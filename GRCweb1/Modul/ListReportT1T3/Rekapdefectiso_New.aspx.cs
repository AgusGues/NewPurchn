using BusinessFacade;
using Domain;
using System;
using System.Collections;
using System.Collections.Generic;
using System.Data;
using System.Data.SqlClient;
using System.IO;
using System.Linq;
using System.Web;
using System.Web.UI;
using System.Web.UI.WebControls;
using Factory;

namespace GRCweb1.Modul.ListReportT1T3
{
    public partial class Rekapdefectiso_New : System.Web.UI.Page
    {
        protected void Page_Load(object sender, EventArgs e)
        {
            if (!Page.IsPostBack)
            {
                Global.link = "../../Default.aspx";
                getYear();
                LoadBulan();
                ddlBulan.SelectedValue = DateTime.Now.Month.ToString().PadLeft(2, '0');
                ddlBulan_SelectedIndexChanged(null, null);
                LblTgl1.Text = DateTime.Parse(txtdrtanggal.Text).ToString("MMMM yyyy");
                LblTgl2.Text = "Satuan Meter Kubik"; RBLembar.Enabled = false;
                //Button1_Click(null, null);
            }
        ((ScriptManager)Master.FindControl("ScriptManager1")).RegisterPostBackControl(LinkButton3);
        }

        private void getYear()
        {
            /**
             * Fill dropdown items with data tahun from database
             */
            ddTahun.Items.Clear();
            ArrayList arrTahun = new ArrayList();
            T3_MutasiWIPFacade T3_MutasiWIPFacade = new T3_MutasiWIPFacade();
            arrTahun = T3_MutasiWIPFacade.BM_Tahun();
            ddTahun.Items.Clear();
            ddTahun.Items.Add(new ListItem("-- Pilih Tahun --", "0"));
            foreach (T3_MutasiWIP bmTahun in arrTahun)
            {
                ddTahun.Items.Add(new ListItem(bmTahun.Tahune.ToString(), bmTahun.Tahune.ToString()));
            }
            ddTahun.SelectedValue = DateTime.Now.Year.ToString();
        }

        protected void Button1_Click(object sender, EventArgs e)
        {
            try
            {
                LblTgl6.Text = DateTime.Now.ToString("dddd") + " " + DateTime.Now.ToString("dd MMMM yyyy");
                loadDynamicGrid(DateTime.Parse(txtdrtanggal.Text).ToString("yyyyMM"));
                loadDynamicGrid2(DateTime.Parse(txtdrtanggal.Text).ToString("yyyyMM"));
                loadDynamicGrid3(DateTime.Parse(txtdrtanggal.Text).ToString("yyyyMM"));
                loadDynamicGrid4(DateTime.Parse(txtdrtanggal.Text).ToString("yyyyMM"));
                loadDynamicGrid5(DateTime.Parse(txtdrtanggal.Text).ToString("yyyyMM"));
                loadDynamicGrid6(DateTime.Parse(txtdrtanggal.Text).ToString("yyyyMM"));
                loadDynamicGrid7(DateTime.Parse(txtdrtanggal.Text).ToString("yyyyMM"));
            }
            catch { }

            //loadDynamicGrid8(DateTime.Parse(txtdrtanggal.Text).ToString("yyyyMM"));
        }
        public override void VerifyRenderingInServerForm(Control control)
        {
            /* Verifies that the control is rendered */
        }
        private void loadDynamicGrid(string tgl1)
        {
            ddlBulan_SelectedIndexChanged(null, null);

            Users users = (Users)Session["Users"]; string logika2 = string.Empty; string logika3 = string.Empty;
            string strStocker = string.Empty; string strtgl11 = string.Empty; string strtgl21 = string.Empty;
            string strtgl1 = string.Empty; string strtgl2 = string.Empty;
            int Bln0 = 0; string Bln = string.Empty;
            int Thn0 = 0; string Thn = string.Empty;
            int Thn1 = 0;
            string Periode = string.Empty;

            if (txtdrtanggal.Text == string.Empty || txtsdtanggal.Text == string.Empty)
            {
                return;
            }
            DateTime intgl1 = DateTime.Parse(txtdrtanggal.Text);
            DateTime intgl2 = DateTime.Parse(txtsdtanggal.Text);

            strtgl1 = intgl1.ToString("yyyyMMdd");
            strtgl2 = intgl2.ToString("yyyyMMdd");

            if (Convert.ToInt32(intgl1.Month) == 1)
            {
                Bln0 = 12;
            }
            else
            {
                Bln0 = Convert.ToInt32(intgl1.Month) - 1;
            }

            Thn0 = Convert.ToInt32(intgl1.Year);

            if (Bln0.ToString().Length == 1)
            {
                Bln = "0" + Bln0.ToString();

            }
            else
            {
                Bln = Bln0.ToString();
            }

            if (Bln == "12")
            {
                Thn1 = Thn0 - 1;
                Thn = Thn1.ToString();
            }
            else
            {
                Thn1 = Thn0;
                Thn = Thn1.ToString();
            }

            Periode = Thn.Trim() + Bln.Trim();

            string thnbln = ddTahun.SelectedValue + ddlBulan.SelectedValue.ToString().PadLeft(2, '0');
            string QueryTotalPotongLama = string.Empty;
            string QueryTotalPotongBaru = string.Empty;
            string QueryTotalPotongLamaLb = string.Empty;
            string QueryTotalPotongBaruLb = string.Empty;

            QueryTotalPotongLama = "select *,isnull((select sum(qty) from tempdefectGPIso where [group]=A.[Group] ),0) totdefect, " +
               "isnull((select sum(kubik) from tempdefectGPIso where [group]=A.[Group] ),0) totdefectK into tempdefectGPIsoTot from ( " +
               "select  B.[Group],SUM(C.qtyin) as totpotong,SUM(kubik) as totkubik    from BM_Destacking A left join BM_PlantGroup B on A.PlantGroupID=B.ID  " +
               "inner join (  select C.destid,C.qtyin,C.QtyIn*I1.Volume as kubik from T1_Serah C Inner join fc_items I  on C.itemid=I.ID Inner join fc_items I1 on C.itemid0=I1.ID  " +
               "where C.Status>-1 and CONVERT(char,C.tglserah,112)>=@thnbln1 and   CONVERT(char,C.tglserah,112)<=@thnbln2 and (I.PartNo like '%-w-%' or I.PartNo like '%-3-%' )  " +
               "union all   " +
               "select C.DestID , B.Qty qtyin,B.Qty*I.Volume as kubik from Def_Defect A inner join Def_DefectDetail B on A.ID=B.DefectID  inner join T1_Serah C on A.SerahID=C.ID  " +
               "left join FC_Items I on I.ID=C.ItemID0  where CONVERT(char,A.tgl,112)>=@thnbln1 and  CONVERT(char,A.tgl,112)<=@thnbln2 and B.RowStatus>-1 ) as C   " +
               "on A.ID=C.DestID group by B.[Group])A";
            QueryTotalPotongBaru = "select  B.[Group],SUM(C.qtyin) as totpotong,SUM(kubik) as totkubik, " +
               "isnull((select sum(qty) from tempdefectGPIso where [group]=B.[Group] ),0) totdefect, " +
               "isnull((select sum(kubik) from tempdefectGPIso where [group]=B.[Group] ),0) totdefectK into tempdefectGPIsoTot " +
               "from BM_Destacking A left join BM_PlantGroup B on A.PlantGroupID=B.ID inner join (   " +
               "select C.ID DestID , A.TPotong qtyin,A.TPotong*I.Volume as kubik  " +
               "from Def_Defect A   " +
               "inner join BM_Destacking C on A.DestID=C.ID left join FC_Items I on I.ID=C.ItemID  " +
               "where A.Status>-1 and  CONVERT(varchar,A.tgl,112)>=@thnbln1 and CONVERT(varchar,A.tgl,112)<=@thnbln2 " +
               ") as C  on A.ID=C.DestID group by B.[Group] order by B.[Group]  ";

            QueryTotalPotongLamaLb = "select *,isnull((select sum(qty) from tempdefectGPIso where [group]=A.[Group] ),0) totdefect, " +
               "isnull((select sum(qty) from tempdefectGPIso where [group]=A.[Group] ),0) totdefectK into tempdefectGPIsoTot from ( " +
               "select  B.[Group],SUM(C.qtyin) as totpotong,SUM(kubik) as totkubik    from BM_Destacking A left join BM_PlantGroup B on A.PlantGroupID=B.ID  " +
               "inner join (  select C.destid,C.qtyin,C.QtyIn*I1.Volume as kubik from T1_Serah C Inner join fc_items I  on C.itemid=I.ID Inner join fc_items I1 on C.itemid0=I1.ID  " +
               "where C.Status>-1 and CONVERT(char,C.tglserah,112)>=@thnbln1 and   CONVERT(char,C.tglserah,112)<=@thnbln2 and (I.PartNo like '%-w-%' or I.PartNo like '%-3-%' )  " +
               "union all   " +
               "select C.DestID , B.Qty qtyin,B.Qty*I.Volume as kubik from Def_Defect A inner join Def_DefectDetail B on A.ID=B.DefectID  inner join T1_Serah C on A.SerahID=C.ID  " +
               "left join FC_Items I on I.ID=C.ItemID0  where CONVERT(char,A.tgl,112)>=@thnbln1 and  CONVERT(char,A.tgl,112)<=@thnbln2 and B.RowStatus>-1 ) as C   " +
               "on A.ID=C.DestID group by B.[Group])A";
            QueryTotalPotongBaruLb = "select  B.[Group],SUM(C.qtyin) as totpotong,SUM(kubik) as totkubik, " +
               "isnull((select sum(qty) from tempdefectGPIso where [group]=B.[Group] ),0) totdefect, " +
               "isnull((select sum(qty) from tempdefectGPIso where [group]=B.[Group] ),0) totdefectK into tempdefectGPIsoTot " +
               "from BM_Destacking A left join BM_PlantGroup B on A.PlantGroupID=B.ID inner join (   " +
               "select C.ID DestID , A.TPotong qtyin,A.TPotong*I.Volume as kubik  " +
               "from Def_Defect A   " +
               "inner join BM_Destacking C on A.DestID=C.ID left join FC_Items I on I.ID=C.ItemID  " +
               "where A.Status>-1 and  CONVERT(varchar,A.tgl,112)>=@thnbln1 and CONVERT(varchar,A.tgl,112)<=@thnbln2 " +
               ") as C  on A.ID=C.DestID group by B.[Group] order by B.[Group]  ";

            string QueryTotalPotong = string.Empty;
            if (users.UnitKerjaID == 1)
            {
                if (Convert.ToInt32(DateTime.Parse(txtdrtanggal.Text).ToString("yyyyMM")) < 201812)
                    if (RBKubik.Checked == true)
                        QueryTotalPotong = QueryTotalPotongLama;
                    else
                        QueryTotalPotong = QueryTotalPotongLamaLb;
                else
                    if (RBKubik.Checked == true)
                    QueryTotalPotong = QueryTotalPotongBaru;
                else
                    QueryTotalPotong = QueryTotalPotongBaruLb;
            }
            if (users.UnitKerjaID == 7)
            {
                if (Convert.ToInt32(DateTime.Parse(txtdrtanggal.Text).ToString("yyyyMM")) < 201805)
                    if (RBKubik.Checked == true)
                        QueryTotalPotong = QueryTotalPotongLama;
                    else
                        QueryTotalPotong = QueryTotalPotongLamaLb;
                else
                    if (RBKubik.Checked == true)
                    QueryTotalPotong = QueryTotalPotongBaru;
                else
                    QueryTotalPotong = QueryTotalPotongBaruLb;
            }
            else
            {

                if (RBKubik.Checked == true)
                    QueryTotalPotong = QueryTotalPotongLama;
                else
                    QueryTotalPotong = QueryTotalPotongLamaLb;

            }

            string perubahanlogikalisplank = string.Empty;
            if (Convert.ToInt32(DateTime.Parse(txtdrtanggal.Text).ToString("yyyyMM")) >= 201906)
                perubahanlogikalisplank = " and (sfrom not like'%R1%' and sfrom not like'%R2%' and sfrom not like'%R3%')";

            string strSQL = string.Empty;
            string query1 = string.Empty; string query2 = string.Empty;
            string query3 = string.Empty; string query4 = string.Empty;
            string query5 = string.Empty; string query6 = string.Empty;
            string query7 = string.Empty; string query8 = string.Empty;
            string query9 = string.Empty; string query10 = string.Empty;
            string query11 = string.Empty; string query12 = string.Empty;
            string logikaretur = string.Empty;

            if (Convert.ToInt32(strtgl1.Substring(0, 6)) < 201902)
            {
                if (RBKubik.Checked == true)
                    #region query kubik
                    strSQL = "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectGPIso]') AND type in (N'U')) DROP TABLE [dbo].[tempdefectGPIso]  " +
                        "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectGPIsoTot]') AND type in (N'U')) DROP TABLE [dbo].tempdefectGPIsoTot  " +
                        "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectFin]') AND type in (N'U')) DROP TABLE [dbo].tempdefectFin " +
                        "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectL1]') AND type in (N'U')) DROP TABLE [dbo].tempdefectL1 " +
                        "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectL2]') AND type in (N'U')) DROP TABLE [dbo].tempdefectL2 " +
                        "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectL3]') AND type in (N'U')) DROP TABLE [dbo].tempdefectL3 " +
                        "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectL4]') AND type in (N'U')) DROP TABLE [dbo].tempdefectL4 " +
                        "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectL5]') AND type in (N'U')) DROP TABLE [dbo].tempdefectL5 " +
                        "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectL6]') AND type in (N'U')) DROP TABLE [dbo].tempdefectL6 " +
                                    "declare @thnbln1 varchar(8) " +
                        "declare @thnbln2 varchar(8) " +
                        "set @thnbln1='" + strtgl1 + "' " +
                        "set @thnbln2='" + strtgl2 + "' " +
                                    "select *  into tempdefectGPIso from (  " +
                        "select case when D.DeptID=0 then  " +
                        "case when GJ.GroupJemurName In ('M','N','O','P','Q','R','S','T','U','V','W','X') then   " +
                        "    case when D.DefName='retak' then 2   " +
                        "        when D.DefName='gompal' then 3  " +
                        "    else D.DeptID end   " +
                        "else    " +
                        "    case when (B.Qty/E.Qty) *100 >5 then 2 else 3 end   " +
                        "end  " +
                        "else D.DeptID end deptID1,A.CreatedTime as tglInput,A.Tgl as TglPeriksa,E.TglProduksi as TglProd,  D.DefCode,BP.PlantName as Line, PG.[Group],BF.FormulaCode as Jenis,   " +
                        "D.DefName,D.DeptID,B.ID,B.DefectID,B.MasterID,B.Qty,A.ID  DestID,isnull(A.TPotong,0)  QtyIn,B.Qty*I.Volume as Kubik,isnull(A.TPotong,0) as TotPotong,'' sfrom  " +
                        "from Def_DefectDetail B inner join Def_Defect A on A.Id=B.DefectID   " +
                        "left join Def_MasterDefect D on B.MasterID=D.ID left join BM_Destacking E on E.ID=A.DestID   " +
                        "left join BM_PlantGroup PG on A.GroupProdID=PG.ID left join BM_Formula BF on BF.ID=E.FormulaID    " +
                        "left join BM_Plant BP on BP.ID=E.PlantID left join FC_Items I on I.ID=E.ItemID inner join Def_GroupJemur GJ on GJ.ID=A.GroupJemurID  " +
                        "where B.RowStatus>-1  and D.RowStatus >-1) as Def    " +
                        "where DeptID1=2 and CONVERT(varchar,TglPeriksa,112)>=@thnbln1 and CONVERT(varchar,TglPeriksa,112)<=@thnbln2  " +
                        " " +
                         QueryTotalPotong +
                        " " +
                        "declare @DefectFin decimal(18,2) " +
                        "set @DefectFin= (select sum(kubik) from (  " +
                        "select case when D.DeptID=0 then  " +
                        "case when GJ.GroupJemurName In ('M','N','O','P','Q','R','S','T','U','V','W','X') then   " +
                        "case when D.DefName='retak' then 2   " +
                        "when D.DefName='gompal' then 3  " +
                        "else D.DeptID end   " +
                        "else    " +
                        "case when (B.Qty/E.Qty) *100 >5 then 2 else 3 end   " +
                        "end  " +
                        "else D.DeptID end deptID1,A.CreatedTime as tglInput,A.Tgl as TglPeriksa,E.TglProduksi as TglProd,  D.DefCode,BP.PlantName as Line, PG.[Group],BF.FormulaCode as Jenis,   " +
                        "D.DefName,D.DeptID,B.ID,B.DefectID,B.MasterID,B.Qty,A.ID  DestID,isnull(A.TPotong,0)  QtyIn,B.Qty*I.Volume as Kubik,isnull(A.TPotong,0) as TotPotong,'' sfrom  " +
                        "from Def_DefectDetail B inner join Def_Defect A on A.Id=B.DefectID   " +
                        "left join Def_MasterDefect D on B.MasterID=D.ID left join BM_Destacking E on E.ID=A.DestID   " +
                        "left join BM_PlantGroup PG on A.GroupProdID=PG.ID left join BM_Formula BF on BF.ID=E.FormulaID    " +
                        "left join BM_Plant BP on BP.ID=E.PlantID left join FC_Items I on I.ID=E.ItemID inner join Def_GroupJemur GJ on GJ.ID=A.GroupJemurID  " +
                        "where B.RowStatus>-1  and D.RowStatus >-1) as Def    " +
                        "where DeptID1<>2 and CONVERT(varchar,TglPeriksa,112)>=@thnbln1 and CONVERT(varchar,TglPeriksa,112)<=@thnbln2) " +
                        " " +
                        "select * into tempdefectFin from ( " +
                        "select 'OKKW' fin, sum(qtyout) lembar,sum(qtyout * kubik)kubik from ( " +
                        "select I1.PartNo partno1,I1.Panjang * I1.Lebar luas1,  S.qtyin,I2.PartNo partno2,I2.Panjang * I2.Lebar luas2,  S.qtyout ,(I2.Tebal * I2.Panjang * I2.Lebar)/1000000000 kubik " +
                        "from t3_simetris S inner join T3_Serah Se on S.SerahID =Se.ID inner join fc_items I1 on Se.ItemID=I1.ID inner join fc_items I2 on S.ItemID=I2.id  " +
                        "where I2.lebar>500 and S.RowStatus>-1 and CONVERT(varchar,S.tgltrans,112)>=@thnbln1 and CONVERT(varchar,S.tgltrans,112)<=@thnbln2 )a where partno1 like '%-1-%' and luas1>=luas2*2 and partno2 like '%-p-%' " +
                        "union all " +
                        "select 'BP' fin, sum(qtyout) lembar,sum(qtyout * kubik)kubik from ( " +
                        "select I1.PartNo partno1,I1.Panjang * I1.Lebar luas1,  S.qtyin,I2.PartNo partno2,I2.Panjang * I2.Lebar luas2,  S.qtyout ,(I2.Tebal * I2.Panjang * I2.Lebar)/1000000000 kubik " +
                        "from t3_simetris S inner join T3_Serah Se on S.SerahID =Se.ID inner join fc_items I1 on Se.ItemID=I1.ID inner join fc_items I2 on S.ItemID=I2.id  " +
                        "where I2.lebar>500 and S.RowStatus>-1 and CONVERT(varchar,S.tgltrans,112)>=@thnbln1 and CONVERT(varchar,S.tgltrans,112)<=@thnbln2  )a where partno1 like '%-1-%' and luas1>=luas2*2 and  " +
                        "(partno2 like '%-3-%' or partno2 like '%-w-%' or partno2 like '%-m-%') " +
                        "union all " +
                        "select 'BS' fin,sum(R.QtyIn) Lembar,sum(R.QtyIn *((I.tebal*I.panjang*I.lebar)/1000000000)) kubik from T3_Rekap R inner join FC_Items I on R.ItemID=I.id inner join fc_lokasi L on R.LokID =L.id where R.RowStatus>-1 and  " +
                        "CONVERT(varchar,R.tgltrans,112)>=@thnbln1 and CONVERT(varchar,R.tgltrans,112)<=@thnbln2 and I.PartNo like '%-s-%' and Process='direct')A " +
                        " " +
                        "declare @TotalPotong decimal(18,2) " +
                        "declare @TotalDefKhusus decimal(18,2) " +
                        "declare @DefKhusus decimal(18,2) " +
                        "declare @Ttotalkw1kw2 decimal(18,2) " +
                        "declare @NCSortir decimal(18,2) " +
                        "declare @Retur decimal(18,2) " +
                        "set @TotalPotong=isnull((select sum(totkubik ) from tempdefectGPIsoTot),0) " +
                        "if @TotalPotong >0  " +
                        "begin " +
                        "set @TotalDefKhusus=isnull((select sum(kubik) from tempdefectFin),0) " +
                        "set @DefKhusus=isnull((select sum(kubik) from tempdefectFin where fin<>'bp'),0) " +
                        "set @Ttotalkw1kw2 =isnull((select sum(qtyin *((I.tebal*I.Lebar*I.Panjang)/1000000000)) from T3_Rekap R inner join fc_items I on R.itemid=I.ID  " +
                        "where R.rowstatus>-1 and R.Process  like '%simetris%' and CONVERT(varchar,R.tgltrans,112)>=@thnbln1 and CONVERT(varchar,R.tgltrans,112)<=@thnbln2   " +
                        "and I.lebar=1200 and I.panjang=2400 and R.keterangan like '%-p-%' and (I.partno like '%-3-%' or I.partno like '%-W-%' or I.partno like '%-M-%' )),0) " +
                        "set @NCSortir=isnull((select /*sum(QtyAkhirSS)+sum(QtyAkhirSE)*/sum(M3AkhirSS)+sum(M3AkhirSE) from (  " +
                        "SELECT B.tgltrans as Tanggal, I1.PartNo as PartnoAwal, sum(B.QtyIn) as QtyAwal,sum(I1.Volume*B.QtyIn) M3Awal,   " +
                        "I2.PartNo AS PartnoAkhir, case when B.NCSS>0 then sum(B.QtyOut) else 0 end QtyAkhirSS,  " +
                        "case when B.NCSS>0 then sum(I2.Volume*B.QtyOut) else 0 end M3AkhirSS,case when B.NCSE>0 then sum(B.QtyOut) else 0 end QtyAkhirSE,  " +
                        "case when B.NCSE>0 then sum(I2.Volume*B.QtyOut) else 0 end M3AkhirSE,B.NCSS,B.NCSE  FROM T3_Serah AS A   " +
                        "INNER JOIN T3_Simetris AS B ON A.ID = B.SerahID INNER JOIN FC_Items AS I1 ON A.ItemID = I1.ID INNER JOIN   " +
                        "FC_Items AS I2 ON B.ItemID = I2.ID LEFT JOIN T3_GroupM AS D ON B.GroupID = D.ID   " +
                        "where (B.NCSS>0 or B.NCSE>0) and B.rowstatus>-1 and CONVERT(varchar,B.tgltrans,112)>=@thnbln1 and CONVERT(varchar,B.tgltrans,112)<=@thnbln2   " +
                        "group by B.tgltrans,I1.PartNo,I2.PartNo,B.NCSS,B.NCSE) S),0) " +
                        "set @Retur=isnull((select sum(qty) from ( " +
                        "select sum(qty *(I.tebal*I.panjang*I.lebar)/1000000000) qty from t3_retur R inner join fc_items I on R.itemid=I.id where R.rowstatus>-1 and  " +
                        "R.typer=1 and (I.partno like '%-p-%' or I.partno like '%-S-%')  and CONVERT(varchar,R.tgltrans,112)>=@thnbln1 and CONVERT(varchar,R.tgltrans,112)<=@thnbln2  " +
                        "union all " +
                        "select sum(qty *(I.tebal*I.panjang*I.lebar)/1000000000)*-1 qty from t3_retur R inner join fc_items I on R.itemid=I.id where R.rowstatus>-1 and  " +
                        "R.typer=2 and (I.partno like '%-p-%' or I.partno like '%-S-%')and CONVERT(varchar,R.tgltrans,112)>=@thnbln1 and CONVERT(varchar,R.tgltrans,112)<=@thnbln2 " +
                        "union all " +
                        "select sum(qty *(I.tebal*I.panjang*I.lebar)/1000000000) qty from t3_returO R inner join fc_items I on R.itemid=I.id where R.rowstatus>-1 and  " +
                        "(I.partno like '%-p-%' or I.partno like '%-S-%') and CONVERT(varchar,R.tgltrans,112)>=@thnbln1 and CONVERT(varchar,R.tgltrans,112)<=@thnbln2)A),0) " +
                        " " +
                        "declare @TotalPotongL1 decimal(18,2) " +
                        "declare @TotDefKhususL1 decimal(18,2) " +
                        "declare @DefKhususL1 decimal(18,2) " +
                        "declare @Ttotalkw1kw2L1 decimal(18,2) " +
                        "declare @NCSortirL1 decimal(18,2) " +
                        "declare @ReturL1 decimal(18,2) " +
                        "declare @DefectFinL1 decimal(18,2) " +
                        "set @TotalPotongL1=(select sum(totkubik ) from tempdefectGPIsoTot where [group]in (select [group] from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 1'))) " +
                        "set @TotDefKhususL1=(@TotalPotongL1/@TotalPotong)*@TotalDefKhusus " +
                        "set @DefKhususL1=(@TotalPotongL1/@TotalPotong)*@DefKhusus " +
                        "set @Ttotalkw1kw2L1=(@TotalPotongL1/@TotalPotong)*@Ttotalkw1kw2 " +
                        "set @NCSortirL1=(@TotalPotongL1/@TotalPotong)*@NCSortir " +
                        "set @ReturL1=(@TotalPotongL1/@TotalPotong)*@Retur " +
                        "set @DefectFinL1=isnull((@TotalPotongL1/@TotalPotong)*@DefectFin,0) " +
                        "if @TotalPotongL1>0 " +
                        "begin " +
                        "select * into tempdefectL1 from ( " +
                        "select *,c-d+e+f+g+h i,case when b>0 then (c-d+e+f+g+h)/b*100 else 0  end j from ( " +
                        "select [Group],case when @TotalPotongL1>0 then isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) +  " +
                        "  (( isnull(( select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@TotDefKhususL1)  else 0 end b, " +
                        " case when @TotalPotongL1>0 then isnull((select totdefectK from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)  else 0 end c, " +
                        " case when @TotalPotongL1>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@Ttotalkw1kw2L1) else 0 end  d, " +
                        " case when @TotalPotongL1>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@NCSortirL1)  else 0 end  e, " +
                        " case when @TotalPotongL1>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@ReturL1)  else 0 end  f, " +
                        " case when @TotalPotongL1>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@DefectFinL1)  else 0 end g, " +
                        " case when @TotalPotongL1>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@DefKhususL1) else 0 end  h " +
                        " from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 1') )A " +
                        "union all  " +
                        "select 'Total' [Group],sum(b)b,sum(c)c,sum(d)d,sum(e)e,sum(f)f,sum(g)g,sum(h)h,sum(c)-sum(d)+sum(e)+sum(f)+sum(g)+sum(h) i " +
                        ",(sum(c)-sum(d)+sum(e)+sum(f)+sum(g)+sum(h))/sum(b)*100 j from( " +
                        "select [Group],case when @TotalPotongL1>0 then isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) +  " +
                        "  (( isnull(( select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@TotDefKhususL1)  else 0 end b, " +
                        " case when @TotalPotongL1>0 then isnull((select totdefectK from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)  else 0 end c, " +
                        " case when @TotalPotongL1>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@Ttotalkw1kw2L1) else 0 end  d, " +
                        " case when @TotalPotongL1>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@NCSortirL1)  else 0 end  e, " +
                        " case when @TotalPotongL1>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@ReturL1)  else 0 end  f, " +
                        " case when @TotalPotongL1>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@DefectFinL1)  else 0 end g, " +
                        " case when @TotalPotongL1>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@DefKhususL1) else 0 end  h, " +
                        " 0 i,0 j from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 1'))A )B " +
                        " end " +
                        " else " +
                        " begin " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 h,0 i, 0 j into tempdefectL1 " +
                        " end " +
                        " " +
                        "declare @TotalPotongL2 decimal(18,2) " +
                        "declare @TotDefKhususL2 decimal(18,2) " +
                        "declare @DefKhususL2 decimal(18,2) " +
                        "declare @Ttotalkw1kw2L2 decimal(18,2) " +
                        "declare @NCSortirL2 decimal(18,2) " +
                        "declare @ReturL2 decimal(18,2) " +
                        "declare @DefectFinL2 decimal(18,2) " +
                        "set @TotalPotongL2=(select sum(totkubik ) from tempdefectGPIsoTot where [group]in (select [group] from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 2'))) " +
                        " " +
                        "set @TotDefKhususL2=(@TotalPotongL2/@TotalPotong)*@TotalDefKhusus " +
                        "set @DefKhususL2=(@TotalPotongL2/@TotalPotong)*@DefKhusus " +
                        "set @Ttotalkw1kw2L2=(@TotalPotongL2/@TotalPotong)*@Ttotalkw1kw2 " +
                        "set @NCSortirL2=(@TotalPotongL2/@TotalPotong)*@NCSortir " +
                        "set @ReturL2=(@TotalPotongL2/@TotalPotong)*@Retur " +
                        "set @DefectFinL2=isnull((@TotalPotongL2/@TotalPotong)*@DefectFin,0) " +
                        "if @TotalPotongL2>0 " +
                        "begin " +
                        "select * into tempdefectL2 from ( " +
                        "select *,c-d+e+f+g+h i,case when b>0 then (c-d+e+f+g+h)/b*100 else 0  end j from ( " +
                        "select [Group],case when @TotalPotongL2>0 then isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) +  " +
                        " ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL2)*@TotDefKhususL2) else 0 end  b, " +
                        " case when @TotalPotongL2>0 then isnull((select totdefectK from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) else 0 end c, " +
                        " case when @TotalPotongL2>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL2)*@Ttotalkw1kw2L2) else 0 end  d, " +
                        " case when @TotalPotongL2>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL2)*@NCSortirL2) else 0 end  e, " +
                        " case when @TotalPotongL2>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL2)*@ReturL2)  else 0 end f, " +
                        " case when @TotalPotongL2>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL2)*@DefectFinL2) else 0 end  g, " +
                        " case when @TotalPotongL2>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL2)*@DefKhususL2) else 0 end  h " +
                        "  from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 2') )A " +
                        "union all  " +
                        "select 'Total' [Group],sum(b)b,sum(c)c,sum(d)d,sum(e)e,sum(f)f,sum(g)g,sum(h)h,sum(c)-sum(d)+sum(e)+sum(f)+sum(g)+sum(h) i " +
                        ",(sum(c)-sum(d)+sum(e)+sum(f)+sum(g)+sum(h))/sum(b)*100 j from( " +
                        "select [Group],case when @TotalPotongL2>0 then isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) +  " +
                        " ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL2)*@TotDefKhususL2) else 0 end  b, " +
                        " case when @TotalPotongL2>0 then isnull((select totdefectK from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) else 0 end c, " +
                        " case when @TotalPotongL2>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL2)*@Ttotalkw1kw2L2) else 0 end  d, " +
                        " case when @TotalPotongL2>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL2)*@NCSortirL2) else 0 end  e, " +
                        " case when @TotalPotongL2>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL2)*@ReturL2)  else 0 end f, " +
                        " case when @TotalPotongL2>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL2)*@DefectFinL2) else 0 end  g, " +
                        " case when @TotalPotongL2>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL2)*@DefKhususL2) else 0 end  h, " +
                        " 0 i,0 j from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 2'))A )B " +
                        " end " +
                        " else " +
                        " begin " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 h,0 i, 0 j into tempdefectL2 " +
                        " end " +
                        " " +
                        "declare @TotalPotongL3 decimal(18,2) " +
                        "declare @TotDefKhususL3 decimal(18,2) " +
                        "declare @DefKhususL3 decimal(18,2) " +
                        "declare @Ttotalkw1kw2L3 decimal(18,2) " +
                        "declare @NCSortirL3 decimal(18,2) " +
                        "declare @ReturL3 decimal(18,2) " +
                        "declare @DefectFinL3 decimal(18,2) " +
                        "set @TotalPotongL3=(select sum(totkubik ) from tempdefectGPIsoTot where [group]in (select [group] from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 3'))) " +
                        "set @TotDefKhususL3=(@TotalPotongL3/@TotalPotong)*@TotalDefKhusus " +
                        "set @DefKhususL3=(@TotalPotongL3/@TotalPotong)*@DefKhusus " +
                        "set @Ttotalkw1kw2L3=(@TotalPotongL3/@TotalPotong)*@Ttotalkw1kw2 " +
                        "set @NCSortirL3=(@TotalPotongL3/@TotalPotong)*@NCSortir " +
                        "set @ReturL3=(@TotalPotongL3/@TotalPotong)*@Retur " +
                        "set @DefectFinL3=isnull((@TotalPotongL3/@TotalPotong)*@DefectFin,0) " +
                        "if @TotalPotongL3>0 " +
                        "begin " +
                        "select * into tempdefectL3 from ( " +
                        "select *,c-d+e+f+g+h i,case when b>0 then (c-d+e+f+g+h)/b*100 else 0  end j from ( " +
                        "select [Group],case when @TotalPotongL3>0 then isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) +  " +
                        " ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@TotDefKhususL3) else 0 end  b, " +
                        " case when @TotalPotongL3>0 then isnull((select totdefectK from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) else 0 end c, " +
                        " case when @TotalPotongL3>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@Ttotalkw1kw2L3) else 0 end  d, " +
                        " case when @TotalPotongL3>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@NCSortirL3) else 0 end  e, " +
                        " case when @TotalPotongL3>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@ReturL3) else 0 end  f, " +
                        " case when @TotalPotongL3>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@DefectFinL3) else 0 end  g, " +
                        " case when @TotalPotongL3>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@DefKhususL3) else 0 end  h " +
                        "  from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 3') )A " +
                        "union all  " +
                        "select 'Total' [Group],sum(b)b,sum(c)c,sum(d)d,sum(e)e,sum(f)f,sum(g)g,sum(h)h,sum(c)-sum(d)+sum(e)+sum(f)+sum(g)+sum(h) i " +
                        ",(sum(c)-sum(d)+sum(e)+sum(f)+sum(g)+sum(h))/sum(b)*100 j from( " +
                        "select [Group],isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) +  " +
                        " ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@TotDefKhususL3) b, " +
                        " isnull((select totdefectK from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)c, " +
                        " ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@Ttotalkw1kw2L3) d, " +
                        " ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@NCSortirL3) e, " +
                        " ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@ReturL3) f, " +
                        " ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@DefectFinL3) g, " +
                        " ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@DefKhususL3) h, " +
                        " 0 i,0 j from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 3'))A )B " +
                        " end " +
                        " else " +
                        " begin " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 h,0 i, 0 j into tempdefectL3 " +
                        " end " +
                        " " +
                        "declare @TotalPotongL4 decimal(18,2) " +
                        "declare @TotDefKhususL4 decimal(18,2) " +
                        "declare @DefKhususL4 decimal(18,2) " +
                        "declare @Ttotalkw1kw2L4 decimal(18,2) " +
                        "declare @NCSortirL4 decimal(18,2) " +
                        "declare @ReturL4 decimal(18,2) " +
                        "declare @DefectFinL4 decimal(18,2) " +
                        "set @TotalPotongL4=(select sum(totkubik ) from tempdefectGPIsoTot where [group]in (select [group] from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 4'))) " +
                        "set @TotDefKhususL4=(@TotalPotongL4/@TotalPotong)*@TotalDefKhusus " +
                        "set @DefKhususL4=(@TotalPotongL4/@TotalPotong)*@DefKhusus " +
                        "set @Ttotalkw1kw2L4=(@TotalPotongL4/@TotalPotong)*@Ttotalkw1kw2 " +
                        "set @NCSortirL4=(@TotalPotongL4/@TotalPotong)*@NCSortir " +
                        "set @ReturL4=(@TotalPotongL4/@TotalPotong)*@Retur " +
                        "set @DefectFinL4=isnull((@TotalPotongL4/@TotalPotong)*@DefectFin,0) " +
                        "if @TotalPotongL4>0 " +
                        "begin " +
                        "select * into tempdefectL4 from ( " +
                        "select *,c-d+e+f+g+h i,case when b>0 then (c-d+e+f+g+h)/b*100 else 0  end j from ( " +
                        "select [Group],case when @TotalPotongL4>0 then isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) +  " +
                        " ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@TotDefKhususL4) else 0 end  b, " +
                        " case when @TotalPotongL4>0 then isnull((select totdefectK from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) else 0 end c, " +
                        " case when @TotalPotongL4>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@Ttotalkw1kw2L4) else 0 end  d, " +
                        " case when @TotalPotongL4>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@NCSortirL4) else 0 end  e, " +
                        " case when @TotalPotongL4>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@ReturL4) else 0 end  f, " +
                        " case when @TotalPotongL4>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@DefectFinL4) else 0 end  g, " +
                        " case when @TotalPotongL4>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@DefKhususL4) else 0 end  h " +
                        "  from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 4') )A " +
                        "union all  " +
                        "select 'Total' [Group],sum(b)b,sum(c)c,sum(d)d,sum(e)e,sum(f)f,sum(g)g,sum(h)h,sum(c)-sum(d)+sum(e)+sum(f)+sum(g)+sum(h) i " +
                        ",(sum(c)-sum(d)+sum(e)+sum(f)+sum(g)+sum(h))/sum(b)*100 j from( " +
                        "select [Group],isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) +  " +
                        " ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@TotDefKhususL4) b, " +
                        " isnull((select totdefectK from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)c, " +
                        " ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@Ttotalkw1kw2L4) d, " +
                        " ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@NCSortirL4) e, " +
                        " ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@ReturL4) f, " +
                        " ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@DefectFinL4) g, " +
                        " ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@DefKhususL4) h, " +
                        " 0 i,0 j from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 4'))A )B " +
                        " end " +
                        " else " +
                        " begin " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 h,0 i, 0 j into tempdefectL4 " +
                        " end " +
                        " " +
                        "declare @TotalPotongL5 decimal(18,2) " +
                        "declare @TotDefKhususL5 decimal(18,2) " +
                        "declare @DefKhususL5 decimal(18,2) " +
                        "declare @Ttotalkw1kw2L5 decimal(18,2) " +
                        "declare @NCSortirL5 decimal(18,2) " +
                        "declare @ReturL5 decimal(18,2) " +
                        "declare @DefectFinL5 decimal(18,2) " +
                        "set @TotalPotongL5=(select sum(totkubik ) from tempdefectGPIsoTot where [group]in (select [group] from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 5'))) " +
                        "set @TotDefKhususL5=(@TotalPotongL5/@TotalPotong)*@TotalDefKhusus " +
                        "set @DefKhususL5=(@TotalPotongL5/@TotalPotong)*@DefKhusus " +
                        "set @Ttotalkw1kw2L5=(@TotalPotongL5/@TotalPotong)*@Ttotalkw1kw2 " +
                        "set @NCSortirL5=(@TotalPotongL5/@TotalPotong)*@NCSortir " +
                        "set @ReturL5=(@TotalPotongL5/@TotalPotong)*@Retur " +
                        "set @DefectFinL5=isnull((@TotalPotongL5/@TotalPotong)*@DefectFin,0) " +
                        "if @TotalPotongL5>0 " +
                        "begin " +
                        "select * into tempdefectL5 from ( " +
                        "select *,c-d+e+f+g+h i,case when b>0 then (c-d+e+f+g+h)/b*100 else 0  end j from ( " +
                        "select [Group],case when @TotalPotongL5>0 then isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) +  " +
                        " ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@TotDefKhususL5) else 0 end  b, " +
                        " case when @TotalPotongL5>0 then isnull((select totdefectK from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) else 0 end c, " +
                        " case when @TotalPotongL5>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@Ttotalkw1kw2L5) else 0 end  d, " +
                        " case when @TotalPotongL5>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@NCSortirL5) else 0 end  e, " +
                        " case when @TotalPotongL5>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@ReturL5) else 0 end  f, " +
                        " case when @TotalPotongL5>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@DefectFinL5) else 0 end  g, " +
                        " case when @TotalPotongL5>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@DefKhususL5) else 0 end  h " +
                        "  from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 5') )A " +
                        "union all  " +
                        "select 'Total' [Group],sum(b)b,sum(c)c,sum(d)d,sum(e)e,sum(f)f,sum(g)g,sum(h)h,sum(c)-sum(d)+sum(e)+sum(f)+sum(g)+sum(h) i " +
                        ",(sum(c)-sum(d)+sum(e)+sum(f)+sum(g)+sum(h))/sum(b)*100 j from( " +
                        "select [Group],isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) +  " +
                        " ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@TotDefKhususL5) b, " +
                        " isnull((select totdefectK from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)c, " +
                        " ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@Ttotalkw1kw2L5) d, " +
                        " ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@NCSortirL5) e, " +
                        " ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@ReturL5) f, " +
                        " ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@DefectFinL5) g, " +
                        " ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@DefKhususL5) h, " +
                        " 0 i,0 j from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 5'))A )B " +
                        " end " +
                        " else " +
                        " begin " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 h,0 i, 0 j into tempdefectL5 " +
                        " end " +
                        " " +
                        "declare @TotalPotongL6 decimal(18,2) " +
                        "declare @TotDefKhususL6 decimal(18,2) " +
                        "declare @DefKhususL6 decimal(18,2) " +
                        "declare @Ttotalkw1kw2L6 decimal(18,2) " +
                        "declare @NCSortirL6 decimal(18,2) " +
                        "declare @ReturL6 decimal(18,2) " +
                        "declare @DefectFinL6 decimal(18,2) " +
                        "set @TotalPotongL6=(select sum(totkubik ) from tempdefectGPIsoTot where [group]in (select [group] from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 6'))) " +
                        "set @TotDefKhususL6=(@TotalPotongL6/@TotalPotong)*@TotalDefKhusus " +
                        "set @DefKhususL6=(@TotalPotongL6/@TotalPotong)*@DefKhusus " +
                        "set @Ttotalkw1kw2L6=(@TotalPotongL6/@TotalPotong)*@Ttotalkw1kw2 " +
                        "set @NCSortirL6=(@TotalPotongL6/@TotalPotong)*@NCSortir " +
                        "set @ReturL6=(@TotalPotongL6/@TotalPotong)*@Retur " +
                        "set @DefectFinL6=isnull((@TotalPotongL6/@TotalPotong)*@DefectFin,0) " +
                        "if @TotalPotongL6>0 " +
                        "begin " +
                        "select * into tempdefectL6 from ( " +
                        "select *,c-d+e+f+g+h i,case when b>0 then (c-d+e+f+g+h)/b*100 else 0  end j from ( " +
                        "select [Group],case when @TotalPotongL6>0 then isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) +  " +
                        " ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@TotDefKhususL6)  else 0 end b, " +
                        " case when @TotalPotongL6>0 then isnull((select totdefectK from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) else 0 end c, " +
                        " case when @TotalPotongL6>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@Ttotalkw1kw2L6)  else 0 end d, " +
                        " case when @TotalPotongL6>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@NCSortirL6)  else 0 end e, " +
                        " case when @TotalPotongL6>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@ReturL6)  else 0 end f, " +
                        " case when @TotalPotongL6>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@DefectFinL6)  else 0 end g, " +
                        " case when @TotalPotongL6>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@DefKhususL6) else 0 end  h " +
                        "  from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 6') )A " +
                        "union all  " +
                        "select 'Total' [Group],sum(b)b,sum(c)c,sum(d)d,sum(e)e,sum(f)f,sum(g)g,sum(h)h,sum(c)-sum(d)+sum(e)+sum(f)+sum(g)+sum(h) i " +
                        ",(sum(c)-sum(d)+sum(e)+sum(f)+sum(g)+sum(h))/sum(b)*100 j from( " +
                        "select [Group],isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) +  " +
                        " ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@TotDefKhususL6) b, " +
                        " isnull((select totdefectK from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)c, " +
                        " ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@Ttotalkw1kw2L6) d, " +
                        " ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@NCSortirL6) e, " +
                        " ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@ReturL6) f, " +
                        " ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@DefectFinL6) g, " +
                        " ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@DefKhususL6) h, " +
                        " 0 i,0 j from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 6'))A )B " +
                        " end " +
                        " else " +
                        " begin " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 h,0 i, 0 j into tempdefectL6 " +
                        " end " +
                        " " +
                        " end " +
                        " else " +
                        " begin " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 h,0 i, 0 j into tempdefectL1 " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 h,0 i, 0 j into tempdefectL2 " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 h,0 i, 0 j into tempdefectL3 " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 h,0 i, 0 j into tempdefectL4 " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 h,0 i, 0 j into tempdefectL5 " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 h,0 i, 0 j into tempdefectL6 " +
                        " end " +
                        " select * from tempdefectL1 ";
                #endregion
                else
                    #region query lembar
                    strSQL = "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectGPIso]') AND type in (N'U')) DROP TABLE [dbo].[tempdefectGPIso]  " +
                        "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectGPIsoTot]') AND type in (N'U')) DROP TABLE [dbo].tempdefectGPIsoTot  " +
                        "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectFin]') AND type in (N'U')) DROP TABLE [dbo].tempdefectFin " +
                        "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectL1]') AND type in (N'U')) DROP TABLE [dbo].tempdefectL1 " +
                        "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectL2]') AND type in (N'U')) DROP TABLE [dbo].tempdefectL2 " +
                        "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectL3]') AND type in (N'U')) DROP TABLE [dbo].tempdefectL3 " +
                        "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectL4]') AND type in (N'U')) DROP TABLE [dbo].tempdefectL4 " +
                        "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectL5]') AND type in (N'U')) DROP TABLE [dbo].tempdefectL5 " +
                        "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectL6]') AND type in (N'U')) DROP TABLE [dbo].tempdefectL6 " +
                                    "declare @thnbln1 varchar(8) " +
                        "declare @thnbln2 varchar(8) " +
                        "set @thnbln1='" + strtgl1 + "' " +
                        "set @thnbln2='" + strtgl2 + "' " +
                         "select *  into tempdefectGPIso from (  " +
                        "select case when D.DeptID=0 then  " +
                        "case when GJ.GroupJemurName In ('M','N','O','P','Q','R','S','T','U','V','W','X') then   " +
                        "    case when D.DefName='retak' then 2   " +
                        "        when D.DefName='gompal' then 3  " +
                        "    else D.DeptID end   " +
                        "else    " +
                        "    case when (B.Qty/E.Qty) *100 >5 then 2 else 3 end   " +
                        "end  " +
                        "else D.DeptID end deptID1,A.CreatedTime as tglInput,A.Tgl as TglPeriksa,E.TglProduksi as TglProd,  D.DefCode,BP.PlantName as Line, PG.[Group],BF.FormulaCode as Jenis,   " +
                        "D.DefName,D.DeptID,B.ID,B.DefectID,B.MasterID,B.Qty,A.ID  DestID,isnull(A.TPotong,0)  QtyIn,B.Qty*I.Volume as Kubik,isnull(A.TPotong,0) as TotPotong,'' sfrom  " +
                        "from Def_DefectDetail B inner join Def_Defect A on A.Id=B.DefectID   " +
                        "left join Def_MasterDefect D on B.MasterID=D.ID left join BM_Destacking E on E.ID=A.DestID   " +
                        "left join BM_PlantGroup PG on A.GroupProdID=PG.ID left join BM_Formula BF on BF.ID=E.FormulaID    " +
                        "left join BM_Plant BP on BP.ID=E.PlantID left join FC_Items I on I.ID=E.ItemID inner join Def_GroupJemur GJ on GJ.ID=A.GroupJemurID  " +
                        "where B.RowStatus>-1  and D.RowStatus >-1) as Def    " +
                        "where DeptID1=2 and CONVERT(varchar,TglPeriksa,112)>=@thnbln1 and CONVERT(varchar,TglPeriksa,112)<=@thnbln2  " +
                        " " +
                        QueryTotalPotong +
                        " " +
                        "declare @DefectFin decimal(18,2) " +
                        "set @DefectFin= (select sum(Qty) from (  " +
                        "select case when D.DeptID=0 then  " +
                        "case when GJ.GroupJemurName In ('M','N','O','P','Q','R','S','T','U','V','W','X') then   " +
                        "case when D.DefName='retak' then 2   " +
                        "when D.DefName='gompal' then 3  " +
                        "else D.DeptID end   " +
                        "else    " +
                        "case when (B.Qty/E.Qty) *100 >5 then 2 else 3 end   " +
                        "end  " +
                        "else D.DeptID end deptID1,A.CreatedTime as tglInput,A.Tgl as TglPeriksa,E.TglProduksi as TglProd,  D.DefCode,BP.PlantName as Line, PG.[Group],BF.FormulaCode as Jenis,   " +
                        "D.DefName,D.DeptID,B.ID,B.DefectID,B.MasterID,B.Qty,A.ID  DestID,isnull(A.TPotong,0)  QtyIn,B.Qty*I.Volume as Kubik,isnull(A.TPotong,0) as TotPotong,'' sfrom  " +
                        "from Def_DefectDetail B inner join Def_Defect A on A.Id=B.DefectID   " +
                        "left join Def_MasterDefect D on B.MasterID=D.ID left join BM_Destacking E on E.ID=A.DestID   " +
                        "left join BM_PlantGroup PG on A.GroupProdID=PG.ID left join BM_Formula BF on BF.ID=E.FormulaID    " +
                        "left join BM_Plant BP on BP.ID=E.PlantID left join FC_Items I on I.ID=E.ItemID inner join Def_GroupJemur GJ on GJ.ID=A.GroupJemurID  " +
                        "where B.RowStatus>-1  and D.RowStatus >-1) as Def    " +
                        "where DeptID1<>2 and CONVERT(varchar,TglPeriksa,112)>=@thnbln1 and CONVERT(varchar,TglPeriksa,112)<=@thnbln2) " +
                        " " +
                        "select * into tempdefectFin from ( " +
                        "select 'OKKW' fin, sum(qtyout) lembar,sum(qtyout * kubik)kubik from ( " +
                        "select I1.PartNo partno1,I1.Panjang * I1.Lebar luas1,  S.qtyin,I2.PartNo partno2,I2.Panjang * I2.Lebar luas2,  S.qtyout ,(I2.Tebal * I2.Panjang * I2.Lebar)/1000000000 kubik " +
                        "from t3_simetris S inner join T3_Serah Se on S.SerahID =Se.ID inner join fc_items I1 on Se.ItemID=I1.ID inner join fc_items I2 on S.ItemID=I2.id  " +
                        "where I2.lebar>500 and S.RowStatus>-1 and CONVERT(varchar,S.tgltrans,112)>=@thnbln1 and CONVERT(varchar,S.tgltrans,112)<=@thnbln2 )a where partno1 like '%-1-%' and luas1>=luas2*2 and partno2 like '%-p-%' " +
                        "union all " +
                        "select 'BP' fin, sum(qtyout) lembar,sum(qtyout * kubik)kubik from ( " +
                        "select I1.PartNo partno1,I1.Panjang * I1.Lebar luas1,  S.qtyin,I2.PartNo partno2,I2.Panjang * I2.Lebar luas2,  S.qtyout ,(I2.Tebal * I2.Panjang * I2.Lebar)/1000000000 kubik " +
                        "from t3_simetris S inner join T3_Serah Se on S.SerahID =Se.ID inner join fc_items I1 on Se.ItemID=I1.ID inner join fc_items I2 on S.ItemID=I2.id  " +
                        "where I2.lebar>500 and S.RowStatus>-1 and CONVERT(varchar,S.tgltrans,112)>=@thnbln1 and CONVERT(varchar,S.tgltrans,112)<=@thnbln2  )a where partno1 like '%-1-%' and luas1>=luas2*2 and  " +
                        "(partno2 like '%-3-%' or partno2 like '%-w-%' or partno2 like '%-m-%') " +
                        "union all " +
                        "select 'BS' fin,sum(R.QtyIn) Lembar,sum(R.QtyIn *((I.tebal*I.panjang*I.lebar)/1000000000)) kubik from T3_Rekap R inner join FC_Items I on R.ItemID=I.id inner join fc_lokasi L on R.LokID =L.id where R.RowStatus>-1 and  " +
                        "CONVERT(varchar,R.tgltrans,112)>=@thnbln1 and CONVERT(varchar,R.tgltrans,112)<=@thnbln2 and I.PartNo like '%-s-%' and Process='direct')A " +
                        " " +
                        "declare @TotalPotong decimal(18,2) " +
                        "declare @TotalDefKhusus decimal(18,2) " +
                        "declare @DefKhusus decimal(18,2) " +
                        "declare @Ttotalkw1kw2 decimal(18,2) " +
                        "declare @NCSortir decimal(18,2) " +
                        "declare @Retur decimal(18,2) " +
                        "set @TotalPotong=isnull((select sum(totpotong ) from tempdefectGPIsoTot),0) " +
                        "if @TotalPotong >0  " +
                        "begin " +
                        "set @TotalDefKhusus=isnull((select sum(Lembar) from tempdefectFin),0) " +
                        "set @DefKhusus=isnull((select sum(Lembar) from tempdefectFin where fin<>'bp'),0) " +
                        "set @Ttotalkw1kw2 =isnull((select sum(qtyin) from T3_Rekap R inner join fc_items I on R.itemid=I.ID  " +
                        "where R.rowstatus>-1 and R.Process  like '%simetris%' and CONVERT(varchar,R.tgltrans,112)>=@thnbln1 and CONVERT(varchar,R.tgltrans,112)<=@thnbln2   " +
                        "and I.lebar=1200 and I.panjang=2400 and R.keterangan like '%-p-%' and (I.partno like '%-3-%' or I.partno like '%-W-%' or I.partno like '%-M-%' )),0) " +
                        "set @NCSortir=isnull((select sum(QtyAkhirSS)+sum(QtyAkhirSE)/*sum(M3AkhirSS)+sum(M3AkhirSE)*/ from (  " +
                        "SELECT B.tgltrans as Tanggal, I1.PartNo as PartnoAwal, sum(B.QtyIn) as QtyAwal,sum(I1.Volume*B.QtyIn) M3Awal,   " +
                        "I2.PartNo AS PartnoAkhir, case when B.NCSS>0 then sum(B.QtyOut) else 0 end QtyAkhirSS,  " +
                        "case when B.NCSS>0 then sum(I2.Volume*B.QtyOut) else 0 end M3AkhirSS,case when B.NCSE>0 then sum(B.QtyOut) else 0 end QtyAkhirSE,  " +
                        "case when B.NCSE>0 then sum(I2.Volume*B.QtyOut) else 0 end M3AkhirSE,B.NCSS,B.NCSE  FROM T3_Serah AS A   " +
                        "INNER JOIN T3_Simetris AS B ON A.ID = B.SerahID INNER JOIN FC_Items AS I1 ON A.ItemID = I1.ID INNER JOIN   " +
                        "FC_Items AS I2 ON B.ItemID = I2.ID LEFT JOIN T3_GroupM AS D ON B.GroupID = D.ID   " +
                        "where (B.NCSS>0 or B.NCSE>0) and B.rowstatus>-1 and CONVERT(varchar,B.tgltrans,112)>=@thnbln1 and CONVERT(varchar,B.tgltrans,112)<=@thnbln2   " +
                        "group by B.tgltrans,I1.PartNo,I2.PartNo,B.NCSS,B.NCSE) S),0) " +
                        "set @Retur=isnull((select sum(qty) from ( " +
                        "select sum(qty ) qty from t3_retur R inner join fc_items I on R.itemid=I.id where R.rowstatus>-1 and  " +
                        "R.typer=1 and (I.partno like '%-p-%' or I.partno like '%-S-%')and CONVERT(varchar,R.tgltrans,112)>=@thnbln1 and CONVERT(varchar,R.tgltrans,112)<=@thnbln2  " +
                        "union all " +
                        "select sum(qty)*-1 qty from t3_retur R inner join fc_items I on R.itemid=I.id where R.rowstatus>-1 and  " +
                        "R.typer=2 and (I.partno like '%-p-%' or I.partno like '%-S-%') and CONVERT(varchar,R.tgltrans,112)>=@thnbln1 and CONVERT(varchar,R.tgltrans,112)<=@thnbln2 " +
                        "union all " +
                        "select sum(qty) qty from t3_returO R inner join fc_items I on R.itemid=I.id where R.rowstatus>-1 " +
                        " and (I.partno like '%-p-%' or I.partno like '%-S-%') and CONVERT(varchar,R.tgltrans,112)>=@thnbln1 and CONVERT(varchar,R.tgltrans,112)<=@thnbln2 " +
                        ")A),0) " +
                        " " +
                        "declare @TotalPotongL1 decimal(18,2) " +
                        "declare @TotDefKhususL1 decimal(18,2) " +
                        "declare @DefKhususL1 decimal(18,2) " +
                        "declare @Ttotalkw1kw2L1 decimal(18,2) " +
                        "declare @NCSortirL1 decimal(18,2) " +
                        "declare @ReturL1 decimal(18,2) " +
                        "declare @DefectFinL1 decimal(18,2) " +
                        "set @TotalPotongL1=(select sum(totpotong ) from tempdefectGPIsoTot where [group]in (select [group] from BM_PlantGroup  " +
                        "where PlantID in (select id from BM_Plant where PlantName='line 1'))) " +
                        "set @TotDefKhususL1=(@TotalPotongL1/@TotalPotong)*@TotalDefKhusus " +
                        "set @DefKhususL1=(@TotalPotongL1/@TotalPotong)*@DefKhusus " +
                        "set @Ttotalkw1kw2L1=(@TotalPotongL1/@TotalPotong)*@Ttotalkw1kw2 " +
                        "set @NCSortirL1=(@TotalPotongL1/@TotalPotong)*@NCSortir " +
                        "set @ReturL1=(@TotalPotongL1/@TotalPotong)*@Retur " +
                        "set @DefectFinL1=isnull((@TotalPotongL1/@TotalPotong)*@DefectFin,0) " +
                        "if @TotalPotongL1>0 " +
                        "begin " +
                        "select * into tempdefectL1 from ( " +
                        "select *,c-d+e+f+g+h i,case when b>0 then (c-d+e+f+g+h)/b*100 else 0  end j from ( " +
                        "select [Group],case when @TotalPotongL1>0 then isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) +  " +
                        "  (( isnull(( select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@TotDefKhususL1)  else 0 end b, " +
                        " case when @TotalPotongL1>0 then isnull((select totdefectK from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)  else 0 end c, " +
                        " case when @TotalPotongL1>0 then ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@Ttotalkw1kw2L1) else 0 end  d, " +
                        " case when @TotalPotongL1>0 then ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@NCSortirL1)  else 0 end  e, " +
                        " case when @TotalPotongL1>0 then ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@ReturL1)  else 0 end  f, " +
                        " case when @TotalPotongL1>0 then ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@DefectFinL1)  else 0 end g, " +
                        " case when @TotalPotongL1>0 then ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@DefKhususL1) else 0 end  h " +
                        " from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 1') )A " +
                        "union all  " +
                        "select 'Total' [Group],sum(b)b,sum(c)c,sum(d)d,sum(e)e,sum(f)f,sum(g)g,sum(h)h,sum(c)-sum(d)+sum(e)+sum(f)+sum(g)+sum(h) i " +
                        ",(sum(c)-sum(d)+sum(e)+sum(f)+sum(g)+sum(h))/sum(b)*100 j from( " +
                        "select [Group],case when @TotalPotongL1>0 then isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) +  " +
                        "  (( isnull(( select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@TotDefKhususL1)  else 0 end b, " +
                        " case when @TotalPotongL1>0 then isnull((select totdefectK from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)  else 0 end c, " +
                        " case when @TotalPotongL1>0 then ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@Ttotalkw1kw2L1) else 0 end  d, " +
                        " case when @TotalPotongL1>0 then ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@NCSortirL1)  else 0 end  e, " +
                        " case when @TotalPotongL1>0 then ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@ReturL1)  else 0 end  f, " +
                        " case when @TotalPotongL1>0 then ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@DefectFinL1)  else 0 end g, " +
                        " case when @TotalPotongL1>0 then ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@DefKhususL1) else 0 end  h, " +
                        " 0 i,0 j from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 1'))A )B " +
                        " end " +
                        " else " +
                        " begin " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 h,0 i, 0 j into tempdefectL1 " +
                        " end " +
                        " " +
                        "declare @TotalPotongL2 decimal(18,2) " +
                        "declare @TotDefKhususL2 decimal(18,2) " +
                        "declare @DefKhususL2 decimal(18,2) " +
                        "declare @Ttotalkw1kw2L2 decimal(18,2) " +
                        "declare @NCSortirL2 decimal(18,2) " +
                        "declare @ReturL2 decimal(18,2) " +
                        "declare @DefectFinL2 decimal(18,2) " +
                        "set @TotalPotongL2=(select sum(totpotong ) from tempdefectGPIsoTot where [group]in (select [group] from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 2'))) " +
                        " " +
                        "set @TotDefKhususL2=(@TotalPotongL2/@TotalPotong)*@TotalDefKhusus " +
                        "set @DefKhususL2=(@TotalPotongL2/@TotalPotong)*@DefKhusus " +
                        "set @Ttotalkw1kw2L2=(@TotalPotongL2/@TotalPotong)*@Ttotalkw1kw2 " +
                        "set @NCSortirL2=(@TotalPotongL2/@TotalPotong)*@NCSortir " +
                        "set @ReturL2=(@TotalPotongL2/@TotalPotong)*@Retur " +
                        "set @DefectFinL2=isnull((@TotalPotongL2/@TotalPotong)*@DefectFin,0) " +
                        "if @TotalPotongL2>0 " +
                        "begin " +
                        "select * into tempdefectL2 from ( " +
                        "select *,c-d+e+f+g+h i,case when b>0 then (c-d+e+f+g+h)/b*100 else 0  end j from ( " +
                        "select [Group],case when @TotalPotongL2>0 then isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) +  " +
                        " ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL2)*@TotDefKhususL2) else 0 end  b, " +
                        " case when @TotalPotongL2>0 then isnull((select totdefectK from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) else 0 end c, " +
                        " case when @TotalPotongL2>0 then ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL2)*@Ttotalkw1kw2L2) else 0 end  d, " +
                        " case when @TotalPotongL2>0 then ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL2)*@NCSortirL2) else 0 end  e, " +
                        " case when @TotalPotongL2>0 then ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL2)*@ReturL2)  else 0 end f, " +
                        " case when @TotalPotongL2>0 then ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL2)*@DefectFinL2) else 0 end  g, " +
                        " case when @TotalPotongL2>0 then ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL2)*@DefKhususL2) else 0 end  h " +
                        "  from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 2') )A " +
                        "union all  " +
                        "select 'Total' [Group],sum(b)b,sum(c)c,sum(d)d,sum(e)e,sum(f)f,sum(g)g,sum(h)h,sum(c)-sum(d)+sum(e)+sum(f)+sum(g)+sum(h) i " +
                        ",(sum(c)-sum(d)+sum(e)+sum(f)+sum(g)+sum(h))/sum(b)*100 j from( " +
                        "select [Group],case when @TotalPotongL2>0 then isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) +  " +
                        " ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL2)*@TotDefKhususL2) else 0 end  b, " +
                        " case when @TotalPotongL2>0 then isnull((select totdefectK from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) else 0 end c, " +
                        " case when @TotalPotongL2>0 then ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL2)*@Ttotalkw1kw2L2) else 0 end  d, " +
                        " case when @TotalPotongL2>0 then ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL2)*@NCSortirL2) else 0 end  e, " +
                        " case when @TotalPotongL2>0 then ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL2)*@ReturL2)  else 0 end f, " +
                        " case when @TotalPotongL2>0 then ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL2)*@DefectFinL2) else 0 end  g, " +
                        " case when @TotalPotongL2>0 then ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL2)*@DefKhususL2) else 0 end  h, " +
                        " 0 i,0 j from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 2'))A )B " +
                        " end " +
                        " else " +
                        " begin " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 h,0 i, 0 j into tempdefectL2 " +
                        " end " +
                        " " +
                        "declare @TotalPotongL3 decimal(18,2) " +
                        "declare @TotDefKhususL3 decimal(18,2) " +
                        "declare @DefKhususL3 decimal(18,2) " +
                        "declare @Ttotalkw1kw2L3 decimal(18,2) " +
                        "declare @NCSortirL3 decimal(18,2) " +
                        "declare @ReturL3 decimal(18,2) " +
                        "declare @DefectFinL3 decimal(18,2) " +
                        "set @TotalPotongL3=(select sum(totpotong ) from tempdefectGPIsoTot where [group]in (select [group] from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 3'))) " +
                        "set @TotDefKhususL3=(@TotalPotongL3/@TotalPotong)*@TotalDefKhusus " +
                        "set @DefKhususL3=(@TotalPotongL3/@TotalPotong)*@DefKhusus " +
                        "set @Ttotalkw1kw2L3=(@TotalPotongL3/@TotalPotong)*@Ttotalkw1kw2 " +
                        "set @NCSortirL3=(@TotalPotongL3/@TotalPotong)*@NCSortir " +
                        "set @ReturL3=(@TotalPotongL3/@TotalPotong)*@Retur " +
                        "set @DefectFinL3=isnull((@TotalPotongL3/@TotalPotong)*@DefectFin,0) " +
                        "if @TotalPotongL3>0 " +
                        "begin " +
                        "select * into tempdefectL3 from ( " +
                        "select *,c-d+e+f+g+h i,case when b>0 then (c-d+e+f+g+h)/b*100 else 0  end j from ( " +
                        "select [Group],case when @TotalPotongL3>0 then isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) +  " +
                        " ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@TotDefKhususL3) else 0 end  b, " +
                        " case when @TotalPotongL3>0 then isnull((select totdefectK from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) else 0 end c, " +
                        " case when @TotalPotongL3>0 then ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@Ttotalkw1kw2L3) else 0 end  d, " +
                        " case when @TotalPotongL3>0 then ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@NCSortirL3) else 0 end  e, " +
                        " case when @TotalPotongL3>0 then ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@ReturL3) else 0 end  f, " +
                        " case when @TotalPotongL3>0 then ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@DefectFinL3) else 0 end  g, " +
                        " case when @TotalPotongL3>0 then ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@DefKhususL3) else 0 end  h " +
                        "  from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 3') )A " +
                        "union all  " +
                        "select 'Total' [Group],sum(b)b,sum(c)c,sum(d)d,sum(e)e,sum(f)f,sum(g)g,sum(h)h,sum(c)-sum(d)+sum(e)+sum(f)+sum(g)+sum(h) i " +
                        ",(sum(c)-sum(d)+sum(e)+sum(f)+sum(g)+sum(h))/sum(b)*100 j from( " +
                        "select [Group],isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) +  " +
                        " ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@TotDefKhususL3) b, " +
                        " isnull((select totdefectK from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)c, " +
                        " ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@Ttotalkw1kw2L3) d, " +
                        " ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@NCSortirL3) e, " +
                        " ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@ReturL3) f, " +
                        " ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@DefectFinL3) g, " +
                        " ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@DefKhususL3) h, " +
                        " 0 i,0 j from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 3'))A )B " +
                        " end " +
                        " else " +
                        " begin " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 h,0 i, 0 j into tempdefectL3 " +
                        " end " +
                        " " +
                        "declare @TotalPotongL4 decimal(18,2) " +
                        "declare @TotDefKhususL4 decimal(18,2) " +
                        "declare @DefKhususL4 decimal(18,2) " +
                        "declare @Ttotalkw1kw2L4 decimal(18,2) " +
                        "declare @NCSortirL4 decimal(18,2) " +
                        "declare @ReturL4 decimal(18,2) " +
                        "declare @DefectFinL4 decimal(18,2) " +
                        "set @TotalPotongL4=(select sum(totpotong ) from tempdefectGPIsoTot where [group]in (select [group] from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 4'))) " +
                        "set @TotDefKhususL4=(@TotalPotongL4/@TotalPotong)*@TotalDefKhusus " +
                        "set @DefKhususL4=(@TotalPotongL4/@TotalPotong)*@DefKhusus " +
                        "set @Ttotalkw1kw2L4=(@TotalPotongL4/@TotalPotong)*@Ttotalkw1kw2 " +
                        "set @NCSortirL4=(@TotalPotongL4/@TotalPotong)*@NCSortir " +
                        "set @ReturL4=(@TotalPotongL4/@TotalPotong)*@Retur " +
                        "set @DefectFinL4=isnull((@TotalPotongL4/@TotalPotong)*@DefectFin,0) " +
                        "if @TotalPotongL4>0 " +
                        "begin " +
                        "select * into tempdefectL4 from ( " +
                        "select *,c-d+e+f+g+h i,case when b>0 then (c-d+e+f+g+h)/b*100 else 0  end j from ( " +
                        "select [Group],case when @TotalPotongL4>0 then isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) +  " +
                        " ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@TotDefKhususL4) else 0 end  b, " +
                        " case when @TotalPotongL4>0 then isnull((select totdefectK from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) else 0 end c, " +
                        " case when @TotalPotongL4>0 then ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@Ttotalkw1kw2L4) else 0 end  d, " +
                        " case when @TotalPotongL4>0 then ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@NCSortirL4) else 0 end  e, " +
                        " case when @TotalPotongL4>0 then ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@ReturL4) else 0 end  f, " +
                        " case when @TotalPotongL4>0 then ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@DefectFinL4) else 0 end  g, " +
                        " case when @TotalPotongL4>0 then ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@DefKhususL4) else 0 end  h " +
                        "  from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 4') )A " +
                        "union all  " +
                        "select 'Total' [Group],sum(b)b,sum(c)c,sum(d)d,sum(e)e,sum(f)f,sum(g)g,sum(h)h,sum(c)-sum(d)+sum(e)+sum(f)+sum(g)+sum(h) i " +
                        ",(sum(c)-sum(d)+sum(e)+sum(f)+sum(g)+sum(h))/sum(b)*100 j from( " +
                        "select [Group],isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) +  " +
                        " ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@TotDefKhususL4) b, " +
                        " isnull((select totdefectK from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)c, " +
                        " ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@Ttotalkw1kw2L4) d, " +
                        " ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@NCSortirL4) e, " +
                        " ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@ReturL4) f, " +
                        " ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@DefectFinL4) g, " +
                        " ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@DefKhususL4) h, " +
                        " 0 i,0 j from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 4'))A )B " +
                        " end " +
                        " else " +
                        " begin " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 h,0 i, 0 j into tempdefectL4 " +
                        " end " +
                        " " +
                        "declare @TotalPotongL5 decimal(18,2) " +
                        "declare @TotDefKhususL5 decimal(18,2) " +
                        "declare @DefKhususL5 decimal(18,2) " +
                        "declare @Ttotalkw1kw2L5 decimal(18,2) " +
                        "declare @NCSortirL5 decimal(18,2) " +
                        "declare @ReturL5 decimal(18,2) " +
                        "declare @DefectFinL5 decimal(18,2) " +
                        "set @TotalPotongL5=(select sum(totpotong ) from tempdefectGPIsoTot where [group]in (select [group] from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 5'))) " +
                        "set @TotDefKhususL5=(@TotalPotongL5/@TotalPotong)*@TotalDefKhusus " +
                        "set @DefKhususL5=(@TotalPotongL5/@TotalPotong)*@DefKhusus " +
                        "set @Ttotalkw1kw2L5=(@TotalPotongL5/@TotalPotong)*@Ttotalkw1kw2 " +
                        "set @NCSortirL5=(@TotalPotongL5/@TotalPotong)*@NCSortir " +
                        "set @ReturL5=(@TotalPotongL5/@TotalPotong)*@Retur " +
                        "set @DefectFinL5=isnull((@TotalPotongL5/@TotalPotong)*@DefectFin,0) " +
                        "if @TotalPotongL5>0 " +
                        "begin " +
                        "select * into tempdefectL5 from ( " +
                        "select *,c-d+e+f+g+h i,case when b>0 then (c-d+e+f+g+h)/b*100 else 0  end j from ( " +
                        "select [Group],case when @TotalPotongL5>0 then isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) +  " +
                        " ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@TotDefKhususL5) else 0 end  b, " +
                        " case when @TotalPotongL5>0 then isnull((select totdefectK from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) else 0 end c, " +
                        " case when @TotalPotongL5>0 then ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@Ttotalkw1kw2L5) else 0 end  d, " +
                        " case when @TotalPotongL5>0 then ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@NCSortirL5) else 0 end  e, " +
                        " case when @TotalPotongL5>0 then ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@ReturL5) else 0 end  f, " +
                        " case when @TotalPotongL5>0 then ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@DefectFinL5) else 0 end  g, " +
                        " case when @TotalPotongL5>0 then ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@DefKhususL5) else 0 end  h " +
                        "  from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 5') )A " +
                        "union all  " +
                        "select 'Total' [Group],sum(b)b,sum(c)c,sum(d)d,sum(e)e,sum(f)f,sum(g)g,sum(h)h,sum(c)-sum(d)+sum(e)+sum(f)+sum(g)+sum(h) i " +
                        ",(sum(c)-sum(d)+sum(e)+sum(f)+sum(g)+sum(h))/sum(b)*100 j from( " +
                        "select [Group],isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) +  " +
                        " ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@TotDefKhususL5) b, " +
                        " isnull((select totdefectK from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)c, " +
                        " ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@Ttotalkw1kw2L5) d, " +
                        " ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@NCSortirL5) e, " +
                        " ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@ReturL5) f, " +
                        " ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@DefectFinL5) g, " +
                        " ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@DefKhususL5) h, " +
                        " 0 i,0 j from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 5'))A )B " +
                        " end " +
                        " else " +
                        " begin " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 h,0 i, 0 j into tempdefectL5 " +
                        " end " +
                        " " +
                        "declare @TotalPotongL6 decimal(18,2) " +
                        "declare @TotDefKhususL6 decimal(18,2) " +
                        "declare @DefKhususL6 decimal(18,2) " +
                        "declare @Ttotalkw1kw2L6 decimal(18,2) " +
                        "declare @NCSortirL6 decimal(18,2) " +
                        "declare @ReturL6 decimal(18,2) " +
                        "declare @DefectFinL6 decimal(18,2) " +
                        "set @TotalPotongL6=(select sum(totpotong ) from tempdefectGPIsoTot where [group]in (select [group] from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 6'))) " +
                        "set @TotDefKhususL6=(@TotalPotongL6/@TotalPotong)*@TotalDefKhusus " +
                        "set @DefKhususL6=(@TotalPotongL6/@TotalPotong)*@DefKhusus " +
                        "set @Ttotalkw1kw2L6=(@TotalPotongL6/@TotalPotong)*@Ttotalkw1kw2 " +
                        "set @NCSortirL6=(@TotalPotongL6/@TotalPotong)*@NCSortir " +
                        "set @ReturL6=(@TotalPotongL6/@TotalPotong)*@Retur " +
                        "set @DefectFinL6=isnull((@TotalPotongL6/@TotalPotong)*@DefectFin,0) " +
                        "if @TotalPotongL6>0 " +
                        "begin " +
                        "select * into tempdefectL6 from ( " +
                        "select *,c-d+e+f+g+h i,case when b>0 then (c-d+e+f+g+h)/b*100 else 0  end j from ( " +
                        "select [Group],case when @TotalPotongL6>0 then isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) +  " +
                        " ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@TotDefKhususL6)  else 0 end b, " +
                        " case when @TotalPotongL6>0 then isnull((select totdefectK from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) else 0 end c, " +
                        " case when @TotalPotongL6>0 then ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@Ttotalkw1kw2L6)  else 0 end d, " +
                        " case when @TotalPotongL6>0 then ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@NCSortirL6)  else 0 end e, " +
                        " case when @TotalPotongL6>0 then ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@ReturL6)  else 0 end f, " +
                        " case when @TotalPotongL6>0 then ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@DefectFinL6)  else 0 end g, " +
                        " case when @TotalPotongL6>0 then ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@DefKhususL6) else 0 end  h " +
                        "  from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 6') )A " +
                        "union all  " +
                        "select 'Total' [Group],sum(b)b,sum(c)c,sum(d)d,sum(e)e,sum(f)f,sum(g)g,sum(h)h,sum(c)-sum(d)+sum(e)+sum(f)+sum(g)+sum(h) i " +
                        ",(sum(c)-sum(d)+sum(e)+sum(f)+sum(g)+sum(h))/sum(b)*100 j from( " +
                        "select [Group],isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) +  " +
                        " ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@TotDefKhususL6) b, " +
                        " isnull((select totdefectK from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)c, " +
                        " ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@Ttotalkw1kw2L6) d, " +
                        " ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@NCSortirL6) e, " +
                        " ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@ReturL6) f, " +
                        " ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@DefectFinL6) g, " +
                        " ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@DefKhususL6) h, " +
                        " 0 i,0 j from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 6'))A )B " +
                        " end " +
                        " else " +
                        " begin " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 h,0 i, 0 j into tempdefectL6 " +
                        " end " +
                        " " +
                        " end " +
                        " else " +
                        " begin " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 h,0 i, 0 j into tempdefectL1 " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 h,0 i, 0 j into tempdefectL2 " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 h,0 i, 0 j into tempdefectL3 " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 h,0 i, 0 j into tempdefectL4 " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 h,0 i, 0 j into tempdefectL5 " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 h,0 i, 0 j into tempdefectL6 " +
                        " end " +

                        " select * from tempdefectL1 ";
                #endregion
            }
            /** Plant Citeureup **/
            #region Citeureup
            else if (users.UnitKerjaID == 1 || users.UnitKerjaID == 13)
            {
                if (RBKubik.Checked == true)
                {
                    /** Beny 13 Mei 2022 **/
                    if (Convert.ToInt32(strtgl1.Substring(0, 6)) > 202203)
                    {
                        logikaretur =
                        " isnull((select cast(Qty1-Qty2+Qty3+Qty4 as decimal(18,2))M3 " +
                        " from (  select cast(sum(Tot1*volume) as decimal(18,2))Qty1,cast(sum(Tot2*volume) as decimal(18,2))Qty2, " +
                        " cast(sum(Tot3*volume) as decimal(18,2))Qty3,cast(sum(Tot4*volume) as decimal(18,2))Qty4 from ( " +
                        " select tanggal,PartNo,volume ,sum(isnull(QtyC1,0))QtyC1,sum(isnull(QtyP1,0)) QtyP1,sum(isnull(QtyS1,0)) QtyS1,sum(isnull(Tot1,0)) " +
                        " Tot1,sum(isnull(TotK1,0)) TotK1, sum(isnull(QtyC2,0)) QtyC2,sum(isnull(QtyP2,0)) QtyP2,sum(isnull(QtyS2,0)) " +
                        " QtyS2,sum(isnull(Tot2,0)) Tot2, sum(isnull(TotK2,0)) TotK2,sum(isnull(QtyC3,0)) QtyC3,sum(isnull(QtyP3,0)) QtyP3, " +
                        " sum(isnull(QtyS3,0)) QtyS3,sum(isnull(Tot3,0)) Tot3,sum(isnull(TotK3,0)) TotK3, sum(isnull(QtyC4,0)) QtyC4,sum(isnull(QtyP4,0)) " +
                        " QtyP4,sum(isnull(QtyS4,0)) QtyS4,sum(isnull(Tot4,0)) Tot4,sum(isnull(TotK4,0)) TotK4, sum(isnull(QtyC5,0)) QtyC5,sum(isnull(QtyP5,0)) " +
                        " QtyP5,sum(isnull(QtyS5,0)) QtyS5,sum(isnull(Tot5,0)) Tot5,sum(isnull(TotK5,0)) TotK5 from ( select tanggal ,PartNo,volume, " +
                        " case when typeR=1 and ((KW='3' or KW='W')or lokasi='cl') then Qty end QtyC1,case when typeR=1 and (KW='P'and lokasi <> 'cl') " +
                        " then Qty end QtyP1, case when typeR=1 and (KW='S'and lokasi <> 'cl') then Qty end QtyS1, case when typeR=1 and ((KW='P' or KW='S') " +
                        " and lokasi <> 'cl') then Qty end Tot1, case when typeR=1 and (KW='P' or KW='S') then QtyK end TotK1, " +
                        " case when typeR=2 and ((KW='3' or KW='W')or lokasi='cl') then Qty end QtyC2, case when typeR=2 and (KW='P' and lokasi <> 'cl') " +
                        " then Qty end QtyP2, case when typeR=2 and (KW='S' and lokasi <> 'cl') then Qty end QtyS2, case when typeR=2 and ((KW='P' or KW='S') " +
                        " and lokasi <> 'cl') then Qty end Tot2, case when typeR=2 and ((KW='P' or KW='S') and lokasi <> 'cl') then QtyK end TotK2, " +
                        " case when typeR=3 and ((KW='3' or KW='W')or lokasi='cl') then Qty end QtyC3, case when typeR=3 and (KW='P' and lokasi <> 'cl') " +
                        " then Qty end QtyP3, case when typeR=3 and (KW='S' and lokasi <> 'cl') then Qty end QtyS3, case when typeR=3 and ((KW='P' or KW='S') " +
                        " and lokasi <> 'cl') then Qty   end Tot3, case when typeR=3 and ((KW='P' or KW='S') and lokasi <> 'cl') then QtyK end TotK3, " +
                        " case when typeR=5 and ((KW='3' or KW='W')or lokasi='cl') then Qty end QtyC4,  case when typeR=5 and (KW='P' and lokasi <> 'cl') " +
                        " then Qty end QtyP4,  case when typeR=5 and (KW='S' and lokasi <> 'cl') then Qty end QtyS4,  case when typeR=5 " +
                        " and ((KW='P' or KW='S') and lokasi <> 'cl') then Qty   end Tot4,  case when typeR=5 and ((KW='P' or KW='S') and lokasi <> 'cl') " +
                        " then QtyK end TotK4,  case when typeR=4 and ((KW='3' or KW='W')or lokasi='cl') then Qty end QtyC5, " +
                        " case when typeR=4 and (KW='P' and lokasi <> 'cl') then Qty end QtyP5,  case when typeR=4 and (KW='S' and lokasi <> 'cl') " +
                        " then Qty end QtyS5,  case when typeR=4 and ((KW='P' or KW='S') and lokasi <> 'cl') then Qty   end Tot5, " +
                        " case when typeR=4 and ((KW='P' or KW='S') and lokasi <> 'cl') then QtyK end TotK5 " +
                        " from (     select R.TglTrans tanggal,I.PartNo,I.volume,SUBSTRING(I.partno,5,1) as KW,sum(R.Qty)Qty,  " +
                        " sum(((I.Panjang*I.Lebar)/(1220*2440) ) * R.Qty) QtyK,isnull(R.TypeR,1)  TypeR,I.ID,L.Lokasi   " +
                        " from T3_Retur R inner join FC_Items I on R.ItemID =I.ID  inner join FC_lokasi L on R.LokID=L.ID " +
                        " where R.RowStatus>-1     group by R.TglTrans,I.PartNo,I.volume,R.TypeR,I.ID,L.Lokasi " +
                        " union all " +
                        " select R.TglTrans tanggal,I.PartNo,I.volume,SUBSTRING(I.partno,5,1) as KW,sum(R.Qty)Qty, " +
                        " sum(((I.Panjang*I.Lebar)/(1220*2440) ) * R.Qty) QtyK,3  TypeR,I.ID,L.Lokasi   " +
                        " from T3_ReturO R inner join FC_Items I on R.ItemID =I.ID  inner join FC_lokasi L on R.LokID=L.ID  where R.RowStatus>-1  " +
                        " group by R.TglTrans,I.PartNo,I.volume,I.ID,L.Lokasi ) as A ) as B " +
                        " where convert(char,tanggal,112)>=@thnbln1  and convert(char,tanggal,112)<=@thnbln2 " +
                        " group by tanggal,PartNo,volume  )  as x ) as xx ),0) ";
                    }
                    else
                    {
                        logikaretur =
                        " isnull((select cast((TotK1/**-TotK2)+TotK3**/) as decimal(18,2))M3 " +
                        " from (  select cast((sum(Volume*Tot1)) as decimal(18,2)) TotK1,cast((sum(Volume*Tot2)) as decimal(18,2)) TotK2, " +
                        " cast((sum(Volume*Tot3)) as decimal(18,2)) TotK3 " +
                        " from (  select tanggal,PartNo,volume ,sum(isnull(QtyC1,0))QtyC1,sum(isnull(QtyP1,0)) QtyP1,sum(isnull(QtyS1,0)) QtyS1, " +
                        " sum(isnull(Tot1,0)) Tot1,sum(isnull(TotK1,0)) TotK1, sum(isnull(QtyC2,0)) QtyC2,sum(isnull(QtyP2,0)) QtyP2,sum(isnull(QtyS2,0)) " +
                        " QtyS2,sum(isnull(Tot2,0)) Tot2, sum(isnull(TotK2,0)) TotK2,sum(isnull(QtyC3,0)) QtyC3,sum(isnull(QtyP3,0)) QtyP3, " +
                        " sum(isnull(QtyS3,0)) QtyS3,sum(isnull(Tot3,0)) Tot3,sum(isnull(TotK3,0)) TotK3 from ( select tanggal ,PartNo,volume, " +
                        " case when typeR=1 and ((KW='3' or KW='W')or lokasi='cl') then Qty end QtyC1,case when typeR=1 and (KW='P'and lokasi <> 'cl') " +
                        " then Qty end QtyP1, case when typeR=1 and (KW='S'and lokasi <> 'cl') then Qty end QtyS1, case when typeR=1 and ((KW='P' or KW='S') " +
                        " and lokasi <> 'cl') then Qty end Tot1, case when typeR=1 and (KW='P' or KW='S') then QtyK end TotK1, case when typeR=2 " +
                        " and ((KW='3' or KW='W')or lokasi='cl') then Qty end QtyC2, case when typeR=2 and (KW='P' and lokasi <> 'cl') then Qty end QtyP2, " +
                        " case when typeR=2 and (KW='S' and lokasi <> 'cl') then Qty end QtyS2, case when typeR=2 and ((KW='P' or KW='S') and lokasi <> 'cl') " +
                        " then Qty end Tot2, case when typeR=2 and ((KW='P' or KW='S') and lokasi <> 'cl') then QtyK end TotK2, " +
                        " case when typeR=3 and ((KW='3' or KW='W')or lokasi='cl') then Qty end QtyC3, case when typeR=3 and (KW='P' and lokasi <> 'cl') " +
                        " then Qty end QtyP3, case when typeR=3 and (KW='S' and lokasi <> 'cl') then Qty end QtyS3, case when typeR=3 and ((KW='P' or KW='S') " +
                        " and lokasi <> 'cl') then Qty   end Tot3, case when typeR=3 and ((KW='P' or KW='S') and lokasi <> 'cl') then QtyK end TotK3 " +
                        " from (select R.TglTrans tanggal,I.PartNo,I.volume,SUBSTRING(I.partno,5,1) as KW,sum(R.Qty)Qty, " +
                        " sum(((I.Panjang*I.Lebar)/(1220*2440) ) * R.Qty) QtyK,isnull(R.TypeR,1)  TypeR,I.ID,L.Lokasi    " +
                        " from T3_Retur R inner join FC_Items I on R.ItemID =I.ID  inner join FC_lokasi L on R.LokID=L.ID  where R.RowStatus>-1   " +
                        " group by R.TglTrans,I.PartNo,I.volume,R.TypeR,I.ID,L.Lokasi " +
                        " union all " +
                        " select R.TglTrans tanggal,I.PartNo,I.volume,SUBSTRING(I.partno,5,1) as KW,sum(R.Qty)Qty," +
                        " sum(((I.Panjang*I.Lebar)/(1220*2440) ) * R.Qty) QtyK,3  TypeR,I.ID,L.Lokasi     " +
                        " from T3_ReturO R inner join FC_Items I on R.ItemID =I.ID  inner join FC_lokasi L on R.LokID=L.ID  where R.RowStatus>-1  " +
                        " group by R.TglTrans,I.PartNo,I.volume,I.ID,L.Lokasi ) as A ) as B where convert(char,tanggal,112)>=@thnbln1 " +
                        " and convert(char,tanggal,112)<=@thnbln2 group by tanggal,PartNo,volume ) as x ) as x1),0)  ";

                    }

                    #region query kubik
                    if (Convert.ToInt32(strtgl1.Substring(0, 6)) < 201911 && users.UnitKerjaID.ToString() != "13")
                    #region Periode Lama
                    {
                        strSQL = "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectGPIso]') AND type in (N'U')) DROP TABLE [dbo].[tempdefectGPIso]  " +
                        "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectGPIsoTot]') AND type in (N'U')) DROP TABLE [dbo].tempdefectGPIsoTot  " +
                        "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectFin]') AND type in (N'U')) DROP TABLE [dbo].tempdefectFin " +
                        "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectL1]') AND type in (N'U')) DROP TABLE [dbo].tempdefectL1 " +
                        "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectL2]') AND type in (N'U')) DROP TABLE [dbo].tempdefectL2 " +
                        "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectL3]') AND type in (N'U')) DROP TABLE [dbo].tempdefectL3 " +
                        "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectL4]') AND type in (N'U')) DROP TABLE [dbo].tempdefectL4 " +
                        "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectL5]') AND type in (N'U')) DROP TABLE [dbo].tempdefectL5 " +
                        "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectL6]') AND type in (N'U')) DROP TABLE [dbo].tempdefectL6 " +
                                    "declare @thnbln1 varchar(8) " +
                        "declare @thnbln2 varchar(8) " +
                        "set @thnbln1='" + strtgl1 + "' " +
                        "set @thnbln2='" + strtgl2 + "' " +
                                    "select *  into tempdefectGPIso from (  " +
                        "select case when D.DeptID=0 then  " +
                        "case when GJ.GroupJemurName In ('M','N','O','P','Q','R','S','T','U','V','W','X') then   " +
                        "    case when D.DefName='retak' then 2   " +
                        "        when D.DefName='gompal' then 3  " +
                        "    else D.DeptID end   " +
                        "else    " +
                        "    case when (B.Qty/E.Qty) *100 >5 then 2 else 3 end   " +
                        "end  " +
                        "else D.DeptID end deptID1,A.CreatedTime as tglInput,A.Tgl as TglPeriksa,E.TglProduksi as TglProd,  D.DefCode,BP.PlantName as Line, PG.[Group],BF.FormulaCode as Jenis,   " +
                        "D.DefName,D.DeptID,B.ID,B.DefectID,B.MasterID,B.Qty,A.ID  DestID,isnull(A.TPotong,0)  QtyIn,B.Qty*I.Volume as Kubik,isnull(A.TPotong,0) as TotPotong,'' sfrom  " +
                        "from Def_DefectDetail B inner join Def_Defect A on A.Id=B.DefectID   " +
                        "left join Def_MasterDefect D on B.MasterID=D.ID left join BM_Destacking E on E.ID=A.DestID   " +
                        "left join BM_PlantGroup PG on A.GroupProdID=PG.ID left join BM_Formula BF on BF.ID=E.FormulaID    " +
                        "left join BM_Plant BP on BP.ID=E.PlantID left join FC_Items I on I.ID=E.ItemID inner join Def_GroupJemur GJ on GJ.ID=A.GroupJemurID  " +
                        "where B.RowStatus>-1  and D.RowStatus >-1) as Def    " +
                        "where DeptID1=2 and CONVERT(varchar,TglPeriksa,112)>=@thnbln1 and CONVERT(varchar,TglPeriksa,112)<=@thnbln2  " +
                        " " +
                         QueryTotalPotong +
                        " " +
                        "declare @DefectFin decimal(18,2) " +
                        "set @DefectFin= (select sum(kubik) from (  " +
                        "select case when D.DeptID=0 then  " +
                        "case when GJ.GroupJemurName In ('M','N','O','P','Q','R','S','T','U','V','W','X') then   " +
                        "case when D.DefName='retak' then 2   " +
                        "when D.DefName='gompal' then 3  " +
                        "else D.DeptID end   " +
                        "else    " +
                        "case when (B.Qty/E.Qty) *100 >5 then 2 else 3 end   " +
                        "end  " +
                        "else D.DeptID end deptID1,A.CreatedTime as tglInput,A.Tgl as TglPeriksa,E.TglProduksi as TglProd,  D.DefCode,BP.PlantName as Line, PG.[Group],BF.FormulaCode as Jenis,   " +
                        "D.DefName,D.DeptID,B.ID,B.DefectID,B.MasterID,B.Qty,A.ID  DestID,isnull(A.TPotong,0)  QtyIn,B.Qty*I.Volume as Kubik,isnull(A.TPotong,0) as TotPotong,'' sfrom  " +
                        "from Def_DefectDetail B inner join Def_Defect A on A.Id=B.DefectID   " +
                        "left join Def_MasterDefect D on B.MasterID=D.ID left join BM_Destacking E on E.ID=A.DestID   " +
                        "left join BM_PlantGroup PG on A.GroupProdID=PG.ID left join BM_Formula BF on BF.ID=E.FormulaID    " +
                        "left join BM_Plant BP on BP.ID=E.PlantID left join FC_Items I on I.ID=E.ItemID inner join Def_GroupJemur GJ on GJ.ID=A.GroupJemurID  " +
                        "where B.RowStatus>-1  and D.RowStatus >-1) as Def    " +
                        "where DeptID1<>2 and CONVERT(varchar,TglPeriksa,112)>=@thnbln1 and CONVERT(varchar,TglPeriksa,112)<=@thnbln2) " +
                        " " +
                        "select * into tempdefectFin from ( " +
                        "select 'OKKW' fin, sum(qtyin) lembar,sum(qtyin * kubik)kubik from ( " +
                        "select I1.PartNo partno1,I1.Panjang * I1.Lebar luas1,  S.qtyin,I2.PartNo partno2,I2.Panjang * I2.Lebar luas2,  S.qtyout ,(I1.Tebal * I1.Panjang * I1.Lebar)/1000000000 kubik " +
                        "from t3_simetris S inner join T3_Serah Se on S.SerahID =Se.ID inner join fc_items I1 on Se.ItemID=I1.ID inner join fc_items I2 on S.ItemID=I2.id  " +
                        "where I2.lebar>500 and S.RowStatus>-1 and CONVERT(varchar,S.tgltrans,112)>=@thnbln1 and CONVERT(varchar,S.tgltrans,112)<=@thnbln2 )a where partno1 like '%-1-%' and luas2/luas1 *100<60 and partno2 like '%-p-%' " +
                        "union all " +
                        "select 'BP' fin, sum(qtyin) lembar,sum(qtyin * kubik)kubik from ( " +
                        "select I1.PartNo partno1,I1.Panjang * I1.Lebar luas1,  S.qtyin,I2.PartNo partno2,I2.Panjang * I2.Lebar luas2,  S.qtyout ,(I1.Tebal * I1.Panjang * I1.Lebar)/1000000000 kubik " +
                        "from t3_simetris S inner join T3_Serah Se on S.SerahID =Se.ID inner join fc_items I1 on Se.ItemID=I1.ID inner join fc_items I2 on S.ItemID=I2.id  " +
                        "where S.RowStatus>-1 and CONVERT(varchar,S.tgltrans,112)>=@thnbln1 and CONVERT(varchar,S.tgltrans,112)<=@thnbln2  )a where partno1 like '%-1-%' and luas2/luas1 *100<60 and  " +
                        "(partno2 like '%-3-%' or partno2 like '%-w-%' or partno2 like '%-m-%') " +
                        "union all " +
                        "select 'BS' fin,sum(R.QtyIn) Lembar,sum(R.QtyIn *((I.tebal*I.panjang*I.lebar)/1000000000)) kubik from T3_Rekap R inner join FC_Items I on R.ItemID=I.id inner join fc_lokasi L on R.LokID =L.id where R.RowStatus>-1 and  " +
                        "CONVERT(varchar,R.tgltrans,112)>=@thnbln1 and CONVERT(varchar,R.tgltrans,112)<=@thnbln2 and I.PartNo like '%-s-%' and Process='direct' " +
                        perubahanlogikalisplank + ")A " +
                        " " +
                        "declare @TotalPotong decimal(18,2) " +
                        "declare @TotalDefKhusus decimal(18,2) " +
                        "declare @DefKhusus decimal(18,2) " +
                        "declare @Ttotalkw1kw2 decimal(18,2) " +
                        "declare @NCSortir decimal(18,2) " +
                        "declare @Retur decimal(18,2) " +
                        "set @TotalPotong=isnull((select sum(totkubik ) from tempdefectGPIsoTot),0) " +
                        "declare @SelisihTotalPotong decimal(18,2) " +
                        "declare @TotalAccReport decimal(18,2) " +
                        "set @TotalAccReport=(select kubik from( " +
                        "    select  sum(lembar) lembar,sum(kubik)kubik from ( " +
                        "    select 'AccReport' fin, sum(qtyin) lembar,sum(qtyin * kubik)kubik from ( " +
                        "    select I1.PartNo partno1,I1.Panjang * I1.Lebar luas1,  S.qtyin,I2.PartNo partno2,I2.Panjang * I2.Lebar luas2,  S.qtyout ,(I1.Tebal * I1.Panjang * I1.Lebar)/1000000000 kubik " +
                        "    from t3_simetris S inner join T3_Serah Se on S.SerahID =Se.ID inner join fc_items I1 on Se.ItemID=I1.ID inner join fc_items I2 on S.ItemID=I2.id  " +
                        "    where S.RowStatus>-1 and CONVERT(varchar,S.tgltrans,112)>=@thnbln1 and CONVERT(varchar,S.tgltrans,112)<=@thnbln2 )a  " +
                        "    where partno1 like '%-1-%' and luas2/luas1 *100>90  and (partno2 like '%-p-%' or partno2 like '%-3-%' or partno2 like '%-M-%') " +
                        "    union all " +
                        "    select 'AccReport' fin, sum(qtyin) lembar,sum(qtyin * kubik)kubik from ( " +
                        "    select I1.PartNo partno1,I1.Panjang * I1.Lebar luas1,  S.qtyin,I2.PartNo partno2,I2.Panjang * I2.Lebar luas2,  S.qtyout ,(I1.Tebal * I1.Panjang * I1.Lebar)/1000000000 kubik " +
                        "    from t1_serah S  inner join fc_items I1 on S.ItemID0=I1.ID inner join fc_items I2 on S.ItemID=I2.id  " +
                        "    where S.Status>-1 and CONVERT(varchar,S.tglserah,112)>=@thnbln1 and CONVERT(varchar,S.tglserah,112)<=@thnbln2 )a  " +
                        "    where (partno2 like '%-p-%' or partno2 like '%-3-%' or partno2 like '%-M-%'))a)B) " +
                        "set @SelisihTotalPotong= @TotalAccReport-@TotalPotong " +
                        "if @TotalPotong >0  " +
                        "begin " +
                        "set @TotalDefKhusus=isnull((select sum(kubik) from tempdefectFin),0) " +
                        "set @DefKhusus=isnull((select sum(kubik) from tempdefectFin where fin<>'bp'),0) " +
                        "set @Ttotalkw1kw2 =isnull((select sum(qtyin *((I.tebal*I.Lebar*I.Panjang)/1000000000)) from T3_Rekap R inner join fc_items I on R.itemid=I.ID  " +
                        "where R.rowstatus>-1 and R.Process  like '%simetris%' and CONVERT(varchar,R.tgltrans,112)>=@thnbln1 and CONVERT(varchar,R.tgltrans,112)<=@thnbln2   " +
                        "and I.lebar=1200 and I.panjang=2400 and R.keterangan like '%-p-%' and (I.partno like '%-3-%' or I.partno like '%-W-%' or I.partno like '%-M-%' )),0) " +
                        "set @NCSortir=isnull((select /*sum(QtyAkhirSS)+sum(QtyAkhirSE)*/sum(M3AkhirSS)+sum(M3AkhirSE) from (  " +
                        "SELECT B.tgltrans as Tanggal, I1.PartNo as PartnoAwal, sum(B.QtyIn) as QtyAwal,sum(I1.Volume*B.QtyIn) M3Awal,   " +
                        "I2.PartNo AS PartnoAkhir, case when B.NCSS>0 then sum(B.QtyOut) else 0 end QtyAkhirSS,  " +
                        "case when B.NCSS>0 then sum(I2.Volume*B.QtyOut) else 0 end M3AkhirSS,case when B.NCSE>0 then sum(B.QtyOut) else 0 end QtyAkhirSE,  " +
                        "case when B.NCSE>0 then sum(I2.Volume*B.QtyOut) else 0 end M3AkhirSE,B.NCSS,B.NCSE  FROM T3_Serah AS A   " +
                        "INNER JOIN T3_Simetris AS B ON A.ID = B.SerahID INNER JOIN FC_Items AS I1 ON A.ItemID = I1.ID INNER JOIN   " +
                        "FC_Items AS I2 ON B.ItemID = I2.ID LEFT JOIN T3_GroupM AS D ON B.GroupID = D.ID   " +
                        "where (B.NCSS>0 or B.NCSE>0) and B.rowstatus>-1 and CONVERT(varchar,B.tgltrans,112)>=@thnbln1 and CONVERT(varchar,B.tgltrans,112)<=@thnbln2   " +
                        "group by B.tgltrans,I1.PartNo,I2.PartNo,B.NCSS,B.NCSE) S),0) " +
                        "set @Retur=isnull((select sum(qty) from ( " +
                        "select sum(qty *(I.tebal*I.panjang*I.lebar)/1000000000) qty from t3_retur R inner join fc_items I on R.itemid=I.id where R.rowstatus>-1 and  " +
                        "R.typer=1 and (I.partno like '%-p-%' or I.partno like '%-S-%')  and CONVERT(varchar,R.tgltrans,112)>=@thnbln1 and CONVERT(varchar,R.tgltrans,112)<=@thnbln2  " +
                        "union all " +
                        "select sum(qty *(I.tebal*I.panjang*I.lebar)/1000000000)*-1 qty from t3_retur R inner join fc_items I on R.itemid=I.id where R.rowstatus>-1 and  " +
                        "R.typer=2 and (I.partno like '%-p-%' or I.partno like '%-S-%')and CONVERT(varchar,R.tgltrans,112)>=@thnbln1 and CONVERT(varchar,R.tgltrans,112)<=@thnbln2 " +
                        "union all " +
                        "select sum(qty *(I.tebal*I.panjang*I.lebar)/1000000000) qty from t3_returO R inner join fc_items I on R.itemid=I.id where R.rowstatus>-1 and  " +
                        "(I.partno like '%-p-%' or I.partno like '%-S-%') and CONVERT(varchar,R.tgltrans,112)>=@thnbln1 and CONVERT(varchar,R.tgltrans,112)<=@thnbln2)A),0) " +
                        " " +
                        "declare @TotalPotongL1 decimal(18,2) " +
                        "declare @TotDefKhususL1 decimal(18,2) " +
                        "declare @DefKhususL1 decimal(18,2) " +
                        "declare @Ttotalkw1kw2L1 decimal(18,2) " +
                        "declare @NCSortirL1 decimal(18,2) " +
                        "declare @ReturL1 decimal(18,2) " +
                        "declare @DefectFinL1 decimal(18,2) " +

                        "set @TotalPotongL1=(select sum(totkubik ) from tempdefectGPIsoTot where [group]in (select [group] from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 1'))) " +
                        "set @TotDefKhususL1=(@TotalPotongL1/@TotalPotong)*@TotalDefKhusus " +
                        "set @DefKhususL1=(@TotalPotongL1/@TotalPotong)*@DefKhusus " +
                        "set @Ttotalkw1kw2L1=(@TotalPotongL1/@TotalPotong)*@Ttotalkw1kw2 " +
                        "set @NCSortirL1=(@TotalPotongL1/@TotalPotong)*@NCSortir " +
                        "set @ReturL1=(@TotalPotongL1/@TotalPotong)*@Retur " +
                        "set @DefectFinL1=isnull((@TotalPotongL1/@TotalPotong)*@DefectFin,0) " +
                        "declare @SelisihTotalPotongL1 decimal(18,2) " +
                        "set @SelisihTotalPotongL1=(@TotalPotongL1/@TotalPotong)*@SelisihTotalPotong " +
                        "if @TotalPotongL1>0 " +
                        "begin " +
                        "select * into tempdefectL1 from ( " +
                        "select *,c-d+e+f+g+h i,case when b>0 then (c-d+e+f+g+h)/b*100 else 0  end j from ( " +
                        "select [Group],case when @TotalPotongL1>0 then isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) +  " +
                        "  (( isnull(( select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@TotDefKhususL1) + " +
                        "(( isnull((   select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@SelisihTotalPotongL1) else 0 end b, " +
                        " case when @TotalPotongL1>0 then isnull((select totdefectK from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)  else 0 end c, " +
                        " case when @TotalPotongL1>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@Ttotalkw1kw2L1) else 0 end  d, " +
                        " case when @TotalPotongL1>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@NCSortirL1)  else 0 end  e, " +
                        " case when @TotalPotongL1>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@ReturL1)  else 0 end  f, " +
                        " case when @TotalPotongL1>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@DefectFinL1)  else 0 end g, " +
                        " case when @TotalPotongL1>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@DefKhususL1) else 0 end  h " +
                        " from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 1') )A " +
                        "union all  " +
                        "select 'Total' [Group],sum(b)b,sum(c)c,sum(d)d,sum(e)e,sum(f)f,sum(g)g,sum(h)h,sum(c)-sum(d)+sum(e)+sum(f)+sum(g)+sum(h) i " +
                        ",cast((sum(c)-sum(d)+sum(e)+sum(f)+sum(g)+sum(h))/sum(b)*100 as decimal(18,1)) j from( " +
                        "select [Group],case when @TotalPotongL1>0 then isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) +  " +
                        "  (( isnull(( select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@TotDefKhususL1) + " +
                        "(( isnull((   select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@SelisihTotalPotongL1) else 0 end b, " +
                        " case when @TotalPotongL1>0 then isnull((select totdefectK from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)  else 0 end c, " +
                        " case when @TotalPotongL1>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@Ttotalkw1kw2L1) else 0 end  d, " +
                        " case when @TotalPotongL1>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@NCSortirL1)  else 0 end  e, " +
                        " case when @TotalPotongL1>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@ReturL1)  else 0 end  f, " +
                        " case when @TotalPotongL1>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@DefectFinL1)  else 0 end g, " +
                        " case when @TotalPotongL1>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@DefKhususL1) else 0 end  h, " +
                        " 0 i,0 j from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 1'))A )B " +
                        " end " +
                        " else " +
                        " begin " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 h,0 i, 0 j into tempdefectL1 " +
                        " end " +
                        " " +
                        "update SPD_Trans set actual=(select j from tempdefectL1 where [group]='total') where approval=0 and Tahun =" + ddTahun.SelectedValue + " and Bulan=" + ddlBulan.SelectedValue.ToString() + " and sarmutdeptid in ( " +
                        "select ID from SPD_Departemen where SarmutDepartemen='Line 1' and SarmutPID in (select ID from SPD_Perusahaan where SarMutPerusahaan ='Defect Board Mill')) " +

                        "declare @TotalPotongL2 decimal(18,2) " +
                        "declare @TotDefKhususL2 decimal(18,2) " +
                        "declare @DefKhususL2 decimal(18,2) " +
                        "declare @Ttotalkw1kw2L2 decimal(18,2) " +
                        "declare @NCSortirL2 decimal(18,2) " +
                        "declare @ReturL2 decimal(18,2) " +
                        "declare @DefectFinL2 decimal(18,2) " +

                        "set @TotalPotongL2=(select sum(totkubik ) from tempdefectGPIsoTot where [group]in (select [group] from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 2'))) " +
                        "set @TotDefKhususL2=(@TotalPotongL2/@TotalPotong)*@TotalDefKhusus " +
                        "set @DefKhususL2=(@TotalPotongL2/@TotalPotong)*@DefKhusus " +
                        "set @Ttotalkw1kw2L2=(@TotalPotongL2/@TotalPotong)*@Ttotalkw1kw2 " +
                        "set @NCSortirL2=(@TotalPotongL2/@TotalPotong)*@NCSortir " +
                        "set @ReturL2=(@TotalPotongL2/@TotalPotong)*@Retur " +
                        "set @DefectFinL2=isnull((@TotalPotongL2/@TotalPotong)*@DefectFin,0) " +
                        "declare @SelisihTotalPotongL2 decimal(18,2) " +
                        "set @SelisihTotalPotongL2=(@TotalPotongL2/@TotalPotong)*@SelisihTotalPotong " +
                        "if @TotalPotongL2>0 " +
                        "begin " +
                        "select * into tempdefectL2 from ( " +
                        "select *,c-d+e+f+g+h i,case when b>0 then (c-d+e+f+g+h)/b*100 else 0  end j from ( " +
                        "select [Group],case when @TotalPotongL2>0 then isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) +  " +
                        " ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL2)*@TotDefKhususL2)+ " +
                        "(( isnull((   select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL2)*@SelisihTotalPotongL2) else 0 end  b, " +
                        " case when @TotalPotongL2>0 then isnull((select totdefectK from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) else 0 end c, " +
                        " case when @TotalPotongL2>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL2)*@Ttotalkw1kw2L2) else 0 end  d, " +
                        " case when @TotalPotongL2>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL2)*@NCSortirL2) else 0 end  e, " +
                        " case when @TotalPotongL2>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL2)*@ReturL2)  else 0 end f, " +
                        " case when @TotalPotongL2>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL2)*@DefectFinL2) else 0 end  g, " +
                        " case when @TotalPotongL2>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL2)*@DefKhususL2) else 0 end  h " +
                        "  from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 2') )A " +
                        "union all  " +
                        "select 'Total' [Group],sum(b)b,sum(c)c,sum(d)d,sum(e)e,sum(f)f,sum(g)g,sum(h)h,sum(c)-sum(d)+sum(e)+sum(f)+sum(g)+sum(h) i " +
                        ",cast((sum(c)-sum(d)+sum(e)+sum(f)+sum(g)+sum(h))/sum(b)*100 as decimal(18,1)) j from( " +
                        "select [Group],case when @TotalPotongL2>0 then isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) +  " +
                        " ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL2)*@TotDefKhususL2) + " +
                        "(( isnull((   select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL2)*@SelisihTotalPotongL2) else 0 end  b, " +
                        " case when @TotalPotongL2>0 then isnull((select totdefectK from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) else 0 end c, " +
                        " case when @TotalPotongL2>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL2)*@Ttotalkw1kw2L2) else 0 end  d, " +
                        " case when @TotalPotongL2>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL2)*@NCSortirL2) else 0 end  e, " +
                        " case when @TotalPotongL2>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL2)*@ReturL2)  else 0 end f, " +
                        " case when @TotalPotongL2>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL2)*@DefectFinL2) else 0 end  g, " +
                        " case when @TotalPotongL2>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL2)*@DefKhususL2) else 0 end  h, " +
                        " 0 i,0 j from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 2'))A )B " +
                        " end " +
                        " else " +
                        " begin " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 h,0 i, 0 j into tempdefectL2 " +
                        " end " +
                        " " +
                        "update SPD_Trans set actual=(select j from tempdefectL2 where [group]='total') where approval=0 and Tahun =" + ddTahun.SelectedValue + " and Bulan=" + ddlBulan.SelectedValue.ToString() + " and sarmutdeptid in ( " +
                        "select ID from SPD_Departemen where SarmutDepartemen='Line 2' and SarmutPID in (select ID from SPD_Perusahaan where SarMutPerusahaan ='Defect Board Mill')) " +

                        "declare @TotalPotongL3 decimal(18,2) " +
                        "declare @TotDefKhususL3 decimal(18,2) " +
                        "declare @DefKhususL3 decimal(18,2) " +
                        "declare @Ttotalkw1kw2L3 decimal(18,2) " +
                        "declare @NCSortirL3 decimal(18,2) " +
                        "declare @ReturL3 decimal(18,2) " +
                        "declare @DefectFinL3 decimal(18,2) " +
                        "set @TotalPotongL3=(select sum(totkubik ) from tempdefectGPIsoTot where [group]in (select [group] from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 3'))) " +
                        "set @TotDefKhususL3=(@TotalPotongL3/@TotalPotong)*@TotalDefKhusus " +
                        "set @DefKhususL3=(@TotalPotongL3/@TotalPotong)*@DefKhusus " +
                        "set @Ttotalkw1kw2L3=(@TotalPotongL3/@TotalPotong)*@Ttotalkw1kw2 " +
                        "set @NCSortirL3=(@TotalPotongL3/@TotalPotong)*@NCSortir " +
                        "set @ReturL3=(@TotalPotongL3/@TotalPotong)*@Retur " +
                        "set @DefectFinL3=isnull((@TotalPotongL3/@TotalPotong)*@DefectFin,0) " +
                        "declare @SelisihTotalPotongL3 decimal(18,2) " +
                        "set @SelisihTotalPotongL3=(@TotalPotongL3/@TotalPotong)*@SelisihTotalPotong " +
                        "if @TotalPotongL3>0 " +
                        "begin " +
                        "select * into tempdefectL3 from ( " +
                        "select *,c-d+e+f+g+h i,case when b>0 then (c-d+e+f+g+h)/b*100 else 0  end j from ( " +
                        "select [Group],case when @TotalPotongL3>0 then isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) +  " +
                        " ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@TotDefKhususL3)+ " +
                        "(( isnull((   select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@SelisihTotalPotongL3) else 0 end  b, " +
                        " case when @TotalPotongL3>0 then isnull((select totdefectK from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) else 0 end c, " +
                        " case when @TotalPotongL3>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@Ttotalkw1kw2L3) else 0 end  d, " +
                        " case when @TotalPotongL3>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@NCSortirL3) else 0 end  e, " +
                        " case when @TotalPotongL3>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@ReturL3) else 0 end  f, " +
                        " case when @TotalPotongL3>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@DefectFinL3) else 0 end  g, " +
                        " case when @TotalPotongL3>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@DefKhususL3) else 0 end  h " +
                        "  from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 3') )A " +
                        "union all  " +
                        "select 'Total' [Group],sum(b)b,sum(c)c,sum(d)d,sum(e)e,sum(f)f,sum(g)g,sum(h)h,sum(c)-sum(d)+sum(e)+sum(f)+sum(g)+sum(h) i " +
                        ",cast((sum(c)-sum(d)+sum(e)+sum(f)+sum(g)+sum(h))/sum(b)*100 as decimal(18,1)) j from( " +
                        "select [Group],isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) +  " +
                        " ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@TotDefKhususL3)+ " +
                        "(( isnull((   select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@SelisihTotalPotongL3) b, " +
                        " isnull((select totdefectK from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)c, " +
                        " ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@Ttotalkw1kw2L3) d, " +
                        " ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@NCSortirL3) e, " +
                        " ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@ReturL3) f, " +
                        " ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@DefectFinL3) g, " +
                        " ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@DefKhususL3) h, " +
                        " 0 i,0 j from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 3'))A )B " +
                        " end " +
                        " else " +
                        " begin " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 h,0 i, 0 j into tempdefectL3 " +
                        " end " +
                        " " +

                        "update SPD_Trans set actual=(select j from tempdefectL3 where [group]='total') where approval=0 and Tahun =" + ddTahun.SelectedValue + " and Bulan=" + ddlBulan.SelectedValue.ToString() + " and sarmutdeptid in ( " +
                        "select ID from SPD_Departemen where SarmutDepartemen='Line 3' and SarmutPID in (select ID from SPD_Perusahaan where SarMutPerusahaan ='Defect Board Mill')) " +
                        "declare @TotalPotongL4 decimal(18,2) " +
                        "declare @TotDefKhususL4 decimal(18,2) " +
                        "declare @DefKhususL4 decimal(18,2) " +
                        "declare @Ttotalkw1kw2L4 decimal(18,2) " +
                        "declare @NCSortirL4 decimal(18,2) " +
                        "declare @ReturL4 decimal(18,2) " +
                        "declare @DefectFinL4 decimal(18,2) " +
                        "set @TotalPotongL4=(select sum(totkubik ) from tempdefectGPIsoTot where [group]in (select [group] from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 4'))) " +
                        "set @TotDefKhususL4=(@TotalPotongL4/@TotalPotong)*@TotalDefKhusus " +
                        "set @DefKhususL4=(@TotalPotongL4/@TotalPotong)*@DefKhusus " +
                        "set @Ttotalkw1kw2L4=(@TotalPotongL4/@TotalPotong)*@Ttotalkw1kw2 " +
                        "set @NCSortirL4=(@TotalPotongL4/@TotalPotong)*@NCSortir " +
                        "set @ReturL4=(@TotalPotongL4/@TotalPotong)*@Retur " +
                        "set @DefectFinL4=isnull((@TotalPotongL4/@TotalPotong)*@DefectFin,0) " +
                        "declare @SelisihTotalPotongL4 decimal(18,2) " +
                        "set @SelisihTotalPotongL4=(@TotalPotongL4/@TotalPotong)*@SelisihTotalPotong " +
                        "if @TotalPotongL4>0 " +
                        "begin " +
                        "select * into tempdefectL4 from ( " +
                        "select *,c-d+e+f+g+h i,case when b>0 then (c-d+e+f+g+h)/b*100 else 0  end j from ( " +
                        "select [Group],case when @TotalPotongL4>0 then isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) +  " +
                        " ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@TotDefKhususL4)+ " +
                        "(( isnull((   select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@SelisihTotalPotongL4) else 0 end  b, " +
                        " case when @TotalPotongL4>0 then isnull((select totdefectK from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) else 0 end c, " +
                        " case when @TotalPotongL4>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@Ttotalkw1kw2L4) else 0 end  d, " +
                        " case when @TotalPotongL4>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@NCSortirL4) else 0 end  e, " +
                        " case when @TotalPotongL4>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@ReturL4) else 0 end  f, " +
                        " case when @TotalPotongL4>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@DefectFinL4) else 0 end  g, " +
                        " case when @TotalPotongL4>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@DefKhususL4) else 0 end  h " +
                        "  from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 4') )A " +
                        "union all  " +
                        "select 'Total' [Group],sum(b)b,sum(c)c,sum(d)d,sum(e)e,sum(f)f,sum(g)g,sum(h)h,sum(c)-sum(d)+sum(e)+sum(f)+sum(g)+sum(h) i " +
                        ",cast((sum(c)-sum(d)+sum(e)+sum(f)+sum(g)+sum(h))/sum(b)*100 as decimal(18,1)) j from( " +
                        "select [Group],isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) +  " +
                        " ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@TotDefKhususL4)+ " +
                        "(( isnull((   select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@SelisihTotalPotongL4) b, " +
                        " isnull((select totdefectK from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)c, " +
                        " ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@Ttotalkw1kw2L4) d, " +
                        " ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@NCSortirL4) e, " +
                        " ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@ReturL4) f, " +
                        " ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@DefectFinL4) g, " +
                        " ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@DefKhususL4) h, " +
                        " 0 i,0 j from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 4'))A )B " +
                        " end " +
                        " else " +
                        " begin " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 h,0 i, 0 j into tempdefectL4 " +
                        " end " +
                        " " +
                        "update SPD_Trans set actual=(select j from tempdefectL4 where [group]='total') where approval=0 and Tahun =" + ddTahun.SelectedValue + " and Bulan=" + ddlBulan.SelectedValue.ToString() + " and sarmutdeptid in ( " +
                        "select ID from SPD_Departemen where SarmutDepartemen='Line 4' and SarmutPID in (select ID from SPD_Perusahaan where SarMutPerusahaan ='Defect Board Mill')) " +
                        "declare @TotalPotongL5 decimal(18,2) " +
                        "declare @TotDefKhususL5 decimal(18,2) " +
                        "declare @DefKhususL5 decimal(18,2) " +
                        "declare @Ttotalkw1kw2L5 decimal(18,2) " +
                        "declare @NCSortirL5 decimal(18,2) " +
                        "declare @ReturL5 decimal(18,2) " +
                        "declare @DefectFinL5 decimal(18,2) " +
                        "set @TotalPotongL5=(select sum(totkubik ) from tempdefectGPIsoTot where [group]in (select [group] from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 5'))) " +
                        "set @TotDefKhususL5=(@TotalPotongL5/@TotalPotong)*@TotalDefKhusus " +
                        "set @DefKhususL5=(@TotalPotongL5/@TotalPotong)*@DefKhusus " +
                        "set @Ttotalkw1kw2L5=(@TotalPotongL5/@TotalPotong)*@Ttotalkw1kw2 " +
                        "set @NCSortirL5=(@TotalPotongL5/@TotalPotong)*@NCSortir " +
                        "set @ReturL5=(@TotalPotongL5/@TotalPotong)*@Retur " +
                        "set @DefectFinL5=isnull((@TotalPotongL5/@TotalPotong)*@DefectFin,0) " +
                        "declare @SelisihTotalPotongL5 decimal(18,2) " +
                        "set @SelisihTotalPotongL5=(@TotalPotongL5/@TotalPotong)*@SelisihTotalPotong " +
                        "if @TotalPotongL5>0 " +
                        "begin " +
                        "select * into tempdefectL5 from ( " +
                        "select *,c-d+e+f+g+h i,case when b>0 then (c-d+e+f+g+h)/b*100 else 0  end j from ( " +
                        "select [Group],case when @TotalPotongL5>0 then isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) +  " +
                        " ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@TotDefKhususL5)+ " +
                        "(( isnull((   select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@SelisihTotalPotongL5) else 0 end  b, " +
                        " case when @TotalPotongL5>0 then isnull((select totdefectK from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) else 0 end c, " +
                        " case when @TotalPotongL5>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@Ttotalkw1kw2L5) else 0 end  d, " +
                        " case when @TotalPotongL5>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@NCSortirL5) else 0 end  e, " +
                        " case when @TotalPotongL5>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@ReturL5) else 0 end  f, " +
                        " case when @TotalPotongL5>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@DefectFinL5) else 0 end  g, " +
                        " case when @TotalPotongL5>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@DefKhususL5) else 0 end  h " +
                        "  from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 5') )A " +
                        "union all  " +
                        "select 'Total' [Group],sum(b)b,sum(c)c,sum(d)d,sum(e)e,sum(f)f,sum(g)g,sum(h)h,sum(c)-sum(d)+sum(e)+sum(f)+sum(g)+sum(h) i " +
                        ",cast((sum(c)-sum(d)+sum(e)+sum(f)+sum(g)+sum(h))/sum(b)*100 as decimal(18,1)) j from( " +
                        "select [Group],isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) +  " +
                        " ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@TotDefKhususL5)+ " +
                        "(( isnull((   select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@SelisihTotalPotongL5) b, " +
                        " isnull((select totdefectK from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)c, " +
                        " ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@Ttotalkw1kw2L5) d, " +
                        " ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@NCSortirL5) e, " +
                        " ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@ReturL5) f, " +
                        " ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@DefectFinL5) g, " +
                        " ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@DefKhususL5) h, " +
                        " 0 i,0 j from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 5'))A )B " +
                        " end " +
                        " else " +
                        " begin " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 h,0 i, 0 j into tempdefectL5 " +
                        " end " +
                        " " +
                        "update SPD_Trans set actual=(select j from tempdefectL5 where [group]='total') where approval=0 and Tahun =" + ddTahun.SelectedValue + " and Bulan=" + ddlBulan.SelectedValue.ToString() + " and sarmutdeptid in ( " +
                        "select ID from SPD_Departemen where SarmutDepartemen='Line 5' and SarmutPID in (select ID from SPD_Perusahaan where SarMutPerusahaan ='Defect Board Mill')) " +
                        "declare @TotalPotongL6 decimal(18,2) " +
                        "declare @TotDefKhususL6 decimal(18,2) " +
                        "declare @DefKhususL6 decimal(18,2) " +
                        "declare @Ttotalkw1kw2L6 decimal(18,2) " +
                        "declare @NCSortirL6 decimal(18,2) " +
                        "declare @ReturL6 decimal(18,2) " +
                        "declare @DefectFinL6 decimal(18,2) " +
                        "set @TotalPotongL6=(select sum(totkubik ) from tempdefectGPIsoTot where [group]in (select [group] from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 6'))) " +
                        "set @TotDefKhususL6=(@TotalPotongL6/@TotalPotong)*@TotalDefKhusus " +
                        "set @DefKhususL6=(@TotalPotongL6/@TotalPotong)*@DefKhusus " +
                        "set @Ttotalkw1kw2L6=(@TotalPotongL6/@TotalPotong)*@Ttotalkw1kw2 " +
                        "set @NCSortirL6=(@TotalPotongL6/@TotalPotong)*@NCSortir " +
                        "set @ReturL6=(@TotalPotongL6/@TotalPotong)*@Retur " +
                        "set @DefectFinL6=isnull((@TotalPotongL6/@TotalPotong)*@DefectFin,0) " +
                        "declare @SelisihTotalPotongL6 decimal(18,2) " +
                        "set @SelisihTotalPotongL6=(@TotalPotongL6/@TotalPotong)*@SelisihTotalPotong " +
                        "if @TotalPotongL6>0 " +
                        "begin " +
                        "select * into tempdefectL6 from ( " +
                        "select *,c-d+e+f+g+h i,case when b>0 then (c-d+e+f+g+h)/b*100 else 0  end j from ( " +
                        "select [Group],case when @TotalPotongL6>0 then isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) +  " +
                        " ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@TotDefKhususL6) + " +
                        "(( isnull((   select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@SelisihTotalPotongL6) else 0 end b, " +
                        " case when @TotalPotongL6>0 then isnull((select totdefectK from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) else 0 end c, " +
                        " case when @TotalPotongL6>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@Ttotalkw1kw2L6)  else 0 end d, " +
                        " case when @TotalPotongL6>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@NCSortirL6)  else 0 end e, " +
                        " case when @TotalPotongL6>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@ReturL6)  else 0 end f, " +
                        " case when @TotalPotongL6>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@DefectFinL6)  else 0 end g, " +
                        " case when @TotalPotongL6>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@DefKhususL6) else 0 end  h " +
                        "  from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 6') )A " +
                        "union all  " +
                        "select 'Total' [Group],sum(b)b,sum(c)c,sum(d)d,sum(e)e,sum(f)f,sum(g)g,sum(h)h,sum(c)-sum(d)+sum(e)+sum(f)+sum(g)+sum(h) i " +
                        ",cast((sum(c)-sum(d)+sum(e)+sum(f)+sum(g)+sum(h))/sum(b)*100 as decimal(18,1)) j from( " +
                        "select [Group],isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) +  " +
                        " ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@TotDefKhususL6)+ " +
                        "(( isnull((   select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@SelisihTotalPotongL6) b, " +
                        " isnull((select totdefectK from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)c, " +
                        " ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@Ttotalkw1kw2L6) d, " +
                        " ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@NCSortirL6) e, " +
                        " ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@ReturL6) f, " +
                        " ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@DefectFinL6) g, " +
                        " ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@DefKhususL6) h, " +
                        " 0 i,0 j from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 6'))A )B " +
                        " end " +
                        " else " +
                        " begin " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 h,0 i, 0 j into tempdefectL6 " +
                        " end " +
                        " " +
                        " end " +
                        " else " +
                        " begin " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 h,0 i, 0 j into tempdefectL1 " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 h,0 i, 0 j into tempdefectL2 " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 h,0 i, 0 j into tempdefectL3 " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 h,0 i, 0 j into tempdefectL4 " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 h,0 i, 0 j into tempdefectL5 " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 h,0 i, 0 j into tempdefectL6 " +
                        " end " +
                        " select * from tempdefectL1 order by [group] " +
                        "update SPD_Trans set actual=(select j from tempdefectL6 where [group]='total') where approval=0 and Tahun =" + ddTahun.SelectedValue + " and Bulan=" + ddlBulan.SelectedValue.ToString() + " and sarmutdeptid in ( " +
                        "select ID from SPD_Departemen where SarmutDepartemen='Line 6' and SarmutPID in (select ID from SPD_Perusahaan where SarMutPerusahaan ='Defect Board Mill')) ";
                    }
                    #endregion
                    else if (Convert.ToInt32(strtgl1.Substring(0, 6)) > 201910 && Convert.ToInt32(strtgl1.Substring(0, 6)) < 202009)
                    #region Periode Baru
                    {

                        if (Convert.ToInt32(strtgl1.Substring(0, 6)) > 201910 && Convert.ToInt32(strtgl1.Substring(0, 6)) < 202003 && users.UnitKerjaID.ToString() != "13")
                        {
                            query1 = " 0 h "; query2 = " 0 h, ";
                            query3 = " 0 h "; query4 = " 0 h, ";
                            query5 = " 0 h "; query6 = " 0 h, ";
                            query7 = " 0 h "; query8 = " 0 h, ";
                            query9 = " 0 h "; query10 = " 0 h, ";
                            query11 = " 0 h "; query12 = " 0 h, ";
                        }
                        else
                        {
                            query1 = " case when @TotalPotongL1>0 then isnull((select cast(A.M3 as decimal(10,4)) from tempBST1 A where [group]=BM_PlantGroup.[Group]),0) else 0 end  h  ";
                            query2 = " case when @TotalPotongL1>0 then isnull((select cast(A.M3 as decimal(10,4)) from tempBST1 A where [group]=BM_PlantGroup.[Group]),0) else 0 end  h, ";
                            query3 = " case when @TotalPotongL2>0 then isnull((select cast(A.M3 as decimal(10,4)) from tempBST1 A where [group]=BM_PlantGroup.[Group]),0) else 0 end  h  ";
                            query4 = " case when @TotalPotongL2>0 then isnull((select cast(A.M3 as decimal(10,4)) from tempBST1 A where [group]=BM_PlantGroup.[Group]),0) else 0 end  h, ";
                            query5 = " case when @TotalPotongL3>0 then isnull((select cast(A.M3 as decimal(10,4)) from tempBST1 A where [group]=BM_PlantGroup.[Group]),0) else 0 end  h  ";
                            query6 = " isnull((select cast(A.M3 as decimal(10,4)) from tempBST1 A where [group]=BM_PlantGroup.[Group]),0) h, ";
                            query7 = " isnull((select cast(A.M3 as decimal(10,4)) from tempBST1 A where [group]=BM_PlantGroup.[Group]),0) h ";
                            query8 = " isnull((select cast(A.M3 as decimal(10,4)) from tempBST1 A where [group]=BM_PlantGroup.[Group]),0) h, ";
                            query9 = " isnull((select cast(A.M3 as decimal(10,4)) from tempBST1 A where [group]=BM_PlantGroup.[Group]),0) h ";
                            query10 = " isnull((select cast(A.M3 as decimal(10,4)) from tempBST1 A where [group]=BM_PlantGroup.[Group]),0) h, ";
                            query11 = " isnull((select cast(A.M3 as decimal(10,4)) from tempBST1 A where [group]=BM_PlantGroup.[Group]),0) h ";
                            query12 = " isnull((select cast(A.M3 as decimal(10,4)) from tempBST1 A where [group]=BM_PlantGroup.[Group]),0) h, ";
                        }

                        strSQL =
                        #region Part1
 "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDM3]') AND type in (N'U')) DROP TABLE [dbo].tempDM3 " +
                            "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempD1M3]') AND type in (N'U')) DROP TABLE [dbo].tempD1M3 " +
                            "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempD2M3]') AND type in (N'U')) DROP TABLE [dbo].tempD2M3 " +
                            "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempD3M3]') AND type in (N'U')) DROP TABLE [dbo].tempD3M3 " +

                            "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectGPIso]') AND type in (N'U')) DROP TABLE [dbo].[tempdefectGPIso]  " +
                            "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectGPIsoTot]') AND type in (N'U')) DROP TABLE [dbo].tempdefectGPIsoTot  " +
                            "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectFin]') AND type in (N'U')) DROP TABLE [dbo].tempdefectFin " +
                            "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectL1]') AND type in (N'U')) DROP TABLE [dbo].tempdefectL1 " +
                            "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectL2]') AND type in (N'U')) DROP TABLE [dbo].tempdefectL2 " +
                            "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectL3]') AND type in (N'U')) DROP TABLE [dbo].tempdefectL3 " +
                            "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectL4]') AND type in (N'U')) DROP TABLE [dbo].tempdefectL4 " +
                            "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectL5]') AND type in (N'U')) DROP TABLE [dbo].tempdefectL5 " +
                            "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectL6]') AND type in (N'U')) DROP TABLE [dbo].tempdefectL6 " +
                            "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectListP]') AND type in (N'U')) DROP TABLE [dbo].tempdefectListP " +
                            "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectListPOK]') AND type in (N'U')) DROP TABLE [dbo].tempdefectListPOK " +
                            "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectListP2]') AND type in (N'U')) DROP TABLE [dbo].tempdefectListP2 " +
                            "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTotalGroup]') AND type in (N'U')) DROP TABLE [dbo].tempTotalGroup " +
                            "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTotalSerahDfctM3]') AND type in (N'U')) DROP TABLE [dbo].tempTotalSerahDfctM3 " +
                            "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTotalSerahLP]') AND type in (N'U')) DROP TABLE [dbo].tempTotalSerahLP " +
                            "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectListP3]') AND type in (N'U')) DROP TABLE [dbo].tempdefectListP3 " +
                            "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTotalBPM3]') AND type in (N'U')) DROP TABLE [dbo].tempTotalBPM3 " +
                            "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempUkuranKhusus]') AND type in (N'U')) DROP TABLE [dbo].tempUkuranKhusus " +
                            "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempBST1]') AND type in (N'U')) DROP TABLE [dbo].tempBST1 " +
                            "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTotalSerahM3]') AND type in (N'U')) DROP TABLE [dbo].tempTotalSerahM3 " +

                            "declare @thnbln1 varchar(8) " +
                            "declare @thnbln2 varchar(8) " +
                            "declare @TotalLine int " +
                            "declare @TotalGroup int " +
                            "declare @SerahPerGroup decimal(18,2) " +
                            "declare @bagi2 decimal(10,3) " +
                            "declare @TotalGroup1 decimal(18,2) " +
                            "declare @TotalGroup2 decimal(18,2) " +
                            "declare @Pembagi1 decimal(18,2) " +
                            "declare @M32 decimal(18,2) " +
                            "declare @M3 decimal(18,2) " +

                            "set @thnbln1='" + strtgl1 + "' " +
                            "set @thnbln2='" + strtgl2 + "' " +

                            /** Temp Table tempdefectGPIso **/
                            "select *  into tempdefectGPIso from (  " +
                            "select case when D.DeptID=0 then  " +
                            "case when GJ.GroupJemurName In ('M','N','O','P','Q','R','S','T','U','V','W','X') then   " +
                            "case when D.DefName='retak' then 2 " +
                            "when D.DefName='gompal' then 3  " +
                            "else D.DeptID end   " +
                            "else    " +
                            "case when (B.Qty/E.Qty) *100 >5 then 2 else 3 end   " +
                            "end  " +
                            "else D.DeptID end deptID1,A.CreatedTime as tglInput,A.Tgl as TglPeriksa,E.TglProduksi as TglProd,  D.DefCode,BP.PlantName as Line, PG.[Group],BF.FormulaCode as Jenis,   " +
                            "D.DefName,D.DeptID,B.ID,B.DefectID,B.MasterID,B.Qty,A.ID  DestID,isnull(A.TPotong,0)  QtyIn,B.Qty*I.Volume as Kubik,isnull(A.TPotong,0) as TotPotong,'' sfrom  " +
                            "from Def_DefectDetail B inner join Def_Defect A on A.Id=B.DefectID   " +
                            "left join Def_MasterDefect D on B.MasterID=D.ID left join BM_Destacking E on E.ID=A.DestID   " +
                            "left join BM_PlantGroup PG on A.GroupProdID=PG.ID left join BM_Formula BF on BF.ID=E.FormulaID    " +
                            "left join BM_Plant BP on BP.ID=E.PlantID left join FC_Items I on I.ID=E.ItemID inner join Def_GroupJemur GJ on GJ.ID=A.GroupJemurID  " +
                            "where B.RowStatus>-1  and D.RowStatus >-1) as Def    " +
                            "where DeptID1=2 and CONVERT(varchar,TglPeriksa,112)>=@thnbln1 and CONVERT(varchar,TglPeriksa,112)<=@thnbln2  " +
                            /** end Temp Table tempdefectGPIso **/
                            " " +

                            /** Temp Table tempdefectListP **/
                            "/** tempdefectListP **/ " +
                            "/** Turunan Bevel **/ " +
                            "select PlantName,[Group],sum(Qty)Qty,sum(M3)M3 into tempdefectListP " +
                            "from ( select PlantName,[group],Qty,M3  from (select PlantName,[Group],sum(Qty)Qty,sum(M3)M3 " +
                            "from (select Data3.PlantName,Data3.[Group],Data3.Qty,Data3.M3 from (select C1.PlantName,B1.[Group],Data2.Qty,M3 " +
                            "from (select B.PlantID,B.PlantGroupID,Data1.*,((C.Tebal*C.Lebar*C.Panjang)/1000000000)* Data1.Qty M3 from (select  tanggal,itemid,PartNo,Qty,DestID " +
                            "from vw_KartuStockListplankR1 " +
                            "where itemid in (select ID from FC_Items where PartNo like'%-P-%')  and CONVERT(varchar,tanggal,112)>=@thnbln1 " +
                            "and CONVERT(varchar,tanggal,112)<=@thnbln2 and qty>0 and process='i99' and ID in (select IDrec from vw_KartuStockListplank " +
                            "where process='Bevel' and qty<0 and Stat='BvToR1')) as Data1 " +
                            "INNER JOIN BM_Destacking B ON Data1.DestID=B.ID " +
                            "INNER JOIN FC_Items C ON C.ID=Data1.itemid ) as Data2 " +
                            "INNER JOIN BM_PlantGroup B1 ON Data2.PlantGroupID=B1.ID " +
                            "INNER JOIN BM_Plant C1 ON C1.ID=Data2.PlantID ) as Data3  ) as Data4 group by PlantName,[group] ) as Data5 " +
                            "union all " +
                            "/** BP dari Strapping **/  " +
                            "select PlantName,[group],Qty,M3 from (select PlantName,[group],sum(qty)Qty,sum(M3)M3 " +
                            "from (select A6.PlantName,A5.[group],A4.Qty,((A7.Tebal*A7.Lebar*A7.Panjang)/1000000000)*A4.Qty  M3 " +
                            "from (select A3.PlantID,A3.PlantGroupID,A2.Tanggal,A2.Qty,A2.ItemID from (select (select A1.PartNo " +
                            "from FC_Items A1 where A1.ID=A.ItemID)Partno,A.DestID,A.TglTrans Tanggal,A.QtyIn Qty,B.ItemID " +
                            "from T3_Rekap A INNER JOIN T1_Straping B ON A.DestID=B.DestID and A.T1SerahID=B.ID where CONVERT(varchar,A.TglTrans,112)>=@thnbln1 " +
                            "and CONVERT(varchar,A.TglTrans,112)<=@thnbln2 and A.sfrom='straping' and A.RowStatus>-1 and A.ItemID in (select ID " +
                            "from FC_Items where partno like'%-P-%') ) as A2 " +
                            "INNER JOIN BM_Destacking A3 ON A2.DestID=A3.ID ) as A4 " +
                            "INNER JOIN BM_PlantGroup A5 ON A4.PlantGroupID=A5.ID " +
                            "INNER JOIN BM_Plant A6 ON A6.ID=A4.PlantID INNER JOIN FC_Items A7 ON A7.ID=A4.ItemID ) as A8 " +
                            "group by PlantName,[Group] ) as A9 ) as Final group by PlantName,[Group] " +
                            "/** end tempdefectListP **/ " +
                            /** end Temp Table tempdefectListP **/

                            /** Temp Table tempdefectListP2 **/
                            "/** Temp Table : tempdefectListP2 **/ " +
                            "select PlantName,[group],Qty,(Qty*M3)M3 into tempdefectListP2 from ( " +
                            "select PlantName,[group],Qty,(Qty*M3)M3 from (select PlantName,[group],sum(qty)Qty,sum(M3)M3 from ( " +
                            "select A6.PlantName,A5.[group],A4.Qty,((A7.Tebal*A7.Lebar*A7.Panjang)/1000000000)M3 from ( " +
                            "select A3.PlantID,A3.PlantGroupID,A2.Tanggal,A2.Qty,A2.ItemID from ( " +
                            "select (select A1.PartNo from FC_Items A1 where A1.ID=A.ItemID)Partno,A.DestID,A.TglTrans Tanggal,A.QtyIn Qty,A.ItemID " +
                            "from T3_Rekap A " +
                            "INNER JOIN T1_Straping B ON A.DestID=B.DestID and A.T1SerahID=B.ID where CONVERT(varchar,A.TglTrans,112)>=@thnbln1 " +
                            "and CONVERT(varchar,A.TglTrans,112)<=@thnbln2 and A.sfrom='straping' and A.RowStatus>-1 and A.ItemID in " +
                            "(select ID from FC_Items where partno like'%-P-%') ) as A2 INNER JOIN BM_Destacking A3 ON A2.DestID=A3.ID ) as A4 " +
                            "INNER JOIN BM_PlantGroup A5 ON A4.PlantGroupID=A5.ID INNER JOIN BM_Plant A6 ON A6.ID=A4.PlantID " +
                            "INNER JOIN FC_Items A7 ON A7.ID=A4.ItemID ) as A8 group by PlantName,[Group] ) as A9 ) as xx " +
                            /** end Temp Table tempdefectListP2 **/

                            /** Temp Table tempdefectListPOK **/
                            "/** tempdefectListPOK **/ " +
                            "/** OK KW dari Strapping **/ " +
                            "select PlantName,[group],Qty,(Qty*M3)M3 into tempdefectListPOK from (select PlantName,[group],sum(qty)Qty,sum(M3)M3 " +
                            "from (select A6.PlantName,A5.[group],A4.Qty,((A7.Tebal*A7.Lebar*A7.Panjang)/1000000000)M3 " +
                            "from (select A3.PlantID,A3.PlantGroupID,A2.Tanggal,A2.Qty,A2.ItemID  from (select (select A1.PartNo " +
                            "from FC_Items A1 where A1.ID=A.ItemID)Partno,A.DestID,A.TglTrans Tanggal,A.QtyIn Qty,A.ItemID from T3_Rekap A " +
                            "INNER JOIN T1_Straping B ON A.DestID=B.DestID and A.T1SerahID=B.ID where CONVERT(varchar,A.TglTrans,112)>=@thnbln1 " +
                            "and CONVERT(varchar,A.TglTrans,112)<=@thnbln2 and A.sfrom='straping' and A.RowStatus>-1 and A.ItemID in (select ID " +
                            "from FC_Items where partno like'%-3-%' or partno like'%-M-%') ) as A2 INNER JOIN BM_Destacking A3 ON A2.DestID=A3.ID ) as A4 " +
                            "INNER JOIN BM_PlantGroup A5 ON A4.PlantGroupID=A5.ID INNER JOIN BM_Plant A6 ON A6.ID=A4.PlantID " +
                            "INNER JOIN FC_Items A7 ON A7.ID=A4.ItemID ) as A8 group by PlantName,[Group] ) as A9 " +
                            "/** end tempdefectListPOK **/ " +
                            /** end Temp Table tempdefectListPOK **/

                            /** Hitung Jumlah Group Produksi  **/
                            "set @TotalGroup = " +
                            "(select count(TotalGroup)Total from (select [group] TotalGroup from (select xx.*,A.PlantGroupID,A.PlantID from ( " +
                            "select qty,destid from vw_KartustockWIP where CONVERT(varchar,tanggal,112)>=@thnbln1 and CONVERT(varchar,tanggal,112)<=@thnbln2 " +
                            "and Lokasi in ('B99','H99') and qty<0 " +
                            "union all " +
                            "select cast(qty as decimal(10,2)) Qty,DestID from vw_KartustockWIP2 where CONVERT(varchar,tanggal,112)>=@thnbln1 and " +
                            "CONVERT(varchar,tanggal,112)<=@thnbln2 and qty<0 AND ItemID IN (SELECT ID from FC_Items where partno like'%-3-%' or " +
                            "PartNo like'%-M-%' or PartNo like'%-P-%')) as xx left join BM_Destacking A ON A.ID=xx.destid ) as xx1 " +
                            "left join BM_PlantGroup B ON B.ID=xx1.PlantGroupID left join BM_Plant C ON C.ID=xx1.PlantID  group by [group] ) as Data1) " +

                            /** Hitung Jumlah Line Produksi  **/
                            "set @TotalLine = " +
                            "(select count(PlantName)TotalLine from(select distinct C.PlantName  from (select xx.*,A.PlantGroupID,A.PlantID from ( " +
                            "select qty,destid from vw_KartustockWIP where CONVERT(varchar,tanggal,112)>=@thnbln1 and CONVERT(varchar,tanggal,112)<=@thnbln2 " +
                            "and Lokasi in ('B99','H99') and qty<0 " +
                            "union all " +
                            "select cast(qty as decimal(10,2)) Qty,DestID from vw_KartustockWIP2 where CONVERT(varchar,tanggal,112)>=@thnbln1 " +
                            "and CONVERT(varchar,tanggal,112)<=@thnbln2 and qty<0 AND ItemID IN (SELECT ID from FC_Items where partno like'%-3-%' or " +
                            "PartNo like'%-M-%' or PartNo like'%-P-%')) as xx left join BM_Destacking A ON A.ID=xx.destid ) as xx1 " +
                            "left join BM_PlantGroup B ON B.ID=xx1.PlantGroupID left join BM_Plant C ON C.ID=xx1.PlantID ) as DataXX ) " +

                            "set @TotalGroup1 = " +
                            "(select count([group])Total from ( " +
                            "select distinct([Group]) from ( " +
                            "select sum(xx.Qty)Qty,sum(M3)M3,PlantName,[group] from (select sum(QtyIn)Qty,sum((((B.Tebal*B.Lebar*B.Panjang)/1000000000)*A.QtyIn))M3," +
                            "DestID from t3_rekap A inner join FC_Items B ON B.ID=A.ItemID where CONVERT(varchar,A.TglTrans,112)>=@thnbln1 " +
                            "and CONVERT(varchar,A.TglTrans,112)<=@thnbln2 and Sfrom='straping' and ItemID in (select ID from FC_Items where partno like'%-P-%') and A.RowStatus>-1 " +
                            "group by B.Tebal,B.Lebar,B.Panjang,A.DestID ) as xx inner join BM_Destacking A ON A.ID=xx.DestID " +
                            "inner join BM_PlantGroup B ON B.ID=A.PlantGroupID inner join BM_Plant C ON C.ID=A.PlantID group by PlantName,[group] " +
                            "union all " +
                            "select sum(xx.Qty)Qty,sum(M3)M3,PlantName,[group] from (select sum(A.QtyIn)Qty,sum((((C.Tebal*C.Lebar*C.Panjang)/1000000000)*A.QtyIn))" +
                            "M3,A.DestID from T1_LR1_Listplank A inner join T1_Bevel B ON A.L1ID=B.ID inner join FC_Items C ON C.ID=B.ItemID " +
                            "where CONVERT(varchar,A.TglTrans,112)>=@thnbln1 and CONVERT(varchar,A.TglTrans,112)<=@thnbln2 and Status>-1 and A.L1ID in (select ID from T1_Bevel " +
                            "where RowStatus>-1) " +
                            "group by A.DestID ) as xx inner join BM_Destacking A ON A.ID=xx.DestID inner join BM_PlantGroup B ON B.ID=A.PlantGroupID " +
                            "inner join BM_Plant C ON C.ID=A.PlantID group by PlantName,[group] ) as Data1 ) as cc )" +

                            "set @Pembagi1 = " +
                            "(select sum((((B.Tebal*B.Lebar*B.Panjang)/1000000000)*xx.Qty)) / @TotalGroup1 M3 " +
                            "from (select sum(QtyIn) Qty,SerahID from T3_Simetris where ID in (select CutID from vw_KartuStockBJNew " +
                            "where CONVERT(varchar,tanggal,112)>=@thnbln1 and CONVERT(varchar,tanggal,112)<=@thnbln2 and ItemID IN (SELECT ID from FC_Items where partno like'%-P-%') and " +
                            "Process like'%simetris%' and Keterangan like'%-1-%' and CutID in (select ID from T3_Simetris where QtyIn<QtyOut and RowStatus>-1)) " +
                            "and RowStatus>-1 group by SerahID ) as xx inner join T3_Serah A ON A.ID=xx.SerahID inner join FC_Items B ON B.ID=A.ItemID) " +


                            "set @M32 = " +
                            "(select sum(M3)/@TotalGroup M3 from ( " +
                            "select sum((((A2.Tebal*A2.Lebar*A2.Panjang)/1000000000)*xx.Qty)) M3 from (select sum(Qty)qty,SerahID from vw_KartuStockBJNew  " +
                            "where CONVERT(varchar,tanggal,112)>=@thnbln1 and CONVERT(varchar,tanggal,112)<=@thnbln2 and ItemID IN (SELECT ID from FC_Items where  PartNo like'%-P-%') and " +
                            "Process like'%simetris%' and Keterangan like'%-1-%' and CutID in (select ID from T3_Simetris where QtyIn=QtyOut and RowStatus>-1) " +
                            "group by SerahID ) as xx inner join T3_Serah A1 ON A1.ID=xx.SerahID inner join FC_Items A2 ON A2.ID=A1.ItemID " +
                            "union all " +
                            "select round(sum((((A2.Tebal*A2.Lebar*A2.Panjang)/1000000000)*xx.Qty)),1)M3 from (select sum(QtyIn)Qty,SerahID from T3_Simetris " +
                            "where ID in (select CutID from vw_KartuStockBJNew where CONVERT(varchar,tanggal,112)>=@thnbln1 and CONVERT(varchar,tanggal,112)<=@thnbln2 and ItemID IN " +
                            "(SELECT ID from FC_Items where partno like'%-P-%') and Process like'%simetris%' and Keterangan like'%-1-%' and CutID in " +
                            "(select ID from T3_Simetris where QtyIn<QtyOut and RowStatus>-1)) and RowStatus>-1 group by SerahID ) as xx " +
                            "inner join t3_Serah A1 ON A1.ID=xx.SerahID inner join FC_Items A2 ON A2.ID=A1.ItemID ) as xx )" +

                            "set @M3 = " +
                            "(select sum(M3)/@TotalGroup M3 from ( " +
                            "select cast(sum(xx.Qty) as decimal(10,2)) Qty,sum((((A2.Tebal*A2.Lebar*A2.Panjang)/1000000000)*xx.Qty)) M3 " +
                            "from (select sum(Qty)qty,SerahID from vw_KartuStockBJNew  where CONVERT(varchar,tanggal,112)>=@thnbln1 and " +
                            "CONVERT(varchar,tanggal,112)<=@thnbln2 and ItemID IN (SELECT ID from FC_Items where partno like'%-3-%' or PartNo like'%-M-%' or " +
                            "PartNo like'%-P-%') and Process like'%simetris%' and Keterangan like'%-1-%' and CutID in (select ID from T3_Simetris " +
                            "where QtyIn=QtyOut and RowStatus>-1) group by SerahID ) as xx inner join T3_Serah A1 ON A1.ID=xx.SerahID " +
                            "inner join FC_Items A2 ON A2.ID=A1.ItemID  " +
                            "union all " +
                            "select sum(qty)Qty,sum(m3)M3 from ( " +
                            "select x.Qty,(((A2.Tebal*A2.Lebar*A2.Panjang)/1000000000)*x.Qty)M3 from ( " +
                            "select sum(QtyIn)Qty,serahID from T3_Simetris where ID in (select CutID from vw_KartuStockBJNew " +
                            "where CONVERT(varchar,tanggal,112)>=@thnbln1 and CONVERT(varchar,tanggal,112)<=@thnbln2 and ItemID IN (SELECT ID from FC_Items where partno like'%-3-%' or " +
                            "partno like'%-M-%' or partno like'%-P-%') and Process like'%simetris%' and Keterangan like'%-1-%' and CutID in " +
                            "(select ID from T3_Simetris where QtyIn<QtyOut and RowStatus>-1)) and RowStatus>-1 group by serahiD ) as x " +
                            "inner join t3_serah A1 ON A1.ID=x.SerahID inner join FC_Items A2 ON A2.ID=A1.ItemID ) as AA ) as BB) " +

                             "set @TotalGroup2 = " +
                            "(select count([group])Total from (select sum(Qty)Qty,sum(M3)M3,[group],PlantName " +
                            "from (select QtyIn Qty,M3,B1.[Group],B2.PlantName from (select x1.*,(((A2.Tebal*A2.Lebar*A2.Panjang)/1000000000)*x1.QtyIn)M3 " +
                            "from (select *,case when sfrom='straping' then (select A.ItemID0 from T1_Straping A where A.ID=T1SerahID) " +
                            "when sfrom='Bevel' then (select A1.ItemID0 from T1_Bevel A1 where A1.ID=T1SerahID) end ItemID0 " +
                            "from (select Sfrom,QtyIn,DestID,T1SerahID from T3_Rekap where Keterangan like'%-1-%' and ItemID in (select ID from FC_Items " +
                            "where partno like'%-S-%') and CONVERT(varchar,TglTrans,112)>=@thnbln1 and CONVERT(varchar,TglTrans,112)<=@thnbln2 and Process='direct' and (sfrom='straping' or " +
                            "Sfrom='Bevel')) as x ) as x1 inner join FC_Items A2 ON A2.ID=x1.ItemID0 ) as x2 inner join BM_Destacking B ON B.ID=x2.DestID " +
                            "inner join BM_PlantGroup B1 ON B1.ID=B.PlantGroupID inner join BM_Plant B2 ON B2.ID=B.PlantID ) as x3 " +
                            "group by [Group],PlantName ) as data1 ) " +

                            /** BSAuto T1 **/
                            " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempitembsauto2]') AND type in (N'U')) " +
                            " DROP TABLE [dbo].[tempitembsauto2]  " +

                            " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempKartuStockBJNew2]') AND type in (N'U')) " +
                            " DROP TABLE [dbo].[tempKartuStockBJNew2]  " +

                            " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempitembs]') AND type in (N'U')) " +
                            " DROP TABLE [dbo].[tempitembs] " +



                            " select distinct itemid into tempitembsauto2 from vw_KartuStockBJNew " +
                            " where itemid in (select ID from fc_items where partno like '%-s-%') and LokID in (select ID from FC_Lokasi where Lokasi='bsauto') " +

                            " select * into tempitembs from vw_KartuStockBJNew " +
                            " where left(CONVERT(char, tanggal ,112),8)>=@thnbln1 and left(CONVERT(char, tanggal ,112),8)<=@thnbln2 and itemID " +
                            " not in  (select itemid from tempitembsauto2) " +

                            " select * into tempKartuStockBJNew2 from vw_KartuStockBJNew " +
                            " where left(CONVERT(char, tanggal ,112),8)>=@thnbln1 and left(CONVERT(char, tanggal ,112),8)<=@thnbln2 and itemID in " +
                            " (select itemid from tempitembsauto2) " +

                            "set @bagi2= " +
                            " (select (round(sum(M3),2)/@TotalGroup) M3 from ( " +
                            " select (sum(M3)) M3 from ( " +
                            " select ((A.Tebal*A.Lebar*A.Panjang)/1000000000)*x.Qty M3 from ( " +
                            " select isnull(SUM(Qty),0)Qty,ItemID from tempKartuStockBJNew2 " +
                            " where (process='direct' or process='Simetris' ) and substring(Keterangan,1,21) like '%-1-%' /** and " +
                            " lokid in (select ID from FC_Lokasi where Lokasi='BSAUTO') **/ group by ItemID ) as x " +
                            " inner join FC_Items A ON A.ID=x.ItemID ) as x1 " +

                            " union all " +

                            " select (round(sum(M3),3)) M3 from ( " +
                            " select ((A.Tebal*A.Lebar*A.Panjang)/1000000000)*x.Qty M3 from ( " +
                            " select isnull(SUM(Qty),0)Qty,ItemID from tempitembs " +
                            " where (process='direct' or process='Simetris') and (isnull(sfrom,'-')='-' or isnull(sfrom,'bevel')='-' " +
                            " or isnull(sfrom,'-')='straping') and  lokid not in (select ID from FC_Lokasi where Lokasi='BSAUTO') and " +
                            " substring(Keterangan,1,21) like '%-1-%' group by ItemID ) as x inner join FC_Items A ON A.ID=x.ItemID " +
                            " where A.PartNo like'%-S-%') as A ) as A1) " +



                            //" (select sum(round(Qty*Volume,2)/@TotalGroup)  M3 from (select (A1.Tebal*A1.Lebar*A1.Panjang)/1000000000 Volume,Qty  from ( " +
                            //" select sum(qty)qty,ItemID from vw_KartuStockBJNew where  (process='direct' or process='Simetris') and (isnull(sfrom,'-')='-' "+
                            //" or isnull(sfrom,'bevel')='-' or  isnull(sfrom,'-')='straping') and /** lokid not in (select ID from FC_Lokasi where Lokasi='BSAUTO') "+
                            //" and **/ substring(Keterangan,1,21) like '%-1-%' and ItemID in (select ID from FC_Items where PartNo like'%-S-%') and "+
                            //" CONVERT(varchar,Tanggal,112)>=@thnbln1 and CONVERT(varchar,Tanggal,112)<=@thnbln2  group by ItemID " +
                            //" ) as x inner join FC_Items A1 ON A1.ID=x.ItemID ) as x ) "+


                            /** temp Table tempUkuranKhusus **/
                            "select  sum(M3) + @Pembagi1 M3,PlantName,[group] into tempUkuranKhusus from ( " +
                            "select sum(xx.Qty)Qty,sum(M3)M3,PlantName,[group] from (select sum(QtyIn)Qty,sum((((B.Tebal*B.Lebar*B.Panjang)/1000000000)*A.QtyIn))" +
                            "M3,DestID from t3_rekap A inner join FC_Items B ON B.ID=A.ItemID where CONVERT(varchar,A.TglTrans,112)>=@thnbln1 and CONVERT(varchar,A.TglTrans,112)<=@thnbln2 and " +
                            "Sfrom='straping' and ItemID in (select ID from FC_Items where partno like'%-P-%') and A.RowStatus>-1 " +
                            "group by B.Tebal,B.Lebar,B.Panjang,A.DestID ) as xx inner join BM_Destacking A ON A.ID=xx.DestID " +
                            "inner join BM_PlantGroup B ON B.ID=A.PlantGroupID inner join BM_Plant C ON C.ID=A.PlantID group by PlantName,[group] " +
                            "union all " +
                            "select sum(xx.Qty)Qty,sum(M3)M3,PlantName,[group] from (select sum(A.QtyIn)Qty,sum((((C.Tebal*C.Lebar*C.Panjang)/1000000000)*A.QtyIn)) " +
                            "M3,A.DestID from T1_LR1_Listplank A inner join T1_Bevel B ON A.L1ID=B.ID inner join FC_Items C ON C.ID=B.ItemID " +
                            "where CONVERT(varchar,A.TglTrans,112)>=@thnbln1 and CONVERT(varchar,A.TglTrans,112)<=@thnbln2 and Status>-1 and A.L1ID in (select ID from T1_Bevel where RowStatus>-1) " +
                            "group by A.DestID ) as xx inner join BM_Destacking A ON A.ID=xx.DestID inner join BM_PlantGroup B ON B.ID=A.PlantGroupID " +
                            "inner join BM_Plant C ON C.ID=A.PlantID group by PlantName,[group] " +
                            ") as xxx group by PlantName,[group] " +
                            /** end temp Table tempUkuranKhusus **/

                            /** temp Table tempTotalBPM3 **/
                            //"select sum(M3) + @M32 M3,PlantName,[group] into tempTotalBPM3 from ( " +
                            //"select sum(m3)m3,PlantName,[group]  from ( " +
                            //"select sum(M3)M3,PlantName,[group] from (select sum(qty*-1)qty,sum((((B.Tebal*B.Lebar*B.Panjang)/1000000000)*A.qty * -1))M3,destid " +
                            //"from vw_KartustockWIP A inner join FC_Items B ON A.itemid0=B.ID where CONVERT(varchar,Tanggal,112)>=@thnbln1 and CONVERT(varchar,Tanggal,112)<=@thnbln2 and Lokasi='B99' " +
                            //"and qty<0  group by destid ) as xx inner join BM_Destacking A1 ON A1.ID=xx.DestID inner join BM_PlantGroup A2 " +
                            //"ON A2.ID=A1.PlantGroupID inner join BM_Plant A3 ON A3.ID=A1.PlantID  group  by PlantName,[group] " +
                            //"union all " +
                            //"select sum(M3)M3,PlantName,[group] from (select sum(qty *-1)qty,sum((((B.Tebal*B.Lebar*B.Panjang)/1000000000)*A.qty * -1))M3,DestID " +
                            //"from vw_KartustockWIP2 A inner join FC_Items B ON A.itemid0=B.ID where CONVERT(varchar,Tanggal,112)>=@thnbln1 and CONVERT(varchar,Tanggal,112)<=@thnbln2 and qty<0 " +
                            //"AND ItemID IN (SELECT ID from FC_Items where partno like'%-P-%' ) group by DestID) as xx inner join BM_Destacking A1 " +
                            //"ON A1.ID=xx.DestID inner join BM_PlantGroup A2 ON A2.ID=A1.PlantGroupID inner join BM_Plant A3 ON A3.ID=A1.PlantID " +
                            //"group  by PlantName,[group]) as xx1 group  by PlantName,[group] " +
                            //"union all " +
                            //"select  round(sum(M3),1)M3,PlantName,[group] from ( " +
                            //"select sum(M3)M3,A3.PlantName,A2.[Group] from (select sum(QtyIn)Qty,sum((((B.Tebal*B.Lebar*B.Panjang)/1000000000)*A.QtyIn))M3,DestID " +
                            //"from t3_rekap A inner join FC_Items B ON B.ID=A.ItemID where CONVERT(varchar,TglTrans,112)>=@thnbln1 and CONVERT(varchar,TglTrans,112)<=@thnbln2 and Sfrom='straping' " +
                            //"and ItemID in (select ID from FC_Items where partno like'%-P-%') and A.RowStatus>-1 group by B.Tebal,B.Lebar,B.Panjang,A.DestID ) " +
                            //"as xx inner join BM_Destacking A1 ON A1.ID=xx.DestID inner join BM_PlantGroup A2 ON A2.ID=A1.PlantGroupID inner join BM_Plant A3 " +
                            //"ON A3.ID=A1.PlantID group by PlantName,[group] " +
                            //"union all " +
                            //"select sum(M3)M3,A3.PlantName,A2.[Group] from (select sum(A.QtyIn)Qty,sum((((C.Tebal*C.Lebar*C.Panjang)/1000000000)*A.QtyIn))M3," +
                            //"A.DestID from T1_LR1_Listplank A inner join T1_Bevel B ON A.L1ID=B.ID inner join FC_Items C ON C.ID=B.ItemID " +
                            //"where CONVERT(varchar,A.TglTrans,112)>=@thnbln1 and CONVERT(varchar,A.TglTrans,112)<=@thnbln2 and Status>-1 and A.L1ID in (select ID from T1_Bevel where RowStatus>-1) " +
                            //"group by A.DestID ) as xx inner join BM_Destacking A1 ON A1.ID=xx.DestID inner join BM_PlantGroup A2 ON A2.ID=A1.PlantGroupID " +
                            //"inner join BM_Plant A3 ON A3.ID=A1.PlantID group by PlantName,[group] " +
                            //") as xxx group  by PlantName,[group] " +
                            //") as xx2 group  by PlantName,[group] " +
                            /** end temp Table tempTotalBPM3 **/


                            /** temp Table tempBST1 **/
                            "select [group],PlantName,sum(M3)M3 into tempBST1 from  (select groupP [group],case when GroupP in ('KA','KB','KC','KD') " +
                            "then 'LINE 1' when GroupP in ('KE','KF','KG','KH') then 'LINE 2' when GroupP in ('KI','KJ','KK','KL') then 'LINE 3' " +
                            "when GroupP in ('KM','KN','KO','KP') then 'LINE 4' when GroupP in ('KQ','KR','KS','KT') then 'LINE 5' " +
                            "when GroupP in ('KU','KV','KW','KX') then 'LINE 6' end PlantName,'0' + cast(@bagi2 as decimal(10,3)) M3  " +
                            "from (select GroupP from (select [group] GroupP from (select xx.*,A.PlantGroupID,A.PlantID " +
                            "from ( select qty,destid from vw_KartustockWIP " +
                            "where CONVERT(varchar,Tanggal,112)>=@thnbln1 and CONVERT(varchar,Tanggal,112)<=@thnbln2 " +
                            "and Lokasi in ('B99','H99') and qty<0 union all select cast(qty as decimal(10,2)) Qty,DestID " +
                            "from vw_KartustockWIP2 " +
                            "where CONVERT(varchar,Tanggal,112)>=@thnbln1 and CONVERT(varchar,Tanggal,112)<=@thnbln2 and qty<0 AND ItemID IN " +
                            "(SELECT ID from FC_Items where partno like'%-3-%' or PartNo like'%-M-%' or PartNo like'%-P-%')) as xx " +
                            "left join BM_Destacking A ON A.ID=xx.destid where A.PlantGroupID>0 and A.PlantID>0) as xx1 " +
                            "left join BM_PlantGroup B ON B.ID=xx1.PlantGroupID left join BM_Plant C ON C.ID=xx1.PlantID  group by [group] ) as Data1) as p  " +
                            "union all " +
                            /** BS dari Listplank pertama **/
                            "select [group],PlantName,(sum(M3)) M3 from (select QtyIn Qty,M3,B1.[Group],B2.PlantName " +
                            "from (select x1.*,(((A2.Tebal*A2.Lebar*A2.Panjang)/1000000000)*x1.QtyIn)M3 from (select *,case when sfrom='straping' " +
                            "then (select A.ItemID0 from T1_Straping A where A.ID=T1SerahID) when sfrom='Bevel' then (select A1.ItemID0 from T1_Bevel A1 " +
                            "where A1.ID=T1SerahID) end ItemID0 from (select Sfrom,QtyIn,DestID,T1SerahID from T3_Rekap where Keterangan like'%-1-%' " +
                            "and ItemID in (select ID from FC_Items where partno like'%-S-%') and CONVERT(varchar,TglTrans,112)>=@thnbln1 and " +
                            "CONVERT(varchar,TglTrans,112)<=@thnbln2 and Process='direct' and (sfrom='straping' or Sfrom='Bevel')) as x ) as x1 inner join FC_Items A2 ON A2.ID=x1.ItemID0 ) as x2 " +
                            "inner join BM_Destacking B ON B.ID=x2.DestID inner join BM_PlantGroup B1 ON B1.ID=B.PlantGroupID " +
                            "inner join BM_Plant B2 ON B2.ID=B.PlantID ) as x3 group by [Group],PlantName) as Dt group by [group],PlantName " +
                            /** end Data BS Tahap I **/

                            /** temp Table tempTotalSerahDfctM3 **/
                            "select sum(M3)M3,PlantName,[group] into tempTotalSerahDfctM3 from ( " +
                            "select sum(M3)M3,PlantName,[group] from ( " +
                            "select sum(M3) + /**14.633890**/@M3 M3,PlantName,[group]   from ( " +
                            "select sum(M3*-1)M3,PlantName,[group]  from ( " +
                            "select sum((((B.Tebal*B.Lebar*B.Panjang)/1000000000)*A.qty)) M3,PlantName,[group] from vw_KartustockWIP A " +
                            "inner join FC_Items B ON A.itemid0=B.ID inner join BM_Destacking C ON C.ID=A.destid inner join BM_PlantGroup D ON D.ID=C.PlantGroupID " +
                            "inner join BM_Plant E ON E.ID=C.PlantID where CONVERT(varchar,tanggal,112)>=@thnbln1 and CONVERT(varchar,tanggal,112)<=@thnbln2 and " +
                            "Lokasi in ('H99','B99') and A.qty<0  group by PlantName,[group] " +
                            "union all " +
                            "select sum((((B.Tebal*B.Lebar*B.Panjang)/1000000000)*A.qty)) M3,PlantName,[group] from vw_KartustockWIP2 A " +
                            "inner join FC_Items B ON A.itemid0=B.ID inner join BM_Destacking C ON C.ID=A.destid inner join BM_PlantGroup D " +
                            "ON D.ID=C.PlantGroupID inner join BM_Plant E ON E.ID=C.PlantID where CONVERT(varchar,tanggal,112)>=@thnbln1 and " +
                            "CONVERT(varchar,tanggal,112)<=@thnbln2 and A.qty<0 AND A.ItemID IN (SELECT ID from FC_Items where partno like'%-3-%' or " +
                            "PartNo like'%-M-%' or PartNo like'%-P-%') group by PlantName,[group] " +
                            ") as x1 group by PlantName,[group] ) as x2 group by PlantName,[group] ) as cc group by PlantName,[group] " +
                            "union all " +
                            "select sum(M3)M3,PlantName,[group] from ( " +
                            "select M3,PlantName,[group] from (select sum(A.QtyIn)Qty,sum((((C.Tebal*C.Lebar*C.Panjang)/1000000000)*A.QtyIn))M3,A.DestID " +
                            "from T1_Straping A inner join T1_Bevel B ON A.L1ID=B.ID inner join FC_Items C ON C.ID=B.ItemID where A.RowStatus>-1 and " +
                            "CONVERT(varchar,A.TglTrans,112)>=@thnbln1 and CONVERT(varchar,A.TglTrans,112)<=@thnbln2 and A.L1ID in (select ID from T1_Bevel " +
                            "where RowStatus>-1) group by A.DestID) as A1 inner join BM_Destacking B1 ON B1.ID=A1.DestID inner join BM_PlantGroup C1 " +
                            "ON C1.ID=B1.PlantGroupID inner join BM_Plant D1 ON D1.ID=B1.PlantID " +
                            "union all " +
                            "select M3,PlantName,[group] from (select sum(Qty)Qty,sum((((B1.Tebal*B1.Lebar*B1.Panjang)/1000000000)*A1.Qty))M3,ItemID,DestID " +
                            "from (select sum(A.QtyIn)Qty,B.ItemID,A.DestID from T1_LR1_Listplank A inner join T1_Bevel B ON A.L1ID=B.ID where A.L1ID in " +
                            "(select ID from T1_Bevel where RowStatus>-1) and CONVERT(varchar,A.TglTrans,112)>=@thnbln1 and " +
                            "CONVERT(varchar,A.TglTrans,112)<=@thnbln2 and Status>-1 group by B.ItemID,A.DestID) as A1 inner join FC_Items B1 ON B1.ID=A1.ItemID " +
                            "group by A1.ItemID,A1.DestID ) as X1 inner join BM_Destacking X2 ON X2.ID=X1.DestID " +
                            "inner join BM_PlantGroup X3 ON X3.ID=X2.PlantGroupID inner join BM_Plant X4 ON X4.ID=X2.PlantID ) as AAA " +
                            "group by PlantName,[group] ) as A2 group by PlantName,[group] " +
                            /** end temp Table tempTotalSerahDfctM3 **/

                            /** temp Table tempTotalSerahLP **/
                            "select sum(Qty)Qty,sum(M3)M3,PlantName,[Group] into tempTotalSerahLP from ( " +
                            "/** Bevel Out**/ " +
                             "select sum(Qty)Qty,sum(M3 * Qty)M3,PlantName,[Group] from (select x.*,B.[Group],C.PlantName,((D.Tebal*D.Lebar*D.Panjang)/1000000000)M3 " +
                             " from (select sum(QtyIn)Qty,DestID,ItemID from T1_Straping where CONVERT(varchar,TglTrans,112)>=@thnbln1 and " +
                             "CONVERT(varchar,TglTrans,112)<=@thnbln2 and RowStatus>-1 and L1ID in (select ID from T1_Bevel where RowStatus >-1) " +
                             "group by DestID,ItemID ) as x " +
                             "LEFT JOIN BM_Destacking A ON A.ID=x.DestID " +
                             "LEFT JOIN BM_PlantGroup B ON B.ID=A.PlantGroupID " +
                             "LEFT JOIN BM_Plant C ON C.ID=A.PlantID " +
                             "LEFT JOIN FC_Items D ON D.ID=x.ItemID) as x2 group by PlantName,[Group] " +
                             "union all " +
                             "select sum(Qty)Qty,sum(M3 * Qty)M3,PlantName,[Group] from (select x.*,B.[Group],C.PlantName,((D.Tebal*D.Lebar*D.Panjang)/1000000000)M3 " +
                             "from (select sum(QtyIn)Qty,DestID,ItemID from T1_LR1_Listplank where CONVERT(varchar,TglTrans,112)>=@thnbln1 and " +
                             "CONVERT(varchar,TglTrans,112)<=@thnbln2 and Status>-1 and L1ID in (select ID from T1_Bevel where RowStatus >-1) " +
                             "group by DestID,ItemID ) as x  " +
                             "LEFT JOIN BM_Destacking A ON A.ID=x.DestID " +
                             "LEFT JOIN BM_PlantGroup B ON B.ID=A.PlantGroupID  " +
                             "LEFT JOIN BM_Plant C ON C.ID=A.PlantID " +
                             "LEFT JOIN FC_Items D ON D.ID=x.ItemID) as x2 group by PlantName,[Group] " +
                             "union all " +
                             "/** BP dari Bevel **/ " +
                             " select sum(Qty * -1)Qty,sum(M3 * Qty)M3,PlantName,[Group] from (select x.*,B.[Group],C.PlantName,((D.Tebal*D.Lebar*D.Panjang)/1000000000)M3 " +
                             "from (select sum(QtyIn)Qty,DestID,ItemID from T1_LR1_Listplank where CONVERT(varchar,TglTrans,112)>=@thnbln1 and " +
                             "CONVERT(varchar,TglTrans,112)<=@thnbln2 and Status>-1 and L1ID in (select ID from T1_Bevel where RowStatus >-1) " +
                             "group by DestID,ItemID ) as x  " +
                             " LEFT JOIN BM_Destacking A ON A.ID=x.DestID " +
                             "LEFT JOIN BM_PlantGroup B ON B.ID=A.PlantGroupID " +
                             " LEFT JOIN BM_Plant C ON C.ID=A.PlantID " +
                             "LEFT JOIN FC_Items D ON D.ID=x.ItemID) as x2 group by PlantName,[Group] " +
                             "union all " +
                            "/** BP dari Straping **/ " +
                            "select sum(Qty * -1)Qty,sum(M3 * Qty)M3,PlantName,[Group] from tempdefectListP2 group by PlantName,[Group] " +
                             ") as DataA group by PlantName,[Group] " +
                             /** end temp Table tempTotalSerahLP **/

                             /** temp Table tempdefectListP3 **/
                             " select sum(qty)Qty,PlantName,[Group] into tempdefectListP3  from ( " +
                             "select A.qty * -1 Qty,(((E.Tebal*E.Lebar*E.Panjang)/1000000000)*A.qty *-1)M3,C.[Group],D.PlantName from vw_KartustockWIP A LEFT JOIN BM_Destacking B ON A.destid=B.ID LEFT JOIN BM_PlantGroup C ON C.ID=B.PlantGroupID LEFT JOIN BM_Plant D ON D.ID=B.PlantID LEFT JOIN FC_Items E ON E.ID=A.ItemID where left(convert(char,A.tanggal,112),6)='201911' and A.Lokasi='B99' and A.qty<0 " +
                             "union all " +
                             "select A.qty * -1 Qty,(((E.Tebal*E.Lebar*E.Panjang)/1000000000)*A.qty *-1)M3,C.[Group],D.PlantName from vw_KartustockWIP2 A LEFT JOIN BM_Destacking B ON A.destid=B.ID LEFT JOIN BM_PlantGroup C ON C.ID=B.PlantGroupID LEFT JOIN BM_Plant D ON D.ID=B.PlantID LEFT JOIN FC_Items E ON E.ID=A.ItemID where left(convert(char,A.tanggal,112),6)='201911'  and A.qty<0 and A.ItemID IN (SELECT ID from FC_Items where partno like'%-P-%' ) " +
                             ") as x1 group by PlantName,[Group] " +
                            /** end temp Table tempdefectListP3 **/

                            /** Data Adjust yg sdh serah **/
                            //"IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDM3]') AND type in (N'U')) DROP TABLE [dbo].tempDM3 " +
                            //"IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempD1M3]') AND type in (N'U')) DROP TABLE [dbo].tempD1M3 " +
                            //"IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempD2M3]') AND type in (N'U')) DROP TABLE [dbo].tempD2M3 " +
                            //"IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempD3M3]') AND type in (N'U')) DROP TABLE [dbo].tempD3M3 " +

                            "select A.Qty,A.M3,substring(A2.PartNo,7,11)PartNo,destid into tempDM3 from ( " +
                            "select DestID,A.Qty * -1 Qty,(((B.Tebal*B.Lebar*B.Panjang)/1000000000)*A.qty)*-1 M3 from vw_KartustockWIP A " +
                            "inner join FC_Items B ON A.itemid0=B.ID where CONVERT(varchar,tanggal,112)>=@thnbln1 and CONVERT(varchar,tanggal,112)<=@thnbln2 " +
                            "and Lokasi in ('B99','H99') and qty<0  and destid in (select ID from BM_Destacking " +
                            "where LokasiID in (select ID from FC_Lokasi where Lokasi like'%adj%')) " +
                            "union all  " +
                            "select DestID,cast(qty as decimal(10,2))*-1 Qty,(((B1.Tebal*B1.Lebar*B1.Panjang)/1000000000)*A1.qty)*-1 M3 " +
                            "from vw_KartustockWIP2 A1 inner join FC_Items B1 ON A1.itemid0=B1.ID where  " +
                            "CONVERT(varchar,tanggal,112)>=@thnbln1 and CONVERT(varchar,tanggal,112)<=@thnbln2 and qty<0 AND ItemID IN (SELECT ID from FC_Items where partno like'%-3-%' or " +
                            "PartNo like'%-M-%' or PartNo like'%-P-%') and destid in (select ID from BM_Destacking where LokasiID in (select ID from FC_Lokasi " +
                            " where Lokasi like'%adj%'))) as A " +
                            "inner join BM_Destacking A1 ON A1.ID=A.destid " +
                            "inner join FC_Items A2 ON A2.ID=A1.ItemID " +

                            "select A.*,B.PlantID,B.RowStatus into tempD1M3 from tempDM3 A left join FC_ItemsAdjustDefect B ON A.PartNo=B.PartNo and B.RowStatus>-1 " +

                            "select destid,qty,M3,PlantGroupID,PlantID,RowStatus into tempD2M3 from (select distinct destid,qty,M3,PlantGroupID,PlantID,RowStatus " +
                            "from (select x.destid,x.PartNo,x.qty,x.M3,x1.PlantGroupID,x1.PlantID,x.RowStatus from tempD1M3 as x inner join (select PlantID,PlantGroupID " +
                            "from BM_Destacking where LokasiID not in (select ID from FC_Lokasi where Lokasi like'%adj%') and " +
                            "CONVERT(varchar,tglproduksi,112)>=@thnbln1 and CONVERT(varchar,tglproduksi,112)<=@thnbln2 and RowStatus>-1) x1 ON x1.PlantID=x.PlantID ) as xx " +
                            "group by destid,PlantGroupID,qty,PlantID,RowStatus,M3 ) as x2 " +

                            "select GroupP,PlantName,SubQty Qty,SubM3 M3 into tempD3M3 from (select GroupP,PlantName,SubQty,SubM3 " +
                            "from (select *,cast((qty/Ttl) as decimal(10,2)) SubQty,cast((M3/Ttl) as decimal(10,2)) SubM3 from (select B1.PlantName,x3.*,A1.[Group]GroupP " +
                            "from (select COUNT(A.destid)Ttl,B.* from tempD2M3 A inner join tempD2M3 B ON A.destid=B.destid " +
                            "group by A.destid,B.destid,B.qty,B.PlantGroupID,B.PlantID,B.RowStatus,B.M3 ) as x3 " +
                            "inner join BM_PlantGroup A1 ON A1.ID=x3.PlantGroupID " +
                            "inner join BM_Plant B1 ON B1.ID=A1.PlantID) as A1 ) as A2 ) as A3 group by GroupP,PlantName,SubQty,SubM3 " +
                            /** end Data Adjust yg sdh serah **/

                            ///** Defect Produksi **/
                            ///** temp Table tempDataDefectBM_m3 **/
                            //"declare @DefectBagi decimal(18,2) " +
                            ////"declare @tgl1 varchar(8) "+
                            ////"declare @tgl2 varchar(8) "+

                            //"set @DefectBagi=(select cast((sum(M3)/(select count(distinct [group]) from tempTtlSerah_m33)) as decimal(10,2)) M3 " +
                            //"from (select isnull(sum((((B.Tebal*B.Lebar*B.Panjang)/1000000000) * xx.Qty )),0) M3 " +
                            //"from (select sum(QtyIn) Qty,SerahID from T3_Simetris where ID in (select CutID from vw_KartuStockBJNew " +
                            //"where CONVERT(varchar,tanggal,112)>=@thnbln1 and CONVERT(varchar,tanggal,112)<=@thnbln2 and ItemID " +
                            //"IN (SELECT ID from FC_Items where partno like'%-P-%') and " +
                            //"Process like'%simetris%' and Keterangan like'%-1-%' and CutID in (select ID from T3_Simetris where QtyIn<QtyOut and RowStatus>-1))  " +
                            //"and RowStatus>-1 group by SerahID ) as xx inner join T3_Serah A ON A.ID=xx.SerahID inner join FC_Items B ON B.ID=A.ItemID  " +
                            //"union all  " +
                            ///** BP yg keluar dari Mesin Cutter dan ketika di potong menghasilkan 1 Produk **/
                            //"select sum((((A2.Tebal*A2.Lebar*A2.Panjang)/1000000000) * xx.Qty )) M3  from (select sum(Qty)qty,SerahID from vw_KartuStockBJNew   " +
                            //"where CONVERT(varchar,tanggal,112)>=@thnbln1 and CONVERT(varchar,tanggal,112)<=@thnbln2 and ItemID IN (SELECT ID from FC_Items " +
                            //"where  PartNo like'%-P-%')  " +
                            //"and Process like'%simetris%' and Keterangan like'%-1-%' and CutID in (select ID from T3_Simetris " +
                            //"where QtyIn=QtyOut and RowStatus>-1) " +
                            //"group by SerahID ) as xx inner join T3_Serah A1 ON A1.ID=xx.SerahID inner join FC_Items A2 ON A2.ID=A1.ItemID ) as xx1) " +


                            //"IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTm3]') AND type in (N'U')) DROP TABLE [dbo].[tempTm3] " +
                            //"IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDataDefectBM_m3]') AND type in (N'U')) DROP TABLE [dbo].[tempDataDefectBM_m3] " +

                            //"select cast(M3 as decimal(10,2)) M3,[group],PlantName into tempTm3 from (select cast(sum(M3) as decimal(10,2)) M3,[group],PlantName from ( " +
                            ///** BP ListPlank ada informasi Group Produksi **/
                            //"select M3,[group],PlantName from tempdefectListP  " +
                            //"union all  " +
                            ///** BP yg keluar dari proses Tahap I (Produk Pelarian - Produk Normal ) ada informasi Group Produksi **/
                            //"select M3,[group],PlantName from (select sum(M3)M3,[group],PlantName from (select xx.*,A2.[Group],A3.PlantName from ( " +
                            //"select sum((((B.Tebal*B.Lebar*B.Panjang)/1000000000)*A.qty))*-1 M3,destid from vw_KartustockWIP A inner join FC_Items B ON A.itemid0=B.ID " +
                            //"where CONVERT(varchar,tanggal,112)>=@thnbln1 and CONVERT(varchar,tanggal,112)<=@thnbln2 " +
                            //"and Lokasi='B99' and destid not in (select ID from BM_Destacking where LokasiID in (select ID from FC_Lokasi " +
                            //"where Lokasi like'%adj%')) and qty<0  group by destid,Tebal,Lebar,Panjang " +
                            //"union all  " +
                            //"select sum((((B.Tebal*B.Lebar*B.Panjang)/1000000000)*A.qty))*-1 M3,destid from vw_KartustockWIP2 A " +
                            //"inner join FC_Items B ON A.itemid0=B.ID  " +
                            //"where CONVERT(varchar,tanggal,112)>=@thnbln1 and CONVERT(varchar,tanggal,112)<=@thnbln2 and qty<0 AND " +
                            //"ItemID IN (SELECT ID from FC_Items where partno like'%-P-%' )  and destid not in (select ID from BM_Destacking " +
                            //"where LokasiID in (select ID from FC_Lokasi where Lokasi like'%adj%')) " +
                            //"group by DestID,Tebal,Lebar,Panjang) as xx inner join BM_Destacking A1 ON A1.ID=xx.destid " +
                            //"left join BM_PlantGroup A2 ON A2.ID=A1.PlantGroupID " +
                            //"inner join BM_Plant A3 ON A3.ID=A1.PlantID ) as xx1 group by [group],PlantName ) as bb ) as xx2 " +
                            //"group by [group],PlantName ) as xx3   " +
                            ///** End Defect Produksi **/

                            //"select M3,[group],PlantName into tempDataDefectBM_m3 from ( " +
                            //"select cast(sum(M3) + (@DefectBagi)as decimal(10,2)) M3,[group],PlantName from ( " +
                            //"select M3,[group],PlantName from ( " +
                            //"select 0'M3',x.[group],x2.PlantName from (select distinct [group] from tempTotalSerah_lmbr2) as x " +
                            //"inner join BM_PlantGroup x1 ON x.[group]=x1.[Group] inner join BM_Plant x2 ON x2.ID=x1.PlantID ) as x3  " +
                            //"union all " +
                            //"select * from tempTm3 " +
                            //"union all " +
                            //"select M3,[group],PlantName from (select *,(select distinct M3 / count(destid) M3 from tempD2M3 " +
                            //"where RowStatus=1 group by M3)M3 from ( " +
                            //"select x1.[Group],x2.PlantName from (select PlantGroupID,PlantID from tempD2M3 where RowStatus=1 ) as x  " +
                            //"inner join BM_PlantGroup x1 ON x.PlantGroupID=x1.ID " +
                            //"inner join BM_Plant x2 ON x2.ID=x.PlantID ) as xx ) as xx2 " +
                            //") as x5 group by [group],PlantName ) as cc " +

                            /** Total Defect ListPlank OK BP **/
                            "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDefectOKBPNew]') AND type in (N'U')) DROP TABLE [dbo].tempDefectOKBPNew " +

                            "select sum(Qty)Qty,sum(M3)M3,PlantName,[Group] into tempDefectOKBPNew from (  " +

                            /** Pemasukan ke Bevel **/
                            "select sum(Qty)Qty,sum(M3)M3,PlantName,[Group]  from (select x.*,B.[Group],C.PlantName, " +
                            "((D.Tebal*D.Lebar*D.Panjang)/1000000000)*x.Qty M3   " +
                            "from (select sum(QtyIn)Qty,DestID,ItemID from T1_Straping " +
                            "where CONVERT(varchar,TglTrans,112)>=@thnbln1 and CONVERT(varchar,TglTrans,112)<=@thnbln2  " +
                            "and RowStatus>-1 and L1ID in (select ID from T1_Bevel where RowStatus >-1) group by DestID,ItemID ) as x  " +
                            "LEFT JOIN BM_Destacking A ON A.ID=x.DestID  " +
                            "LEFT JOIN BM_PlantGroup B ON B.ID=A.PlantGroupID  " +
                            "LEFT JOIN BM_Plant C ON C.ID=A.PlantID  " +
                            "LEFT JOIN FC_Items D ON D.ID=x.ItemID) as x2 group by [group],PlantName  " +
                            "union all  " +
                            /** BP Strapping dah OK **/
                            "select sum(Qty)*-1 Qty,sum(M3)*-1 M3,PlantName,[Group] from (select PlantName,[group],sum(qty)Qty,sum(M3)M3  " +
                            "from (select A6.PlantName,A5.[group],A4.Qty,((A7.Tebal*A7.Lebar*A7.Panjang)/1000000000)*A4.Qty M3  " +
                            "from (select A3.PlantID,A3.PlantGroupID,A2.Tanggal,A2.Qty,A2.ItemID  " +
                            "from (select (select A1.PartNo from FC_Items A1 where A1.ID=A.ItemID)Partno,A.DestID,A.TglTrans Tanggal,A.QtyIn Qty,B.ItemID  " +
                            "from T3_Rekap A INNER JOIN T1_Straping B ON A.DestID=B.DestID and A.T1SerahID=B.ID " +
                            "where CONVERT(varchar,A.TglTrans,112)>=@thnbln1 and CONVERT(varchar,A.TglTrans,112)<=@thnbln2   " +
                            "and A.sfrom='straping' and A.RowStatus>-1 and A.ItemID in (select ID from FC_Items where partno like'%-P-%') ) as A2 " +
                            "INNER JOIN BM_Destacking A3 ON A2.DestID=A3.ID ) as A4 " +
                            "INNER JOIN BM_PlantGroup A5 ON A4.PlantGroupID=A5.ID " +
                            "INNER JOIN BM_Plant A6 ON A6.ID=A4.PlantID INNER JOIN FC_Items A7 ON A7.ID=A4.ItemID ) as A8 group by PlantName,[Group] ) as A9  " +
                            "group by [group],PlantName  " +
                            "union all  " +
                            /** Defect ListPlank BP **/
                            "select sum(Qty)Qty,sum(M3)M3,PlantName,[Group] from tempdefectListP group by [group],PlantName  " +
                            ") as DataFinal group by [group],PlantName  " +
                            /** end Total Defect ListPlank OK BP **/

                            /** I. BP ListPlank **/
                            /** BP dari Bevel **/
                            //"select sum(Qty)Qty,ROUND(sum(M3),1)M3,PlantName,[Group] into tempDefectOKBPNew  from ( " +
                            //"select sum(Qty)Qty,sum(M3)M3,PlantName,[Group]  from ( select PlantName,[group],Qty,M3  " +
                            //"from (select PlantName,[Group],sum(Qty)Qty,sum(M3)M3 from (select Data3.PlantName,Data3.[Group],Data3.Qty,Data3.M3 " +
                            //"from (select C1.PlantName,B1.[Group],Data2.Qty,M3 from (select B.PlantID,B.PlantGroupID,Data1.*, " +
                            //"(((C.Tebal*C.Lebar*C.Panjang)/1000000000)*Data1.Qty) M3 from (select  tanggal,itemid,PartNo,Qty,DestID from vw_KartuStockListplankR1 " +
                            //"where itemid in (select ID from FC_Items where PartNo like'%-P-%')  and CONVERT(varchar,tanggal,112)>=@thnbln1 and CONVERT(varchar,tanggal,112)<=@thnbln2 " +
                            //"and qty>0 and process='i99' and ID in (select IDrec from vw_KartuStockListplank where process='Bevel' and qty<0 and Stat='BvToR1')) as Data1 " +
                            //"INNER JOIN BM_Destacking B ON Data1.DestID=B.ID " +
                            //"INNER JOIN FC_Items C ON C.ID=Data1.itemid ) as Data2 " +
                            //"INNER JOIN BM_PlantGroup B1 ON Data2.PlantGroupID=B1.ID " +
                            //"INNER JOIN BM_Plant C1 ON C1.ID=Data2.PlantID ) as Data3  ) as Data4 group by PlantName,[group] ) as Data5 " +
                            //"union all " +
                            ///** BP dari Strapping **/
                            //"select PlantName,[group],Qty,M3 from (select PlantName,[group],sum(qty)Qty,sum(M3)M3 " +
                            //"from (select A6.PlantName,A5.[group],A4.Qty,(((A7.Tebal*A7.Lebar*A7.Panjang)/1000000000)* A4.Qty) M3 " +
                            //"from (select A3.PlantID,A3.PlantGroupID,A2.Tanggal,A2.Qty,A2.ItemID " +
                            //"from (select (select A1.PartNo from FC_Items A1 where A1.ID=A.ItemID)Partno,A.DestID,A.TglTrans Tanggal,A.QtyIn Qty,A.ItemID " +
                            //"from T3_Rekap A INNER JOIN T1_Straping B ON A.DestID=B.DestID and A.T1SerahID=B.ID " +
                            //"where CONVERT(varchar,A.TglTrans,112)>=@thnbln1 and CONVERT(varchar,A.TglTrans,112)<=@thnbln2 " +
                            //"and A.sfrom='straping' and A.RowStatus>-1 and A.ItemID in (select ID from FC_Items where partno like'%-P-%') ) as A2 " +
                            //"INNER JOIN BM_Destacking A3 ON A2.DestID=A3.ID ) as A4 " +
                            //"INNER JOIN BM_PlantGroup A5 ON A4.PlantGroupID=A5.ID " +
                            //"INNER JOIN BM_Plant A6 ON A6.ID=A4.PlantID INNER JOIN FC_Items A7 ON A7.ID=A4.ItemID ) as A8 " +
                            //"group by PlantName,[Group] ) as A9 ) as Final  group by PlantName,[Group] " +
                            //"union all " +
                            ///** II. OK KW ListPlank ( Pemasukan dari Bevel ) **/
                            //"select sum(Qty)Qty,sum(M3)M3,PlantName,[Group] from (select x.*,B.[Group],C.PlantName,(((D.Tebal*D.Lebar*D.Panjang)/1000000000)*x.Qty) M3  " +
                            //"from (select sum(QtyIn)Qty,DestID,ItemID from T1_Straping " +
                            //"where CONVERT(varchar,TglTrans,112)>=@thnbln1 and CONVERT(varchar,TglTrans,112)<=@thnbln2 " +
                            //"and RowStatus>-1 and L1ID in (select ID from T1_Bevel where RowStatus >-1) group by DestID,ItemID ) as x " +
                            //"LEFT JOIN BM_Destacking A ON A.ID=x.DestID " +
                            //"LEFT JOIN BM_PlantGroup B ON B.ID=A.PlantGroupID " +
                            //"LEFT JOIN BM_Plant C ON C.ID=A.PlantID " +
                            //"LEFT JOIN FC_Items D ON D.ID=x.ItemID) as x2 group by [group],PlantName ) as DataFinal group by [group],PlantName " +

                            /** Total Serah Tahap I ke Tahap III **/
                            //"IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTotalSerahM3]') AND type in (N'U')) DROP TABLE [dbo].tempTotalSerahM3 " +
                            //"select M3,[group],PlantName into tempTotalSerahM3 from ( " +
                            //"select sum(M3)M3,[group],PlantName from ( " +
                            //"select M3,[group],PlantName from ( " +
                            //"select M3 +  " +
                            //"(select sum(M3)/@TotalGroup M3 from (" +
                            ///** Defect Ukuran Khusus OK KM **/
                            //"select round(isnull(sum(M3),0),1)M3 from ( " +
                            //"select (((A3.Tebal*A3.Lebar*A3.Panjang)/1000000000)*sum(A1.QtyIn))M3 " +
                            //"from T3_Simetris A1 inner join T3_Serah A2 ON A1.SerahID=A2.ID inner join FC_Items A3 ON A3.ID=A2.ItemID " +
                            //"where A1.ID in (select CutID from vw_KartuStockBJNew " +
                            //"where CONVERT(varchar,tanggal,112)>=@thnbln1 and CONVERT(varchar,tanggal,112)<=@thnbln2 " +
                            //"and ItemID IN (SELECT ID from FC_Items where partno like'%-3-%' or partno like'%-M-%') and Process like'%simetris%' " +
                            //"and Keterangan like'%-1-%' and CutID in (select ID from T3_Simetris where QtyIn<QtyOut and RowStatus>-1)) and A1.RowStatus>-1 " +
                            //"group by A3.Tebal,A3.Lebar,A3.Panjang ) as xx " +
                            ///** end Defect Ukuran Khusus OK KM **/
                            //"union all " +
                            ///** Defect Ukuran Khusus BP **/
                            //"select round(isnull(sum(M3),0),1)M3 from ( " +
                            //"select (((B3.Tebal*B3.Lebar*B3.Panjang)/1000000000)*sum(B1.QtyIn))M3 from T3_Simetris B1 " +
                            //"inner join T3_Serah B2 ON B1.SerahID=B2.ID inner join FC_Items B3 ON B3.ID=B2.ItemID " +
                            //"where B1.ID in (select CutID from vw_KartuStockBJNew " +
                            //"where CONVERT(varchar,tanggal,112)>=@thnbln1 and CONVERT(varchar,tanggal,112)<=@thnbln2 " +
                            //"and ItemID IN (SELECT ID from FC_Items where partno like'%-P-%') and Process like'%simetris%' and Keterangan like'%-1-%' " +
                            //"and CutID in (select ID from T3_Simetris where QtyIn<QtyOut and RowStatus>-1)) and B1.RowStatus>-1  " +
                            //"group by B3.Tebal,B3.Lebar,B3.Panjang ) as xxx " +
                            ///** end Defect Ukuran Khusus BP **/
                            //"union all " +
                            ///** Mutasi BJ T1**/
                            //"select round(sum(M3),2) M3 from " +
                            //"(select SerahID,(((A2.Tebal*A2.Lebar*A2.Panjang)/1000000000)*x.Qty)M3 from ( " +
                            //"select sum(A.qty) Qty,A.SerahID from vw_KartuStockBJNew A inner join FC_Items B ON A.ItemID=B.ID " +
                            //"where CONVERT(varchar,tanggal,112)>=@thnbln1 and CONVERT(varchar,tanggal,112)<=@thnbln2 " +
                            //"and ItemID IN (SELECT ID from FC_Items where PartNo like'%-3-%' or PartNo like'%-M-%' or PartNo like'%-W-%' or PartNo like'%-P-%') " +
                            //"and Process like'%simetris%' and Keterangan like'%-1-%' and " +
                            //"CutID in (select ID from T3_Simetris where QtyIn=QtyOut and RowStatus>-1) group by A.SerahID ) as x " +
                            //"inner join T3_Serah A1 ON A1.ID=x.SerahID inner join FC_Items A2 ON A2.ID=A1.ItemID ) as x " +
                            ///** end Mutasi BJ T1**/
                            //") as xx) M3,[group],PlantName " +
                            //"from (" +
                            //"select sum(M3)M3,[group],PlantName from ( " +
                            //"select round(sum(M3),2)M3,[group],PlantName from (select xx1.*,B.[Group],C.PlantName  " +
                            //"from (select xx.*,A.PlantGroupID,A.PlantID from ( " +
                            ///** Mutasi WiP **/
                            //"select destid,(((B.Tebal*B.Lebar*B.Panjang)/1000000000)*(A.qty * -1))M3 from vw_KartustockWIP A " +
                            //"inner join FC_Items B ON A.itemid0=B.ID " +
                            //"where CONVERT(varchar,tanggal,112)>=@thnbln1 and CONVERT(varchar,tanggal,112)<=@thnbln2 " +
                            //"and Lokasi in ('B99','H99') and qty<0  and destid in (select ID from BM_Destacking where LokasiID " +
                            //"not in (select ID from FC_Lokasi where Lokasi like'%adj%')) " +
                            //"union all " +
                            //"select DestID,(((B1.Tebal*B1.Lebar*B1.Panjang)/1000000000)*(A1.Qty * -1))M3 from vw_KartustockWIP2 A1 " +
                            //"inner join FC_Items B1 ON A1.itemid0=B1.ID " +
                            //"where CONVERT(varchar,tanggal,112)>=@thnbln1 and CONVERT(varchar,tanggal,112)<=@thnbln2 " +
                            //"and qty<0 AND ItemID IN (SELECT ID from FC_Items where partno like'%-3-%' or PartNo like'%-M-%' or PartNo like'%-P-%') " +
                            //"and destid in (select ID from BM_Destacking where LokasiID not in (select ID from FC_Lokasi where Lokasi like'%adj%')) " +
                            ///** end Mutasi WiP **/
                            //") as xx left join BM_Destacking A ON A.ID=xx.destid ) as xx1 " +
                            //"left join BM_PlantGroup B ON B.ID=xx1.PlantGroupID left join BM_Plant C ON C.ID=xx1.PlantID ) as AA  " +
                            //"group by [group],PlantName " +
                            //"union all " +
                            //"select M3,GroupP [group],PlantName from tempD3M3 ) as Datax group by [group],PlantName ) as x0  ) as x00 " +
                            //"union all " +
                            //"select M3,[group],PlantName from tempDefectOKBPNew ) as x01 group by [group],PlantName ) as D " +
                            /** end Tambahan Baruuuuuuuuu **/
                            "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTtlSerah_m3]') AND type in (N'U')) DROP TABLE [dbo].tempTtlSerah_m3 " +
                            "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTtlSerah_m32]') AND type in (N'U')) DROP TABLE [dbo].tempTtlSerah_m32 " +
                            "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTtlSerah_m33]') AND type in (N'U')) DROP TABLE [dbo].tempTtlSerah_m33 " +

                            //"declare @tgl1 varchar(8) "+
                            //"declare @tgl2 varchar(8) "+
                            "declare @BagiRata decimal(10,2) " +
                            "declare @TotalGroupAktif decimal(10,2) " +

                            "set @BagiRata= " +
                            //"(select cast(sum(M3)as decimal(10,2)) M3 from ( "+
                            ///** Defect Ukuran Khusus OK KM **/
                            //"select sum(Qty)Qty,sum(M3)M3 from ( "+
                            //"select sum(A1.QtyIn)Qty,sum(((A3.Tebal*A3.Lebar*A3.Panjang)/1000000000)* A1.QtyIn) M3 "+
                            //"from T3_Simetris A1 inner join T3_Serah A2 ON A1.SerahID=A2.ID "+
                            //"inner join FC_Items A3 ON A3.ID=A2.ItemID where A1.ID in (select CutID from vw_KartuStockBJNew "+
                            //"where CONVERT(varchar,tanggal,112)>=@thnbln1 and CONVERT(varchar,tanggal,112)<=@thnbln2 "+
                            //"and ItemID IN (SELECT ID from FC_Items where partno like'%-3-%' or partno like'%-M-%') and Process like'%simetris%' "+
                            //"and Keterangan like'%-1-%' and CutID in (select ID from T3_Simetris where QtyIn<QtyOut and RowStatus>-1)) and A1.RowStatus>-1 "+
                            //"group by A3.Tebal,A3.Lebar,A3.Panjang ) as xx "+
                            ///** end Defect Ukuran Khusus OK KM **/
                            //"union all  "+
                            ///** Defect Ukuran Khusus BP **/
                            //"select sum(Qty)Qty,sum(M3)M3 from ( "+
                            //"select sum(QtyIn)Qty,sum(((B3.Tebal*B3.Lebar*B3.Panjang)/1000000000)* B1.QtyIn) M3 from T3_Simetris B1 "+
                            //"inner join T3_Serah B2 ON B1.SerahID=B2.ID inner join FC_Items B3 ON B3.ID=B2.ItemID "+
                            //"where B1.ID in (select CutID from vw_KartuStockBJNew "+
                            //"where CONVERT(varchar,tanggal,112)>=@thnbln1 and CONVERT(varchar,tanggal,112)<=@thnbln2 "+
                            //"and ItemID IN (SELECT ID from FC_Items where partno like'%-P-%') and Process like'%simetris%' and Keterangan like'%-1-%' and "+
                            //"CutID in (select ID from T3_Simetris where QtyIn<QtyOut and RowStatus>-1)) and B1.RowStatus>-1  "+
                            //"group by B3.Tebal,B3.Lebar,B3.Panjang ) as xxx "+
                            ///** end Defect Ukuran Khusus BP **/
                            //"union all "+
                            ///** Mutasi BJ T1**/
                            //"select sum(Qty)Qty,sum(M3)M3 from ( "+
                            //"select sum(x2.Qty)Qty,sum(((x4.Tebal*x4.Lebar*x4.Panjang)/1000000000)*x2.Qty) M3 from ( "+
                            //"select sum(qty)Qty,C.SerahID from vw_KartuStockBJNew A inner join FC_Items B ON A.ItemID=B.ID "+
                            //"inner join T3_Simetris C ON C.ID=A.CutID "+
                            //"where CONVERT(varchar,tanggal,112)>=@thnbln1 and CONVERT(varchar,tanggal,112)<=@thnbln2 "+
                            //"and A.ItemID IN (SELECT ID from FC_Items where partno like'%-3-%' "+
                            //"or PartNo like'%-M-%' or PartNo like'%-P-%') and Process like'%simetris%' and Keterangan like'%-1-%' and "+
                            //"CutID in (select ID from T3_Simetris where QtyIn=QtyOut and RowStatus>-1) group by B.Tebal,B.Lebar,B.Panjang,C.SerahID ) as x2 "+
                            //"inner join T3_Serah x3 ON x3.ID=x2.SerahID inner join FC_Items x4 ON x4.ID=x3.ItemID ) as x "+
                            ///** end Mutasi BJ T1**/
                            //") as xx) "+

                            " /** @BagiRata **/ " +
                            "(select cast(sum(M3)as decimal(10,2)) M3 from ( " +
                            "select sum(Qty*Volume) M3 from ( select sum(A1.QtyIn)Qty,((A3.Tebal*A3.Lebar*A3.Panjang)/1000000000)Volume " +
                            "from T3_Simetris A1 inner join T3_Serah A2 ON A1.SerahID=A2.ID inner join FC_Items A3 ON A3.ID=A2.ItemID " +
                            "where A1.ID in (select CutID from vw_KartuStockBJNew where CONVERT(varchar,tanggal,112)>=@thnbln1 " +
                            "and CONVERT(varchar,tanggal,112)<=@thnbln2 and ItemID IN (SELECT ID from FC_Items where partno like'%-3-%' or partno like'%-M-%') " +
                            "and Process='simetris' and Keterangan like'%-1-%' and CutID in (select ID from T3_Simetris " +
                            "where QtyIn<QtyOut and RowStatus>-1)) and A1.RowStatus>-1 group by A3.Tebal,A3.Lebar,A3.Panjang ) as xx " +
                            "union all " +
                            "/** Tambahan ASimetris**/ " +
                            "select Qty*Volume M3 from ( " +
                            "select sum(Qty)*-1 Qty,((A.Tebal*A.Lebar*A.Panjang)/1000000000)Volume " +
                            "from ( select qty,ItemID from vw_KartuStockBJNew where PartNo like'%-1-%' and qty<0 and " +
                            "CONVERT(varchar,tanggal,112)>=@thnbln1 and CONVERT(varchar,tanggal,112)<=@thnbln2 and Process='ASimetris') as xx " +
                            "inner join FC_Items A ON A.ID=xx.ItemID group by A.Tebal,A.Lebar,A.Panjang ) as xx " +
                            "union all " +
                            "/** Defect System Simetris  **/ " +
                            "select sum(Qty*Volume)M3 from ( " +
                            "select sum(qty)Qty,((B.Tebal*B.Lebar*B.Panjang)/1000000000)Volume " +
                            "from vw_KartuStockBJNew A inner join FC_Items B ON A.ItemID=B.ID " +
                            "where CONVERT(varchar,tanggal,112)>=@thnbln1 and CONVERT(varchar,tanggal,112)<=@thnbln2 and ItemID IN " +
                            "(SELECT ID from FC_Items where partno like'%-3-%' or PartNo like'%-M-%' or PartNo like'%-P-%') and Process='simetris' " +
                            "and Keterangan like'%-1-%' and CutID in (select ID from T3_Simetris where QtyIn=QtyOut and RowStatus>-1) " +
                            "group by B.Tebal,B.Lebar,B.Panjang ) as AA " +
                            "union all " +
                            "select sum(Qty*Volume)M3 from ( select sum(QtyIn)Qty,((B3.Tebal*B3.Lebar*B3.Panjang)/1000000000)Volume " +
                            "from T3_Simetris B1 inner join T3_Serah B2 ON B1.SerahID=B2.ID inner join FC_Items B3 ON B3.ID=B2.ItemID " +
                            "where B1.ID in (select CutID from vw_KartuStockBJNew " +
                            "where CONVERT(varchar,tanggal,112)>=@thnbln1 and CONVERT(varchar,tanggal,112)<=@thnbln2 " +
                            "and ItemID IN (SELECT ID from FC_Items where partno like'%-P-%') and /**Process like'%simetris%'**/ Process='Simetris' and " +
                            "Keterangan like'%-1-%' and CutID in (select ID from T3_Simetris where QtyIn<QtyOut and RowStatus>-1)) and B1.RowStatus>-1  " +
                            "group by B3.Tebal,B3.Lebar,B3.Panjang ) as xxx ) as x4 )" +

                            "select M3,[group],PlantName into tempTtlSerah_m3 from ( " +
                            "select sum(M3)M3,[group],PlantName from ( " +
                            "select M3,[group],PlantName from ( " +
                            "select M3,[group],PlantName " +
                            "from ( " +
                            "select sum(M3)M3,[group],PlantName from ( " +
                            "select cast(sum(M3) as decimal(10,2)) M3,[group],PlantName " +
                            "from (select xx1.*,B.[Group],C.PlantName  from (select xx.*,A.PlantGroupID,A.PlantID from ( " +
                            /** Mutasi WiP **/
                            "select (((B.Tebal*B.Lebar*B.Panjang)/1000000000)*A.qty) *-1 M3,destid " +
                            "from vw_KartustockWIP A inner join FC_Items B ON A.itemid0=B.ID " +
                            "where CONVERT(varchar,tanggal,112)>=@thnbln1 and CONVERT(varchar,tanggal,112)<=@thnbln2 " +
                            "and Lokasi in ('B99','H99') and qty<0  and destid in (select ID from BM_Destacking " +
                            "where LokasiID not in (select ID from FC_Lokasi where Lokasi like'%adj%')) " +
                            "union all " +
                            "select (((B1.Tebal*B1.Lebar*B1.Panjang)/1000000000)*A1.qty) *-1 M3,DestID " +
                            "from vw_KartustockWIP2 A1 inner join FC_Items B1 ON A1.itemid0=B1.ID " +
                            "where CONVERT(varchar,tanggal,112)>=@thnbln1 and CONVERT(varchar,tanggal,112)<=@thnbln2 " +
                            "and qty<0 AND ItemID IN (SELECT ID from FC_Items where partno like'%-3-%' or PartNo like'%-M-%' or PartNo like'%-P-%') and " +
                            " destid in (select ID from BM_Destacking where LokasiID not in (select ID from FC_Lokasi where Lokasi like'%adj%')) " +
                            /** end Mutasi WiP **/

                            ") as xx left join BM_Destacking A ON A.ID=xx.destid ) as xx1 " +
                            "left join BM_PlantGroup B ON B.ID=xx1.PlantGroupID left join BM_Plant C ON C.ID=xx1.PlantID ) as AA  group by [group],PlantName " +
                            "union all " +
                            /** total adjust **/
                            "select cast(M3 as decimal(10,2))M3,GroupP [group],PlantName from tempD3M3 ) as Datax " +
                            "group by [group],PlantName ) as x0  ) as x00 ) as x01 group by [group],PlantName ) as D " +

                            "select * into tempTtlSerah_m32 from ( " +
                            "select 'A'Urut,cast(sum(M3) as decimal(10,3)) M3,[group],PlantName from tempTtlSerah_m3  group by [group],PlantName " +
                            "union all " +
                            "select 'B'Urut,cast(sum(M3) as decimal(10,3)) M3,[group],PlantName from tempDefectOKBPNew  group by [group],PlantName ) as xm  " +

                            "set @TotalGroupAktif = (select count(distinct [group])Total from tempTtlSerah_m32) " +

                            "select cast(M3+(@BagiRata/(select count(distinct [group])Total from tempTtlSerah_m32)) as decimal(10,2))M3,[group],PlantName " +
                            "into tempTtlSerah_m33 from (select sum(M3)M3,[group],PlantName from tempTtlSerah_m32  group by [group],PlantName ) as xx " +

                            /** Defect Produksi **/
                            /** temp Table tempDataDefectBM_m3 **/
                            "declare @DefectBagi decimal(18,2) " +
                            //"declare @tgl1 varchar(8) "+
                            //"declare @tgl2 varchar(8) "+

                            "set @DefectBagi=(select cast((sum(M3)/(select count(distinct [group]) from tempTtlSerah_m33)) as decimal(10,2)) M3 " +
                            "from (select isnull(sum((((B.Tebal*B.Lebar*B.Panjang)/1000000000) * xx.Qty )),0) M3 " +
                            "from (select sum(QtyIn) Qty,SerahID from T3_Simetris where ID in (select CutID from vw_KartuStockBJNew " +
                            "where CONVERT(varchar,tanggal,112)>=@thnbln1 and CONVERT(varchar,tanggal,112)<=@thnbln2 and ItemID " +
                            "IN (SELECT ID from FC_Items where partno like'%-P-%') and " +
                            " /**Process like'%simetris%'**/Process='Simetris' and Keterangan like'%-1-%' and CutID in (select ID from T3_Simetris where QtyIn<QtyOut and RowStatus>-1))  " +
                            "and RowStatus>-1 group by SerahID ) as xx inner join T3_Serah A ON A.ID=xx.SerahID inner join FC_Items B ON B.ID=A.ItemID  " +
                            "union all  " +
                            /** BP yg keluar dari Mesin Cutter dan ketika di potong menghasilkan 1 Produk **/
                            "select sum((((A2.Tebal*A2.Lebar*A2.Panjang)/1000000000) * xx.Qty )) M3  from (select sum(Qty)qty,SerahID from vw_KartuStockBJNew   " +
                            "where CONVERT(varchar,tanggal,112)>=@thnbln1 and CONVERT(varchar,tanggal,112)<=@thnbln2 and ItemID IN (SELECT ID from FC_Items " +
                            "where  PartNo like'%-P-%') and " +
                            " /**Process like'%simetris%'**/Process='Simetris' and Keterangan like'%-1-%' and CutID in (select ID from T3_Simetris " +
                            "where QtyIn=QtyOut and RowStatus>-1) " +
                            "group by SerahID ) as xx inner join T3_Serah A1 ON A1.ID=xx.SerahID inner join FC_Items A2 ON A2.ID=A1.ItemID ) as xx1) " +


                            "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTm3]') AND type in (N'U')) DROP TABLE [dbo].[tempTm3] " +
                            "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDataDefectBM_m3]') AND type in (N'U')) DROP TABLE [dbo].[tempDataDefectBM_m3] " +

                            "select cast(M3 as decimal(10,2)) M3,[group],PlantName into tempTm3 from (select cast(sum(M3) as decimal(10,2)) M3,[group],PlantName from ( " +
                            /** BP ListPlank ada informasi Group Produksi **/
                            "select M3,[group],PlantName from tempdefectListP  " +
                            "union all  " +
                            /** BP yg keluar dari proses Tahap I (Produk Pelarian - Produk Normal ) ada informasi Group Produksi **/
                            "select M3,[group],PlantName from (select sum(M3)M3,[group],PlantName from (select xx.*,A2.[Group],A3.PlantName from ( " +
                            "select sum((((B.Tebal*B.Lebar*B.Panjang)/1000000000)*A.qty))*-1 M3,destid from vw_KartustockWIP A inner join FC_Items B ON A.itemid0=B.ID " +
                            "where CONVERT(varchar,tanggal,112)>=@thnbln1 and CONVERT(varchar,tanggal,112)<=@thnbln2 " +
                            "and Lokasi='B99' and destid not in (select ID from BM_Destacking where LokasiID in (select ID from FC_Lokasi " +
                            "where Lokasi like'%adj%')) and qty<0  group by destid,Tebal,Lebar,Panjang " +
                            "union all  " +
                            "select sum((((B.Tebal*B.Lebar*B.Panjang)/1000000000)*A.qty))*-1 M3,destid from vw_KartustockWIP2 A " +
                            "inner join FC_Items B ON A.itemid0=B.ID  " +
                            "where CONVERT(varchar,tanggal,112)>=@thnbln1 and CONVERT(varchar,tanggal,112)<=@thnbln2 and qty<0 AND " +
                            "ItemID IN (SELECT ID from FC_Items where partno like'%-P-%' )  and destid not in (select ID from BM_Destacking " +
                            "where LokasiID in (select ID from FC_Lokasi where Lokasi like'%adj%')) " +
                            "group by DestID,Tebal,Lebar,Panjang) as xx inner join BM_Destacking A1 ON A1.ID=xx.destid " +
                            "left join BM_PlantGroup A2 ON A2.ID=A1.PlantGroupID " +
                            "inner join BM_Plant A3 ON A3.ID=A1.PlantID ) as xx1 group by [group],PlantName ) as bb ) as xx2 " +
                            "group by [group],PlantName ) as xx3   " +
                            /** End Defect Produksi **/

                            "select M3,[group],PlantName into tempDataDefectBM_m3 from ( " +
                            "select cast(sum(M3) + (@DefectBagi)as decimal(10,2)) M3,[group],PlantName from ( " +
                            "select M3,[group],PlantName from ( " +
                            "select 0'M3',x.[group],x2.PlantName from (select distinct [group] from tempTtlSerah_m33) as x " +
                            "inner join BM_PlantGroup x1 ON x.[group]=x1.[Group] inner join BM_Plant x2 ON x2.ID=x1.PlantID ) as x3  " +
                            "union all " +
                            "select * from tempTm3 " +
                            "union all " +
                            "select M3,[group],PlantName from (select *,(select distinct M3 / count(destid) M3 from tempD2M3 " +
                            "where RowStatus=1 group by M3)M3 from ( " +
                            "select x1.[Group],x2.PlantName from (select PlantGroupID,PlantID from tempD2M3 where RowStatus=1 ) as x  " +
                            "inner join BM_PlantGroup x1 ON x.PlantGroupID=x1.ID " +
                            "inner join BM_Plant x2 ON x2.ID=x.PlantID ) as xx ) as xx2 " +
                            ") as x5 group by [group],PlantName ) as cc " +


                            " " +
                             QueryTotalPotong +
                            " " +
                            "declare @DefectFin decimal(18,2) " +
                            "set @DefectFin= (select sum(kubik) from (  " +
                            "select case when D.DeptID=0 then  " +
                            "case when GJ.GroupJemurName In ('M','N','O','P','Q','R','S','T','U','V','W','X') then   " +
                            "case when D.DefName='retak' then 2   " +
                            "when D.DefName='gompal' then 3  " +
                            "else D.DeptID end   " +
                            "else    " +
                            "case when (B.Qty/E.Qty) *100 >5 then 2 else 3 end   " +
                            "end  " +
                            "else D.DeptID end deptID1,A.CreatedTime as tglInput,A.Tgl as TglPeriksa,E.TglProduksi as TglProd,  D.DefCode,BP.PlantName as Line, PG.[Group],BF.FormulaCode as Jenis,   " +
                            "D.DefName,D.DeptID,B.ID,B.DefectID,B.MasterID,B.Qty,A.ID  DestID,isnull(A.TPotong,0)  QtyIn,B.Qty*I.Volume as Kubik,isnull(A.TPotong,0) as TotPotong,'' sfrom  " +
                            "from Def_DefectDetail B inner join Def_Defect A on A.Id=B.DefectID   " +
                            "left join Def_MasterDefect D on B.MasterID=D.ID left join BM_Destacking E on E.ID=A.DestID   " +
                            "left join BM_PlantGroup PG on A.GroupProdID=PG.ID left join BM_Formula BF on BF.ID=E.FormulaID    " +
                            "left join BM_Plant BP on BP.ID=E.PlantID left join FC_Items I on I.ID=E.ItemID inner join Def_GroupJemur GJ on GJ.ID=A.GroupJemurID  " +
                            "where B.RowStatus>-1  and D.RowStatus >-1) as Def    " +
                            "where DeptID1<>2 and CONVERT(varchar,TglPeriksa,112)>=@thnbln1 and CONVERT(varchar,TglPeriksa,112)<=@thnbln2) " +
                            " " +

                            /** temp Table tempdefectFin **/
                            "select * into tempdefectFin from ( " +
                            "select 'OKKW' fin, sum(qtyin) lembar,sum(qtyin * kubik)kubik from ( " +
                            "select I1.PartNo partno1,I1.Panjang * I1.Lebar luas1,  S.qtyin,I2.PartNo partno2,I2.Panjang * I2.Lebar luas2,  S.qtyout ,(I1.Tebal * I1.Panjang * I1.Lebar)/1000000000 kubik " +
                            "from t3_simetris S inner join T3_Serah Se on S.SerahID =Se.ID inner join fc_items I1 on Se.ItemID=I1.ID inner join fc_items I2 on S.ItemID=I2.id  " +
                            "where I2.lebar>500 and S.RowStatus>-1 and CONVERT(varchar,S.tgltrans,112)>=@thnbln1 and CONVERT(varchar,S.tgltrans,112)<=@thnbln2 )a where partno1 like '%-1-%' and luas2/luas1 *100<60 and partno2 like '%-p-%' " +
                            "union all " +
                            "select 'BP' fin, sum(qtyin) lembar,sum(qtyin * kubik)kubik from ( " +
                            "select I1.PartNo partno1,I1.Panjang * I1.Lebar luas1,  S.qtyin,I2.PartNo partno2,I2.Panjang * I2.Lebar luas2,  S.qtyout ,(I1.Tebal * I1.Panjang * I1.Lebar)/1000000000 kubik " +
                            "from t3_simetris S inner join T3_Serah Se on S.SerahID =Se.ID inner join fc_items I1 on Se.ItemID=I1.ID inner join fc_items I2 on S.ItemID=I2.id  " +
                            "where S.RowStatus>-1 and CONVERT(varchar,S.tgltrans,112)>=@thnbln1 and CONVERT(varchar,S.tgltrans,112)<=@thnbln2  )a where partno1 like '%-1-%' and luas2/luas1 *100<60 and  " +
                            "(partno2 like '%-3-%' or partno2 like '%-w-%' or partno2 like '%-m-%') " +
                            "union all " +
                            "select 'BS' fin,sum(R.QtyIn) Lembar,sum(R.QtyIn *((I.tebal*I.panjang*I.lebar)/1000000000)) kubik from T3_Rekap R inner join FC_Items I on R.ItemID=I.id inner join fc_lokasi L on R.LokID =L.id where R.RowStatus>-1 and  " +
                            "CONVERT(varchar,R.tgltrans,112)>=@thnbln1 and CONVERT(varchar,R.tgltrans,112)<=@thnbln2 and I.PartNo like '%-s-%' and Process='direct' " +
                            perubahanlogikalisplank + ")A " +
                            /** end temp Table tempdefectFin **/
                            " " +

                            "declare @TotalPotong decimal(18,2) " +
                            "declare @TotalDefKhusus decimal(18,2) " +
                            "declare @DefKhusus decimal(18,2) " +
                            "declare @Ttotalkw1kw2 decimal(18,2) " +
                            "declare @NCSortir decimal(18,2) " +
                            "declare @Retur decimal(18,2) " +

                            //"set @TotalPotong=isnull((select sum(totkubik ) from tempdefectGPIsoTot),0) " +
                            "set @TotalPotong=isnull((select sum(m3) from tempTtlSerah_m33),0) " +

                            "declare @SelisihTotalPotong decimal(18,2) " +
                            "declare @TotalAccReport decimal(18,2) " +
                            "set @TotalAccReport=(select kubik from( " +
                            "    select  sum(lembar) lembar,sum(kubik)kubik from ( " +
                            "    select 'AccReport' fin, sum(qtyin) lembar,sum(qtyin * kubik)kubik from ( " +
                            "    select I1.PartNo partno1,I1.Panjang * I1.Lebar luas1,  S.qtyin,I2.PartNo partno2,I2.Panjang * I2.Lebar luas2,  S.qtyout ,(I1.Tebal * I1.Panjang * I1.Lebar)/1000000000 kubik " +
                            "    from t3_simetris S inner join T3_Serah Se on S.SerahID =Se.ID inner join fc_items I1 on Se.ItemID=I1.ID inner join fc_items I2 on S.ItemID=I2.id  " +
                            "    where S.RowStatus>-1 and CONVERT(varchar,S.tgltrans,112)>=@thnbln1 and CONVERT(varchar,S.tgltrans,112)<=@thnbln2 )a  " +
                            "    where partno1 like '%-1-%' and luas2/luas1 *100>90  and (partno2 like '%-p-%' or partno2 like '%-3-%' or partno2 like '%-M-%') " +
                            "    union all " +
                            "    select 'AccReport' fin, sum(qtyin) lembar,sum(qtyin * kubik)kubik from ( " +
                            "    select I1.PartNo partno1,I1.Panjang * I1.Lebar luas1,  S.qtyin,I2.PartNo partno2,I2.Panjang * I2.Lebar luas2,  S.qtyout ,(I1.Tebal * I1.Panjang * I1.Lebar)/1000000000 kubik " +
                            "    from t1_serah S  inner join fc_items I1 on S.ItemID0=I1.ID inner join fc_items I2 on S.ItemID=I2.id  " +
                            "    where S.Status>-1 and CONVERT(varchar,S.tglserah,112)>=@thnbln1 and CONVERT(varchar,S.tglserah,112)<=@thnbln2 )a  " +
                            "    where (partno2 like '%-p-%' or partno2 like '%-3-%' or partno2 like '%-M-%'))a)B) " +
                            "set @SelisihTotalPotong= @TotalAccReport-@TotalPotong " +
                            "if @TotalPotong >0  " +
                            "begin " +
                            "set @TotalDefKhusus=isnull((select sum(kubik) from tempdefectFin),0) " +
                            "set @DefKhusus=isnull((select sum(kubik) from tempdefectFin where fin<>'bp'),0) " +
                            "set @Ttotalkw1kw2 =isnull((select sum(qtyin *((I.tebal*I.Lebar*I.Panjang)/1000000000)) from T3_Rekap R inner join fc_items I on R.itemid=I.ID  " +
                            "where R.rowstatus>-1 and R.Process  like '%simetris%' and CONVERT(varchar,R.tgltrans,112)>=@thnbln1 and CONVERT(varchar,R.tgltrans,112)<=@thnbln2   " +
                            "and I.lebar=1200 and I.panjang=2400 and R.keterangan like '%-p-%' and (I.partno like '%-3-%' or I.partno like '%-W-%' or I.partno like '%-M-%' )),0) " +
                            "set @NCSortir=isnull((select /*sum(QtyAkhirSS)+sum(QtyAkhirSE)*/sum(M3AkhirSS)+sum(M3AkhirSE) from (  " +
                            "SELECT B.tgltrans as Tanggal, I1.PartNo as PartnoAwal, sum(B.QtyIn) as QtyAwal,sum(I1.Volume*B.QtyIn) M3Awal,   " +
                            "I2.PartNo AS PartnoAkhir, case when B.NCSS>0 then sum(B.QtyOut) else 0 end QtyAkhirSS,  " +
                            "case when B.NCSS>0 then sum(I2.Volume*B.QtyOut) else 0 end M3AkhirSS,case when B.NCSE>0 then sum(B.QtyOut) else 0 end QtyAkhirSE,  " +
                            "case when B.NCSE>0 then sum(I2.Volume*B.QtyOut) else 0 end M3AkhirSE,B.NCSS,B.NCSE  FROM T3_Serah AS A   " +
                            "INNER JOIN T3_Simetris AS B ON A.ID = B.SerahID INNER JOIN FC_Items AS I1 ON A.ItemID = I1.ID INNER JOIN   " +
                            "FC_Items AS I2 ON B.ItemID = I2.ID LEFT JOIN T3_GroupM AS D ON B.GroupID = D.ID   " +
                            "where (B.NCSS>0 or B.NCSE>0) and B.rowstatus>-1 and CONVERT(varchar,B.tgltrans,112)>=@thnbln1 and CONVERT(varchar,B.tgltrans,112)<=@thnbln2   " +
                            "group by B.tgltrans,I1.PartNo,I2.PartNo,B.NCSS,B.NCSE) S),0) " +
                            "set @Retur=isnull((select sum(qty) from ( " +
                            "select sum(qty *(I.tebal*I.panjang*I.lebar)/1000000000) qty from t3_retur R inner join fc_items I on R.itemid=I.id where R.rowstatus>-1 and  " +
                            "R.typer=1 and (I.partno like '%-p-%' or I.partno like '%-S-%')  and CONVERT(varchar,R.tgltrans,112)>=@thnbln1 and CONVERT(varchar,R.tgltrans,112)<=@thnbln2  " +
                            "union all " +
                            "select sum(qty *(I.tebal*I.panjang*I.lebar)/1000000000)*-1 qty from t3_retur R inner join fc_items I on R.itemid=I.id where R.rowstatus>-1 and  " +
                            "R.typer=2 and (I.partno like '%-p-%' or I.partno like '%-S-%')and CONVERT(varchar,R.tgltrans,112)>=@thnbln1 and CONVERT(varchar,R.tgltrans,112)<=@thnbln2 " +
                            "union all " +
                            "select sum(qty *(I.tebal*I.panjang*I.lebar)/1000000000) qty from t3_returO R inner join fc_items I on R.itemid=I.id where R.rowstatus>-1 and  " +
                            "(I.partno like '%-p-%' or I.partno like '%-S-%') and CONVERT(varchar,R.tgltrans,112)>=@thnbln1 and CONVERT(varchar,R.tgltrans,112)<=@thnbln2)A),0) " +
                            " " +
                            "declare @TotalPotongL1 decimal(18,2) " +
                            "declare @TotDefKhususL1 decimal(18,2) " +
                            "declare @DefKhususL1 decimal(18,2) " +
                            "declare @Ttotalkw1kw2L1 decimal(18,2) " +
                            "declare @NCSortirL1 decimal(18,2) " +
                            "declare @ReturL1 decimal(18,2) " +
                            "declare @DefectFinL1 decimal(18,2) " +

                            /** Area tempdefectL1 **/
                            //"set @TotalPotongL1=(select sum(totkubik ) from tempdefectGPIsoTot where [group]in (select [group] from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 1'))) " +

                            //"set @TotalPotongL1=(select isnull(sum(M3),0)M3 from ( " +
                            //"select isnull(sum(M3),0)M3 from tempTtlSerah_m33 where [group] in (select [group] from BM_PlantGroup " +
                            //"where PlantID in (select id from BM_Plant where PlantName='line 1')) " +
                            //"union all " +
                            //"select isnull(sum(M3),0)M3 from tempDataDefectBM_m3 where [group] in (select [group] from BM_PlantGroup " +
                            //"where PlantID in (select id from BM_Plant where PlantName='line 1'))) as x) " +

                            "set @TotalPotongL1=(select isnull(sum(M3),0)M3 from ( " +
                            "select isnull(sum(M3),0)M3 from tempTtlSerah_m33 where [group] in (select [group] from BM_PlantGroup " +
                            "where PlantID in (select id from BM_Plant where PlantName='line 1'))) as x) " +

                            "set @TotDefKhususL1=(@TotalPotongL1/@TotalPotong)*@TotalDefKhusus " +
                            "set @DefKhususL1=(@TotalPotongL1/@TotalPotong)*@DefKhusus " +
                            "set @Ttotalkw1kw2L1=(@TotalPotongL1/@TotalPotong)*@Ttotalkw1kw2 " +
                            "set @NCSortirL1=(@TotalPotongL1/@TotalPotong)*@NCSortir " +
                            "set @ReturL1=(@TotalPotongL1/@TotalPotong)*@Retur " +
                            "set @DefectFinL1=isnull((@TotalPotongL1/@TotalPotong)*@DefectFin,0) " +
                            "declare @SelisihTotalPotongL1 decimal(18,2) " +
                            "set @SelisihTotalPotongL1=(@TotalPotongL1/@TotalPotong)*@SelisihTotalPotong " +
                        #endregion

                        #region tempdefectL1
 "if @TotalPotongL1>0 " +
                            "begin " +
                            "select * into tempdefectL1 from ( " +
                            //"select [Group],b+h b,c,d,e,f,h,c-d+e+f i,((c-d+e+f)/(b+h))*100 j from ( " +
                            "select [Group],b+h b,c,d,e,f,h,c-d+e+f i,case when (b+h)=0 then 0 else ((c-d+e+f)/(b+h))*100 end j from ( " +
                            "select [Group],case when @TotalPotongL1>0 then " +
                            //"isnull((select isnull(cast(M3 as decimal(10,2)),0)M3 from tempTotalSerahDfctM3 where [group]=BM_PlantGroup.[Group]),0) else 0 end b,  " +
                            "isnull((select isnull(cast(M3 as decimal(10,2)),0)M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group]),0) else 0 end b,  " +
                            "case when @TotalPotongL1>0 then isnull((select M3 from tempDataDefectBM_m3 where [group]=BM_PlantGroup.[Group] ),0)  else 0 end c, " +
                            "case when @TotalPotongL1>0 then ((isnull((select M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@Ttotalkw1kw2L1) else 0 end  d, " +
                            "case when @TotalPotongL1>0 then ((isnull((select M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@NCSortirL1)  else 0 end  e, " +
                            "case when @TotalPotongL1>0 then ((isnull((select M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@ReturL1)  else 0 end  f, " +
                            "case when @TotalPotongL1>0 then ((isnull((select M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@DefectFinL1)  else 0 end g, " +
                            " " + query1 + " " +
                            //" case when @TotalPotongL1>0 then "+
                            //"isnull((select isnull(cast(M3 as decimal(10,2)),0)M3 from tempTotalSerahDfctM3 where [group]=BM_PlantGroup.[Group]),0) / "+
                            //"isnull((select isnull(cast(M3 as decimal(10,2)),0)M3 from tempTotalBPM3 where [group]=BM_PlantGroup.[Group]),0) else 0 end j "+
                            " from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 1') )A " +

                            "union all  " +

                            "select 'Total' [Group],sum(b)+sum(h) b,sum(c)c,sum(d)d,sum(e)e,sum(f)f,sum(h)h,sum(c)-sum(d)+sum(e)+sum(f) i " +
                            //"((sum(c)-sum(d)+sum(e)+sum(f))/(sum(b)+sum(h)))*100 j from ( " +
                            ",case when (sum(b)+sum(h))=0 then 0 else ((sum(c)-sum(d)+sum(e)+sum(f))/(sum(b)+sum(h)))*100 end j from ( " +
                            "select [Group],case when @TotalPotongL1>0 then " +
                            //"isnull((select isnull(cast(M3 as decimal(10,2)),0)M3 from tempTotalSerahDfctM3 where [group]=BM_PlantGroup.[Group]),0) else 0 end b,  " +
                            "isnull((select isnull(cast(M3 as decimal(10,2)),0)M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group]),0) else 0 end b,  " +
                            " case when @TotalPotongL1>0 then isnull((select M3 from tempDataDefectBM_m3 where [group]=BM_PlantGroup.[Group] ),0)  else 0 end c, " +
                            " case when @TotalPotongL1>0 then ((isnull((select M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@Ttotalkw1kw2L1) else 0 end  d, " +
                            " case when @TotalPotongL1>0 then ((isnull((select M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@NCSortirL1)  else 0 end  e, " +
                            " case when @TotalPotongL1>0 then ((isnull((select M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@ReturL1)  else 0 end  f, " +
                            " case when @TotalPotongL1>0 then ((isnull((select M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@DefectFinL1)  else 0 end g, " +
                            " " + query2 + " " +
                            " case when @TotalPotongL1>0 then " +
                            "isnull((select isnull(cast(M3 as decimal(10,2)),0)M3 from tempTotalSerahDfctM3 where [group]=BM_PlantGroup.[Group]),0) / " +
                            "isnull((select isnull(cast(M3 as decimal(10,2)),0)M3 from tempDataDefectBM_m3 where [group]=BM_PlantGroup.[Group]),0) else 0 end j,0 i " +
                            "from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 1'))A )B " +
                            " end " +
                            " else " +
                            " begin " +
                            " select '' [group],0 b,0 c,0 d,0 e,0 f,0 h,0 i, 0 j into tempdefectL1 " +
                            " end " +
                            " " +

                            "update SPD_Trans set actual=(select j from tempdefectL1 where [group]='total') where approval=0 and Tahun =" + ddTahun.SelectedValue + " and Bulan=" + ddlBulan.SelectedValue.ToString() + " and sarmutdeptid in ( " +
                            "select ID from SPD_Departemen where SarmutDepartemen='Line 1' and SarmutPID in (select ID from SPD_Perusahaan where SarMutPerusahaan ='Defect Board Mill')) " +
                            /** end Area tempdefectL1 **/
                        #endregion

                        #region tempdefectL2
                            /** Area tempdefectL2 **/
                            "declare @TotalPotongL2 decimal(18,2) " +
                            "declare @TotDefKhususL2 decimal(18,2) " +
                            "declare @DefKhususL2 decimal(18,2) " +
                            "declare @Ttotalkw1kw2L2 decimal(18,2) " +
                            "declare @NCSortirL2 decimal(18,2) " +
                            "declare @ReturL2 decimal(18,2) " +
                            "declare @DefectFinL2 decimal(18,2) " +

                            //"set @TotalPotongL2=(select sum(totkubik ) from tempdefectGPIsoTot where [group]in (select [group] from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 2'))) " +
                            //"set @TotalPotongL2=(select isnull(sum(M3),0)M3 from ( " +
                            //"select isnull(sum(M3),0)M3 from tempTtlSerah_m33 where [group] in (select [group] from BM_PlantGroup " +
                            //"where PlantID in (select id from BM_Plant where PlantName='line 2')) " +
                            //"union all " +
                            //"select isnull(sum(M3),0)M3 from tempDataDefectBM_m3 where [group] in (select [group] from BM_PlantGroup " +
                            //"where PlantID in (select id from BM_Plant where PlantName='line 2'))) as x) " +

                            "set @TotalPotongL2=(select isnull(sum(M3),0)M3 from ( " +
                            "select isnull(sum(M3),0)M3 from tempTtlSerah_m33 where [group] in (select [group] from BM_PlantGroup " +
                            "where PlantID in (select id from BM_Plant where PlantName='line 2'))) as x) " +

                            "set @TotDefKhususL2=(@TotalPotongL2/@TotalPotong)*@TotalDefKhusus " +
                            "set @DefKhususL2=(@TotalPotongL2/@TotalPotong)*@DefKhusus " +
                            "set @Ttotalkw1kw2L2=(@TotalPotongL2/@TotalPotong)*@Ttotalkw1kw2 " +
                            "set @NCSortirL2=(@TotalPotongL2/@TotalPotong)*@NCSortir " +
                            "set @ReturL2=(@TotalPotongL2/@TotalPotong)*@Retur " +
                            "set @DefectFinL2=isnull((@TotalPotongL2/@TotalPotong)*@DefectFin,0) " +
                            "declare @SelisihTotalPotongL2 decimal(18,2) " +
                            "set @SelisihTotalPotongL2=(@TotalPotongL2/@TotalPotong)*@SelisihTotalPotong " +

                            "if @TotalPotongL2>0 " +
                            "begin " +
                            "select * into tempdefectL2 from ( " +
                            //"select [Group],b+h b,c,d,e,f,h,c-d+e+f i,case when b>0 then ((c-d+e+f)/(b+h))*100  else 0  end j from ( " +
                            "select [Group],b+h b,c,d,e,f,h,c-d+e+f i,case when (b+h)=0 then 0 else ((c-d+e+f)/(b+h))*100 end j from ( " +
                            "select [Group],case when @TotalPotongL2>0 then " +
                            "isnull((select isnull(cast(M3 as decimal(10,2)),0)M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group]),0) else 0 end b,  " +
                            "case when @TotalPotongL2>0 then isnull((select M3 from tempDataDefectBM_m3 where [group]=BM_PlantGroup.[Group] ),0)  else 0 end c, " +
                            "case when @TotalPotongL2>0 then ((isnull((select M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL2)*@Ttotalkw1kw2L2) else 0 end  d, " +
                            "case when @TotalPotongL2>0 then ((isnull((select M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL2)*@NCSortirL2) else 0 end  e, " +
                            "case when @TotalPotongL2>0 then ((isnull((select M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL2)*@ReturL2)  else 0 end f, " +
                            "case when @TotalPotongL2>0 then ((isnull((select M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL2)*@DefectFinL2) else 0 end  g, " +
                            " " + query3 + " " +
                            "from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 2') )A " +
                            "union all  " +
                            "select 'Total' [Group],sum(b)+sum(h) b,sum(c)c,sum(d)d,sum(e)e,sum(f)f,sum(h)h,sum(c)-sum(d)+sum(e)+sum(f) i " +
                            //",((sum(c)-sum(d)+sum(e)+sum(f))/sum(b))*100 j from( " +
                            ",case when (sum(b)+sum(h))=0 then 0 else ((sum(c)-sum(d)+sum(e)+sum(f))/(sum(b)+sum(h)))*100 end j from ( " +
                            "select [Group],case when @TotalPotongL2>0 then " +
                            "isnull((select isnull(cast(M3 as decimal(10,2)),0)M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group]),0) else 0 end b,  " +
                            "case when @TotalPotongL2>0 then isnull((select M3 from tempDataDefectBM_m3 where [group]=BM_PlantGroup.[Group] ),0)  else 0 end c, " +
                            "case when @TotalPotongL2>0 then ((isnull((select M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL2)*@Ttotalkw1kw2L2) else 0 end  d, " +
                            "case when @TotalPotongL2>0 then ((isnull((select M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL2)*@NCSortirL2) else 0 end  e, " +
                            "case when @TotalPotongL2>0 then ((isnull((select M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL2)*@ReturL2)  else 0 end f, " +
                            "case when @TotalPotongL2>0 then ((isnull((select M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL2)*@DefectFinL2) else 0 end  g, " +
                            " " + query4 + " " +
                            " 0 i,0 j from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 2'))A )B " +
                            " end " +
                            " else " +
                            " begin " +
                            " select '' [group],0 b,0 c,0 d,0 e,0 f,0 h,0 i, 0 j into tempdefectL2 " +
                            " end " +
                            " " +
                            "update SPD_Trans set actual=(select j from tempdefectL2 where [group]='total') where approval=0 and Tahun =" + ddTahun.SelectedValue + " and Bulan=" + ddlBulan.SelectedValue.ToString() + " and sarmutdeptid in ( " +
                            "select ID from SPD_Departemen where SarmutDepartemen='Line 2' and SarmutPID in (select ID from SPD_Perusahaan where SarMutPerusahaan ='Defect Board Mill')) " +
                            /** end Area tempdefectL2 **/
                        #endregion

                        #region tempdefectL3
                            /** Area tempdefectL3 **/
                            "declare @TotalPotongL3 decimal(18,2) " +
                            "declare @TotDefKhususL3 decimal(18,2) " +
                            "declare @DefKhususL3 decimal(18,2) " +
                            "declare @Ttotalkw1kw2L3 decimal(18,2) " +
                            "declare @NCSortirL3 decimal(18,2) " +
                            "declare @ReturL3 decimal(18,2) " +
                            "declare @DefectFinL3 decimal(18,2) " +

                            //"set @TotalPotongL3=(select sum(totkubik ) from tempdefectGPIsoTot where [group]in (select [group] from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 3'))) " +
                            //"set @TotalPotongL3=(select isnull(sum(M3),0)M3 from ( " +
                            //"select isnull(sum(M3),0)M3 from tempTtlSerah_m33 where [group] in (select [group] from BM_PlantGroup " +
                            //"where PlantID in (select id from BM_Plant where PlantName='line 3')) " +
                            //"union all " +
                            //"select isnull(sum(M3),0)M3 from tempDataDefectBM_m3 where [group] in (select [group] from BM_PlantGroup " +
                            //"where PlantID in (select id from BM_Plant where PlantName='line 3'))) as x) " +

                            "set @TotalPotongL3=(select isnull(sum(M3),0)M3 from ( " +
                            "select isnull(sum(M3),0)M3 from tempTtlSerah_m33 where [group] in (select [group] from BM_PlantGroup " +
                            "where PlantID in (select id from BM_Plant where PlantName='line 3'))) as x) " +

                            "set @TotDefKhususL3=(@TotalPotongL3/@TotalPotong)*@TotalDefKhusus " +
                            "set @DefKhususL3=(@TotalPotongL3/@TotalPotong)*@DefKhusus " +
                            "set @Ttotalkw1kw2L3=(@TotalPotongL3/@TotalPotong)*@Ttotalkw1kw2 " +
                            "set @NCSortirL3=(@TotalPotongL3/@TotalPotong)*@NCSortir " +
                            "set @ReturL3=(@TotalPotongL3/@TotalPotong)*@Retur " +
                            "set @DefectFinL3=isnull((@TotalPotongL3/@TotalPotong)*@DefectFin,0) " +
                            "declare @SelisihTotalPotongL3 decimal(18,2) " +
                            "set @SelisihTotalPotongL3=(@TotalPotongL3/@TotalPotong)*@SelisihTotalPotong " +

                            "if @TotalPotongL3>0 " +
                            "begin " +
                            "select * into tempdefectL3 from ( " +
                            //"select [Group],b+h b,c,d,e,f,h,c-d+e+f i,case when b>0 then ((c-d+e+f)/(b+h))*100 else 0  end j from ( " +
                            "select [Group],b+h b,c,d,e,f,h,c-d+e+f i,case when (b+h)=0 then 0 else ((c-d+e+f)/(b+h))*100 end j from ( " +
                            "select [Group],case when @TotalPotongL3>0 then " +
                            "isnull((select isnull(cast(M3 as decimal(10,2)),0)M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group]),0) else 0 end b,  " +
                            "case when @TotalPotongL3>0 then isnull((select M3 from tempDataDefectBM_m3 where [group]=BM_PlantGroup.[Group] ),0)  else 0 end c, " +
                            "case when @TotalPotongL3>0 then ((isnull((select M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@Ttotalkw1kw2L3) else 0 end  d, " +
                            "case when @TotalPotongL3>0 then ((isnull((select M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@NCSortirL3) else 0 end  e, " +
                            "case when @TotalPotongL3>0 then ((isnull((select M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@ReturL3) else 0 end  f, " +
                            "case when @TotalPotongL3>0 then ((isnull((select M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@DefectFinL3) else 0 end  g, " +
                            " " + query5 + " " +
                            "from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 3') )A " +
                            "union all  " +
                            "select 'Total' [Group],sum(b)+sum(h) b,sum(c)c,sum(d)d,sum(e)e,sum(f)f,sum(h)h,sum(c)-sum(d)+sum(e)+sum(f) i " +
                            //",((sum(c)-sum(d)+sum(e)+sum(f))/sum(b))*100 j from( " +
                            ",case when (sum(b)+sum(h))=0 then 0 else ((sum(c)-sum(d)+sum(e)+sum(f))/(sum(b)+sum(h)))*100 end j from ( " +
                            "select [Group], " +
                            "isnull((select isnull(cast(M3 as decimal(10,2)),0)M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group]),0) b,  " +
                            "isnull((select M3 from tempDataDefectBM_m3 where [group]=BM_PlantGroup.[Group] ),0)c, " +
                            "((isnull((select M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@Ttotalkw1kw2L3) d, " +
                            "((isnull((select M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@NCSortirL3) e, " +
                            "((isnull((select M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@ReturL3) f, " +
                            "((isnull((select M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@DefectFinL3) g, " +
                            " " + query6 + " " +
                            " 0 i,0 j from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 3'))A )B " +
                            " end " +
                            " else " +
                            " begin " +
                            " select '' [group],0 b,0 c,0 d,0 e,0 f,0 h,0 i, 0 j into tempdefectL3 " +
                            " end " +
                            " " +

                            "update SPD_Trans set actual=(select j from tempdefectL3 where [group]='total') where approval=0 and Tahun =" + ddTahun.SelectedValue + " and Bulan=" + ddlBulan.SelectedValue.ToString() + " and sarmutdeptid in ( " +
                            "select ID from SPD_Departemen where SarmutDepartemen='Line 3' and SarmutPID in (select ID from SPD_Perusahaan where SarMutPerusahaan ='Defect Board Mill')) " +
                            //** end Area tempdefectL3 **/
                        #endregion

                        #region tempdefectL4
                            //** Area tempdefectL4 **/
                            "declare @TotalPotongL4 decimal(18,2) " +
                            "declare @TotDefKhususL4 decimal(18,2) " +
                            "declare @DefKhususL4 decimal(18,2) " +
                            "declare @Ttotalkw1kw2L4 decimal(18,2) " +
                            "declare @NCSortirL4 decimal(18,2) " +
                            "declare @ReturL4 decimal(18,2) " +
                            "declare @DefectFinL4 decimal(18,2) " +
                            //"set @TotalPotongL4=(select sum(totkubik ) from tempdefectGPIsoTot where [group]in (select [group] from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 4'))) " +
                            //"set @TotalPotongL4=(select isnull(sum(M3),0)M3 from ( " +
                            //"select isnull(sum(M3),0)M3 from tempTtlSerah_m33 where [group] in (select [group] from BM_PlantGroup " +
                            //"where PlantID in (select id from BM_Plant where PlantName='line 4')) " +
                            //"union all " +
                            //"select isnull(sum(M3),0)M3 from tempDataDefectBM_m3 where [group] in (select [group] from BM_PlantGroup " +
                            //"where PlantID in (select id from BM_Plant where PlantName='line 4'))) as x) " +

                            "set @TotalPotongL4=(select isnull(sum(M3),0)M3 from ( " +
                            "select isnull(sum(M3),0)M3 from tempTtlSerah_m33 where [group] in (select [group] from BM_PlantGroup " +
                            "where PlantID in (select id from BM_Plant where PlantName='line 4'))) as x) " +

                            "set @TotDefKhususL4=(@TotalPotongL4/@TotalPotong)*@TotalDefKhusus " +
                            "set @DefKhususL4=(@TotalPotongL4/@TotalPotong)*@DefKhusus " +
                            "set @Ttotalkw1kw2L4=(@TotalPotongL4/@TotalPotong)*@Ttotalkw1kw2 " +
                            "set @NCSortirL4=(@TotalPotongL4/@TotalPotong)*@NCSortir " +
                            "set @ReturL4=(@TotalPotongL4/@TotalPotong)*@Retur " +
                            "set @DefectFinL4=isnull((@TotalPotongL4/@TotalPotong)*@DefectFin,0) " +
                            "declare @SelisihTotalPotongL4 decimal(18,2) " +
                            "set @SelisihTotalPotongL4=(@TotalPotongL4/@TotalPotong)*@SelisihTotalPotong " +


                            "if @TotalPotongL4>0 " +
                            "begin " +
                            "select * into tempdefectL4 from ( " +
                            //"select [Group],b+h b,c,d,e,f,h,c-d+e+f i,case when b>0 then ((c-d+e+f)/(b+h))*100 else 0  end j from ( " +
                            "select [Group],b+h b,c,d,e,f,h,c-d+e+f i,case when (b+h)=0 then 0 else ((c-d+e+f)/(b+h))*100 end j from ( " +
                            "select [Group],case when @TotalPotongL4>0 then " +
                            "isnull((select isnull(cast(M3 as decimal(10,2)),0)M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group]),0) else 0 end b,  " +
                            " case when @TotalPotongL4>0 then isnull((select M3 from tempDataDefectBM_m3 where [group]=BM_PlantGroup.[Group] ),0)  else 0 end c, " +
                            " case when @TotalPotongL4>0 then ((isnull((select M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@Ttotalkw1kw2L4) else 0 end  d, " +
                            " case when @TotalPotongL4>0 then ((isnull((select M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@NCSortirL4) else 0 end  e, " +
                            " case when @TotalPotongL4>0 then ((isnull((select M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@ReturL4) else 0 end  f, " +
                            " case when @TotalPotongL4>0 then ((isnull((select M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@DefectFinL4) else 0 end  g, " +
                            " " + query7 + " " +
                            "from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 4') )A " +
                            "union all  " +
                            "select 'Total' [Group],sum(b)+sum(h) b,sum(c)c,sum(d)d,sum(e)e,sum(f)f,sum(h)h,sum(c)-sum(d)+sum(e)+sum(f) i " +
                            //",((sum(c)-sum(d)+sum(e)+sum(f))/sum(b))*100 j from( " +
                            ",case when (sum(b)+sum(h))=0 then 0 else ((sum(c)-sum(d)+sum(e)+sum(f))/(sum(b)+sum(h)))*100 end j from ( " +
                            "select [Group], " +
                            "isnull((select isnull(cast(M3 as decimal(10,2)),0)M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group]),0) b,  " +
                            " isnull((select M3 from tempDataDefectBM_m3 where [group]=BM_PlantGroup.[Group] ),0)c, " +
                            " ((isnull((select M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@Ttotalkw1kw2L4) d, " +
                            " ((isnull((select M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@NCSortirL4) e, " +
                            " ((isnull((select M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@ReturL4) f, " +
                            " ((isnull((select M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@DefectFinL4) g, " +
                            " " + query8 + " " +
                            " 0 i,0 j from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 4'))A )B " +
                            " end " +
                            " else " +
                            " begin " +
                            " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 h,0 i, 0 j into tempdefectL4 " +
                            " end " +
                            " " +

                            "update SPD_Trans set actual=(select j from tempdefectL4 where [group]='total') where approval=0 and Tahun =" + ddTahun.SelectedValue + " and Bulan=" + ddlBulan.SelectedValue.ToString() + " and sarmutdeptid in ( " +
                            "select ID from SPD_Departemen where SarmutDepartemen='Line 4' and SarmutPID in (select ID from SPD_Perusahaan where SarMutPerusahaan ='Defect Board Mill')) " +
                            //** end Area tempdefectL4 **/
                        #endregion

                        #region tempdefectL5
                            //** Area tempdefectL5 **/
                            "declare @TotalPotongL5 decimal(18,2) " +
                            "declare @TotDefKhususL5 decimal(18,2) " +
                            "declare @DefKhususL5 decimal(18,2) " +
                            "declare @Ttotalkw1kw2L5 decimal(18,2) " +
                            "declare @NCSortirL5 decimal(18,2) " +
                            "declare @ReturL5 decimal(18,2) " +
                            "declare @DefectFinL5 decimal(18,2) " +

                            //"set @TotalPotongL5=(select sum(totkubik ) from tempdefectGPIsoTot where [group]in (select [group] from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 5'))) " +
                            //"set @TotalPotongL5=(select isnull(sum(M3),0)M3 from ( " +
                            //"select isnull(sum(M3),0)M3 from tempTtlSerah_m33 where [group] in (select [group] from BM_PlantGroup " +
                            //"where PlantID in (select id from BM_Plant where PlantName='line 5')) " +
                            //"union all " +
                            //"select isnull(sum(M3),0)M3 from tempDataDefectBM_m3 where [group] in (select [group] from BM_PlantGroup " +
                            //"where PlantID in (select id from BM_Plant where PlantName='line 5'))) as x) " +

                            "set @TotalPotongL5=(select isnull(sum(M3),0)M3 from ( " +
                            "select isnull(sum(M3),0)M3 from tempTtlSerah_m33 where [group] in (select [group] from BM_PlantGroup " +
                            "where PlantID in (select id from BM_Plant where PlantName='line 5'))) as x) " +

                            "set @TotDefKhususL5=(@TotalPotongL5/@TotalPotong)*@TotalDefKhusus " +
                            "set @DefKhususL5=(@TotalPotongL5/@TotalPotong)*@DefKhusus " +
                            "set @Ttotalkw1kw2L5=(@TotalPotongL5/@TotalPotong)*@Ttotalkw1kw2 " +
                            "set @NCSortirL5=(@TotalPotongL5/@TotalPotong)*@NCSortir " +
                            "set @ReturL5=(@TotalPotongL5/@TotalPotong)*@Retur " +
                            "set @DefectFinL5=isnull((@TotalPotongL5/@TotalPotong)*@DefectFin,0) " +
                            "declare @SelisihTotalPotongL5 decimal(18,2) " +
                            "set @SelisihTotalPotongL5=(@TotalPotongL5/@TotalPotong)*@SelisihTotalPotong " +

                            "if @TotalPotongL5>0 " +
                            "begin " +
                            "select * into tempdefectL5 from ( " +
                            //"select [Group],b+h b,c,d,e,f,h,c-d+e+f i,case when b>0 then ((c-d+e+f)/b)*100 else 0  end j from ( " +
                            "select [Group],b+h b,c,d,e,f,h,c-d+e+f i,case when (b+h)=0 then 0 else ((c-d+e+f)/(b+h))*100 end j from ( " +
                            "select [Group],case when @TotalPotongL5>0 then " +
                            "isnull((select isnull(cast(M3 as decimal(10,2)),0)M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group]),0) else 0 end b,  " +
                            "case when @TotalPotongL5>0 then isnull((select M3 from tempDataDefectBM_m3 where [group]=BM_PlantGroup.[Group] ),0)  else 0 end c, " +
                            "case when @TotalPotongL5>0 then ((isnull((select M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@Ttotalkw1kw2L5) else 0 end  d, " +
                            "case when @TotalPotongL5>0 then ((isnull((select M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@NCSortirL5) else 0 end  e, " +
                            "case when @TotalPotongL5>0 then ((isnull((select M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@ReturL5) else 0 end  f, " +
                            "case when @TotalPotongL5>0 then ((isnull((select M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@DefectFinL5) else 0 end  g, " +
                            " " + query9 + " " +
                            "from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 5') )A " +
                            "union all  " +
                            "select 'Total' [Group],sum(b)+sum(h) b,sum(c)c,sum(d)d,sum(e)e,sum(f)f,sum(h)h,sum(c)-sum(d)+sum(e)+sum(f) i " +
                            //",((sum(c)-sum(d)+sum(e)+sum(f))/sum(b))*100 j from( " +
                            ",case when (sum(b)+sum(h))=0 then 0 else ((sum(c)-sum(d)+sum(e)+sum(f))/(sum(b)+sum(h)))*100 end j from ( " +
                            "select [Group], " +
                            "isnull((select isnull(cast(M3 as decimal(10,2)),0)M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group]),0) b,  " +
                            " isnull((select M3 from tempDataDefectBM_m3 where [group]=BM_PlantGroup.[Group] ),0) c, " +
                            " ((isnull((select M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@Ttotalkw1kw2L5) d, " +
                            " ((isnull((select M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@NCSortirL5) e, " +
                            " ((isnull((select M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@ReturL5) f, " +
                            " ((isnull((select M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@DefectFinL5) g, " +
                            " " + query10 + " " +
                            " 0 i,0 j from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 5'))A )B " +
                            " end " +
                            " else " +
                            " begin " +
                            " select '' [group],0 b,0 c,0 d,0 e,0 f,0 h,0 i, 0 j into tempdefectL5 " +
                            " end " +
                            " " +

                            "update SPD_Trans set actual=(select j from tempdefectL5 where [group]='total') where approval=0 and Tahun =" + ddTahun.SelectedValue + " and Bulan=" + ddlBulan.SelectedValue.ToString() + " and sarmutdeptid in ( " +
                            "select ID from SPD_Departemen where SarmutDepartemen='Line 5' and SarmutPID in (select ID from SPD_Perusahaan where SarMutPerusahaan ='Defect Board Mill')) " +
                            //** Area tempdefectL5 **/
                        #endregion

                        #region tempdefectL6
                            //** Area tempdefectL6 **/
                            "declare @TotalPotongL6 decimal(18,2) " +
                            "declare @TotDefKhususL6 decimal(18,2) " +
                            "declare @DefKhususL6 decimal(18,2) " +
                            "declare @Ttotalkw1kw2L6 decimal(18,2) " +
                            "declare @NCSortirL6 decimal(18,2) " +
                            "declare @ReturL6 decimal(18,2) " +
                            "declare @DefectFinL6 decimal(18,2) " +

                            //"set @TotalPotongL6=(select sum(totkubik ) from tempdefectGPIsoTot where [group]in (select [group] from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 6'))) " +
                            //"set @TotalPotongL6=(select isnull(sum(M3),0)M3 from ( " +
                            //"select isnull(sum(M3),0)M3 from tempTtlSerah_m33 where [group] in (select [group] from BM_PlantGroup " +
                            //"where PlantID in (select id from BM_Plant where PlantName='line 6')) " +
                            //"union all " +
                            //"select isnull(sum(M3),0)M3 from tempDataDefectBM_m3 where [group] in (select [group] from BM_PlantGroup " +
                            //"where PlantID in (select id from BM_Plant where PlantName='line 6'))) as x) " +

                            "set @TotalPotongL6=(select isnull(sum(M3),0)M3 from ( " +
                            "select isnull(sum(M3),0)M3 from tempTtlSerah_m33 where [group] in (select [group] from BM_PlantGroup " +
                            "where PlantID in (select id from BM_Plant where PlantName='line 6'))) as x) " +

                            "set @TotDefKhususL6=(@TotalPotongL6/@TotalPotong)*@TotalDefKhusus " +
                            "set @DefKhususL6=(@TotalPotongL6/@TotalPotong)*@DefKhusus " +
                            "set @Ttotalkw1kw2L6=(@TotalPotongL6/@TotalPotong)*@Ttotalkw1kw2 " +
                            "set @NCSortirL6=(@TotalPotongL6/@TotalPotong)*@NCSortir " +
                            "set @ReturL6=(@TotalPotongL6/@TotalPotong)*@Retur " +
                            "set @DefectFinL6=isnull((@TotalPotongL6/@TotalPotong)*@DefectFin,0) " +
                            "declare @SelisihTotalPotongL6 decimal(18,2) " +
                            "set @SelisihTotalPotongL6=(@TotalPotongL6/@TotalPotong)*@SelisihTotalPotong " +

                            "if @TotalPotongL6>0 " +
                            "begin " +
                            "select * into tempdefectL6 from ( " +
                            "select [Group],b+h b,c,d,e,f,h,c-d+e+f i " +
                            ",case when (b+h)=0 then 0 else ((c-d+e+f)/(b+h))*100 end j from ( " +
                            "select [Group],case when @TotalPotongL6>0 then " +
                            "isnull((select isnull(cast(M3 as decimal(10,2)),0)M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group]),0) else 0 end b,  " +
                            " case when @TotalPotongL6>0 then isnull((select M3 from tempDataDefectBM_m3 where [group]=BM_PlantGroup.[Group] ),0)  else 0 end c, " +
                            " case when @TotalPotongL6>0 then ((isnull((select M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@Ttotalkw1kw2L6)  else 0 end d, " +
                            " case when @TotalPotongL6>0 then ((isnull((select M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@NCSortirL6)  else 0 end e, " +
                            " case when @TotalPotongL6>0 then ((isnull((select M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@ReturL6)  else 0 end f, " +
                            " case when @TotalPotongL6>0 then ((isnull((select M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@DefectFinL6)  else 0 end g, " +
                            " " + query11 + " " +
                            "  from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 6') )A " +
                            "union all  " +
                            "select 'Total' [Group],sum(b)+sum(h) b,sum(c)c,sum(d)d,sum(e)e,sum(f)f,sum(h)h,sum(c)-sum(d)+sum(e)+sum(f) i " +
                            //",((sum(c)-sum(d)+sum(e)+sum(f))/sum(b))*100 j from( " +
                            ",case when (sum(b)+sum(h))=0 then 0 else ((sum(c)-sum(d)+sum(e)+sum(f))/(sum(b)+sum(h)))*100 end j from ( " +
                            "select [Group], " +
                            "isnull((select isnull(cast(M3 as decimal(10,2)),0)M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group]),0) b,  " +
                            "isnull((select M3 from tempDataDefectBM_m3 where [group]=BM_PlantGroup.[Group] ),0) c, " +
                            "((isnull((select M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@Ttotalkw1kw2L6) d, " +
                            "((isnull((select M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@NCSortirL6) e, " +
                            "((isnull((select M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@ReturL6) f, " +
                            "((isnull((select M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@DefectFinL6) g, " +
                            " " + query12 + " " +
                            " 0 i,0 j from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 6'))A )B " +
                            " end " +
                            " else " +
                            " begin " +
                            " select '' [group],0 b,0 c,0 d,0 e,0 f,0 h,0 i, 0 j into tempdefectL6 " +
                            " end " +
                            " " +
                            " end " +
                            " else " +
                            " begin " +
                            " select '' [group],0 b,0 c,0 d,0 e,0 f,0 h,0 i, 0 j into tempdefectL1 " +
                            " select '' [group],0 b,0 c,0 d,0 e,0 f,0 h,0 i, 0 j into tempdefectL2 " +
                            " select '' [group],0 b,0 c,0 d,0 e,0 f,0 h,0 i, 0 j into tempdefectL3 " +
                            " select '' [group],0 b,0 c,0 d,0 e,0 f,0 h,0 i, 0 j into tempdefectL4 " +
                            " select '' [group],0 b,0 c,0 d,0 e,0 f,0 h,0 i, 0 j into tempdefectL5 " +
                            " select '' [group],0 b,0 c,0 d,0 e,0 f,0 h,0 i, 0 j into tempdefectL6 " +
                            " end " +
                            " select * from tempdefectL1 order by [group] " +

                            "update SPD_Trans set actual=(select j from tempdefectL6 where [group]='total') where approval=0 and Tahun =" + ddTahun.SelectedValue + " and Bulan=" + ddlBulan.SelectedValue.ToString() + " and sarmutdeptid in ( " +
                            "select ID from SPD_Departemen where SarmutDepartemen='Line 6' and SarmutPID in (select ID from SPD_Perusahaan where SarMutPerusahaan ='Defect Board Mill')) ";
                        //** end Area tempdefectL6 **/
                        #endregion
                    }
                    #endregion
                    #region Periode TerBaru added 30 Oktober 2020
                    else if (Convert.ToInt32(strtgl1.Substring(0, 6)) > 202008 && Convert.ToInt32(strtgl1.Substring(0, 6)) < 202103 && users.UnitKerjaID.ToString() != "13")
                    {
                        string Query1 = string.Empty; string Query2 = string.Empty; string Query3 = string.Empty;
                        if (users.UnitKerjaID == 1)
                        {
                            Query1 =
                             " when Line=1 then 'CA,CB,CC,CD' " +
                             " when Line=2 then 'CE,CF,CG,CH' " +
                             " when Line=3 then 'CI,CJ,CK,CL' " +
                             " when Line=4 then 'CM,CN,CO,CP' ";

                            Query2 =
                            " union all  " +
                            " select 'CA,CB,CC,CD'[Group],'1'Line,'0'M3,'0'Qty  " +
                            " union all  " +
                            " select 'CE,CF,CG,CH'[Group],'2'Line,'0'M3,'0'Qty  " +
                            " union all " +
                            " select 'CI,CJ,CK,CL'[Group],'3'Line,'0'M3,'0'Qty  " +
                            " union all  " +
                            " select 'CM,CN,CO,CP'[Group],'4'Line,'0'M3,'0'Qty  ";

                            Query3 =
                            " union all  " +
                            " select 'CA,CB,CC,CD'[Group],'1'Line,'0'M3 " +
                            " union all  " +
                            " select 'CE,CF,CG,CH'[Group],'2'Line,'0'M3 " +
                            " union all " +
                            " select 'CI,CJ,CK,CL'[Group],'3'Line,'0'M3 " +
                            " union all  " +
                            " select 'CM,CN,CO,CP'[Group],'4'Line,'0'M3 ";

                        }
                        else if (users.UnitKerjaID == 7)
                        {
                            Query1 =
                            " when Line=1 then 'KA,KB,KC,KD' " +
                            " when Line=2 then 'KE,KF,KG,KH' " +
                            " when Line=3 then 'KI,KJ,KK,KL' " +
                            " when Line=4 then 'KM,KN,KO,KP' " +
                            " when Line=5 then 'KQ,KR,KS,KT' " +
                            " when Line=6 then 'KU,KV,KW,KX' ";

                            Query2 =
                            " union all  " +
                            " select 'KA,KB,KC,KD'[Group],'1'Line,'0'M3,'0'Qty  " +
                            " union all  " +
                            " select 'KE,KF,KG,KH'[Group],'2'Line,'0'M3,'0'Qty  " +
                            " union all " +
                            " select 'KI,KJ,KK,KL'[Group],'3'Line,'0'M3,'0'Qty  " +
                            " union all  " +
                            " select 'KM,KN,KO,KP'[Group],'4'Line,'0'M3,'0'Qty  " +
                            " union all  " +
                            " select 'KQ,KR,KS,KT'[Group],'5'Line,'0'M3,'0'Qty  " +
                            " union all  " +
                            " select 'KQ,KR,KS,KT'[Group],'6'Line,'0'M3,'0'Qty ";

                            Query3 =
                            " union all  " +
                            " select 'KA,KB,KC,KD'[Group],'1'Line,'0'M3  " +
                            " union all  " +
                            " select 'KE,KF,KG,KH'[Group],'2'Line,'0'M3  " +
                            " union all " +
                            " select 'KI,KJ,KK,KL'[Group],'3'Line,'0'M3  " +
                            " union all  " +
                            " select 'KM,KN,KO,KP'[Group],'4'Line,'0'M3  " +
                            " union all  " +
                            " select 'KQ,KR,KS,KT'[Group],'5'Line,'0'M3  " +
                            " union all  " +
                            " select 'KQ,KR,KS,KT'[Group],'6'Line,'0'M3 ";
                        }
                        else
                        {
                            Query1 =
                             " when Line=1 then 'JA,JB,JC,JD' " +
                             " when Line=2 then 'JE,JF,JG,JH' " +
                             " when Line=3 then 'JI,JJ,JK,JL' " +
                             " when Line=4 then 'JM,JN,JO,JP' ";

                            Query2 =
                            " union all  " +
                            " select 'JA,JB,JC,JD'[Group],'1'Line,'0'M3,'0'Qty  " +
                            " union all  " +
                            " select 'JE,JF,JG,JH'[Group],'2'Line,'0'M3,'0'Qty  " +
                            " union all " +
                            " select 'JI,JJ,JK,JL'[Group],'3'Line,'0'M3,'0'Qty  " +
                            " union all  " +
                            " select 'JM,JN,JO,JP'[Group],'4'Line,'0'M3,'0'Qty  ";

                            Query3 =
                            " union all  " +
                            " select 'JA,JB,JC,JD'[Group],'1'Line,'0'M3  " +
                            " union all  " +
                            " select 'JE,JF,JG,JH'[Group],'2'Line,'0'M3  " +
                            " union all " +
                            " select 'JI,JJ,JK,JL'[Group],'3'Line,'0'M3  " +
                            " union all  " +
                            " select 'JM,JN,JO,JP'[Group],'4'Line,'0'M3  ";
                        }

                        string New1 = string.Empty; string New2 = string.Empty; string New3 = string.Empty; string New4 = string.Empty;
                        string New5 = string.Empty; string New6 = string.Empty; string New7 = string.Empty; string New8 = string.Empty;
                        string New9 = string.Empty; string New10 = string.Empty; string New11 = string.Empty; string New12 = string.Empty;
                        string Old1 = string.Empty; string Old2 = string.Empty; string Old3 = string.Empty; string Old4 = string.Empty;
                        string Old5 = string.Empty; string Old6 = string.Empty; string Old7 = string.Empty; string Old8 = string.Empty;
                        string Old9 = string.Empty; string Old10 = string.Empty; string Old11 = string.Empty; string Old12 = string.Empty;

                        if (Convert.ToInt32(strtgl1.Substring(0, 6)) > 202102 && users.UnitKerjaID == 1)
                        {
                            Old1 = ""; Old2 = ""; Old3 = ""; Old4 = ""; Old5 = ""; Old6 = ""; Old7 = ""; Old8 = ""; Old9 = ""; Old10 = ""; Old11 = "";

                            New1 =
                            " select *,(select top 1 B.ThnBln from Bm04 B where B.Part=A.Part order by B.ThnBln desc)Flag into Link0  " +
                            " from tes1 A " +

                            " select PartNo,M3,Qty,Line  into tes2  from ( " +
                            " select A.PartNo,Persen*M3/100 M3,A.Qty,PlantID Line  from Link0 A " +
                            " left join Bm04 B ON substring(A.PartNo,1,9)=B.Part  and A.Flag=B.ThnBln " +
                            " ) as x group by PartNo,M3,Qty,Line ";

                            New2 =
                            " select *,(select top 1 B.ThnBln from Bm04 B where B.Part=substring(A.PartNo,1,9) order by B.ThnBln desc)Flag into Link  " +
                            " from tesLPRs1_m3 A " +
                            " select A.PartNo,Persen*M3/100 M3,A.Qty,PlantID Line into tesLPRs2_m3 from Link A " +
                            " left join Bm04 B ON substring(A.PartNo,1,9)=B.Part  and A.Flag=B.ThnBln ";

                            New3 =
                            " select *,(select top 1 B.ThnBln from Bm04 B where B.Part=substring(A.PartNo,1,9) order by B.ThnBln desc)Flag into Link1 " +
                            " from tesSAwal_RS_m3 A " +
                            " select A.PartNo,Persen*M3/100 M3,A.Qty,PlantID Line into tesSAwal_RS1_m3 from Link1 A " +
                            " left join Bm04 B ON substring(A.PartNo,1,9)=B.Part  and A.Flag=B.ThnBln ";
                            New4 =
                            " select *,(select top 1 B.ThnBln from Bm04 B where B.Part=substring(A.PartNo,1,9) order by B.ThnBln desc)Flag into Link2 " +
                            " from tesSAkhir_RS A " +
                            " select A.PartNo,Persen*M3/100 M3,A.Qty,PlantID Line into tesSAkhir_RS1 from Link2 A " +
                            " left join Bm04 B ON substring(A.PartNo,1,9)=B.Part  and A.Flag=B.ThnBln ";
                            New5 =
                            " select *,(select top 1 B.ThnBln from Bm04 B where B.Part=substring(A.PartNo,1,9) order by B.ThnBln desc)Flag into Link3 " +
                            " from tesSAwal_Bv A " +
                            " select A.PartNo,Persen*M3/100 M3,A.Qty,PlantID Line into tesSAwal_Bv1 from Link3 A " +
                            " left join Bm04 B ON substring(A.PartNo,1,9)=B.Part  and A.Flag=B.ThnBln ";
                            New6 =
                            " select *,(select top 1 B.ThnBln from Bm04 B where B.Part=substring(A.PartNo,1,9) order by B.ThnBln desc)Flag into Link4  " +
                            " from tesSAkhir_Bv A " +
                            " select A.PartNo,Persen*M3/100 M3,A.Qty,PlantID Line into tesSAkhir_Bv1 from Link4 A " +
                            " left join Bm04 B ON substring(A.PartNo,1,9)=B.Part  and A.Flag=B.ThnBln ";
                            New7 =
                            " select *,(select top 1 B.ThnBln from Bm04 B where B.Part=substring(A.PartNo,1,9) order by B.ThnBln desc)Flag into Link5 " +
                            " from tesSAwal_Str A " +
                            " select A.PartNo,Persen*M3/100 M3,A.Qty,PlantID Line into tesSAwal_Str1 from Link5 A  " +
                            " left join Bm04 B ON substring(A.PartNo,1,9)=B.Part  and A.Flag=B.ThnBln ";
                            New8 =
                            " select *,(select top 1 B.ThnBln from Bm04 B where B.Part=substring(A.PartNo,1,9) order by B.ThnBln desc)Flag into Link6 " +
                            " from tesSAkhir_Str A " +
                            " select A.PartNo,Persen*M3/100 M3,A.Qty,PlantID Line into tesSAkhir_Str1 from Link6 A " +
                            " left join Bm04 B ON substring(A.PartNo,1,9)=B.Part  and A.Flag=B.ThnBln ";
                            New9 =
                            " select *,(select top 1 B.ThnBln from Bm04 B where B.Part=substring(A.PartNo,1,9) order by B.ThnBln desc)Flag into Link7  " +
                            " from tesTahap3_OK A " +
                            " select A.PartNo,Persen*M3/100 M3,A.Qty,PlantID Line into tesTahap3_OK1 from Link7 A " +
                            " left join Bm04 B ON substring(A.PartNo,1,9)=B.Part  and A.Flag=B.ThnBln ";
                            New10 =
                            " select *,(select top 1 B.ThnBln from Bm04 B where B.Part=substring(A.PartNo,1,9) order by B.ThnBln desc)Flag into Link8  " +
                            " from tesTahap3_BP A " +
                            " select A.PartNo,Persen*M3/100 M3,A.Qty,PlantID Line into tesTahap3_BP1 from Link8 A  " +
                            " left join Bm04 B ON substring(A.PartNo,1,9)=B.Part  and A.Flag=B.ThnBln ";
                            New11 =
                            " select *,(select top 1 B.ThnBln from Bm04 B where B.Part=A.Part order by B.ThnBln desc)Flag into Link9 " +
                            " from tempDef1_OKBP A " +
                            " select A.PartNo,Persen*M3/100 M3,A.Qty,PlantID Line into tempDef2_OKBP from Link9 A " +
                            " left join Bm04 B ON A.Part=B.Part  and A.Flag=B.ThnBln ";
                        }
                        else
                        {
                            New1 = ""; New2 = ""; New3 = ""; New4 = ""; New5 = ""; New6 = ""; New7 = ""; New8 = ""; New9 = ""; New10 = ""; New11 = "";
                            Old1 =
                            " select A.PartNo,A.Qty,case when B.Prosen=100 then A.M3 else A.M3*B.Prosen/100 end M3,B.Line,B.Prosen into tes2 from tes1 A left join Def_UKhususProsen B ON A.PartNo=B.Partno " +
                            " where left(convert(char,B.Periode,112),6)=left(convert(char,@thnbln1,112),6) and B.Noted='Defect ukuran khusus' ";
                            Old2 =
                            " select A.PartNo,case when B.Prosen=100 then A.M3 else A.M3*B.Prosen/100 end M3,A.Qty,B.Line,B.Prosen into tesLPRs2_m3 from tesLPRs1_m3 A left join Def_UKhususProsen B ON A.PartNo=B.Partno " +
                            " where B.Noted='Defect ListPlank'  and left(convert(char,B.Periode,112),6)=left(convert(char,@thnbln1,112),6) ";
                            Old3 =
                            " select A.PartNo,A.Qty,case when B.Prosen=100 then A.M3 else A.M3*B.Prosen/100 end M3,B.Line,B.Prosen into tesSAwal_RS1_m3 from tesSAwal_RS_m3 A left join Def_UKhususProsen B ON A.PartNo=B.Partno  where B.Noted='Defect ListPlank' and left(convert(char,B.Periode,112),6)=left(convert(char,@thnbln1,112),6)  ";
                            Old4 =
                            " select A.PartNo,case when B.Prosen=100 then A.M3 else A.M3*B.Prosen/100 end M3,A.Qty,B.Line,B.Prosen into tesSAkhir_RS1 from tesSAkhir_RS A left join Def_UKhususProsen B ON A.PartNo=B.Partno  where B.Noted='Defect ListPlank' and left(convert(char,B.Periode,112),6)=left(convert(char,@thnbln1,112),6) ";
                            Old5 =
                            " select A.PartNo,case when B.Prosen=100 then A.M3 else A.M3*B.Prosen/100 end M3,A.Qty,B.Line,B.Prosen into tesSAwal_Bv1 from tesSAwal_Bv A left join Def_UKhususProsen B ON A.PartNo=B.Partno  where B.Noted='Defect ListPlank' and left(convert(char,B.Periode,112),6)=left(convert(char,@thnbln1,112),6)  ";
                            Old6 =
                            " select A.PartNo,case when B.Prosen=100 then A.M3 else A.M3*B.Prosen/100 end M3,A.Qty,B.Line,B.Prosen into tesSAkhir_Bv1 from tesSAkhir_Bv A left join Def_UKhususProsen B ON A.PartNo=B.Partno  where B.Noted='Defect ListPlank' and left(convert(char,B.Periode,112),6)=left(convert(char,@thnbln1,112),6)   ";
                            Old7 =
                            " select A.PartNo,case when B.Prosen=100 then A.M3 else A.M3*B.Prosen/100 end M3,A.Qty,B.Line,B.Prosen into tesSAwal_Str1 from tesSAwal_Str A left join Def_UKhususProsen B ON A.PartNo=B.Partno  where B.Noted='Defect ListPlank' and  left(convert(char,B.Periode,112),6)=left(convert(char,@thnbln1,112),6)  ";
                            Old8 =
                            " select A.PartNo,case when B.Prosen=100 then A.M3 else A.M3*B.Prosen/100 end M3,A.Qty,B.Line,B.Prosen into tesSAkhir_Str1 from tesSAkhir_Str A left join Def_UKhususProsen B ON A.PartNo=B.Partno  where B.Noted='Defect ListPlank' and left(convert(char,B.Periode,112),6)=left(convert(char,@thnbln1,112),6)  ";
                            Old9 =
                            " select A.PartNo,case when B.Prosen=100 then A.M3 else A.M3*B.Prosen/100 end M3,A.Qty,B.Line,B.Prosen into tesTahap3_OK1 from tesTahap3_OK A left join Def_UKhususProsen B ON A.PartNo=B.Partno  where B.Noted='Defect ListPlank' and left(convert(char,B.Periode,112),6)=left(convert(char,@thnbln1,112),6) ";
                            Old10 =
                            " select A.PartNo,case when B.Prosen=100 then A.M3 else A.M3*B.Prosen/100 end M3,A.Qty,B.Line,B.Prosen into tesTahap3_BP1 from tesTahap3_BP A left join Def_UKhususProsen B ON A.PartNo=B.Partno  where B.Noted='Defect ListPlank' and left(convert(char,B.Periode,112),6)=left(convert(char,@thnbln1,112),6)  ";
                            Old11 =
                            " select A.PartNo,A.Qty,case when B.Prosen2=100 then A.M3 else (B.Prosen2*A.M3)/100 end M3,B.Line,B.Prosen2 into tempDef2_OKBP  from tempDef1_OKBP A left join Def_UKhususProsen B ON A.PartNo=B.Partno where B.Noted='Defect ukuran khusus'  and left(convert(char,B.Periode,112),6)=left(convert(char,@thnbln1,112),6) ";
                        }
                        if (users.UnitKerjaID == 7)
                        {
                            New1 = ""; New2 = ""; New3 = ""; New4 = ""; New5 = ""; New6 = ""; New7 = ""; New8 = ""; New9 = ""; New10 = ""; New11 = "";
                            Old1 =
                            " select A.PartNo,A.Qty,case when B.Prosen=100 then A.M3 else A.M3*B.Prosen/100 end M3,B.Line,B.Prosen into tes2 from tes1 A left join Def_UKhususProsen B ON A.PartNo=B.Partno " +
                            " where left(convert(char,B.Periode,112),6)=left(convert(char,@thnbln1,112),6) and B.Noted='Defect ukuran khusus' ";
                            Old2 =
                            " select A.PartNo,case when B.Prosen=100 then A.M3 else A.M3*B.Prosen/100 end M3,A.Qty,B.Line,B.Prosen into tesLPRs2_m3 from tesLPRs1_m3 A left join Def_UKhususProsen B ON A.PartNo=B.Partno " +
                            " where B.Noted='Defect ListPlank'  and left(convert(char,B.Periode,112),6)=left(convert(char,@thnbln1,112),6) ";
                            Old3 =
                            " select A.PartNo,A.Qty,case when B.Prosen=100 then A.M3 else A.M3*B.Prosen/100 end M3,B.Line,B.Prosen into tesSAwal_RS1_m3 from tesSAwal_RS_m3 A left join Def_UKhususProsen B ON A.PartNo=B.Partno  where B.Noted='Defect ListPlank' and left(convert(char,B.Periode,112),6)=left(convert(char,@thnbln1,112),6)  ";
                            Old4 =
                            " select A.PartNo,case when B.Prosen=100 then A.M3 else A.M3*B.Prosen/100 end M3,A.Qty,B.Line,B.Prosen into tesSAkhir_RS1 from tesSAkhir_RS A left join Def_UKhususProsen B ON A.PartNo=B.Partno  where B.Noted='Defect ListPlank' and left(convert(char,B.Periode,112),6)=left(convert(char,@thnbln1,112),6) ";
                            Old5 =
                            " select A.PartNo,case when B.Prosen=100 then A.M3 else A.M3*B.Prosen/100 end M3,A.Qty,B.Line,B.Prosen into tesSAwal_Bv1 from tesSAwal_Bv A left join Def_UKhususProsen B ON A.PartNo=B.Partno  where B.Noted='Defect ListPlank' and left(convert(char,B.Periode,112),6)=left(convert(char,@thnbln1,112),6)  ";
                            Old6 =
                            " select A.PartNo,case when B.Prosen=100 then A.M3 else A.M3*B.Prosen/100 end M3,A.Qty,B.Line,B.Prosen into tesSAkhir_Bv1 from tesSAkhir_Bv A left join Def_UKhususProsen B ON A.PartNo=B.Partno  where B.Noted='Defect ListPlank' and left(convert(char,B.Periode,112),6)=left(convert(char,@thnbln1,112),6)   ";
                            Old7 =
                            " select A.PartNo,case when B.Prosen=100 then A.M3 else A.M3*B.Prosen/100 end M3,A.Qty,B.Line,B.Prosen into tesSAwal_Str1 from tesSAwal_Str A left join Def_UKhususProsen B ON A.PartNo=B.Partno  where B.Noted='Defect ListPlank' and  left(convert(char,B.Periode,112),6)=left(convert(char,@thnbln1,112),6)  ";
                            Old8 =
                            " select A.PartNo,case when B.Prosen=100 then A.M3 else A.M3*B.Prosen/100 end M3,A.Qty,B.Line,B.Prosen into tesSAkhir_Str1 from tesSAkhir_Str A left join Def_UKhususProsen B ON A.PartNo=B.Partno  where B.Noted='Defect ListPlank' and left(convert(char,B.Periode,112),6)=left(convert(char,@thnbln1,112),6)  ";
                            Old9 =
                            " select A.PartNo,case when B.Prosen=100 then A.M3 else A.M3*B.Prosen/100 end M3,A.Qty,B.Line,B.Prosen into tesTahap3_OK1 from tesTahap3_OK A left join Def_UKhususProsen B ON A.PartNo=B.Partno  where B.Noted='Defect ListPlank' and left(convert(char,B.Periode,112),6)=left(convert(char,@thnbln1,112),6) ";
                            Old10 =
                            " select A.PartNo,case when B.Prosen=100 then A.M3 else A.M3*B.Prosen/100 end M3,A.Qty,B.Line,B.Prosen into tesTahap3_BP1 from tesTahap3_BP A left join Def_UKhususProsen B ON A.PartNo=B.Partno  where B.Noted='Defect ListPlank' and left(convert(char,B.Periode,112),6)=left(convert(char,@thnbln1,112),6)  ";
                            Old11 =
                            " select A.PartNo,A.Qty,case when B.Prosen2=100 then A.M3 else (B.Prosen2*A.M3)/100 end M3,B.Line,B.Prosen2 into tempDef2_OKBP  from tempDef1_OKBP A left join Def_UKhususProsen B ON A.PartNo=B.Partno where B.Noted='Defect ukuran khusus'  and left(convert(char,B.Periode,112),6)=left(convert(char,@thnbln1,112),6) ";
                        }


                        strSQL =
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectGPIso]') AND type in (N'U')) DROP TABLE [dbo].[tempdefectGPIso] " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectGPIsoTot]') AND type in (N'U')) DROP TABLE [dbo].tempdefectGPIsoTot  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectFin]') AND type in (N'U')) DROP TABLE [dbo].tempdefectFin  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectL1]') AND type in (N'U')) DROP TABLE [dbo].tempdefectL1 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectL2]') AND type in (N'U')) DROP TABLE [dbo].tempdefectL2 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectL3]') AND type in (N'U')) DROP TABLE [dbo].tempdefectL3 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectL4]') AND type in (N'U')) DROP TABLE [dbo].tempdefectL4 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectL5]') AND type in (N'U')) DROP TABLE [dbo].tempdefectL5 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectL6]') AND type in (N'U')) DROP TABLE [dbo].tempdefectL6 " +

                        " /** Baru **/ " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectGPIso2]') AND type in (N'U')) DROP TABLE [dbo].tempdefectGPIso2 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[detailDfctSystemBM_M3]') AND type in (N'U')) DROP TABLE [dbo].detailDfctSystemBM_M3 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[DtlDefectSystemFN_M3]') AND type in (N'U')) DROP TABLE [dbo].DtlDefectSystemFN_M3 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[DtlSelisih_M3]') AND type in (N'U')) DROP TABLE [dbo].DtlSelisih_M3 " +
                        " /** end Baru **/ " +

                        " declare @thnbln1 varchar(8) declare @thnbln2 varchar(8) declare @BlnThn varchar(6) " +

                        " set @thnbln1='" + strtgl1 + "' " +
                        " set @thnbln2='" + strtgl2 + "' " +
                        " set @BlnThn='" + Periode + "' " +

                        " select *  into tempdefectGPIso from (  select case when D.DeptID=0 then  case when GJ.GroupJemurName In ('M','N','O','P','Q','R','S','T','U','V','W','X') then " +
                        " case when D.DefName='retak' then 2 when D.DefName='gompal' then 3 else D.DeptID end else " +
                        " case when (B.Qty/E.Qty) *100 >5 then 2 else 3 end   end  else D.DeptID end deptID1,A.CreatedTime as tglInput,A.Tgl as TglPeriksa, " +
                        " E.TglProduksi as TglProd,  D.DefCode,BP.PlantName as Line, PG.[Group],BF.FormulaCode as Jenis,D.DefName,D.DeptID,B.ID,B.DefectID, " +
                        " B.MasterID,B.Qty,A.ID  DestID,isnull(A.TPotong,0)  QtyIn, " +
                        " I.Volume*B.Qty Kubik,isnull(A.TPotong,0) as TotPotong,'' sfrom  " +
                        " from Def_DefectDetail B " +
                        " inner join Def_Defect A on A.Id=B.DefectID   " +
                        " left join Def_MasterDefect D on B.MasterID=D.ID " +
                        " left join BM_Destacking E on E.ID=A.DestID  " +
                        " left join BM_PlantGroup PG on A.GroupProdID=PG.ID " +
                        " left join BM_Formula BF on BF.ID=E.FormulaID   " +
                        " left join BM_Plant BP on BP.ID=E.PlantID " +
                        " left join FC_Items I on I.ID=E.ItemID " +
                        " inner join Def_GroupJemur GJ on GJ.ID=A.GroupJemurID  " +
                        " where B.RowStatus>-1  and D.RowStatus >-1) as Def    " +
                        " where DeptID1=2 and CONVERT(varchar,TglPeriksa,112)>=@thnbln1 and CONVERT(varchar,TglPeriksa,112)<=@thnbln2   " +

                        " /** Baru **/ " +
                        " declare @ttlDefectBM decimal(10,5) " +
                        " declare @ttlDefectFN decimal(10,5) " +
                        " declare @Selisih_ttl_defect decimal(10,5) " +
                        " declare @dtlSelisih_ttl_defect decimal(10,5) " +
                        " declare @Selisih_ttl_defect2 decimal(10,5) " +
                        " declare @TtlDfctSystemBM_M3 decimal(10,5) " +
                        " declare @TtlDfctSystemFN_M3 decimal(10,5) " +
                        " declare @TtlDfctBMFN_M3 decimal(10,5) " +
                        " declare @TtlDefectBM_M3 decimal(10,5) " +
                        " declare @TtlDfctBMFN_M3_OKKW decimal(10,5) " +

                        " select * into tempdefectGPIso2 " +
                        " from (  select case when D.DeptID=0 then  case when GJ.GroupJemurName In ('M','N','O','P','Q','R','S','T','U','V','W','X') then  " +
                        " case when D.DefName='retak' then 2 when D.DefName='gompal' then 3 else D.DeptID end else case when (B.Qty/E.Qty) *100 >5 then 2 " +
                        " else 3 end   end  else D.DeptID end deptID1,A.CreatedTime as tglInput,A.Tgl as TglPeriksa,E.TglProduksi as TglProd, " +
                        " D.DefCode,BP.PlantName as Line, PG.[Group],BF.FormulaCode as Jenis,D.DefName,D.DeptID,B.ID,B.DefectID,B.MasterID,B.Qty,A.ID " +
                        " DestID,isnull(A.TPotong,0)  QtyIn,B.Qty*I.Volume as Kubik,isnull(A.TPotong,0) as TotPotong,'' sfrom  " +
                        " from Def_DefectDetail B inner join Def_Defect A on A.Id=B.DefectID   left join Def_MasterDefect D on B.MasterID=D.ID " +
                        " left join BM_Destacking E on E.ID=A.DestID   left join BM_PlantGroup PG on A.GroupProdID=PG.ID " +
                        " left join BM_Formula BF on BF.ID=E.FormulaID    left join BM_Plant BP on BP.ID=E.PlantID left join FC_Items I on I.ID=E.ItemID " +
                        " inner join Def_GroupJemur GJ on GJ.ID=A.GroupJemurID  where B.RowStatus>-1  and D.RowStatus >-1) as Def  " +
                        " where DeptID1=3 and CONVERT(varchar,TglPeriksa,112)>=@thnbln1 and CONVERT(varchar,TglPeriksa,112)<=@thnbln2  " +

                        " /** Detail data transaksi Defect System BM per Group **/ " +
                        " select [Group],round(M3,1)M3 into detailDfctSystemBM_M3 from ( " +
                        " select [Group],round(sum(kubik),2) M3  from tempdefectGPIso group by [Group] ) as x " +
                        " /** end Detail Defect System BM **/ " +

                        " /** Total Defect BM dan Finishing BP**/ " +
                        " set @TtlDfctBMFN_M3 = ( " +
                        " select round(sum(M3),1)BP_M3  from ( " +
                        " select sum(Qty)Qty,sum(M3)M3 from ( " +
                        " select *,round((Qty*Volume),2)M3 from ( " +
                        " select sum(A.qty *-1) Qty,(B.Tebal*B.Lebar*B.Panjang)/1000000000 Volume from vw_KartustockWIP A  " +
                        " inner join FC_Items B ON A.itemid0=B.ID " +
                        " where qty<0   and lokasi='B99' and process<>'lari' and process<>'listplank' and left(convert(char,tanggal,112),8)>=@thnbln1 and " +
                        " left(convert(char,tanggal,112),8)<=@thnbln2   group by tebal,lebar,panjang ) as x ) as x1 " +
                        " union all " +
                        " select sum(Qty)Qty,sum(M3)M3 from ( " +
                        " select *,round((Qty*Volume),2)M3 from ( " +
                        " select isnull(SUM(qty)*-1,0)Qty,(A.Tebal*A.Lebar*A.Panjang)/1000000000 Volume from vw_KartustockWIP2 V  " +
                        " inner join FC_Items I on V.itemID=I.ID inner join FC_Items A ON A.ID=V.itemid0 and (I.partno  like '%-p-%'  ) " +
                        " where qty<0  and idrec not like '%ou%'    and process='lari'and lokid1 not in (select ID from fc_lokasi where lokasi='I99') and " +
                        " left(convert(char,tanggal,112),8)>=@thnbln1 and left(convert(char,tanggal,112),8)<=@thnbln2  group by A.tebal,A.lebar,A.panjang) as x ) as x1 ) as xx ) " +
                        " /** Total Defect BM dan Finishing BP**/ " +

                        " /** Total Defect BM dan Finishing OK KW **/ " +
                        " set @TtlDfctBMFN_M3_OKKW = ( " +
                        " select round(sum(M3),1)BP_M3  from ( " +
                        " select sum(Qty)Qty,sum(M3)M3 from ( " +
                        " select *,round((Qty*Volume),2)M3 from ( " +
                        " select sum(A.qty *-1) Qty,(B.Tebal*B.Lebar*B.Panjang)/1000000000 Volume from vw_KartustockWIP A  " +
                        " inner join FC_Items B ON A.itemid0=B.ID " +
                        " where qty<0   and lokasi='H99' and process<>'lari' and process<>'listplank' and left(convert(char,tanggal,112),8)>=@thnbln1 " +
                        " and left(convert(char,tanggal,112),8)<=@thnbln2   group by tebal,lebar,panjang ) as x ) as x1 " +
                        " union all " +
                        " select sum(Qty)Qty,sum(M3)M3 from ( " +
                        " select *,round((Qty*Volume),2)M3 from ( " +
                        " select isnull(SUM(qty)*-1,0)Qty,(A.Tebal*A.Lebar*A.Panjang)/1000000000 Volume from vw_KartustockWIP2 V  " +
                        " inner join FC_Items I on V.itemID=I.ID inner join FC_Items A ON A.ID=V.itemid0 and (I.partno  like '%-3-%' or I.partno  like '%-M-%'  )     " +
                        " where qty<0  and idrec not like '%ou%'    and process='lari'and lokid1 not in (select ID from fc_lokasi where lokasi='I99') and " +
                        " left(convert(char,tanggal,112),8)>=@thnbln1 and left(convert(char,tanggal,112),8)<=@thnbln2  group by A.tebal,A.lebar,A.panjang) as x ) as x1 ) as xx ) " +
                        " /** Total Defect BM dan Finishing OK KW **/ " +

                        " set @TtlDfctSystemBM_M3 = (select M3 from (select round(sum(M3),3)M3 from detailDfctSystemBM_M3) as x) " +
                        " set @TtlDfctSystemFN_M3 = (select M3 from (select round(sum(kubik),5)M3 from tempdefectGPIso2) as x) " +
                        " set @TtlDefectBM_M3 = (select M3 from (select round(sum(M3),3)M3 from detailDfctSystemBM_M3) as x) " +

                        " /** Detail data transaksi Defect System Finishing per Group **/ " +
                        "  select [Group],round(((round(M3,6)/@TtlDfctSystemBM_M3)*@TtlDfctSystemFN_M3),6)M3 into DtlDefectSystemFN_M3 from detailDfctSystemBM_M3  " +
                        " /** End Detail data transaksi Defect System Finishing per Group **/ " +

                        " set @Selisih_ttl_defect = (select @TtlDfctBMFN_M3 - round(@TtlDefectBM_M3,5) - round(@TtlDfctSystemFN_M3,4)) " +
                        " select [Group],round((M3/@TtlDfctSystemBM_M3)*@Selisih_ttl_defect,4) M3 into DtlSelisih_M3 from detailDfctSystemBM_M3 order by [group] " +

                        /** Tambahan **/
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Bm01]') AND type in (N'U')) DROP TABLE [dbo].Bm01 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Bm02]') AND type in (N'U')) DROP TABLE [dbo].Bm02 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Bm03]') AND type in (N'U')) DROP TABLE [dbo].Bm03 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Bm04]') AND type in (N'U')) DROP TABLE [dbo].Bm04 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Bm05]') AND type in (N'U')) DROP TABLE [dbo].Bm05 " +

                        " select * into Bm01 from ( " +
                        " select distinct ItemID,PlantID,left(convert(char,tglproduksi,112),6)ThnBln from BM_Destacking where RowStatus>-1 " +
                        " group by ItemID,PlantiD,TglProduksi " +
                        " ) as x order by ThnBln,ItemID desc " +

                        " select * into Bm02 from ( " +
                        " select *,(select count(ItemID) from Bm01 B where B.ItemID=A.ItemID and B.ThnBln=A.ThnBln and ItemID>0)ttl " +
                        " from Bm01 A where ItemID>0) as x " +

                        " select *,case when ttl=0 then 0 else cast(100 as decimal(10,2))/cast(ttl as decimal(10,2)) end PerSen into Bm03 " +
                        " from Bm02 order by ThnBln desc " +

                        " select Substring(B.PartNo,1,9)Part,A.* into Bm04 from Bm03 A inner join FC_Items B ON A.ItemID=B.ID " +
                        " select ItemID,ThnBln into Bm05 from Bm04 group by ItemID,ThnBln " +
                        /** End Tambahan **/

                        " /** Defect Ukuran Khusus BP **/ " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tes1]') AND type in (N'U')) DROP TABLE [dbo].tes1 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tes2]') AND type in (N'U')) DROP TABLE [dbo].tes2 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tes3]') AND type in (N'U')) DROP TABLE [dbo].tes3 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tes4]') AND type in (N'U')) DROP TABLE [dbo].tes4 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tes5]') AND type in (N'U')) DROP TABLE [dbo].tes5 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDefectUKhusus]') AND type in (N'U')) DROP TABLE [dbo].tempDefectUKhusus " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Link0]') AND type in (N'U')) DROP TABLE [dbo].Link0 " +

                        " select * into tes1  from (  " +
                        " select SUBSTRING(replace(x.partno,',',''),1,9)Part,SUBSTRING(replace(x.partno,',',''),1,17)PartNo,x.PartnoAsal,x.Qty,((A.Tebal*A.Lebar*A.Panjang)/1000000000)*x.Qty M3 from (  " +
                        " select REPLACE(substring(Keterangan,0,19),'-P-','-1-')Partno,PartNo PartnoAsal,ItemID,isnull(SUM(Qty),0)  * -1 Qty from vw_KartuStockBJNew " +
                        " where qty <0 and (process  like '%simetris%' ) and  (/**Keterangan like '%-3-%' or Keterangan like '%-w-%' or " +
                        " Keterangan like '%-m-%' or **/Keterangan like '%-P-%') and  LokID not In (select ID from FC_Lokasi where lokasi='q99')  " +
                        " and left(convert(char,tanggal,112),8)>=@thnbln1 and  left(convert(char,tanggal,112),8)<=@thnbln2 and ItemID in (select ID " +
                        " from FC_Items where PartNo like'%-1-%' ) group by ItemID,Keterangan,PartNo   " +
                        " ) as x  inner join FC_Items A ON A.ID=x.ItemID ) as xx " +

                        //" select A.PartNo,A.Qty,case when B.Prosen=100 then A.M3 else A.M3*B.Prosen/100 end M3,B.Line,B.Prosen into tes2 from tes1 A left join Def_UKhususProsen B ON A.PartNo=B.Partno " +
                        //"  where left(convert(char,B.Periode,112),6)=left(convert(char,@thnbln1,112),6) and B.Noted='Defect ukuran khusus' " +

                        " " + New1 + " " +
                        " " + Old1 + " " +

                        " select Line,round(sum(M3),2) M3 into tes3 from ( " +
                        " select * from tes2 ) as x group by Line " +

                        " select case " +
                        " " + Query1 + " " +
                        " end [Group],* into tes4 from tes3 " +

                        " SELECT A.[Line],   " +
                        "     Split.a.value('.', 'VARCHAR(100)') AS [Group]  ,round((M3/4),3) M3 into tes5 " +
                        " FROM  (SELECT [Line],   " +
                        "        CAST ('<M>' + REPLACE([Group], ',', '</M><M>') + '</M>' AS XML) AS String  ,M3 " +
                        "   FROM  tes4) AS A CROSS APPLY String.nodes ('/M') AS Split(a); " +

                        " select [Group],round(M3,3)M3 into tempDefectUKhusus from tes5  " +
                        " /** End Defect Ukuran Khusus BP **/ " +

                        " /** Defect Ukuran Khusus OK **/ " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tes1_OK]') AND type in (N'U')) DROP TABLE [dbo].tes1_OK  " +

                        " select * into tes1_OK from ( " +
                        " select SUBSTRING(A.partno,1,9)Part,A.PartNo,x.*,((A.Tebal*A.Lebar*A.Panjang)/1000000000)*x.Qty M3 from ( " +
                        " select ItemID,isnull(SUM(Qty),0)  * -1 Qty from vw_KartuStockBJNew where qty <0 and (process  like '%simetris%' ) and " +
                        " (Keterangan like '%-3-%' or Keterangan like '%-w-%' or Keterangan like '%-m-%') and LokID not In (select ID from FC_Lokasi where lokasi='q99') " +
                        " and left(convert(char,tanggal,112),8)>=@thnbln1 and left(convert(char,tanggal,112),8)<=@thnbln2 and ItemID in (select ID from FC_Items where PartNo like'%-1-%') " +
                        " /**and CutID in (select ID from T3_Simetris where RowStatus>-1 and QtyOut>QtyIn)**/ group by ItemID ) as x inner join FC_Items A ON A.ID=x.ItemID ) as xx " +
                        " /** End Defect Ukuran Khusus OK **/ " +

                        " /** Defect ListPlank **/ " +
                        " /** 1. Out Running Saw **/ " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesLPRs1_m3]') AND type in (N'U')) DROP TABLE [dbo].tesLPRs1_m3 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesLPRs2_m3]') AND type in (N'U')) DROP TABLE [dbo].tesLPRs2_m3 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesLPRs3_m3]') AND type in (N'U')) DROP TABLE [dbo].tesLPRs3_m3  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesLPRs4_m3]') AND type in (N'U')) DROP TABLE [dbo].tesLPRs4_m3  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesLPRs5_m3]') AND type in (N'U')) DROP TABLE [dbo].tesLPRs5_m3  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempRSOut_m3]') AND type in (N'U')) DROP TABLE [dbo].tempRSOut_m3  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Link]') AND type in (N'U')) DROP TABLE [dbo].Link " +

                        " select PartNo,sum(Qty)Qty,round(sum(M3),4)M3 into tesLPRs1_m3 from ( " +
                        " select PartNo,Qty,round(((Tebal*Lebar*Panjang)/1000000000)*Qty,4)M3  from ( " +
                        " select PartNo,PartNo2,sum(Qty)Qty,Tebal,Lebar,Panjang  from ( " +
                        " select x1.PartNo,x2.PartNo PartNo2,x2.Tebal,x2.Lebar,x2.Panjang,x.Qty from ( " +
                        " select ItemID0,itemid,Qty * -1 Qty from vw_KartuStockListplank where left(convert(char,tanggal,112),8)>=@thnbln1 and " +
                        " left(convert(char,tanggal,112),8)<=@thnbln2 and process='runingsaw' and qty<0 ) as x  " +
                        " inner join FC_Items x1 ON x.ItemID0=x1.ID " +
                        " inner join FC_Items x2 ON x.ItemID=x2.ID) as A group by PartNo,PartNo2,Tebal,Lebar,Panjang ) as xx ) as xx1 group by PartNo  " +

                        //" select A.PartNo,case when B.Prosen=100 then A.M3 else A.M3*B.Prosen/100 end M3,A.Qty,B.Line,B.Prosen into tesLPRs2_m3 from tesLPRs1_m3 A left join Def_UKhususProsen B ON A.PartNo=B.Partno " +
                        //" where B.Noted='Defect ListPlank'  and left(convert(char,B.Periode,112),6)=left(convert(char,@thnbln1,112),6) " +
                        "" + New2 + "" +
                        "" + Old2 + "" +

                        " select Line,sum(M3)M3,sum(Qty)Qty into tesLPRs3_m3 from ( " +
                        " select * from tesLPRs2_m3 ) as x group by Line " +

                        " select [Group],Line ,cast(sum(M3) as decimal(10,5))M3,sum(Qty)Qty into tesLPRs4_m3  from (  " +
                        " select case " +
                        //" when Line=1 then 'KA,KB,KC,KD' when Line=2 then 'KE,KF,KG,KH' when Line=3 then 'KI,KJ,KK,KL' when Line=4 then 'KM,KN,KO,KP' "+
                        //" when Line=5 then 'KQ,KR,KS,KT' when Line=6 then 'KU,KV,KW,KX' "+
                        " " + Query1 + " " +
                        " end [Group],Line,round(M3,5)M3,Qty from tesLPRs3_m3  " +
                        //" union all  "+
                        //" select 'KA,KB,KC,KD'[Group],'1'Line,'0'M3,'0'Qty  "+
                        //" union all  "+
                        //" select 'KE,KF,KG,KH'[Group],'2'Line,'0'M3,'0'Qty  "+
                        //" union all "+
                        //" select 'KI,KJ,KK,KL'[Group],'3'Line,'0'M3,'0'Qty  "+
                        //" union all  "+
                        //" select 'KM,KN,KO,KP'[Group],'4'Line,'0'M3,'0'Qty  "+
                        //" union all  "+
                        //" select 'KQ,KR,KS,KT'[Group],'5'Line,'0'M3,'0'Qty  "+
                        //" union all  "+
                        //" select 'KQ,KR,KS,KT'[Group],'6'Line,'0'M3,'0'Qty "+
                        " " + Query2 + " " +
                        " ) as x group by [Group],Line   " +

                        " SELECT A.[Line],Split.a.value('.', 'VARCHAR(100)') AS [Group]  ,round((Qty/4),4) Qty,round((M3/4),4) M3 into tesLPRs5_m3 " +
                        " FROM  (SELECT [Line],CAST ('<M>' + REPLACE([Group], ',', '</M><M>') + '</M>' AS XML) AS String,M3,Qty FROM  tesLPRs4_m3) AS A " +
                        " CROSS APPLY String.nodes ('/M') AS Split(a); " +

                        " select Line,round(M3,5)M3 into tempRSOut_m3 from tesLPRs5_m3 order by Line " +
                        " /** 1 End **/ " +

                        " /** 2. Saldo Awal Running Saw **/ " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesSAwal_RS_m3]') AND type in (N'U')) DROP TABLE [dbo].tesSAwal_RS_m3   " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesSAwal_RS1_m3]') AND type in (N'U')) DROP TABLE [dbo].tesSAwal_RS1_m3  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesSAwal_RS2_m3]') AND type in (N'U')) DROP TABLE [dbo].tesSAwal_RS2_m3  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesSAwal_RS3_m3]') AND type in (N'U')) DROP TABLE [dbo].tesSAwal_RS3_m3  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempSAwal_RS_m3]') AND type in (N'U')) DROP TABLE [dbo].tempSAwal_RS_m3  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Link1]') AND type in (N'U')) DROP TABLE [dbo].Link1 " +

                        " select PartNo,sum((Volume*Qty))M3,sum(Qty)Qty into tesSAwal_RS_m3 " +
                        " from (  select x2.PartNo,cast(((x1.Tebal*x1.Lebar*x1.Panjang)/1000000000) as decimal(10,5))Volume,x.Qty " +
                        " from (  select sum(saldo)Qty ,ItemID,ItemID0 from T1_SaldoListPlank where Process='runingsaw' and thnbln=@BlnThn and Saldo>0 " +
                        " and ItemID<>ItemID0 group by ItemID,ItemID0 ) as x   " +
                        " inner join FC_Items x1 ON x.ItemID=x1.ID " +
                        " inner join FC_Items x2 ON x.ItemID0=x2.ID) as A group by PartNo " +

                        //" select A.PartNo,A.Qty,case when B.Prosen=100 then A.M3 else A.M3*B.Prosen/100 end M3,B.Line,B.Prosen into tesSAwal_RS1_m3 from tesSAwal_RS_m3 A left join Def_UKhususProsen B ON A.PartNo=B.Partno " +
                        //" where B.Noted='Defect ListPlank' and left(convert(char,B.Periode,112),6)=left(convert(char,@thnbln1,112),6) " +
                        " " + New3 + " " +
                        " " + Old3 + " " +

                        " select sum(M3)M3,sum(Qty)Qty,Line into tesSAwal_RS2_m3 from tesSAwal_RS1_m3 group by Line " +

                        " select [Group],Line ,cast(sum(M3) as decimal(10,5))M3,sum(Qty)Qty into tesSAwal_RS3_m3 from ( " +
                        " select case " +
                        " " + Query1 + " " +
                        " end [Group],Line,round(M3,5)M3,Qty " +
                        " from tesSAwal_RS2_m3 " +
                        " " + Query2 + " " +
                        " ) as x group by [Group],Line  " +

                        " select Line,sum(M3)M3 into tempSAwal_RS_m3 from tesSAwal_RS3_m3  group by Line " +
                        " /** 2 End **/ " +

                        " /** 3. Saldo Akhir RunningSaw **/ " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesSAkhir_RS]') AND type in (N'U')) DROP TABLE [dbo].tesSAkhir_RS " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesSAkhir_RS1]') AND type in (N'U')) DROP TABLE [dbo].tesSAkhir_RS1 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesSAkhir_RS2]') AND type in (N'U')) DROP TABLE [dbo].tesSAkhir_RS2  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesSAkhir_RS3]') AND type in (N'U')) DROP TABLE [dbo].tesSAkhir_RS3 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesSAkhir_RS4]') AND type in (N'U')) DROP TABLE [dbo].tesSAkhir_RS4 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempSAkhir_RS_m3]') AND type in (N'U')) DROP TABLE [dbo].tempSAkhir_RS_m3 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Link2]') AND type in (N'U')) DROP TABLE [dbo].Link2 " +

                        " select PartNo,sum(Qty)Qty,round(sum(M3),4)M3 into tesSAkhir_RS from ( " +
                        " select PartNo,Qty,round(((Tebal*Lebar*Panjang)/1000000000)*Qty,4)M3  from ( " +
                        " select PartNo,PartNo2,sum(Qty)Qty,Tebal,Lebar,Panjang  from ( " +
                        " select x1.PartNo,x2.PartNo PartNo2,x2.Tebal,x2.Lebar,x2.Panjang,x.Qty from ( " +
                        " select sum(Saldo)Qty,ItemID0,ItemID from T1_SaldoListPlank where Process='runingsaw' and thnbln=left(convert(char,@thnbln1,112),6) and Saldo>0 " +
                        " and ItemID<>ItemID0 group by ItemID0,ItemID ) as x  " +
                        " inner join FC_Items x1 ON x.ItemID0=x1.ID " +
                        " inner join FC_Items x2 ON x.ItemID=x2.ID) as A group by PartNo,PartNo2,Tebal,Lebar,Panjang ) as xx ) as xx1 group by PartNo  " +

                        //" select A.PartNo,case when B.Prosen=100 then A.M3 else A.M3*B.Prosen/100 end M3,A.Qty,B.Line,B.Prosen into tesSAkhir_RS1 from tesSAkhir_RS A left join Def_UKhususProsen B ON A.PartNo=B.Partno " +
                        //" where B.Noted='Defect ListPlank' and left(convert(char,B.Periode,112),6)=left(convert(char,@thnbln1,112),6) " +
                        " " + New4 + " " +
                        " " + Old4 + " " +

                        " select Line,sum(M3)M3,sum(Qty)Qty into tesSAkhir_RS2 from (select * from tesSAkhir_RS1 ) as x group by Line  " +

                        " select [Group],Line ,cast(sum(M3) as decimal(10,5))M3,sum(Qty)Qty into tesSAkhir_RS3 from (  " +
                        " select case " +
                        " " + Query1 + " " +
                        " end [Group],Line,round(M3,5)M3,Qty  from tesSAkhir_RS2 " +
                        " " + Query2 + " " +
                        " ) as x group by [Group],Line  " +

                        " SELECT A.[Line],   " +
                        "    Split.a.value('.', 'VARCHAR(100)') AS [Group]  ,cast(round((Qty/4),4) as decimal(10,4)) Qty,round((M3/4),4) M3 into tesSAkhir_RS4 " +
                        " FROM  (SELECT [Line],   " +
                        "        CAST ('<M>' + REPLACE([Group], ',', '</M><M>') + '</M>' AS XML) AS String  ,M3,cast(Qty as decimal(10,4))Qty " +
                        "    FROM  tesSAkhir_RS3) AS A CROSS APPLY String.nodes ('/M') AS Split(a); " +

                        " select Line,round(M3,3)M3 into tempSAkhir_RS_m3 from tesSAkhir_RS4   order by Line " +
                        " /** 3 End **/ " +

                        " /** 4. Saldo Awal Bevel **/ " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesSAwal_Bv]') AND type in (N'U')) DROP TABLE [dbo].tesSAwal_Bv " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesSAwal_Bv1]') AND type in (N'U')) DROP TABLE [dbo].tesSAwal_Bv1 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesSAwal_Bv2]') AND type in (N'U')) DROP TABLE [dbo].tesSAwal_Bv2 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesSAwal_Bv3]') AND type in (N'U')) DROP TABLE [dbo].tesSAwal_Bv3 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesSAwal_Bv4]') AND type in (N'U')) DROP TABLE [dbo].tesSAwal_Bv4 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempSAwal_Bv_m3]') AND type in (N'U')) DROP TABLE [dbo].tempSAwal_Bv_m3 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Link3]') AND type in (N'U')) DROP TABLE [dbo].Link3 " +

                        " select PartNo,sum(Qty)Qty,round(sum(M3),4)M3 into tesSAwal_Bv from ( " +
                        " select PartNo,Qty,round(((Tebal*Lebar*Panjang)/1000000000)*Qty,4)M3  from ( " +
                        " select PartNo,PartNo2,sum(Qty)Qty,Tebal,Lebar,Panjang  from ( " +
                        " select x1.PartNo,x2.PartNo PartNo2,x2.Tebal,x2.Lebar,x2.Panjang,x.Qty from ( " +
                        " select sum(Saldo)Qty,ItemID0,ItemID from T1_SaldoListPlank where Process='bevel' and thnbln=@BlnThn and Saldo>0 and ItemID<>ItemID0 group by ItemID0,ItemID ) as x  " +
                        " inner join FC_Items x1 ON x.ItemID0=x1.ID " +
                        " inner join FC_Items x2 ON x.ItemID=x2.ID) as A group by PartNo,PartNo2,Tebal,Lebar,Panjang ) as xx ) as xx1 group by PartNo  " +

                        //" select A.PartNo,case when B.Prosen=100 then A.M3 else A.M3*B.Prosen/100 end M3,A.Qty,B.Line,B.Prosen into tesSAwal_Bv1 from tesSAwal_Bv A left join Def_UKhususProsen B ON A.PartNo=B.Partno " +
                        //" where B.Noted='Defect ListPlank' and left(convert(char,B.Periode,112),6)=left(convert(char,@thnbln1,112),6) " +
                        " " + New5 + " " +
                        " " + Old5 + " " +

                        " select Line,sum(M3)M3,sum(Qty)Qty into tesSAwal_Bv2 from ( " +
                        " select * from tesSAwal_Bv1 ) as x group by Line " +

                        " select [Group],Line ,cast(sum(M3) as decimal(10,5))M3,sum(Qty)Qty into tesSAwal_Bv3 from ( " +
                        " select case " +
                        //" when Line=1 then 'KA,KB,KC,KD' when Line=2 then 'KE,KF,KG,KH' when Line=3 then 'KI,KJ,KK,KL' when Line=4 "+
                        //" then 'KM,KN,KO,KP' when Line=5 then 'KQ,KR,KS,KT' when Line=6 then 'KU,KV,KW,KX' "+
                        " " + Query1 + " " +
                        " end [Group],Line,round(M3,2)M3,Qty " +
                        " from tesSAwal_Bv2 " +
                        //" union all "+ 
                        //" select 'KA,KB,KC,KD'[Group],'1'Line,'0'M3,'0'Qty "+
                        //" union all "+
                        //" select 'KE,KF,KG,KH'[Group],'2'Line,'0'M3,'0'Qty "+
                        //" union all "+
                        //" select 'KI,KJ,KK,KL'[Group],'3'Line,'0'M3,'0'Qty "+
                        //" union all "+
                        //" select 'KM,KN,KO,KP'[Group],'4'Line,'0'M3,'0'Qty "+
                        //" union all "+
                        //" select 'KQ,KR,KS,KT'[Group],'5'Line,'0'M3,'0'Qty "+
                        //" union all "+
                        //" select 'KQ,KR,KS,KT'[Group],'6'Line,'0'M3,'0'Qty "+
                        " " + Query2 + " " +
                        " ) as x group by [Group],Line  " +

                        " SELECT A.[Line],   " +
                        "    Split.a.value('.', 'VARCHAR(100)') AS [Group]  ,cast(round((Qty/4),4) as decimal(10,4)) Qty,round((M3/4),4) M3 into tesSAwal_Bv4 " +
                        " FROM  (SELECT [Line],   " +
                        "        CAST ('<M>' + REPLACE([Group], ',', '</M><M>') + '</M>' AS XML) AS String  ,M3,cast(Qty as decimal(10,4))Qty " +
                        "    FROM  tesSAwal_Bv3) AS A CROSS APPLY String.nodes ('/M') AS Split(a); " +

                        " select Line,M3 into tempSAwal_Bv_m3 from tesSAwal_Bv4   order by Line " +
                        " /** End 4 **/ " +

                        " /** 5. Saldo Akhir Bevel **/ " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesSAkhir_Bv]') AND type in (N'U')) DROP TABLE [dbo].tesSAkhir_Bv " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesSAkhir_Bv1]') AND type in (N'U')) DROP TABLE [dbo].tesSAkhir_Bv1 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesSAkhir_Bv2]') AND type in (N'U')) DROP TABLE [dbo].tesSAkhir_Bv2 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesSAkhir_Bv3]') AND type in (N'U')) DROP TABLE [dbo].tesSAkhir_Bv3 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesSAkhir_Bv4]') AND type in (N'U')) DROP TABLE [dbo].tesSAkhir_Bv4 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempSAkhir_Bv_m3]') AND type in (N'U')) DROP TABLE [dbo].tempSAkhir_Bv_m3 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Link4]') AND type in (N'U')) DROP TABLE [dbo].Link4 " +

                        " select PartNo,sum(Qty)Qty,round(sum(M3),4)M3 into tesSAkhir_Bv from ( " +
                        " select PartNo,Qty,round(((Tebal*Lebar*Panjang)/1000000000)*Qty,4)M3  from ( " +
                        " select PartNo,PartNo2,sum(Qty)Qty,Tebal,Lebar,Panjang  from ( " +
                        " select x1.PartNo,x2.PartNo PartNo2,x2.Tebal,x2.Lebar,x2.Panjang,x.Qty from ( " +
                        " select sum(Saldo)Qty,ItemID0,ItemID from T1_SaldoListPlank where Process='bevel' and thnbln=left(convert(char,@thnbln1,112),6) and Saldo>0 " +
                        " and ItemID<>ItemID0 group by ItemID0,ItemID ) as x  " +
                        " inner join FC_Items x1 ON x.ItemID0=x1.ID " +
                        " inner join FC_Items x2 ON x.ItemID=x2.ID) as A group by PartNo,PartNo2,Tebal,Lebar,Panjang ) as xx ) as xx1 group by PartNo  " +

                        //" select A.PartNo,case when B.Prosen=100 then A.M3 else A.M3*B.Prosen/100 end M3,A.Qty,B.Line,B.Prosen into tesSAkhir_Bv1 from tesSAkhir_Bv A left join Def_UKhususProsen B ON A.PartNo=B.Partno " +
                        //" where B.Noted='Defect ListPlank' and left(convert(char,B.Periode,112),6)=left(convert(char,@thnbln1,112),6) " +
                        " " + New6 + " " +
                        " " + Old6 + " " +

                        " select Line,sum(M3)M3,sum(Qty)Qty into tesSAkhir_Bv2 from ( " +
                        "select * from tesSAkhir_Bv1 ) as x group by Line " +

                        " select [Group],Line ,cast(sum(M3) as decimal(10,5))M3,sum(Qty)Qty into tesSAkhir_Bv3 from ( " +
                        " select case " +
                        //" when Line=1 then 'KA,KB,KC,KD' when Line=2 then 'KE,KF,KG,KH' when Line=3 then 'KI,KJ,KK,KL' when Line=4 then 'KM,KN,KO,KP' "+
                        //" when Line=5 then 'KQ,KR,KS,KT' when Line=6 then 'KU,KV,KW,KX' "+
                        " " + Query1 + " " +
                        " end [Group],Line,round(M3,5)M3,Qty from tesSAkhir_Bv2 " +
                        //" union all "+ 
                        //" select 'KA,KB,KC,KD'[Group],'1'Line,'0'M3,'0'Qty "+
                        //" union all "+
                        //" select 'KE,KF,KG,KH'[Group],'2'Line,'0'M3,'0'Qty "+
                        //" union all "+
                        //" select 'KI,KJ,KK,KL'[Group],'3'Line,'0'M3,'0'Qty "+
                        //" union all "+
                        //" select 'KM,KN,KO,KP'[Group],'4'Line,'0'M3,'0'Qty "+
                        //" union all "+
                        //" select 'KQ,KR,KS,KT'[Group],'5'Line,'0'M3,'0'Qty "+
                        //" union all "+
                        //" select 'KQ,KR,KS,KT'[Group],'6'Line,'0'M3,'0'Qty "+
                        " " + Query2 + " " +
                        " ) as x group by [Group],Line  " +

                        " SELECT A.[Line],   " +
                        "    Split.a.value('.', 'VARCHAR(100)') AS [Group]  ,cast(round((Qty/4),4) as decimal(10,4)) Qty,round((M3/4),4) M3 into tesSAkhir_Bv4 " +
                        " FROM  (SELECT [Line],  " +
                        "        CAST ('<M>' + REPLACE([Group], ',', '</M><M>') + '</M>' AS XML) AS String  ,M3,cast(Qty as decimal(10,4))Qty " +
                        "    FROM  tesSAkhir_Bv3) AS A CROSS APPLY String.nodes ('/M') AS Split(a); " +

                        " select Line,M3 into tempSAkhir_Bv_m3 from tesSAkhir_Bv4   order by Line " +
                        " /** End 5 **/ " +

                        " /** 6. Saldo Awal Strapping **/ " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesSAwal_Str]') AND type in (N'U')) DROP TABLE [dbo].tesSAwal_Str " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesSAwal_Str1]') AND type in (N'U')) DROP TABLE [dbo].tesSAwal_Str1 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesSAwal_Str2]') AND type in (N'U')) DROP TABLE [dbo].tesSAwal_Str2 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesSAwal_Str3]') AND type in (N'U')) DROP TABLE [dbo].tesSAwal_Str3 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesSAwal_Str4]') AND type in (N'U')) DROP TABLE [dbo].tesSAwal_Str4 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempSAwal_Str_m3]') AND type in (N'U')) DROP TABLE [dbo].tempSAwal_Str_m3 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Link5]') AND type in (N'U')) DROP TABLE [dbo].Link5 " +

                        " select PartNo,sum(Qty)Qty,round(sum(M3),4)M3 into tesSAwal_Str from ( " +
                        " select PartNo,Qty,round(((Tebal*Lebar*Panjang)/1000000000)*Qty,4)M3  from ( " +
                        " select PartNo,PartNo2,sum(Qty)Qty,Tebal,Lebar,Panjang  from ( " +
                        " select x1.PartNo,x2.PartNo PartNo2,x2.Tebal,x2.Lebar,x2.Panjang,x.Qty from ( " +
                        " select sum(Saldo)Qty,ItemID0,ItemID from T1_SaldoListPlank where Process='straping' and thnbln=@BlnThn and Saldo>0 and ItemID<>ItemID0 group by ItemID0,ItemID ) as x  " +
                        " inner join FC_Items x1 ON x.ItemID0=x1.ID " +
                        " inner join FC_Items x2 ON x.ItemID=x2.ID) as A group by PartNo,PartNo2,Tebal,Lebar,Panjang ) as xx ) as xx1 group by PartNo  " +

                        //" select A.PartNo,case when B.Prosen=100 then A.M3 else A.M3*B.Prosen/100 end M3,A.Qty,B.Line,B.Prosen into tesSAwal_Str1 from tesSAwal_Str A left join Def_UKhususProsen B ON A.PartNo=B.Partno " +
                        //" where B.Noted='Defect ListPlank' and  left(convert(char,B.Periode,112),6)=left(convert(char,@thnbln1,112),6) " +
                        " " + New7 + " " +
                        " " + Old7 + " " +

                        " select Line,sum(M3)M3,sum(Qty)Qty into tesSAwal_Str2 from ( " +
                        " select * from tesSAwal_Str1 ) as x group by Line " +

                        " select [Group],Line ,cast(sum(M3) as decimal(10,5))M3,sum(Qty)Qty into tesSAwal_Str3 from (  " +
                        " select case " +
                        //" when Line=1 then 'KA,KB,KC,KD' when Line=2 then 'KE,KF,KG,KH' when Line=3 then 'KI,KJ,KK,KL' when Line=4 then 'KM,KN,KO,KP' "+
                        //" when Line=5 then 'KQ,KR,KS,KT' when Line=6 then 'KU,KV,KW,KX' "+
                        " " + Query1 + " " +
                        " end [Group],Line,round(M3,5)M3,Qty  from tesSAwal_Str2  " +
                        //" union all "+ 
                        //" select 'KA,KB,KC,KD'[Group],'1'Line,'0'M3,'0'Qty "+
                        //" union all "+
                        //" select 'KE,KF,KG,KH'[Group],'2'Line,'0'M3,'0'Qty "+
                        //" union all "+
                        //" select 'KI,KJ,KK,KL'[Group],'3'Line,'0'M3,'0'Qty "+
                        //" union all "+
                        //" select 'KM,KN,KO,KP'[Group],'4'Line,'0'M3,'0'Qty "+
                        //" union all "+
                        //" select 'KQ,KR,KS,KT'[Group],'5'Line,'0'M3,'0'Qty "+
                        //" union all "+
                        //" select 'KQ,KR,KS,KT'[Group],'6'Line,'0'M3,'0'Qty "+
                        " " + Query2 + " " +
                        " ) as x group by [Group],Line  " +

                        " SELECT A.[Line],  " +
                        "    Split.a.value('.', 'VARCHAR(100)') AS [Group]  ,cast(round((Qty/4),4) as decimal(10,4)) Qty,round((M3/4),4) M3 into tesSAwal_Str4 " +
                        " FROM  (SELECT [Line],  " +
                        "        CAST ('<M>' + REPLACE([Group], ',', '</M><M>') + '</M>' AS XML) AS String  ,M3,cast(Qty as decimal(10,4))Qty " +
                        "    FROM  tesSAwal_Str3) AS A CROSS APPLY String.nodes ('/M') AS Split(a); " +

                        " select Line,round(M3,5)M3 into tempSAwal_Str_m3 from tesSAwal_Str4   order by Line " +
                        " /** End 6 **/ " +

                        " /** 7. Saldo Akhir Strapping **/ " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesSAkhir_Str]') AND type in (N'U')) DROP TABLE [dbo].tesSAkhir_Str " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesSAkhir_Str1]') AND type in (N'U')) DROP TABLE [dbo].tesSAkhir_Str1 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesSAkhir_Str2]') AND type in (N'U')) DROP TABLE [dbo].tesSAkhir_Str2 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesSAkhir_Str3]') AND type in (N'U')) DROP TABLE [dbo].tesSAkhir_Str3 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesSAkhir_Str4]') AND type in (N'U')) DROP TABLE [dbo].tesSAkhir_Str4 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempSAkhir_Str_m3]') AND type in (N'U')) DROP TABLE [dbo].tempSAkhir_Str_m3 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Link6]') AND type in (N'U')) DROP TABLE [dbo].Link6 " +

                        " select PartNo,sum(Qty)Qty,round(sum(M3),4)M3 into tesSAkhir_Str from ( " +
                        " select PartNo,Qty,round(((Tebal*Lebar*Panjang)/1000000000)*Qty,4)M3  from ( " +
                        " select PartNo,PartNo2,sum(Qty)Qty,Tebal,Lebar,Panjang  from ( " +
                        " select x1.PartNo,x2.PartNo PartNo2,x2.Tebal,x2.Lebar,x2.Panjang,x.Qty from ( " +
                        " select sum(Saldo)Qty,ItemID0,ItemID from T1_SaldoListPlank where Process='straping' and thnbln=left(convert(char,@thnbln1,112),6) and ItemID<>ItemID0 and Saldo>0 " +
                        " group by ItemID0,ItemID ) as x  " +
                        " inner join FC_Items x1 ON x.ItemID0=x1.ID " +
                        " inner join FC_Items x2 ON x.ItemID=x2.ID) as A group by PartNo,PartNo2,Tebal,Lebar,Panjang ) as xx ) as xx1 group by PartNo  " +

                        //" select A.PartNo,case when B.Prosen=100 then A.M3 else A.M3*B.Prosen/100 end M3,A.Qty,B.Line,B.Prosen into tesSAkhir_Str1 from tesSAkhir_Str A left join Def_UKhususProsen B ON A.PartNo=B.Partno " +
                        //" where B.Noted='Defect ListPlank' and left(convert(char,B.Periode,112),6)=left(convert(char,@thnbln1,112),6) " +
                        " " + New8 + " " +
                        " " + Old8 + " " +

                        " select Line,sum(M3)M3,sum(Qty)Qty into tesSAkhir_Str2 from ( " +
                        " select * from tesSAkhir_Str1 ) as x group by Line " +

                        " select [Group],Line ,cast(sum(M3) as decimal(10,5))M3,sum(Qty)Qty into tesSAkhir_Str3 from ( " +
                        " select case " +
                        //" when Line=1 then 'KA,KB,KC,KD' when Line=2 then 'KE,KF,KG,KH' when Line=3 then 'KI,KJ,KK,KL' when Line=4 then 'KM,KN,KO,KP' "+
                        //" when Line=5 then 'KQ,KR,KS,KT' when Line=6 then 'KU,KV,KW,KX' "+
                        " " + Query1 + " " +
                        " end [Group],Line,round(M3,5)M3,Qty  from tesSAkhir_Str2  " +
                        //" union all "+ 
                        //" select 'KA,KB,KC,KD'[Group],'1'Line,'0'M3,'0'Qty "+
                        //" union all "+
                        //" select 'KE,KF,KG,KH'[Group],'2'Line,'0'M3,'0'Qty "+
                        //" union all "+
                        //" select 'KI,KJ,KK,KL'[Group],'3'Line,'0'M3,'0'Qty "+
                        //" union all "+
                        //" select 'KM,KN,KO,KP'[Group],'4'Line,'0'M3,'0'Qty "+
                        //" union all "+
                        //" select 'KQ,KR,KS,KT'[Group],'5'Line,'0'M3,'0'Qty "+
                        //" union all "+
                        //" select 'KQ,KR,KS,KT'[Group],'6'Line,'0'M3,'0'Qty "+
                        " " + Query2 + " " +
                        " ) as x group by [Group],Line  " +

                        " SELECT A.[Line],    " +
                        "    Split.a.value('.', 'VARCHAR(100)') AS [Group]  ,cast(round((Qty/4),4) as decimal(10,4)) Qty,round((M3/4),4) M3 into tesSAkhir_Str4  " +
                        " FROM  (SELECT [Line],   " +
                        "        CAST ('<M>' + REPLACE([Group], ',', '</M><M>') + '</M>' AS XML) AS String  ,M3,cast(Qty as decimal(10,4))Qty  " +
                        "    FROM  tesSAkhir_Str3) AS A CROSS APPLY String.nodes ('/M') AS Split(a);  " +

                        " select Line,round(M3,5)M3 into tempSAkhir_Str_m3 from tesSAkhir_Str4   order by Line  " +
                        " /** End 7 **/  " +

                        " /** 8. Tahap III OK **/ " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesTahap3_OK]') AND type in (N'U')) DROP TABLE [dbo].tesTahap3_OK " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesTahap3_OK1]') AND type in (N'U')) DROP TABLE [dbo].tesTahap3_OK1 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesTahap3_OK2]') AND type in (N'U')) DROP TABLE [dbo].tesTahap3_OK2 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesTahap3_OK3]') AND type in (N'U')) DROP TABLE [dbo].tesTahap3_OK3 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesTahap3_OK4]') AND type in (N'U')) DROP TABLE [dbo].tesTahap3_OK4 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTahap3_OK_m3]') AND type in (N'U')) DROP TABLE [dbo].tempTahap3_OK_m3 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Link7]') AND type in (N'U')) DROP TABLE [dbo].Link7 " +

                        " select PartNo,sum(Qty)Qty,round(sum(M3),5)M3 into tesTahap3_OK from ( " +
                        " select PartNo,Qty,round(((Tebal*Lebar*Panjang)/1000000000)*Qty,5)M3  from ( " +
                        " select PartNo,sum(Qty)Qty,Tebal,Lebar,Panjang  from ( " +
                        " select x.PartNo ,x2.Tebal,x2.Lebar,x2.Panjang,x.Qty from ( " +
                        " select sum(Qty)Qty,ItemID,Keterangan Partno from vw_KartuStockBJNew " +
                        " where sfrom='straping' and left(convert(char,tanggal,112),6)=left(convert(char,@thnbln1,112),6) and ItemID in " +
                        " (select ID from FC_Items where PartNo like'%-M-%' or PartNo like'%-3-%')  group by ItemID,Keterangan ) as x  " +
                        " inner join FC_Items x2 ON x.ItemID=x2.ID) as A group by PartNo,Tebal,Lebar,Panjang ) as xx ) as xx1 group by PartNo  " +

                        //" select A.PartNo,case when B.Prosen=100 then A.M3 else A.M3*B.Prosen/100 end M3,A.Qty,B.Line,B.Prosen into tesTahap3_OK1 from tesTahap3_OK A left join Def_UKhususProsen B ON A.PartNo=B.Partno " +
                        //" where B.Noted='Defect ListPlank' and left(convert(char,B.Periode,112),6)=left(convert(char,@thnbln1,112),6) " +
                        " " + New9 + " " +
                        " " + Old9 + " " +

                        " select Line,sum(M3)M3,sum(Qty)Qty into tesTahap3_OK2 from ( " +
                        " select * from tesTahap3_OK1 ) as x group by Line " +

                        " select [Group],Line ,cast(sum(M3) as decimal(10,5))M3,sum(Qty)Qty into tesTahap3_OK3 from ( " +
                        " select case " +
                        //" when Line=1 then 'KA,KB,KC,KD' when Line=2 then 'KE,KF,KG,KH' when Line=3 then 'KI,KJ,KK,KL' when Line=4 then 'KM,KN,KO,KP' "+
                        //" when Line=5 then 'KQ,KR,KS,KT' when Line=6 then 'KU,KV,KW,KX' "+
                        " " + Query1 + " " +
                        " end [Group],Line,round(M3,5)M3,Qty from tesTahap3_OK2 " +
                        //" union all "+ 
                        //" select 'KA,KB,KC,KD'[Group],'1'Line,'0'M3,'0'Qty "+
                        //" union all "+
                        //" select 'KE,KF,KG,KH'[Group],'2'Line,'0'M3,'0'Qty "+
                        //" union all "+
                        //" select 'KI,KJ,KK,KL'[Group],'3'Line,'0'M3,'0'Qty "+
                        //" union all "+
                        //" select 'KM,KN,KO,KP'[Group],'4'Line,'0'M3,'0'Qty "+
                        //" union all "+
                        //" select 'KQ,KR,KS,KT'[Group],'5'Line,'0'M3,'0'Qty "+
                        //" union all "+
                        //" select 'KQ,KR,KS,KT'[Group],'6'Line,'0'M3,'0'Qty "+
                        " " + Query2 + " " +
                        " ) as x group by [Group],Line  " +

                        " SELECT A.[Line],   " +
                        "    Split.a.value('.', 'VARCHAR(100)') AS [Group]  ,cast(round((Qty/4),4) as decimal(10,4)) Qty,round((M3/4),4) M3 into tesTahap3_OK4 " +
                        " FROM  (SELECT [Line], " +
                        "        CAST ('<M>' + REPLACE([Group], ',', '</M><M>') + '</M>' AS XML) AS String  ,M3,cast(Qty as decimal(10,4))Qty " +
                        "    FROM  tesTahap3_OK3) AS A CROSS APPLY String.nodes ('/M') AS Split(a);	 " +

                        " select line,round(m3,5)M3 into tempTahap3_OK_m3 from ( " +
                        " select sum(M3)M3,line from tesTahap3_OK4 group by line ) as x " +
                        " /** End 8 **/ " +

                        " /** 9. Tahap III BP **/ " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesTahap3_BP]') AND type in (N'U')) DROP TABLE [dbo].tesTahap3_BP " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesTahap3_BP1]') AND type in (N'U')) DROP TABLE [dbo].tesTahap3_BP1 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesTahap3_BP2]') AND type in (N'U')) DROP TABLE [dbo].tesTahap3_BP2 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesTahap3_BP3]') AND type in (N'U')) DROP TABLE [dbo].tesTahap3_BP3 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesTahap3_BP4]') AND type in (N'U')) DROP TABLE [dbo].tesTahap3_BP4 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTahap3_BP_m3]') AND type in (N'U')) DROP TABLE [dbo].tempTahap3_BP_m3 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Link8]') AND type in (N'U')) DROP TABLE [dbo].Link8 " +

                        " select PartNo,sum(Qty)Qty,round(sum(M3),5)M3 into tesTahap3_BP from ( " +
                        " select PartNo,Qty,round(((Tebal*Lebar*Panjang)/1000000000)*Qty,5)M3  from ( " +
                        " select PartNo,sum(Qty)Qty,Tebal,Lebar,Panjang  from ( " +
                        " select x.PartNo ,x2.Tebal,x2.Lebar,x2.Panjang,x.Qty from ( " +
                        " select sum(Qty)Qty,ItemID,Keterangan Partno from vw_KartuStockBJNew " +
                        " where sfrom='straping' and left(convert(char,tanggal,112),6)=left(convert(char,@thnbln1,112),6) and " +
                        " ItemID in (select ID from FC_Items where PartNo like'%-P-%' or PartNo like'%-S-%')  group by ItemID,Keterangan ) as x  " +
                        " inner join FC_Items x2 ON x.ItemID=x2.ID) as A group by PartNo,Tebal,Lebar,Panjang ) as xx ) as xx1 group by PartNo  " +

                        //" select A.PartNo,case when B.Prosen=100 then A.M3 else A.M3*B.Prosen/100 end M3,A.Qty,B.Line,B.Prosen into tesTahap3_BP1 from tesTahap3_BP A left join Def_UKhususProsen B ON A.PartNo=B.Partno " +
                        //" where B.Noted='Defect ListPlank' and left(convert(char,B.Periode,112),6)=left(convert(char,@thnbln1,112),6) " +
                        " " + New10 + " " +
                        " " + Old10 + " " +

                        " select Line,sum(M3)M3,sum(Qty)Qty into tesTahap3_BP2 from ( " +
                        " select * from tesTahap3_BP1 ) as x group by Line " +

                        " select [Group],Line ,cast(sum(M3) as decimal(10,5))M3,sum(Qty)Qty into tesTahap3_BP3 from ( " +
                        " select case " +
                        //" when Line=1 then 'KA,KB,KC,KD' when Line=2 then 'KE,KF,KG,KH' when Line=3 then 'KI,KJ,KK,KL' when Line=4 then 'KM,KN,KO,KP'  "+
                        //" when Line=5 then 'KQ,KR,KS,KT' when Line=6 then 'KU,KV,KW,KX' "+
                        " " + Query1 + " " +
                        " end [Group],Line,round(M3,5)M3,Qty  from tesTahap3_BP2 " +
                        //" union all "+ 
                        //" select 'KA,KB,KC,KD'[Group],'1'Line,'0'M3,'0'Qty "+
                        //" union all "+
                        //" select 'KE,KF,KG,KH'[Group],'2'Line,'0'M3,'0'Qty "+
                        //" union all "+
                        //" select 'KI,KJ,KK,KL'[Group],'3'Line,'0'M3,'0'Qty "+
                        //" union all "+
                        //" select 'KM,KN,KO,KP'[Group],'4'Line,'0'M3,'0'Qty "+
                        //" union all "+
                        //" select 'KQ,KR,KS,KT'[Group],'5'Line,'0'M3,'0'Qty "+
                        //" union all "+
                        //" select 'KQ,KR,KS,KT'[Group],'6'Line,'0'M3,'0'Qty "+
                        " " + Query2 + " " +
                        " ) as x group by [Group],Line  " +

                        " SELECT A.[Line],   " +
                        "     Split.a.value('.', 'VARCHAR(100)') AS [Group]  ,cast(round((Qty/4),4) as decimal(10,4)) Qty,round((M3/4),4) M3 into tesTahap3_BP4 " +
                        " FROM  (SELECT [Line],   " +
                        "         CAST ('<M>' + REPLACE([Group], ',', '</M><M>') + '</M>' AS XML) AS String  ,M3,cast(Qty as decimal(10,4))Qty " +
                        "     FROM  tesTahap3_BP3) AS A CROSS APPLY String.nodes ('/M') AS Split(a); " +

                        " select line,round(m3,5)M3 into tempTahap3_BP_m3 from (select sum(M3)M3,line from tesTahap3_BP4 group by line ) as x " +
                        " /** End 9 **/ " +

                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempBagiDefectLP_m3]') AND type in (N'U')) DROP TABLE [dbo].tempBagiDefectLP_m3 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempBagiDefect_LP1_m3]') AND type in (N'U')) DROP TABLE [dbo].tempBagiDefect_LP1_m3 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempBagiDefect_LP2_m3]') AND type in (N'U')) DROP TABLE [dbo].tempBagiDefect_LP2_m3 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempBagiDefect_LP3_m3]') AND type in (N'U')) DROP TABLE [dbo].tempBagiDefect_LP3_m3 " +

                        " select Line,round(sum(M3),1)M3 into tempBagiDefectLP_m3 from ( " +
                        " select line,sum(M3)M3 from ( " +
                        " select line,sum(M3)M3 from ( " +
                        " select line,round(sum(M3),2)M3 from ( " +
                        " select Line,round(M3,4)M3 from tempRSOut_m3 ) as x group by line " +
                        " union all " +
                        " select line,sum(M3)M3 from ( " +
                        " /** 1 **/ " +
                        " select Line,round(sum(M3),5)M3 from ( " +
                        " select line,round(M3,5)M3 from tempSAwal_RS_m3 " +
                        " union all " +
                        " select Line,round(M3*-1,5) M3 from tempSAkhir_RS_m3 ) as x group by line " +
                        " /** 1 **/ " +
                        " union all " +
                        " /** 2 **/ " +
                        " select Line,sum(M3)M3 from ( " +
                        " select * from tempSAwal_Bv_m3 " +
                        " union all " +
                        " select Line,M3*-1 M3 from tempSAkhir_Bv_m3 ) as x group by line " +
                        "/** 2 **/ " +
                        "union all " +
                        "/** 3 **/ " +
                        "select Line,round(sum(M3),2)M3 from ( " +
                        "select Line,round(sum(M3),3)M3 from tempSAwal_Str_m3 group by line " +
                        "union all " +
                        "select Line,M3*-1 M3 from tempSAkhir_Str_m3 ) as x group by line  " +
                        "/** 3 **/ " +
                        ") as A group by line ) as B group by line " +
                        "union all " +
                        "select Line,M3*-1 M3 from tempTahap3_OK_m3 " +
                        ") as C group by line " +
                        "union all " +
                        "select Line,round(M3,5)M3 from tempTahap3_BP_m3  " +
                        ") as D  group by line " +

                        " select [Group],Line ,cast(sum(M3) as decimal(10,5))M3 into tempBagiDefect_LP1_m3 from ( " +
                        " select case " +
                        //" when Line=1 then 'KA,KB,KC,KD' when Line=2 then 'KE,KF,KG,KH' when Line=3 then 'KI,KJ,KK,KL' "+
                        //" when Line=4 then 'KM,KN,KO,KP' when Line=5 then 'KQ,KR,KS,KT' when Line=6 then 'KU,KV,KW,KX' "+
                        " " + Query1 + " " +
                        " end [Group],Line,round(M3,2)M3 " +
                        " from tempBagiDefectLP_m3 " +
                        //" union all "+
                        //" select 'KA,KB,KC,KD'[Group],'1'Line,'0'M3 "+
                        //" union all "+
                        //" select 'KE,KF,KG,KH'[Group],'2'Line,'0'M3 "+
                        //" union all "+
                        //" select 'KI,KJ,KK,KL'[Group],'3'Line,'0'M3 "+
                        //" union all "+
                        //" select 'KM,KN,KO,KP'[Group],'4'Line,'0'M3 "+
                        //" union all "+
                        //" select 'KQ,KR,KS,KT'[Group],'5'Line,'0'M3 "+
                        //" union all "+
                        //" select 'KQ,KR,KS,KT'[Group],'6'Line,'0'M3 "+
                        " " + Query3 + " " +
                        " ) as x group by [Group],Line " +

                        " SELECT A.[Line],   " +
                        "    Split.a.value('.', 'VARCHAR(100)') AS [Group]  ,round((M3/4),2) M3 into tempBagiDefect_LP2_m3 " +
                        " FROM  (SELECT [Line],  " +
                        "        CAST ('<M>' + REPLACE([Group], ',', '</M><M>') + '</M>' AS XML) AS String  ,M3 " +
                        "    FROM  tempBagiDefect_LP1_m3) AS A CROSS APPLY String.nodes ('/M') AS Split(a); " +

                        " select [Group],M3 into tempBagiDefect_LP3_m3 from tempBagiDefect_LP2_m3 order by [group] " +

                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDefect_Prod_m3]') AND type in (N'U')) DROP TABLE [dbo].tempDefect_Prod_m3 " +

                        " select [Group],round(M3,2)M3 into tempDefect_Prod_m3 from ( " +
                        " select [Group],round(sum(M3),2)M3 from ( " +
                        " select * from detailDfctSystemBM_M3  " +
                        " union all " +
                        " select [Group],M3 from DtlDefectSystemFN_M3 " +
                        " union all " +
                        " select * from DtlSelisih_M3  " +
                        " union all " +
                        " select * from tempDefectUKhusus " +
                        " union all " +
                        " select * from tempBagiDefect_LP3_m3 " +
                        " ) as x group by [group] ) as x1 order by [group] " +
                        " /** End Defect ListPlank **/  " +

                        " /** Total Defect ListPlank OK **/ " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTtl_LP_OK]') AND type in (N'U')) DROP TABLE [dbo].tempTtl_LP_OK " +

                        " select round(sum(M3),4)M3 into tempTtl_LP_OK from tempTahap3_OK_m3 " +
                        //" select round(sum(M3),0)M3 into tempTtl_LP_OK from ( "+
                        //" select sum(M3)M3 from ( "+
                        //" select line,round(sum(M3),2)M3 from ( "+
                        //" select Line,round(M3,5)M3 from tempRSOut_m3 ) as x group by line "+
                        //" union all "+
                        //" select line,sum(M3)M3 from ( "+
                        //" /** 1 **/ "+
                        //" select Line,round(sum(M3),5)M3 from ( "+
                        //" select line,round(M3,5)M3 from tempSAwal_RS_m3 "+
                        //" union all "+
                        //" select Line,round(M3*-1,5) M3 from tempSAkhir_RS_m3 ) as x group by line "+
                        //" /** 1 **/ "+
                        //" union all "+
                        //" /** 2 **/ "+
                        //" select Line,sum(M3)M3 from ( "+
                        //" select * from tempSAwal_Bv_m3 "+
                        //" union all "+
                        //" select Line,M3*-1 M3 from tempSAkhir_Bv_m3 ) as x group by line "+
                        //" /** 2 **/ "+
                        //" union all "+
                        //" /** 3 **/ "+
                        //" select Line,round(sum(M3),5)M3 from ( "+
                        //" select Line,round(sum(M3),5)M3 from tempSAwal_Str_m3 group by line "+
                        //" union all "+
                        //" select Line,M3*-1 M3 from tempSAkhir_Str_m3 ) as x group by line  "+
                        //" /** 3 **/ "+
                        //" ) as A group by line ) as B group by line ) as x1 "+
                        " /** End Total Defect ListPlank OK **/ " +

                        " /** Data BS Tahap I **/ " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDataBSauto]') AND type in (N'U')) DROP TABLE [dbo].tempDataBSauto  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempKSBJNewBSAuto]') AND type in (N'U')) DROP TABLE [dbo].tempKSBJNewBSAuto  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempKSBJNewBSAuto1]') AND type in (N'U')) DROP TABLE [dbo].tempKSBJNewBSAuto1 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempKSBJNew]') AND type in (N'U')) DROP TABLE [dbo].tempKSBJNew  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempKSBJNew1]') AND type in (N'U')) DROP TABLE [dbo].tempKSBJNew1   " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempBSTahap1]') AND type in (N'U')) DROP TABLE [dbo].tempBSTahap1   " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDetailBSTahap1]') AND type in (N'U')) DROP TABLE [dbo].tempDetailBSTahap1  " +

                        " declare @periode varchar(10)  select @periode=left(convert(char,@thnbln1,112),6) " +

                        " select distinct itemid into tempDataBSauto from vw_KartuStockBJNew where itemid in (select ID from fc_items where partno like '%-s-%') and " +
                        " LokID in (select ID from FC_Lokasi where Lokasi='bsauto') " +

                        " select * into tempKSBJNewBSAuto from vw_KartuStockBJNew where left(CONVERT(char, tanggal ,112),6)=@periode and itemID in  " +
                        " (select itemid from tempDataBSauto)  " +
                        " select * into tempKSBJNew from vw_KartuStockBJNew where left(CONVERT(char, tanggal ,112),6)=@periode and itemID not in  " +
                        " (select itemid from tempDataBSauto) " +

                        " select sum(Qty)Qty,round(sum(Qty*Volume),2)M3 into tempKSBJNewBSAuto1 from ( " +
                        " select x.qty Qty,((x1.Tebal*x1.Lebar*x1.Panjang)/1000000000)Volume from ( " +
                        " select Qty,ItemID from tempKSBJNewBSAuto where (process='direct' or process like'%Simetris%') and (isnull(sfrom,'-')='-' or isnull(sfrom,'bevel')='-' " +
                        " or isnull(sfrom,'-')='straping') and lokid in (select ID from FC_Lokasi where Lokasi='BSAUTO') and substring(Keterangan,1,21) like '%-1-%' " +
                        " and left(convert(char,tanggal,112),6)=@periode and PartNo  like'%-S-%') as x inner join FC_Items x1 ON x.ItemID=x1.ID ) as A " +

                        " select sum(Qty)Qty,sum(Qty*Volume)M3 into tempKSBJNew1 from ( " +
                        " select x.qty Qty,((x1.Tebal*x1.Lebar*x1.Panjang)/1000000000)Volume from ( " +
                        " select Qty,ItemID from tempKSBJNew where (process='direct' or process like'%Simetris%') and (isnull(sfrom,'-')='-' or isnull(sfrom,'bevel')='-' " +
                        " or isnull(sfrom,'-')='straping') and lokid not in (select ID from FC_Lokasi where Lokasi='BSAUTO') and substring(Keterangan,1,21) like '%-1-%' " +
                        " and left(convert(char,tanggal,112),6)=@periode and PartNo  like'%-S-%') as x inner join FC_Items x1 ON x.ItemID=x1.ID ) as A " +

                        " select sum(Qty)Qty,round(sum(M3),4)M3 into tempBSTahap1 from ( " +
                        " select * from tempKSBJNewBSAuto1 union all " +
                        " select * from tempKSBJNew1 ) as x " +

                        " declare @TtlBS_Tahap1 varchar(10) " +
                        " set @TtlBS_Tahap1 = (select M3 from tempBSTahap1) " +

                        " select [Group],round((M3/@TtlDfctSystemBM_M3)* @TtlBS_Tahap1,4) M3 into tempDetailBSTahap1 from detailDfctSystemBM_M3 order by [group] " +
                        " /** end Data BS Tahap I **/ " +

                        " /** Total Potong QA **/ " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTotPotong_QA]') AND type in (N'U')) DROP TABLE [dbo].tempTotPotong_QA  " +

                        " select  B.[Group],round(sum(TPotongM3),2) TotPotongM3 into tempTotPotong_QA from BM_Destacking A left join BM_PlantGroup B on A.PlantGroupID=B.ID " +
                        " inner join (  select C.ID DestID , A.TPotong qtyin,A.TPotong*I.Volume as kubik,A.TPotong*I.Volume TPotongM3 from Def_Defect A  " +
                        " inner join BM_Destacking C on A.DestID=C.ID left join FC_Items I on I.ID=C.ItemID where A.Status>-1 and CONVERT(char,A.tgl,112)>=@thnbln1 and " +
                        " CONVERT(char,A.tgl,112)<=@thnbln2 ) as C  on A.ID=C.DestID group by B.[Group] " +
                        " /** End Total Potong QA **/ " +

                        " /** Total Potong Defect Ukuran Khusus **/ " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDef1_OKBP]') AND type in (N'U')) DROP TABLE [dbo].tempDef1_OKBP " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDef2_OKBP]') AND type in (N'U')) DROP TABLE [dbo].tempDef2_OKBP  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDef_Khusus_OKBP]') AND type in (N'U')) DROP TABLE [dbo].tempDef_Khusus_OKBP " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Link9]') AND type in (N'U')) DROP TABLE [dbo].Link9 " +

                        //" select * into tempDef1_OKBP from ( "+
                        //" select SUBSTRING(A.partno,1,9)Part,A.PartNo,x.*,((A.Tebal*A.Lebar*A.Panjang)/1000000000)*x.Qty M3 from ( "+
                        //" select ItemID,isnull(SUM(Qty),0)  * -1 Qty from vw_KartuStockBJNew where qty <0 and (process  like '%simetris%' ) and "+
                        //" (Keterangan like '%-3-%' or Keterangan like '%-w-%' or Keterangan like '%-m-%'or Keterangan like '%-P-%') and LokID not In "+
                        //" (select ID from FC_Lokasi where lokasi='q99')   and left(convert(char,tanggal,112),8)>=@thnbln1 "+
                        //" and left(convert(char,tanggal,112),8)<=@thnbln2 and ItemID in (select ID from FC_Items where PartNo like'%-1-%') "+
                        //" group by ItemID ) as x inner join FC_Items A ON A.ID=x.ItemID ) as xx "+

                        " select * into tempDef1_OKBP from (  select Part,SUBSTRING(Partno,1,17)Partno,sum(Qty)Qty,sum(M3)M3 from ( " +
                        " select SUBSTRING(x.PartNo2,1,9)Part,x.Keterangan Partno,PartNo2,x.Qty,((A.Tebal*A.Lebar*A.Panjang)/1000000000)*x.Qty M3 from ( " +
                        " select PartNo PartNo2,REPLACE(substring(replace(Keterangan1,',',''),0,19),'-3-','-1-')Keterangan,ItemID,sum(Qty)Qty from ( " +
                        " select  REPLACE(substring(Keterangan,0,19),'-P-','-1-')Keterangan1,PartNo,ItemID,isnull(SUM(Qty),0)  * -1 Qty " +
                        " from vw_KartuStockBJNew where qty <0 and (process  like '%simetris%' ) and  (Keterangan like '%-3-%' or Keterangan like '%-w-%' or  " +
                        " Keterangan like '%-m-%'or Keterangan like '%-P-%') and LokID not In  (select ID from FC_Lokasi where lokasi='q99') " +
                        " and left(convert(char,tanggal,112),8)>=@thnbln1  and left(convert(char,tanggal,112),8)<=@thnbln2 and ItemID in  " +
                        " (select ID from FC_Items where PartNo like'%-1-%')  group by ItemID,Keterangan,PartNo) as x group by Keterangan1,ItemID,PartNo ) as x " +
                        " inner join FC_Items A ON A.ID=x.ItemID ) as x1 group by Part,Partno ) as xx " +

                        //" select A.PartNo,A.Qty,case when B.Prosen2=100 then A.M3 else (B.Prosen2*A.M3)/100 end M3,B.Line,B.Prosen2 into tempDef2_OKBP " +
                        //" from tempDef1_OKBP A left join Def_UKhususProsen B ON A.PartNo=B.Partno where B.Noted='Defect ukuran khusus' " +
                        //" and left(convert(char,B.Periode,112),6)=left(convert(char,@thnbln1,112),6) " +
                        " " + New11 + " " +
                        " " + Old11 + " " +

                        " select Line,/**round(sum(Prosentase*M3),4)**/sum(M3)M3 into tempDef_Khusus_OKBP from ( " +
                        " select * /**,cast(Prosen2 as decimal(10,4))*0.01 Prosentase **/ from tempDef2_OKBP ) as x group by Line " +
                        " /** End Total Potong Defect Ukuran Khusus **/ " +

                        " /** Total Potong Defect ListPlank **/ " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDef_LP]') AND type in (N'U')) DROP TABLE [dbo].tempDef_LP " +

                        //" select Line,sum(M3)M3 into tempDef_LP from tempBagiDefectLP_m3 group by Line "+
                        " select Line,sum(M3)M3 into tempDef_LP from ( " +
                        " select line,sum(M3)M3 from ( " +
                        " select line,sum(M3)M3 from ( " +
                        " select line,round(sum(M3),2)M3 from ( " +
                        " select Line,round(M3,4)M3 from tempRSOut_m3 ) as x group by line " +
                        " union all " +
                        " select line,sum(M3)M3 from ( " +
                        " /** 1 **/ " +
                        " select Line,round(sum(M3),5)M3 from ( " +
                        " select line,round(M3,5)M3 from tempSAwal_RS_m3 " +
                        " union all " +
                        " select Line,round(M3*-1,5) M3 from tempSAkhir_RS_m3 ) as x group by line " +
                        " /** 1 **/ " +
                        " union all " +
                        " /** 2 **/ " +
                        " select Line,sum(M3)M3 from ( " +
                        " select * from tempSAwal_Bv_m3 " +
                        " union all " +
                        " select Line,M3*-1 M3 from tempSAkhir_Bv_m3 ) as x group by line " +
                        " /** 2 **/ " +
                        " union all " +
                        " /** 3 **/ " +
                        " select Line,round(sum(M3),2)M3 from ( " +
                        " select Line,round(sum(M3),3)M3 from tempSAwal_Str_m3 group by line " +
                        " union all " +
                        " select Line,M3*-1 M3 from tempSAkhir_Str_m3 ) as x group by line  " +
                        " /** 3 **/ " +
                        " ) as A group by line ) as B group by line) as C where m3>0 group by line  " +
                        " union all " +
                        //" select * from tempBagiDefectLP_m3 where m3>0 or m3<0 ) as A1 group by Line " +
                        " select Line,M3 * -1 M3 from tempTahap3_OK_m3 " +
                        " union all  " +
                        " select * from tempTahap3_BP_m3 " +
                        " union all " +
                        " select * from tempTahap3_OK_m3 " +
                        " ) as A1 group by Line  " +
                        " /** End Total Potong Defect ListPlank **/ " +

                        " /** Total Potong Defect ListPlank dan Defect Ukuran Khusus **/ " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTtlPot1_LPU]') AND type in (N'U')) DROP TABLE [dbo].tempTtlPot1_LPU " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTtlPot2_LPU]') AND type in (N'U')) DROP TABLE [dbo].tempTtlPot2_LPU " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTtlPot3_LPU]') AND type in (N'U')) DROP TABLE [dbo].tempTtlPot3_LPU " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTtlPot_LPU]') AND type in (N'U')) DROP TABLE [dbo].tempTtlPot_LPU " +

                        " select Line,sum(M3)M3 into tempTtlPot1_LPU from ( " +
                        " select * from tempDef_Khusus_OKBP " +
                        " union all " +
                        " select * from tempDef_LP ) as x group by Line " +

                        " select [Group],Line ,cast(sum(M3) as decimal(10,5))M3 into tempTtlPot2_LPU  from ( " +
                        " select case " +
                        //" when Line=1 then 'KA,KB,KC,KD' when Line=2 then 'KE,KF,KG,KH' when Line=3 then 'KI,KJ,KK,KL' when Line=4 then 'KM,KN,KO,KP' "+
                        //" when Line=5 then 'KQ,KR,KS,KT' when Line=6 then 'KU,KV,KW,KX' "+
                        " " + Query1 + " " +
                        " end [Group],Line,round(M3,5)M3 from tempTtlPot1_LPU " +
                        //" union all "+
                        //" select 'KA,KB,KC,KD'[Group],'1'Line,'0'M3 "+
                        //" union all "+
                        //" select 'KE,KF,KG,KH'[Group],'2'Line,'0'M3 "+
                        //" union all "+
                        //" select 'KI,KJ,KK,KL'[Group],'3'Line,'0'M3 "+
                        //" union all "+
                        //" select 'KM,KN,KO,KP'[Group],'4'Line,'0'M3 "+
                        //" union all "+
                        //" select 'KQ,KR,KS,KT'[Group],'5'Line,'0'M3 "+
                        //" union all "+
                        //" select 'KQ,KR,KS,KT'[Group],'6'Line,'0'M3 "+
                        " " + Query3 + " " +
                        " ) as x group by [Group],Line  " +

                        " SELECT A.[Line],   " +
                        "     Split.a.value('.', 'VARCHAR(100)') AS [Group]  ,round((M3/4),2) M3 into tempTtlPot3_LPU " +
                        " FROM  (SELECT [Line],  " +
                         "        CAST ('<M>' + REPLACE([Group], ',', '</M><M>') + '</M>' AS XML) AS String  ,M3 " +
                         "    FROM  tempTtlPot2_LPU) AS A CROSS APPLY String.nodes ('/M') AS Split(a); " +

                        " select [Group],round(M3,2)M3 into tempTtlPot_LPU from tempTtlPot3_LPU order by [group] " +
                        " /** End Total Potong Defect ListPlank dan Defect Ukuran Khusus **/ " +

                        " /** Total Potong System dan ListPlank **/ " +
                        " declare @TtlPot_LPSystem decimal(10,2) " +
                        " set @TtlPot_LPSystem = ( " +
                        " select round(sum(M3),0)M3 from ( " +
                        " select @TtlDfctBMFN_M3 M3 /**Defect_BP**/ union all " +
                        " select @TtlDfctBMFN_M3_OKKW M3 /**Defect_OK**/ union all " +
                        " select round(sum(M3),1)M3 /**Khusus_BP**/ from tempDefectUKhusus union all " +
                        " select round(sum(M3),1)M3 /**Khusus_OK**/ from tes1_OK union all " +
                        " select round(sum(M3),1)M3 /**ListPlank_BP**/ from tempBagiDefect_LP3_m3 union all " +
                        " select round(sum(M3),1)M3 /**ListPlank_OK**/ from tempTtl_LP_OK union all " +
                        " select round(sum(M3),1)M3 /**BS_BP**/ from tempBSTahap1 ) as x )  " +
                        " /** End Total Potong System dan ListPlank **/ " +

                        " /** Detail Total Potong System dan ListPlank **/ " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDtlTtlPot_LP]') AND type in (N'U')) DROP TABLE [dbo].tempDtlTtlPot_LP " +

                        " select [Group],round(sum(M3),1)M3 into tempDtlTtlPot_LP from ( " +
                        " select [Group],TotPotongM3 M3 from tempTotPotong_QA union all " +
                        " select * from tempTtlPot_LPU ) as x group by [Group] " +
                        " /** End Detail Total Potong System dan ListPlank **/  " +

                        " /** Selisih Total Potong **/ " +
                        " declare @TtlPot_Selisih decimal(10,2) " +
                        " declare @TtlPotSystem_ListPlank decimal(10,2) " +

                        " set @TtlPotSystem_ListPlank =(select sum(M3)M3 from tempDtlTtlPot_LP) " +
                        " set @TtlPot_Selisih = ( @TtlPot_LPSystem - @TtlPotSystem_ListPlank) " +
                        " /** End Selisih Total Potong **/ " +

                        " /** Total Group Produksi **/ " +
                        " declare @TtlGroup varchar(3) " +
                        " set @TtlGroup=(select count([Group])TtlGroup from ( " +
                        " select [Group] from ( " +
                        " select [Group] from detailDfctSystemBM_M3 union all " +
                        " select [Group] from DtlDefectSystemFN_M3 ) as x group by [Group] ) as x1) " +
                        " /** End Total Group Produksi **/ " +

                        " /** Detail Selisih Total Potong **/ " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[DtlSelisihTtlPot_LP]') AND type in (N'U')) DROP TABLE [dbo].DtlSelisihTtlPot_LP " +

                        " select [Group],round(@TtlPot_Selisih/@TtlGroup,1) M3 into DtlSelisihTtlPot_LP from ( " +
                        " select [Group] from detailDfctSystemBM_M3 union all " +
                        " select [Group] from DtlDefectSystemFN_M3 ) as x group by [Group] " +
                        " /** End Detail Selisih Total Potong **/ " +

                        " /** Detail Total Potong **/ " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDetail_TtlPot]') AND type in (N'U')) DROP TABLE [dbo].tempDetail_TtlPot " +

                        " select [Group],round(sum(M3),0)M3 into tempDetail_TtlPot from ( " +
                        " select * from tempDtlTtlPot_LP union all " +
                        " select * from DtlSelisihTtlPot_LP ) as x group by [Group] " +
                        " /** End Detail Total Potong **/ " +
                        " /** End Tambahan Baru **/ " +
                        " " +
                         QueryTotalPotong +
                        " " +
                        "declare @DefectFin decimal(18,2) " +
                        "set @DefectFin= (select sum(kubik) from (  " +
                        "select case when D.DeptID=0 then  " +
                        "case when GJ.GroupJemurName In ('M','N','O','P','Q','R','S','T','U','V','W','X') then   " +
                        "case when D.DefName='retak' then 2   " +
                        "when D.DefName='gompal' then 3  " +
                        "else D.DeptID end   " +
                        "else    " +
                        "case when (B.Qty/E.Qty) *100 >5 then 2 else 3 end   " +
                        "end  " +
                        "else D.DeptID end deptID1,A.CreatedTime as tglInput,A.Tgl as TglPeriksa,E.TglProduksi as TglProd,  D.DefCode,BP.PlantName as Line, PG.[Group],BF.FormulaCode as Jenis,   " +
                        "D.DefName,D.DeptID,B.ID,B.DefectID,B.MasterID,B.Qty,A.ID  DestID,isnull(A.TPotong,0)  QtyIn,B.Qty*I.Volume as Kubik,isnull(A.TPotong,0) as TotPotong,'' sfrom  " +
                        "from Def_DefectDetail B inner join Def_Defect A on A.Id=B.DefectID   " +
                        "left join Def_MasterDefect D on B.MasterID=D.ID left join BM_Destacking E on E.ID=A.DestID   " +
                        "left join BM_PlantGroup PG on A.GroupProdID=PG.ID left join BM_Formula BF on BF.ID=E.FormulaID    " +
                        "left join BM_Plant BP on BP.ID=E.PlantID left join FC_Items I on I.ID=E.ItemID inner join Def_GroupJemur GJ on GJ.ID=A.GroupJemurID  " +
                        "where B.RowStatus>-1  and D.RowStatus >-1) as Def    " +
                        "where DeptID1<>2 and CONVERT(varchar,TglPeriksa,112)>=@thnbln1 and CONVERT(varchar,TglPeriksa,112)<=@thnbln2) " +
                        " " +
                        "select * into tempdefectFin from ( " +
                        "select 'OKKW' fin, sum(qtyout) lembar,sum(qtyout * kubik)kubik from ( " +
                        "select I1.PartNo partno1,I1.Panjang * I1.Lebar luas1,  S.qtyin,I2.PartNo partno2,I2.Panjang * I2.Lebar luas2,  S.qtyout ,(I2.Tebal * I2.Panjang * I2.Lebar)/1000000000 kubik " +
                        "from t3_simetris S inner join T3_Serah Se on S.SerahID =Se.ID inner join fc_items I1 on Se.ItemID=I1.ID inner join fc_items I2 on S.ItemID=I2.id  " +
                        "where I2.lebar>500 and S.RowStatus>-1 and CONVERT(varchar,S.tgltrans,112)>=@thnbln1 and CONVERT(varchar,S.tgltrans,112)<=@thnbln2 )a where partno1 like '%-1-%' and luas1>=luas2*2 and partno2 like '%-p-%' " +
                        "union all " +
                        "select 'BP' fin, sum(qtyout) lembar,sum(qtyout * kubik)kubik from ( " +
                        "select I1.PartNo partno1,I1.Panjang * I1.Lebar luas1,  S.qtyin,I2.PartNo partno2,I2.Panjang * I2.Lebar luas2,  S.qtyout ,(I2.Tebal * I2.Panjang * I2.Lebar)/1000000000 kubik " +
                        "from t3_simetris S inner join T3_Serah Se on S.SerahID =Se.ID inner join fc_items I1 on Se.ItemID=I1.ID inner join fc_items I2 on S.ItemID=I2.id  " +
                        "where I2.lebar>500 and S.RowStatus>-1 and CONVERT(varchar,S.tgltrans,112)>=@thnbln1 and CONVERT(varchar,S.tgltrans,112)<=@thnbln2  )a where partno1 like '%-1-%' and luas1>=luas2*2 and  " +
                        "(partno2 like '%-3-%' or partno2 like '%-w-%' or partno2 like '%-m-%') " +
                        "union all " +
                        "select 'BS' fin,sum(R.QtyIn) Lembar,sum(R.QtyIn *((I.tebal*I.panjang*I.lebar)/1000000000)) kubik from T3_Rekap R inner join FC_Items I on R.ItemID=I.id inner join fc_lokasi L on R.LokID =L.id where R.RowStatus>-1 and  " +
                        "CONVERT(varchar,R.tgltrans,112)>=@thnbln1 and CONVERT(varchar,R.tgltrans,112)<=@thnbln2 and I.PartNo like '%-s-%' and Process='direct')A " +
                        " " +
                        "declare @TotalPotong decimal(18,2) " +
                        "declare @TotalDefKhusus decimal(18,2) " +
                        "declare @DefKhusus decimal(18,2) " +
                        "declare @Ttotalkw1kw2 decimal(18,2) " +
                        "declare @NCSortir decimal(18,2) " +
                        "declare @Retur decimal(18,2) " +
                        "set @TotalPotong=isnull((select sum(totkubik ) from tempdefectGPIsoTot),0) " +
                        "if @TotalPotong >0  " +
                        "begin " +
                        "set @TotalDefKhusus=isnull((select sum(kubik) from tempdefectFin),0) " +
                        "set @DefKhusus=isnull((select sum(kubik) from tempdefectFin where fin<>'bp'),0) " +
                        "set @Ttotalkw1kw2 =isnull((select sum(qtyin *((I.tebal*I.Lebar*I.Panjang)/1000000000)) from T3_Rekap R inner join fc_items I on R.itemid=I.ID  " +
                        "where R.rowstatus>-1 and R.Process  like '%simetris%' and CONVERT(varchar,R.tgltrans,112)>=@thnbln1 and CONVERT(varchar,R.tgltrans,112)<=@thnbln2   " +
                        "and I.lebar=1200 and I.panjang=2400 and R.keterangan like '%-p-%' and (I.partno like '%-3-%' or I.partno like '%-W-%' or I.partno like '%-M-%' )),0) " +
                        "set @NCSortir=isnull((select /*sum(QtyAkhirSS)+sum(QtyAkhirSE)*/sum(M3AkhirSS)+sum(M3AkhirSE) from (  " +
                        "SELECT B.tgltrans as Tanggal, I1.PartNo as PartnoAwal, sum(B.QtyIn) as QtyAwal,sum(I1.Volume*B.QtyIn) M3Awal,   " +
                        "I2.PartNo AS PartnoAkhir, case when B.NCSS>0 then sum(B.QtyOut) else 0 end QtyAkhirSS,  " +
                        "case when B.NCSS>0 then sum(I2.Volume*B.QtyOut) else 0 end M3AkhirSS,case when B.NCSE>0 then sum(B.QtyOut) else 0 end QtyAkhirSE,  " +
                        "case when B.NCSE>0 then sum(I2.Volume*B.QtyOut) else 0 end M3AkhirSE,B.NCSS,B.NCSE  FROM T3_Serah AS A   " +
                        "INNER JOIN T3_Simetris AS B ON A.ID = B.SerahID INNER JOIN FC_Items AS I1 ON A.ItemID = I1.ID INNER JOIN   " +
                        "FC_Items AS I2 ON B.ItemID = I2.ID LEFT JOIN T3_GroupM AS D ON B.GroupID = D.ID   " +
                        "where (B.NCSS>0 or B.NCSE>0) and B.rowstatus>-1 and CONVERT(varchar,B.tgltrans,112)>=@thnbln1 and CONVERT(varchar,B.tgltrans,112)<=@thnbln2   " +
                        "group by B.tgltrans,I1.PartNo,I2.PartNo,B.NCSS,B.NCSE) S),0) " +

                        //"set @Retur=isnull((select sum(qty) from ( " +
                        //"select sum(qty *(I.tebal*I.panjang*I.lebar)/1000000000) qty from t3_retur R inner join fc_items I on R.itemid=I.id where R.rowstatus>-1 and  " +
                        //"R.typer=1 and (I.partno like '%-p-%' or I.partno like '%-S-%')  and CONVERT(varchar,R.tgltrans,112)>=@thnbln1 and CONVERT(varchar,R.tgltrans,112)<=@thnbln2  " +
                        //"union all " +
                        //"select sum(qty *(I.tebal*I.panjang*I.lebar)/1000000000)*-1 qty from t3_retur R inner join fc_items I on R.itemid=I.id where R.rowstatus>-1 and  " +
                        //"R.typer=2 and (I.partno like '%-p-%' or I.partno like '%-S-%')and CONVERT(varchar,R.tgltrans,112)>=@thnbln1 and CONVERT(varchar,R.tgltrans,112)<=@thnbln2 " +
                        //"union all " +
                        //"select sum(qty *(I.tebal*I.panjang*I.lebar)/1000000000) qty from t3_returO R inner join fc_items I on R.itemid=I.id where R.rowstatus>-1 and  " +
                        //"(I.partno like '%-p-%' or I.partno like '%-S-%') and CONVERT(varchar,R.tgltrans,112)>=@thnbln1 and CONVERT(varchar,R.tgltrans,112)<=@thnbln2)A),0) " +
                        //" " +

                        "set @Retur=isnull((select round((TotK1-TotK2)+TotK3,2)TotM3 from ( " +
                        "select round(sum(Volume*Tot1),3)TotK1,round(sum(Volume*Tot2),3)TotK2,round(sum(Volume*Tot3),3)TotK3 from ( " +
                        "select tanggal,PartNo,volume ,sum(isnull(QtyC1,0))QtyC1,sum(isnull(QtyP1,0)) QtyP1,sum(isnull(QtyS1,0)) QtyS1, " +
                        "sum(isnull(Tot1,0)) Tot1,sum(isnull(TotK1,0)) TotK1, sum(isnull(QtyC2,0)) QtyC2,sum(isnull(QtyP2,0)) QtyP2, " +
                        "sum(isnull(QtyS2,0)) QtyS2,sum(isnull(Tot2,0)) Tot2, sum(isnull(TotK2,0)) TotK2,sum(isnull(QtyC3,0)) QtyC3, " +
                        "sum(isnull(QtyP3,0)) QtyP3,sum(isnull(QtyS3,0)) QtyS3,sum(isnull(Tot3,0)) Tot3,sum(isnull(TotK3,0)) TotK3 from ( " +
                        "select tanggal ,PartNo,volume,case when typeR=1 and ((KW='3' or KW='W')or lokasi='cl') then Qty end QtyC1, " +
                        "case when typeR=1 and (KW='P'and lokasi <> 'cl') then Qty end QtyP1, case when typeR=1 and (KW='S'and lokasi <> 'cl') " +
                        "then Qty end QtyS1, case when typeR=1 and ((KW='P' or KW='S') and lokasi <> 'cl') then Qty end Tot1, " +
                        "case when typeR=1 and (KW='P' or KW='S') then QtyK end TotK1, case when typeR=2 and ((KW='3' or KW='W')or lokasi='cl') " +
                        "then Qty end QtyC2, case when typeR=2 and (KW='P' and lokasi <> 'cl') then Qty end QtyP2, case when typeR=2 and (KW='S' and " +
                        "lokasi <> 'cl') then Qty end QtyS2, case when typeR=2 and ((KW='P' or KW='S') and lokasi <> 'cl') then Qty end Tot2, " +
                        "case when typeR=2 and ((KW='P' or KW='S') and lokasi <> 'cl') then QtyK end TotK2, case when typeR=3 and ((KW='3' or KW='W') " +
                        "or lokasi='cl') then Qty end QtyC3, case when typeR=3 and (KW='P' and lokasi <> 'cl') then Qty end QtyP3, " +
                        "case when typeR=3 and (KW='S' and lokasi <> 'cl') then Qty end QtyS3, case when typeR=3 and ((KW='P' or KW='S') and lokasi <> 'cl') " +
                        "then Qty   end Tot3, case when typeR=3 and ((KW='P' or KW='S') and lokasi <> 'cl') then QtyK end TotK3 from (  " +
                        "select R.TglTrans tanggal,I.PartNo,I.volume,SUBSTRING(I.partno,5,1) as KW,sum(R.Qty)Qty,sum(((I.Panjang*I.Lebar)/(1220*2440) ) * R.Qty) QtyK, " +
                        "isnull(R.TypeR,1)  TypeR,I.ID,L.Lokasi     from T3_Retur R inner join FC_Items I on R.ItemID =I.ID  " +
                        "inner join FC_lokasi L on R.LokID=L.ID  where R.RowStatus>-1     group by R.TglTrans,I.PartNo,I.volume,R.TypeR,I.ID,L.Lokasi " +
                        "union all select R.TglTrans tanggal,I.PartNo,I.volume,SUBSTRING(I.partno,5,1) as KW,sum(R.Qty)Qty,sum(((I.Panjang*I.Lebar)/(1220*2440))* R.Qty) " +
                        "QtyK,3  TypeR,I.ID,L.Lokasi     from T3_ReturO R inner join FC_Items I on R.ItemID =I.ID  inner join FC_lokasi L on R.LokID=L.ID " +
                        "where R.RowStatus>-1     group by R.TglTrans,I.PartNo,I.volume,I.ID,L.Lokasi ) as A ) as B " +
                        "where convert(char,tanggal,112)>=@thnbln1 and convert(char,tanggal,112)<=@thnbln2 group by tanggal,PartNo,volume ) as x ) as x1),0) " +

                        "declare @TotalPotongL1 decimal(18,2) " +
                        "declare @TotDefKhususL1 decimal(18,2) " +
                        "declare @DefKhususL1 decimal(18,2) " +
                        "declare @Ttotalkw1kw2L1 decimal(18,2) " +
                        "declare @NCSortirL1 decimal(18,2) " +
                        "declare @ReturL1 decimal(18,2) " +
                        "declare @DefectFinL1 decimal(18,2) " +

                        "set @TotalPotongL1=(select isnull(sum(totkubik ),0) from tempdefectGPIsoTot where [group]in (select [group] from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 1'))) " +
                        "set @TotDefKhususL1=(@TotalPotongL1/@TotalPotong)*@TotalDefKhusus " +
                        "set @DefKhususL1=(@TotalPotongL1/@TotalPotong)*@DefKhusus " +
                        "set @Ttotalkw1kw2L1=(@TotalPotongL1/@TotalPotong)*@Ttotalkw1kw2 " +
                        "set @NCSortirL1=(@TotalPotongL1/@TotalPotong)*@NCSortir " +
                        "set @ReturL1=(@TotalPotongL1/@TotalPotong)*@Retur " +
                        "set @DefectFinL1=isnull((@TotalPotongL1/@TotalPotong)*@DefectFin,0) " +

                        " /** Tambahan OK KM **/ " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempOKKM_m3]') AND type in (N'U')) DROP TABLE [dbo].tempOKKM_m3 " +
                        " select [Group],round((M3/@TtlDfctSystemBM_M3)*@Ttotalkw1kw2,2) M3 into tempOKKM_m3 from detailDfctSystemBM_M3 order by [group] " +
                        " /** End Tambahan **/ " +

                        " /** Tambahan Sortir **/ " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempSortir_m3]') AND type in (N'U')) DROP TABLE [dbo].tempSortir_m3 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempSortir_1_m3]') AND type in (N'U')) DROP TABLE [dbo].tempSortir_1_m3 " +

                        " select [Group],round((M3/@TtlDfctSystemBM_M3)*@NCSortir,4) M3 into tempSortir_m3 from detailDfctSystemBM_M3 order by [group] " +

                        " select [Group],round(M3,4)M3 into tempSortir_1_m3 from ( " +
                        " select [Group],round(M3,4)M3 from ( " +
                        " select * from tempSortir_m3 ) as x ) as x1 " +
                        " /** End Tambahan **/ " +

                        " /** Tambahan Return **/ " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempRetur_m3]') AND type in (N'U')) DROP TABLE [dbo].tempRetur_m3 " +
                        " select [Group],round((M3/@TtlDfctSystemBM_M3)*@Retur,4) M3 into tempRetur_m3 from detailDfctSystemBM_M3 order by [group] " +
                        " /** End Tambahan **/ " +

    /** Tambahan 15 April 2021 **/

    /** Baru **/

    //select @TtlDfctBMFN_M3 /** Total Defect **/
    //select @TtlDefectBM_M3 /** Total Defect System BM **/
    //select @TtlDfctSystemFN_M3 /** Total Defect System Finishing **/
    //select sum(m3)m3 from tes1 /** Total Defect Ukuran Khusus **/
    //select sum(m3) from tempBagiDefectLP_m3 /** Total Defect ListPlank **/

    "declare @SelisihTtlDefect varchar(30) " +

    "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[DetailSTtlDefect]') AND type in (N'U')) DROP TABLE [dbo].DetailSTtlDefect  " +
    "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[DetailDefectBMFin]') AND type in (N'U')) DROP TABLE [dbo].DetailDefectBMFin  " +

    "set @SelisihTtlDefect = @TtlDfctBMFN_M3 - @TtlDefectBM_M3 - @TtlDfctSystemFN_M3 - (select sum(m3) from tes1) - (select sum(m3) from tempBagiDefectLP_m3) " +

    /** Detail Selisih Total Defect **/
    "select [Group],round(((m3/@TtlDefectBM_M3)* @SelisihTtlDefect),1)M3 into DetailSTtlDefect from detailDfctSystemBM_M3 order by [Group]  " +

    /** Detail Defect BM + Finishing **/
    "select [Group],round(sum(M3),1)M3 into DetailDefectBMFin from ( " +
    "select * from detailDfctSystemBM_M3 union all " +
    "select * from DtlDefectSystemFN_M3 union all " +
    "select * from DetailSTtlDefect ) as x group by [group] " +


    /** Detail Defect Ukuran Khusus **/
    "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Bm01]') AND type in (N'U')) DROP TABLE [dbo].Bm01 " +
    "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Bm02]') AND type in (N'U')) DROP TABLE [dbo].Bm02   " +
    "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Bm03]') AND type in (N'U')) DROP TABLE [dbo].Bm03 " +
    "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Bm04]') AND type in (N'U')) DROP TABLE [dbo].Bm04 " +
    "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Bm05]') AND type in (N'U')) DROP TABLE [dbo].Bm05 " +
    "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Dataxx]') AND type in (N'U')) DROP TABLE [dbo].Dataxx " +
    "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Dataxxx]') AND type in (N'U')) DROP TABLE [dbo].Dataxxx " +
    "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Dataxx01]') AND type in (N'U')) DROP TABLE [dbo].Dataxx01 " +
    "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Dataxx02]') AND type in (N'U')) DROP TABLE [dbo].Dataxx02 " +
    "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Dataxx03]') AND type in (N'U')) DROP TABLE [dbo].Dataxx03 " +
    "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[DetailDefectKhusus]') AND type in (N'U')) DROP TABLE [dbo].DetailDefectKhusus " +

     "select * into Bm01 from ( " +
    "select distinct ItemID,PlantID,left(convert(char,tglproduksi,112),6)ThnBln from BM_Destacking where RowStatus>-1 group by ItemID,PlantiD,TglProduksi  " +
    ") as x order by ThnBln,ItemID desc " +

    "select x.*,x1.PartNo into Bm02 from ( " +
    "select *,(select count(ItemID) from Bm01 B where B.ItemID=A.ItemID and B.ThnBln=A.ThnBln and ItemID>0)ttl from Bm01 A where ItemID>0) as x inner join FC_Items x1 ON x1.ID=x.ItemID " +

    "select *,case when ttl=0 then 0 else cast(100 as decimal(10,2))/cast(ttl as decimal(10,2)) end PerSen into Bm03 from Bm02 order by ThnBln desc " +

    "select ItemID into Dataxx  from ( " +
    "select A.ID ItemID from ( " +
    " select distinct PartNo from vw_KartuStockBJNew  where qty <0 and (process  like '%simetris%' ) and  (Keterangan like '%-P-%') and  LokID not In (select ID from FC_Lokasi where lokasi='q99')   and left(convert(char,tanggal,112),6)=SUBSTRING(@thnbln1,1,6) and ItemID in (select ID  from FC_Items where PartNo like'%-1-%')) as x inner join FC_Items A ON A.PartNo=x.PartNo ) as xx " +

    "select B.PlantID,B.PerSen into Dataxxx from Dataxx A left join Bm03 B ON B.ItemID=A.ItemID where B.ThnBln=SUBSTRING(@thnbln1,1,6) " +
    "select distinct PlantID,'1'Flag into Dataxx01 from Dataxxx " +

    "select [Group],sum(cast(Flag as int)) Flag,Line into Dataxx02 from ( " +
    " select case  " +
    " when PlantID=1 then 'CA,CB,CC,CD'  " +
    " when PlantID=2 then 'CE,CF,CG,CH'  " +
    " when PlantID=3 then 'CI,CJ,CK,CL'  " +
    " when PlantID=4 then 'CM,CN,CO,CP'   " +
    " end [Group],Flag,PlantID Line from Dataxx01 " +
    " union all  select 'CA,CB,CC,CD'[Group],'0'Flag,'1'Line " +
    " union all  select 'CE,CF,CG,CH'[Group],'0'Flag,'2'Line " +
    " union all  select 'CI,CJ,CK,CL'[Group],'0'Flag,'3'Line " +
    " union all  select 'CM,CN,CO,CP'[Group],'0'Flag,'4'Line ) as x group by [Group],Line " +

    " SELECT A.[Line],A.Flag,Split.a.value('.', 'VARCHAR(100)') AS [Group]  into Dataxx03   FROM  (SELECT [Line],Flag,CAST ('<M>' + REPLACE([Group], ',', '</M><M>') + '</M>' AS XML) AS String FROM  Dataxx02) AS A CROSS APPLY String.nodes ('/M') AS Split(a);  " +

    " select [Group],case when Flag >0 then (select sum(m3) from tes1)/(select @TtlGroup) else 0 end M3 into DetailDefectKhusus from Dataxx03  " +



    /** Detail Defect ListPlank **/
    " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[TempBm01]') AND type in (N'U')) DROP TABLE [dbo].TempBm01 " +
    "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[TempBm02]') AND type in (N'U')) DROP TABLE [dbo].TempBm02 " +
    "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[TempBm03]') AND type in (N'U')) DROP TABLE [dbo].TempBm03 " +
    "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[TempBm04]') AND type in (N'U')) DROP TABLE [dbo].TempBm04 " +
    "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[TempBm05]') AND type in (N'U')) DROP TABLE [dbo].TempBm05 " +
    "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[TempBm06]') AND type in (N'U')) DROP TABLE [dbo].TempBm06 " +
    "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[TempBm07]') AND type in (N'U')) DROP TABLE [dbo].TempBm07 " +
    "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[TempBm08]') AND type in (N'U')) DROP TABLE [dbo].TempBm08 " +
    "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[TempBm09]') AND type in (N'U')) DROP TABLE [dbo].TempBm09 " +
    "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[TempBm10]') AND type in (N'U')) DROP TABLE [dbo].TempBm10 " +
    "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[DetailDefectListPlank]') AND type in (N'U')) DROP TABLE [dbo].DetailDefectListPlank " +

    "select A.*,B.ID ItemID into TempBm01 from ( " +
    "select PartNo,SUBSTRING(PartNo,7,3)/10 Tebal,SUBSTRING(PartNo,1,3)Jenis from ( " +
    "select PartNo from tesLPRs1_m3 union all " +
    "select PartNo from tesSAwal_RS_m3 union all " +
    "select PartNo from tesSAkhir_RS union all " +
    "select PartNo from tesSAwal_Bv union all " +
    "select PartNo from tesSAkhir_Bv union all " +
    "select PartNo from tesSAwal_Str union all " +
    "select PartNo from tesSAkhir_Str union all " +
    "select PartNo from tesSAkhir_Str union all " +
    "select PartNo from tesTahap3_OK union all " +
    "select PartNo from tesTahap3_BP ) as x group by PartNo  " +
    ") as A inner join FC_Items B ON A.PartNo=B.PartNo " +

    " select x.*,SUBSTRING(x1.PartNo,1,3)Kode into TempBm02 from ( " +
    "select distinct ItemID,PlantID,left(convert(char,tglproduksi,112),6)ThnBln from BM_Destacking where RowStatus>-1 and LokasiID not in (select ID from FC_Lokasi where Lokasi like'%adj%' ) group by ItemID,PlantiD,TglProduksi  " +
    ") as x inner join FC_Items x1 ON x.ItemID=x1.ID " +

    "select *,SUBSTRING(@thnbln1,1,6)ThnBln into TempBm03 from ( " +
    "select Kode,PlantID  from ( " +
    "select Kode,PlantID from TempBm02 where ThnBln=SUBSTRING(@thnbln1,1,6) and kode in (select Jenis from TempBm01)) as x group by Kode,PlantID " +
    "union all " +
    "select Jenis,'0'PlantID from TempBm01 where Jenis not in (select Kode from TempBm02 where ThnBln=SUBSTRING(@thnbln1,1,6))) as xx  " +

    "select xx.Kode,AA.PlantID,AA.ThnBln into TempBm04 from ( " +
    "select Kode,PlantID  from ( " +
    "select Kode,PlantID from TempBm02 where ThnBln=SUBSTRING(@thnbln1,1,6) and kode in (select Jenis from TempBm01)) as x group by Kode,PlantID " +
    "union all " +
    "select Jenis,'0'PlantID from TempBm01 where Jenis not in (select Kode from TempBm02 where ThnBln=SUBSTRING(@thnbln1,1,6))) as xx left join TempBm02 AA ON AA.Kode=xx.Kode where xx.PlantID=0  group by xx.Kode,AA.PlantID,AA.ThnBln order by ThnBln desc " +

    "select Kode,COUNT(PlantID)Ttl,ThnBln into TempBm06 from ( " +
    "select * from TempBm04 ) as x group by Kode,ThnBln " +

    "select *,case when PlantID=0 then (select top 1 ThnBln from TempBm06 order by ThnBln desc) else '0' end ThnBln2 into TempBm07 from TempBm03 A " +

    "select PlantID,'1'flag into TempBm08 from ( " +
    "select B.Kode,B.PlantID from TempBm07 A inner join TempBm04 B ON A.Kode=B.Kode and A.ThnBln2=B.ThnBln " +
    "union all " +
    "select Kode,PlantID from TempBm07 where PlantID>0 ) as x " +

    "select [Group],Line,sum(cast(flag as int))Flag  into TempBm09 from ( " +
    "select case  " +
    " when PlantID=1 then 'CA,CB,CC,CD'  " +
    " when PlantID=2 then 'CE,CF,CG,CH' " +
    " when PlantID=3 then 'CI,CJ,CK,CL' " +
    " when PlantID=4 then 'CM,CN,CO,CP'   " +
    "end [Group],PlantID Line,flag from TempBm08   " +
    " union all  select 'CA,CB,CC,CD'[Group],'1'Line,'0'Flag " +
    " union all  select 'CE,CF,CG,CH'[Group],'2'Line,'0'Flag " +
    " union all  select 'CI,CJ,CK,CL'[Group],'3'Line,'0'Flag " +
    " union all  select 'CM,CN,CO,CP'[Group],'4'Line,'0'Flag " +
    " ) as x group by [Group],Line  " +

    "SELECT A.[Line],A.Flag,Split.a.value('.', 'VARCHAR(100)') AS [Group] into  TempBm10  FROM  (SELECT [Line],Flag,CAST ('<M>' + REPLACE([Group], ',', '</M><M>') + '</M>' AS XML) AS String FROM  TempBm09) AS A CROSS APPLY String.nodes ('/M') AS Split(a);  " +

    "select [Group],case when Flag >0 then (select sum(M3) from tempBagiDefect_LP2_m3)/(select @TtlGroup) else 0 end M3 into DetailDefectListPlank from TempBm10 " +



    /** Detail Defect Produksi **/
    "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDetailDP]') AND type in (N'U')) DROP TABLE [dbo].tempDetailDP " +

    "select [Group],sum(M3)M3 into tempDetailDP from ( " +
    "select * from DetailDefectBMFin union all " +
    "select * from DetailDefectKhusus union all " +
    "select * from DetailDefectListPlank ) as x group by [group] " +

    /** Detail BS Tahap-1 **/
    //"--select * from tempDetailBSTahap1

    /** Detail Total Defect **/
    "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDetailTotalDefect]') AND type in (N'U')) DROP TABLE [dbo].tempDetailTotalDefect " +

    "select [Group],sum(M3)M3 into tempDetailTotalDefect from ( " +
    "select [Group],sum(Kubik) M3 from tempdefectGPIso2  group by [Group] union all " +
    "select [Group],M3 from detailDfctSystemBM_M3 union all " +
    "select [Group],M3 from DetailDefectBMFin  union all " +
    "select [Group],M3 from DetailDefectKhusus union all " +
    "select [Group],M3 from DetailDefectListPlank  union all " +
    "select [Group],M3 from tempDetailBSTahap1 ) as x group by [Group] " +

    /** Detail Total Defect Produksi **/
    "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDetailTotalDefectProd]') AND type in (N'U')) DROP TABLE [dbo].tempDetailTotalDefectProd " +

    "select [Group],sum(M3)M3 into tempDetailTotalDefectProd from ( " +
    "select * from DetailDefectListPlank union all " +
    "select * from DetailDefectBMFin union all " +
    "select * from Dataxx04 ) as x group by [Group] " +

    /** Detail Total potong system QA **/
    //--select * from tempTotPotong_QA

    /** Detail Total potong system QA **/
    "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTotalDefect2]') AND type in (N'U')) DROP TABLE [dbo].tempTotalDefect2 " +

    "select sum(M3)M3 into tempTotalDefect2 from ( " +
    " select sum(M3)M3 from tes1 union all " +
    "  select sum(M3)M3 from tes1_OK union all " +
    "  select sum(M3)M3 from tempTtl_LP_OK union all  " +
    "  select sum(m3)M3 from tempBagiDefectLP_m3) as x " +

     /** Total potong ListPlank dan Ukuran Khusus **/
     " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTotPotLU]') AND type in (N'U')) DROP TABLE [dbo].tempTotPotLU " +
     " select [Group],case when M3>0 then ((select * from tempTotalDefect2)/(select @TtlGroup)) else 0 end M3 into tempTotPotLU from tempDetailTotalDefectProd " +

    /** Total potong System dan ListPlank **/
    "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTotPotSystemLP]') AND type in (N'U')) DROP TABLE [dbo].tempTotPotSystemLP " +

    "select [Group],sum(M3)M3 into tempTotPotSystemLP from ( " +
    "select  [Group],TotPotongM3 M3 from tempTotPotong_QA union all " +
    "select [Group],M3 from tempTotPotLU ) as x group by [Group] " +

    /** Selisih Total Potong **/
    "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempSelisihTP]') AND type in (N'U')) DROP TABLE [dbo].tempSelisihTP " +
    "declare @SelisihTP varchar(30) " +
    "set @SelisihTP=(select (select sum(M3) from tempDetail_TtlPot) - (select sum(M3) from tempTotPotSystemLP)) " +

    "select [Group],case when M3>0 then (select cast(@SelisihTP as decimal(10,2)))/(select @TtlGroup) else 0 end M3 into tempSelisihTP from tempDetailTotalDefectProd " +

    /** Total Potong **/
    "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTotalPotong]') AND type in (N'U')) DROP TABLE [dbo].tempTotalPotong " +
    "select [Group],sum(M3)M3 into tempTotalPotong from ( " +
    "select * from tempSelisihTP union all " +
    "select * from tempTotPotSystemLP ) as x group by [Group] " +

    /** Detail OK KM **/
    "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempOKKM]') AND type in (N'U')) DROP TABLE [dbo].tempOKKM " +

    "select [Group], (M3/(select sum(M3) from detailDfctSystemBM_M3))*(select sum(M3) from tempOKKM_m3)M3 into tempOKKM from detailDfctSystemBM_M3 " +
                        /** End Baru **/


                        #region Line -1
                        "if @TotalPotongL1>0 " +
                        "begin " +
                        "select [Group],round(b,4)b,round(c,4)c,round(d,4)d,round(e,4)e,round(f,4)f,round(g,4)g,round(i,4)i,j into tempdefectL1 from ( " +
                        "select *,/**c-d+e+f+g i**/ (c+e+f+g)-d i,case when b>0 then round(((c-d+e+f+g)/b)*100,1) else 0  end j from ( " +
                        "select [Group], " +
                        //"case when @TotalPotongL1>0 then isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) +  " +
                        //"  (( isnull(( select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@TotDefKhususL1)  else 0 end b, " +
                        " case when @TotalPotongL1>0 then isnull((select round(M3,5)M3 from tempTotalPotong where [group]=BM_PlantGroup.[Group] ),0)  else 0 end b, " +
                        //" case when @TotalPotongL1>0 then isnull((select totdefectK from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)  else 0 end c, " +
                        " case when @TotalPotongL1>0 then isnull((select round(M3,5)M3 from tempDetailDP where [group]=BM_PlantGroup.[Group] ),0)  else 0 end c, " +
                        //" case when @TotalPotongL1>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@Ttotalkw1kw2L1) else 0 end  d, " +
                        " case when @TotalPotongL1>0 then ((isnull((select round(M3,5)M3 from tempOKKM where [group]=BM_PlantGroup.[Group] ),0))) else 0 end  d,  " +
                        //" case when @TotalPotongL1>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@NCSortirL1)  else 0 end  e, " +
                        " case when @TotalPotongL1>0 then ((isnull((select round(M3,5)M3 from tempSortir_1_m3 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  e, " +
                        //" case when @TotalPotongL1>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@ReturL1)  else 0 end  f, " +
                        " case when @TotalPotongL1>0 then ((isnull((select round(M3,5)M3 from tempRetur_m3 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  f, " +
                        //" case when @TotalPotongL1>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@DefectFinL1)  else 0 end g, " +
                        " case when @TotalPotongL1>0 then ((isnull((select round(M3,5)M3 from tempDetailBSTahap1 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end g  " +
                        //" case when @TotalPotongL1>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@DefKhususL1) else 0 end  h " +
                        " from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 1') )A " +

                        "union all  " +

                        "select 'Total' [Group],sum(b)b,sum(c)c,sum(d)d,sum(e)e,sum(f)f,sum(g)g,/**sum(c)-sum(d)+sum(e)+sum(f)+sum(g) i**/ (sum(c)+sum(e)+sum(f)+sum(g))-sum(d) i" +
                        ",case when sum(b)>0 then round((sum(c)-sum(d)+sum(e)+sum(f)+sum(g))/sum(b)*100,1) else 0 end j from( " +
                        "select [Group], " +
                        //" case when @TotalPotongL1>0 then isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) +  " +
                        //"  (( isnull(( select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@TotDefKhususL1)  else 0 end b, " +
                        " case when @TotalPotongL1>0 then isnull((select round(M3,4)M3 from tempTotalPotong where [group]=BM_PlantGroup.[Group] ),0)  else 0 end b,  " +
                        //" case when @TotalPotongL1>0 then isnull((select totdefectK from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)  else 0 end c, " +
                        " case when @TotalPotongL1>0 then isnull((select round(M3,4)M3 from tempDetailDP where [group]=BM_PlantGroup.[Group] ),0)  else 0 end c,  " +
                        //" case when @TotalPotongL1>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@Ttotalkw1kw2L1) else 0 end  d, " +
                        " case when @TotalPotongL1>0 then ((isnull((select round(M3,4)M3 from tempOKKM where [group]=BM_PlantGroup.[Group] ),0))) else 0 end  d, " +
                        //" case when @TotalPotongL1>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@NCSortirL1)  else 0 end  e, " +
                        " case when @TotalPotongL1>0 then ((isnull((select round(M3,4)M3 from tempSortir_1_m3 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  e,  " +
                        //" case when @TotalPotongL1>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@ReturL1)  else 0 end  f, " +
                        " case when @TotalPotongL1>0 then ((isnull((select round(M3,4)M3 from tempRetur_m3 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  f,  " +
                        //" case when @TotalPotongL1>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@DefectFinL1)  else 0 end g, " +
                        " case when @TotalPotongL1>0 then ((isnull((select round(M3,4)M3 from tempDetailBSTahap1 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end g,  " +
                        //" case when @TotalPotongL1>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@DefKhususL1) else 0 end  h, " +
                        " 0 i,0 j from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 1'))A )B " +
                        " end " +
                        " else " +
                        " begin " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 i, 0 j into tempdefectL1 " +
                        " end " +
                        #endregion
 " " +
                        "declare @TotalPotongL2 decimal(18,2) " +
                        "declare @TotDefKhususL2 decimal(18,2) " +
                        "declare @DefKhususL2 decimal(18,2) " +
                        "declare @Ttotalkw1kw2L2 decimal(18,2) " +
                        "declare @NCSortirL2 decimal(18,2) " +
                        "declare @ReturL2 decimal(18,2) " +
                        "declare @DefectFinL2 decimal(18,2) " +
                        "set @TotalPotongL2=(select isnull(sum(totkubik ),0) from tempdefectGPIsoTot where [group]in (select [group] from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 2'))) " +
                        " " +
                        "set @TotDefKhususL2=(@TotalPotongL2/@TotalPotong)*@TotalDefKhusus " +
                        "set @DefKhususL2=(@TotalPotongL2/@TotalPotong)*@DefKhusus " +
                        "set @Ttotalkw1kw2L2=(@TotalPotongL2/@TotalPotong)*@Ttotalkw1kw2 " +
                        "set @NCSortirL2=(@TotalPotongL2/@TotalPotong)*@NCSortir " +
                        "set @ReturL2=(@TotalPotongL2/@TotalPotong)*@Retur " +
                        "set @DefectFinL2=isnull((@TotalPotongL2/@TotalPotong)*@DefectFin,0) " +

                        #region Line - 2
 "if @TotalPotongL2>0 " +
                        "begin " +
                        "select [Group],round(b,4)b,round(c,4)c,round(d,4)d,round(e,4)e,round(f,4)f,round(g,4)g,round(i,4)i,j into tempdefectL2 from ( " +
                        "select *,/**c-d+e+f+g i**/ (c+e+f+g)-d i,case when b>0 then round((c-d+e+f+g)/b*100,1) else 0  end j from ( " +
                        " select [Group], " +
                        " case when @TotalPotongL2>0 then isnull((select round(M3,5)M3 from tempTotalPotong where [group]=BM_PlantGroup.[Group] ),0)  else 0 end b,  " +
                        " case when @TotalPotongL2>0 then isnull((select round(M3,5)M3 from tempDetailDP where [group]=BM_PlantGroup.[Group] ),0)  else 0 end c,  " +
                        " case when @TotalPotongL2>0 then ((isnull((select round(M3,5)M3 from tempOKKM where [group]=BM_PlantGroup.[Group] ),0))) else 0 end  d, " +
                        " case when @TotalPotongL2>0 then ((isnull((select round(M3,5)M3 from tempSortir_1_m3 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  e,  " +
                        " case when @TotalPotongL2>0 then ((isnull((select round(M3,5)M3 from tempRetur_m3 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  f,  " +
                        " case when @TotalPotongL2>0 then ((isnull((select round(M3,5)M3 from tempDetailBSTahap1 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end g  " +
                        " from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 2') )A " +

                        "union all  " +

                        "select 'Total' [Group],sum(b)b,sum(c)c,sum(d)d,sum(e)e,sum(f)f,sum(g)g,/**sum(c)-sum(d)+sum(e)+sum(f)+sum(g) i**/ (sum(c)+sum(e)+sum(f)+sum(g))-sum(d) i " +
                        ",case when sum(b)>0 then round((sum(c)-sum(d)+sum(e)+sum(f)+sum(g))/sum(b)*100,1) else 0 end j from(select [Group], " +
                        " case when @TotalPotongL2>0 then isnull((select round(M3,4)M3 from tempTotalPotong where [group]=BM_PlantGroup.[Group] ),0)  else 0 end b,  " +
                        " case when @TotalPotongL2>0 then isnull((select round(M3,4)M3 from tempDetailDP where [group]=BM_PlantGroup.[Group] ),0)  else 0 end c,  " +
                        " case when @TotalPotongL2>0 then ((isnull((select round(M3,4)M3 from tempOKKM where [group]=BM_PlantGroup.[Group] ),0))) else 0 end  d, " +
                        " case when @TotalPotongL2>0 then ((isnull((select round(M3,4)M3 from tempSortir_1_m3 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  e,  " +
                        " case when @TotalPotongL2>0 then ((isnull((select round(M3,4)M3 from tempRetur_m3 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  f,  " +
                        " case when @TotalPotongL2>0 then ((isnull((select round(M3,4)M3 from tempDetailBSTahap1 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end g,  " +
                        " 0 i,0 j from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 2'))A )B " +
                        " end " +
                        " else " +
                        " begin " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 i, 0 j into tempdefectL2 " +
                        " end " +
                        #endregion
 " " +
                        "declare @TotalPotongL3 decimal(18,2) " +
                        "declare @TotDefKhususL3 decimal(18,2) " +
                        "declare @DefKhususL3 decimal(18,2) " +
                        "declare @Ttotalkw1kw2L3 decimal(18,2) " +
                        "declare @NCSortirL3 decimal(18,2) " +
                        "declare @ReturL3 decimal(18,2) " +
                        "declare @DefectFinL3 decimal(18,2) " +
                        "set @TotalPotongL3=(select isnull(sum(totkubik ),0) from tempdefectGPIsoTot where [group]in (select [group] from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 3'))) " +
                        "set @TotDefKhususL3=(@TotalPotongL3/@TotalPotong)*@TotalDefKhusus " +
                        "set @DefKhususL3=(@TotalPotongL3/@TotalPotong)*@DefKhusus " +
                        "set @Ttotalkw1kw2L3=(@TotalPotongL3/@TotalPotong)*@Ttotalkw1kw2 " +
                        "set @NCSortirL3=(@TotalPotongL3/@TotalPotong)*@NCSortir " +
                        "set @ReturL3=(@TotalPotongL3/@TotalPotong)*@Retur " +
                        "set @DefectFinL3=isnull((@TotalPotongL3/@TotalPotong)*@DefectFin,0) " +
                        #region Lin3 - 3
 "if @TotalPotongL3>0 " +
                        "begin " +
                        "select [Group],round(b,4)b,round(c,4)c,round(d,4)d,round(e,4)e,round(f,4)f,round(g,4)g,round(i,4)i,j into tempdefectL3 from ( " +
                        "select *,/**c-d+e+f+g i**/ (c+e+f+g)-d i,case when b>0 then round((c-d+e+f+g)/b*100,1) else 0  end j from ( select [Group], " +
                        //"select [Group],case when @TotalPotongL3>0 then isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) +  " +
                        //" ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@TotDefKhususL3) else 0 end  b, " +
                        //" case when @TotalPotongL3>0 then isnull((select totdefectK from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) else 0 end c, " +
                        //" case when @TotalPotongL3>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@Ttotalkw1kw2L3) else 0 end  d, " +
                        //" case when @TotalPotongL3>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@NCSortirL3) else 0 end  e, " +
                        //" case when @TotalPotongL3>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@ReturL3) else 0 end  f, " +
                        //" case when @TotalPotongL3>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@DefectFinL3) else 0 end  g " +
                        //" case when @TotalPotongL3>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@DefKhususL3) else 0 end  h " +
                        " case when @TotalPotongL3>0 then isnull((select round(M3,5)M3 from tempTotalPotong where [group]=BM_PlantGroup.[Group] ),0)  else 0 end b,  " +
                        " case when @TotalPotongL3>0 then isnull((select round(M3,5)M3 from tempDetailDP where [group]=BM_PlantGroup.[Group] ),0)  else 0 end c,  " +
                        " case when @TotalPotongL3>0 then ((isnull((select round(M3,5)M3 from tempOKKM where [group]=BM_PlantGroup.[Group] ),0))) else 0 end  d, " +
                        " case when @TotalPotongL3>0 then ((isnull((select round(M3,5)M3 from tempSortir_1_m3 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  e,  " +
                        " case when @TotalPotongL3>0 then ((isnull((select round(M3,5)M3 from tempRetur_m3 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  f,  " +
                        " case when @TotalPotongL3>0 then ((isnull((select round(M3,5)M3 from tempDetailBSTahap1 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end g  " +
                        "  from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 3') )A " +

                        "union all  " +

                        "select 'Total' [Group],sum(b)b,sum(c)c,sum(d)d,sum(e)e,sum(f)f,sum(g)g,/**sum(c)-sum(d)+sum(e)+sum(f)+sum(g) i**/ (sum(c)+sum(e)+sum(f)+sum(g))-sum(d) i " +
                        ",case when sum(b)>0 then round((sum(c)-sum(d)+sum(e)+sum(f)+sum(g))/sum(b)*100,1) else 0 end j from( select [Group], " +
                         //"select [Group],isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) +  " +
                         //" ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@TotDefKhususL3) b, " +
                         //" isnull((select totdefectK from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)c, " +
                         //" ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@Ttotalkw1kw2L3) d, " +
                         //" ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@NCSortirL3) e, " +
                         //" ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@ReturL3) f, " +
                         //" ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@DefectFinL3) g, " +
                         ////" ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@DefKhususL3) h, " +
                         " case when @TotalPotongL3>0 then isnull((select round(M3,4)M3 from tempTotalPotong where [group]=BM_PlantGroup.[Group] ),0)  else 0 end b,  " +
                        " case when @TotalPotongL3>0 then isnull((select round(M3,4)M3 from tempDetailDP where [group]=BM_PlantGroup.[Group] ),0)  else 0 end c,  " +
                        " case when @TotalPotongL3>0 then ((isnull((select round(M3,4)M3 from tempOKKM where [group]=BM_PlantGroup.[Group] ),0))) else 0 end  d, " +
                        " case when @TotalPotongL3>0 then ((isnull((select round(M3,4)M3 from tempSortir_1_m3 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  e,  " +
                        " case when @TotalPotongL3>0 then ((isnull((select round(M3,4)M3 from tempRetur_m3 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  f,  " +
                        " case when @TotalPotongL3>0 then ((isnull((select round(M3,4)M3 from tempDetailBSTahap1 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end g,  " +
                        " 0 i,0 j from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 3'))A )B " +
                        " end " +
                        " else " +
                        " begin " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 i, 0 j into tempdefectL3 " +
                        " end " +
                        #endregion
 " " +
                        "declare @TotalPotongL4 decimal(18,2) " +
                        "declare @TotDefKhususL4 decimal(18,2) " +
                        "declare @DefKhususL4 decimal(18,2) " +
                        "declare @Ttotalkw1kw2L4 decimal(18,2) " +
                        "declare @NCSortirL4 decimal(18,2) " +
                        "declare @ReturL4 decimal(18,2) " +
                        "declare @DefectFinL4 decimal(18,2) " +
                        "set @TotalPotongL4=(select isnull(sum(totkubik ),0) from tempdefectGPIsoTot where [group]in (select [group] from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 4'))) " +
                        "set @TotDefKhususL4=(@TotalPotongL4/@TotalPotong)*@TotalDefKhusus " +
                        "set @DefKhususL4=(@TotalPotongL4/@TotalPotong)*@DefKhusus " +
                        "set @Ttotalkw1kw2L4=(@TotalPotongL4/@TotalPotong)*@Ttotalkw1kw2 " +
                        "set @NCSortirL4=(@TotalPotongL4/@TotalPotong)*@NCSortir " +
                        "set @ReturL4=(@TotalPotongL4/@TotalPotong)*@Retur " +
                        "set @DefectFinL4=isnull((@TotalPotongL4/@TotalPotong)*@DefectFin,0) " +
                        #region Line - 4
 "if @TotalPotongL4>0 " +
                        "begin " +
                        "select [Group],round(b,4)b,round(c,4)c,round(d,4)d,round(e,4)e,round(f,4)f,round(g,4)g,round(i,4)i,j into tempdefectL4 from ( " +
                        "select *,/**c-d+e+f+g i**/ (c+e+f+g)-d i,case when b>0 then round((c-d+e+f+g)/b*100,1) else 0  end j from ( " +
                        "select [Group], " +
                        //" case when @TotalPotongL4>0 then isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) +  " +
                        //" ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@TotDefKhususL4) else 0 end  b, " +
                        //" case when @TotalPotongL4>0 then isnull((select totdefectK from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) else 0 end c, " +
                        //" case when @TotalPotongL4>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@Ttotalkw1kw2L4) else 0 end  d, " +
                        //" case when @TotalPotongL4>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@NCSortirL4) else 0 end  e, " +
                        //" case when @TotalPotongL4>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@ReturL4) else 0 end  f, " +
                        //" case when @TotalPotongL4>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@DefectFinL4) else 0 end  g " +
                        //" case when @TotalPotongL4>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@DefKhususL4) else 0 end  h " +
                        " case when @TotalPotongL4>0 then isnull((select round(M3,5)M3 from tempTotalPotong where [group]=BM_PlantGroup.[Group] ),0)  else 0 end b,  " +
                        " case when @TotalPotongL4>0 then isnull((select round(M3,5)M3 from tempDetailDP where [group]=BM_PlantGroup.[Group] ),0)  else 0 end c,  " +
                        " case when @TotalPotongL4>0 then ((isnull((select round(M3,5)M3 from tempOKKM where [group]=BM_PlantGroup.[Group] ),0))) else 0 end  d, " +
                        " case when @TotalPotongL4>0 then ((isnull((select round(M3,5)M3 from tempSortir_1_m3 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  e,  " +
                        " case when @TotalPotongL4>0 then ((isnull((select round(M3,5)M3 from tempRetur_m3 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  f,  " +
                        " case when @TotalPotongL4>0 then ((isnull((select round(M3,5)M3 from tempDetailBSTahap1 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end g  " +
                        "  from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 4') )A " +

                        "union all  " +

                        "select 'Total' [Group],sum(b)b,sum(c)c,sum(d)d,sum(e)e,sum(f)f,sum(g)g,/**sum(c)-sum(d)+sum(e)+sum(f)+sum(g) i**/ (sum(c)+sum(e)+sum(f)+sum(g))-sum(d) i" +
                        ",case when sum(b)>0 then round((sum(c)-sum(d)+sum(e)+sum(f)+sum(g))/sum(b)*100,1) else 0 end j from( " +
                        "select [Group], " +
                        //" isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) +  " +
                        //" ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@TotDefKhususL4) b, " +
                        //" isnull((select totdefectK from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)c, " +
                        //" ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@Ttotalkw1kw2L4) d, " +
                        //" ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@NCSortirL4) e, " +
                        //" ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@ReturL4) f, " +
                        //" ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@DefectFinL4) g, " +
                        //" ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@DefKhususL4) h, " +                   
                        " ((isnull((select round(M3,4)M3 from tempTotalPotong where [group]=BM_PlantGroup.[Group] ),0))) b, " +
                        " isnull((select round(M3,4)M3 from tempDetailDP where [group]=BM_PlantGroup.[Group] ),0)c, " +
                        " ((isnull((select round(M3,4)M3 from tempOKKM where [group]=BM_PlantGroup.[Group] ),0))) d, " +
                        " ((isnull((select round(M3,4)M3 from tempSortir_1_m3 where [group]=BM_PlantGroup.[Group] ),0))) e, " +
                        " ((isnull((select round(M3,4)M3 from tempRetur_m3 where [group]=BM_PlantGroup.[Group] ),0))) f, " +
                        " ((isnull((select round(M3,4)M3 from tempDetailBSTahap1 where [group]=BM_PlantGroup.[Group] ),0))) g, " +
                        " 0 i,0 j from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 4'))A )B " +
                        " end " +
                        " else " +
                        " begin " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 i, 0 j into tempdefectL4 " +
                        " end " +
                        #endregion
 " " +
                        "declare @TotalPotongL5 decimal(18,2) " +
                        "declare @TotDefKhususL5 decimal(18,2) " +
                        "declare @DefKhususL5 decimal(18,2) " +
                        "declare @Ttotalkw1kw2L5 decimal(18,2) " +
                        "declare @NCSortirL5 decimal(18,2) " +
                        "declare @ReturL5 decimal(18,2) " +
                        "declare @DefectFinL5 decimal(18,2) " +
                        "set @TotalPotongL5=(select isnull(sum(totkubik ),0) from tempdefectGPIsoTot where [group]in (select [group] from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 5'))) " +
                        "set @TotDefKhususL5=(@TotalPotongL5/@TotalPotong)*@TotalDefKhusus " +
                        "set @DefKhususL5=(@TotalPotongL5/@TotalPotong)*@DefKhusus " +
                        "set @Ttotalkw1kw2L5=(@TotalPotongL5/@TotalPotong)*@Ttotalkw1kw2 " +
                        "set @NCSortirL5=(@TotalPotongL5/@TotalPotong)*@NCSortir " +
                        "set @ReturL5=(@TotalPotongL5/@TotalPotong)*@Retur " +
                        "set @DefectFinL5=isnull((@TotalPotongL5/@TotalPotong)*@DefectFin,0) " +
                        #region Line - 5
 "if @TotalPotongL5>0 " +
                        "begin " +
                        "select [Group],round(b,4)b,round(c,4)c,round(d,4)d,round(e,4)e,round(f,4)f,round(g,4)g,round(i,0)i,j into tempdefectL5 from ( " +
                        "select *,/**c-d+e+f+g i**/ (c+e+f+g)-d i,case when b>0 then round((c-d+e+f+g)/b*100,1) else 0  end j from ( " +
                        "select [Group], " +
                        //" case when @TotalPotongL5>0 then isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) +  " +
                        //" ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@TotDefKhususL5) else 0 end  b, " +
                        //" case when @TotalPotongL5>0 then isnull((select totdefectK from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) else 0 end c, " +
                        //" case when @TotalPotongL5>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@Ttotalkw1kw2L5) else 0 end  d, " +
                        //" case when @TotalPotongL5>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@NCSortirL5) else 0 end  e, " +
                        //" case when @TotalPotongL5>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@ReturL5) else 0 end  f, " +
                        //" case when @TotalPotongL5>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@DefectFinL5) else 0 end  g " +
                        //" case when @TotalPotongL5>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@DefKhususL5) else 0 end  h " +
                        " case when @TotalPotongL5>=0 then isnull((select round(M3,5)M3 from tempTotalPotong where [group]=BM_PlantGroup.[Group] ),0)  else 0 end b,  " +
                        " case when @TotalPotongL5>=0 then isnull((select round(M3,5)M3 from tempDetailDP where [group]=BM_PlantGroup.[Group] ),0)  else 0 end c,  " +
                        " case when @TotalPotongL5>=0 then ((isnull((select round(M3,5)M3 from tempOKKM where [group]=BM_PlantGroup.[Group] ),0))) else 0 end  d, " +
                        " case when @TotalPotongL5>=0 then ((isnull((select round(M3,5)M3 from tempSortir_1_m3 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  e,  " +
                        " case when @TotalPotongL5>=0 then ((isnull((select round(M3,5)M3 from tempRetur_m3 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  f,  " +
                        " case when @TotalPotongL5>=0 then ((isnull((select round(M3,5)M3 from tempDetailBSTahap1 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end g  " +
                        "  from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 5') )A " +

                        "union all  " +

                        "select 'Total' [Group],sum(b)b,sum(c)c,sum(d)d,sum(e)e,sum(f)f,sum(g)g,/**sum(c)-sum(d)+sum(e)+sum(f)+sum(g) i**/ (sum(c)+sum(e)+sum(f)+sum(g))-sum(d) i " +
                        ",case when sum(b)>0 then round((sum(c)-sum(d)+sum(e)+sum(f)+sum(g))/sum(b)*100,1) else 0 end j from( " +
                        "select [Group], " +
                        //" isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) +  " +
                        //" ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@TotDefKhususL5) b, " +
                        //" isnull((select totdefectK from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)c, " +
                        //" ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@Ttotalkw1kw2L5) d, " +
                        //" ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@NCSortirL5) e, " +
                        //" ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@ReturL5) f, " +
                        //" ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@DefectFinL5) g, " +
                        //" ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@DefKhususL5) h, " +
                        " ((isnull((select round(M3,4)M3 from tempTotalPotong where [group]=BM_PlantGroup.[Group] ),0))) b, " +
                        " isnull((select round(M3,4)M3 from tempDetailDP where [group]=BM_PlantGroup.[Group] ),0)c, " +
                        " ((isnull((select round(M3,4)M3 from tempOKKM where [group]=BM_PlantGroup.[Group] ),0))) d, " +
                        " ((isnull((select round(M3,4)M3 from tempSortir_1_m3 where [group]=BM_PlantGroup.[Group] ),0))) e, " +
                        " ((isnull((select round(M3,4)M3 from tempRetur_m3 where [group]=BM_PlantGroup.[Group] ),0))) f, " +
                        " ((isnull((select round(M3,4)M3 from tempDetailBSTahap1 where [group]=BM_PlantGroup.[Group] ),0))) g, " +
                        " 0 i,0 j from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 5'))A )B " +
                        " end " +
                        " else " +
                        " begin " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 i, 0 j into tempdefectL5 " +
                        " end " +
                        #endregion
 " " +
                        "declare @TotalPotongL6 decimal(18,2) " +
                        "declare @TotDefKhususL6 decimal(18,2) " +
                        "declare @DefKhususL6 decimal(18,2) " +
                        "declare @Ttotalkw1kw2L6 decimal(18,2) " +
                        "declare @NCSortirL6 decimal(18,2) " +
                        "declare @ReturL6 decimal(18,2) " +
                        "declare @DefectFinL6 decimal(18,2) " +
                        "set @TotalPotongL6=(select isnull(sum(totkubik ),0) from tempdefectGPIsoTot where [group]in (select [group] from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 6'))) " +
                        "set @TotDefKhususL6=(@TotalPotongL6/@TotalPotong)*@TotalDefKhusus " +
                        "set @DefKhususL6=(@TotalPotongL6/@TotalPotong)*@DefKhusus " +
                        "set @Ttotalkw1kw2L6=(@TotalPotongL6/@TotalPotong)*@Ttotalkw1kw2 " +
                        "set @NCSortirL6=(@TotalPotongL6/@TotalPotong)*@NCSortir " +
                        "set @ReturL6=(@TotalPotongL6/@TotalPotong)*@Retur " +
                        "set @DefectFinL6=isnull((@TotalPotongL6/@TotalPotong)*@DefectFin,0) " +
                        #region Line - 6
 "if @TotalPotongL6>0 " +
                        "begin " +
                        "select [Group],round(b,4)b,round(c,4)c,round(d,4)d,round(e,4)e,round(f,4)f,round(g,4)g,round(i,0)i,j into tempdefectL6 from ( " +
                        "select *,/**c-d+e+f+g i**/ (c+e+f+g)-d i,case when b>0 then round((c-d+e+f+g)/b*100,1) else 0  end j from ( " +
                        "select [Group], " +
                        //" case when @TotalPotongL6>0 then isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) +  " +
                        //" ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@TotDefKhususL6)  else 0 end b, " +
                        //" case when @TotalPotongL6>0 then isnull((select totdefectK from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) else 0 end c, " +
                        //" case when @TotalPotongL6>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@Ttotalkw1kw2L6)  else 0 end d, " +
                        //" case when @TotalPotongL6>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@NCSortirL6)  else 0 end e, " +
                        //" case when @TotalPotongL6>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@ReturL6)  else 0 end f, " +
                        //" case when @TotalPotongL6>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@DefectFinL6)  else 0 end g " +
                        //" case when @TotalPotongL6>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@DefKhususL6) else 0 end  h " +
                        " case when @TotalPotongL6>=0 then isnull((select round(M3,5)M3 from tempTotalPotong where [group]=BM_PlantGroup.[Group] ),0)  else 0 end b,  " +
                        " case when @TotalPotongL6>=0 then isnull((select round(M3,5)M3 from tempDetailDP where [group]=BM_PlantGroup.[Group] ),0)  else 0 end c,  " +
                        " case when @TotalPotongL6>=0 then ((isnull((select round(M3,5)M3 from tempOKKM where [group]=BM_PlantGroup.[Group] ),0))) else 0 end  d, " +
                        " case when @TotalPotongL6>=0 then ((isnull((select round(M3,5)M3 from tempSortir_1_m3 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  e,  " +
                        " case when @TotalPotongL6>=0 then ((isnull((select round(M3,5)M3 from tempRetur_m3 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  f,  " +
                        " case when @TotalPotongL6>=0 then ((isnull((select round(M3,5)M3 from tempDetailBSTahap1 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end g  " +
                        "  from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 6') )A " +

                        "union all  " +

                        "select 'Total' [Group],sum(b)b,sum(c)c,sum(d)d,sum(e)e,sum(f)f,sum(g)g,/**sum(c)-sum(d)+sum(e)+sum(f)+sum(g) i**/ (sum(c)+sum(e)+sum(f)+sum(g))-sum(d) i" +
                        ",case when sum(b)>0 then round((sum(c)-sum(d)+sum(e)+sum(f)+sum(g))/sum(b)*100,1) else 0 end j from( " +
                        "select [Group], " +
                        //" isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) +  " +
                        //" ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@TotDefKhususL6) b, " +
                        //" isnull((select totdefectK from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)c, " +
                        //" ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@Ttotalkw1kw2L6) d, " +
                        //" ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@NCSortirL6) e, " +
                        //" ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@ReturL6) f, " +
                        //" ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@DefectFinL6) g, " +
                        //" ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@DefKhususL6) h, " +
                        " ((isnull((select round(M3,4)M3 from tempTotalPotong where [group]=BM_PlantGroup.[Group] ),0))) b, " +
                        " isnull((select round(M3,4)M3 from tempDetailDP where [group]=BM_PlantGroup.[Group] ),0)c, " +
                        " ((isnull((select round(M3,4)M3 from tempOKKM where [group]=BM_PlantGroup.[Group] ),0))) d, " +
                        " ((isnull((select round(M3,4)M3 from tempSortir_1_m3 where [group]=BM_PlantGroup.[Group] ),0))) e, " +
                        " ((isnull((select round(M3,4)M3 from tempRetur_m3 where [group]=BM_PlantGroup.[Group] ),0))) f, " +
                        " ((isnull((select round(M3,4)M3 from tempDetailBSTahap1 where [group]=BM_PlantGroup.[Group] ),0))) g, " +
                        " 0 i,0 j from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 6'))A )B " +
                        " end " +
                        #endregion
 " else " +
                        " begin " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 i, 0 j into tempdefectL6 " +
                        " end " +
                        " " +
                        " end " +
                        " else " +
                        " begin " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 i, 0 j into tempdefectL1 " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 i, 0 j into tempdefectL2 " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 i, 0 j into tempdefectL3 " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 i, 0 j into tempdefectL4 " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 i, 0 j into tempdefectL5 " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 i, 0 j into tempdefectL6 " +
                        " end " +
                        " select [group],round(b,1)b,round(c,1)c,round(d,1)d,round(e,1)e,round(f,1)f,case when [group]<>'total' then round(g,1) when [group]='total' then round(g,1) end g,i,j from tempdefectL1 ";
                    }
                    #endregion
                    #endregion
                    #region added 07 Mei 2021
                    else if (Convert.ToInt32(strtgl1.Substring(0, 6)) > 202102 && Convert.ToInt32(strtgl1.Substring(0, 6)) < 202106 && users.UnitKerjaID.ToString() == "1" ||
                             Convert.ToInt32(strtgl1.Substring(0, 6)) > 202102 && Convert.ToInt32(strtgl1.Substring(0, 6)) < 202106 && users.UnitKerjaID.ToString() == "7" ||
                             Convert.ToInt32(strtgl1.Substring(0, 6)) < 202108 && users.UnitKerjaID.ToString() == "13")
                    {
                        string logika1 = string.Empty;
                        if (users.UnitKerjaID == 7)
                        {
                            logika1 =
                            " select cast(@selisihTotalPot//**@TtlGroup**/24 as decimal(18,1))M3,[Group] into DtlSelisihTtlPot from ( " +
                            " select [Group] from detailDfctSystemBM_M3  " +
                            " union all   " +
                            " select [Group] from DtlDefectSystemFN_M3 " +
                            " union all " +
                            " select [Group] from BM_PlantGroup where PlantID>0) as x group by [Group] ";


                        }
                        else if (users.UnitKerjaID == 1)
                        {
                            logika1 =
                                " select sum(M3)M3,[Group]  into DtlSelisihTtlPot from ( " +
                                " select (@selisihTotalPot/(select count([Group])ttl from tempDetailTotPotong_LPUK where m3>0))M3,[Group] from tempDetailTotPotong_LPUK  where m3>0 union all " +
                                " select '0'M3,[Group] from BM_PlantGroup where PlantID>0) as x group by [Group] ";
                            //" select cast(@selisihTotalPot/@TtlGroup as decimal(18,1))M3,[Group] into DtlSelisihTtlPot " +
                            //" from (  select [Group] from detailDfctSystemBM_M3  " +
                            //" union all  " +
                            //" select [Group] from DtlDefectSystemFN_M3 " +
                            //" union all  select [Group] from BM_PlantGroup where PlantID>0) as x group by [Group] ";
                        }
                        else if (users.UnitKerjaID == 13)
                        {
                            logika1 =
                            " select cast(@selisihTotalPot/@TtlGroup as decimal(18,1))M3,[Group] into DtlSelisihTtlPot from ( " +
                            " select [Group] from detailDfctSystemBM_M3  " +
                            " union all   " +
                            " select [Group] from DtlDefectSystemFN_M3 " +
                            " union all " +
                            " select [Group] from BM_PlantGroup where PlantID>0) as x group by [Group] ";

                        }

                        if (Convert.ToInt32(strtgl1.Substring(0, 6)) > 202105)
                        {
                            logika2 = " select M3,[Group] from AtempDetail_Listplank ";
                            //logika3 = " ,case when sum(b)>0 then cast((sum(i))/sum(b)*100 as decimal(18,1)) else 0 end j from ( ";
                        }
                        else
                        {
                            //" select M3 *-1 M3,[Group] from tempDetail_Listplank0 "+
                            //" /**select M3,[Group] from AtempDetail_Listplank**/ "+
                            logika2 = " select M3 *-1 M3,[Group] from tempDetail_Listplank0 ";
                            //logika3 = " ,case when sum(b)>0 then cast((sum(c)-sum(d)+sum(e)+sum(f))/sum(b)*100 as decimal(18,1)) else 0 end j from (  ";
                        }

                        if (Convert.ToInt32(strtgl1.Substring(0, 6)) > 202106 && users.UnitKerjaID == 7 || Convert.ToInt32(strtgl1.Substring(0, 6)) > 202106 && users.UnitKerjaID == 1)
                        {
                            logika3 = " ,case when sum(b)>0 then cast((sum(i))/sum(b)*100 as decimal(18,1)) else 0 end j from ( ";
                        }
                        else
                        {
                            logika3 = " ,case when sum(b)>0 then cast((sum(c)-sum(d)+sum(e)+sum(f))/sum(b)*100 as decimal(18,1)) else 0 end j from (  ";
                        }

                        if (Convert.ToInt32(strtgl1.Substring(0, 6)) > 202105 && users.UnitKerjaID == 13)
                        {
                            logika3 = " ,case when sum(b)>0 then cast((sum(i))/sum(b)*100 as decimal(18,1)) else 0 end j from ( ";
                        }
                        else
                        {
                            logika3 = " ,case when sum(b)>0 then cast((sum(c)-sum(d)+sum(e)+sum(f))/sum(b)*100 as decimal(18,1)) else 0 end j from (  ";
                        }

                        strSQL =

                        #region Temp Table

     " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectGPIso]') AND type in (N'U')) DROP TABLE [dbo].[tempdefectGPIso] " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectGPIsoTot]') AND type in (N'U')) DROP TABLE [dbo].tempdefectGPIsoTot   " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectFin]') AND type in (N'U')) DROP TABLE [dbo].tempdefectFin   " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectL1]') AND type in (N'U')) DROP TABLE [dbo].tempdefectL1  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectL2]') AND type in (N'U')) DROP TABLE [dbo].tempdefectL2  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectL3]') AND type in (N'U')) DROP TABLE [dbo].tempdefectL3  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectL4]') AND type in (N'U')) DROP TABLE [dbo].tempdefectL4  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectL5]') AND type in (N'U')) DROP TABLE [dbo].tempdefectL5  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectL6]') AND type in (N'U')) DROP TABLE [dbo].tempdefectL6 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectGPIso2]') AND type in (N'U')) DROP TABLE [dbo].tempdefectGPIso2 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[detailDfctSystemBM_M3]') AND type in (N'U')) DROP TABLE [dbo].detailDfctSystemBM_M3 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[DtlDefectSystemFN_M3]') AND type in (N'U')) DROP TABLE [dbo].DtlDefectSystemFN_M3  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[DtlSelisih_M3]') AND type in (N'U')) DROP TABLE [dbo].DtlSelisih_M3 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTotPotong_QA]') AND type in (N'U')) DROP TABLE [dbo].tempTotPotong_QA " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempOKKM_m3]') AND type in (N'U')) DROP TABLE [dbo].tempOKKM_m3  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempSortir_1_m3]') AND type in (N'U')) DROP TABLE [dbo].tempSortir_1_m3 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempRetur_m3]') AND type in (N'U')) DROP TABLE [dbo].tempRetur_m3 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempOKKM]') AND type in (N'U')) DROP TABLE [dbo].tempOKKM " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDefectBMFin]') AND type in (N'U')) DROP TABLE [dbo].tempDefectBMFin " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDetail_Listplank]') AND type in (N'U')) DROP TABLE [dbo].tempDetail_Listplank " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDetail_Listplank0]') AND type in (N'U')) DROP TABLE [dbo].tempDetail_Listplank0 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDetailDefect_UkuranKhusus]') AND type in (N'U')) DROP TABLE [dbo].tempDetailDefect_UkuranKhusus " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDetailDefect_UkuranKhususOK]') AND type in (N'U')) DROP TABLE [dbo].tempDetailDefect_UkuranKhususOK " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDefectProduksi]') AND type in (N'U')) DROP TABLE [dbo].tempDefectProduksi " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTotalBSTahap1]') AND type in (N'U')) DROP TABLE [dbo].tempTotalBSTahap1  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDetailBSTahap1]') AND type in (N'U')) DROP TABLE [dbo].tempDetailBSTahap1 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDetailTotalDefect]') AND type in (N'U')) DROP TABLE [dbo].tempDetailTotalDefect " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDetailTotalDefect_P]') AND type in (N'U')) DROP TABLE [dbo].tempDetailTotalDefect_P " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTotPotong_QA]') AND type in (N'U')) DROP TABLE [dbo].tempTotPotong_QA  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDetailTotPotong_LPUK]') AND type in (N'U')) DROP TABLE [dbo].tempDetailTotPotong_LPUK  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDetailTotPotong_LPUK2]') AND type in (N'U')) DROP TABLE [dbo].tempDetailTotPotong_LPUK2 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[DtlSelisihTtlPot]') AND type in (N'U')) DROP TABLE [dbo].DtlSelisihTtlPot  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[DtlTotalPotongProposionet]') AND type in (N'U')) DROP TABLE [dbo].DtlTotalPotongProposionet " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[DtlTotalDefect]') AND type in (N'U')) DROP TABLE [dbo].DtlTotalDefect " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[AtempDetail_Listplank]') AND type in (N'U')) DROP TABLE [dbo].AtempDetail_Listplank " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDataBSauto]') AND type in (N'U')) DROP TABLE [dbo].[tempDataBSauto]  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDataSarmut_Defect]') AND type in (N'U')) DROP TABLE [dbo].[tempDataSarmut_Defect] " +
                        #endregion

                        #region Logika
                    " declare @thnbln1 varchar(8) declare @thnbln2 varchar(8) declare @BlnThn varchar(6) " +

                        " set @thnbln1='" + strtgl1 + "' " +
                        " set @thnbln2='" + strtgl2 + "' " +
                        " set @BlnThn='" + Periode + "' " +

                        " select *  into tempdefectGPIso from (  select case when D.DeptID=0 then  case when GJ.GroupJemurName In ('M','N','O','P','Q','R','S','T','U','V','W','X') then " +
                        " case when D.DefName='retak' then 2 when D.DefName='gompal' then 3 else D.DeptID end else " +
                        " case when (B.Qty/E.Qty) *100 >5 then 2 else 3 end   end  else D.DeptID end deptID1,A.CreatedTime as tglInput,A.Tgl as TglPeriksa, " +
                        " E.TglProduksi as TglProd,  D.DefCode,BP.PlantName as Line, PG.[Group],BF.FormulaCode as Jenis,D.DefName,D.DeptID,B.ID,B.DefectID, " +
                        " B.MasterID,B.Qty,A.ID  DestID,isnull(A.TPotong,0)  QtyIn, " +
                        " I.Volume*B.Qty Kubik,isnull(A.TPotong,0) as TotPotong,'' sfrom  " +
                        " from Def_DefectDetail B " +
                        " inner join Def_Defect A on A.Id=B.DefectID   " +
                        " left join Def_MasterDefect D on B.MasterID=D.ID " +
                        " left join BM_Destacking E on E.ID=A.DestID  " +
                        " left join BM_PlantGroup PG on A.GroupProdID=PG.ID " +
                        " left join BM_Formula BF on BF.ID=E.FormulaID   " +
                        " left join BM_Plant BP on BP.ID=E.PlantID " +
                        " left join FC_Items I on I.ID=E.ItemID " +
                        " inner join Def_GroupJemur GJ on GJ.ID=A.GroupJemurID  " +
                        " where B.RowStatus>-1  and D.RowStatus >-1) as Def    " +
                        " where DeptID1=2 and CONVERT(varchar,TglPeriksa,112)>=@thnbln1 and CONVERT(varchar,TglPeriksa,112)<=@thnbln2   " +

                        " declare @ttlDefectBM decimal(10,5) " +
                        " declare @ttlDefectFN decimal(10,5) " +
                        " declare @Selisih_ttl_defect decimal(10,5) " +
                        " declare @dtlSelisih_ttl_defect decimal(10,5) " +
                        " declare @Selisih_ttl_defect2 decimal(10,5) " +
                        " declare @TtlDfctSystemBM_M3 decimal(10,5) " +
                        " declare @TtlDfctSystemFN_M3 decimal(10,5) " +
                        " declare @TtlDfctBMFN_M3 decimal(10,5) " +
                        " declare @TtlDefectBM_M3 decimal(10,5) " +
                        " declare @TtlDfctBMFN_M3_OKKW decimal(10,5) " +

                        " select * into tempdefectGPIso2 " +
                        " from (  select case when D.DeptID=0 then  case when GJ.GroupJemurName In ('M','N','O','P','Q','R','S','T','U','V','W','X') then  " +
                        " case when D.DefName='retak' then 2 when D.DefName='gompal' then 3 else D.DeptID end else case when (B.Qty/E.Qty) *100 >5 then 2 " +
                        " else 3 end   end  else D.DeptID end deptID1,A.CreatedTime as tglInput,A.Tgl as TglPeriksa,E.TglProduksi as TglProd, " +
                        " D.DefCode,BP.PlantName as Line, PG.[Group],BF.FormulaCode as Jenis,D.DefName,D.DeptID,B.ID,B.DefectID,B.MasterID,B.Qty,A.ID " +
                        " DestID,isnull(A.TPotong,0)  QtyIn,B.Qty*I.Volume as Kubik,isnull(A.TPotong,0) as TotPotong,'' sfrom  " +
                        " from Def_DefectDetail B inner join Def_Defect A on A.Id=B.DefectID   left join Def_MasterDefect D on B.MasterID=D.ID " +
                        " left join BM_Destacking E on E.ID=A.DestID   left join BM_PlantGroup PG on A.GroupProdID=PG.ID " +
                        " left join BM_Formula BF on BF.ID=E.FormulaID    left join BM_Plant BP on BP.ID=E.PlantID left join FC_Items I on I.ID=E.ItemID " +
                        " inner join Def_GroupJemur GJ on GJ.ID=A.GroupJemurID  where B.RowStatus>-1  and D.RowStatus >-1) as Def  " +
                        " where DeptID1=3 and CONVERT(varchar,TglPeriksa,112)>=@thnbln1 and CONVERT(varchar,TglPeriksa,112)<=@thnbln2  " +

                        "  /** 1. Defect System BM ( Kolom ) **/  " +
                        " select [Group],cast((M3) as decimal(18,5))M3 into detailDfctSystemBM_M3 from (select [Group],cast((sum(kubik)) as decimal(18,5)) M3  from tempdefectGPIso group by [Group] ) as x   " +

                        " /** Total Defect BM dan Finishing BP ( Kolom Defect System BP )**/  " +
                        " /** Accounting Report Mutasi WiP : Pengeluaran B99 **/ " +
                        " set @TtlDfctBMFN_M3 = (  select cast((sum(M3)) as decimal(18,0))BP_M3  from (  select sum(Qty)Qty,sum(M3)M3 from (  select *,cast(((Qty*Volume)) as decimal(18,2))M3 from (  select sum(A.qty *-1) Qty,(B.Tebal*B.Lebar*B.Panjang)/1000000000 Volume from vw_KartustockWIP A   inner join FC_Items B ON A.itemid0=B.ID  where qty<0   and lokasi='B99' and process<>'lari' and process<>'listplank' and left(convert(char,tanggal,112),8)>=@thnbln1 and  left(convert(char,tanggal,112),8)<=@thnbln2   group by tebal,lebar,panjang ) as x ) as x1  " +
                        " union all  " +
                        " select sum(Qty)Qty,sum(M3)M3 from (  select *,cast(((Qty*Volume)) as decimal(18,2))M3 from (  select isnull(SUM(qty)*-1,0)Qty,(I2.Tebal*I2.Lebar*I2.Panjang)/1000000000 Volume from vw_KartustockWIP2 V   inner join FC_Items I on V.itemID=I.ID inner join FC_Items I2 on I2.ID=V.itemid0 and (I.partno  like '%-p-%'  )  where qty<0  and idrec not like '%ou%'    and process='lari'and lokid1 not in (select ID from fc_lokasi where lokasi='I99') and  left(convert(char,tanggal,112),8)>=@thnbln1 and left(convert(char,tanggal,112),8)<=@thnbln2  group by I2.tebal,I2.lebar,I2.panjang) as x ) as x1 ) as xx )  " +

                        "  /** Total Defect BM dan Finishing BP ( Kolom Defect System OK KW ) **/  " +
                        " /** Total Defect BM dan Finishing OK KW **/  " +
                        " set @TtlDfctBMFN_M3_OKKW = (  select cast((sum(M3)) as decimal(18,2))BP_M3  from (  select sum(Qty)Qty,sum(M3)M3 from (  select *,cast(((Qty*Volume)) as decimal(18,2))M3 from (  select sum(A.qty *-1) Qty,(B.Tebal*B.Lebar*B.Panjang)/1000000000 Volume from vw_KartustockWIP A   inner join FC_Items B ON A.itemid0=B.ID  where qty<0   and lokasi='H99' and process<>'lari' and process<>'listplank' and left(convert(char,tanggal,112),8)>=@thnbln1  and left(convert(char,tanggal,112),8)<=@thnbln2   group by tebal,lebar,panjang ) as x ) as x1  " +
                        " union all  " +
                        " select sum(Qty)Qty,sum(M3)M3 from (  select *,cast(((Qty*Volume)) as decimal(18,2))M3 from (  select isnull(SUM(qty)*-1,0)Qty,(I2.Tebal*I2.Lebar*I2.Panjang)/1000000000 Volume from vw_KartustockWIP2 V   inner join FC_Items I on V.itemID=I.ID inner join FC_Items I2 on I2.ID=V.itemid0 and (I.partno  like '%-3-%' or I.partno  like '%-M-%'  )      where qty<0  and idrec not like '%ou%'    and process='lari'and lokid1 not in (select ID from fc_lokasi where lokasi='I99') and  left(convert(char,tanggal,112),8)>=@thnbln1 and left(convert(char,tanggal,112),8)<=@thnbln2  group by I2.tebal,I2.lebar,I2.panjang) as x ) as x1 ) as xx )  " +

                        "  /** Total Defect BM dan Finishing OK KW **/  " +
                        " set @TtlDfctSystemBM_M3 = (select M3 from (select cast((sum(M3)) as decimal(18,5))M3 from detailDfctSystemBM_M3) as x)  " +
                        " set @TtlDfctSystemFN_M3 = (select M3 from (select cast((sum(kubik)) as decimal(18,1))M3 from tempdefectGPIso2) as x)  " +
                        " set @TtlDefectBM_M3 = (select M3 from (select cast((sum(M3)) as decimal(18,0))M3 from detailDfctSystemBM_M3) as x)  " +

                        " /** 2. Defect System Finishing ( Kolom ) **/   " +
                        " select [Group],cast((((M3/@TtlDfctSystemBM_M3)*@TtlDfctSystemFN_M3)) as decimal(18,5))M3 into DtlDefectSystemFN_M3 from detailDfctSystemBM_M3 " +
                        " /** End Detail data transaksi Defect System Finishing per Group **/ " +

                        "   /** 3. Selisih Total Defect ( Kolom ) **/ " +
                        " set @Selisih_ttl_defect = (select @TtlDfctBMFN_M3 - cast((@TtlDefectBM_M3) as decimal(18,5)) - cast((@TtlDfctSystemFN_M3) as decimal(18,5))) " +
                        " select [Group],cast(((M3/@TtlDfctSystemBM_M3)*@Selisih_ttl_defect) as decimal(18,5)) M3 into DtlSelisih_M3 from detailDfctSystemBM_M3 order by [group] " +

                        " /** 4. Detail Defect BM + Finishing ( Kolom ) **/ " +
                        " select [group],cast(sum(M3) as decimal(18,5))M3 into tempDefectBMFin from ( " +
                        " select * from detailDfctSystemBM_M3 union all  select * from DtlDefectSystemFN_M3 union all select * from  DtlSelisih_M3 ) as x group by [group] ; " +

                        " /** 5. Detail Defect Ukuran Khusus BP **/ " +
                        //" with dataDestacking as (select distinct ItemID,PlantID,left(convert(char,tglproduksi,112),6)ThnBln from BM_Destacking where RowStatus>-1 group by ItemID,PlantiD,TglProduksi ), "+
                        //" dataDestacking1 as (select B.PartNo,PlantID,ThnBln from dataDestacking A inner join FC_Items B ON A.ItemID=B.ID), "+
                        //" dataDestacking2 as (select x.ItemID,x.PartnoAsal,x.Qty,((A.Tebal*A.Lebar*A.Panjang)/1000000000)*x.Qty M3 from (   select PartNo PartnoAsal,ItemID,isnull(SUM(Qty),0)  * -1 Qty from vw_KartuStockBJNew  where qty <0 and (process  like '%simetris%' ) and  (Keterangan like '%-P-%') and  LokID not In (select ID from FC_Lokasi where lokasi='q99')   and left(convert(char,tanggal,112),8)>=@thnbln1 and  left(convert(char,tanggal,112),8)<=@thnbln2 and ItemID in (select ID  from FC_Items where PartNo like'%-1-%') group by ItemID,Keterangan,PartNo,ItemID   ) as x  inner join FC_Items A ON A.ID=x.ItemID), " +        
                        //" dataDestacking3 as (select *,(select top 1 A1.ThnBln from dataDestacking1 A1 where A1.PartNo=A.PartnoAsal and A1.ThnBln<=left(convert(char,@thnbln1,112),6) order by A1.ThnBln desc)ThnBln from dataDestacking2 A) , " +
                        //" dataDestacking4 as (select PartnoAsal,sum(M3)M3,ThnBln,PlantID from (select A.*,B.PlantID from dataDestacking3 A left join dataDestacking1 B ON A.PartnoAsal=B.PartNo and A.ThnBln=B.ThnBln ) as x group by PartnoAsal,ThnBln,PlantID), " +
                        //" dataDestacking04 as (select *,(select top 1 A1.Line from Def_UKhususProsen A1 where A1.rowstatus>-1 and A1.Partno=A.PartnoAsal and A1.Periode=left(convert(char,@thnbln1,112),6))PlantID2 from dataDestacking4 A ), " +
                        //" dataDestacking5 as (select PartnoAsal,M3,case when PlantID2 is null then PlantID else PlantID2 end PlantID from dataDestacking04 xx), "+
                        //" dataDestacking051 as (select PartnoAsal,M3,PlantID from dataDestacking5 xx group by PartnoAsal,M3,PlantID ), "+
                        //" dataDestacking05 as (select PartnoAsal,M3,PlantID,(select count(PartnoAsal) from dataDestacking051 A where A.PartnoAsal=dataDestacking051.PartnoAsal)ttl from dataDestacking051 group by PartnoAsal,M3,PlantID), " +
                        //" dataDestacking6 as (select PartnoAsal,sum(m3)m3,PlantID,ttl from dataDestacking05 group by PlantID,ttl,PartnoAsal), "+
                        //" dataDestacking06 as (select PartnoAsal,case when ttl=1 then m3 when ttl>1 then m3/ttl end m3,PlantID from dataDestacking6 group by PlantID,m3,ttl,PartnoAsal), "+
                        //" dataDestacking7 as ( "+
                        //" select sum(M3)M3,[Group] from ( "+
                        //" select M3/4 M3,B.[Group] from dataDestacking06 A inner join BM_PlantGroup B ON A.PlantID=B.PlantID where B.PlantID>0 "+
                        //" union all "+
                        //" select 0'M3',[Group] from BM_PlantGroup where PlantID>0 ) as x group by [Group] ) "+
                        //" select * into tempDetailDefect_UkuranKhusus from dataDestacking7; "+
                        " /** 5. Detail Defect Ukuran Khusus BP **/ " +
                        " with dataDestacking as (select distinct ItemID,PlantID,left(convert(char,tglproduksi,112),6)ThnBln from BM_Destacking where RowStatus>-1 group by ItemID,PlantiD,TglProduksi ), " +
                        " dataDestacking1 as (select B.PartNo,PlantID,ThnBln from dataDestacking A inner join FC_Items B ON A.ItemID=B.ID), " +
                        " dataDestacking2 as (select x.ItemID,x.PartnoAsal,x.Qty,((A.Tebal*A.Lebar*A.Panjang)/1000000000)*x.Qty M3 from (   select PartNo PartnoAsal,ItemID,isnull(SUM(Qty),0)  * -1 Qty from vw_KartuStockBJNew  where qty <0 and (process  like '%simetris%' ) and  (Keterangan like '%-P-%') and  LokID not In (select ID from FC_Lokasi where lokasi='q99')   and left(convert(char,tanggal,112),8)>=@thnbln1 and  left(convert(char,tanggal,112),8)<=@thnbln2 and ItemID in (select ID  from FC_Items where PartNo like'%-1-%') group by ItemID,Keterangan,PartNo,ItemID   ) as x  inner join FC_Items A ON A.ID=x.ItemID), " +
                        " dataDestacking3 as (select *,(select top 1 A1.ThnBln from dataDestacking1 A1 where A1.PartNo=A.PartnoAsal and A1.ThnBln<=left(convert(char,@thnbln1,112),6) order by A1.ThnBln desc)ThnBln from dataDestacking2 A) , " +
                        " dataDestacking4 as (select PartnoAsal,sum(M3)M3,ThnBln,PlantID from (select A.*,B.PlantID from dataDestacking3 A left join dataDestacking1 B ON A.PartnoAsal=B.PartNo and A.ThnBln=B.ThnBln ) as x group by PartnoAsal,ThnBln,PlantID), " +
                        " dataDestacking04 as (select *,(select top 1 A1.Line from Def_UKhususProsen A1 where A1.Partno=A.PartnoAsal and A1.Periode=left(convert(char,@thnbln1,112),6))PlantID2 from dataDestacking4 A ), " +
                        " dataDestacking5 as (select PartnoAsal,M3,case when PlantID2 is null then PlantID else PlantID2 end PlantID from dataDestacking04 xx), " +
                        " dataDestacking051 as (select PartnoAsal,M3,PlantID from dataDestacking5 xx group by PartnoAsal,M3,PlantID ), " +
                        " dataDestacking05 as (select PartnoAsal,M3,PlantID,(select count(PartnoAsal) from dataDestacking051 A where A.PartnoAsal=dataDestacking051.PartnoAsal)ttl from dataDestacking051 group by PartnoAsal,M3,PlantID), " +
                        " dataDestacking6 as (select PartnoAsal,sum(m3)m3,PlantID,ttl from dataDestacking05 group by PlantID,ttl,PartnoAsal), " +
                        " dataDestacking06 as (select PartnoAsal,case when ttl=1 then m3 when ttl>1 then m3/ttl end m3,PlantID from dataDestacking6 group by PlantID,m3,ttl,PartnoAsal), " +
                        " dataDestacking7 as ( " +
                        " select sum(M3)M3,[Group] from ( " +
                        " select M3/4 M3,B.[Group] from dataDestacking06 A inner join BM_PlantGroup B ON A.PlantID=B.PlantID where B.PlantID>0 " +
                        " union all " +
                        " select 0'M3',[Group] from BM_PlantGroup where PlantID>0 ) as x group by [Group] ) " +
                        " select * into tempDetailDefect_UkuranKhusus  from dataDestacking7; " +

                        " /** 5.1. Detail Defect Ukuran Khusus OK **/ " +
                        //" with dataDestackingOK as (select distinct ItemID,PlantID,left(convert(char,tglproduksi,112),6)ThnBln from BM_Destacking where RowStatus>-1 group by ItemID,PlantiD,TglProduksi ), "+
                        //" dataDestackingOK1 as (select B.PartNo,PlantID,ThnBln from dataDestackingOK A inner join FC_Items B ON A.ItemID=B.ID), "+
                        //" dataDestackingOK2 as (select x.ItemID,x.PartnoAsal,x.Qty,((A.Tebal*A.Lebar*A.Panjang)/1000000000)*x.Qty M3 from (   select PartNo PartnoAsal,ItemID,isnull(SUM(Qty),0)  * -1 Qty from vw_KartuStockBJNew  where qty <0 and (process  like '%simetris%' ) and  (Keterangan like '%-3-%' or Keterangan like '%-M-%') and  LokID not In (select ID from FC_Lokasi where lokasi='q99')   and left(convert(char,tanggal,112),8)>=@thnbln1 and  left(convert(char,tanggal,112),8)<=@thnbln2 and ItemID in (select ID  from FC_Items where PartNo like'%-1-%') group by ItemID,Keterangan,PartNo,ItemID   ) as x  inner join FC_Items A ON A.ID=x.ItemID), " +
                        //" dataDestackingOK3 as (select *,(select top 1 A1.ThnBln from dataDestackingOK1 A1 where A1.PartNo=A.PartnoAsal and A1.ThnBln<=left(convert(char,@thnbln1,112),6) order by A1.ThnBln desc)ThnBln from dataDestackingOK2 A) , " +
                        //" dataDestackingOK4 as (select PartnoAsal,sum(M3)M3,ThnBln,PlantID from (select A.*,B.PlantID from dataDestackingOK3 A left join dataDestackingOK1 B ON A.PartnoAsal=B.PartNo and A.ThnBln=B.ThnBln ) as x group by PartnoAsal,ThnBln,PlantID), "+
                        //" dataDestackingOK04 as (select *,(select top 1 A1.Line from Def_UKhususProsen A1 where A1.rowstatus>-1 and A1.Partno=A.PartnoAsal and A1.Periode=left(convert(char,@thnbln1,112),6))PlantID2 from dataDestackingOK4 A ), "+
                        //" dataDestackingOK5 as (select PartnoAsal,M3,PlantID2 PlantID from dataDestackingOK04 xx), "+
                        //" dataDestackingOK05 as (select PartnoAsal,M3,PlantID from dataDestackingOK5 group by PartnoAsal,M3,PlantID), "+
                        //" dataDestackingOK6 as (select sum(M3)M3,PlantID from dataDestackingOK05 group by PlantID), "+
                        //" dataDestackingOK7 as ( "+
                        //" select sum(M3)M3,[Group] from ( "+
                        //" select M3/4 M3,B.[Group] from dataDestackingOK6 A inner join BM_PlantGroup B ON A.PlantID=B.PlantID where B.PlantID>0 "+
                        //" union all "+
                        //" select 0'M3',[Group] from BM_PlantGroup where PlantID>0 ) as x group by [Group] ) "+
                        //" select * into tempDetailDefect_UkuranKhususOK from dataDestackingOK7; "+ 

                        " with dataDestackingOK as (select distinct ItemID,PlantID,left(convert(char,tglproduksi,112),6)ThnBln from BM_Destacking where RowStatus>-1 group by ItemID,PlantiD,TglProduksi ), " +
                        " dataDestackingOK1 as (select B.PartNo,PlantID,ThnBln from dataDestackingOK A inner join FC_Items B ON A.ItemID=B.ID), " +
                        " dataDestackingOK2 as (select x.ItemID,x.PartnoAsal,x.Qty,((A.Tebal*A.Lebar*A.Panjang)/1000000000)*x.Qty M3 from (   select PartNo PartnoAsal,ItemID,isnull(SUM(Qty),0)  * -1 Qty from vw_KartuStockBJNew  where qty <0 and (process  like '%simetris%' ) and  (Keterangan like '%-3-%' or Keterangan like '%-M-%') and  LokID not In (select ID from FC_Lokasi where lokasi='q99')   and left(convert(char,tanggal,112),8)>=@thnbln1 and  left(convert(char,tanggal,112),8)<=@thnbln2 and ItemID in (select ID  from FC_Items where PartNo like'%-1-%') group by ItemID,Keterangan,PartNo,ItemID   ) as x  inner join FC_Items A ON A.ID=x.ItemID), " +
                        " dataDestackingOK3 as (select *,(select top 1 A1.ThnBln from dataDestackingOK1 A1 where A1.PartNo=A.PartnoAsal and A1.ThnBln<=left(convert(char,@thnbln1,112),6) order by A1.ThnBln desc)ThnBln from dataDestackingOK2 A) , " +
                        " dataDestackingOK4 as (select PartnoAsal,sum(M3)M3,ThnBln,PlantID from (select A.*,B.PlantID from dataDestackingOK3 A left join dataDestackingOK1 B ON A.PartnoAsal=B.PartNo and A.ThnBln=B.ThnBln ) as x group by PartnoAsal,ThnBln,PlantID), " +
                        //" dataDestackingOK04 as (select *,(select top 1 A1.Line from Def_UKhususProsen A1 where A1.Partno=A.PartnoAsal and A1.Periode=left(convert(char,@thnbln1,112),6))PlantID2 from dataDestackingOK4 A ), "+
                        " dataDestackingOK04 as (select *,case when ThnBln is null then (select top 1 A2.Periode from Def_UKhususProsen A2 where A2.PartNo=A.PartNoAsal and A2.rowstatus>-1 and Periode=left(convert(char,@thnbln1,112),6)) else ThnBln end ThnBln2,(select top 1 A1.Line from Def_UKhususProsen A1 where A1.Partno=A.PartnoAsal and A1.Periode=left(convert(char,@thnbln1,112),6))PlantID2 from dataDestackingOK4 A ), " +
                        //" dataDestackingOK5 as (select PartnoAsal,M3,PlantID2 PlantID from dataDestackingOK04 xx), "+
                        //" dataDestackingOK05 as (select PartnoAsal,M3,PlantID from dataDestackingOK5 group by PartnoAsal,M3,PlantID), "+
                        //" dataDestackingOK5 as (select PartnoAsal,M3,case when plantid is null then PlantID2 else PlantID end PlantID from dataDestackingOK04 xx), "+
                        " dataDestackingOK5 as (select PartnoAsal,M3,case when plantid is null then PlantID2 when PlantID2 is null then PlantID else PlantID2 end PlantID from dataDestackingOK04 xx), " +
                        " dataDestackingOK05 as (select PartnoAsal,M3,PlantID from dataDestackingOK5 group by PartnoAsal,M3,PlantID), " +

                        " dataDestackingOK005 as (select A.*,(select count(A1.PartnoAsal) from dataDestackingOK05 A1 where A1.PartnoAsal=A.PartnoAsal and A1.M3=A.M3)Ttl from dataDestackingOK05 A), " +
                        " dataDestackingOK06 as (select PartnoAsal,M3/ttl M3,PlantID from dataDestackingOK005), " +

                        " dataDestackingOK6 as (select sum(M3)M3,PlantID from dataDestackingOK06 group by PlantID), " +
                        " dataDestackingOK7 as ( " +
                        " select sum(M3)M3,[Group] from ( " +
                        " select M3/4 M3,B.[Group] from dataDestackingOK6 A inner join BM_PlantGroup B ON A.PlantID=B.PlantID where B.PlantID>0 " +
                        " union all " +
                        " select 0'M3',[Group] from BM_PlantGroup where PlantID>0 ) as x group by [Group] ) " +
                        " select * into tempDetailDefect_UkuranKhususOK from dataDestackingOK7; " +

                        " /** 6. Perhitungan Defect ListPlank BP ( Detail Defect ListPlank ) **/   " +
                        " with  " +
                        " Listplank as (select distinct ItemID,PlantID,left(convert(char,tglproduksi,112),6)ThnBln from BM_Destacking where RowStatus>-1 group by ItemID,PlantiD,TglProduksi ), " +
                        " Listplank1 as (select B.PartNo,PlantID,ThnBln from Listplank A inner join FC_Items B ON A.ItemID=B.ID), " +
                        " Listplank2 as ( " +
                        " select PartnoAsal,isnull(cast((sum(M3)) as decimal(18,1)),0) M3  from ( " +
                        " select PartnoAsal,isnull(cast((sum(M3)) as decimal(18,2)),0)M3  from (  select PartnoAsal,Qty,cast((((Tebal*Lebar*Panjang)/1000000000)*Qty) as decimal(18,5)) M3  from (  select PartnoAsal,PartNo2,sum(Qty)Qty,Tebal,Lebar,Panjang  from (  select x1.PartNo PartnoAsal,x2.PartNo PartNo2,x2.Tebal,x2.Lebar,x2.Panjang,x.Qty from (  select ItemID0,itemid,Qty * -1 Qty from vw_KartuStockListplank where left(convert(char,tanggal,112),8)>=@thnbln1 and  left(convert(char,tanggal,112),8)<=@thnbln2 and process='runingsaw' and qty<0 ) as x   inner join FC_Items x1 ON x.ItemID0=x1.ID  inner join FC_Items x2 ON x.ItemID=x2.ID) as A group by PartnoAsal,PartNo2,Tebal,Lebar,Panjang ) as xx ) as xx1  group by PartnoAsal " +
                        " union all " +
                        " /** 2. Saldo Awal Running Saw **/   " +
                        " select PartnoAsal,isnull(cast((sum((Volume*Qty))) as decimal(18,2)),0) M3  from (  select x2.PartNo PartnoAsal,cast(((x1.Tebal*x1.Lebar*x1.Panjang)/1000000000) as decimal(10,5))Volume,x.Qty  from (  select sum(saldo)Qty ,ItemID,ItemID0 from T1_SaldoListPlank where Process='runingsaw' and thnbln=@BlnThn and Saldo>0 and ItemID<>ItemID0 group by ItemID,ItemID0 ) as x    inner join FC_Items x1 ON x.ItemID=x1.ID  inner join FC_Items x2 ON x.ItemID0=x2.ID) as A group by PartnoAsal " +
                        " union all  " +
                        " /** 3. Saldo Akhir RunningSaw **/ " +
                        " select PartnoAsal,isnull(cast((sum(M3)) as decimal(18,2)) * -1,0) M3 from (  select PartnoAsal,Qty,cast((((Tebal*Lebar*Panjang)/1000000000)*Qty) as decimal(18,5)) M3  from (  select PartnoAsal,PartNo2,sum(Qty)Qty,Tebal,Lebar,Panjang  from (  select x1.PartNo PartnoAsal,x2.PartNo PartNo2,x2.Tebal,x2.Lebar,x2.Panjang,x.Qty from (  select sum(Saldo)Qty,ItemID0,ItemID from T1_SaldoListPlank where Process='runingsaw' and thnbln=left(convert(char,@thnbln1,112),6) and Saldo>0 and ItemID<>ItemID0  group by ItemID0,ItemID ) as x   inner join FC_Items x1 ON x.ItemID0=x1.ID  inner join FC_Items x2 ON x.ItemID=x2.ID) as A group by PartnoAsal,PartNo2,Tebal,Lebar,Panjang ) as xx ) as xx1    group by PartnoAsal " +
                        " union all  " +
                        " /** 4. Saldo Awal Bevel **/  " +
                        " select PartnoAsal,isnull(cast((sum(M3)) as decimal(18,2)),0) M3  from (  select PartnoAsal,Qty,cast((((Tebal*Lebar*Panjang)/1000000000)*Qty) as decimal(18,5)) M3  from (  select PartnoAsal,PartNo2,sum(Qty)Qty,Tebal,Lebar,Panjang  from (  select x1.PartNo PartnoAsal,x2.PartNo PartNo2,x2.Tebal,x2.Lebar,x2.Panjang,x.Qty from (  select sum(Saldo)Qty,ItemID0,ItemID from T1_SaldoListPlank where Process='bevel' and thnbln=@BlnThn and Saldo>0 group by ItemID0,ItemID ) as x   inner join FC_Items x1 ON x.ItemID0=x1.ID  inner join FC_Items x2 ON x.ItemID=x2.ID) as A group by PartnoAsal,PartNo2,Tebal,Lebar,Panjang ) as xx ) as xx1 group by PartnoAsal  " +
                        " union all  " +
                        " /** 5. Saldo Akhir Bevel **/   " +
                        " select PartnoAsal,isnull(cast((sum(M3)) as decimal(18,2)) * -1,0) M3 from (  select PartnoAsal,Qty,cast((((Tebal*Lebar*Panjang)/1000000000)*Qty) as decimal(18,5)) M3  from (  select PartnoAsal,PartNo2,sum(Qty)Qty,Tebal,Lebar,Panjang  from (  select x1.PartNo PartnoAsal,x2.PartNo PartNo2,x2.Tebal,x2.Lebar,x2.Panjang,x.Qty from (  select sum(Saldo)Qty,ItemID0,ItemID from T1_SaldoListPlank where Process='bevel' and thnbln=left(convert(char,@thnbln1,112),6) and Saldo>0 and ItemID<>ItemID0  group by ItemID0,ItemID ) as x   inner join FC_Items x1 ON x.ItemID0=x1.ID  inner join FC_Items x2 ON x.ItemID=x2.ID) as A group by PartnoAsal,PartNo2,Tebal,Lebar,Panjang ) as xx ) as xx1   group by PartnoAsal  " +
                        " union all " +
                        " /** 6. Saldo Awal Strapping **/   " +
                        " select PartnoAsal,isnull(cast((sum(M3)) as decimal(18,2)),0) M3 from (select PartnoAsal,Qty,cast((((Tebal*Lebar*Panjang)/1000000000)*Qty) as decimal(18,5)) M3  from (  select PartnoAsal,PartNo2,sum(Qty)Qty,Tebal,Lebar,Panjang  from (  select x1.PartNo PartnoAsal,x2.PartNo PartNo2,x2.Tebal,x2.Lebar,x2.Panjang,x.Qty from (  select sum(Saldo)Qty,ItemID0,ItemID from T1_SaldoListPlank where Process='straping' and thnbln=@BlnThn and Saldo>0 group by ItemID0,ItemID ) as x   inner join FC_Items x1 ON x.ItemID0=x1.ID  inner join FC_Items x2 ON x.ItemID=x2.ID) as A group by PartnoAsal,PartNo2,Tebal,Lebar,Panjang ) as xx ) as xx1 group by PartnoAsal " +
                        " union all  " +
                        " /** 7. Saldo Akhir Strapping **/ " +
                        " select PartnoAsal,isnull(cast((sum(M3)) as decimal(18,2))* -1,0) M3 from (  select PartnoAsal,Qty,cast((((Tebal*Lebar*Panjang)/1000000000)*Qty) as decimal(18,5)) M3  from (  select PartnoAsal,PartNo2,sum(Qty)Qty,Tebal,Lebar,Panjang  from (  select x1.PartNo PartnoAsal,x2.PartNo PartNo2,x2.Tebal,x2.Lebar,x2.Panjang,x.Qty from (  select sum(Saldo)Qty,ItemID0,ItemID from T1_SaldoListPlank where Process='straping' and thnbln=left(convert(char,@thnbln1,112),6) and Saldo>0 and ItemID<>ItemID0  group by ItemID0,ItemID ) as x   inner join FC_Items x1 ON x.ItemID0=x1.ID  inner join FC_Items x2 ON x.ItemID=x2.ID) as A group by PartnoAsal,PartNo2,Tebal,Lebar,Panjang ) as xx ) as xxx group by PartnoAsal " +
                        " union all " +
                        " /** 8. Tahap III OK **/    " +
                        " select PartnoAsal,isnull(cast((sum(M3))*-1 as decimal(18,2)),0) M3 from (  select PartnoAsal,Qty,cast((((Tebal*Lebar*Panjang)/1000000000)*Qty) as decimal(18,5)) M3  from (  select PartnoAsal,sum(Qty)Qty,Tebal,Lebar,Panjang  from (  select x.PartNo PartnoAsal,x2.Tebal,x2.Lebar,x2.Panjang,x.Qty from (  select sum(Qty)Qty,ItemID,Keterangan Partno from vw_KartuStockBJNew  where sfrom='straping' and left(convert(char,tanggal,112),6)=left(convert(char,@thnbln1,112),6) and ItemID in  (select ID from FC_Items where PartNo like'%-M-%' or PartNo like'%-3-%')  group by ItemID,Keterangan ) as x   inner join FC_Items x2 ON x.ItemID=x2.ID) as A group by PartnoAsal,Tebal,Lebar,Panjang ) as xx ) as xx1 group by PartnoAsal " +
                        " union all  " +
                        " /** 9. Tahap III BP **/  " +
                        " select PartnoAsal,isnull(cast((sum(M3)) as decimal(18,2)),0) M3  from (  select PartnoAsal,Qty,cast((((Tebal*Lebar*Panjang)/1000000000)*Qty) as decimal(18,5))  M3  from (  select PartnoAsal,sum(Qty)Qty,Tebal,Lebar,Panjang  from (  select x.PartNo PartnoAsal,x2.Tebal,x2.Lebar,x2.Panjang,x.Qty from (  select sum(Qty)Qty,ItemID,Keterangan Partno from vw_KartuStockBJNew  where sfrom='straping' and left(convert(char,tanggal,112),6)=left(convert(char,@thnbln1,112),6) and  ItemID in (select ID from FC_Items where PartNo like'%-P-%' or PartNo like'%-S-%')  group by ItemID,Keterangan ) as x   inner join FC_Items x2 ON x.ItemID=x2.ID) as A group by PartnoAsal,Tebal,Lebar,Panjang ) as xx ) as xx1 group by PartnoAsal " +
                        " ) as DataFinall group by PartnoAsal ) ,  " +

                        //" Listplank3 as (select *,(select top 1 A1.ThnBln from Listplank1 A1 where A1.PartNo=A.PartnoAsal and A1.ThnBln<=left(convert(char,@thnbln1,112),6) order by A1.ThnBln desc)ThnBln from Listplank2 A) , "+
                        //" Listplank4 as (select PartnoAsal,sum(M3)M3,ThnBln,PlantID from (select A.*,B.PlantID from Listplank3 A left join Listplank1 B ON A.PartnoAsal=B.PartNo and A.ThnBln=B.ThnBln ) as x group by PartnoAsal,ThnBln,PlantID), "+
                        //" Listplank04 as (select *,(select top 1 A1.Line from Def_UKhususProsen A1 where A1.rowstatus>-1 and A1.Partno=A.PartnoAsal and A1.Periode=left(convert(char,@thnbln1,112),6))PlantID2 from Listplank4 A ), "+
                        //" Listplank5 as (select PartnoAsal,M3,case when PlantID2 is null then PlantID else PlantID2 end PlantID from Listplank04 xx), " +
                        //" Listplank051 as (select PartnoAsal,M3,PlantID from Listplank5 xx group by PartnoAsal,M3,PlantID ), "+
                        //" Listplank05 as (select PartnoAsal,M3,PlantID,(select count(PartnoAsal) from Listplank051 A where A.PartnoAsal=Listplank051.PartnoAsal)ttl from Listplank051 group by PartnoAsal,M3,PlantID), " +
                        //" Listplank6 as (select PartnoAsal,sum(m3)m3,PlantID,ttl from Listplank05 group by PlantID,ttl,PartnoAsal), "+
                        //" Listplank06 as (select PartnoAsal,case when ttl=1 then m3 when ttl>1 then m3/ttl end m3,PlantID from Listplank6 group by PlantID,m3,ttl,PartnoAsal), "+
                        //" Listplank7 as ( "+
                        //" select sum(M3)M3,[Group] from ( "+
                        //" select M3/4 M3,B.[Group] from Listplank06 A inner join BM_PlantGroup B ON A.PlantID=B.PlantID where B.PlantID>0 "+
                        //" union all "+
                        //" select 0'M3',[Group] from BM_PlantGroup where PlantID>0 ) as x group by [Group] ) "+
                        //" select * into tempDetail_Listplank from Listplank7; "+

                        " Listplank3 as (select *,(select top 1 A1.ThnBln from Listplank1 A1 where A1.PartNo=A.PartnoAsal and A1.ThnBln<=left(convert(char,@thnbln1,112),6) order by A1.ThnBln desc)ThnBln from Listplank2 A) , " +
                        " Listplank4 as (select PartnoAsal,sum(M3)M3,ThnBln,PlantID from (select A.*,B.PlantID from Listplank3 A left join Listplank1 B ON A.PartnoAsal=B.PartNo and A.ThnBln=B.ThnBln ) as x group by PartnoAsal,ThnBln,PlantID), " +
                        " Listplank04 as (select *,(select top 1 A1.Line from Def_UKhususProsen A1 where A1.Partno=A.PartnoAsal and A1.Periode=left(convert(char,@thnbln1,112),6))PlantID2 from Listplank4 A ), " +
                        " Listplank5 as (select PartnoAsal,M3,case when PlantID2 is null then PlantID else PlantID2 end PlantID from Listplank04 xx), " +
                        " Listplank051 as (select PartnoAsal,M3,PlantID from Listplank5 xx group by PartnoAsal,M3,PlantID ), " +
                        " Listplank05 as (select PartnoAsal,M3,PlantID,(select count(PartnoAsal) from Listplank051 A where A.PartnoAsal=Listplank051.PartnoAsal)ttl from Listplank051 group by PartnoAsal,M3,PlantID), " +
                        " Listplank6 as (select PartnoAsal,sum(m3)m3,PlantID,ttl from Listplank05 group by PlantID,ttl,PartnoAsal), " +
                        " Listplank06 as (select PartnoAsal,case when ttl=1 then m3 when ttl>1 then m3/ttl end m3,PlantID from Listplank6 group by PlantID,m3,ttl,PartnoAsal), " +
                        " Listplank7 as ( " +
                        " select sum(M3)M3,[Group] from ( " +
                        " select M3/4 M3,B.[Group] from Listplank06 A inner join BM_PlantGroup B ON A.PlantID=B.PlantID where B.PlantID>0 " +
                        " union all " +
                        " select 0'M3',[Group] from BM_PlantGroup where PlantID>0 ) as x group by [Group] ) " +
                        " select *  into tempDetail_Listplank from Listplank7; " +

                        /** tambahan **/
                        " with   AListplank as (select distinct ItemID,PlantID,left(convert(char,tglproduksi,112),6)ThnBln from BM_Destacking where RowStatus>-1 group by ItemID,PlantiD,TglProduksi ),  " +

                        " AListplank1 as (select B.PartNo,PlantID,ThnBln from AListplank A inner join FC_Items B ON A.ItemID=B.ID),  Listplank2 as (  select PartnoAsal,isnull(cast((sum(M3)) as decimal(18,1)),0) M3  from (  select PartnoAsal,isnull(cast((sum(M3)) as decimal(18,2)),0)M3  from (  select PartnoAsal,Qty,cast((((Tebal*Lebar*Panjang)/1000000000)*Qty) as decimal(18,5)) M3  from (  select PartnoAsal,PartNo2,sum(Qty)Qty,Tebal,Lebar,Panjang  from (  select x1.PartNo PartnoAsal,x2.PartNo PartNo2,x2.Tebal,x2.Lebar,x2.Panjang,x.Qty from (  select ItemID0,itemid,Qty * -1 Qty from vw_KartuStockListplank where left(convert(char,tanggal,112),8)>=@thnbln1 and  left(convert(char,tanggal,112),8)<=@thnbln2 and process='runingsaw' and qty<0 ) as x   inner join FC_Items x1 ON x.ItemID0=x1.ID  inner join FC_Items x2 ON x.ItemID=x2.ID) as A group by PartnoAsal,PartNo2,Tebal,Lebar,Panjang ) as xx ) as xx1  group by PartnoAsal  " +
                        " union all " +
                        " /** 2. Saldo Awal Running Saw **/  " +
                        " select PartnoAsal,isnull(cast((sum((Volume*Qty))) as decimal(18,2)),0) M3  from (  select x2.PartNo PartnoAsal,cast(((x1.Tebal*x1.Lebar*x1.Panjang)/1000000000) as decimal(10,5))Volume,x.Qty  from (  select sum(saldo)Qty ,ItemID,ItemID0 from T1_SaldoListPlank where Process='runingsaw' and thnbln=@BlnThn and Saldo>0 and ItemID<>ItemID0 group by ItemID,ItemID0 ) as x    inner join FC_Items x1 ON x.ItemID=x1.ID  inner join FC_Items x2 ON x.ItemID0=x2.ID) as A group by PartnoAsal  " +
                        "  union all " +
                        "  /** 3. Saldo Akhir RunningSaw **/  " +
                        "  select PartnoAsal,isnull(cast((sum(M3)) as decimal(18,2)) * -1,0) M3 from (  select PartnoAsal,Qty,cast((((Tebal*Lebar*Panjang)/1000000000)*Qty) as decimal(18,5)) M3  from (  select PartnoAsal,PartNo2,sum(Qty)Qty,Tebal,Lebar,Panjang  from (  select x1.PartNo PartnoAsal,x2.PartNo PartNo2,x2.Tebal,x2.Lebar,x2.Panjang,x.Qty from (  select sum(Saldo)Qty,ItemID0,ItemID from T1_SaldoListPlank where Process='runingsaw' and thnbln=left(convert(char,@thnbln1,112),6) and Saldo>0 and ItemID<>ItemID0  group by ItemID0,ItemID ) as x   inner join FC_Items x1 ON x.ItemID0=x1.ID  inner join FC_Items x2 ON x.ItemID=x2.ID) as A group by PartnoAsal,PartNo2,Tebal,Lebar,Panjang ) as xx ) as xx1    group by PartnoAsal  " +
                        " union all   " +
                        " /** 4. Saldo Awal Bevel **/   " +
                        " select PartnoAsal,isnull(cast((sum(M3)) as decimal(18,2)),0) M3  from (  select PartnoAsal,Qty,cast((((Tebal*Lebar*Panjang)/1000000000)*Qty) as decimal(18,5)) M3  from (  select PartnoAsal,PartNo2,sum(Qty)Qty,Tebal,Lebar,Panjang  from (  select x1.PartNo PartnoAsal,x2.PartNo PartNo2,x2.Tebal,x2.Lebar,x2.Panjang,x.Qty from (  select sum(Saldo)Qty,ItemID0,ItemID from T1_SaldoListPlank where Process='bevel' and thnbln=@BlnThn and Saldo>0 group by ItemID0,ItemID ) as x   inner join FC_Items x1 ON x.ItemID0=x1.ID  inner join FC_Items x2 ON x.ItemID=x2.ID) as A group by PartnoAsal,PartNo2,Tebal,Lebar,Panjang ) as xx ) as xx1 group by PartnoAsal   union all   " +
                        " /** 5. Saldo Akhir Bevel **/   " +
                        " select PartnoAsal,isnull(cast((sum(M3)) as decimal(18,2)) * -1,0) M3 from (  select PartnoAsal,Qty,cast((((Tebal*Lebar*Panjang)/1000000000)*Qty) as decimal(18,5)) M3  from (  select PartnoAsal,PartNo2,sum(Qty)Qty,Tebal,Lebar,Panjang  from (  select x1.PartNo PartnoAsal,x2.PartNo PartNo2,x2.Tebal,x2.Lebar,x2.Panjang,x.Qty from (  select sum(Saldo)Qty,ItemID0,ItemID from T1_SaldoListPlank where Process='bevel' and thnbln=left(convert(char,@thnbln1,112),6) and Saldo>0 and ItemID<>ItemID0  group by ItemID0,ItemID ) as x   inner join FC_Items x1 ON x.ItemID0=x1.ID  inner join FC_Items x2 ON x.ItemID=x2.ID) as A group by PartnoAsal,PartNo2,Tebal,Lebar,Panjang ) as xx ) as xx1   group by PartnoAsal   union all  " +
                        " /** 6. Saldo Awal Strapping **/  " +
                        " select PartnoAsal,isnull(cast((sum(M3)) as decimal(18,2)),0) M3 from (select PartnoAsal,Qty,cast((((Tebal*Lebar*Panjang)/1000000000)*Qty) as decimal(18,5)) M3  from (  select PartnoAsal,PartNo2,sum(Qty)Qty,Tebal,Lebar,Panjang  from (  select x1.PartNo PartnoAsal,x2.PartNo PartNo2,x2.Tebal,x2.Lebar,x2.Panjang,x.Qty from (  select sum(Saldo)Qty,ItemID0,ItemID from T1_SaldoListPlank where Process='straping' and thnbln=@BlnThn and Saldo>0 group by ItemID0,ItemID ) as x   inner join FC_Items x1 ON x.ItemID0=x1.ID  inner join FC_Items x2 ON x.ItemID=x2.ID) as A group by PartnoAsal,PartNo2,Tebal,Lebar,Panjang ) as xx ) as xx1 group by PartnoAsal  " +
                        " union all   " +
                        " /** 7. Saldo Akhir Strapping **/  " +
                        " select PartnoAsal,isnull(cast((sum(M3)) as decimal(18,2))* -1,0) M3 from (  select PartnoAsal,Qty,cast((((Tebal*Lebar*Panjang)/1000000000)*Qty) as decimal(18,5)) M3  from (  select PartnoAsal,PartNo2,sum(Qty)Qty,Tebal,Lebar,Panjang  from (  select x1.PartNo PartnoAsal,x2.PartNo PartNo2,x2.Tebal,x2.Lebar,x2.Panjang,x.Qty from (  select sum(Saldo)Qty,ItemID0,ItemID from T1_SaldoListPlank where Process='straping' and thnbln=left(convert(char,@thnbln1,112),6) and Saldo>0 and ItemID<>ItemID0  group by ItemID0,ItemID ) as x   inner join FC_Items x1 ON x.ItemID0=x1.ID  inner join FC_Items x2 ON x.ItemID=x2.ID) as A group by PartnoAsal,PartNo2,Tebal,Lebar,Panjang ) as xx ) as xxx group by PartnoAsal  " +
                        "  ) as DataFinall group by PartnoAsal ) ,  " +
                        " AListplank3 as (select *,(select top 1 A1.ThnBln from AListplank1 A1 where A1.PartNo=A.PartnoAsal and A1.ThnBln<=left(convert(char,@thnbln1,112),6) order by A1.ThnBln desc)ThnBln from Listplank2 A) , " +
                        " AListplank4 as (select PartnoAsal,sum(M3)M3,ThnBln,PlantID from (select A.*,B.PlantID from AListplank3 A left join AListplank1 B ON A.PartnoAsal=B.PartNo and A.ThnBln=B.ThnBln ) as x group by PartnoAsal,ThnBln,PlantID),  " +
                        " AListplank04 as (select *,(select top 1 A1.Line from Def_UKhususProsen A1 where A1.Partno=A.PartnoAsal and A1.Periode=left(convert(char,@thnbln1,112),6))PlantID2 from AListplank4 A ),  " +
                        " AListplank5 as (select PartnoAsal,M3,case when PlantID2 is null then PlantID else PlantID2 end PlantID from AListplank04 xx), " +
                        " AListplank051 as (select PartnoAsal,M3,PlantID from AListplank5 xx group by PartnoAsal,M3,PlantID ),  " +
                        " AListplank05 as (select PartnoAsal,M3,PlantID,(select count(PartnoAsal) from AListplank051 A where A.PartnoAsal=AListplank051.PartnoAsal)ttl from AListplank051 group by PartnoAsal,M3,PlantID),  " +
                        " AListplank6 as (select PartnoAsal,sum(m3)m3,PlantID,ttl from AListplank05 group by PlantID,ttl,PartnoAsal), " +
                        " AListplank06 as (select PartnoAsal,case when ttl=1 then m3 when ttl>1 then m3/ttl end m3,PlantID from AListplank6 group by PlantID,m3,ttl,PartnoAsal), " +
                        " AListplank7 as (  select sum(M3)M3,[Group] from (  select M3/4 M3,B.[Group] from AListplank06 A inner join BM_PlantGroup B ON A.PlantID=B.PlantID where B.PlantID>0  " +
                        " union all " +
                        " select 0'M3',[Group] from BM_PlantGroup where PlantID>0 ) as x group by [Group] )  " +

                        " select * into AtempDetail_Listplank from AListplank7; " +

                        " /** 6. Perhitungan Defect ListPlank dikurangi OK - BP ( Detail Defect ListPlank ) **/   " +
                        " with  " +
                        " LP as (select distinct ItemID,PlantID,left(convert(char,tglproduksi,112),6)ThnBln from BM_Destacking where RowStatus>-1 group by ItemID,PlantiD,TglProduksi ), " +
                        " LP01 as (select B.PartNo,PlantID,ThnBln from LP A inner join FC_Items B ON A.ItemID=B.ID), " +
                        " LP02 as ( " +
                        " select PartnoAsal,isnull(cast((sum(M3)) as decimal(18,1)),0) M3  from ( " +
                        " /** 1. Tahap III OK **/   " +
                        " select PartnoAsal,isnull(cast((sum(M3))*-1 as decimal(18,2)),0) M3 from (  select PartnoAsal,Qty,cast((((Tebal*Lebar*Panjang)/1000000000)*Qty) as decimal(18,5)) M3  from (  select PartnoAsal,sum(Qty)Qty,Tebal,Lebar,Panjang  from (  select x.PartNo PartnoAsal,x2.Tebal,x2.Lebar,x2.Panjang,x.Qty from (  select sum(Qty)Qty,ItemID,Keterangan Partno from vw_KartuStockBJNew  where sfrom='straping' and left(convert(char,tanggal,112),6)=left(convert(char,@thnbln1,112),6) and ItemID in  (select ID from FC_Items where PartNo like'%-M-%' or PartNo like'%-3-%')  group by ItemID,Keterangan ) as x   inner join FC_Items x2 ON x.ItemID=x2.ID) as A group by PartnoAsal,Tebal,Lebar,Panjang ) as xx ) as xx1 group by PartnoAsal " +
                        " /** union all " +
                        " /** 2. Tahap III BP **/ " +
                        " select PartnoAsal,isnull(cast((sum(M3)) as decimal(18,2)),0) M3  from (  select PartnoAsal,Qty,cast((((Tebal*Lebar*Panjang)/1000000000)*Qty) as decimal(18,5))  M3  from (  select PartnoAsal,sum(Qty)Qty,Tebal,Lebar,Panjang  from (  select x.PartNo PartnoAsal,x2.Tebal,x2.Lebar,x2.Panjang,x.Qty from (  select sum(Qty)Qty,ItemID,Keterangan Partno from vw_KartuStockBJNew  where sfrom='straping' and left(convert(char,tanggal,112),6)=left(convert(char,@thnbln1,112),6) and  ItemID in (select ID from FC_Items where PartNo like'%-P-%' or PartNo like'%-S-%')  group by ItemID,Keterangan ) as x   inner join FC_Items x2 ON x.ItemID=x2.ID) as A group by PartnoAsal,Tebal,Lebar,Panjang ) as xx ) as xx1 group by PartnoAsal **/ " +
                        " ) as DataFinall group by PartnoAsal ) ,  " +

                        " LP03 as (select *,(select top 1 A1.ThnBln from LP01 A1 where A1.PartNo=A.PartnoAsal and A1.ThnBln<=left(convert(char,@thnbln1,112),6) order by A1.ThnBln desc)ThnBln from LP02 A) , " +
                        " LP04 as (select PartnoAsal,sum(M3)M3,ThnBln,PlantID from (select A.*,B.PlantID from LP03 A left join LP01 B ON A.PartnoAsal=B.PartNo and A.ThnBln=B.ThnBln ) as x group by PartnoAsal,ThnBln,PlantID), " +
                        " LP004 as (select *,(select top 1 A1.Line from Def_UKhususProsen A1 where A1.rowstatus>-1 and A1.Partno=A.PartnoAsal and A1.Periode=left(convert(char,@thnbln1,112),6))PlantID2 from LP04 A ), " +
                        " LP05 as (select PartnoAsal,M3,case when PlantID2 is null then PlantID else PlantID2 end PlantID from LP004 xx),  " +
                        " LP005 as (select PartnoAsal,M3,PlantID from LP05 group by PartnoAsal,M3,PlantID), " +
                        " LP06 as (select sum(M3)M3,PlantID from LP005 group by PlantID), " +
                        " LP07 as ( " +
                        " select sum(M3)M3,[Group] from ( " +
                        " select M3/4 M3,B.[Group] from LP06 A inner join BM_PlantGroup B ON A.PlantID=B.PlantID where B.PlantID>0 " +
                        " union all " +
                        " select 0'M3',[Group] from BM_PlantGroup where PlantID>0 ) as x group by [Group] ) " +
                        " select * into tempDetail_Listplank0 from LP07; " +

                        " /** 7. Detail Defect Produksi **/ " +
                        " select sum(M3)M3,[Group] into tempDefectProduksi from ( " +
                        " select M3,[Group] from tempDefectBMFin union all  " +
                        " select M3,[Group] from tempDetail_Listplank union all  " +
                        " select M3,[Group] from tempDetailDefect_UkuranKhusus ) as x group by [Group] " +

                        " /** Total Group Produksi **/  " +
                        " declare @TtlGroup varchar(3)  " +
                        " set @TtlGroup=(select count([Group])TtlGroup from (  select [Group] from (  select [Group] from detailDfctSystemBM_M3  " +
                        " union all   " +
                        " select [Group] from DtlDefectSystemFN_M3 ) as x group by [Group] ) as x1)  ; " +
                        " /** End Total Group Produksi **/ " +

                        " /** 8.1. Total BS Tahap 1 **/ " +

                        " select distinct itemid into tempDataBSauto from vw_KartuStockBJNew where itemid in (select ID from fc_items where partno like '%-s-%') and LokID in (select ID from FC_Lokasi where Lokasi='bsauto') " +

                        " ;with BSTahap as (select distinct itemid from vw_KartuStockBJNew where itemid in (select ID from fc_items where partno like '%-s-%') and  LokID in (select ID from FC_Lokasi where Lokasi='bsauto')  ), " +
                        " BSTahap1 as (select * from vw_KartuStockBJNew where left(CONVERT(char, tanggal ,112),6)=left(convert(char,@thnbln1,112),6) and itemID in   (select itemid from tempDataBSauto)), " +
                        " BSTahap2 as (select * from vw_KartuStockBJNew where left(CONVERT(char, tanggal ,112),6)=left(convert(char,@thnbln1,112),6) and itemID not in   (select itemid from tempDataBSauto) ), " +
                        " BSTahap3 as (select isnull(sum(Qty),0)Qty,isnull(sum(Qty*Volume),0)M3  from (  select x.qty Qty,((x1.Tebal*x1.Lebar*x1.Panjang)/1000000000)Volume from (  select Qty,ItemID from BSTahap1 where (process='direct' or process like'%Simetris%') and (isnull(sfrom,'-')='-' or isnull(sfrom,'bevel')='-'  or isnull(sfrom,'-')='straping') and lokid in (select ID from FC_Lokasi where Lokasi='BSAUTO') and substring(Keterangan,1,21) like '%-1-%'  and left(convert(char,tanggal,112),6)=left(convert(char,@thnbln1,112),6) and PartNo  like'%-S-%') as x inner join FC_Items x1 ON x.ItemID=x1.ID ) as A  ), " +
                        " BSTahap4 as (select isnull(sum(Qty),0)Qty,isnull(sum(Qty*Volume),0)M3 from (  select x.qty Qty,((x1.Tebal*x1.Lebar*x1.Panjang)/1000000000)Volume from (  select Qty,ItemID from BSTahap2 where (process='direct' or process like'%Simetris%') and (isnull(sfrom,'-')='-' or isnull(sfrom,'bevel')='-'  or isnull(sfrom,'-')='straping') and lokid not in (select ID from FC_Lokasi where Lokasi='BSAUTO') and substring(Keterangan,1,21) like '%-1-%'  and left(convert(char,tanggal,112),6)=left(convert(char,@thnbln1,112),6) and PartNo  like'%-S-%') as x inner join FC_Items x1 ON x.ItemID=x1.ID ) as A ), " +
                        " BSTahap5 as (select isnull(cast(sum(M3) as decimal(18,1)),0) M3 from (select M3 from BSTahap3 union all select M3 from BSTahap4) as x ) " +
                        " select * into tempTotalBSTahap1 from BSTahap5 " +

                        " declare @TtlBS_Tahap1 varchar(10)   " +
                        " set @TtlBS_Tahap1 = (select M3 from tempTotalBSTahap1)   " +

                        " /** 8.2. Detail BS Tahap 1 **/ " +
                        " select [Group],cast(((M3/@TtlDfctSystemBM_M3)* @TtlBS_Tahap1) as decimal(18,2))  M3 into tempDetailBSTahap1 from detailDfctSystemBM_M3 order by [group]  " +

                        " /** 9. Detail Total Defect Proposionet **/ " +
                        " select sum(M3)M3,[Group] into tempDetailTotalDefect_P from ( " +
                        " select M3,[Group] from tempDefectBMFin  " +
                        " union all " +
                        " select M3,[Group] from tempDetailDefect_UkuranKhusus " +
                        " union all " +
                        " select M3,[Group] from tempDetail_Listplank  " +
                        " union all " +
                        " select M3,[Group] from tempDetailBSTahap1 ) as x group by [Group] " +

                        " /** 10. Total Potong QA **/   " +
                        " select  B.[Group],cast((sum(TPotongM3)) as decimal(18,2))  TotPotongM3 into tempTotPotong_QA from BM_Destacking A left join BM_PlantGroup B on A.PlantGroupID=B.ID  inner join (  select C.ID DestID , A.TPotong qtyin,A.TPotong*I.Volume as kubik,A.TPotong*I.Volume TPotongM3 from Def_Defect A   inner join BM_Destacking C on A.DestID=C.ID left join FC_Items I on I.ID=C.ItemID where A.Status>-1 and CONVERT(char,A.tgl,112)>=@thnbln1 and  CONVERT(char,A.tgl,112)<=@thnbln2 ) as C  on A.ID=C.DestID group by B.[Group] ; " +
                        " /** End Total Potong QA **/   " +

                        " /** 11. Detail Total Potong ListPlank dan Ukuran Khusus **/ " +
                        " select sum(M3)M3,[Group] into tempDetailTotPotong_LPUK from ( " +
                        " select * from tempDetailDefect_UkuranKhusus union all " +
                        " select * from tempDetailDefect_UkuranKhususOK union all " +
                        " select * from tempDetail_Listplank union all " +
                        " " + logika2 + " " +
                        //" select M3 *-1 M3,[Group] from tempDetail_Listplank0 "+
                        //" /**select M3,[Group] from AtempDetail_Listplank**/ "+
                        " ) as x group by [Group] " +

                        " /** 12. Detail Total Potong System QA,ListPlank dan Ukuran Khusus **/ " +
                        " select sum(M3)M3,[Group] into tempDetailTotPotong_LPUK2 from ( " +
                        " select * from tempDetailTotPotong_LPUK " +
                        " union all " +
                        " select TotPotongM3 M3,[Group] from tempTotPotong_QA ) as x group by [Group] " +

                        " /** 13. Selisih Total Potong **/ " +
                        " /** 13.1 Total Potong Keseluruhan ( Accounting Report ) **/ " +
                        " declare @ttlPotongSemua varchar(30) " +
                        " set @ttlPotongSemua=( " +
                        " select cast(sum(M3) as decimal(18,0)) M3 from ( " +
                        " select sum(M3)M3 from tempDetailBSTahap1 " +
                        " union all " +
                        " select cast(sum(M3) as decimal(18,1))M3 from ( " +
                        " select sum(M3)M3 from tempDetail_Listplank " +
                        " union all " +
                        " select sum(M3) * -1 M3 from tempDetail_Listplank0 ) as x " +
                        " union all " +
                        " select cast(sum(M3) as decimal(18,1))M3 from ( " +
                        " select sum(M3)M3 from tempDetailDefect_UkuranKhusus " +
                        " union all " +
                        " select sum(M3)M3 from tempDetailDefect_UkuranKhususOK ) as x " +
                        " union all " +
                        " select @TtlDfctBMFN_M3 M3 " +
                        " union all " +
                        " select @TtlDfctBMFN_M3_OKKW M3 ) as x) " +

                        " /** 13.2 Total Selisih Total Potong **/ " +
                        " declare @selisihTotalPot decimal(18,1) " +
                        " set @selisihTotalPot=( " +
                        " select sum(M3) M3 from ( " +
                        " select @ttlPotongSemua M3 " +
                        " union all " +
                        " select round(sum(M3),1)* -1 M3 from tempDetailTotPotong_LPUK2 ) as x ) " +

                        " /** 13.3 Detail Selisih Total Potong **/ " +

                        "" + logika1 + "" +

                        //" select cast(@selisihTotalPot/24 as decimal(18,1))M3,[Group] into DtlSelisihTtlPot from ( " +
                        //" select [Group] from detailDfctSystemBM_M3  " +
                        //" union all   " +
                        //" select [Group] from DtlDefectSystemFN_M3 " +
                        //" union all " +
                        //" select [Group] from BM_PlantGroup where PlantID>0) as x group by [Group] " +

                        //" select sum(M3)M3,[Group]  into DtlSelisihTtlPot from ( "+
                        //" select (@selisihTotalPot/(select count([Group])ttl from tempDetailTotPotong_LPUK where m3>0))M3,[Group] from tempDetailTotPotong_LPUK  where m3>0 union all " +
                        //" select '0'M3,[Group] from BM_PlantGroup where PlantID>0) as x group by [Group] "+

                        " /** 14. Total Potong Proposionet **/ " +
                        " select sum(M3)M3,[Group] into DtlTotalPotongProposionet from ( " +
                        " select * from tempDetailTotPotong_LPUK2 " +
                        " union all " +
                        " select * from DtlSelisihTtlPot ) as x group by [Group] " +

                        " select *,isnull((select sum(qty) from tempdefectGPIso where [group]=A.[Group] ),0) totdefect, isnull((select sum(kubik) from tempdefectGPIso where [group]=A.[Group] ),0) totdefectK into tempdefectGPIsoTot from ( select  B.[Group],SUM(C.qtyin) as totpotong,SUM(kubik) as totkubik    from BM_Destacking A left join BM_PlantGroup B on A.PlantGroupID=B.ID  inner join (  select C.destid,C.qtyin,C.QtyIn*I1.Volume as kubik from T1_Serah C Inner join fc_items I  on C.itemid=I.ID Inner join fc_items I1 on C.itemid0=I1.ID  where C.Status>-1 and CONVERT(char,C.tglserah,112)>=@thnbln1 and   CONVERT(char,C.tglserah,112)<=@thnbln2 and (I.PartNo like '%-w-%' or I.PartNo like '%-3-%' )  union all   select C.DestID , B.Qty qtyin,B.Qty*I.Volume as kubik from Def_Defect A inner join Def_DefectDetail B on A.ID=B.DefectID  inner join T1_Serah C on A.SerahID=C.ID  left join FC_Items I on I.ID=C.ItemID0  where CONVERT(char,A.tgl,112)>=@thnbln1 and  CONVERT(char,A.tgl,112)<=@thnbln2 and B.RowStatus>-1 ) as C   on A.ID=C.DestID group by B.[Group])A  " +

                        " declare @DefectFin decimal(18,2) " +
                        " set @DefectFin= (select sum(kubik) from (  select case when D.DeptID=0 then  case when GJ.GroupJemurName In ('M','N','O','P','Q','R','S','T','U','V','W','X') then   case when D.DefName='retak' then 2   when D.DefName='gompal' then 3  else D.DeptID end   else    case when (B.Qty/E.Qty) *100 >5 then 2 else 3 end   end  else D.DeptID end deptID1,A.CreatedTime as tglInput,A.Tgl as TglPeriksa,E.TglProduksi as TglProd,  D.DefCode,BP.PlantName as Line, PG.[Group],BF.FormulaCode as Jenis,   D.DefName,D.DeptID,B.ID,B.DefectID,B.MasterID,B.Qty,A.ID  DestID,isnull(A.TPotong,0)  QtyIn,B.Qty*I.Volume as Kubik,isnull(A.TPotong,0) as TotPotong,'' sfrom  from Def_DefectDetail B inner join Def_Defect A on A.Id=B.DefectID   left join Def_MasterDefect D on B.MasterID=D.ID left join BM_Destacking E on E.ID=A.DestID   left join BM_PlantGroup PG on A.GroupProdID=PG.ID left join BM_Formula BF on BF.ID=E.FormulaID    left join BM_Plant BP on BP.ID=E.PlantID left join FC_Items I on I.ID=E.ItemID inner join Def_GroupJemur GJ on GJ.ID=A.GroupJemurID  where B.RowStatus>-1  and D.RowStatus >-1) as Def    where DeptID1<>2 and CONVERT(varchar,TglPeriksa,112)>=@thnbln1 and CONVERT(varchar,TglPeriksa,112)<=@thnbln2)  " +

                        " select * into tempdefectFin from ( select 'OKKW' fin, sum(qtyout) lembar,sum(qtyout * kubik)kubik from ( select I1.PartNo partno1,I1.Panjang * I1.Lebar luas1,  S.qtyin,I2.PartNo partno2,I2.Panjang * I2.Lebar luas2,  S.qtyout ,(I2.Tebal * I2.Panjang * I2.Lebar)/1000000000 kubik from t3_simetris S inner join T3_Serah Se on S.SerahID =Se.ID inner join fc_items I1 on Se.ItemID=I1.ID inner join fc_items I2 on S.ItemID=I2.id  where I2.lebar>500 and S.RowStatus>-1 and CONVERT(varchar,S.tgltrans,112)>=@thnbln1 and CONVERT(varchar,S.tgltrans,112)<=@thnbln2 )a where partno1 like '%-1-%' and luas1>=luas2*2 and partno2 like '%-p-%' union all select 'BP' fin, sum(qtyout) lembar,sum(qtyout * kubik)kubik from ( select I1.PartNo partno1,I1.Panjang * I1.Lebar luas1,  S.qtyin,I2.PartNo partno2,I2.Panjang * I2.Lebar luas2,  S.qtyout ,(I2.Tebal * I2.Panjang * I2.Lebar)/1000000000 kubik from t3_simetris S inner join T3_Serah Se on S.SerahID =Se.ID inner join fc_items I1 on Se.ItemID=I1.ID inner join fc_items I2 on S.ItemID=I2.id  where I2.lebar>500 and S.RowStatus>-1 and CONVERT(varchar,S.tgltrans,112)>=@thnbln1 and CONVERT(varchar,S.tgltrans,112)<=@thnbln2  )a where partno1 like '%-1-%' and luas1>=luas2*2 and  (partno2 like '%-3-%' or partno2 like '%-w-%' or partno2 like '%-m-%') union all select 'BS' fin,sum(R.QtyIn) Lembar,sum(R.QtyIn *((I.tebal*I.panjang*I.lebar)/1000000000)) kubik from T3_Rekap R inner join FC_Items I on R.ItemID=I.id inner join fc_lokasi L on R.LokID =L.id where R.RowStatus>-1 and  CONVERT(varchar,R.tgltrans,112)>=@thnbln1 and CONVERT(varchar,R.tgltrans,112)<=@thnbln2 and I.PartNo like '%-s-%' and Process='direct')A  " +

                        " declare @TotalPotong decimal(18,2) " +
                        " declare @TotalDefKhusus decimal(18,2)  " +
                        " declare @DefKhusus decimal(18,2)  " +
                        " declare @Ttotalkw1kw2 decimal(18,2) " +
                        " declare @NCSortir decimal(18,2)  " +
                        " declare @Retur decimal(18,2)  " +
                        " set @TotalPotong=isnull((select sum(totkubik ) from tempdefectGPIsoTot),0)  " +

                        " if @TotalPotong >0  begin " +
                        " set @TotalDefKhusus=isnull((select sum(kubik) from tempdefectFin),0)  " +
                        " set @DefKhusus=isnull((select sum(kubik) from tempdefectFin where fin<>'bp'),0)  " +
                        " set @Ttotalkw1kw2 =isnull((select sum(qtyin *((I.tebal*I.Lebar*I.Panjang)/1000000000)) from T3_Rekap R inner join fc_items I on R.itemid=I.ID  where R.rowstatus>-1 and R.Process  like '%simetris%' and CONVERT(varchar,R.tgltrans,112)>=@thnbln1 and CONVERT(varchar,R.tgltrans,112)<=@thnbln2   and I.lebar=1200 and I.panjang=2400 and R.keterangan like '%-p-%' and (I.partno like '%-3-%' or I.partno like '%-W-%' or I.partno like '%-M-%' )),0) " +

                        " set @NCSortir=isnull((select sum(M3AkhirSS)+sum(M3AkhirSE) from (  SELECT B.tgltrans as Tanggal, I1.PartNo as PartnoAwal, sum(B.QtyIn) as QtyAwal,sum(I1.Volume*B.QtyIn) M3Awal,   I2.PartNo AS PartnoAkhir, case when B.NCSS>0 then sum(B.QtyOut) else 0 end QtyAkhirSS,  case when B.NCSS>0 then sum(I2.Volume*B.QtyOut) else 0 end M3AkhirSS,case when B.NCSE>0 then sum(B.QtyOut) else 0 end QtyAkhirSE,  case when B.NCSE>0 then sum(I2.Volume*B.QtyOut) else 0 end M3AkhirSE,B.NCSS,B.NCSE  FROM T3_Serah AS A   INNER JOIN T3_Simetris AS B ON A.ID = B.SerahID INNER JOIN FC_Items AS I1 ON A.ItemID = I1.ID INNER JOIN   FC_Items AS I2 ON B.ItemID = I2.ID LEFT JOIN T3_GroupM AS D ON B.GroupID = D.ID   where (B.NCSS>0 or B.NCSE>0) and B.rowstatus>-1 and CONVERT(varchar,B.tgltrans,112)>=@thnbln1 and CONVERT(varchar,B.tgltrans,112)<=@thnbln2   group by B.tgltrans,I1.PartNo,I2.PartNo,B.NCSS,B.NCSE) S),0) " +

                        " set @Retur=isnull((select cast(((TotK1-TotK2)+TotK3) as decimal(18,2)) TotM3 from ( " +
                        " select cast((sum(Volume*Tot1)) as decimal(18,2)) TotK1,cast((sum(Volume*Tot2)) as decimal(18,2)) TotK2,cast((sum(Volume*Tot3)) as decimal(18,2)) TotK3 from ( " +
                        " select tanggal,PartNo,volume ,sum(isnull(QtyC1,0))QtyC1,sum(isnull(QtyP1,0)) QtyP1,sum(isnull(QtyS1,0)) QtyS1,sum(isnull(Tot1,0)) Tot1,sum(isnull(TotK1,0)) TotK1, sum(isnull(QtyC2,0)) QtyC2,sum(isnull(QtyP2,0)) QtyP2,sum(isnull(QtyS2,0)) QtyS2,sum(isnull(Tot2,0)) Tot2, sum(isnull(TotK2,0)) TotK2,sum(isnull(QtyC3,0)) QtyC3,sum(isnull(QtyP3,0)) QtyP3,sum(isnull(QtyS3,0)) QtyS3,sum(isnull(Tot3,0)) Tot3,sum(isnull(TotK3,0)) TotK3 from ( select tanggal ,PartNo,volume,case when typeR=1 and ((KW='3' or KW='W')or lokasi='cl') then Qty end QtyC1,case when typeR=1 and (KW='P'and lokasi <> 'cl') then Qty end QtyP1, case when typeR=1 and (KW='S'and lokasi <> 'cl') then Qty end QtyS1, case when typeR=1 and ((KW='P' or KW='S') and lokasi <> 'cl') then Qty end Tot1, case when typeR=1 and (KW='P' or KW='S') then QtyK end TotK1, case when typeR=2 and ((KW='3' or KW='W')or lokasi='cl') then Qty end QtyC2, case when typeR=2 and (KW='P' and lokasi <> 'cl') then Qty end QtyP2, case when typeR=2 and (KW='S' and lokasi <> 'cl') then Qty end QtyS2, case when typeR=2 and ((KW='P' or KW='S') and lokasi <> 'cl') then Qty end Tot2, case when typeR=2 and ((KW='P' or KW='S') and lokasi <> 'cl') then QtyK end TotK2, case when typeR=3 and ((KW='3' or KW='W')or lokasi='cl') then Qty end QtyC3, case when typeR=3 and (KW='P' and lokasi <> 'cl') then Qty end QtyP3, case when typeR=3 and (KW='S' and lokasi <> 'cl') then Qty end QtyS3, case when typeR=3 and ((KW='P' or KW='S') and lokasi <> 'cl') then Qty   end Tot3, case when typeR=3 and ((KW='P' or KW='S') and lokasi <> 'cl') then QtyK end TotK3 from (     select R.TglTrans tanggal,I.PartNo,I.volume,SUBSTRING(I.partno,5,1) as KW,sum(R.Qty)Qty,     sum(((I.Panjang*I.Lebar)/(1220*2440) ) * R.Qty) QtyK,isnull(R.TypeR,1)  TypeR,I.ID,L.Lokasi     from T3_Retur R inner join FC_Items I on R.ItemID =I.ID  inner join FC_lokasi L on R.LokID=L.ID  where R.RowStatus>-1     group by R.TglTrans,I.PartNo,I.volume,R.TypeR,I.ID,L.Lokasi union all select R.TglTrans tanggal,I.PartNo,I.volume,SUBSTRING(I.partno,5,1) as KW,sum(R.Qty)Qty,    sum(((I.Panjang*I.Lebar)/(1220*2440) ) * R.Qty) QtyK,3  TypeR,I.ID,L.Lokasi     from T3_ReturO R inner join FC_Items I on R.ItemID =I.ID  inner join FC_lokasi L on R.LokID=L.ID  where R.RowStatus>-1     group by R.TglTrans,I.PartNo,I.volume,I.ID,L.Lokasi ) as A ) as B where convert(char,tanggal,112)>=@thnbln1 and convert(char,tanggal,112)<=@thnbln2 group by tanggal,PartNo,volume ) as x ) as x1),0) " +

                        " /** 15. Detail OK KM **/ " +
                        " select [Group],cast(((M3/@TtlDfctSystemBM_M3)*@Ttotalkw1kw2) as decimal(18,1)) M3 into tempOKKM_m3 from detailDfctSystemBM_M3  " +
                        " select [Group], (M3/(select sum(M3) from detailDfctSystemBM_M3))*(select sum(M3) from tempOKKM_m3)M3 into tempOKKM from detailDfctSystemBM_M3 " +

                        " /** 16. Detail Retur **/  " +
                        " select [Group],cast(((M3/@TtlDfctSystemBM_M3)*@Retur) as decimal(18,2)) M3 into tempRetur_m3 from detailDfctSystemBM_M3 order by [group]  ; " +

                        " /** 17. Detail Sortir **/   " +
                        " with Sortir as (select [Group],cast(((M3/@TtlDfctSystemBM_M3)*@NCSortir) as decimal(18,2)) M3 from detailDfctSystemBM_M3 ), " +
                        " Sortir01 as (select [Group],cast((M3) as decimal(18,2))M3 from (  select [Group],cast((M3) as decimal(18,2))M3 from (  select * from Sortir ) as x ) as x1 ) " +

                        " select * into tempSortir_1_m3 from Sortir01 " +

                        " /** 18. Total Defect **/  " +
                        " select sum(M3)M3,[Group] into DtlTotalDefect from ( " +
                        " select cast(M3 as decimal(18,2))M3,[Group] from tempDetailTotalDefect_P  " +
                        " union all " +
                        " select M3,[Group] from tempRetur_m3 " +
                        " union all " +
                        " select M3,[Group] from tempSortir_1_m3 " +
                        " union all " +
                        " select M3 * -1,[Group] from tempOKKM_m3 ) as x group by [Group] " +
                        #endregion

                        #region Line - 1
                    " declare @TotalPotongL1 decimal(18,2) " +
                        " declare @TotDefKhususL1 decimal(18,2)  " +
                        " declare @DefKhususL1 decimal(18,2)  " +
                        " declare @Ttotalkw1kw2L1 decimal(18,2)  " +
                        " declare @NCSortirL1 decimal(18,2)  " +
                        " declare @ReturL1 decimal(18,2)  " +
                        " declare @DefectFinL1 decimal(18,2) " +

                        " set @TotalPotongL1=(select isnull(sum(totkubik ),0) from tempdefectGPIsoTot where [group]in (select [group] from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 1'))) " +
                        " set @TotDefKhususL1=(@TotalPotongL1/@TotalPotong)*@TotalDefKhusus " +
                        " set @DefKhususL1=(@TotalPotongL1/@TotalPotong)*@DefKhusus " +
                        " set @Ttotalkw1kw2L1=(@TotalPotongL1/@TotalPotong)*@Ttotalkw1kw2 " +
                        " set @NCSortirL1=(@TotalPotongL1/@TotalPotong)*@NCSortir " +
                        " set @ReturL1=(@TotalPotongL1/@TotalPotong)*@Retur " +
                        " set @DefectFinL1=isnull((@TotalPotongL1/@TotalPotong)*@DefectFin,0) " +

                        " if @TotalPotongL1>0 " +
                        " begin " +
                        " select [Group],cast((b) as decimal(18,2))b,cast((c) as decimal(18,2))c,cast((d) as decimal(18,2))d,cast((e) as decimal(18,2))e,cast((f) as decimal(18,2))f,cast((g) as decimal(18,2))g,cast((i) as decimal(18,2))i,j into tempdefectL1 from ( " +
                        " select *,case when b>0 then cast((((c-d+e+f)/b)*100) as decimal(18,2)) else 0  end j from ( " +
                        " select [Group], " +
                        " case when @TotalPotongL1>0 then isnull((select cast((M3) as decimal(18,2))M3 from DtlTotalPotongProposionet where [group]=BM_PlantGroup.[Group] ),0)  else 0 end b, " +
                        " case when @TotalPotongL1>0 then isnull((select cast((M3) as decimal(18,2))M3 from tempDefectProduksi where [group]=BM_PlantGroup.[Group] ),0)  else 0 end c, " +
                        " case when @TotalPotongL1>0 then ((isnull((select cast((M3) as decimal(18,2))M3 from tempOKKM where [group]=BM_PlantGroup.[Group] ),0))) else 0 end  d,  " +
                        " case when @TotalPotongL1>0 then ((isnull((select cast((M3) as decimal(18,2))M3 from tempSortir_1_m3 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  e, " +
                        " case when @TotalPotongL1>0 then ((isnull((select cast((M3) as decimal(18,2))M3 from tempRetur_m3 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  f, " +
                        " case when @TotalPotongL1>0 then ((isnull((select cast((M3) as decimal(18,2))M3 from tempDetailBSTahap1 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end g,  " +
                        " case when @TotalPotongL1>0 then ((isnull((select cast((M3) as decimal(18,2))M3 from DtlTotalDefect where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end i " +
                        " from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 1') )A " +

                        " union all  " +

                        " select 'Total' [Group],sum(b)b,sum(c)c,sum(d)d,sum(e)e,sum(f)f,sum(g)g,sum(i) i" +
                        //" ,case when sum(b)>0 then cast((sum(c)-sum(d)+sum(e)+sum(f))/sum(b)*100 as decimal(18,1)) else 0 end j from( " +
                        " " + logika3 + " " +
                        " select [Group], " +
                        " case when @TotalPotongL1>0 then isnull((select cast((M3) as decimal(18,2))M3 from DtlTotalPotongProposionet where [group]=BM_PlantGroup.[Group] ),0)  else 0 end b,  " +
                        " case when @TotalPotongL1>0 then isnull((select cast((M3) as decimal(18,2))M3 from tempDefectProduksi where [group]=BM_PlantGroup.[Group] ),0)  else 0 end c,  " +
                        " case when @TotalPotongL1>0 then ((isnull((select cast((M3) as decimal(18,2))M3 from tempOKKM where [group]=BM_PlantGroup.[Group] ),0))) else 0 end  d, " +
                        " case when @TotalPotongL1>0 then ((isnull((select cast((M3) as decimal(18,2))M3 from tempSortir_1_m3 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  e,  " +
                        " case when @TotalPotongL1>0 then ((isnull((select cast((M3) as decimal(18,2))M3 from tempRetur_m3 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  f,  " +
                        " case when @TotalPotongL1>0 then ((isnull((select cast((M3) as decimal(18,2))M3 from tempDetailBSTahap1 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end g,  " +
                        " case when @TotalPotongL1>0 then ((isnull((select cast((M3) as decimal(18,2))M3 from DtlTotalDefect where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end i, " +
                        " 0 j from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 1'))A )B " +
                        " end " +
                        " else " +
                        " begin " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 i, 0 j into tempdefectL1 " +
                        " end " +
                        #endregion
 " " +
                        #region Line - 2
 " declare @TotalPotongL2 decimal(18,2) " +
                        " declare @TotDefKhususL2 decimal(18,2) " +
                        " declare @DefKhususL2 decimal(18,2) " +
                        " declare @Ttotalkw1kw2L2 decimal(18,2) " +
                        " declare @NCSortirL2 decimal(18,2) " +
                        " declare @ReturL2 decimal(18,2) " +
                        " declare @DefectFinL2 decimal(18,2) " +

                        " set @TotalPotongL2=(select isnull(sum(totkubik ),0) from tempdefectGPIsoTot where [group]in (select [group] from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 2'))) " +
                        " set @TotDefKhususL2=(@TotalPotongL2/@TotalPotong)*@TotalDefKhusus " +
                        " set @DefKhususL2=(@TotalPotongL2/@TotalPotong)*@DefKhusus " +
                        " set @Ttotalkw1kw2L2=(@TotalPotongL2/@TotalPotong)*@Ttotalkw1kw2 " +
                        " set @NCSortirL2=(@TotalPotongL2/@TotalPotong)*@NCSortir " +
                        " set @ReturL2=(@TotalPotongL2/@TotalPotong)*@Retur " +
                        " set @DefectFinL2=isnull((@TotalPotongL2/@TotalPotong)*@DefectFin,0) " +

                        " if @TotalPotongL2>0 " +
                        " begin " +
                        " select [Group],cast((b) as decimal(18,1))b,cast((c) as decimal(18,1))c,cast((d) as decimal(18,1))d,cast((e) as decimal(18,1))e,cast((f) as decimal(18,1))f,cast((g) as decimal(18,1))g,cast((i) as decimal(18,1))i,j into tempdefectL2 from ( " +
                        " select *,case when b>0 then cast((((c-d+e+f)/b)*100) as decimal(18,1))  else 0  end j from ( " +
                        " select [Group], " +
                        " case when @TotalPotongL2>0 then isnull((select cast((M3) as decimal(18,2))M3 from DtlTotalPotongProposionet where [group]=BM_PlantGroup.[Group] ),0)  else 0 end b,  " +
                        " case when @TotalPotongL2>0 then isnull((select cast((M3) as decimal(18,2))M3 from tempDefectProduksi where [group]=BM_PlantGroup.[Group] ),0)  else 0 end c,  " +
                        " case when @TotalPotongL2>0 then ((isnull((select cast((M3) as decimal(18,2))M3 from tempOKKM where [group]=BM_PlantGroup.[Group] ),0))) else 0 end  d, " +
                        " case when @TotalPotongL2>0 then ((isnull((select cast((M3) as decimal(18,2))M3 from tempSortir_1_m3 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  e,  " +
                        " case when @TotalPotongL2>0 then ((isnull((select cast((M3) as decimal(18,2))M3 from tempRetur_m3 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  f,  " +
                        " case when @TotalPotongL2>0 then ((isnull((select cast((M3) as decimal(18,2))M3 from tempDetailBSTahap1 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end g , " +
                        " case when @TotalPotongL2>0 then ((isnull((select cast((M3) as decimal(18,2))M3 from DtlTotalDefect where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end i " +
                        " from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 2') )A " +

                        " union all  " +

                        " select 'Total' [Group],sum(b)b,sum(c)c,sum(d)d,sum(e)e,sum(f)f,sum(g)g,sum(i) i " +
                         //" ,case when sum(b)>0 then cast((sum(c)-sum(d)+sum(e)+sum(f))/sum(b)*100 as decimal(18,1)) else 0 end j from( "+

                         " " + logika3 + " " +
                         " select [Group], " +
                        " case when @TotalPotongL2>0 then isnull((select cast((M3) as decimal(18,2))M3 from DtlTotalPotongProposionet where [group]=BM_PlantGroup.[Group] ),0)  else 0 end b,  " +
                        " case when @TotalPotongL2>0 then isnull((select cast((M3) as decimal(18,2))M3 from tempDefectProduksi where [group]=BM_PlantGroup.[Group] ),0)  else 0 end c,  " +
                        " case when @TotalPotongL2>0 then ((isnull((select cast((M3) as decimal(18,2))M3 from tempOKKM where [group]=BM_PlantGroup.[Group] ),0))) else 0 end  d, " +
                        " case when @TotalPotongL2>0 then ((isnull((select cast((M3) as decimal(18,2))M3 from tempSortir_1_m3 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  e,  " +
                        " case when @TotalPotongL2>0 then ((isnull((select cast((M3) as decimal(18,2))M3 from tempRetur_m3 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  f,  " +
                        " case when @TotalPotongL2>0 then ((isnull((select cast((M3) as decimal(18,2))M3 from tempDetailBSTahap1 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end g,  " +
                        " case when @TotalPotongL2>0 then ((isnull((select cast((M3) as decimal(18,2))M3 from DtlTotalDefect where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end i, " +
                        " 0 j from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 2'))A )B " +
                        " end " +
                        " else " +
                        " begin " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 i, 0 j into tempdefectL2 " +
                        " end " +
                        #endregion
 " " +
                        #region Lin3 - 3
 " declare @TotalPotongL3 decimal(18,2) " +
                        " declare @TotDefKhususL3 decimal(18,2) " +
                        " declare @DefKhususL3 decimal(18,2) " +
                        " declare @Ttotalkw1kw2L3 decimal(18,2) " +
                        " declare @NCSortirL3 decimal(18,2) " +
                        " declare @ReturL3 decimal(18,2) " +
                        " declare @DefectFinL3 decimal(18,2) " +

                        " set @TotalPotongL3=(select isnull(sum(totkubik ),0) from tempdefectGPIsoTot where [group]in (select [group] from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 3'))) " +
                        " set @TotDefKhususL3=(@TotalPotongL3/@TotalPotong)*@TotalDefKhusus " +
                        " set @DefKhususL3=(@TotalPotongL3/@TotalPotong)*@DefKhusus " +
                        " set @Ttotalkw1kw2L3=(@TotalPotongL3/@TotalPotong)*@Ttotalkw1kw2 " +
                        " set @NCSortirL3=(@TotalPotongL3/@TotalPotong)*@NCSortir " +
                        " set @ReturL3=(@TotalPotongL3/@TotalPotong)*@Retur " +
                        " set @DefectFinL3=isnull((@TotalPotongL3/@TotalPotong)*@DefectFin,0) " +

                        " if @TotalPotongL3>0 " +
                        " begin " +
                        " select [Group],cast((b) as decimal(18,1))b,cast((c) as decimal(18,1))c,cast((d) as decimal(18,1))d,cast((e) as decimal(18,1))e,cast((f) as decimal(18,1))f,cast((g) as decimal(18,1))g,cast((i) as decimal(18,1))i,j into tempdefectL3 from ( " +
                        " select *,case when b>0 then cast((((c-d+e+f)/b)*100) as decimal(18,1))  else 0  end j from ( select [Group], " +
                        " case when @TotalPotongL3>0 then isnull((select cast((M3) as decimal(18,2))M3 from DtlTotalPotongProposionet where [group]=BM_PlantGroup.[Group] ),0)  else 0 end b,  " +
                        " case when @TotalPotongL3>0 then isnull((select cast((M3) as decimal(18,2))M3 from tempDefectProduksi where [group]=BM_PlantGroup.[Group] ),0)  else 0 end c,  " +
                        " case when @TotalPotongL3>0 then ((isnull((select cast((M3) as decimal(18,2))M3 from tempOKKM where [group]=BM_PlantGroup.[Group] ),0))) else 0 end  d, " +
                        " case when @TotalPotongL3>0 then ((isnull((select cast((M3) as decimal(18,2))M3 from tempSortir_1_m3 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  e,  " +
                        " case when @TotalPotongL3>0 then ((isnull((select cast((M3) as decimal(18,2))M3 from tempRetur_m3 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  f,  " +
                        " case when @TotalPotongL3>0 then ((isnull((select cast((M3) as decimal(18,2))M3 from tempDetailBSTahap1 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end g,  " +
                        " case when @TotalPotongL3>0 then ((isnull((select cast((M3) as decimal(18,2))M3 from DtlTotalDefect where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end i " +
                        "  from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 3') )A " +

                        " union all  " +

                        " select 'Total' [Group],sum(b)b,sum(c)c,sum(d)d,sum(e)e,sum(f)f,sum(g)g,sum(i) i " +
                        //" ,case when sum(b)>0 then cast((sum(c)-sum(d)+sum(e)+sum(f))/sum(b)*100 as decimal(18,1))  else 0 end j from( select [Group], " +

                        " " + logika3 + " " +
                        " select [Group], " +
                        " case when @TotalPotongL3>0 then isnull((select cast((M3) as decimal(18,2))M3 from DtlTotalPotongProposionet where [group]=BM_PlantGroup.[Group] ),0)  else 0 end b,  " +
                        " case when @TotalPotongL3>0 then isnull((select cast((M3) as decimal(18,2))M3 from tempDefectProduksi where [group]=BM_PlantGroup.[Group] ),0)  else 0 end c,  " +
                        " case when @TotalPotongL3>0 then ((isnull((select cast((M3) as decimal(18,2))M3 from tempOKKM where [group]=BM_PlantGroup.[Group] ),0))) else 0 end  d, " +
                        " case when @TotalPotongL3>0 then ((isnull((select cast((M3) as decimal(18,2))M33 from tempSortir_1_m3 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  e,  " +
                        " case when @TotalPotongL3>0 then ((isnull((select cast((M3) as decimal(18,2))M3 from tempRetur_m3 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  f,  " +
                        " case when @TotalPotongL3>0 then ((isnull((select cast((M3) as decimal(18,2))M3 from tempDetailBSTahap1 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end g,  " +
                        " case when @TotalPotongL3>0 then ((isnull((select cast((M3) as decimal(18,2))M3 from DtlTotalDefect where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end i, " +
                        " 0 j from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 3'))A )B " +
                        " end " +
                        " else " +
                        " begin " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 i, 0 j into tempdefectL3 " +
                        " end " +
                        #endregion
 " " +
                        #region Line - 4
 " declare @TotalPotongL4 decimal(18,2) " +
                        " declare @TotDefKhususL4 decimal(18,2) " +
                        " declare @DefKhususL4 decimal(18,2) " +
                        " declare @Ttotalkw1kw2L4 decimal(18,2) " +
                        " declare @NCSortirL4 decimal(18,2) " +
                        " declare @ReturL4 decimal(18,2) " +
                        " declare @DefectFinL4 decimal(18,2) " +

                        " set @TotalPotongL4=(select isnull(sum(totkubik ),0) from tempdefectGPIsoTot where [group]in (select [group] from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 4'))) " +
                        " set @TotDefKhususL4=(@TotalPotongL4/@TotalPotong)*@TotalDefKhusus " +
                        " set @DefKhususL4=(@TotalPotongL4/@TotalPotong)*@DefKhusus " +
                        " set @Ttotalkw1kw2L4=(@TotalPotongL4/@TotalPotong)*@Ttotalkw1kw2 " +
                        " set @NCSortirL4=(@TotalPotongL4/@TotalPotong)*@NCSortir " +
                        " set @ReturL4=(@TotalPotongL4/@TotalPotong)*@Retur " +
                        " set @DefectFinL4=isnull((@TotalPotongL4/@TotalPotong)*@DefectFin,0) " +

                        " if @TotalPotongL4>0 " +
                        " begin " +
                        " select [Group],cast((b) as decimal(18,1))b,cast((c) as decimal(18,1))c,cast((d) as decimal(18,1))d,cast((e) as decimal(18,1))e,cast((f) as decimal(18,1))f,cast((g) as decimal(18,1))g,cast((i) as decimal(18,1))i,j into tempdefectL4 from ( " +
                        " select *,case when b>0 then cast((((c-d+e+f)/b)*100) as decimal(18,1)) else 0  end j from ( " +
                        " select [Group], " +
                        " case when @TotalPotongL4>0 then isnull((select cast((M3) as decimal(18,2))M3 from DtlTotalPotongProposionet where [group]=BM_PlantGroup.[Group] ),0)  else 0 end b,  " +
                        " case when @TotalPotongL4>0 then isnull((select cast((M3) as decimal(18,2))M3 from tempDefectProduksi where [group]=BM_PlantGroup.[Group] ),0)  else 0 end c,  " +
                        " case when @TotalPotongL4>0 then ((isnull((select cast((M3) as decimal(18,2))M3 from tempOKKM where [group]=BM_PlantGroup.[Group] ),0))) else 0 end  d, " +
                        " case when @TotalPotongL4>0 then ((isnull((select cast((M3) as decimal(18,2))M33 from tempSortir_1_m3 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  e,  " +
                        " case when @TotalPotongL4>0 then ((isnull((select cast((M3) as decimal(18,2))M3 from tempRetur_m3 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  f,  " +
                        " case when @TotalPotongL4>0 then ((isnull((select cast((M3) as decimal(18,2))M3 from tempDetailBSTahap1 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end g,  " +
                        " case when @TotalPotongL4>0 then ((isnull((select cast((M3) as decimal(18,2))M3 from DtlTotalDefect where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end i " +
                        " from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 4') )A " +

                        " union all  " +

                        " select 'Total' [Group],sum(b)b,sum(c)c,sum(d)d,sum(e)e,sum(f)f,sum(g)g,sum(i) i" +
                        // " ,case when sum(b)>0 then cast((sum(c)-sum(d)+sum(e)+sum(f))/sum(b)*100 as decimal(18,1)) else 0 end j from( " +

                        " " + logika3 + " " +

                        " select [Group], " +
                        " ((isnull((select cast((M3) as decimal(18,2))M3 from DtlTotalPotongProposionet where [group]=BM_PlantGroup.[Group] ),0))) b, " +
                        " isnull((select cast((M3) as decimal(18,2))M3 from tempDefectProduksi where [group]=BM_PlantGroup.[Group] ),0)c, " +
                        " ((isnull((select cast((M3) as decimal(18,2))M3 from tempOKKM where [group]=BM_PlantGroup.[Group] ),0))) d, " +
                        " ((isnull((select cast((M3) as decimal(18,2))M3 from tempSortir_1_m3 where [group]=BM_PlantGroup.[Group] ),0))) e, " +
                        " ((isnull((select cast((M3) as decimal(18,2))M33 from tempRetur_m3 where [group]=BM_PlantGroup.[Group] ),0))) f, " +
                        " ((isnull((select cast((M3) as decimal(18,2))M3 from tempDetailBSTahap1 where [group]=BM_PlantGroup.[Group] ),0))) g, " +
                        " ((isnull((select cast((M3) as decimal(18,2))M3 from DtlTotalDefect where [group]=BM_PlantGroup.[Group] ),0))) i, " +
                        " 0 j from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 4'))A )B " +
                        " end " +
                        " else " +
                        " begin " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 i, 0 j into tempdefectL4 " +
                        " end " +
                        #endregion
 " " +
                        #region Line - 5
 " declare @TotalPotongL5 decimal(18,2) " +
                        " declare @TotDefKhususL5 decimal(18,2) " +
                        " declare @DefKhususL5 decimal(18,2) " +
                        " declare @Ttotalkw1kw2L5 decimal(18,2) " +
                        " declare @NCSortirL5 decimal(18,2) " +
                        " declare @ReturL5 decimal(18,2) " +
                        " declare @DefectFinL5 decimal(18,2) " +

                        " set @TotalPotongL5=(select isnull(sum(totkubik ),0) from tempdefectGPIsoTot where [group]in (select [group] from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 5'))) " +
                        " set @TotDefKhususL5=(@TotalPotongL5/@TotalPotong)*@TotalDefKhusus " +
                        " set @DefKhususL5=(@TotalPotongL5/@TotalPotong)*@DefKhusus " +
                        " set @Ttotalkw1kw2L5=(@TotalPotongL5/@TotalPotong)*@Ttotalkw1kw2 " +
                        " set @NCSortirL5=(@TotalPotongL5/@TotalPotong)*@NCSortir " +
                        " set @ReturL5=(@TotalPotongL5/@TotalPotong)*@Retur " +
                        " set @DefectFinL5=isnull((@TotalPotongL5/@TotalPotong)*@DefectFin,0) " +

                        " if @TotalPotongL5>0 " +
                        " begin " +
                        " select [Group],cast((b) as decimal(18,1))b,cast((c) as decimal(18,1))c,cast((d) as decimal(18,1))d,cast((e) as decimal(18,1))e,cast((f) as decimal(18,1))f,cast((g) as decimal(18,1))g,cast((i) as decimal(18,1))i,j into tempdefectL5 from ( " +
                        " select *,case when b>0 then cast(((c-d+e+f)/b)*100 as decimal(18,1)) else 0  end j from ( " +
                        " select [Group], " +
                        " case when @TotalPotongL5>0 then isnull((select cast((M3) as decimal(18,2))M3 from DtlTotalPotongProposionet where [group]=BM_PlantGroup.[Group] ),0)  else 0 end b,  " +
                        " case when @TotalPotongL5>0 then isnull((select cast((M3) as decimal(18,2))M3 from tempDefectProduksi where [group]=BM_PlantGroup.[Group] ),0)  else 0 end c,  " +
                        " case when @TotalPotongL5>0 then ((isnull((select cast((M3) as decimal(18,2))M3 from tempOKKM where [group]=BM_PlantGroup.[Group] ),0))) else 0 end  d, " +
                        " case when @TotalPotongL5>0 then ((isnull((select cast((M3) as decimal(18,2))M3 from tempSortir_1_m3 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  e,  " +
                        " case when @TotalPotongL5>0 then ((isnull((select cast((M3) as decimal(18,2))M3 from tempRetur_m3 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  f,  " +
                        " case when @TotalPotongL5>0 then ((isnull((select cast((M3) as decimal(18,2))M3 from tempDetailBSTahap1 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end g,  " +
                        " case when @TotalPotongL5>0 then ((isnull((select cast((M3) as decimal(18,2))M3 from DtlTotalDefect where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end i " +
                        " from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 5') )A " +

                        "union all  " +

                        " select 'Total' [Group],sum(b)b,sum(c)c,sum(d)d,sum(e)e,sum(f)f,sum(g)g,sum(i) i " +
                        // " ,case when sum(b)>0 then cast((sum(c)-sum(d)+sum(e)+sum(f))/sum(b)*100 as decimal(18,1)) else 0 end j from( " +

                        " " + logika3 + " " +

                       " select [Group], " +
                        " ((isnull((select cast((M3) as decimal(18,2))M3 from DtlTotalPotongProposionet where [group]=BM_PlantGroup.[Group] ),0))) b, " +
                        " isnull((select cast((M3) as decimal(18,2))M3 from tempDefectProduksi where [group]=BM_PlantGroup.[Group] ),0)c, " +
                        " ((isnull((select cast((M3) as decimal(18,2))M3 from tempOKKM where [group]=BM_PlantGroup.[Group] ),0))) d, " +
                        " ((isnull((select cast((M3) as decimal(18,2))M3 from tempSortir_1_m3 where [group]=BM_PlantGroup.[Group] ),0))) e, " +
                        " ((isnull((select cast((M3) as decimal(18,2))M3 from tempRetur_m3 where [group]=BM_PlantGroup.[Group] ),0))) f, " +
                        " ((isnull((select cast((M3) as decimal(18,2))M3 from tempDetailBSTahap1 where [group]=BM_PlantGroup.[Group] ),0))) g, " +
                        " ((isnull((select cast((M3) as decimal(18,2))M3 from DtlTotalDefect where [group]=BM_PlantGroup.[Group] ),0))) i, " +
                        " 0 j from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 5'))A )B " +
                        " end " +
                        " else " +
                        " begin " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 i, 0 j into tempdefectL5 " +
                        " end " +
                        #endregion
 " " +
                        #region Line - 6
 " declare @TotalPotongL6 decimal(18,2) " +
                        " declare @TotDefKhususL6 decimal(18,2) " +
                        " declare @DefKhususL6 decimal(18,2) " +
                        " declare @Ttotalkw1kw2L6 decimal(18,2) " +
                        " declare @NCSortirL6 decimal(18,2) " +
                        " declare @ReturL6 decimal(18,2) " +
                        " declare @DefectFinL6 decimal(18,2) " +

                        " set @TotalPotongL6=(select isnull(sum(totkubik ),0) from tempdefectGPIsoTot where [group]in (select [group] from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 6'))) " +
                        " set @TotDefKhususL6=(@TotalPotongL6/@TotalPotong)*@TotalDefKhusus " +
                        " set @DefKhususL6=(@TotalPotongL6/@TotalPotong)*@DefKhusus " +
                        " set @Ttotalkw1kw2L6=(@TotalPotongL6/@TotalPotong)*@Ttotalkw1kw2 " +
                        " set @NCSortirL6=(@TotalPotongL6/@TotalPotong)*@NCSortir " +
                        " set @ReturL6=(@TotalPotongL6/@TotalPotong)*@Retur " +
                        " set @DefectFinL6=isnull((@TotalPotongL6/@TotalPotong)*@DefectFin,0) " +

                        " if @TotalPotongL6>0 " +
                        " begin " +
                        " select [Group],cast((b) as decimal(18,1))b,cast((c) as decimal(18,1))c,cast((d) as decimal(18,1))d,cast((e) as decimal(18,1))e,cast((f) as decimal(18,1))f,cast((g) as decimal(18,1))g,cast((i) as decimal(18,1))i,j into tempdefectL6 from ( " +
                        " select *,case when b>0 then cast((((c-d+e+f)/b)*100) as decimal(18,1)) else 0  end j from ( " +
                        " select [Group], " +
                        " case when @TotalPotongL6>0 then isnull((select cast((M3) as decimal(18,2))M3 from DtlTotalPotongProposionet where [group]=BM_PlantGroup.[Group] ),0)  else 0 end b,  " +
                        " case when @TotalPotongL6>0 then isnull((select cast((M3) as decimal(18,2))M3 from tempDefectProduksi where [group]=BM_PlantGroup.[Group] ),0)  else 0 end c,  " +
                        " case when @TotalPotongL6>0 then ((isnull((select cast((M3) as decimal(18,2))M3 from tempOKKM where [group]=BM_PlantGroup.[Group] ),0))) else 0 end  d, " +
                        " case when @TotalPotongL6>0 then ((isnull((select cast((M3) as decimal(18,2))M3 from tempSortir_1_m3 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  e,  " +
                        " case when @TotalPotongL6>0 then ((isnull((select cast((M3) as decimal(18,2))M3 from tempRetur_m3 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  f,  " +
                        " case when @TotalPotongL6>0 then ((isnull((select cast((M3) as decimal(18,2))M3 from tempDetailBSTahap1 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end g,  " +
                        " case when @TotalPotongL6>0 then ((isnull((select cast((M3) as decimal(18,2))M3 from DtlTotalDefect where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end i " +
                        " from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 6') )A " +

                        "union all  " +

                        " select 'Total' [Group],sum(b)b,sum(c)c,sum(d)d,sum(e)e,sum(f)f,sum(g)g,sum(i) i" +
                        //" ,case when sum(b)>0 then cast((sum(c)-sum(d)+sum(e)+sum(f))/sum(b)*100 as decimal(18,1)) else 0 end j from( " +

                        " " + logika3 + " " +

                        " select [Group], " +
                        " ((isnull((select cast((M3) as decimal(18,2))M3 from DtlTotalPotongProposionet where [group]=BM_PlantGroup.[Group] ),0))) b, " +
                        " isnull((select cast((M3) as decimal(18,2))M3 from tempDefectProduksi where [group]=BM_PlantGroup.[Group] ),0)c, " +
                        " ((isnull((select cast((M3) as decimal(18,2))M3 from tempOKKM where [group]=BM_PlantGroup.[Group] ),0))) d, " +
                        " ((isnull((select cast((M3) as decimal(18,2))M3 from tempSortir_1_m3 where [group]=BM_PlantGroup.[Group] ),0))) e, " +
                        " ((isnull((select cast((M3) as decimal(18,2))M3 from tempRetur_m3 where [group]=BM_PlantGroup.[Group] ),0))) f, " +
                        " ((isnull((select cast((M3) as decimal(18,2))M3 from tempDetailBSTahap1 where [group]=BM_PlantGroup.[Group] ),0))) g, " +
                        " ((isnull((select cast((M3) as decimal(18,2))M3 from DtlTotalDefect where [group]=BM_PlantGroup.[Group] ),0))) i, " +
                        " 0 j from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 6'))A )B " +
                        " end " +
                        #endregion

                        " else " +
                        " begin " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 i, 0 j into tempdefectL6 " +
                        " end " +
                        " " +
                        " end " +
                        " else " +
                        " begin " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 i, 0 j into tempdefectL1 " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 i, 0 j into tempdefectL2 " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 i, 0 j into tempdefectL3 " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 i, 0 j into tempdefectL4 " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 i, 0 j into tempdefectL5 " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 i, 0 j into tempdefectL6 " +
                        " end " +
                        " select [group],cast((b) as decimal(18,2))b,cast((c) as decimal(18,2))c,cast((d) as decimal(18,2))d,cast((e) as decimal(18,2))e,cast((f) as decimal(18,2))f,case when [group]<>'total' then cast((g) as decimal(18,2)) when [group]='total' then cast((g) as decimal(18,2)) end g,i,j from tempdefectL1 " +

                        " select GP,i NilaiDefect,b NilaiSerah,'" + DateTime.Parse(txtdrtanggal.Text).ToString("yyyyMM") + "'Periode  into tempDataSarmut_Defect from " +
                        " ( " +
                        " select case when [Group]='Total' then 'Total_L1' else [Group] end GP,b,i from tempdefectL1 union all " +
                        " select case when [Group]='Total' then 'Total_L2' else [Group] end GP,b,i from tempdefectL2 union all  " +
                        " select case when [Group]='Total' then 'Total_L3' else [Group] end GP,b,i from tempdefectL3 union all  " +
                        " select case when [Group]='Total' then 'Total_L4' else [Group] end GP,b,i from tempdefectL4 union all " +
                        " select case when [Group]='Total' then 'Total_L5' else [Group] end GP,b,i from tempdefectL5 union all " +
                        " select case when [Group]='Total' then 'Total_L6' else [Group] end GP,b,i from tempdefectL6   " +
                        " )A  where GP<>'' ";

                    }
                    #endregion
                    #region Baru > Mei 2021
                    else if (Convert.ToInt32(strtgl1.Substring(0, 6)) > 202105 && users.UnitKerjaID.ToString() == "1" ||
                             Convert.ToInt32(strtgl1.Substring(0, 6)) > 202107 && users.UnitKerjaID.ToString() == "13" ||
                             Convert.ToInt32(strtgl1.Substring(0, 6)) < 202107 && users.UnitKerjaID.ToString() == "7")
                    {
                        strSQL =
                        #region Temp Table
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempData_Group]') AND type in (N'U')) DROP TABLE [dbo].[tempData_Group] " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDefect_BM]') AND type in (N'U')) DROP TABLE [dbo].[tempDefect_BM] " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDefect_Fin]') AND type in (N'U')) DROP TABLE [dbo].[tempDefect_Fin] " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDefect_Fin0]') AND type in (N'U')) DROP TABLE [dbo].[tempDefect_Fin0] " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDefect_BM_detail0]') AND type in (N'U')) DROP TABLE [dbo].[tempDefect_BM_detail0] " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDefect_BM_detail]') AND type in (N'U')) DROP TABLE [dbo].[tempDefect_BM_detail] " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDefect_Fin_detail]') AND type in (N'U')) DROP TABLE [dbo].[tempDefect_Fin_detail] " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDefect_Fin_detail0]') AND type in (N'U')) DROP TABLE [dbo].[tempDefect_Fin_detail0] " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Selisih_ttl_defect_Detail]') AND type in (N'U')) DROP TABLE [dbo].[Selisih_ttl_defect_Detail] " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDefect_BM_FN_detail]') AND type in (N'U')) DROP TABLE [dbo].[tempDefect_BM_FN_detail] " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDefect_UkuranKhusus_detail]') AND type in (N'U')) DROP TABLE [dbo].[tempDefect_UkuranKhusus_detail] " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDefect_ListPlank_detail]') AND type in (N'U')) DROP TABLE [dbo].[tempDefect_ListPlank_detail] " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDefect_Produksi_detail]') AND type in (N'U')) DROP TABLE [dbo].[tempDefect_Produksi_detail] " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempMasterDataBSauto]') AND type in (N'U')) DROP TABLE [dbo].[tempMasterDataBSauto]  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempBS_Tahap1]') AND type in (N'U')) DROP TABLE [dbo].[tempBS_Tahap1]  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempBS_Tahap1_detail]') AND type in (N'U')) DROP TABLE [dbo].[tempBS_Tahap1_detail] " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTotalDefect_detail]') AND type in (N'U')) DROP TABLE [dbo].[tempTotalDefect_detail]  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTotalDefect_Pro_detail]') AND type in (N'U')) DROP TABLE [dbo].[tempTotalDefect_Pro_detail] " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTotalPot_QA]') AND type in (N'U')) DROP TABLE [dbo].[tempTotalPot_QA]  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDefect_Master_ListPlank]') AND type in (N'U')) DROP TABLE [dbo].[tempDefect_Master_ListPlank] " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTtlBP_LP]') AND type in (N'U')) DROP TABLE [dbo].[tempTtlBP_LP]  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTtlOK_LP]') AND type in (N'U')) DROP TABLE [dbo].[tempTtlOK_LP]  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTtl_LP]') AND type in (N'U')) DROP TABLE [dbo].[tempTtl_LP]  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTotalPotong_BP_LP]') AND type in (N'U')) DROP TABLE [dbo].[tempTotalPotong_BP_LP] " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTotalPotong_LP]') AND type in (N'U')) DROP TABLE [dbo].[tempTotalPotong_LP]  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTotalPotong_UkuranKhusus]') AND type in (N'U')) DROP TABLE [dbo].[tempTotalPotong_UkuranKhusus] " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempGroup]') AND type in (N'U')) DROP TABLE [dbo].[tempGroup]  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempGroup2]') AND type in (N'U')) DROP TABLE [dbo].[tempGroup2]  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempGroup3]') AND type in (N'U')) DROP TABLE [dbo].[tempGroup3]  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTotalPot_LP_UkuranKhusus]') AND type in (N'U')) DROP TABLE [dbo].[tempTotalPot_LP_UkuranKhusus] " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTotalPot_SystemLP]') AND type in (N'U')) DROP TABLE [dbo].[tempTotalPot_SystemLP]  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempSelisih_TotPot]') AND type in (N'U')) DROP TABLE [dbo].[tempSelisih_TotPot]  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTotPot_Proposionet]') AND type in (N'U')) DROP TABLE [dbo].[tempTotPot_Proposionet] " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempGroup_LPUK]') AND type in (N'U')) DROP TABLE [dbo].[tempGroup_LPUK]  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[temp_OKKM]') AND type in (N'U')) DROP TABLE [dbo].[temp_OKKM]  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[temp_Retur]') AND type in (N'U')) DROP TABLE [dbo].[temp_Retur]  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[temp_Sortir]') AND type in (N'U')) DROP TABLE [dbo].[temp_Sortir]  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[temp_TotalDefect]') AND type in (N'U')) DROP TABLE [dbo].[temp_TotalDefect] " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[temp_Persen]') AND type in (N'U')) DROP TABLE [dbo].[temp_Persen]  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[temp_Total]') AND type in (N'U')) DROP TABLE [dbo].[temp_Total]  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[temp_DataDefectISO]') AND type in (N'U')) DROP TABLE [dbo].[temp_DataDefectISO] " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectGPIsoTot]') AND type in (N'U')) DROP TABLE [dbo].[tempdefectGPIsoTot]  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectL1]') AND type in (N'U')) DROP TABLE [dbo].tempdefectL1  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectL2]') AND type in (N'U')) DROP TABLE [dbo].tempdefectL2  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectL3]') AND type in (N'U')) DROP TABLE [dbo].tempdefectL3  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectL4]') AND type in (N'U')) DROP TABLE [dbo].tempdefectL4  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectL5]') AND type in (N'U')) DROP TABLE [dbo].tempdefectL5  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectL6]') AND type in (N'U')) DROP TABLE [dbo].tempdefectL6 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDataSarmut_Defect]') AND type in (N'U')) DROP TABLE [dbo].tempDataSarmut_Defect " +

                        " IF  EXISTS(SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Master_Plant1]') AND type in (N'U')) DROP TABLE [dbo].Master_Plant1 "+
                        " IF  EXISTS(SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Master_Plant2]') AND type in (N'U')) DROP TABLE[dbo].Master_Plant2 " +
                        " IF  EXISTS(SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Master_Plant3]') AND type in (N'U')) DROP TABLE[dbo].Master_Plant3 " +
                        " IF  EXISTS(SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[temp_UkuranKhusus_Trans]') AND type in (N'U')) DROP TABLE[dbo].temp_UkuranKhusus_Trans " +
                        " IF  EXISTS(SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Master_Plant22]') AND type in (N'U')) DROP TABLE[dbo].Master_Plant22 " +
                        " IF  EXISTS(SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Master_Plant33]') AND type in (N'U')) DROP TABLE[dbo].Master_Plant33 " +
                        " IF  EXISTS(SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[temp_ToPotUK_Trans]') AND type in (N'U')) DROP TABLE[dbo].temp_ToPotUK_Trans " +
                        " IF  EXISTS(SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[temp_ListPlank_Trans]') AND type in (N'U')) DROP TABLE[dbo].temp_ListPlank_Trans " +
                        " IF  EXISTS(SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Master_Plant23]') AND type in (N'U')) DROP TABLE[dbo].Master_Plant23 " +
                        " IF  EXISTS(SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Master_Plant34]') AND type in (N'U')) DROP TABLE[dbo].Master_Plant34 " +
                        " IF  EXISTS(SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[temp_M_LP]') AND type in (N'U')) DROP TABLE[dbo].temp_M_LP " +
                        " IF  EXISTS(SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[temp_TtlBP_Trans]') AND type in (N'U')) DROP TABLE[dbo].temp_TtlBP_Trans "+
                        " IF  EXISTS(SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[temp_TtlOK_Trans]') AND type in (N'U')) DROP TABLE[dbo].temp_TtlOK_Trans "+

                        #endregion
                        #region Logika
                        " declare @Total_tempDefect_BM_detail decimal(18,5) " +
                        " declare @Total_tempDefect_Fin_detail decimal(10,5) " +
                        " declare @Selisih_ttl_defect decimal(10,5) " +
                        " declare @dtlSelisih_ttl_defect decimal(10,5) " +
                        " declare @Selisih_ttl_defect2 decimal(10,5) " +
                        " declare @Total_Defect_ListPlank decimal(10,5) " +
                        " declare @Total_Defect_UkuranKhusus decimal(10,5) " +
                        " declare @OutBP_WiP decimal(10,5) " +
                        " declare @Total_tempDefect_BM decimal(10,5) " +
                        " declare @Total_Defect_BMFin decimal(10,5)  " +
                        " declare @Total_DefectProduksi decimal(10,5)  " +
                        " declare @TtlBS_Tahap1 decimal(10,5)   " +
                        " declare @TtlPot_All decimal(10,5)   " +
                        " declare @Selisih_TotPot decimal(10,5)  " +
                        " declare @TotPot_LP_UKhusus decimal(10,5)  " +
                        " declare @TotGroup_LP_UKhusus decimal(10,5)  " +
                        " declare @Tot_Sortir decimal(10,5)  " +
                        " declare @Tot_OKKM decimal(10,5)  " +
                        " declare @Tot_Retur decimal(10,5)  " +
                        " declare @Tot_GP decimal(10,5)  " +

                        " declare @thnbln1 varchar(8) declare @thnbln2 varchar(8) declare @BlnThn varchar(6) " +

                        " set @thnbln1='" + strtgl1 + "' " +
                        " set @thnbln2='" + strtgl2 + "' " +
                        " set @BlnThn='" + Periode + "' " +

                        " select [Group],'0' M3 into tempData_Group from BM_PlantGroup where PlantID>0 " +

                        " set @Tot_GP=isnull(( " +
                        " select count(PlantGroupID)ttl from ( " +
                        " select distinct PlantGroupID from BM_Destacking where left(convert(char,tglproduksi,112),6)=SUBSTRING(@thnbln1,1,6) and RowStatus>-1 " +
                        " and LokasiID not in (select ID from FC_Lokasi where Lokasi like'%adj%') " +
                        " ) as x),0) " +

                        " select A.[Group] into tempGroup3 from ( " +
                        " select distinct PlantGroupID IDGroup from BM_Destacking where left(convert(char,tglproduksi,112),6)=SUBSTRING(@thnbln1,1,6) " +
                        " and RowStatus>-1 and LokasiID not in (select ID from FC_Lokasi where Lokasi like'%adj%')) as x " +
                        " inner join BM_PlantGroup A ON A.ID=x.IDGroup " +

                        /** Defect BM **/
                        " select *  into tempDefect_BM from (  select case when D.DeptID=0 then  case when GJ.GroupJemurName In ('M','N','O','P','Q','R','S','T','U','V','W','X') then " +
                        " case when D.DefName='retak' then 2 when D.DefName='gompal' then 3 else D.DeptID end else " +
                        " case when (B.Qty/E.Qty) *100 >5 then 2 else 3 end   end  else D.DeptID end deptID1,A.CreatedTime as tglInput,A.Tgl as TglPeriksa, " +
                        " E.TglProduksi as TglProd,  D.DefCode,BP.PlantName as Line, PG.[Group],BF.FormulaCode as Jenis,D.DefName,D.DeptID,B.ID,B.DefectID, " +
                        " B.MasterID,B.Qty,A.ID  DestID,isnull(A.TPotong,0)  QtyIn, " +
                        " I.Volume*B.Qty Kubik,isnull(A.TPotong,0) as TotPotong,'' sfrom  " +
                        " from Def_DefectDetail B " +
                        " inner join Def_Defect A on A.Id=B.DefectID   " +
                        " left join Def_MasterDefect D on B.MasterID=D.ID " +
                        " left join BM_Destacking E on E.ID=A.DestID  " +
                        " left join BM_PlantGroup PG on A.GroupProdID=PG.ID " +
                        " left join BM_Formula BF on BF.ID=E.FormulaID   " +
                        " left join BM_Plant BP on BP.ID=E.PlantID " +
                        " left join FC_Items I on I.ID=E.ItemID " +
                        " inner join Def_GroupJemur GJ on GJ.ID=A.GroupJemurID  " +
                        " where B.RowStatus>-1  and D.RowStatus >-1) as Def    " +
                        " where DeptID1=2 and CONVERT(varchar,TglPeriksa,112)>=@thnbln1 and CONVERT(varchar,TglPeriksa,112)<=@thnbln2    " +

                        " select *,isnull((select sum(qty) from tempDefect_BM where [group]=A.[Group] ),0) totdefect, isnull((select sum(kubik) from tempDefect_BM where [group]=A.[Group] ),0) totdefectK into tempdefectGPIsoTot from ( select  B.[Group],SUM(C.qtyin) as totpotong,SUM(kubik) as totkubik    from BM_Destacking A left join BM_PlantGroup B on A.PlantGroupID=B.ID  inner join (  select C.destid,C.qtyin,C.QtyIn*I1.Volume as kubik from T1_Serah C Inner join fc_items I  on C.itemid=I.ID Inner join fc_items I1 on C.itemid0=I1.ID  where C.Status>-1 and CONVERT(char,C.tglserah,112)>=@thnbln1 and   CONVERT(char,C.tglserah,112)<=@thnbln2 and (I.PartNo like '%-w-%' or I.PartNo like '%-3-%' )  union all   select C.DestID , B.Qty qtyin,B.Qty*I.Volume as kubik from Def_Defect A inner join Def_DefectDetail B on A.ID=B.DefectID  inner join T1_Serah C on A.SerahID=C.ID  left join FC_Items I on I.ID=C.ItemID0  where CONVERT(char,A.tgl,112)>=@thnbln1 and  CONVERT(char,A.tgl,112)<=@thnbln2 and B.RowStatus>-1 ) as C   on A.ID=C.DestID group by B.[Group])A  " +

                        /** Defect Finishing **/
                        " select * into tempDefect_Fin " +
                        " from (  select case when D.DeptID=0 then  case when GJ.GroupJemurName In ('M','N','O','P','Q','R','S','T','U','V','W','X') then  " +
                        " case when D.DefName='retak' then 2 when D.DefName='gompal' then 3 else D.DeptID end else case when (B.Qty/E.Qty) *100 >5 then 2 " +
                        " else 3 end   end  else D.DeptID end deptID1,A.CreatedTime as tglInput,A.Tgl as TglPeriksa,E.TglProduksi as TglProd, " +
                        " D.DefCode,BP.PlantName as Line, PG.[Group],BF.FormulaCode as Jenis,D.DefName,D.DeptID,B.ID,B.DefectID,B.MasterID,B.Qty,A.ID " +
                        " DestID,isnull(A.TPotong,0)  QtyIn,B.Qty*I.Volume as Kubik,isnull(A.TPotong,0) as TotPotong,'' sfrom  " +
                        " from Def_DefectDetail B inner join Def_Defect A on A.Id=B.DefectID   left join Def_MasterDefect D on B.MasterID=D.ID " +
                        " left join BM_Destacking E on E.ID=A.DestID   left join BM_PlantGroup PG on A.GroupProdID=PG.ID " +
                        " left join BM_Formula BF on BF.ID=E.FormulaID    left join BM_Plant BP on BP.ID=E.PlantID left join FC_Items I on I.ID=E.ItemID " +
                        " inner join Def_GroupJemur GJ on GJ.ID=A.GroupJemurID  where B.RowStatus>-1  and D.RowStatus >-1) as Def  " +
                        " where DeptID1=3 and CONVERT(varchar,TglPeriksa,112)>=@thnbln1 and CONVERT(varchar,TglPeriksa,112)<=@thnbln2 " +

                        /** Defect Ukuran Khusus **/
                        /** temp Table temp_UkuranKhusus_detail **/
                        /** temp Table Master_Plant1 **/
" select B.PartNo,PlantID,ThnBln into Master_Plant1 from( "+
" select distinct ItemID, PlantID, left(convert(char, tglproduksi,112),6)ThnBln from BM_Destacking where RowStatus > -1 group by ItemID,PlantiD,TglProduksi ) as A inner join FC_Items B ON A.ItemID = B.ID "+

                        " select *,(select top 1 A1.ThnBln from Master_Plant1 A1 where A1.PartNo = x.PartnoAsal and A1.ThnBln <= left(convert(char, @thnbln1, 112), 6) order by A1.ThnBln desc)ThnBln into temp_UkuranKhusus_Trans from( " +
                        " select x.ItemID, x.PartnoAsal, x.Qty, cast(((A.Tebal* A.Lebar* A.Panjang)/ 1000000000)*x.Qty as decimal(18, 2)) M3 "+
                        " from(select PartNo PartnoAsal, ItemID, isnull(SUM(Qty),0)  *-1 Qty from vw_KartuStockBJNew where qty < 0 and(process  like '%simetris%') and(Keterangan like '%-P-%') and LokID not In(select ID from FC_Lokasi where lokasi = 'q99')   and left(convert(char, tanggal,112),8)>= @thnbln1 and left(convert(char, tanggal,112),8)<= @thnbln2 and ItemID in (select ID from FC_Items where PartNo like'%-1-%') group by ItemID,Keterangan,PartNo,ItemID   ) as x  inner join FC_Items A ON A.ID = x.ItemID ) as x " +

                        /** temp Table Master_Plant2 **/
                        " select PartnoAsal, M3, PlantID into Master_Plant2 from( " +
                        " select PartnoAsal, M3,case when PlantID2 is null then PlantID else PlantID2 end PlantID from( " +
                        " select *, (select top 1 A1.Line from Def_UKhususProsen A1 where A1.Partno = x.PartnoAsal and A1.Periode = left(convert(char, @thnbln1, 112), 6))PlantID2 from( " +
                        " select PartnoAsal, sum(M3) M3, ThnBln, PlantID from (select A.*,B.PlantID from temp_UkuranKhusus_Trans A left join Master_Plant1 B ON A.PartnoAsal = B.PartNo and A.ThnBln = B.ThnBln ) as x group by PartnoAsal,ThnBln,PlantID ) as x ) as xx ) as xxx group by PartnoAsal,M3,PlantID " +

                        /** temp Table Master_Plant3 **/
                        " select cast(m3 as decimal(18, 2))m3,PlantID into Master_Plant3 from( " +
                        " select PartnoAsal,case when ttl = 1 then m3 when ttl> 1 then m3/ ttl end m3, PlantID  from( " +
                        " select PartnoAsal, sum(m3)m3, PlantID, ttl from( " +
                        " select PartnoAsal, M3, PlantID, (select count(PartnoAsal) from Master_Plant2 A where A.PartnoAsal = Master_Plant2.PartnoAsal)ttl from Master_Plant2 group by PartnoAsal, M3, PlantID) as x group by PartnoAsal,PlantID,ttl ) as xx group by PlantID,m3,ttl,PartnoAsal ) as xxx " +

                        " select[Group],sum(m3)M3 into tempDefect_UkuranKhusus_detail from( " +
                        " select cast(sum(m3)/ 4 as decimal(18, 3)) m3,A.PlantID,B.[Group] from Master_Plant3 A inner join BM_PlantGroup B ON A.PlantID = B.PlantID where B.PlantID > 0 group by A.PlantID,B.[Group]  union all " +
                        " select 0 M3,PlantID,[group] from BM_PlantGroup where PlantID > 0 ) as x group by[Group] " +

                        /** Total Potong Ukuran Khusus **/
                        /** Temp Table : tempTotalPotong_UkuranKhusus  **/
                        /** temp Table temp_ToPotUK_Trans **/
                        " select *,(select top 1 A1.ThnBln from Master_Plant1 A1 where A1.PartNo = x.PartnoAsal and A1.ThnBln <= left(convert(char, @thnbln1, 112), 6) order by A1.ThnBln desc)ThnBln into temp_ToPotUK_Trans from( " +
                        " select x.ItemID, x.PartnoAsal, x.Qty, ((A.Tebal* A.Lebar* A.Panjang)/ 1000000000)*x.Qty M3 from(select PartNo PartnoAsal, ItemID, isnull(SUM(Qty),0)  *-1 Qty from vw_KartuStockBJNew where qty < 0 and(process  like '%simetris%') and(Keterangan like '%-P-%' or Keterangan like '%-3-%' or Keterangan like '%-M-%') and LokID not In(select ID from FC_Lokasi where lokasi = 'q99')   and left(convert(char, tanggal,112),8)>= @thnbln1 and left(convert(char, tanggal,112),8)<= @thnbln2 and ItemID in (select ID from FC_Items where PartNo like'%-1-%') group by ItemID,Keterangan,PartNo,ItemID   ) as x  inner join FC_Items A ON A.ID = x.ItemID ) as x " +

                        /** temp Table Master_Plant22 **/
                        " select PartnoAsal, M3, PlantID into Master_Plant22 from( " +
                        " select PartnoAsal, M3,case when PlantID2 is null then PlantID else PlantID2 end PlantID from( " +
                        " select *, (select top 1 A1.Line from Def_UKhususProsen A1 where A1.Partno = x.PartnoAsal and A1.Periode = left(convert(char, @thnbln1, 112), 6))PlantID2 from( " +
                        " select PartnoAsal, sum(M3) M3, ThnBln, PlantID from (select A.*,B.PlantID from temp_ToPotUK_Trans A left join Master_Plant1 B ON A.PartnoAsal = B.PartNo and A.ThnBln = B.ThnBln ) as x group by PartnoAsal,ThnBln,PlantID ) as x ) as xx ) as xxx group by PartnoAsal,M3,PlantID " +

                        /** temp Table Master_Plant33 **/
                        " select cast(m3 as decimal(18, 2))m3,PlantID into Master_Plant33 from( " +
                        " select PartnoAsal,case when ttl = 1 then m3 when ttl> 1 then m3/ ttl end m3, PlantID  from( " +
                        " select PartnoAsal, sum(m3)m3, PlantID, ttl from( " +
                        " select PartnoAsal, M3, PlantID, (select count(PartnoAsal) from Master_Plant22 A where A.PartnoAsal = Master_Plant22.PartnoAsal)ttl from Master_Plant22 group by PartnoAsal, M3, PlantID) as x group by PartnoAsal,PlantID,ttl ) as xx group by PlantID,m3,ttl,PartnoAsal ) as xxx " +

                        " select[Group],sum(m3)M3 into tempTotalPotong_UkuranKhusus from( " +
                        " select cast(sum(m3)/ 4 as decimal(18, 2)) m3,A.PlantID,B.[Group] from Master_Plant33 A inner join BM_PlantGroup B ON A.PlantID = B.PlantID where B.PlantID > 0 group by A.PlantID,B.[Group]  union all " +
                        " select 0 M3,PlantID,[group] from BM_PlantGroup where PlantID > 0 ) as x group by[Group] " +

                        //" ;with dataDestacking as (select distinct ItemID,PlantID,left(convert(char,tglproduksi,112),6)ThnBln from BM_Destacking where RowStatus>-1 group by ItemID,PlantiD,TglProduksi ), " +
                        //" dataDestacking1 as (select B.PartNo,PlantID,ThnBln from dataDestacking A inner join FC_Items B ON A.ItemID=B.ID),  " +
                        //" dataDestacking2 as (select x.ItemID,x.PartnoAsal,x.Qty,((A.Tebal*A.Lebar*A.Panjang)/1000000000)*x.Qty M3 from (   select PartNo PartnoAsal,ItemID,isnull(SUM(Qty),0)  * -1 Qty from vw_KartuStockBJNew  where qty <0 and (process  like '%simetris%' ) and  (Keterangan like '%-P-%' or Keterangan like '%-3-%' or Keterangan like '%-M-%') and  LokID not In (select ID from FC_Lokasi where lokasi='q99')   and left(convert(char,tanggal,112),8)>=@thnbln1 and  left(convert(char,tanggal,112),8)<=@thnbln2 and ItemID in (select ID  from FC_Items where PartNo like'%-1-%') group by ItemID,Keterangan,PartNo,ItemID   ) as x  inner join FC_Items A ON A.ID=x.ItemID),    " +
                        //" dataDestacking3 as (select *,(select top 1 A1.ThnBln from dataDestacking1 A1 where A1.PartNo=A.PartnoAsal and A1.ThnBln<=left(convert(char,@thnbln1,112),6) order by A1.ThnBln desc)ThnBln from dataDestacking2 A) ,    " +
                        //" dataDestacking4 as (select PartnoAsal,sum(M3)M3,ThnBln,PlantID from (select A.*,B.PlantID from dataDestacking3 A left join dataDestacking1 B ON A.PartnoAsal=B.PartNo and A.ThnBln=B.ThnBln ) as x group by PartnoAsal,ThnBln,PlantID),    " +
                        //" dataDestacking04 as (select *,(select top 1 A1.Line from Def_UKhususProsen A1 where A1.Partno=A.PartnoAsal and A1.Periode=left(convert(char,@thnbln1,112),6))PlantID2 from dataDestacking4 A ),    " +
                        //" dataDestacking5 as (select PartnoAsal,M3,case when PlantID2 is null then PlantID else PlantID2 end PlantID from dataDestacking04 xx),  " +
                        //" dataDestacking051 as (select PartnoAsal,M3,PlantID from dataDestacking5 xx group by PartnoAsal,M3,PlantID ),  " +
                        //" dataDestacking05 as (select PartnoAsal,M3,PlantID,(select count(PartnoAsal) from dataDestacking051 A where A.PartnoAsal=dataDestacking051.PartnoAsal)ttl from dataDestacking051 group by PartnoAsal,M3,PlantID),    " +
                        //" dataDestacking6 as (select PartnoAsal,sum(m3)m3,PlantID,ttl from dataDestacking05 group by PlantID,ttl,PartnoAsal), " +
                        //" dataDestacking06 as (select PartnoAsal,case when ttl=1 then m3 when ttl>1 then m3/ttl end m3,PlantID from dataDestacking6 group by PlantID,m3,ttl,PartnoAsal),   " +

                        //" dataDestacking006 as (select cast(m3 as decimal(18,2))m3,PlantID from dataDestacking06 ) " +
                        //" select [Group],sum(m3)M3 into tempTotalPotong_UkuranKhusus from ( " +
                        //" select cast(sum(m3)/ 4 as decimal(18, 3)) m3,A.PlantID,B.[Group] from dataDestacking006 A inner join BM_PlantGroup B ON A.PlantID = B.PlantID where B.PlantID > 0 group by A.PlantID,B.[Group] " +                        " union all " +
                        //" select 0 M3,PlantID,[group] from BM_PlantGroup where PlantID > 0 ) as x group by[Group] " +


                        /** OK KM **/
                        " set @Tot_OKKM= " +
                        " isnull((select cast(sum(qtyin *((I.tebal*I.Lebar*I.Panjang)/1000000000)) as decimal(18,2))M3 " +
                        " from T3_Rekap R inner join fc_items I on R.itemid=I.ID  where R.rowstatus>-1 and R.Process  like '%simetris%' " +
                        " and CONVERT(varchar,R.tgltrans,112)>=@thnbln1 and CONVERT(varchar,R.tgltrans,112)<=@thnbln2   and I.lebar=1200 and I.panjang=2400 " +
                        " and R.keterangan like '%-p-%' and (I.partno like '%-3-%' or I.partno like '%-W-%' or I.partno like '%-M-%' )),0)  " +

                        /** Sortir **/
                        " set @Tot_Sortir= " +
                        " isnull((select cast(sum(M3AkhirSS)+sum(M3AkhirSE) as decimal(18,0))M3 " +
                        " from (  SELECT B.tgltrans as Tanggal, I1.PartNo as PartnoAwal, sum(B.QtyIn) as QtyAwal,sum(I1.Volume*B.QtyIn) M3Awal,  " +
                        " I2.PartNo AS PartnoAkhir, case when B.NCSS>0 then sum(B.QtyOut) else 0 end QtyAkhirSS,  case when B.NCSS>0 " +
                        " then sum(I2.Volume*B.QtyOut) else 0 end M3AkhirSS,case when B.NCSE>0 then sum(B.QtyOut) else 0 end QtyAkhirSE,  " +
                        " case when B.NCSE>0 then sum(I2.Volume*B.QtyOut) else 0 end M3AkhirSE,B.NCSS,B.NCSE  " +
                        " FROM T3_Serah AS A   INNER JOIN T3_Simetris AS B ON A.ID = B.SerahID " +
                        " INNER JOIN FC_Items AS I1 ON A.ItemID = I1.ID " +
                        " INNER JOIN   FC_Items AS I2 ON B.ItemID = I2.ID " +
                        " LEFT JOIN T3_GroupM AS D ON B.GroupID = D.ID   " +
                        " where (B.NCSS>0 or B.NCSE>0) and B.rowstatus>-1 and CONVERT(varchar,B.tgltrans,112)>=@thnbln1 " +
                        " and CONVERT(varchar,B.tgltrans,112)<=@thnbln2   group by B.tgltrans,I1.PartNo,I2.PartNo,B.NCSS,B.NCSE ) as xx ),0)  " +

                        /** Retur **/
                        " set @Tot_Retur= " +
                        "" + logikaretur + "" +
                        //" isnull((select cast((TotK1/**-TotK2)+TotK3**/) as decimal(18,2))M3 " +
                        //" from (  select cast((sum(Volume*Tot1)) as decimal(18,2)) TotK1,cast((sum(Volume*Tot2)) as decimal(18,2)) TotK2, " +
                        //" cast((sum(Volume*Tot3)) as decimal(18,2)) TotK3 " +
                        //" from (  select tanggal,PartNo,volume ,sum(isnull(QtyC1,0))QtyC1,sum(isnull(QtyP1,0)) QtyP1,sum(isnull(QtyS1,0)) QtyS1, " +
                        //" sum(isnull(Tot1,0)) Tot1,sum(isnull(TotK1,0)) TotK1, sum(isnull(QtyC2,0)) QtyC2,sum(isnull(QtyP2,0)) QtyP2,sum(isnull(QtyS2,0)) " +
                        //" QtyS2,sum(isnull(Tot2,0)) Tot2, sum(isnull(TotK2,0)) TotK2,sum(isnull(QtyC3,0)) QtyC3,sum(isnull(QtyP3,0)) QtyP3, " +
                        //" sum(isnull(QtyS3,0)) QtyS3,sum(isnull(Tot3,0)) Tot3,sum(isnull(TotK3,0)) TotK3 from ( select tanggal ,PartNo,volume, " +
                        //" case when typeR=1 and ((KW='3' or KW='W')or lokasi='cl') then Qty end QtyC1,case when typeR=1 and (KW='P'and lokasi <> 'cl') " +
                        //" then Qty end QtyP1, case when typeR=1 and (KW='S'and lokasi <> 'cl') then Qty end QtyS1, case when typeR=1 and ((KW='P' or KW='S') " +
                        //" and lokasi <> 'cl') then Qty end Tot1, case when typeR=1 and (KW='P' or KW='S') then QtyK end TotK1, case when typeR=2 " +
                        //" and ((KW='3' or KW='W')or lokasi='cl') then Qty end QtyC2, case when typeR=2 and (KW='P' and lokasi <> 'cl') then Qty end QtyP2, " +
                        //" case when typeR=2 and (KW='S' and lokasi <> 'cl') then Qty end QtyS2, case when typeR=2 and ((KW='P' or KW='S') and lokasi <> 'cl') " +
                        //" then Qty end Tot2, case when typeR=2 and ((KW='P' or KW='S') and lokasi <> 'cl') then QtyK end TotK2, " +
                        //" case when typeR=3 and ((KW='3' or KW='W')or lokasi='cl') then Qty end QtyC3, case when typeR=3 and (KW='P' and lokasi <> 'cl') " +
                        //" then Qty end QtyP3, case when typeR=3 and (KW='S' and lokasi <> 'cl') then Qty end QtyS3, case when typeR=3 and ((KW='P' or KW='S') " +
                        //" and lokasi <> 'cl') then Qty   end Tot3, case when typeR=3 and ((KW='P' or KW='S') and lokasi <> 'cl') then QtyK end TotK3 " +
                        //" from (select R.TglTrans tanggal,I.PartNo,I.volume,SUBSTRING(I.partno,5,1) as KW,sum(R.Qty)Qty, " +
                        //" sum(((I.Panjang*I.Lebar)/(1220*2440) ) * R.Qty) QtyK,isnull(R.TypeR,1)  TypeR,I.ID,L.Lokasi    " +
                        //" from T3_Retur R inner join FC_Items I on R.ItemID =I.ID  inner join FC_lokasi L on R.LokID=L.ID  where R.RowStatus>-1   " +
                        //" group by R.TglTrans,I.PartNo,I.volume,R.TypeR,I.ID,L.Lokasi " +
                        //" union all " +
                        //" select R.TglTrans tanggal,I.PartNo,I.volume,SUBSTRING(I.partno,5,1) as KW,sum(R.Qty)Qty," +
                        //" sum(((I.Panjang*I.Lebar)/(1220*2440) ) * R.Qty) QtyK,3  TypeR,I.ID,L.Lokasi     " +
                        //" from T3_ReturO R inner join FC_Items I on R.ItemID =I.ID  inner join FC_lokasi L on R.LokID=L.ID  where R.RowStatus>-1  " +
                        //" group by R.TglTrans,I.PartNo,I.volume,I.ID,L.Lokasi ) as A ) as B where convert(char,tanggal,112)>=@thnbln1 " +
                        //" and convert(char,tanggal,112)<=@thnbln2 group by tanggal,PartNo,volume ) as x ) as x1),0)  " +

                        /** Data Master Defect ListPlank sampai Strapping **/
                        " select * into tempDefect_Master_ListPlank  from  (  select PartnoAsal,isnull(cast((sum(M3)) as decimal(18,2)),0) M3  " +
                        " from (  select PartnoAsal,isnull(cast((sum(M3)) as decimal(18,2)),0)M3  " +
                        " from (  select PartnoAsal,Qty,cast((((Tebal*Lebar*Panjang)/1000000000)*Qty) as decimal(18,5)) M3  from ( " +

                        " select PartnoAsal,PartNo2,sum(Qty)Qty,Tebal,Lebar,Panjang " +
                        " from (  select x1.PartNo PartnoAsal,x2.PartNo PartNo2,x2.Tebal,x2.Lebar,x2.Panjang,x.Qty " +
                        " from (  select ItemID0,itemid,Qty * -1 Qty from vw_KartuStockListplank where left(convert(char,tanggal,112),8)>=@thnbln1 " +
                        " and  left(convert(char,tanggal,112),8)<=@thnbln2 and process='runingsaw' and qty<0 ) as x   " +
                        " inner join FC_Items x1 ON x.ItemID0=x1.ID  inner join FC_Items x2 ON x.ItemID=x2.ID) as A " +
                        " group by PartnoAsal,PartNo2,Tebal,Lebar,Panjang ) as xx ) as xx1  group by PartnoAsal  " +
                        " union all " +

                        /** 2. Saldo Awal Running Saw **/
                        " select PartnoAsal,isnull(cast((sum((Volume*Qty))) as decimal(18,2)),0) M3  " +
                        " from (  select x2.PartNo PartnoAsal,cast(((x1.Tebal*x1.Lebar*x1.Panjang)/1000000000) as decimal(10,5))Volume,x.Qty  " +
                        " from (  select sum(saldo)Qty ,ItemID,ItemID0 from T1_SaldoListPlank where Process='runingsaw' and thnbln=@BlnThn and Saldo>0 " +
                        " and ItemID<>ItemID0 group by ItemID,ItemID0 ) as x   " +
                        " inner join FC_Items x1 ON x.ItemID=x1.ID  inner join FC_Items x2 ON x.ItemID0=x2.ID) as A group by PartnoAsal " +
                        " union all   " +
                        /** 3. Saldo Akhir RunningSaw **/
                        " select PartnoAsal,isnull(cast((sum(M3)) as decimal(18,2)) * -1,0) M3 " +
                        " from (  select PartnoAsal,Qty,cast((((Tebal*Lebar*Panjang)/1000000000)*Qty) as decimal(18,5)) M3  " +
                        " from (  select PartnoAsal,PartNo2,sum(Qty)Qty,Tebal,Lebar,Panjang  " +
                        " from (  select x1.PartNo PartnoAsal,x2.PartNo PartNo2,x2.Tebal,x2.Lebar,x2.Panjang,x.Qty " +
                        " from (  select sum(Saldo)Qty,ItemID0,ItemID from T1_SaldoListPlank where Process='runingsaw' " +
                        " and thnbln=left(convert(char,@thnbln1,112),6) and Saldo>0 and ItemID<>ItemID0  group by ItemID0,ItemID ) as x  " +
                        " inner join FC_Items x1 ON x.ItemID0=x1.ID  inner join FC_Items x2 ON x.ItemID=x2.ID) as A " +
                        " group by PartnoAsal,PartNo2,Tebal,Lebar,Panjang ) as xx ) as xx1    group by PartnoAsal  " +
                        " union all " +
                        /** 4. Saldo Awal Bevel **/
                        " select PartnoAsal,isnull(cast((sum(M3)) as decimal(18,2)),0) M3 " +
                        " from (  select PartnoAsal,Qty,cast((((Tebal*Lebar*Panjang)/1000000000)*Qty) as decimal(18,5)) M3 " +
                        " from (  select PartnoAsal,PartNo2,sum(Qty)Qty,Tebal,Lebar,Panjang " +
                        " from (  select x1.PartNo PartnoAsal,x2.PartNo PartNo2,x2.Tebal,x2.Lebar,x2.Panjang,x.Qty " +
                        " from (  select sum(Saldo)Qty,ItemID0,ItemID from T1_SaldoListPlank where Process='bevel' and thnbln=@BlnThn and Saldo>0 " +
                        " group by ItemID0,ItemID ) as x   inner join FC_Items x1 ON x.ItemID0=x1.ID  inner join FC_Items x2 ON x.ItemID=x2.ID) as A " +
                        " group by PartnoAsal,PartNo2,Tebal,Lebar,Panjang ) as xx ) as xx1 group by PartnoAsal   " +
                        " union all   " +
                        /** 5. Saldo Akhir Bevel **/
                        " select PartnoAsal,isnull(cast((sum(M3)) as decimal(18,2)) * -1,0) M3 " +
                        " from (  select PartnoAsal,Qty,cast((((Tebal*Lebar*Panjang)/1000000000)*Qty) as decimal(18,5)) M3  " +
                        " from (  select PartnoAsal,PartNo2,sum(Qty)Qty,Tebal,Lebar,Panjang  " +
                        " from (  select x1.PartNo PartnoAsal,x2.PartNo PartNo2,x2.Tebal,x2.Lebar,x2.Panjang,x.Qty " +
                        " from (  select sum(Saldo)Qty,ItemID0,ItemID from T1_SaldoListPlank where Process='bevel' " +
                        " and thnbln=left(convert(char,@thnbln1,112),6) and Saldo>0 and ItemID<>ItemID0  group by ItemID0,ItemID ) as x  " +
                        " inner join FC_Items x1 ON x.ItemID0=x1.ID  inner join FC_Items x2 ON x.ItemID=x2.ID) as A " +
                        " group by PartnoAsal,PartNo2,Tebal,Lebar,Panjang ) as xx ) as xx1   group by PartnoAsal   " +
                        " union all  " +
                        /** 6. Saldo Awal Strapping **/
                        " select PartnoAsal,isnull(cast((sum(M3)) as decimal(18,2)),0) M3 " +
                        " from (select PartnoAsal,Qty,cast((((Tebal*Lebar*Panjang)/1000000000)*Qty) as decimal(18,5)) M3 " +
                        " from (  select PartnoAsal,PartNo2,sum(Qty)Qty,Tebal,Lebar,Panjang  " +
                        " from (  select x1.PartNo PartnoAsal,x2.PartNo PartNo2,x2.Tebal,x2.Lebar,x2.Panjang,x.Qty " +
                        " from (  select sum(Saldo)Qty,ItemID0,ItemID from T1_SaldoListPlank where Process='straping' and thnbln=@BlnThn and Saldo>0 " +
                        " group by ItemID0,ItemID ) as x   inner join FC_Items x1 ON x.ItemID0=x1.ID  inner join FC_Items x2 ON x.ItemID=x2.ID) as A " +
                        " group by PartnoAsal,PartNo2,Tebal,Lebar,Panjang ) as xx ) as xx1 group by PartnoAsal  " +
                        " union all  " +
                        /** 7. Saldo Akhir Strapping **/
                        " select PartnoAsal,isnull(cast((sum(M3)) as decimal(18,2))* -1,0) M3 " +
                        " from (  select PartnoAsal,Qty,cast((((Tebal*Lebar*Panjang)/1000000000)*Qty) as decimal(18,5)) M3  " +
                        " from (  select PartnoAsal,PartNo2,sum(Qty)Qty,Tebal,Lebar,Panjang  " +
                        " from (  select x1.PartNo PartnoAsal,x2.PartNo PartNo2,x2.Tebal,x2.Lebar,x2.Panjang,x.Qty " +
                        " from (  select sum(Saldo)Qty,ItemID0,ItemID from T1_SaldoListPlank where Process='straping' " +
                        " and thnbln=left(convert(char,@thnbln1,112),6) and Saldo>0 and ItemID<>ItemID0  group by ItemID0,ItemID ) as x " +
                        " inner join FC_Items x1 ON x.ItemID0=x1.ID  inner join FC_Items x2 ON x.ItemID=x2.ID) as A " +
                        " group by PartnoAsal,PartNo2,Tebal,Lebar,Panjang ) as xx ) as xxx group by PartnoAsal  " +
                        " ) as DataFinall group by PartnoAsal ) as x " +
                        //" select * into tempDefect_Master_ListPlank from Listplank_Master; " +

                        /** Defect ListPlank **/
                        "  select *,(select top 1 A1.ThnBln from Master_Plant1 A1 where A1.PartNo=x.PartnoAsal and A1.ThnBln<=left(convert(char,@thnbln1,112),6) order by A1.ThnBln desc)ThnBln into temp_ListPlank_Trans from ( " +
                        "  select PartnoAsal,isnull((sum(M3)) ,0) M3  from ( select PartnoAsal,sum(M3)M3 from (  select PartnoAsal,isnull((sum(M3)) ,0)M3  from (  select PartnoAsal,Qty,(((Tebal*Lebar*Panjang)/1000000000)*Qty) M3  from (  select PartnoAsal,PartNo2,sum(Qty)Qty,Tebal,Lebar,Panjang  from (  select x1.PartNo PartnoAsal,x2.PartNo PartNo2,x2.Tebal,x2.Lebar,x2.Panjang,x.Qty from (  select ItemID0,itemid,Qty * -1 Qty from vw_KartuStockListplank where left(convert(char,tanggal,112),8)>=@thnbln1 and  left(convert(char,tanggal,112),8)<=@thnbln2 and process='runingsaw' and qty<0 ) as x   inner join FC_Items x1 ON x.ItemID0=x1.ID  inner join FC_Items x2 ON x.ItemID=x2.ID) as A group by PartnoAsal,PartNo2,Tebal,Lebar,Panjang ) as xx ) as xx1  group by PartnoAsal   " +
                        "  union all  " +
                        "  select PartnoAsal,isnull((sum(M3)) ,0)M3  from (  select PartnoAsal,Qty,(((Tebal*Lebar*Panjang)/1000000000)*Qty) M3  from (  select PartnoAsal,PartNo2,sum(Qty)Qty,Tebal,Lebar,Panjang  from (  select x1.PartNo PartnoAsal,x2.PartNo PartNo2,x2.Tebal,x2.Lebar,x2.Panjang,x.Qty from (  select ItemID0,itemid,Qty * -1 Qty from vw_KartuStockListplank where left(convert(char,tanggal,112),8)>=@thnbln1 and  left(convert(char,tanggal,112),8)<=@thnbln2 and process Like '%adjoutruningsaw%' and qty<0 ) as x   inner join FC_Items x1 ON x.ItemID0=x1.ID  inner join FC_Items x2 ON x.ItemID=x2.ID) as A group by PartnoAsal,PartNo2,Tebal,Lebar,Panjang ) as xx ) as xx1  group by PartnoAsal  " +
                        "  union all   " +
                        "  select PartnoAsal,isnull((sum(M3)) ,0)M3  from (  select PartnoAsal,Qty,(((Tebal*Lebar*Panjang)/1000000000)*Qty) M3  from (  select PartnoAsal,PartNo2,sum(Qty)Qty,Tebal,Lebar,Panjang  from (  select x1.PartNo PartnoAsal,x2.PartNo PartNo2,x2.Tebal,x2.Lebar,x2.Panjang,x.Qty from (  select ItemID0,itemid,Qty * -1 Qty from vw_KartuStockListplank where left(convert(char,tanggal,112),8)>=@thnbln1 and  left(convert(char,tanggal,112),8)<=@thnbln2 and process Like '%adjinruningsaw%' and qty<0 ) as x   inner join FC_Items x1 ON x.ItemID0=x1.ID  inner join FC_Items x2 ON x.ItemID=x2.ID) as A group by PartnoAsal,PartNo2,Tebal,Lebar,Panjang ) as xx ) as xx1  group by PartnoAsal  ) as x group by PartnoAsal  " +
                        "  union all " +
                        "  select PartnoAsal,isnull((sum((Volume*Qty))) ,0) M3  from (  select x2.PartNo PartnoAsal,((x1.Tebal*x1.Lebar*x1.Panjang)/1000000000) Volume,x.Qty  from (  select sum(saldo)Qty ,ItemID,ItemID0 from T1_SaldoListPlank where Process='runingsaw' and thnbln=@BlnThn and Saldo>0 and ItemID<>ItemID0 group by ItemID,ItemID0 ) as x    inner join FC_Items x1 ON x.ItemID=x1.ID  inner join FC_Items x2 ON x.ItemID0=x2.ID) as A group by PartnoAsal    " +
                        "  union all " +
                        "  select PartnoAsal,isnull((sum(M3)) * -1,0) M3 from (  select PartnoAsal,Qty,(((Tebal*Lebar*Panjang)/1000000000)*Qty)  M3  from (  select PartnoAsal,PartNo2,sum(Qty)Qty,Tebal,Lebar,Panjang  from (  select x1.PartNo PartnoAsal,x2.PartNo PartNo2,x2.Tebal,x2.Lebar,x2.Panjang,x.Qty from (  select sum(Saldo)Qty,ItemID0,ItemID from T1_SaldoListPlank where Process='runingsaw' and thnbln=left(convert(char,@thnbln1,112),6) and Saldo>0 and ItemID<>ItemID0  group by ItemID0,ItemID ) as x   inner join FC_Items x1 ON x.ItemID0=x1.ID  inner join FC_Items x2 ON x.ItemID=x2.ID) as A group by PartnoAsal,PartNo2,Tebal,Lebar,Panjang ) as xx ) as xx1    group by PartnoAsal  " +
                        "  union all  " +
                        "  select PartnoAsal,isnull((sum(M3)) ,0) M3  from (  select PartnoAsal,Qty,(((Tebal*Lebar*Panjang)/1000000000)*Qty)  M3  from (  select PartnoAsal,PartNo2,sum(Qty)Qty,Tebal,Lebar,Panjang  from (  select x1.PartNo PartnoAsal,x2.PartNo PartNo2,x2.Tebal,x2.Lebar,x2.Panjang,x.Qty from (  select sum(Saldo)Qty,ItemID0,ItemID from T1_SaldoListPlank where Process='bevel' and thnbln=@BlnThn and Saldo>0 group by ItemID0,ItemID ) as x   inner join FC_Items x1 ON x.ItemID0=x1.ID  inner join FC_Items x2 ON x.ItemID=x2.ID) as A group by PartnoAsal,PartNo2,Tebal,Lebar,Panjang ) as xx ) as xx1 group by PartnoAsal  " +
                        "  union all  " +
                        "  select PartnoAsal,isnull((sum(M3))  * -1,0) M3 from (  select PartnoAsal,Qty,(((Tebal*Lebar*Panjang)/1000000000)*Qty)  M3  from (  select PartnoAsal,PartNo2,sum(Qty)Qty,Tebal,Lebar,Panjang  from (  select x1.PartNo PartnoAsal,x2.PartNo PartNo2,x2.Tebal,x2.Lebar,x2.Panjang,x.Qty from (  select sum(Saldo)Qty,ItemID0,ItemID from T1_SaldoListPlank where Process='bevel' and thnbln=left(convert(char,@thnbln1,112),6) and Saldo>0 and ItemID<>ItemID0  group by ItemID0,ItemID ) as x   inner join FC_Items x1 ON x.ItemID0=x1.ID  inner join FC_Items x2 ON x.ItemID=x2.ID) as A group by PartnoAsal,PartNo2,Tebal,Lebar,Panjang ) as xx ) as xx1   group by PartnoAsal  " +
                        "  union all   " +
                        "  select PartnoAsal,isnull((sum(M3)) ,0) M3 from (select PartnoAsal,Qty,(((Tebal*Lebar*Panjang)/1000000000)*Qty)  M3  from (  select PartnoAsal,PartNo2,sum(Qty)Qty,Tebal,Lebar,Panjang  from (  select x1.PartNo PartnoAsal,x2.PartNo PartNo2,x2.Tebal,x2.Lebar,x2.Panjang,x.Qty from (  select sum(Saldo)Qty,ItemID0,ItemID from T1_SaldoListPlank where Process='straping' and thnbln=@BlnThn and Saldo>0 group by ItemID0,ItemID ) as x   inner join FC_Items x1 ON x.ItemID0=x1.ID  inner join FC_Items x2 ON x.ItemID=x2.ID) as A group by PartnoAsal,PartNo2,Tebal,Lebar,Panjang ) as xx ) as xx1 group by PartnoAsal   " +
                        "  union all     " +
                        "  select PartnoAsal,isnull((sum(M3)) * -1,0) M3 from (  select PartnoAsal,Qty,(((Tebal*Lebar*Panjang)/1000000000)*Qty)  M3  from (  select PartnoAsal,PartNo2,sum(Qty)Qty,Tebal,Lebar,Panjang  from (  select x1.PartNo PartnoAsal,x2.PartNo PartNo2,x2.Tebal,x2.Lebar,x2.Panjang,x.Qty from (  select sum(Saldo)Qty,ItemID0,ItemID from T1_SaldoListPlank where Process='straping' and thnbln=left(convert(char,@thnbln1,112),6) and Saldo>0 and ItemID<>ItemID0  group by ItemID0,ItemID ) as x   inner join FC_Items x1 ON x.ItemID0=x1.ID  inner join FC_Items x2 ON x.ItemID=x2.ID) as A group by PartnoAsal,PartNo2,Tebal,Lebar,Panjang ) as xx ) as xxx group by PartnoAsal   " +
                        "  union all  " +
                        "  select PartnoAsal,isnull((sum(M3))*-1 ,0) M3 from (  select PartnoAsal,Qty,(((Tebal*Lebar*Panjang)/1000000000)*Qty)  M3  from (  select PartnoAsal,sum(Qty)Qty,Tebal,Lebar,Panjang  from (  select x.PartNo PartnoAsal,x2.Tebal,x2.Lebar,x2.Panjang,x.Qty from (  select sum(Qty)Qty,ItemID,Keterangan Partno from vw_KartuStockBJNew  where sfrom='straping' and left(convert(char,tanggal,112),6)=left(convert(char,@thnbln1,112),6) and ItemID in  (select ID from FC_Items where PartNo like'%-M-%' or PartNo like'%-3-%')  group by ItemID,Keterangan ) as x   inner join FC_Items x2 ON x.ItemID=x2.ID) as A group by PartnoAsal,Tebal,Lebar,Panjang ) as xx ) as xx1 group by PartnoAsal    " +
                        "  union all " +
                        "  select PartnoAsal,isnull((sum(M3)),0) M3  from (  select PartnoAsal,Qty,(((Tebal*Lebar*Panjang)/1000000000)*Qty)   M3  from (  select PartnoAsal,sum(Qty)Qty,Tebal,Lebar,Panjang  from (  select x.PartNo PartnoAsal,x2.Tebal,x2.Lebar,x2.Panjang,x.Qty from (  select sum(Qty)Qty,ItemID,Keterangan Partno from vw_KartuStockBJNew  where sfrom='straping' and left(convert(char,tanggal,112),6)=left(convert(char,@thnbln1,112),6) and  ItemID in (select ID from FC_Items where PartNo like'%-P-%' or PartNo like'%-S-%')  group by ItemID,Keterangan ) as x   inner join FC_Items x2 ON x.ItemID=x2.ID) as A group by PartnoAsal,Tebal,Lebar,Panjang ) as xx ) as xx1 group by PartnoAsal  ) as DataFinall group by PartnoAsal) as x " +

                        /** temp Table Master_Plant23 **/
                        " select PartnoAsal,M3,PlantID into Master_Plant23 from ( " +
                        " select PartnoAsal,M3,case when PlantID2 is null then PlantID else PlantID2 end PlantID from ( " +
                        " select *,(select top 1 A1.Line from Def_UKhususProsen A1 where A1.Partno=x.PartnoAsal and A1.Periode=left(convert(char,@thnbln1,112),6))PlantID2  from ( " +
                        " select PartnoAsal,sum(M3)M3,ThnBln,PlantID from (select A.*,B.PlantID from temp_ListPlank_Trans A left join Master_Plant1 B ON A.PartnoAsal=B.PartNo and A.ThnBln=B.ThnBln ) as x group by PartnoAsal,ThnBln,PlantID ) as x ) as xx ) as xxx group by PartnoAsal,M3,PlantID " +

                        /** temp Table Master_Plant34 **/
                        " select m3,PlantID into Master_Plant34 from ( " +
                        " select PartnoAsal,case when ttl=1 then m3 when ttl>1 then m3/ttl end m3,PlantID  from ( " +
                        " select PartnoAsal,sum(m3)m3,PlantID,ttl from ( " +
                        " select PartnoAsal,M3,PlantID,(select count(PartnoAsal) from Master_Plant23 A where A.PartnoAsal=Master_Plant23.PartnoAsal)ttl from Master_Plant23 group by PartnoAsal,M3,PlantID ) as x group by PartnoAsal,PlantID,ttl ) as xx group by PlantID,m3,ttl,PartnoAsal ) as xxx " +

                        "   select [Group],sum(m3)M3 into tempDefect_ListPlank_detail  from ( " +
                        " select cast(sum(M3) as decimal(18,2))/4 M3,A.PlantID,B.[Group] from Master_Plant34 A inner join BM_PlantGroup B ON A.PlantID=B.PlantID where B.PlantID>0 group by A.PlantID,B.[Group]  union all " +
                        " select 0 M3,PlantID,[group] from BM_PlantGroup where PlantID>0 ) as x group by [Group] " +


                        //" ;with   Listplank as (select distinct ItemID,PlantID,left(convert(char,tglproduksi,112),6)ThnBln from BM_Destacking where RowStatus>-1 group by ItemID,PlantiD,TglProduksi ),  Listplank1 as (select B.PartNo,PlantID,ThnBln from Listplank A inner join FC_Items B ON A.ItemID=B.ID),  " +
                        //" Listplank2 as (  select PartnoAsal,isnull((sum(M3)) ,0) M3  from ( select PartnoAsal,sum(M3)M3 from ( " +
                        //" select PartnoAsal,isnull((sum(M3)) ,0)M3  from (  select PartnoAsal,Qty,(((Tebal*Lebar*Panjang)/1000000000)*Qty) M3  from (  select PartnoAsal,PartNo2,sum(Qty)Qty,Tebal,Lebar,Panjang  from (  select x1.PartNo PartnoAsal,x2.PartNo PartNo2,x2.Tebal,x2.Lebar,x2.Panjang,x.Qty from (  select ItemID0,itemid,Qty * -1 Qty from vw_KartuStockListplank where left(convert(char,tanggal,112),8)>=@thnbln1 and  left(convert(char,tanggal,112),8)<=@thnbln2 and process='runingsaw' and qty<0 ) as x   inner join FC_Items x1 ON x.ItemID0=x1.ID  inner join FC_Items x2 ON x.ItemID=x2.ID) as A group by PartnoAsal,PartNo2,Tebal,Lebar,Panjang ) as xx ) as xx1  group by PartnoAsal   " +
                        //" union all " +
                        //" select PartnoAsal,isnull((sum(M3)) ,0)M3  from (  select PartnoAsal,Qty,(((Tebal*Lebar*Panjang)/1000000000)*Qty) M3  from (  select PartnoAsal,PartNo2,sum(Qty)Qty,Tebal,Lebar,Panjang  from (  select x1.PartNo PartnoAsal,x2.PartNo PartNo2,x2.Tebal,x2.Lebar,x2.Panjang,x.Qty from (  select ItemID0,itemid,Qty * -1 Qty from vw_KartuStockListplank where left(convert(char,tanggal,112),8)>=@thnbln1 and  left(convert(char,tanggal,112),8)<=@thnbln2 and process Like '%adjoutruningsaw%' and qty<0 ) as x   inner join FC_Items x1 ON x.ItemID0=x1.ID  inner join FC_Items x2 ON x.ItemID=x2.ID) as A group by PartnoAsal,PartNo2,Tebal,Lebar,Panjang ) as xx ) as xx1  group by PartnoAsal  " +
                        //" union all " +
                        //" select PartnoAsal,isnull((sum(M3)) ,0)M3  from (  select PartnoAsal,Qty,(((Tebal*Lebar*Panjang)/1000000000)*Qty) M3  from (  select PartnoAsal,PartNo2,sum(Qty)Qty,Tebal,Lebar,Panjang  from (  select x1.PartNo PartnoAsal,x2.PartNo PartNo2,x2.Tebal,x2.Lebar,x2.Panjang,x.Qty from (  select ItemID0,itemid,Qty * -1 Qty from vw_KartuStockListplank where left(convert(char,tanggal,112),8)>=@thnbln1 and  left(convert(char,tanggal,112),8)<=@thnbln2 and process Like '%adjinruningsaw%' and qty<0 ) as x   inner join FC_Items x1 ON x.ItemID0=x1.ID  inner join FC_Items x2 ON x.ItemID=x2.ID) as A group by PartnoAsal,PartNo2,Tebal,Lebar,Panjang ) as xx ) as xx1  group by PartnoAsal " +
                        //" ) as x group by PartnoAsal " +
                        //" union all " +
                        ///** 2. Saldo Awal Running Saw **/
                        //" select PartnoAsal,isnull((sum((Volume*Qty))) ,0) M3  from (  select x2.PartNo PartnoAsal,((x1.Tebal*x1.Lebar*x1.Panjang)/1000000000) Volume,x.Qty  from (  select sum(saldo)Qty ,ItemID,ItemID0 from T1_SaldoListPlank where Process='runingsaw' and thnbln=@BlnThn and Saldo>0 and ItemID<>ItemID0 group by ItemID,ItemID0 ) as x    inner join FC_Items x1 ON x.ItemID=x1.ID  inner join FC_Items x2 ON x.ItemID0=x2.ID) as A group by PartnoAsal   " +
                        //" union all " +
                        ///** 3. Saldo Akhir RunningSaw **/
                        //" select PartnoAsal,isnull((sum(M3)) * -1,0) M3 from (  select PartnoAsal,Qty,(((Tebal*Lebar*Panjang)/1000000000)*Qty)  M3  from (  select PartnoAsal,PartNo2,sum(Qty)Qty,Tebal,Lebar,Panjang  from (  select x1.PartNo PartnoAsal,x2.PartNo PartNo2,x2.Tebal,x2.Lebar,x2.Panjang,x.Qty from (  select sum(Saldo)Qty,ItemID0,ItemID from T1_SaldoListPlank where Process='runingsaw' and thnbln=left(convert(char,@thnbln1,112),6) and Saldo>0 and ItemID<>ItemID0  group by ItemID0,ItemID ) as x   inner join FC_Items x1 ON x.ItemID0=x1.ID  inner join FC_Items x2 ON x.ItemID=x2.ID) as A group by PartnoAsal,PartNo2,Tebal,Lebar,Panjang ) as xx ) as xx1    group by PartnoAsal   " +
                        //" union all " +
                        ///** 4. Saldo Awal Bevel **/
                        //" select PartnoAsal,isnull((sum(M3)) ,0) M3  from (  select PartnoAsal,Qty,(((Tebal*Lebar*Panjang)/1000000000)*Qty)  M3  from (  select PartnoAsal,PartNo2,sum(Qty)Qty,Tebal,Lebar,Panjang  from (  select x1.PartNo PartnoAsal,x2.PartNo PartNo2,x2.Tebal,x2.Lebar,x2.Panjang,x.Qty from (  select sum(Saldo)Qty,ItemID0,ItemID from T1_SaldoListPlank where Process='bevel' and thnbln=@BlnThn and Saldo>0 group by ItemID0,ItemID ) as x   inner join FC_Items x1 ON x.ItemID0=x1.ID  inner join FC_Items x2 ON x.ItemID=x2.ID) as A group by PartnoAsal,PartNo2,Tebal,Lebar,Panjang ) as xx ) as xx1 group by PartnoAsal   union all    " +
                        ///** 5. Saldo Akhir Bevel **/
                        //" select PartnoAsal,isnull((sum(M3))  * -1,0) M3 from (  select PartnoAsal,Qty,(((Tebal*Lebar*Panjang)/1000000000)*Qty)  M3  from (  select PartnoAsal,PartNo2,sum(Qty)Qty,Tebal,Lebar,Panjang  from (  select x1.PartNo PartnoAsal,x2.PartNo PartNo2,x2.Tebal,x2.Lebar,x2.Panjang,x.Qty from (  select sum(Saldo)Qty,ItemID0,ItemID from T1_SaldoListPlank where Process='bevel' and thnbln=left(convert(char,@thnbln1,112),6) and Saldo>0 and ItemID<>ItemID0  group by ItemID0,ItemID ) as x   inner join FC_Items x1 ON x.ItemID0=x1.ID  inner join FC_Items x2 ON x.ItemID=x2.ID) as A group by PartnoAsal,PartNo2,Tebal,Lebar,Panjang ) as xx ) as xx1   group by PartnoAsal   union all   " +
                        ///** 6. Saldo Awal Strapping **/
                        //" select PartnoAsal,isnull((sum(M3)) ,0) M3 from (select PartnoAsal,Qty,(((Tebal*Lebar*Panjang)/1000000000)*Qty)  M3  from (  select PartnoAsal,PartNo2,sum(Qty)Qty,Tebal,Lebar,Panjang  from (  select x1.PartNo PartnoAsal,x2.PartNo PartNo2,x2.Tebal,x2.Lebar,x2.Panjang,x.Qty from (  select sum(Saldo)Qty,ItemID0,ItemID from T1_SaldoListPlank where Process='straping' and thnbln=@BlnThn and Saldo>0 group by ItemID0,ItemID ) as x   inner join FC_Items x1 ON x.ItemID0=x1.ID  inner join FC_Items x2 ON x.ItemID=x2.ID) as A group by PartnoAsal,PartNo2,Tebal,Lebar,Panjang ) as xx ) as xx1 group by PartnoAsal  " +
                        //" union all   " +
                        ///** 7. Saldo Akhir Strapping **/
                        //" select PartnoAsal,isnull((sum(M3)) * -1,0) M3 from (  select PartnoAsal,Qty,(((Tebal*Lebar*Panjang)/1000000000)*Qty)  M3  from (  select PartnoAsal,PartNo2,sum(Qty)Qty,Tebal,Lebar,Panjang  from (  select x1.PartNo PartnoAsal,x2.PartNo PartNo2,x2.Tebal,x2.Lebar,x2.Panjang,x.Qty from (  select sum(Saldo)Qty,ItemID0,ItemID from T1_SaldoListPlank where Process='straping' and thnbln=left(convert(char,@thnbln1,112),6) and Saldo>0 and ItemID<>ItemID0  group by ItemID0,ItemID ) as x   inner join FC_Items x1 ON x.ItemID0=x1.ID  inner join FC_Items x2 ON x.ItemID=x2.ID) as A group by PartnoAsal,PartNo2,Tebal,Lebar,Panjang ) as xx ) as xxx group by PartnoAsal  " +
                        //" union all   " +
                        ///** 8. Tahap III OK **/
                        //" select PartnoAsal,isnull((sum(M3))*-1 ,0) M3 from (  select PartnoAsal,Qty,(((Tebal*Lebar*Panjang)/1000000000)*Qty)  M3  from (  select PartnoAsal,sum(Qty)Qty,Tebal,Lebar,Panjang  from (  select x.PartNo PartnoAsal,x2.Tebal,x2.Lebar,x2.Panjang,x.Qty from (  select sum(Qty)Qty,ItemID,Keterangan Partno from vw_KartuStockBJNew  where sfrom='straping' and left(convert(char,tanggal,112),6)=left(convert(char,@thnbln1,112),6) and ItemID in  (select ID from FC_Items where PartNo like'%-M-%' or PartNo like'%-3-%')  group by ItemID,Keterangan ) as x   inner join FC_Items x2 ON x.ItemID=x2.ID) as A group by PartnoAsal,Tebal,Lebar,Panjang ) as xx ) as xx1 group by PartnoAsal   " +
                        //" union all " +
                        ///** 9. Tahap III BP **/
                        //" select PartnoAsal,isnull((sum(M3)),0) M3  from (  select PartnoAsal,Qty,(((Tebal*Lebar*Panjang)/1000000000)*Qty)   M3  from (  select PartnoAsal,sum(Qty)Qty,Tebal,Lebar,Panjang  from (  select x.PartNo PartnoAsal,x2.Tebal,x2.Lebar,x2.Panjang,x.Qty from (  select sum(Qty)Qty,ItemID,Keterangan Partno from vw_KartuStockBJNew  where sfrom='straping' and left(convert(char,tanggal,112),6)=left(convert(char,@thnbln1,112),6) and  ItemID in (select ID from FC_Items where PartNo like'%-P-%' or PartNo like'%-S-%')  group by ItemID,Keterangan ) as x   inner join FC_Items x2 ON x.ItemID=x2.ID) as A group by PartnoAsal,Tebal,Lebar,Panjang ) as xx ) as xx1 group by PartnoAsal  ) as DataFinall group by PartnoAsal ) ,  " +
                        //" Listplank3 as (select *,(select top 1 A1.ThnBln from Listplank1 A1 where A1.PartNo=A.PartnoAsal and A1.ThnBln<=left(convert(char,@thnbln1,112),6) order by A1.ThnBln desc)ThnBln from Listplank2 A) ,  " +
                        //" Listplank4 as (select PartnoAsal,sum(M3)M3,ThnBln,PlantID from (select A.*,B.PlantID from Listplank3 A left join Listplank1 B ON A.PartnoAsal=B.PartNo and A.ThnBln=B.ThnBln ) as x group by PartnoAsal,ThnBln,PlantID), " +
                        //" Listplank04 as (select *,(select top 1 A1.Line from Def_UKhususProsen A1 where A1.Partno=A.PartnoAsal and A1.Periode=left(convert(char,@thnbln1,112),6))PlantID2 from Listplank4 A ), " +
                        //" Listplank5 as (select PartnoAsal,M3,case when PlantID2 is null then PlantID else PlantID2 end PlantID from Listplank04 xx),  Listplank051 as (select PartnoAsal,M3,PlantID from Listplank5 xx group by PartnoAsal,M3,PlantID ), " +
                        //" Listplank05 as (select PartnoAsal,M3,PlantID,(select count(PartnoAsal) from Listplank051 A where A.PartnoAsal=Listplank051.PartnoAsal)ttl from Listplank051 group by PartnoAsal,M3,PlantID),  Listplank6 as (select PartnoAsal,sum(m3)m3,PlantID,ttl from Listplank05 group by PlantID,ttl,PartnoAsal), " +
                        //" Listplank06 as (select PartnoAsal,case when ttl=1 then m3 when ttl>1 then m3/ttl end m3,PlantID from Listplank6 group by PlantID,m3,ttl,PartnoAsal),  " +
                        //" Listplank006 as (select sum(m3)m3,PlantID  from Listplank06 group by PlantID), " +
                        //" Listplank0006 as (select cast(m3 as decimal(18,3))M3,PlantID  from Listplank006), " +
                        //" Listplank7 as (  select sum(M3)M3,[Group] from (  select cast(M3 as decimal(18,2))/4 M3,B.[Group] from Listplank0006 A inner join BM_PlantGroup B ON A.PlantID=B.PlantID where B.PlantID>0 " +
                        //" union all  " +
                        //" select 0'M3',[Group] from BM_PlantGroup where PlantID>0 ) as x group by [Group] )   " +
                        //" select [Group],M3 into tempDefect_ListPlank_detail from Listplank7;  " +

                        /** ListPlank Before BP dan OK **/

                        /** Temp Table : tempTtl_LP  **/
                        " select *,(select top 1 A1.ThnBln from Master_Plant1 A1 where A1.PartNo = x.PartnoAsal and A1.ThnBln <= left(convert(char, @thnbln1, 112), 6) order by A1.ThnBln desc)ThnBln into temp_M_LP from( " +
                        " select PartnoAsal, isnull(cast((sum(M3)) as decimal(18, 4)),0) M3 from(select* from tempDefect_Master_ListPlank  ) as DataFinall group by PartnoAsal ) as x " +

                        " select cast(sum(M3) as decimal(18, 2))M3,PlantID into tempTtl_LP from( " +
                        " select PartnoAsal, M3,case when PlantID2 is null then PlantID else PlantID2 end PlantID from( " +
                        " select *, (select top 1 A1.Line from Def_UKhususProsen A1 where A1.Partno = x.PartnoAsal and A1.Periode = left(convert(char, @thnbln1, 112), 6))PlantID2 from( " +
                        " select PartnoAsal, sum(M3) M3, ThnBln, PlantID from (select A.*,B.PlantID from temp_M_LP A left join Master_Plant1 B ON A.PartnoAsal = B.PartNo and A.ThnBln = B.ThnBln ) as x group by PartnoAsal,ThnBln,PlantID ) as x ) as xx ) as xxx group by PlantID " +

                        //" with LP_1 as (select distinct ItemID,PlantID,left(convert(char,tglproduksi,112),6)ThnBln from BM_Destacking where RowStatus>-1 group by ItemID,PlantiD,TglProduksi ),  " +
                        //" LP_2 as (select B.PartNo,PlantID,ThnBln from LP_1 A inner join FC_Items B ON A.ItemID=B.ID),  " +
                        //" LP_3 as ( select PartnoAsal,isnull(cast((sum(M3)) as decimal(18,4)),0) M3  from (  " +
                        //" select * from tempDefect_Master_ListPlank " +
                        //" ) as DataFinall group by PartnoAsal) , " +
                        //" LP_4 as (select *,(select top 1 A1.ThnBln from LP_2 A1 where A1.PartNo=A.PartnoAsal and A1.ThnBln<=left(convert(char,@thnbln1,112),6) order by A1.ThnBln desc)ThnBln from LP_3 A), " +
                        //" LP_5 as (select PartnoAsal,sum(M3)M3,ThnBln,PlantID from (select A.*,B.PlantID from LP_4 A left join LP_2 B ON A.PartnoAsal=B.PartNo and A.ThnBln=B.ThnBln ) as x group by PartnoAsal,ThnBln,PlantID),   " +
                        //" LP_6 as (select *,(select top 1 A1.Line from Def_UKhususProsen A1 where A1.Partno=A.PartnoAsal and A1.Periode=left(convert(char,@thnbln1,112),6))PlantID2 from LP_5 A ),  " +
                        //" LP_7 as (select PartnoAsal,M3,case when PlantID2 is null then PlantID else PlantID2 end PlantID from LP_6 xx) " +
                        //" select cast(sum(M3) as decimal(18,2))M3,PlantID into tempTtl_LP from LP_7 group by PlantID " +

                        /** ListPlank BP **/
                        " select *,(select top 1 A1.ThnBln from Master_Plant1 A1 where A1.PartNo = x.PartnoAsal and A1.ThnBln <= left(convert(char, @thnbln1, 112), 6) order by A1.ThnBln desc)ThnBln into temp_TtlBP_Trans from( " +
                        " select PartnoAsal, isnull(cast((sum(M3)) as decimal(18, 4)),0) M3 from(select PartnoAsal, isnull(cast((sum(M3)) as decimal(18, 5)),0) M3 from(select PartnoAsal, Qty, cast((((Tebal* Lebar* Panjang)/ 1000000000)*Qty) as decimal(18, 5))  M3 from(select PartnoAsal, sum(Qty) Qty, Tebal, Lebar, Panjang from (select x.PartNo PartnoAsal, x2.Tebal, x2.Lebar, x2.Panjang, x.Qty from (select sum(Qty) Qty, ItemID, Keterangan Partno from vw_KartuStockBJNew  where sfrom = 'straping' and left(convert(char, tanggal,112),6)= left(convert(char, @thnbln1, 112), 6) and ItemID in (select ID from FC_Items where PartNo like'%-P-%' or PartNo like'%-S-%')  group by ItemID,Keterangan ) as x   inner join FC_Items x2 ON x.ItemID = x2.ID) as A group by PartnoAsal,Tebal,Lebar,Panjang ) as xx ) as xx1 group by PartnoAsal   ) as DataFinall group by PartnoAsal ) as x " +

                        " select cast(sum(M3) as decimal(18, 2))M3,PlantID into tempTtlBP_LP from( " +
                        " select PartnoAsal, M3,case when PlantID2 is null then PlantID else PlantID2 end PlantID from( " +
                        " select *, (select top 1 A1.Line from Def_UKhususProsen A1 where A1.Partno = x.PartnoAsal and A1.Periode = left(convert(char, @thnbln1, 112), 6))PlantID2 from( " +
                        " select PartnoAsal, sum(M3) M3, ThnBln, PlantID from (select A.*,B.PlantID from temp_TtlBP_Trans A left join Master_Plant1 B ON A.PartnoAsal = B.PartNo and A.ThnBln = B.ThnBln ) as x group by PartnoAsal,ThnBln,PlantID ) as x ) as xx ) as xxx group by PlantID " +


//" ;with LP_1 as (select distinct ItemID,PlantID,left(convert(char,tglproduksi,112),6)ThnBln from BM_Destacking where RowStatus>-1 group by ItemID,PlantiD,TglProduksi ),   " +
//" LP_2 as (select B.PartNo,PlantID,ThnBln from LP_1 A inner join FC_Items B ON A.ItemID=B.ID), " +
//" LP_3 as ( select PartnoAsal,isnull(cast((sum(M3)) as decimal(18,4)),0) M3  from ( " +
///** Tahap III BP **/
//" select PartnoAsal,isnull(cast((sum(M3)) as decimal(18,5)),0) M3  from (  select PartnoAsal,Qty,cast((((Tebal*Lebar*Panjang)/1000000000)*Qty) as decimal(18,5))  M3  from (  select PartnoAsal,sum(Qty)Qty,Tebal,Lebar,Panjang  from (  select x.PartNo PartnoAsal,x2.Tebal,x2.Lebar,x2.Panjang,x.Qty from (  select sum(Qty)Qty,ItemID,Keterangan Partno from vw_KartuStockBJNew  where sfrom='straping' and left(convert(char,tanggal,112),6)=left(convert(char,@thnbln1,112),6) and  ItemID in (select ID from FC_Items where PartNo like'%-P-%' or PartNo like'%-S-%')  group by ItemID,Keterangan ) as x   inner join FC_Items x2 ON x.ItemID=x2.ID) as A group by PartnoAsal,Tebal,Lebar,Panjang ) as xx ) as xx1 group by PartnoAsal  " +
//" ) as DataFinall group by PartnoAsal) , " +
//" LP_4 as (select *,(select top 1 A1.ThnBln from LP_2 A1 where A1.PartNo=A.PartnoAsal and A1.ThnBln<=left(convert(char,@thnbln1,112),6) order by A1.ThnBln desc)ThnBln from LP_3 A), " +
//" LP_5 as (select PartnoAsal,sum(M3)M3,ThnBln,PlantID from (select A.*,B.PlantID from LP_4 A left join LP_2 B ON A.PartnoAsal=B.PartNo and A.ThnBln=B.ThnBln ) as x group by PartnoAsal,ThnBln,PlantID),  " +
//" LP_6 as (select *,(select top 1 A1.Line from Def_UKhususProsen A1 where A1.Rowstatus>-1 and A1.Partno=A.PartnoAsal and A1.Periode=left(convert(char,@thnbln1,112),6))PlantID2 from LP_5 A ),  " +
//" LP_7 as (select PartnoAsal,M3,case when PlantID2 is null then PlantID else PlantID2 end PlantID from LP_6 xx) " +
//" select cast(sum(M3) as decimal(18,2))M3,PlantID into tempTtlBP_LP from LP_7 group by PlantID " +

///** ListPlank OK **/
//" ;with LP_1 as (select distinct ItemID,PlantID,left(convert(char,tglproduksi,112),6)ThnBln from BM_Destacking where RowStatus>-1 group by ItemID,PlantiD,TglProduksi ), " +
//" LP_2 as (select B.PartNo,PlantID,ThnBln from LP_1 A inner join FC_Items B ON A.ItemID=B.ID),  " +
//" LP_3 as ( select PartnoAsal,isnull((sum(M3)) ,0) M3  from ( " +
//    /** Tahap III OK **/
//" select PartnoAsal,isnull((sum(M3)),0) M3 from (  select PartnoAsal,Qty,(((Tebal*Lebar*Panjang)/1000000000)*Qty)  M3  from (  select PartnoAsal,sum(Qty)Qty,Tebal,Lebar,Panjang  from (  select x.PartNo PartnoAsal,x2.Tebal,x2.Lebar,x2.Panjang,x.Qty from (  select sum(Qty)Qty,ItemID,Keterangan Partno from vw_KartuStockBJNew  where sfrom='straping' and left(convert(char,tanggal,112),6)=left(convert(char,@thnbln1,112),6) and ItemID in  (select ID from FC_Items where PartNo like'%-M-%' or PartNo like'%-3-%')  group by ItemID,Keterangan ) as x   inner join FC_Items x2 ON x.ItemID=x2.ID) as A group by PartnoAsal,Tebal,Lebar,Panjang ) as xx ) as xx1 group by PartnoAsal  " +
//" ) as DataFinall group by PartnoAsal) , " +
//" LP_4 as (select *,(select top 1 A1.ThnBln from LP_2 A1 where A1.PartNo=A.PartnoAsal and A1.ThnBln<=left(convert(char,@thnbln1,112),6) order by A1.ThnBln desc)ThnBln from LP_3 A), " +
//" LP_5 as (select PartnoAsal,sum(M3)M3,ThnBln,PlantID from (select A.*,B.PlantID from LP_4 A left join LP_2 B ON A.PartnoAsal=B.PartNo and A.ThnBln=B.ThnBln ) as x group by PartnoAsal,ThnBln,PlantID),  " +
//" LP_6 as (select *,(select top 1 A1.Line from Def_UKhususProsen A1 where A1.Partno=A.PartnoAsal and A1.Periode=left(convert(char,@thnbln1,112),6))PlantID2 from LP_5 A ),   " +
//" LP_7 as (select PartnoAsal,M3,case when PlantID2 is null then PlantID else PlantID2 end PlantID from LP_6 xx) " +
//" select cast(sum(M3) as decimal(18,3)) M3,PlantID into tempTtlOK_LP from LP_7  group by PlantID " +

                        /** ListPlank OK **/
                        /** Temp Table : tempTtlOK_LP  **/
                        " select *,(select top 1 A1.ThnBln from Master_Plant1 A1 where A1.PartNo = x.PartnoAsal and A1.ThnBln <= left(convert(char, @thnbln1, 112), 6) order by A1.ThnBln desc)ThnBln into temp_TtlOK_Trans from( " +
                        " select PartnoAsal, isnull((sum(M3)) ,0) M3 from(select PartnoAsal, isnull((sum(M3)),0) M3 from(select PartnoAsal, Qty, (((Tebal* Lebar* Panjang)/ 1000000000)*Qty)  M3 from(select PartnoAsal, sum(Qty) Qty, Tebal, Lebar, Panjang from (select x.PartNo PartnoAsal, x2.Tebal, x2.Lebar, x2.Panjang, x.Qty from (select sum(Qty) Qty, ItemID, Keterangan Partno from vw_KartuStockBJNew  where sfrom = 'straping'  and left(convert(char, tanggal,112),6)= left(convert(char, @thnbln1, 112), 6) and ItemID in  (select ID from FC_Items where PartNo like'%-M-%' or PartNo like'%-3-%')  group by ItemID,Keterangan ) as x  inner join FC_Items x2 ON x.ItemID = x2.ID) as A group by PartnoAsal,Tebal,Lebar,Panjang ) as xx ) as xx1  group by PartnoAsal   ) as DataFinall group by PartnoAsal ) as x " +

                        " select sum(M3) M3,PlantID into tempTtlOK_LP from( " +
                        " select PartnoAsal, M3,case when PlantID2 is null then PlantID else PlantID2 end PlantID from( " +
                        " select *, (select top 1 A1.Line from Def_UKhususProsen A1 where A1.Partno = x.PartnoAsal and A1.Periode = left(convert(char, '20221001', 112), 6))PlantID2 from( " +
                        " select PartnoAsal, sum(M3) M3, ThnBln, PlantID from (select A.*,B.PlantID from temp_TtlOK_Trans A left join Master_Plant1 B ON A.PartnoAsal = B.PartNo and A.ThnBln = B.ThnBln ) as x group by PartnoAsal,ThnBln,PlantID ) as x ) as xx ) as xxx group by PlantID " +

                        //" ;with LP_1 as (select distinct ItemID,PlantID,left(convert(char,tglproduksi,112),6)ThnBln from BM_Destacking " +
                        //" where RowStatus>-1 group by ItemID,PlantiD,TglProduksi ), " +
                        //" LP_2 as (select B.PartNo,PlantID,ThnBln from LP_1 A inner join FC_Items B ON A.ItemID=B.ID), " +
                        //" LP_3 as ( select PartnoAsal,isnull((sum(M3)) ,0) M3  from (  select PartnoAsal,isnull((sum(M3)),0) M3 " +
                        //" from (  select PartnoAsal,Qty,(((Tebal*Lebar*Panjang)/1000000000)*Qty)  M3  " +
                        //" from (  select PartnoAsal,sum(Qty)Qty,Tebal,Lebar,Panjang  from (  select x.PartNo PartnoAsal,x2.Tebal,x2.Lebar,x2.Panjang,x.Qty " +
                        //" from (  select sum(Qty)Qty,ItemID,Keterangan Partno from vw_KartuStockBJNew  where sfrom='straping' " +
                        //" and left(convert(char,tanggal,112),6)=left(convert(char,@thnbln1,112),6) and ItemID in " +
                        //" (select ID from FC_Items where PartNo like'%-M-%' or PartNo like'%-3-%')  group by ItemID,Keterangan ) as x " +
                        //" inner join FC_Items x2 ON x.ItemID=x2.ID) as A group by PartnoAsal,Tebal,Lebar,Panjang ) as xx ) as xx1 " +
                        //" group by PartnoAsal   ) as DataFinall group by PartnoAsal) ,  " +

                        //" LP_40 as (select *,(select top 1 A1.ThnBln from LP_2 A1 " +
                        //" where A1.PartNo=A.PartnoAsal and A1.ThnBln<=left(convert(char,@thnbln1,112),6) order by A1.ThnBln desc)ThnBln from LP_3 A), " +

                        //" LP_4 as (select PartnoAsal,sum(M3)M3,ThnBln,PlantID from (select A.*,B.PlantID from LP_40 A " +
                        //" left join LP_2 B ON A.PartnoAsal=B.PartNo and A.ThnBln=B.ThnBln ) as x group by PartnoAsal,ThnBln,PlantID), " +

                        //" LP_04 as (select *,(select top 1 A1.Line from Def_UKhususProsen A1 " +
                        //" where A1.Partno=A.PartnoAsal and A1.Periode=left(convert(char,@thnbln1,112),6))PlantID2 from LP_4 A ), " +

                        //" LP_5 as (select PartnoAsal,M3,ThnBln,PlantID from (select PartnoAsal,M3,A.ThnBln, " +
                        //" case when A.PlantID2 is null then B.PlantID else A.PlantID2 end PlantID from LP_04 A " +
                        //" left join LP_2 B ON A.PartnoAsal=B.PartNo and A.ThnBln=B.ThnBln ) as x group by PartnoAsal,ThnBln,PlantID,M3), " +

                        //" LP_05 as (select PartnoAsal,M3,PlantID,(select count(PartnoAsal) from LP_5 A where A.PartnoAsal=LP_5.PartnoAsal)ttl " +
                        //" from LP_5 group by PartnoAsal,M3,PlantID) , " +
                        //" LP_06 as (select PartnoAsal,case when ttl=1 then m3 when ttl>1 then m3/ttl end m3,PlantID from LP_05 " +
                        //" group by PlantID,m3,ttl,PartnoAsal)  , " +
                        //" LP_006 as (select sum(m3)M3,PlantID  from LP_06 group by PlantID) " +

                        //" select sum(M3) M3,PlantID into tempTtlOK_LP from LP_006  group by PlantID  " +

                        /** Total Potong BP ListPlank **/
                        " select sum(M3)M3,PlantID into tempTotalPotong_BP_LP from ( " +
                        " select * from tempTtlBP_LP union all " +
                        " select * from tempTtlOK_LP union all " +
                        " select * from tempTtl_LP ) as x group by PlantID " +

                        /** Total Potong ListPlank **/
                        " select sum(M3)M3,PlantID into tempTotalPotong_LP from ( " +
                        " select * from tempTotalPotong_BP_LP union all " +
                        " select * from tempTtl_LP ) as x group by PlantID " +

                        /** Total Potong ListPlank dan Ukuran Khusus  **/
                        " set @TotPot_LP_UKhusus=isnull(cast(( select sum(M3) from ( " +
                        " select sum(M3)M3 from tempTotalPotong_UkuranKhusus " +
                        " union all " +
                        " select sum(M3)M3 from tempDefect_ListPlank_detail " +
                        " union all " +
                        " select sum(M3)M3 from tempTtlOK_LP " +
                        " ) as x)as decimal(18,2)),0) " +

                        " select [Group] into tempGroup_LPUK from ( " +
                        " select [Group] from tempDefect_UkuranKhusus_detail where M3>0 or M3<0 union all " +
                        " select [Group] from tempDefect_ListPlank_detail where M3>0 or M3<0 ) as x group by [Group] " +

                        " set @TotGroup_LP_UKhusus=(select count([Group]) from tempGroup_LPUK) " +
                        //" select [Group],sum(M3) M3 into tempTotalPot_LP_UkuranKhusus from ( " +
                        //" select [Group],cast(@TotPot_LP_UKhusus as decimal(18,5))/cast(@TotGroup_LP_UKhusus as decimal(18,5))M3 from tempGroup_LPUK A " +
                        //" union all " +
                        //" select [Group],cast('0' as decimal(18,0))M3 from tempData_Group) as x group by [Group] " +

                        /** Baru **/
                        //" select [Group],sum(M3) M3 into tempTotalPot_LP_UkuranKhusus from ( "+
                        //" select [Group],cast(@TotPot_LP_UKhusus as decimal(18,5))/cast(@Tot_GP as decimal(18,5))M3 from tempGroup3 A "+
                        //" union all "+
                        //" select [Group],cast('0' as decimal(18,0))M3 from tempGroup3) as x group by [Group] "+

                        " select [Group],sum(M3) M3 into tempTotalPot_LP_UkuranKhusus from ( " +
                        " select [Group],nullif(cast(@TotPot_LP_UKhusus as decimal(18,5)),0)/nullif(cast(@TotGroup_LP_UKhusus as decimal(18,5)),0)M3 from tempGroup_LPUK A " +
                        " union all " +
                        " select [Group],cast('0' as decimal(18,0))M3 from tempData_Group) as x group by [Group] " +

                        /** Total Potong ListPlank Detail Per Group **/
                        " select case when PlantID=1 then 'Line 1'  when PlantID=2 then 'Line 2' when PlantID=3 then 'Line 3' " +
                        " when PlantID=4 then 'Line 4'  when PlantID=5 then 'Line 5' when PlantID=6 then 'Line 6' end Line, " +
                        " case when PlantID=1 then 'CA,CB,CC,CD' when PlantID=2 then 'CE,CF,CG,CH' when PlantID=3 then 'CI,CJ,CK,CL'  " +
                        " when PlantID=4 then 'CM,CN,CO,CP' when PlantID=5 then 'CQ,CR,CS,CT' when PlantID=6 then 'CU,CV,CW,CX' end [Group],M3 into tempGroup from tempTtlOK_LP   " +

                        " SELECT A.[Line],Split.a.value('.', 'VARCHAR(100)') AS [Group],(M3/4) M3 into tempGroup2   " +
                        " FROM (SELECT [Line],CAST ('<M>' + REPLACE([Group],',', '</M><M>') + '</M>' AS XML) AS String,M3 FROM tempGroup) AS A CROSS APPLY String.nodes ('/M') AS Split(a);  " +

                        /** Accounting Report Mutasi WiP : Pengeluaran B99 **/
                        " set @OutBP_WiP = (  select cast((sum(M3)) as decimal(18,2))BP_M3  from (  select sum(Qty)Qty,sum(M3)M3 from (  select *,cast(((Qty*Volume)) as decimal(18,5))M3 from (  select sum(A.qty *-1) Qty,(B.Tebal*B.Lebar*B.Panjang)/1000000000 Volume from vw_KartustockWIP A   inner join FC_Items B ON A.itemid0=B.ID  where qty<0   and lokasi='B99' and process<>'lari' and process<>'listplank' and left(convert(char,tanggal,112),8)>=@thnbln1 and  left(convert(char,tanggal,112),8)<=@thnbln2   group by tebal,lebar,panjang ) as x ) as x1    " +
                        " union all   " +
                        " select sum(Qty)Qty,sum(M3)M3 from (  select *,cast(((Qty*Volume)) as decimal(18,5))M3 from (  select isnull(SUM(qty)*-1,0)Qty,(I2.Tebal*I2.Lebar*I2.Panjang)/1000000000 Volume from vw_KartustockWIP2 V   inner join FC_Items I on V.itemID=I.ID inner join FC_Items I2 on I2.ID=V.itemid0 and (I.partno  like '%-p-%'  )  where qty<0  and idrec not like '%ou%'    and process='lari'and lokid1 not in (select ID from fc_lokasi where lokasi='I99') and  left(convert(char,tanggal,112),8)>=@thnbln1 and left(convert(char,tanggal,112),8)<=@thnbln2  group by I2.tebal,I2.lebar,I2.panjang) as x ) as x1 ) as xx ) " +

                        " select [Group],cast((M3) as decimal(18,2))M3 into tempDefect_BM_detail0 from (select [Group],cast(m3 as decimal(18,1))M3,DefName from ( " +
                        " select [Group],cast(m3 as decimal(18,2))M3,DefName from ( " +
                        " select [Group],sum(Kubik)M3,DefName  from (  " +
                        " select * from tempDefect_BM " +
                        " ) as x group by [Group],DefName " +
                        " ) as xx " +
                        " ) as xxx ) as xxxx " +

                        /** Total : Defect System BM **/
                        " set @Total_tempDefect_BM_detail = isnull((select M3 from (select cast((sum(M3)) as decimal(18,1))M3 from tempDefect_BM_detail0) as x),1)   " +
                        /** Total : Defect System Finishing **/
                        " set @Total_tempDefect_Fin_detail = (select M3 from (select cast((sum(Kubik)) as decimal(18,1))M3 from tempDefect_Fin) as x)  " +
                        /** Total : Selisih Total Defect **/
                        " set @Selisih_ttl_defect = (select @OutBP_WiP - cast((@Total_tempDefect_BM_detail) as decimal(18,1)) - cast((@Total_tempDefect_Fin_detail) as decimal(18,2)))  " +

                        " select [Group],cast(sum(M3) as decimal(18,1))M3 into tempDefect_BM_detail from (select  * from tempData_Group union all select [Group],m3  from tempDefect_BM_detail0 ) as x group by [Group] order by [Group] " +
                        " select [Group],((M3/@Total_tempDefect_BM_detail)*@Selisih_ttl_defect)  M3 into Selisih_ttl_defect_Detail from tempDefect_BM_detail order by [group]  " +
                        " select [Group],(((M3/@Total_tempDefect_BM_detail)*@Total_tempDefect_Fin_detail)) M3 into tempDefect_Fin_detail from tempDefect_BM_detail  " +

                        /** Defect BM dan Finishing **/
                        " select [Group],sum(M3)M3 into tempDefect_BM_FN_detail from ( " +
                        " select [Group],M3 from tempDefect_BM_detail union all " +
                        " select [Group],M3 from tempDefect_Fin_detail union all " +
                        " select [Group],M3 from Selisih_ttl_defect_Detail ) as x group by [Group] " +

                        /** Defect Produksi **/
                        " select [Group],sum(M3)M3 into tempDefect_Produksi_detail from ( " +
                        " select * from tempDefect_UkuranKhusus_detail union all " +
                        " select * from tempDefect_ListPlank_detail union all " +
                        " select * from tempDefect_BM_FN_detail ) as x group by [Group] " +

                        /** BS Tahap 1 **/
                        " select distinct itemid into tempMasterDataBSauto from vw_KartuStockBJNew where itemid in (select ID from fc_items where partno like '%-s-%') and LokID in (select ID from FC_Lokasi where Lokasi='bsauto')  " +
                        " ;with BSTahap as (select distinct itemid from vw_KartuStockBJNew where itemid in (select ID from fc_items where partno like '%-s-%') and  LokID in (select ID from FC_Lokasi where Lokasi='bsauto')  ),  " +
                        " BSTahap1 as (select * from vw_KartuStockBJNew where left(CONVERT(char, tanggal ,112),6)=left(convert(char,@thnbln1,112),6) and itemID in   (select itemid from tempMasterDataBSauto)),  BSTahap2 as (select * from vw_KartuStockBJNew where left(CONVERT(char, tanggal ,112),6)=left(convert(char,@thnbln1,112),6) and itemID not in   (select itemid from tempMasterDataBSauto) ),  " +
                        " BSTahap3 as (select isnull(sum(Qty),0)Qty,isnull(sum(Qty*Volume),0)M3  from (  select x.qty Qty,((x1.Tebal*x1.Lebar*x1.Panjang)/1000000000)Volume from (  select Qty,ItemID from BSTahap1 where (process='direct' or process like'%Simetris%') and (isnull(sfrom,'-')='-' or isnull(sfrom,'bevel')='-'  or isnull(sfrom,'-')='straping') and lokid in (select ID from FC_Lokasi where Lokasi='BSAUTO') and substring(Keterangan,1,21) like '%-1-%'  and left(convert(char,tanggal,112),6)=left(convert(char,@thnbln1,112),6) and PartNo  like'%-S-%') as x inner join FC_Items x1 ON x.ItemID=x1.ID ) as A  ),   " +
                        " BSTahap4 as (select isnull(sum(Qty),0)Qty,isnull(sum(Qty*Volume),0)M3 from (  select x.qty Qty,((x1.Tebal*x1.Lebar*x1.Panjang)/1000000000)Volume from (  select Qty,ItemID from BSTahap2 where (process='direct' or process like'%Simetris%') and (isnull(sfrom,'-')='-' or isnull(sfrom,'bevel')='-'  or isnull(sfrom,'-')='straping') and lokid not in (select ID from FC_Lokasi where Lokasi='BSAUTO') and substring(Keterangan,1,21) like '%-1-%'  and left(convert(char,tanggal,112),6)=left(convert(char,@thnbln1,112),6) and PartNo  like'%-S-%') as x inner join FC_Items x1 ON x.ItemID=x1.ID ) as A ),  " +
                        " BSTahap5 as (select isnull(sum(M3) ,0) M3 from (select M3 from BSTahap3 union all select M3 from BSTahap4) as x ) " +
                        " select * into tempBS_Tahap1 from BSTahap5  " +

                        /** Total : BS Tahap 1 **/
                        " set @TtlBS_Tahap1 = cast(isnull((select M3 from tempBS_Tahap1),0) as decimal(18,2)) " +

                        /** Total : Defect Finishing + BM **/
                        " set @Total_Defect_BMFin = ( @Total_tempDefect_BM_detail + @Total_tempDefect_Fin_detail + @Selisih_ttl_defect ) " +
                        /** Total Defect Ukuran Khusus **/
                        " set @Total_Defect_UkuranKhusus = (select M3 from (select cast((sum(M3)) as decimal(18,2))M3 from tempDefect_UkuranKhusus_detail) as x) " +
                        /** Total Defect ListPlank **/
                        " set @Total_Defect_ListPlank = (select M3 from (select cast((sum(M3)) as decimal(18,1))M3 from tempDefect_ListPlank_detail) as x) " +
                        /** Total Defect Produksi **/
                        " set @Total_DefectProduksi = cast((@Total_Defect_BMFin + @Total_Defect_UkuranKhusus + @Total_Defect_ListPlank) as decimal(18,0))  " +

                        " select [Group],((M3/@Total_tempDefect_BM_detail)* @TtlBS_Tahap1)  M3 into tempBS_Tahap1_detail from tempDefect_BM_detail order by [group]  " +

                        /** Total Defect **/
                        " select [Group],sum(M3) M3 into tempTotalDefect_detail from ( " +
                        " select * from tempDefect_BM_detail union all " +
                        " select * from tempDefect_Fin_detail union all " +
                        " select * from tempDefect_UkuranKhusus_detail union all " +
                        " select * from tempDefect_ListPlank_detail union all " +
                        " select * from tempBS_Tahap1_detail ) as x group by [Group] " +

                        /** Total Defect Proposionet **/
                        " select  [Group],sum(M3) M3 into tempTotalDefect_Pro_detail from ( " +
                        " select * from tempDefect_ListPlank_detail union all " +
                        " select * from tempDefect_UkuranKhusus_detail union all " +
                        " select * from tempDefect_BM_FN_detail union all " +
                        " select * from tempBS_Tahap1_detail ) as x group by [Group] " +

                        /** Total Potong System QA **/
                        " select  B.[Group],cast((sum(TPotongM3)) as decimal(18,1))M3 into tempTotalPot_QA from BM_Destacking A left join BM_PlantGroup B on A.PlantGroupID=B.ID  inner join (  select C.ID DestID , A.TPotong qtyin,A.TPotong*I.Volume as kubik,A.TPotong*I.Volume TPotongM3 from Def_Defect A   inner join BM_Destacking C on A.DestID=C.ID left join FC_Items I on I.ID=C.ItemID where A.Status>-1 and CONVERT(char,A.tgl,112)>=@thnbln1 and  CONVERT(char,A.tgl,112)<=@thnbln2 ) as C  on A.ID=C.DestID group by B.[Group] ;  " +

                        /** Total Potong System ListPlank Detail per Group**/
                        " select  [Group],sum(M3)M3 into tempTotalPot_SystemLP from ( " +
                        " select * from tempTotalPot_LP_UkuranKhusus union all " +
                        " select * from tempTotalPot_QA ) as x group by [Group] " +

                        ///** Total Potong System All **/
                        //" set @TtlPot_All=cast((select sum(M3)M3 from ( " +
                        //    /** AccReport WIP Out BP, OK, KM **/
                        //" select cast(sum(M3) as decimal(18,1))M3  from (  select sum(Qty)Qty,sum(M3)M3 from (  select *,round((Qty*Volume),2)M3 from (  select sum(A.qty *-1) Qty,(B.Tebal*B.Lebar*B.Panjang)/1000000000 Volume from vw_KartustockWIP A   inner join FC_Items B ON A.itemid0=B.ID  where qty<0   and lokasi in ('H99','B99') and process<>'lari' and process<>'listplank' and left(convert(char,tanggal,112),8)>=@thnbln1  and left(convert(char,tanggal,112),8)<=@thnbln2   group by tebal,lebar,panjang ) as x ) as x1   " +
                        //" union all   " +
                        //" select sum(Qty)Qty,sum(M3)M3 from (  select *,round((Qty*Volume),2)M3 from (  select isnull(SUM(qty)*-1,0)Qty,(I.Tebal*I.Lebar*I.Panjang)/1000000000 Volume from vw_KartustockWIP2 V   inner join FC_Items I on V.itemID=I.ID and (I.partno  like '%-3-%' or I.partno  like '%-M-%' or I.partno  like '%-P-%')     where qty<0  and idrec not like '%ou%'    and process='lari'and lokid1 not in (select ID from fc_lokasi where lokasi='I99') and  left(convert(char,tanggal,112),8)>=@thnbln1 and left(convert(char,tanggal,112),8)<=@thnbln2  group by tebal,lebar,panjang) as x ) as x1 ) as xx  " +
                        //" union all " +
                        //    /** Defect Ukuran Khusus - AccRepot BJ Tahap 1 Out BP, OK, KM **/
                        //" select cast(sum(M3) as decimal(18,1))M from ( " +
                        //" select SUBSTRING(x.partno,1,9)Part,x.PartNo,x.PartnoAsal,x.Qty,((A.Tebal*A.Lebar*A.Panjang)/1000000000)*x.Qty M3 from (   select REPLACE(substring(Keterangan,0,18),'-P-','-1-')Partno,PartNo PartnoAsal,ItemID,isnull(SUM(Qty),0)  * -1 Qty from vw_KartuStockBJNew  where qty <0 and (process  like '%simetris%' ) and  (Keterangan like '%-3-%' or Keterangan like '%-w-%' or  Keterangan like '%-m-%' or Keterangan like '%-P-%') and  LokID not In (select ID from FC_Lokasi where lokasi='q99')   and left(convert(char,tanggal,112),8)>=@thnbln1 and  left(convert(char,tanggal,112),8)<=@thnbln2 and ItemID in (select ID  from FC_Items where PartNo like'%-1-%') group by ItemID,Keterangan,PartNo   ) as x  inner join FC_Items A ON A.ID=x.ItemID ) as x " +
                        //" union all " +
                        //" select cast(sum(M3) as decimal(18,1))M3 from ( " +
                        //    /** Defect LP OK **/
                        //" select isnull(cast((sum(M3)) as decimal(18,1)),0) M3  from (    " +
                        //" select PartnoAsal,isnull(cast((sum(M3)) as decimal(18,5)),0) M3 from (  select PartnoAsal,Qty,cast((((Tebal*Lebar*Panjang)/1000000000)*Qty) as decimal(18,5)) M3  from (  select PartnoAsal,sum(Qty)Qty,Tebal,Lebar,Panjang  from (  select x.PartNo PartnoAsal,x2.Tebal,x2.Lebar,x2.Panjang,x.Qty from (  select sum(Qty)Qty,ItemID,Keterangan Partno from vw_KartuStockBJNew  where sfrom='straping' and left(convert(char,tanggal,112),6)=left(convert(char,@thnbln1,112),6) and ItemID in  (select ID from FC_Items where PartNo like'%-M-%' or PartNo like'%-3-%')  group by ItemID,Keterangan ) as x   inner join FC_Items x2 ON x.ItemID=x2.ID) as A group by PartnoAsal,Tebal,Lebar,Panjang ) as xx ) as xx1 group by PartnoAsal  ) as z  " +
                        //" union all " +
                        //    /** Defect LP BP **/
                        //" select sum(M3)M3 from tempTotalPotong_BP_LP ) as x " +
                        //" union all " +
                        //    /** BS Tahap 1 : AccReport BS Normal dan BS Auto in WiP T1 **/
                        //" select M3 from tempBS_Tahap1 " +
                        //" ) as xx ) as decimal(18,1)) " +

                        /** Total Potong Semua **/
                        /** Defect System OK+BP **/
                        " set @TtlPot_All=isnull((select cast(sum(M3) as decimal(18,2))M3 from ( " +
                        " select sum(M3)M3 from ( " +
                        /** Out B99 Mutasi WiP **/
                        " select cast(@OutBP_WiP as decimal(18,5)) M3 " +
                        " union all " +
                        /** Out OK Mutasi WiP **/
                        " select sum(M3)M3 from ( " +
                        " select sum(Qty)Qty,sum(Qty*Volume) M3 from ( " +
                        " select isnull(SUM(qty)*-1,0)Qty,((B.Tebal*B.Lebar*B.Panjang)/1000000000)Volume from vw_KartustockWIP A " +
                        " inner join FC_Items B ON A.itemid0=B.ID where qty<0 and (lokasi='H99' and process<>'lari' and process<>'listplank') and " +
                        " left(convert(char,tanggal,112),6)=left(convert(char,@thnbln1,112),6) group by B.Tebal,B.Lebar,B.Panjang ) as x " +
                        " union all " +
                        " select sum(Qty)Qty,sum(Qty*Volume) M3 from ( " +
                        " select isnull(SUM(qty)*-1,0)Qty,((I2.Tebal*I2.Lebar*I2.Panjang)/1000000000)Volume from vw_KartustockWIP2 V " +
                        " inner join FC_Items I on V.itemID=I.ID and (I.partno like '%-3-%' or I.PartNo like '%-W-%' or I.PartNo like '%-m-%')  " +
                        " inner join FC_Items I2 ON I2.ID=V.itemid0  " +
                        " where qty<0  and idrec not like '%ou%'   and process='lari' and left(convert(char,tanggal,112),6)=left(convert(char,@thnbln1,112),6) " +
                        " group by I2.Tebal,I2.Lebar,I2.Panjang ) as x " +
                        " ) as xx ) as xx " +
                        " union all " +
                        /** Defect Ukuran Khusus OK + BP	**/
                        " select sum(M3)M3 from ( " +
                        " select SUBSTRING(x.partno,1,9)Part,x.PartNo,x.PartnoAsal,x.Qty,((A.Tebal*A.Lebar*A.Panjang)/1000000000)*x.Qty M3 from (   select REPLACE(substring(Keterangan,0,18),'-P-','-1-')Partno,PartNo PartnoAsal,ItemID,isnull(SUM(Qty),0)  * -1 Qty from vw_KartuStockBJNew  where qty <0 and (process  like '%simetris%' ) and  (Keterangan like '%-3-%' or Keterangan like '%-w-%' or  Keterangan like '%-m-%' or Keterangan like '%-P-%') and  LokID not In (select ID from FC_Lokasi where lokasi='q99')   and left(convert(char,tanggal,112),8)>=@thnbln1 and  left(convert(char,tanggal,112),8)<=@thnbln2 and ItemID in (select ID  from FC_Items where PartNo like'%-1-%') group by ItemID,Keterangan,PartNo   ) as x  inner join FC_Items A ON A.ID=x.ItemID ) as x " +
                        " union all    " +
                        " select @Total_Defect_ListPlank  /** Defect LP BP **/ " +
                        " union all  " +
                        " select M3 from tempTtlOK_LP  /** Defect LP OK **/ " +
                        " union all " +
                        " select @TtlBS_Tahap1  /** BS Tahap 1 **/ " +
                        " ) as AA),0) " +

                        " set @Selisih_TotPot=isnull(cast((select sum(M3) M3 from ( " +
                        " select cast(sum(M3) as decimal(18,2))* -1 M3 from tempTotalPot_SystemLP union all " +
                        " select cast(@TtlPot_All as decimal(18,2))  M3  " +
                        " ) as x)as decimal(18,5)),0) " +

                        //" select [Group],sum(M3) M3 into tempSelisih_TotPot from ( " +
                        //" select [Group],cast(@Selisih_TotPot as decimal(18,5))/cast(@TotGroup_LP_UKhusus as decimal(18,5))M3 from tempGroup_LPUK A " +
                        //" union all " +
                        //" select [Group],cast('0' as decimal(18,0))M3 from tempData_Group) as x group by [Group] " +

                        /** Baru **/
                        " select [Group],sum(M3) M3 into tempSelisih_TotPot from ( " +
                        " select [Group],nullif(cast(@Selisih_TotPot as decimal(18,5)),0)/nullif(cast(@Tot_GP as decimal(18,5)),0)M3 from tempGroup3 A " +
                        " union all " +
                        " select [Group],cast('0' as decimal(18,0))M3 from tempGroup3) as x group by [Group] " +


                        /** Total Potong Proposionet **/
                        " select [Group],sum(M3)M3 into tempTotPot_Proposionet from ( " +
                        " select * from tempSelisih_TotPot union all " +
                        " select * from tempTotalPot_SystemLP ) as x group by [Group] " +

                        " select [Group],((M3/@Total_tempDefect_BM_detail)*@Tot_OKKM)  M3 into temp_OKKM from tempDefect_BM_detail order by [group]  " +
                        " select [Group],((M3/@Total_tempDefect_BM_detail)*@Tot_Retur)  M3 into temp_Retur from tempDefect_BM_detail order by [group]  " +
                        " select [Group],((M3/@Total_tempDefect_BM_detail)*@Tot_Sortir)  M3 into temp_Sortir from tempDefect_BM_detail order by [group] " +

                        " select [Group],sum(M3)M3 into temp_TotalDefect from ( " +
                        " select [Group],M3 from tempTotalDefect_Pro_detail union all " +
                        " select [Group],M3 from temp_Retur union all " +
                        " select [Group],M3 from temp_Sortir union all " +
                        " select [Group],M3*-1 from temp_OKKM ) as x group by [Group] " +

                        " select [Group],M3 * 100 M3 into temp_Persen from ( " +
                        " select [Group],isnull(M3/(select NULLIF(M3,0) from tempTotPot_Proposionet A where A.[Group]=B.[Group]),0) M3  from temp_TotalDefect B ) as x " +

                        /** Kumpulkan semua data **/
                        " select [Group],sum(M3) DefectBM_M3,sum(B)DefectFin_M3,sum(C)Selisih_Ttl_Ptg,sum(D)Defect_BMFIN,sum(E)Defect_UKhusus,sum(F)Defect_ListPlank,sum(G)Defect_Produksi,sum(H)BS_Tahap1,sum(T)Total_Defect0,sum(I)Total_Defect_Pro,sum(J)Total_Pot_SystemQA,sum(K)Total_Pot_LP_UK,sum(L)Total_Pot_SystemLP,sum(M)Selisih_TotPot,sum(N)TotPot_Proposionet,sum(O)OK_KM,sum(P)Retur,sum(Q)Sortir,sum(R)Total_Defect,sum(S)Persen into temp_Total " +
                        " from ( " +
                        " select [Group],M3,'0'B,'0'C,'0'D,'0'E,'0'F,'0'G,'0'H,'0'I,'0'J,'0'K,'0'L,'0'M,'0'N,'0'O,'0'P,'0'Q,'0'R,'0'S,'0'T from tempDefect_BM_detail " +
                        " union all " +
                        " select [Group],'0'A,M3,'0'C,'0'D,'0'E,'0'F,'0'G,'0'H,'0'I,'0'J,'0'K,'0'L,'0'M,'0'N,'0'O,'0'P,'0'Q,'0'R,'0'S,'0'T from tempDefect_Fin_detail " +
                        " union all " +
                        " select [Group],'0'A,'0'B,M3,'0'D,'0'E,'0'F,'0'G,'0'H,'0'I,'0'J,'0'K,'0'L,'0'M,'0'N,'0'O,'0'P,'0'Q,'0'R,'0'S,'0'T from Selisih_ttl_defect_Detail " +
                        " union all " +
                        " select [Group],'0'A,'0'B,'0'C,M3,'0'E,'0'F,'0'G,'0'H,'0'I,'0'J,'0'K,'0'L,'0'M,'0'N,'0'O,'0'P,'0'Q,'0'R,'0'S,'0'T from tempDefect_BM_FN_detail  " +
                        " union all " +
                        " select [Group],'0'A,'0'B,'0'C,'0'D,M3,'0'F,'0'G,'0'H,'0'I,'0'J,'0'K,'0'L,'0'M,'0'N,'0'O,'0'P,'0'Q,'0'R,'0'S,'0'T from tempDefect_UkuranKhusus_detail  " +
                        " union all " +
                        " select [Group],'0'A,'0'B,'0'C,'0'D,'0'E,M3,'0'G,'0'H,'0'I,'0'J,'0'K,'0'L,'0'M,'0'N,'0'O,'0'P,'0'Q,'0'R,'0'S,'0'T from tempDefect_ListPlank_detail " +
                        " union all " +
                        " select [Group],'0'A,'0'B,'0'C,'0'D,'0'E,'0'F,M3,'0'H,'0'I,'0'J,'0'K,'0'L,'0'M,'0'N,'0'O,'0'P,'0'Q,'0'R,'0'S,'0'T from tempDefect_Produksi_detail " +
                        " union all " +
                        " select [Group],'0'A,'0'B,'0'C,'0'D,'0'E,'0'F,'0'G,M3,'0'I,'0'J,'0'K,'0'L,'0'M,'0'N,'0'O,'0'P,'0'Q,'0'R,'0'S,'0'T from tempBS_Tahap1_detail " +
                        " union all " +
                        " select [Group],'0'A,'0'B,'0'C,'0'D,'0'E,'0'F,'0'G,'0'H,M3,'0'J,'0'K,'0'L,'0'M,'0'N,'0'O,'0'P,'0'Q,'0'R,'0'S,'0'T from tempTotalDefect_Pro_detail " +
                        " union all " +
                        " select [Group],'0'A,'0'B,'0'C,'0'D,'0'E,'0'F,'0'G,'0'H,'0'I,M3,'0'K,'0'L,'0'M,'0'N,'0'O,'0'P,'0'Q,'0'R,'0'S,'0'T from tempTotalPot_QA " +
                        " union all " +
                        " select [Group],'0'A,'0'B,'0'C,'0'D,'0'E,'0'F,'0'G,'0'H,'0'I,'0'J,M3,'0'L,'0'M,'0'N,'0'O,'0'P,'0'Q,'0'R,'0'S,'0'T from tempTotalPot_LP_UkuranKhusus " +
                        " union all " +
                        " select [Group],'0'A,'0'B,'0'C,'0'D,'0'E,'0'F,'0'G,'0'H,'0'I,'0'J,'0'K,M3,'0'M,'0'N,'0'O,'0'P,'0'Q,'0'R,'0'S,'0'T from tempTotalPot_SystemLP " +
                        " union all " +
                        " select [Group],'0'A,'0'B,'0'C,'0'D,'0'E,'0'F,'0'G,'0'H,'0'I,'0'J,'0'K,'0'L,M3,'0'N,'0'O,'0'P,'0'Q,'0'R,'0'S,'0'T from tempSelisih_TotPot " +
                        " union all " +
                        " select [Group],'0'A,'0'B,'0'C,'0'D,'0'E,'0'F,'0'G,'0'H,'0'I,'0'J,'0'K,'0'L,'0'M,M3,'0'O,'0'P,'0'Q,'0'R,'0'S,'0'T from tempTotPot_Proposionet " +
                        " union all " +
                        " select [Group],'0'A,'0'B,'0'C,'0'D,'0'E,'0'F,'0'G,'0'H,'0'I,'0'J,'0'K,'0'L,'0'M,'0'N,M3,'0'P,'0'Q,'0'R,'0'S,'0'T from temp_OKKM " +
                        " union all " +
                        " select [Group],'0'A,'0'B,'0'C,'0'D,'0'E,'0'F,'0'G,'0'H,'0'I,'0'J,'0'K,'0'L,'0'M,'0'N,'0'O,M3,'0'Q,'0'R,'0'S,'0'T from temp_Retur " +
                        " union all " +
                        " select [Group],'0'A,'0'B,'0'C,'0'D,'0'E,'0'F,'0'G,'0'H,'0'I,'0'J,'0'K,'0'L,'0'M,'0'N,'0'O,'0'P,M3,'0'R,'0'S,'0'T from temp_Sortir " +
                        " union all " +
                        " select [Group],'0'A,'0'B,'0'C,'0'D,'0'E,'0'F,'0'G,'0'H,'0'I,'0'J,'0'K,'0'L,'0'M,'0'N,'0'O,'0'P,'0'Q,M3,'0'S,'0'T from temp_TotalDefect " +
                        " union all " +
                        " select [Group],'0'A,'0'B,'0'C,'0'D,'0'E,'0'F,'0'G,'0'H,'0'I,'0'J,'0'K,'0'L,'0'M,'0'N,'0'O,'0'P,'0'Q,'0'R,M3,'0'T from temp_Persen " +
                        " union all" +
                        " select [Group],'0'A,'0'B,'0'C,'0'D,'0'E,'0'F,'0'G,'0'H,'0'I,'0'J,'0'K,'0'L,'0'M,'0'N,'0'O,'0'P,'0'Q,'0'R,'0'S,M3 from tempTotalDefect_detail " +
                        " ) as x group by [Group] order by [Group] " +

                        " select * into temp_DataDefectISO from ( " +
                        " select [Group],cast((DefectBM_M3) as decimal(18,1))DefectBM_M3,cast((DefectFin_M3)as decimal(18,1))DefectFin_M3,cast((Selisih_Ttl_Ptg)as decimal(18,1))Selisih_Ttl_Ptg,cast((Defect_BMFIN)as decimal(18,1))Defect_BMFIN,cast((Defect_UKhusus)as decimal(18,1))Defect_UKhusus,cast((Defect_ListPlank)as decimal(18,1))Defect_ListPlank,cast((Defect_Produksi)as decimal(18,1))Defect_Produksi,cast((BS_Tahap1)as decimal(18,1))BS_Tahap1,cast((Total_Defect0)as decimal(18,1))Total_Defect0,cast((Total_Defect_Pro)as decimal(18,1))Total_Defect_Pro,cast((Total_Pot_SystemQA)as decimal(18,1))Total_Pot_SystemQA,cast((Total_Pot_LP_UK)as decimal(18,1))Total_Pot_LP_UK,cast((Total_Pot_SystemLP)as decimal(18,1))Total_Pot_SystemLP,cast((Selisih_TotPot)as decimal(18,1))Selisih_TotPot,cast((TotPot_Proposionet)as decimal(18,1))TotPot_Proposionet,cast((OK_KM)as decimal(18,1))OK_KM,cast((Retur)as decimal(18,1))Retur,cast((Sortir)as decimal(18,1))Sortir,cast((Total_Defect)as decimal(18,1))Total_Defect,isnull(cast(((Total_Defect)/(nullif(TotPot_Proposionet,0)))*100 as decimal(18,1)),0)Persentase from temp_Total " +
                        " union all " +
                        " select 'Total'Total,cast(sum(DefectBM_M3) as decimal(18,1)),cast(sum(DefectFin_M3)as decimal(18,1)),cast(sum(Selisih_Ttl_Ptg)as decimal(18,1)),cast(sum(Defect_BMFIN)as decimal(18,1)),cast(sum(Defect_UKhusus)as decimal(18,1)),cast(sum(Defect_ListPlank)as decimal(18,1)),cast(sum(Defect_Produksi)as decimal(18,1)),cast(sum(BS_Tahap1)as decimal(18,1)),cast(sum(Total_Defect0)as decimal(18,1)),cast(sum(Total_Defect_Pro)as decimal(18,1)),cast(sum(Total_Pot_SystemQA)as decimal(18,1)),cast(sum(Total_Pot_LP_UK)as decimal(18,1)),cast(sum(Total_Pot_SystemLP)as decimal(18,1)),cast(sum(Selisih_TotPot)as decimal(18,1)),cast(sum(TotPot_Proposionet)as decimal(18,1)),cast(sum(OK_KM)as decimal(18,1)),cast(sum(Retur)as decimal(18,1)),cast(sum(Sortir)as decimal(18,1)),cast(sum(Total_Defect)as decimal(18,1)),cast((sum(Total_Defect)/sum(TotPot_Proposionet))*100 as decimal(18,1)) from temp_Total " +
                        " ) as x " +

                        #endregion
                        #region Temp Table2
                        #region Line - 1
                    " declare @TotalPotong decimal(18,2) " +
                        " declare @TotalDefKhusus decimal(18,2)   " +
                        " declare @DefKhusus decimal(18,2)   " +
                        " declare @Ttotalkw1kw2 decimal(18,2)  " +
                        " declare @NCSortir decimal(18,2)   " +
                        " declare @Retur decimal(18,2)  " +
                        " set @TotalPotong=isnull((select sum(totkubik ) from tempdefectGPIsoTot),0) " +

                        " declare @TotalPotongL1 decimal(18,2) " +
                        " declare @TotDefKhususL1 decimal(18,2)  " +
                        " declare @DefKhususL1 decimal(18,2)  " +
                        " declare @Ttotalkw1kw2L1 decimal(18,2)  " +
                        " declare @NCSortirL1 decimal(18,2)  " +
                        " declare @ReturL1 decimal(18,2)  " +
                        " declare @DefectFinL1 decimal(18,2) " +

                        //" set @TotalPotongL1=(select isnull(sum(totkubik ),0) from tempdefectGPIsoTot where [group]in (select [group] from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 1'))) " +
                        " set @TotalPotongL1=isnull((select sum(M3) from tempTotPot_Proposionet where [group]in (select [group] from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 1'))),0) " +
                        " set @TotDefKhususL1=(@TotalPotongL1/@TotalPotong)*@TotalDefKhusus " +
                        " set @DefKhususL1=(@TotalPotongL1/@TotalPotong)*@DefKhusus " +
                        " set @Ttotalkw1kw2L1=(@TotalPotongL1/@TotalPotong)*@Ttotalkw1kw2 " +
                        " set @NCSortirL1=(@TotalPotongL1/@TotalPotong)*@NCSortir " +
                        " set @ReturL1=(@TotalPotongL1/@TotalPotong)*@Retur " +
                        //" set @DefectFinL1=isnull((@TotalPotongL1/@TotalPotong)*@DefectFin,0) " +

                        " if @TotalPotongL1>0 " +
                        " begin " +
                        " select [Group],cast((b) as decimal(18,2))b,cast((c) as decimal(18,2))c,cast((d) as decimal(18,2))d,cast((e) as decimal(18,2))e,cast((f) as decimal(18,2))f,cast((g) as decimal(18,2))g,cast((i) as decimal(18,2))i,j into tempdefectL1 from ( " +
                        " select * from ( " +
                        " select [Group], " +
                        " case when @TotalPotongL1>0 then isnull((select cast((TotPot_Proposionet) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)  else 0 end b, " +
                        " case when @TotalPotongL1>0 then ((isnull((select cast((Defect_Produksi) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end c, " +
                        " case when @TotalPotongL1>0 then ((isnull((select cast((OK_KM) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0))) else 0 end  d,  " +
                        " case when @TotalPotongL1>0 then ((isnull((select cast((Sortir) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  e, " +
                        " case when @TotalPotongL1>0 then ((isnull((select cast((Retur) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  f, " +
                        " case when @TotalPotongL1>0 then ((isnull((select cast((BS_Tahap1) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end g,  " +
                        " case when @TotalPotongL1>0 then ((isnull((select cast((Total_Defect) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end i, " +
                        " case when @TotalPotongL1>0 then ((isnull((select cast((Persentase) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end j " +

                        " from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 1') )A " +

                        " union all  " +

                        " select 'Total' [Group],sum(b)b,sum(c)c,sum(d)d,sum(e)e,sum(f)f,sum(g)g,sum(i) i,(sum(nullif(i,0))/sum(b))*100 j" +
                        "  from( " +
                        " select [Group], " +
                        " case when @TotalPotongL1>0 then isnull((select cast((TotPot_Proposionet) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)  else 0 end b,  " +
                        " case when @TotalPotongL1>0 then ((isnull((select cast((Defect_Produksi) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end c,  " +
                        " case when @TotalPotongL1>0 then ((isnull((select cast((OK_KM) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0))) else 0 end  d, " +
                        " case when @TotalPotongL1>0 then ((isnull((select cast((Sortir) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  e,  " +
                        " case when @TotalPotongL1>0 then ((isnull((select cast((Retur) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  f,  " +
                        " case when @TotalPotongL1>0 then ((isnull((select cast((BS_Tahap1) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end g,  " +
                        " case when @TotalPotongL1>0 then ((isnull((select cast((Total_Defect) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end i, " +
                        " case when @TotalPotongL1>0 then ((isnull((select cast((Persentase) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end j " +
                        " from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 1'))A )B " +
                        " end " +
                        " else " +
                        " begin " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 i, 0 j into tempdefectL1 " +
                        " end " +
                        #endregion
                    " " +
                        #region Line - 2
                    " declare @TotalPotongL2 decimal(18,2) " +
                        " declare @TotDefKhususL2 decimal(18,2) " +
                        " declare @DefKhususL2 decimal(18,2) " +
                        " declare @Ttotalkw1kw2L2 decimal(18,2) " +
                        " declare @NCSortirL2 decimal(18,2) " +
                        " declare @ReturL2 decimal(18,2) " +
                        " declare @DefectFinL2 decimal(18,2) " +

                        //" set @TotalPotongL2=(select isnull(sum(totkubik ),0) from tempdefectGPIsoTot where [group]in (select [group] from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 2'))) " +
                        " set @TotalPotongL2=isnull((select sum(M3) from tempTotPot_Proposionet where [group]in (select [group] from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 2'))),0) " +
                        " set @TotDefKhususL2=(@TotalPotongL2/@TotalPotong)*@TotalDefKhusus " +
                        " set @DefKhususL2=(@TotalPotongL2/@TotalPotong)*@DefKhusus " +
                        " set @Ttotalkw1kw2L2=(@TotalPotongL2/@TotalPotong)*@Ttotalkw1kw2 " +
                        " set @NCSortirL2=(@TotalPotongL2/@TotalPotong)*@NCSortir " +
                        " set @ReturL2=(@TotalPotongL2/@TotalPotong)*@Retur " +
                        //" set @DefectFinL2=isnull((@TotalPotongL2/@TotalPotong)*@DefectFin,0) " +

                        " if @TotalPotongL2>0 " +
                        " begin " +
                        " select [Group],cast((b) as decimal(18,1))b,cast((c) as decimal(18,1))c,cast((d) as decimal(18,1))d,cast((e) as decimal(18,1))e,cast((f) as decimal(18,1))f,cast((g) as decimal(18,1))g,cast((i) as decimal(18,1))i,j into tempdefectL2 from ( " +
                        " select * from ( " +
                        " select [Group], " +
                        " case when @TotalPotongL2>0 then isnull((select cast((TotPot_Proposionet) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)  else 0 end b,  " +
                        " case when @TotalPotongL2>0 then ((isnull((select cast((Defect_Produksi) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end c,  " +
                        " case when @TotalPotongL2>0 then ((isnull((select cast((OK_KM) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0))) else 0 end  d, " +
                        " case when @TotalPotongL2>0 then ((isnull((select cast((Sortir) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  e,  " +
                        " case when @TotalPotongL2>0 then ((isnull((select cast((Retur) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  f,  " +
                        " case when @TotalPotongL2>0 then ((isnull((select cast((BS_Tahap1) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end g , " +
                        " case when @TotalPotongL2>0 then ((isnull((select cast((Total_Defect) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end i, " +
                        " case when @TotalPotongL2>0 then ((isnull((select cast((Persentase) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end j " +
                        " from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 2') )A " +

                        " union all  " +

                        " select 'Total' [Group],sum(b)b,sum(c)c,sum(d)d,sum(e)e,sum(f)f,sum(g)g,sum(i) i,(sum(nullif(i,0))/sum(b))*100 j " +
                        " from( " +
                        //" " + logika3 + " " +
                        " select [Group], " +
                        " case when @TotalPotongL2>0 then isnull((select cast((TotPot_Proposionet) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)  else 0 end b,  " +
                        " case when @TotalPotongL2>0 then ((isnull((select cast((Defect_Produksi) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end c,  " +
                        " case when @TotalPotongL2>0 then ((isnull((select cast((OK_KM) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0))) else 0 end  d, " +
                        " case when @TotalPotongL2>0 then ((isnull((select cast((Sortir) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  e,  " +
                        " case when @TotalPotongL2>0 then ((isnull((select cast((Retur) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  f,  " +
                        " case when @TotalPotongL2>0 then ((isnull((select cast((BS_Tahap1) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end g,  " +
                        " case when @TotalPotongL2>0 then ((isnull((select cast((Total_Defect) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end i, " +
                        " case when @TotalPotongL2>0 then ((isnull((select cast((Persentase) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end j " +
                        " from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 2'))A )B " +
                        " end " +
                        " else " +
                        " begin " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 i, 0 j into tempdefectL2 " +
                        " end " +
                        #endregion
 " " +
                        #region Lin3 - 3
                    " declare @TotalPotongL3 decimal(18,2) " +
                        " declare @TotDefKhususL3 decimal(18,2) " +
                        " declare @DefKhususL3 decimal(18,2) " +
                        " declare @Ttotalkw1kw2L3 decimal(18,2) " +
                        " declare @NCSortirL3 decimal(18,2) " +
                        " declare @ReturL3 decimal(18,2) " +
                        " declare @DefectFinL3 decimal(18,2) " +

                        //" set @TotalPotongL3=(select isnull(sum(totkubik ),0) from tempdefectGPIsoTot where [group]in (select [group] from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 3'))) " +
                        " set @TotalPotongL3=isnull((select sum(M3) from tempTotPot_Proposionet where [group]in (select [group] from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 3'))),0) " +
                        " set @TotDefKhususL3=(@TotalPotongL3/@TotalPotong)*@TotalDefKhusus " +
                        " set @DefKhususL3=(@TotalPotongL3/@TotalPotong)*@DefKhusus " +
                        " set @Ttotalkw1kw2L3=(@TotalPotongL3/@TotalPotong)*@Ttotalkw1kw2 " +
                        " set @NCSortirL3=(@TotalPotongL3/@TotalPotong)*@NCSortir " +
                        " set @ReturL3=(@TotalPotongL3/@TotalPotong)*@Retur " +

                        " if @TotalPotongL3>0 " +
                        " begin " +
                        " select [Group],cast((b) as decimal(18,1))b,cast((c) as decimal(18,1))c,cast((d) as decimal(18,1))d,cast((e) as decimal(18,1))e,cast((f) as decimal(18,1))f,cast((g) as decimal(18,1))g,cast((i) as decimal(18,1))i,j into tempdefectL3 from ( " +
                        " select * from ( select [Group], " +
                        " case when @TotalPotongL3>0 then isnull((select cast((TotPot_Proposionet) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)  else 0 end b,  " +
                        " case when @TotalPotongL3>0 then ((isnull((select cast((Defect_Produksi) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end c,  " +
                        " case when @TotalPotongL3>0 then ((isnull((select cast((OK_KM) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0))) else 0 end  d, " +
                        " case when @TotalPotongL3>0 then ((isnull((select cast((Sortir) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  e,  " +
                        " case when @TotalPotongL3>0 then ((isnull((select cast((Retur) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  f,  " +
                        " case when @TotalPotongL3>0 then ((isnull((select cast((BS_Tahap1) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end g,  " +
                        " case when @TotalPotongL3>0 then ((isnull((select cast((Total_Defect) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end i, " +
                        " case when @TotalPotongL3>0 then ((isnull((select cast((Persentase) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end j " +
                        "  from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 3') )A " +

                        " union all  " +

                        " select 'Total' [Group],sum(b)b,sum(c)c,sum(d)d,sum(e)e,sum(f)f,sum(g)g,sum(i) i,(sum(nullif(i,0))/sum(b))*100 j " +
                        " from( " +
                        " select [Group], " +
                        " case when @TotalPotongL3>0 then isnull((select cast((TotPot_Proposionet) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)  else 0 end b,  " +
                        " case when @TotalPotongL3>0 then ((isnull((select cast((Defect_Produksi) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end c,  " +
                        " case when @TotalPotongL3>0 then ((isnull((select cast((OK_KM) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0))) else 0 end  d, " +
                        " case when @TotalPotongL3>0 then ((isnull((select cast((Sortir) as decimal(18,2))M33 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  e,  " +
                        " case when @TotalPotongL3>0 then ((isnull((select cast((Retur) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  f,  " +
                        " case when @TotalPotongL3>0 then ((isnull((select cast((BS_Tahap1) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end g,  " +
                        " case when @TotalPotongL3>0 then ((isnull((select cast((Total_Defect) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end i, " +
                        " case when @TotalPotongL3>0 then ((isnull((select cast((Persentase) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end j " +
                        " from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 3'))A )B " +
                        " end " +
                        " else " +
                        " begin " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 i, 0 j into tempdefectL3 " +
                        " end " +
                        #endregion
 " " +
                        #region Line - 4
                    " declare @TotalPotongL4 decimal(18,2) " +
                        " declare @TotDefKhususL4 decimal(18,2) " +
                        " declare @DefKhususL4 decimal(18,2) " +
                        " declare @Ttotalkw1kw2L4 decimal(18,2) " +
                        " declare @NCSortirL4 decimal(18,2) " +
                        " declare @ReturL4 decimal(18,2) " +
                        " declare @DefectFinL4 decimal(18,2) " +

                        //" set @TotalPotongL4=(select isnull(sum(totkubik ),0) from tempdefectGPIsoTot where [group]in (select [group] from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 4'))) " +
                        " set @TotalPotongL4=isnull((select sum(M3) from tempTotPot_Proposionet where [group]in (select [group] from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 4'))),0) " +
                        " set @TotDefKhususL4=(@TotalPotongL4/@TotalPotong)*@TotalDefKhusus " +
                        " set @DefKhususL4=(@TotalPotongL4/@TotalPotong)*@DefKhusus " +
                        " set @Ttotalkw1kw2L4=(@TotalPotongL4/@TotalPotong)*@Ttotalkw1kw2 " +
                        " set @NCSortirL4=(@TotalPotongL4/@TotalPotong)*@NCSortir " +
                        " set @ReturL4=(@TotalPotongL4/@TotalPotong)*@Retur " +
                        //" set @DefectFinL4=isnull((@TotalPotongL4/@TotalPotong)*@DefectFin,0) " +

                        " if @TotalPotongL4>0 " +
                        " begin " +
                        " select [Group],cast((b) as decimal(18,1))b,cast((c) as decimal(18,1))c,cast((d) as decimal(18,1))d,cast((e) as decimal(18,1))e,cast((f) as decimal(18,1))f,cast((g) as decimal(18,1))g,cast((i) as decimal(18,1))i,j into tempdefectL4 from ( " +
                        " select * from ( " +
                        " select [Group], " +
                        " case when @TotalPotongL4>0 then isnull((select cast((TotPot_Proposionet) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)  else 0 end b,  " +
                        " case when @TotalPotongL4>0 then ((isnull((select cast((Defect_Produksi) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end c,  " +
                        " case when @TotalPotongL4>0 then ((isnull((select cast((OK_KM) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0))) else 0 end  d, " +
                        " case when @TotalPotongL4>0 then ((isnull((select cast((Sortir) as decimal(18,2))M33 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  e,  " +
                        " case when @TotalPotongL4>0 then ((isnull((select cast((Retur) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  f,  " +
                        " case when @TotalPotongL4>0 then ((isnull((select cast((BS_Tahap1) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end g,  " +
                        " case when @TotalPotongL4>0 then ((isnull((select cast((Total_Defect) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end i, " +
                        " case when @TotalPotongL4>0 then ((isnull((select cast((Persentase) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end j " +
                        " from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 4') )A " +

                        " union all  " +

                        " select 'Total' [Group],sum(b)b,sum(c)c,sum(d)d,sum(e)e,sum(f)f,sum(g)g,sum(i)i,(sum(nullif(i,0))/sum(b))*100 j" +
                        " from( " +
                        " select [Group], " +
                        " ((isnull((select cast((TotPot_Proposionet) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0))) b, " +
                        " ((isnull((select cast((Defect_Produksi) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0))) c, " +
                        " ((isnull((select cast((OK_KM) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0))) d, " +
                        " ((isnull((select cast((Sortir) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0))) e, " +
                        " ((isnull((select cast((Retur) as decimal(18,2))M33 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0))) f, " +
                        " ((isnull((select cast((BS_Tahap1) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0))) g, " +
                        " ((isnull((select cast((Total_Defect) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0))) i, " +
                        " ((isnull((select cast((Persentase) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0))) j " +
                        " from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 4'))A )B " +
                        " end " +
                        " else " +
                        " begin " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 i, 0 j into tempdefectL4 " +
                        " end " +
                        #endregion
 " " +
                        #region Line - 5
                    " declare @TotalPotongL5 decimal(18,2) " +
                        " declare @TotDefKhususL5 decimal(18,2) " +
                        " declare @DefKhususL5 decimal(18,2) " +
                        " declare @Ttotalkw1kw2L5 decimal(18,2) " +
                        " declare @NCSortirL5 decimal(18,2) " +
                        " declare @ReturL5 decimal(18,2) " +
                        " declare @DefectFinL5 decimal(18,2) " +

                        //" set @TotalPotongL5=(select isnull(sum(totkubik ),0) from tempdefectGPIsoTot where [group]in (select [group] from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 5'))) " +
                        " set @TotalPotongL5=isnull((select sum(M3) from tempTotPot_Proposionet where [group]in (select [group] from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 5'))),0) " +
                        " set @TotDefKhususL5=(@TotalPotongL5/@TotalPotong)*@TotalDefKhusus " +
                        " set @DefKhususL5=(@TotalPotongL5/@TotalPotong)*@DefKhusus " +
                        " set @Ttotalkw1kw2L5=(@TotalPotongL5/@TotalPotong)*@Ttotalkw1kw2 " +
                        " set @NCSortirL5=(@TotalPotongL5/@TotalPotong)*@NCSortir " +
                        " set @ReturL5=(@TotalPotongL5/@TotalPotong)*@Retur " +
                        //" set @DefectFinL5=isnull((@TotalPotongL5/@TotalPotong)*@DefectFin,0) " +

                        " if @TotalPotongL5>0 " +
                        " begin " +
                        " select [Group],cast((b) as decimal(18,1))b,cast((c) as decimal(18,1))c,cast((d) as decimal(18,1))d,cast((e) as decimal(18,1))e,cast((f) as decimal(18,1))f,cast((g) as decimal(18,1))g,cast((i) as decimal(18,1))i,j into tempdefectL5 from ( " +
                        " select * from ( " +
                        " select [Group], " +
                        " case when @TotalPotongL5>0 then isnull((select cast((TotPot_Proposionet) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)  else 0 end b,  " +
                        " case when @TotalPotongL5>0 then ((isnull((select cast((Defect_Produksi) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end c,  " +
                        " case when @TotalPotongL5>0 then ((isnull((select cast((OK_KM) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0))) else 0 end  d, " +
                        " case when @TotalPotongL5>0 then ((isnull((select cast((Sortir) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  e,  " +
                        " case when @TotalPotongL5>0 then ((isnull((select cast((Retur) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  f,  " +
                        " case when @TotalPotongL5>0 then ((isnull((select cast((BS_Tahap1) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end g,  " +
                        " case when @TotalPotongL5>0 then ((isnull((select cast((Total_Defect) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end i, " +
                        " case when @TotalPotongL5>0 then ((isnull((select cast((Persentase) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end j " +
                        " from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 5') )A " +

                        "union all  " +

                        " select 'Total' [Group],sum(b)b,sum(c)c,sum(d)d,sum(e)e,sum(f)f,sum(g)g,sum(i)i,(sum(nullif(i,0))/sum(b))*100 j " +
                        " from( " +
                        " select [Group], " +
                        " ((isnull((select cast((TotPot_Proposionet) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0))) b, " +
                        " ((isnull((select cast((Defect_Produksi) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0))) c, " +
                        " ((isnull((select cast((OK_KM) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0))) d, " +
                        " ((isnull((select cast((Sortir) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0))) e, " +
                        " ((isnull((select cast((Retur) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0))) f, " +
                        " ((isnull((select cast((BS_Tahap1) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0))) g, " +
                        " ((isnull((select cast((Total_Defect) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0))) i, " +
                        " ((isnull((select cast((Persentase) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0))) j " +
                        " from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 5'))A )B " +
                        " end " +
                        " else " +
                        " begin " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 i, 0 j into tempdefectL5 " +
                        " end " +
                        #endregion
 " " +
                        #region Line - 6
                    " declare @TotalPotongL6 decimal(18,2) " +
                        " declare @TotDefKhususL6 decimal(18,2) " +
                        " declare @DefKhususL6 decimal(18,2) " +
                        " declare @Ttotalkw1kw2L6 decimal(18,2) " +
                        " declare @NCSortirL6 decimal(18,2) " +
                        " declare @ReturL6 decimal(18,2) " +
                        " declare @DefectFinL6 decimal(18,2) " +

                        //" set @TotalPotongL6=(select isnull(sum(totkubik ),0) from tempdefectGPIsoTot where [group]in (select [group] from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 6'))) " +
                        " set @TotalPotongL6=isnull((select sum(M3) from tempTotPot_Proposionet where [group]in (select [group] from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 6'))),0) " +
                        " set @TotDefKhususL6=(@TotalPotongL6/@TotalPotong)*@TotalDefKhusus " +
                        " set @DefKhususL6=(@TotalPotongL6/@TotalPotong)*@DefKhusus " +
                        " set @Ttotalkw1kw2L6=(@TotalPotongL6/@TotalPotong)*@Ttotalkw1kw2 " +
                        " set @NCSortirL6=(@TotalPotongL6/@TotalPotong)*@NCSortir " +
                        " set @ReturL6=(@TotalPotongL6/@TotalPotong)*@Retur " +
                        //" set @DefectFinL6=isnull((@TotalPotongL6/@TotalPotong)*@DefectFin,0) " +

                        " if @TotalPotongL6>0 " +
                        " begin " +
                        " select [Group],cast((b) as decimal(18,1))b,cast((c) as decimal(18,1))c,cast((d) as decimal(18,1))d,cast((e) as decimal(18,1))e,cast((f) as decimal(18,1))f,cast((g) as decimal(18,1))g,cast((i) as decimal(18,1))i,cast((j) as decimal(18,1))j into tempdefectL6 from ( " +
                        " select * from ( " +
                        " select [Group], " +
                        " case when @TotalPotongL6>0 then isnull((select cast((TotPot_Proposionet) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)  else 0 end b,  " +
                        " case when @TotalPotongL6>0 then ((isnull((select cast((Defect_Produksi) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end c,  " +
                        " case when @TotalPotongL6>0 then ((isnull((select cast((OK_KM) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0))) else 0 end  d, " +
                        " case when @TotalPotongL6>0 then ((isnull((select cast((Sortir) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  e,  " +
                        " case when @TotalPotongL6>0 then ((isnull((select cast((Retur) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  f,  " +
                        " case when @TotalPotongL6>0 then ((isnull((select cast((BS_Tahap1) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end g,  " +
                        " case when @TotalPotongL6>0 then ((isnull((select cast((Total_Defect) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end i, " +
                        " case when @TotalPotongL6>0 then ((isnull((select cast((Persentase) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end j " +
                        " from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 6') )A " +

                        "union all  " +

                        " select 'Total' [Group],sum(b)b,sum(c)c,sum(d)d,sum(e)e,sum(f)f,sum(g)g,sum(i)i,(sum(nullif(i,0))/sum(b))*100 j " +
                        " from( " +
                        " select [Group], " +
                        " ((isnull((select cast((TotPot_Proposionet) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0))) b, " +
                        " ((isnull((select cast((Defect_Produksi) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0))) c, " +
                        " ((isnull((select cast((OK_KM) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0))) d, " +
                        " ((isnull((select cast((Sortir) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0))) e, " +
                        " ((isnull((select cast((Retur) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0))) f, " +
                        " ((isnull((select cast((BS_Tahap1) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0))) g, " +
                        " ((isnull((select cast((Total_Defect) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0))) i, " +
                        " ((isnull((select cast((Persentase) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0))) j " +
                        " from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 6'))A )B " +
                        " end " +
                        " else " +
                        " begin " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 i, 0 j into tempdefectL6 " +
                        " end " +
                        #endregion

                        //" select [group],cast((b) as decimal(18,2))b,cast((c) as decimal(18,2))c,cast((d) as decimal(18,2))d,cast((e) as decimal(18,2))e,cast((f) as decimal(18,2))f,case when [group]<>'total' then cast((g) as decimal(18,2)) when [group]='total' then cast((g) as decimal(18,2)) end g,i,j from tempdefectL1 " +

                        " select [group],b,c,d,e,f,g,i,case when [group]='total' then cast((i/b)*100 as decimal(18,1)) else j end j from ( " +
            " select [group],cast((b) as decimal(18,0))b,cast((c) as decimal(18,2))c,cast((d) as decimal(18,2))d,cast((e) as decimal(18,2))e,cast((f) as decimal(18,2))f, " +
            " case when [group]<>'total' then cast((g) as decimal(18,2)) when [group]='total' then cast((g) as decimal(18,2)) end g, " +
            " cast(i as decimal(18,0))i,cast(j as decimal(18,2))j from tempdefectL1 " +
            " ) as b " +

                        " select GP,i NilaiDefect,b NilaiSerah,'" + DateTime.Parse(txtdrtanggal.Text).ToString("yyyyMM") + "'Periode  into tempDataSarmut_Defect from " +
                        " ( " +
                        " select case when [Group]='Total' then 'Total_L1' else [Group] end GP,b,i from tempdefectL1 union all " +
                        " select case when [Group]='Total' then 'Total_L2' else [Group] end GP,b,i from tempdefectL2 union all  " +
                        " select case when [Group]='Total' then 'Total_L3' else [Group] end GP,b,i from tempdefectL3 union all  " +
                        " select case when [Group]='Total' then 'Total_L4' else [Group] end GP,b,i from tempdefectL4 union all " +
                        " select case when [Group]='Total' then 'Total_L5' else [Group] end GP,b,i from tempdefectL5 union all " +
                        " select case when [Group]='Total' then 'Total_L6' else [Group] end GP,b,i from tempdefectL6   " +
                        " )A  where GP<>'' ";
                        #endregion
                    }
                    #endregion
                }
                else
                {
                    #region query lembar
                    #region Lama
                    if (Convert.ToInt32(strtgl1.Substring(0, 6)) < 201911)
                    {
                        strSQL = "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectGPIso]') AND type in (N'U')) DROP TABLE [dbo].[tempdefectGPIso]  " +
                        "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectGPIsoTot]') AND type in (N'U')) DROP TABLE [dbo].tempdefectGPIsoTot  " +
                        "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectFin]') AND type in (N'U')) DROP TABLE [dbo].tempdefectFin " +
                        "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectL1]') AND type in (N'U')) DROP TABLE [dbo].tempdefectL1 " +
                        "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectL2]') AND type in (N'U')) DROP TABLE [dbo].tempdefectL2 " +
                        "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectL3]') AND type in (N'U')) DROP TABLE [dbo].tempdefectL3 " +
                        "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectL4]') AND type in (N'U')) DROP TABLE [dbo].tempdefectL4 " +
                        "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectL5]') AND type in (N'U')) DROP TABLE [dbo].tempdefectL5 " +
                        "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectL6]') AND type in (N'U')) DROP TABLE [dbo].tempdefectL6 " +
                                    "declare @thnbln1 varchar(8) " +
                        "declare @thnbln2 varchar(8) " +
                        "set @thnbln1='" + strtgl1 + "' " +
                        "set @thnbln2='" + strtgl2 + "' " +
                         "select *  into tempdefectGPIso from (  " +
                        "select case when D.DeptID=0 then  " +
                        "case when GJ.GroupJemurName In ('M','N','O','P','Q','R','S','T','U','V','W','X') then   " +
                        "    case when D.DefName='retak' then 2   " +
                        "        when D.DefName='gompal' then 3  " +
                        "    else D.DeptID end   " +
                        "else    " +
                        "    case when (B.Qty/E.Qty) *100 >5 then 2 else 3 end   " +
                        "end  " +
                        "else D.DeptID end deptID1,A.CreatedTime as tglInput,A.Tgl as TglPeriksa,E.TglProduksi as TglProd,  D.DefCode,BP.PlantName as Line, PG.[Group],BF.FormulaCode as Jenis,   " +
                        "D.DefName,D.DeptID,B.ID,B.DefectID,B.MasterID,B.Qty,A.ID  DestID,isnull(A.TPotong,0)  QtyIn,B.Qty*I.Volume as Kubik,isnull(A.TPotong,0) as TotPotong,'' sfrom  " +
                        "from Def_DefectDetail B inner join Def_Defect A on A.Id=B.DefectID   " +
                        "left join Def_MasterDefect D on B.MasterID=D.ID left join BM_Destacking E on E.ID=A.DestID   " +
                        "left join BM_PlantGroup PG on A.GroupProdID=PG.ID left join BM_Formula BF on BF.ID=E.FormulaID    " +
                        "left join BM_Plant BP on BP.ID=E.PlantID left join FC_Items I on I.ID=E.ItemID inner join Def_GroupJemur GJ on GJ.ID=A.GroupJemurID  " +
                        "where B.RowStatus>-1  and D.RowStatus >-1) as Def    " +
                        "where DeptID1=2 and CONVERT(varchar,TglPeriksa,112)>=@thnbln1 and CONVERT(varchar,TglPeriksa,112)<=@thnbln2  " +
                        " " +
                        QueryTotalPotong +
                        " " +
                        "declare @DefectFin decimal(18,2) " +
                        "set @DefectFin= (select sum(Qty) from (  " +
                        "select case when D.DeptID=0 then  " +
                        "case when GJ.GroupJemurName In ('M','N','O','P','Q','R','S','T','U','V','W','X') then   " +
                        "case when D.DefName='retak' then 2   " +
                        "when D.DefName='gompal' then 3  " +
                        "else D.DeptID end   " +
                        "else    " +
                        "case when (B.Qty/E.Qty) *100 >5 then 2 else 3 end   " +
                        "end  " +
                        "else D.DeptID end deptID1,A.CreatedTime as tglInput,A.Tgl as TglPeriksa,E.TglProduksi as TglProd,  D.DefCode,BP.PlantName as Line, PG.[Group],BF.FormulaCode as Jenis,   " +
                        "D.DefName,D.DeptID,B.ID,B.DefectID,B.MasterID,B.Qty,A.ID  DestID,isnull(A.TPotong,0)  QtyIn,B.Qty*I.Volume as Kubik,isnull(A.TPotong,0) as TotPotong,'' sfrom  " +
                        "from Def_DefectDetail B inner join Def_Defect A on A.Id=B.DefectID   " +
                        "left join Def_MasterDefect D on B.MasterID=D.ID left join BM_Destacking E on E.ID=A.DestID   " +
                        "left join BM_PlantGroup PG on A.GroupProdID=PG.ID left join BM_Formula BF on BF.ID=E.FormulaID    " +
                        "left join BM_Plant BP on BP.ID=E.PlantID left join FC_Items I on I.ID=E.ItemID inner join Def_GroupJemur GJ on GJ.ID=A.GroupJemurID  " +
                        "where B.RowStatus>-1  and D.RowStatus >-1) as Def    " +
                        "where DeptID1<>2 and CONVERT(varchar,TglPeriksa,112)>=@thnbln1 and CONVERT(varchar,TglPeriksa,112)<=@thnbln2) " +
                        " " +
                        "select * into tempdefectFin from ( " +
                        "select 'OKKW' fin, sum(qtyin) lembar,sum(qtyin * kubik)kubik from ( " +
                        "select I1.PartNo partno1,I1.Panjang * I1.Lebar luas1,  S.qtyin,I2.PartNo partno2,I2.Panjang * I2.Lebar luas2,  S.qtyout ,(I1.Tebal * I1.Panjang * I1.Lebar)/1000000000 kubik " +
                        "from t3_simetris S inner join T3_Serah Se on S.SerahID =Se.ID inner join fc_items I1 on Se.ItemID=I1.ID inner join fc_items I2 on S.ItemID=I2.id  " +
                        "where S.RowStatus>-1 and CONVERT(varchar,S.tgltrans,112)>=@thnbln1 and CONVERT(varchar,S.tgltrans,112)<=@thnbln2 )a  " +
                        "where partno1 like '%-1-%' and luas2/luas1 *100<60 and partno2 like '%-p-%' " +
                        "union all " +
                        "select 'BP' fin, sum(qtyin) lembar,sum(qtyin * kubik)kubik from ( " +
                        "select I1.PartNo partno1,I1.Panjang * I1.Lebar luas1,  S.qtyin,I2.PartNo partno2,I2.Panjang * I2.Lebar luas2,  S.qtyout ,(I1.Tebal * I1.Panjang * I1.Lebar)/1000000000 kubik " +
                        "from t3_simetris S inner join T3_Serah Se on S.SerahID =Se.ID inner join fc_items I1 on Se.ItemID=I1.ID inner join fc_items I2 on S.ItemID=I2.id  " +
                        "where S.RowStatus>-1 and CONVERT(varchar,S.tgltrans,112)>=@thnbln1 and CONVERT(varchar,S.tgltrans,112)<=@thnbln2  )a where partno1 like '%-1-%' and luas2/luas1 *100<60 and  " +
                        "(partno2 like '%-3-%' or partno2 like '%-w-%' or partno2 like '%-m-%') " +
                        "union all " +
                        "select 'BS' fin,sum(R.QtyIn) Lembar,sum(R.QtyIn *((I.tebal*I.panjang*I.lebar)/1000000000)) kubik from T3_Rekap R inner join  " +
                        "FC_Items I on R.ItemID=I.id inner join fc_lokasi L on R.LokID =L.id where R.RowStatus>-1 and  " +
                        "CONVERT(varchar,R.tgltrans,112)>=@thnbln1 and CONVERT(varchar,R.tgltrans,112)<=@thnbln2   and I.PartNo like '%-s-%' and Process='direct' " +
                        "and (sfrom not like'%R1%' and sfrom not like'%R2%' and sfrom not like'%R3%'))A " +
                        " " +
                        "declare @TotalPotong decimal(18,2) " +
                        "declare @TotalDefKhusus decimal(18,2) " +
                        "declare @DefKhusus decimal(18,2) " +
                        "declare @Ttotalkw1kw2 decimal(18,2) " +
                        "declare @NCSortir decimal(18,2) " +
                        "declare @Retur decimal(18,2) " +
                        "set @TotalPotong=isnull((select sum(totpotong ) from tempdefectGPIsoTot),0) " +
                        "declare @SelisihTotalPotong decimal(18,2) " +
                        "declare @TotalAccReport decimal(18,2) " +
                        "set @TotalAccReport=(select lembar from( " +
                        "select  sum(lembar) lembar,sum(kubik)kubik from ( " +
                        "select 'AccReport' fin, sum(qtyin) lembar,sum(qtyin * kubik)kubik from ( " +
                        "select I1.PartNo partno1,I1.Panjang * I1.Lebar luas1,  S.qtyin,I2.PartNo partno2,I2.Panjang * I2.Lebar luas2,  S.qtyout ,(I1.Tebal * I1.Panjang * I1.Lebar)/1000000000 kubik " +
                        "from t3_simetris S inner join T3_Serah Se on S.SerahID =Se.ID inner join fc_items I1 on Se.ItemID=I1.ID inner join fc_items I2 on S.ItemID=I2.id  " +
                        "where S.RowStatus>-1 and CONVERT(varchar,S.tgltrans,112)>=@thnbln1 and CONVERT(varchar,S.tgltrans,112)<=@thnbln2 )a  " +
                        "where partno1 like '%-1-%' and luas2/luas1 *100>90  and (partno2 like '%-p-%' or partno2 like '%-3-%' or partno2 like '%-M-%') " +
                        "union all " +
                        "select 'AccReport' fin, sum(qtyin) lembar,sum(qtyin * kubik)kubik from ( " +
                        "select I1.PartNo partno1,I1.Panjang * I1.Lebar luas1,  S.qtyin,I2.PartNo partno2,I2.Panjang * I2.Lebar luas2,  S.qtyout ,(I1.Tebal * I1.Panjang * I1.Lebar)/1000000000 kubik " +
                        "from t1_serah S  inner join fc_items I1 on S.ItemID0=I1.ID inner join fc_items I2 on S.ItemID=I2.id  " +
                        "where S.Status>-1 and CONVERT(varchar,S.tglserah,112)>=@thnbln1 and CONVERT(varchar,S.tglserah,112)<=@thnbln2 )a  " +
                        "where (partno2 like '%-p-%' or partno2 like '%-3-%' or partno2 like '%-M-%'))a)B) " +
                        "set @SelisihTotalPotong= @TotalAccReport-@TotalPotong " +
                        "if @TotalPotong >0  " +
                        "begin " +
                        "set @TotalDefKhusus=isnull((select sum(Lembar) from tempdefectFin),0) " +
                        "set @DefKhusus=isnull((select sum(Lembar) from tempdefectFin where fin<>'bp'),0) " +
                        "set @Ttotalkw1kw2 =isnull((select sum(qtyin) from T3_Rekap R inner join fc_items I on R.itemid=I.ID  " +
                        "where R.rowstatus>-1 and R.Process  like '%simetris%' and CONVERT(varchar,R.tgltrans,112)>=@thnbln1 and CONVERT(varchar,R.tgltrans,112)<=@thnbln2   " +
                        "and I.lebar=1200 and I.panjang=2400 and R.keterangan like '%-p-%' and (I.partno like '%-3-%' or I.partno like '%-W-%' or I.partno like '%-M-%' )),0) " +
                        "set @NCSortir=isnull((select sum(QtyAkhirSS)+sum(QtyAkhirSE)/*sum(M3AkhirSS)+sum(M3AkhirSE)*/ from (  " +
                        "SELECT B.tgltrans as Tanggal, I1.PartNo as PartnoAwal, sum(B.QtyIn) as QtyAwal,sum(I1.Volume*B.QtyIn) M3Awal,   " +
                        "I2.PartNo AS PartnoAkhir, case when B.NCSS>0 then sum(B.QtyOut) else 0 end QtyAkhirSS,  " +
                        "case when B.NCSS>0 then sum(I2.Volume*B.QtyOut) else 0 end M3AkhirSS,case when B.NCSE>0 then sum(B.QtyOut) else 0 end QtyAkhirSE,  " +
                        "case when B.NCSE>0 then sum(I2.Volume*B.QtyOut) else 0 end M3AkhirSE,B.NCSS,B.NCSE  FROM T3_Serah AS A   " +
                        "INNER JOIN T3_Simetris AS B ON A.ID = B.SerahID INNER JOIN FC_Items AS I1 ON A.ItemID = I1.ID INNER JOIN   " +
                        "FC_Items AS I2 ON B.ItemID = I2.ID LEFT JOIN T3_GroupM AS D ON B.GroupID = D.ID   " +
                        "where (B.NCSS>0 or B.NCSE>0) and B.rowstatus>-1 and CONVERT(varchar,B.tgltrans,112)>=@thnbln1 and CONVERT(varchar,B.tgltrans,112)<=@thnbln2   " +
                        "group by B.tgltrans,I1.PartNo,I2.PartNo,B.NCSS,B.NCSE) S),0) " +
                        " " +
                        "set @Retur=isnull((select sum(qty) from (  " +
                        "select sum(qty ) qty from t3_retur R inner join fc_items I on R.itemid=I.id where R.rowstatus>-1 and   " +
                        "R.typer=1 and (I.partno like '%-p-%' or I.partno like '%-S-%')  and CONVERT(varchar,R.tgltrans,112)>=@thnbln1 and CONVERT(varchar,R.tgltrans,112)<=@thnbln2   " +
                        "union all  " +
                        "select sum(qty )*-1 qty from t3_retur R inner join fc_items I on R.itemid=I.id where R.rowstatus>-1 and   " +
                        "R.typer=2 and (I.partno like '%-p-%' or I.partno like '%-S-%')and CONVERT(varchar,R.tgltrans,112)>=@thnbln1 and CONVERT(varchar,R.tgltrans,112)<=@thnbln2  " +
                        "union all  " +
                        "select sum(qty) qty from t3_returO R inner join fc_items I on R.itemid=I.id where R.rowstatus>-1 and   " +
                        "(I.partno like '%-p-%' or I.partno like '%-S-%') and CONVERT(varchar,R.tgltrans,112)>=@thnbln1 and CONVERT(varchar,R.tgltrans,112)<=@thnbln2)A),0) " +
                        " " +
                        "declare @TotalPotongL1 decimal(18,2) " +
                        "declare @TotDefKhususL1 decimal(18,2) " +
                        "declare @DefKhususL1 decimal(18,2) " +
                        "declare @Ttotalkw1kw2L1 decimal(18,2) " +
                        "declare @NCSortirL1 decimal(18,2) " +
                        "declare @ReturL1 decimal(18,2) " +
                        "declare @DefectFinL1 decimal(18,2) " +
                        "set @TotalPotongL1=(select sum(totpotong ) from tempdefectGPIsoTot where [group]in (select [group] from BM_PlantGroup  " +
                        "where PlantID in (select id from BM_Plant where PlantName='line 1'))) " +
                        "set @TotDefKhususL1=(@TotalPotongL1/@TotalPotong)*@TotalDefKhusus " +
                        "set @DefKhususL1=(@TotalPotongL1/@TotalPotong)*@DefKhusus " +
                        "set @Ttotalkw1kw2L1=(@TotalPotongL1/@TotalPotong)*@Ttotalkw1kw2 " +
                        "set @NCSortirL1=(@TotalPotongL1/@TotalPotong)*@NCSortir " +
                        "set @ReturL1=(@TotalPotongL1/@TotalPotong)*@Retur " +
                        "set @DefectFinL1=(@TotalPotongL1/@TotalPotong)*@DefectFin " +
                        "declare @SelisihTotalPotongL1 decimal(18,2) " +
                        "set @SelisihTotalPotongL1=(@TotalPotongL1/@TotalPotong)*@SelisihTotalPotong " +
                        "if @TotalPotongL1>0 " +
                        "begin " +
                        "select * into tempdefectL1 from ( " +
                        "select *,c-d+e+f+g+h i,case when b>0 then (c-d+e+f+g+h)/b*100 else 0  end j from ( " +
                        "select [Group],case when @TotalPotongL1>0 then isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) +  " +
                        "  (( isnull(( select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@TotDefKhususL1)+ " +
                        "  (( isnull(( select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@SelisihTotalPotongL1)  else 0 end b, " +
                        " case when @TotalPotongL1>0 then isnull((select totdefect from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)  else 0 end c, " +
                        " case when @TotalPotongL1>0 then ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@Ttotalkw1kw2L1) else 0 end  d, " +
                        " case when @TotalPotongL1>0 then ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@NCSortirL1)  else 0 end  e, " +
                        " case when @TotalPotongL1>0 then ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@ReturL1)  else 0 end  f, " +
                        " case when @TotalPotongL1>0 then ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@DefectFinL1)  else 0 end g, " +
                        " case when @TotalPotongL1>0 then ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@DefKhususL1) else 0 end  h " +
                        " from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 1') )A " +
                        "union all  " +
                        "select 'Total' [Group],sum(b)b,sum(c)c,sum(d)d,sum(e)e,sum(f)f,sum(g)g,sum(h)h,sum(c)-sum(d)+sum(e)+sum(f)+sum(g)+sum(h) i " +
                        ",(sum(c)-sum(d)+sum(e)+sum(f)+sum(g)+sum(h))/sum(b)*100 j from( " +
                        "select [Group],case when @TotalPotongL1>0 then isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) +  " +
                        "  (( isnull(( select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@TotDefKhususL1) + " +
                        "  (( isnull(( select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@SelisihTotalPotongL1) else 0 end b, " +
                        " case when @TotalPotongL1>0 then isnull((select totdefect from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)  else 0 end c, " +
                        " case when @TotalPotongL1>0 then ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@Ttotalkw1kw2L1) else 0 end  d, " +
                        " case when @TotalPotongL1>0 then ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@NCSortirL1)  else 0 end  e, " +
                        " case when @TotalPotongL1>0 then ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@ReturL1)  else 0 end  f, " +
                        " case when @TotalPotongL1>0 then ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@DefectFinL1)  else 0 end g, " +
                        " case when @TotalPotongL1>0 then ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@DefKhususL1) else 0 end  h, " +
                        " 0 i,0 j from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 1'))A )B " +
                        " end " +
                        " else " +
                        " begin " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 h,0 i, 0 j into tempdefectL1 " +
                        " end " +
                        " " +
                        "declare @TotalPotongL2 decimal(18,2) " +
                        "declare @TotDefKhususL2 decimal(18,2) " +
                        "declare @DefKhususL2 decimal(18,2) " +
                        "declare @Ttotalkw1kw2L2 decimal(18,2) " +
                        "declare @NCSortirL2 decimal(18,2) " +
                        "declare @ReturL2 decimal(18,2) " +
                        "declare @DefectFinL2 decimal(18,2) " +
                        "set @TotalPotongL2=(select sum(totpotong ) from tempdefectGPIsoTot where [group]in (select [group] from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 2'))) " +
                        " " +
                        "set @TotDefKhususL2=(@TotalPotongL2/@TotalPotong)*@TotalDefKhusus " +
                        "set @DefKhususL2=(@TotalPotongL2/@TotalPotong)*@DefKhusus " +
                        "set @Ttotalkw1kw2L2=(@TotalPotongL2/@TotalPotong)*@Ttotalkw1kw2 " +
                        "set @NCSortirL2=(@TotalPotongL2/@TotalPotong)*@NCSortir " +
                        "set @ReturL2=(@TotalPotongL2/@TotalPotong)*@Retur " +
                        "set @DefectFinL2=(@TotalPotongL2/@TotalPotong)*@DefectFin " +
                        "declare @SelisihTotalPotongL2 decimal(18,2) " +
                        "set @SelisihTotalPotongL2=(@TotalPotongL2/@TotalPotong)*@SelisihTotalPotong " +
                        "if @TotalPotongL2>0 " +
                        "begin " +
                        "select * into tempdefectL2 from ( " +
                        "select *,c-d+e+f+g+h i,case when b>0 then (c-d+e+f+g+h)/b*100 else 0  end j from ( " +
                        "select [Group],case when @TotalPotongL2>0 then isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) +  " +
                        " ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL2)*@TotDefKhususL2)+ " +
                        "  (( isnull(( select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL2)*@SelisihTotalPotongL2) else 0 end  b, " +
                        " case when @TotalPotongL2>0 then isnull((select totdefect from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) else 0 end c, " +
                        " case when @TotalPotongL2>0 then ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL2)*@Ttotalkw1kw2L2) else 0 end  d, " +
                        " case when @TotalPotongL2>0 then ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL2)*@NCSortirL2) else 0 end  e, " +
                        " case when @TotalPotongL2>0 then ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL2)*@ReturL2)  else 0 end f, " +
                        " case when @TotalPotongL2>0 then ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL2)*@DefectFinL2) else 0 end  g, " +
                        " case when @TotalPotongL2>0 then ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL2)*@DefKhususL2) else 0 end  h " +
                        "  from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 2') )A " +
                        "union all  " +
                        "select 'Total' [Group],sum(b)b,sum(c)c,sum(d)d,sum(e)e,sum(f)f,sum(g)g,sum(h)h,sum(c)-sum(d)+sum(e)+sum(f)+sum(g)+sum(h) i " +
                        ",(sum(c)-sum(d)+sum(e)+sum(f)+sum(g)+sum(h))/sum(b)*100 j from( " +
                        "select [Group],case when @TotalPotongL2>0 then isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) +  " +
                        " ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL2)*@TotDefKhususL2)+ " +
                        "  (( isnull(( select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL2)*@SelisihTotalPotongL2) else 0 end  b, " +
                        " case when @TotalPotongL2>0 then isnull((select totdefect from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) else 0 end c, " +
                        " case when @TotalPotongL2>0 then ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL2)*@Ttotalkw1kw2L2) else 0 end  d, " +
                        " case when @TotalPotongL2>0 then ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL2)*@NCSortirL2) else 0 end  e, " +
                        " case when @TotalPotongL2>0 then ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL2)*@ReturL2)  else 0 end f, " +
                        " case when @TotalPotongL2>0 then ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL2)*@DefectFinL2) else 0 end  g, " +
                        " case when @TotalPotongL2>0 then ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL2)*@DefKhususL2) else 0 end  h, " +
                        " 0 i,0 j from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 2'))A )B " +
                        " end " +
                        " else " +
                        " begin " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 h,0 i, 0 j into tempdefectL2 " +
                        " end " +
                        " " +
                        "declare @TotalPotongL3 decimal(18,2) " +
                        "declare @TotDefKhususL3 decimal(18,2) " +
                        "declare @DefKhususL3 decimal(18,2) " +
                        "declare @Ttotalkw1kw2L3 decimal(18,2) " +
                        "declare @NCSortirL3 decimal(18,2) " +
                        "declare @ReturL3 decimal(18,2) " +
                        "declare @DefectFinL3 decimal(18,2) " +
                        "set @TotalPotongL3=(select sum(totpotong ) from tempdefectGPIsoTot where [group]in (select [group] from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 3'))) " +
                        "set @TotDefKhususL3=(@TotalPotongL3/@TotalPotong)*@TotalDefKhusus " +
                        "set @DefKhususL3=(@TotalPotongL3/@TotalPotong)*@DefKhusus " +
                        "set @Ttotalkw1kw2L3=(@TotalPotongL3/@TotalPotong)*@Ttotalkw1kw2 " +
                        "set @NCSortirL3=(@TotalPotongL3/@TotalPotong)*@NCSortir " +
                        "set @ReturL3=(@TotalPotongL3/@TotalPotong)*@Retur " +
                        "set @DefectFinL3=(@TotalPotongL3/@TotalPotong)*@DefectFin " +
                        "declare @SelisihTotalPotongL3 decimal(18,2) " +
                        "set @SelisihTotalPotongL3=(@TotalPotongL3/@TotalPotong)*@SelisihTotalPotong " +
                        "if @TotalPotongL3>0 " +
                        "begin " +
                        "select * into tempdefectL3 from ( " +
                        "select *,c-d+e+f+g+h i,case when b>0 then (c-d+e+f+g+h)/b*100 else 0  end j from ( " +
                        "select [Group],case when @TotalPotongL3>0 then isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) +  " +
                        " ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@TotDefKhususL3)+ " +
                        "  (( isnull(( select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@SelisihTotalPotongL3) else 0 end  b, " +
                        " case when @TotalPotongL3>0 then isnull((select totdefect from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) else 0 end c, " +
                        " case when @TotalPotongL3>0 then ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@Ttotalkw1kw2L3) else 0 end  d, " +
                        " case when @TotalPotongL3>0 then ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@NCSortirL3) else 0 end  e, " +
                        " case when @TotalPotongL3>0 then ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@ReturL3) else 0 end  f, " +
                        " case when @TotalPotongL3>0 then ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@DefectFinL3) else 0 end  g, " +
                        " case when @TotalPotongL3>0 then ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@DefKhususL3) else 0 end  h " +
                        "  from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 3') )A " +
                        "union all  " +
                        "select 'Total' [Group],sum(b)b,sum(c)c,sum(d)d,sum(e)e,sum(f)f,sum(g)g,sum(h)h,sum(c)-sum(d)+sum(e)+sum(f)+sum(g)+sum(h) i " +
                        ",(sum(c)-sum(d)+sum(e)+sum(f)+sum(g)+sum(h))/sum(b)*100 j from( " +
                        "select [Group],isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) +  " +
                        " ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@TotDefKhususL3)+ " +
                        "  (( isnull(( select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@SelisihTotalPotongL3)  b, " +
                        " isnull((select totdefect from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)c, " +
                        " ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@Ttotalkw1kw2L3) d, " +
                        " ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@NCSortirL3) e, " +
                        " ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@ReturL3) f, " +
                        " ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@DefectFinL3) g, " +
                        " ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@DefKhususL3) h, " +
                        " 0 i,0 j from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 3'))A )B " +
                        " end " +
                        " else " +
                        " begin " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 h,0 i, 0 j into tempdefectL3 " +
                        " end " +
                        " " +
                        "declare @TotalPotongL4 decimal(18,2) " +
                        "declare @TotDefKhususL4 decimal(18,2) " +
                        "declare @DefKhususL4 decimal(18,2) " +
                        "declare @Ttotalkw1kw2L4 decimal(18,2) " +
                        "declare @NCSortirL4 decimal(18,2) " +
                        "declare @ReturL4 decimal(18,2) " +
                        "declare @DefectFinL4 decimal(18,2) " +
                        "set @TotalPotongL4=(select sum(totpotong ) from tempdefectGPIsoTot where [group]in (select [group] from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 4'))) " +
                        "set @TotDefKhususL4=(@TotalPotongL4/@TotalPotong)*@TotalDefKhusus " +
                        "set @DefKhususL4=(@TotalPotongL4/@TotalPotong)*@DefKhusus " +
                        "set @Ttotalkw1kw2L4=(@TotalPotongL4/@TotalPotong)*@Ttotalkw1kw2 " +
                        "set @NCSortirL4=(@TotalPotongL4/@TotalPotong)*@NCSortir " +
                        "set @ReturL4=(@TotalPotongL4/@TotalPotong)*@Retur " +
                        "set @DefectFinL4=(@TotalPotongL4/@TotalPotong)*@DefectFin " +
                        "declare @SelisihTotalPotongL4 decimal(18,2) " +
                        "set @SelisihTotalPotongL4=(@TotalPotongL4/@TotalPotong)*@SelisihTotalPotong " +
                        "if @TotalPotongL4>0 " +
                        "begin " +
                        "select * into tempdefectL4 from ( " +
                        "select *,c-d+e+f+g+h i,case when b>0 then (c-d+e+f+g+h)/b*100 else 0  end j from ( " +
                        "select [Group],case when @TotalPotongL4>0 then isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) +  " +
                        " ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@TotDefKhususL4)+ " +
                        "  (( isnull(( select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@SelisihTotalPotongL4)  else 0 end  b, " +
                        " case when @TotalPotongL4>0 then isnull((select totdefect from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) else 0 end c, " +
                        " case when @TotalPotongL4>0 then ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@Ttotalkw1kw2L4) else 0 end  d, " +
                        " case when @TotalPotongL4>0 then ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@NCSortirL4) else 0 end  e, " +
                        " case when @TotalPotongL4>0 then ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@ReturL4) else 0 end  f, " +
                        " case when @TotalPotongL4>0 then ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@DefectFinL4) else 0 end  g, " +
                        " case when @TotalPotongL4>0 then ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@DefKhususL4) else 0 end  h " +
                        "  from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 4') )A " +
                        "union all  " +
                        "select 'Total' [Group],sum(b)b,sum(c)c,sum(d)d,sum(e)e,sum(f)f,sum(g)g,sum(h)h,sum(c)-sum(d)+sum(e)+sum(f)+sum(g)+sum(h) i " +
                        ",(sum(c)-sum(d)+sum(e)+sum(f)+sum(g)+sum(h))/sum(b)*100 j from( " +
                        "select [Group],isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) +  " +
                        " ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@TotDefKhususL4)+ " +
                        "  (( isnull(( select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@SelisihTotalPotongL4) b, " +
                        " isnull((select totdefect from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)c, " +
                        " ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@Ttotalkw1kw2L4) d, " +
                        " ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@NCSortirL4) e, " +
                        " ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@ReturL4) f, " +
                        " ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@DefectFinL4) g, " +
                        " ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@DefKhususL4) h, " +
                        " 0 i,0 j from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 4'))A )B " +
                        " end " +
                        " else " +
                        " begin " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 h,0 i, 0 j into tempdefectL4 " +
                        " end " +
                        " " +
                        "declare @TotalPotongL5 decimal(18,2) " +
                        "declare @TotDefKhususL5 decimal(18,2) " +
                        "declare @DefKhususL5 decimal(18,2) " +
                        "declare @Ttotalkw1kw2L5 decimal(18,2) " +
                        "declare @NCSortirL5 decimal(18,2) " +
                        "declare @ReturL5 decimal(18,2) " +
                        "declare @DefectFinL5 decimal(18,2) " +
                        "set @TotalPotongL5=(select sum(totpotong ) from tempdefectGPIsoTot where [group]in (select [group] from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 5'))) " +
                        "set @TotDefKhususL5=(@TotalPotongL5/@TotalPotong)*@TotalDefKhusus " +
                        "set @DefKhususL5=(@TotalPotongL5/@TotalPotong)*@DefKhusus " +
                        "set @Ttotalkw1kw2L5=(@TotalPotongL5/@TotalPotong)*@Ttotalkw1kw2 " +
                        "set @NCSortirL5=(@TotalPotongL5/@TotalPotong)*@NCSortir " +
                        "set @ReturL5=(@TotalPotongL5/@TotalPotong)*@Retur " +
                        "set @DefectFinL5=(@TotalPotongL5/@TotalPotong)*@DefectFin " +
                        "declare @SelisihTotalPotongL5 decimal(18,2) " +
                        "set @SelisihTotalPotongL5=(@TotalPotongL5/@TotalPotong)*@SelisihTotalPotong " +
                        "if @TotalPotongL5>0 " +
                        "begin " +
                        "select * into tempdefectL5 from ( " +
                        "select *,c-d+e+f+g+h i,case when b>0 then (c-d+e+f+g+h)/b*100 else 0  end j from ( " +
                        "select [Group],case when @TotalPotongL5>0 then isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) +  " +
                        " ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@TotDefKhususL5) + " +
                        "  (( isnull(( select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@SelisihTotalPotongL5) else 0 end  b, " +
                        " case when @TotalPotongL5>0 then isnull((select totdefect from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) else 0 end c, " +
                        " case when @TotalPotongL5>0 then ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@Ttotalkw1kw2L5) else 0 end  d, " +
                        " case when @TotalPotongL5>0 then ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@NCSortirL5) else 0 end  e, " +
                        " case when @TotalPotongL5>0 then ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@ReturL5) else 0 end  f, " +
                        " case when @TotalPotongL5>0 then ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@DefectFinL5) else 0 end  g, " +
                        " case when @TotalPotongL5>0 then ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@DefKhususL5) else 0 end  h " +
                        "  from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 5') )A " +
                        "union all  " +
                        "select 'Total' [Group],sum(b)b,sum(c)c,sum(d)d,sum(e)e,sum(f)f,sum(g)g,sum(h)h,sum(c)-sum(d)+sum(e)+sum(f)+sum(g)+sum(h) i " +
                        ",(sum(c)-sum(d)+sum(e)+sum(f)+sum(g)+sum(h))/sum(b)*100 j from( " +
                        "select [Group],isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) +  " +
                        " ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@TotDefKhususL5)+ " +
                        "  (( isnull(( select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@SelisihTotalPotongL5) b, " +
                        " isnull((select totdefect from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)c, " +
                        " ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@Ttotalkw1kw2L5) d, " +
                        " ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@NCSortirL5) e, " +
                        " ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@ReturL5) f, " +
                        " ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@DefectFinL5) g, " +
                        " ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@DefKhususL5) h, " +
                        " 0 i,0 j from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 5'))A )B " +
                        " end " +
                        " else " +
                        " begin " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 h,0 i, 0 j into tempdefectL5 " +
                        " end " +
                        " " +
                        "declare @TotalPotongL6 decimal(18,2) " +
                        "declare @TotDefKhususL6 decimal(18,2) " +
                        "declare @DefKhususL6 decimal(18,2) " +
                        "declare @Ttotalkw1kw2L6 decimal(18,2) " +
                        "declare @NCSortirL6 decimal(18,2) " +
                        "declare @ReturL6 decimal(18,2) " +
                        "declare @DefectFinL6 decimal(18,2) " +
                        "set @TotalPotongL6=(select sum(totpotong ) from tempdefectGPIsoTot where [group]in (select [group] from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 6'))) " +
                        "set @TotDefKhususL6=(@TotalPotongL6/@TotalPotong)*@TotalDefKhusus " +
                        "set @DefKhususL6=(@TotalPotongL6/@TotalPotong)*@DefKhusus " +
                        "set @Ttotalkw1kw2L6=(@TotalPotongL6/@TotalPotong)*@Ttotalkw1kw2 " +
                        "set @NCSortirL6=(@TotalPotongL6/@TotalPotong)*@NCSortir " +
                        "set @ReturL6=(@TotalPotongL6/@TotalPotong)*@Retur " +
                        "set @DefectFinL6=(@TotalPotongL6/@TotalPotong)*@DefectFin " +
                        "declare @SelisihTotalPotongL6 decimal(18,2) " +
                        "set @SelisihTotalPotongL6=(@TotalPotongL6/@TotalPotong)*@SelisihTotalPotong " +
                        "if @TotalPotongL6>0 " +
                        "begin " +
                        "select * into tempdefectL6 from ( " +
                        "select *,c-d+e+f+g+h i,case when b>0 then (c-d+e+f+g+h)/b*100 else 0  end j from ( " +
                        "select [Group],case when @TotalPotongL6>0 then isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) +  " +
                        " ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@TotDefKhususL6) + " +
                        "  (( isnull(( select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@SelisihTotalPotongL6) else 0 end b, " +
                        " case when @TotalPotongL6>0 then isnull((select totdefect from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) else 0 end c, " +
                        " case when @TotalPotongL6>0 then ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@Ttotalkw1kw2L6)  else 0 end d, " +
                        " case when @TotalPotongL6>0 then ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@NCSortirL6)  else 0 end e, " +
                        " case when @TotalPotongL6>0 then ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@ReturL6)  else 0 end f, " +
                        " case when @TotalPotongL6>0 then ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@DefectFinL6)  else 0 end g, " +
                        " case when @TotalPotongL6>0 then ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@DefKhususL6) else 0 end  h " +
                        "  from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 6') )A " +
                        "union all  " +
                        "select 'Total' [Group],sum(b)b,sum(c)c,sum(d)d,sum(e)e,sum(f)f,sum(g)g,sum(h)h,sum(c)-sum(d)+sum(e)+sum(f)+sum(g)+sum(h) i " +
                        ",(sum(c)-sum(d)+sum(e)+sum(f)+sum(g)+sum(h))/sum(b)*100 j from( " +
                        "select [Group],isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) +  " +
                        " ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@TotDefKhususL6)+ " +
                        "  (( isnull(( select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@SelisihTotalPotongL6) b, " +
                        " isnull((select totdefect from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)c, " +
                        " ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@Ttotalkw1kw2L6) d, " +
                        " ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@NCSortirL6) e, " +
                        " ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@ReturL6) f, " +
                        " ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@DefectFinL6) g, " +
                        " ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@DefKhususL6) h, " +
                        " 0 i,0 j from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 6'))A )B " +
                        " end " +
                        " else " +
                        " begin " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 h,0 i, 0 j into tempdefectL6 " +
                        " end " +
                        " " +
                        " end " +
                        " else " +
                        " begin " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 h,0 i, 0 j into tempdefectL1 " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 h,0 i, 0 j into tempdefectL2 " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 h,0 i, 0 j into tempdefectL3 " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 h,0 i, 0 j into tempdefectL4 " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 h,0 i, 0 j into tempdefectL5 " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 h,0 i, 0 j into tempdefectL6 " +
                        " end " +


                        " select * from tempdefectL1 ";
                    }
                    #endregion
                    #region Baru I
                    else if (Convert.ToInt32(strtgl1.Substring(0, 6)) > 201910 && Convert.ToInt32(strtgl1.Substring(0, 6)) < 202009)
                    {
                        if (Convert.ToInt32(strtgl1.Substring(0, 6)) > 201910 && Convert.ToInt32(strtgl1.Substring(0, 6)) < 202003)
                        {
                            //query1 = " case when @TotalPotongL1>0 then isnull((select cast(A.Qty as decimal(10,2)) from tempBST1Lembar A where [group]=BM_PlantGroup.[Group]),0) else 0 end  h  ";
                            //query2 = " case when @TotalPotongL1>0 then isnull((select cast(A.Qty as decimal(10,2)) from tempBST1Lembar A where [group]=BM_PlantGroup.[Group]),0) else 0 end  h, ";
                            //query3 = " case when @TotalPotongL2>0 then isnull((select cast(A.Qty as decimal(10,2)) from tempBST1Lembar A where [group]=BM_PlantGroup.[Group]),0) else 0 end  h  ";
                            //query4 = " case when @TotalPotongL2>0 then isnull((select cast(A.Qty as decimal(10,2)) from tempBST1Lembar A where [group]=BM_PlantGroup.[Group]),0) else 0 end  h, ";
                            //query5 = " case when @TotalPotongL3>0 then isnull((select cast(A.Qty as decimal(10,2)) from tempBST1Lembar A where [group]=BM_PlantGroup.[Group]),0) else 0 end  h  ";
                            //query6 = " isnull((select cast(A.Qty as decimal(10,2)) from tempBST1Lembar A where [group]=BM_PlantGroup.[Group]),0) h, ";
                            //query7 = " isnull((select cast(A.Qty as decimal(10,2)) from tempBST1Lembar A where [group]=BM_PlantGroup.[Group]),0) h ";
                            //query8 = " isnull((select cast(A.Qty as decimal(10,2)) from tempBST1Lembar A where [group]=BM_PlantGroup.[Group]),0) h, ";
                            //query9 = " isnull((select cast(A.Qty as decimal(10,2)) from tempBST1Lembar A where [group]=BM_PlantGroup.[Group]),0) h ";
                            //query10 = " isnull((select cast(A.Qty as decimal(10,2)) from tempBST1Lembar A where [group]=BM_PlantGroup.[Group]),0) h, ";
                            //query11 = " isnull((select cast(A.Qty as decimal(10,2)) from tempBST1Lembar A where [group]=BM_PlantGroup.[Group]),0) h ";
                            //query12 = " isnull((select cast(A.Qty as decimal(10,2)) from tempBST1Lembar A where [group]=BM_PlantGroup.[Group]),0) h, ";

                            query1 = " 0 h "; query2 = " 0 h, ";
                            query3 = " 0 h "; query4 = " 0 h, ";
                            query5 = " 0 h "; query6 = " 0 h, ";
                            query7 = " 0 h "; query8 = " 0 h, ";
                            query9 = " 0 h "; query10 = " 0 h, ";
                            query11 = " 0 h "; query12 = " 0 h, ";
                        }
                        else
                        {
                            //query1 = " 0 h "; query2 = " 0 h, ";
                            //query3 = " 0 h "; query4 = " 0 h, ";
                            //query5 = " 0 h "; query6 = " 0 h, ";
                            //query7 = " 0 h "; query8 = " 0 h, ";
                            //query9 = " 0 h "; query10 = " 0 h, ";
                            //query11 = " 0 h "; query12 = " 0 h, ";
                            query1 = " case when @TotalPotongL1>0 then isnull((select cast(A.Qty as decimal(10,2)) from tempBST1Lembar A where [group]=BM_PlantGroup.[Group]),0) else 0 end  h  ";
                            query2 = " case when @TotalPotongL1>0 then isnull((select cast(A.Qty as decimal(10,2)) from tempBST1Lembar A where [group]=BM_PlantGroup.[Group]),0) else 0 end  h, ";
                            query3 = " case when @TotalPotongL2>0 then isnull((select cast(A.Qty as decimal(10,2)) from tempBST1Lembar A where [group]=BM_PlantGroup.[Group]),0) else 0 end  h  ";
                            query4 = " case when @TotalPotongL2>0 then isnull((select cast(A.Qty as decimal(10,2)) from tempBST1Lembar A where [group]=BM_PlantGroup.[Group]),0) else 0 end  h, ";
                            query5 = " case when @TotalPotongL3>0 then isnull((select cast(A.Qty as decimal(10,2)) from tempBST1Lembar A where [group]=BM_PlantGroup.[Group]),0) else 0 end  h  ";
                            query6 = " isnull((select cast(A.Qty as decimal(10,2)) from tempBST1Lembar A where [group]=BM_PlantGroup.[Group]),0) h, ";
                            query7 = " isnull((select cast(A.Qty as decimal(10,2)) from tempBST1Lembar A where [group]=BM_PlantGroup.[Group]),0) h ";
                            query8 = " isnull((select cast(A.Qty as decimal(10,2)) from tempBST1Lembar A where [group]=BM_PlantGroup.[Group]),0) h, ";
                            query9 = " isnull((select cast(A.Qty as decimal(10,2)) from tempBST1Lembar A where [group]=BM_PlantGroup.[Group]),0) h ";
                            query10 = " isnull((select cast(A.Qty as decimal(10,2)) from tempBST1Lembar A where [group]=BM_PlantGroup.[Group]),0) h, ";
                            query11 = " isnull((select cast(A.Qty as decimal(10,2)) from tempBST1Lembar A where [group]=BM_PlantGroup.[Group]),0) h ";
                            query12 = " isnull((select cast(A.Qty as decimal(10,2)) from tempBST1Lembar A where [group]=BM_PlantGroup.[Group]),0) h, ";
                        }


                        strSQL =
                        #region Temp Table
 "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempD]') AND type in (N'U')) DROP TABLE [dbo].tempD " +
                            "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempD1]') AND type in (N'U')) DROP TABLE [dbo].tempD1 " +
                            "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempD2]') AND type in (N'U')) DROP TABLE [dbo].tempD2 " +
                            "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempD3]') AND type in (N'U')) DROP TABLE [dbo].tempD3 " +
                            "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDefectOKBPNew]') AND type in (N'U')) DROP TABLE [dbo].tempDefectOKBPNew " +
                            "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTotalSerah_lmbr]') AND type in (N'U')) DROP TABLE [dbo].tempTotalSerah_lmbr " +
                            "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTotalSerah_lmbr2]') AND type in (N'U')) DROP TABLE [dbo].tempTotalSerah_lmbr2 " +
                            "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTotalSerah_lmbr3]') AND type in (N'U')) DROP TABLE [dbo].tempTotalSerah_lmbr3 " +
                            "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectGPIso]') AND type in (N'U')) DROP TABLE [dbo].[tempdefectGPIso]  " +
                            "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectGPIsoTot]') AND type in (N'U')) DROP TABLE [dbo].tempdefectGPIsoTot  " +
                            "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectFin]') AND type in (N'U')) DROP TABLE [dbo].tempdefectFin " +
                            "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectL1]') AND type in (N'U')) DROP TABLE [dbo].tempdefectL1 " +
                            "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectL2]') AND type in (N'U')) DROP TABLE [dbo].tempdefectL2 " +
                            "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectL3]') AND type in (N'U')) DROP TABLE [dbo].tempdefectL3 " +
                            "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectL4]') AND type in (N'U')) DROP TABLE [dbo].tempdefectL4 " +
                            "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectL5]') AND type in (N'U')) DROP TABLE [dbo].tempdefectL5 " +
                            "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectL6]') AND type in (N'U')) DROP TABLE [dbo].tempdefectL6 " +
                            "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectListP]') AND type in (N'U')) DROP TABLE [dbo].tempdefectListP " +
                            "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectListPOK]') AND type in (N'U')) DROP TABLE [dbo].tempdefectListPOK " +
                            "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectListP2]') AND type in (N'U')) DROP TABLE [dbo].tempdefectListP2 " +
                            "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTotalGroup]') AND type in (N'U')) DROP TABLE [dbo].tempTotalGroup " +
                            "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTotalSerahDfct]') AND type in (N'U')) DROP TABLE [dbo].tempTotalSerahDfct " +
                            "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTotalSerahLP]') AND type in (N'U')) DROP TABLE [dbo].tempTotalSerahLP " +
                            "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectListP3]') AND type in (N'U')) DROP TABLE [dbo].tempdefectListP3 " +
                            "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDataDefectBM]') AND type in (N'U')) DROP TABLE [dbo].tempDataDefectBM " +
                            "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTotalBP]') AND type in (N'U')) DROP TABLE [dbo].tempTotalBP " +
                            "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempBST1Lembar]') AND type in (N'U')) DROP TABLE [dbo].tempBST1Lembar " +
                        //"IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempD]') AND type in (N'U')) DROP TABLE [dbo].tempD " +
                        //"IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempD1]') AND type in (N'U')) DROP TABLE [dbo].tempD1 " +
                        //"IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempD2]') AND type in (N'U')) DROP TABLE [dbo].tempD2 " +
                        //"IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempD3]') AND type in (N'U')) DROP TABLE [dbo].tempD3 " +
                        #endregion

                        #region Kumpulin Data
                        "declare @bagi2 decimal(10,2) " +
                            "declare @thnbln1 varchar(8) " +
                            "declare @thnbln2 varchar(8) " +
                            "set @thnbln1='" + strtgl1 + "' " +
                            "set @thnbln2='" + strtgl2 + "' " +
                             "select *  into tempdefectGPIso from (  " +
                            "select case when D.DeptID=0 then  " +
                            "case when GJ.GroupJemurName In ('M','N','O','P','Q','R','S','T','U','V','W','X') then   " +
                            "    case when D.DefName='retak' then 2   " +
                            "        when D.DefName='gompal' then 3  " +
                            "    else D.DeptID end   " +
                            "else    " +
                            "    case when (B.Qty/E.Qty) *100 >5 then 2 else 3 end   " +
                            "end  " +
                            "else D.DeptID end deptID1,A.CreatedTime as tglInput,A.Tgl as TglPeriksa,E.TglProduksi as TglProd,  D.DefCode,BP.PlantName as Line, PG.[Group],BF.FormulaCode as Jenis,   " +
                            "D.DefName,D.DeptID,B.ID,B.DefectID,B.MasterID,B.Qty,A.ID  DestID,isnull(A.TPotong,0)  QtyIn,B.Qty*I.Volume as Kubik,isnull(A.TPotong,0) as TotPotong,'' sfrom  " +
                            "from Def_DefectDetail B inner join Def_Defect A on A.Id=B.DefectID   " +
                            "left join Def_MasterDefect D on B.MasterID=D.ID left join BM_Destacking E on E.ID=A.DestID   " +
                            "left join BM_PlantGroup PG on A.GroupProdID=PG.ID left join BM_Formula BF on BF.ID=E.FormulaID    " +
                            "left join BM_Plant BP on BP.ID=E.PlantID left join FC_Items I on I.ID=E.ItemID inner join Def_GroupJemur GJ on GJ.ID=A.GroupJemurID  " +
                            "where B.RowStatus>-1  and D.RowStatus >-1) as Def    " +
                            "where DeptID1=2 and CONVERT(varchar,TglPeriksa,112)>=@thnbln1 and CONVERT(varchar,TglPeriksa,112)<=@thnbln2  " +
                            " " +

                            "/** tempdefectListP **/ " +
                            "/** Turunan Bevel **/ " +
                            "select PlantName,[Group],sum(Qty)Qty,sum(M3)M3 into tempdefectListP " +
                            "from ( select PlantName,[group],Qty,M3  from (select PlantName,[Group],sum(Qty)Qty,sum(M3)M3 " +
                            "from (select Data3.PlantName,Data3.[Group],Data3.Qty,Data3.M3 from (select C1.PlantName,B1.[Group],Data2.Qty,M3 " +
                            "from (select B.PlantID,B.PlantGroupID,Data1.*,((C.Tebal*C.Lebar*C.Panjang)/1000000000)* Data1.Qty M3 from (select  tanggal,itemid,PartNo,Qty,DestID " +
                            "from vw_KartuStockListplankR1 " +
                            "where itemid in (select ID from FC_Items where PartNo like'%-P-%')  and CONVERT(varchar,tanggal,112)>=@thnbln1 " +
                            "and CONVERT(varchar,tanggal,112)<=@thnbln2 and qty>0 and process='i99' and ID in (select IDrec from vw_KartuStockListplank " +
                            "where process='Bevel' and qty<0 and Stat='BvToR1')) as Data1 " +
                            "INNER JOIN BM_Destacking B ON Data1.DestID=B.ID " +
                            "INNER JOIN FC_Items C ON C.ID=Data1.itemid ) as Data2 " +
                            "INNER JOIN BM_PlantGroup B1 ON Data2.PlantGroupID=B1.ID " +
                            "INNER JOIN BM_Plant C1 ON C1.ID=Data2.PlantID ) as Data3  ) as Data4 group by PlantName,[group] ) as Data5 " +

                            "union all " +

                            "/** BP dari Strapping **/  " +
                            "select PlantName,[group],Qty,M3 from (select PlantName,[group],sum(qty)Qty,sum(M3)M3 " +
                            "from (select A6.PlantName,A5.[group],A4.Qty,((A7.Tebal*A7.Lebar*A7.Panjang)/1000000000)*A4.Qty  M3 " +
                            "from (select A3.PlantID,A3.PlantGroupID,A2.Tanggal,A2.Qty,A2.ItemID from (select (select A1.PartNo " +
                            "from FC_Items A1 where A1.ID=A.ItemID)Partno,A.DestID,A.TglTrans Tanggal,A.QtyIn Qty,B.ItemID " +
                            "from T3_Rekap A INNER JOIN T1_Straping B ON A.DestID=B.DestID and A.T1SerahID=B.ID where CONVERT(varchar,A.TglTrans,112)>=@thnbln1 " +
                            "and CONVERT(varchar,A.TglTrans,112)<=@thnbln2 and A.sfrom='straping' and A.RowStatus>-1 and A.ItemID in (select ID " +
                            "from FC_Items where partno like'%-P-%') ) as A2 " +
                            "INNER JOIN BM_Destacking A3 ON A2.DestID=A3.ID ) as A4 " +
                            "INNER JOIN BM_PlantGroup A5 ON A4.PlantGroupID=A5.ID " +
                            "INNER JOIN BM_Plant A6 ON A6.ID=A4.PlantID INNER JOIN FC_Items A7 ON A7.ID=A4.ItemID ) as A8 " +
                            "group by PlantName,[Group] ) as A9 ) as Final group by PlantName,[Group] " +
                            "/** end tempdefectListP **/ " +

                            "/** tempdefectListPOK **/ " +
                            "/** OK KW dari Strapping **/ " +
                            "select PlantName,[group],Qty,(Qty*M3)M3 into tempdefectListPOK from (select PlantName,[group],sum(qty)Qty,sum(M3)M3 " +
                            "from (select A6.PlantName,A5.[group],A4.Qty,((A7.Tebal*A7.Lebar*A7.Panjang)/1000000000)M3 " +
                            "from (select A3.PlantID,A3.PlantGroupID,A2.Tanggal,A2.Qty,A2.ItemID  from (select (select A1.PartNo " +
                            "from FC_Items A1 where A1.ID=A.ItemID)Partno,A.DestID,A.TglTrans Tanggal,A.QtyIn Qty,A.ItemID from T3_Rekap A " +
                            "INNER JOIN T1_Straping B ON A.DestID=B.DestID and A.T1SerahID=B.ID where CONVERT(varchar,A.TglTrans,112)>=@thnbln1 " +
                            "and CONVERT(varchar,A.TglTrans,112)<=@thnbln2 and A.sfrom='straping' and A.RowStatus>-1 and A.ItemID in (select ID " +
                            "from FC_Items where partno like'%-3-%' or partno like'%-M-%') ) as A2 INNER JOIN BM_Destacking A3 ON A2.DestID=A3.ID ) as A4 " +
                            "INNER JOIN BM_PlantGroup A5 ON A4.PlantGroupID=A5.ID INNER JOIN BM_Plant A6 ON A6.ID=A4.PlantID " +
                            "INNER JOIN FC_Items A7 ON A7.ID=A4.ItemID ) as A8 group by PlantName,[Group] ) as A9 " +
                            "/** end tempdefectListPOK **/ " +
                            " " +

                            "/** Temp Table : tempdefectListP2 **/ " +
                            "select PlantName,[group],Qty,(Qty*M3)M3 into tempdefectListP2 from ( " +
                            "select PlantName,[group],Qty,(Qty*M3)M3 from (select PlantName,[group],sum(qty)Qty,sum(M3)M3 from ( " +
                            "select A6.PlantName,A5.[group],A4.Qty,((A7.Tebal*A7.Lebar*A7.Panjang)/1000000000)M3 from ( " +
                            "select A3.PlantID,A3.PlantGroupID,A2.Tanggal,A2.Qty,A2.ItemID from ( " +
                            "select (select A1.PartNo from FC_Items A1 where A1.ID=A.ItemID)Partno,A.DestID,A.TglTrans Tanggal,A.QtyIn Qty,A.ItemID " +
                            "from T3_Rekap A " +
                            "INNER JOIN T1_Straping B ON A.DestID=B.DestID and A.T1SerahID=B.ID where CONVERT(varchar,A.TglTrans,112)>=@thnbln1 " +
                            "and CONVERT(varchar,A.TglTrans,112)<=@thnbln2 and A.sfrom='straping' and A.RowStatus>-1 and A.ItemID in " +
                            "(select ID from FC_Items where partno like'%-P-%') ) as A2 INNER JOIN BM_Destacking A3 ON A2.DestID=A3.ID ) as A4 " +
                            "INNER JOIN BM_PlantGroup A5 ON A4.PlantGroupID=A5.ID INNER JOIN BM_Plant A6 ON A6.ID=A4.PlantID " +
                            "INNER JOIN FC_Items A7 ON A7.ID=A4.ItemID ) as A8 group by PlantName,[Group] ) as A9 ) as xx " +
                            " " +

                            "/** Tambahan Baru 18 Januari 2020 oleh Beny**/ " +
                            "declare @TotalLine int " +
                            "declare @TotalGroup int " +
                            "declare @SerahPerGroup decimal(18,2) " +

                            "set @TotalGroup = " +
                            "(select count(TotalGroup)Total from (select [group] TotalGroup from (select xx.*,A.PlantGroupID,A.PlantID from ( " +
                            "select qty,destid from vw_KartustockWIP where CONVERT(varchar,tanggal,112)>=@thnbln1 and CONVERT(varchar,tanggal,112)<=@thnbln2 " +
                            "and Lokasi in ('B99','H99') and qty<0 " +
                            "union all " +
                            "select cast(qty as decimal(10,2)) Qty,DestID from vw_KartustockWIP2 where CONVERT(varchar,tanggal,112)>=@thnbln1 and " +
                            "CONVERT(varchar,tanggal,112)<=@thnbln2 and qty<0 AND ItemID IN (SELECT ID from FC_Items where partno like'%-3-%' or " +
                            "PartNo like'%-M-%' or PartNo like'%-P-%')) as xx left join BM_Destacking A ON A.ID=xx.destid ) as xx1 " +
                            "left join BM_PlantGroup B ON B.ID=xx1.PlantGroupID left join BM_Plant C ON C.ID=xx1.PlantID  group by [group] ) as Data1) " +

                            //"set @TotalGroup = " +
                            //"(select count([group])Total from(select distinct [group] from tempTotalSerah_lmbr2 where Qty>0 ) as x) " +

                            "set @TotalLine = " +
                            "(select count(PlantName)TotalLine from(select distinct C.PlantName  from (select xx.*,A.PlantGroupID,A.PlantID from ( " +
                            "select qty,destid from vw_KartustockWIP where CONVERT(varchar,tanggal,112)>=@thnbln1 and CONVERT(varchar,tanggal,112)<=@thnbln2 " +
                            "and Lokasi in ('B99','H99') and qty<0 " +
                            "union all " +
                            "select cast(qty as decimal(10,2)) Qty,DestID from vw_KartustockWIP2 where CONVERT(varchar,tanggal,112)>=@thnbln1 " +
                            "and CONVERT(varchar,tanggal,112)<=@thnbln2 and qty<0 AND ItemID IN (SELECT ID from FC_Items where partno like'%-3-%' or " +
                            "PartNo like'%-M-%' or PartNo like'%-P-%')) as xx left join BM_Destacking A ON A.ID=xx.destid ) as xx1 " +
                            "left join BM_PlantGroup B ON B.ID=xx1.PlantGroupID left join BM_Plant C ON C.ID=xx1.PlantID ) as DataXX ) " +

                            /** Tambahan Baruuuuuuuuu **/
                            /** Data Adjust yg sdh serah **/
                            //"IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempD]') AND type in (N'U')) DROP TABLE [dbo].tempD "+
                            //"IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempD1]') AND type in (N'U')) DROP TABLE [dbo].tempD1 "+
                            //"IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempD2]') AND type in (N'U')) DROP TABLE [dbo].tempD2 "+
                            //"IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempD3]') AND type in (N'U')) DROP TABLE [dbo].tempD3 "+

                            "select A.Qty,substring(A2.PartNo,7,11)PartNo,destid into tempD from ( " +
                            "select qty * -1 qty,DestID " +
                            "from vw_KartustockWIP where CONVERT(varchar,tanggal,112)>=@thnbln1 and CONVERT(varchar,tanggal,112)<=@thnbln2 and " +
                            "Lokasi in ('B99','H99') and qty<0  and destid in (select ID from BM_Destacking where LokasiID in (select ID from FC_Lokasi " +
                            "where Lokasi like'%adj%')) " +
                            "union all  " +
                            "select cast(qty as decimal(10,2))*-1 Qty,DestID from vw_KartustockWIP2 where  " +
                            "CONVERT(varchar,tanggal,112)>=@thnbln1 and CONVERT(varchar,tanggal,112)<=@thnbln2 and qty<0 AND ItemID IN (SELECT ID from FC_Items where partno like'%-3-%' or " +
                            "PartNo like'%-M-%' or PartNo like'%-P-%') and destid in (select ID from BM_Destacking where LokasiID in (select ID from FC_Lokasi " +
                            " where Lokasi like'%adj%'))) as A " +
                            "inner join BM_Destacking A1 ON A1.ID=A.destid " +
                            "inner join FC_Items A2 ON A2.ID=A1.ItemID " +

                            "select A.*,B.PlantID,B.RowStatus into tempD1 from tempD A left join FC_ItemsAdjustDefect B ON A.PartNo=B.PartNo and B.RowStatus>-1 " +

                            "select destid,qty,PlantGroupID,PlantID,RowStatus into tempD2 from (select distinct destid,qty,PlantGroupID,PlantID,RowStatus " +
                            "from (select x.destid,x.PartNo,x.qty,x1.PlantGroupID,x1.PlantID,x.RowStatus from tempD1 as x inner join (select PlantID,PlantGroupID " +
                            "from BM_Destacking where LokasiID not in (select ID from FC_Lokasi where Lokasi like'%adj%') and " +
                            "CONVERT(varchar,tglproduksi,112)>=@thnbln1 and CONVERT(varchar,tglproduksi,112)<=@thnbln2 and RowStatus>-1) x1 ON x1.PlantID=x.PlantID ) as xx " +
                            "group by destid,PlantGroupID,qty,PlantID,RowStatus ) as x2 " +

                            "select GroupP,PlantName,sum(SubQty)Qty into tempD3 from (select GroupP,PlantName,SubQty " +
                            "from (select *,cast((qty/Ttl) as decimal(10,2)) SubQty from (select B1.PlantName,x3.*,A1.[Group]GroupP " +
                            "from (select COUNT(A.destid)Ttl,B.* from tempD2 A inner join tempD2 B ON A.destid=B.destid " +
                            "group by A.destid,B.destid,B.qty,B.PlantGroupID,B.PlantID,B.Rowstatus ) as x3 " +
                            "inner join BM_PlantGroup A1 ON A1.ID=x3.PlantGroupID " +
                            "inner join BM_Plant B1 ON B1.ID=A1.PlantID) as A1 ) as A2 ) as A3 group by GroupP,PlantName " +
                            /** end Data Adjust yg sdh serah **/

                            /** Total Defect ListPlank OK BP **/
                            "select sum(Qty)Qty,sum(M3)M3,PlantName,[Group] into tempDefectOKBPNew  from ( " +
                            /** Pemasukan ke Bevel **/
                            "/** Pemasukan ke Bevel **/ " +
                            "select sum(Qty)Qty,sum(M3)M3,PlantName,[Group] from (select x.*,B.[Group],C.PlantName,((D.Tebal*D.Lebar*D.Panjang)/1000000000)M3  " +
                            "from (select sum(QtyIn)Qty,DestID,ItemID from T1_Straping " +
                            "where CONVERT(varchar,TglTrans,112)>=@thnbln1 and CONVERT(varchar,TglTrans,112)<=@thnbln2 " +
                            "and RowStatus>-1 and L1ID in (select ID from T1_Bevel where RowStatus >-1) group by DestID,ItemID ) as x " +
                            "LEFT JOIN BM_Destacking A ON A.ID=x.DestID " +
                            "LEFT JOIN BM_PlantGroup B ON B.ID=A.PlantGroupID " +
                            "LEFT JOIN BM_Plant C ON C.ID=A.PlantID " +
                            "LEFT JOIN FC_Items D ON D.ID=x.ItemID) as x2 group by [group],PlantName " +
                            "union all " +
                            /** BP Strapping **/
                            "select sum(Qty)*-1 Qty,sum(M3)M3,PlantName,[Group] from (select PlantName,[group],sum(qty)Qty,sum(M3)M3 " +
                            "from (select A6.PlantName,A5.[group],A4.Qty,((A7.Tebal*A7.Lebar*A7.Panjang)/1000000000)M3 " +
                            "from (select A3.PlantID,A3.PlantGroupID,A2.Tanggal,A2.Qty,A2.ItemID " +
                            "from (select (select A1.PartNo from FC_Items A1 where A1.ID=A.ItemID)Partno,A.DestID,A.TglTrans Tanggal,A.QtyIn Qty,A.ItemID " +
                            "from T3_Rekap A INNER JOIN T1_Straping B ON A.DestID=B.DestID and A.T1SerahID=B.ID " +
                            "where CONVERT(varchar,A.TglTrans,112)>=@thnbln1 and CONVERT(varchar,A.TglTrans,112)<=@thnbln2 " +
                            "and A.sfrom='straping' and A.RowStatus>-1 and A.ItemID in (select ID from FC_Items where partno like'%-P-%') ) as A2 " +
                            "INNER JOIN BM_Destacking A3 ON A2.DestID=A3.ID ) as A4 " +
                            "INNER JOIN BM_PlantGroup A5 ON A4.PlantGroupID=A5.ID " +
                            "INNER JOIN BM_Plant A6 ON A6.ID=A4.PlantID INNER JOIN FC_Items A7 ON A7.ID=A4.ItemID ) as A8 group by PlantName,[Group] ) as A9 " +
                            "group by [group],PlantName " +
                            "union all " +
                            /** Defect ListPlank BP **/
                            "select sum(Qty)Qty,sum(M3)M3,PlantName,[Group] from tempdefectListP group by [group],PlantName  " +
                            ") as DataFinal group by [group],PlantName " +
                            /** end Total Defect ListPlank OK BP **/

                            ///** Total Defect ListPlank OK BP **/
                            ////"IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDefectOKBPNew]') AND type in (N'U')) DROP TABLE [dbo].tempDefectOKBPNew "+
                            ///** I. BP ListPlank **/
                            ///** BP dari Bevel **/
                            //"select sum(Qty)Qty,PlantName,[Group] into tempDefectOKBPNew  from ( " +
                            //"select sum(Qty)Qty,PlantName,[Group]  from ( select PlantName,[group],Qty  " +
                            //"from (select PlantName,[Group],sum(Qty)Qty from (select Data3.PlantName,Data3.[Group],Data3.Qty "+
                            //"from (select C1.PlantName,B1.[Group],Data2.Qty from (select B.PlantID,B.PlantGroupID,Data1.*, "+
                            //"((C.Tebal*C.Lebar*C.Panjang)/1000000000)Volume from (select  tanggal,itemid,PartNo,Qty,DestID from vw_KartuStockListplankR1 "+
                            //"where itemid in (select ID from FC_Items where PartNo like'%-P-%')  and CONVERT(varchar,tanggal,112)>=@thnbln1 and CONVERT(varchar,tanggal,112)<=@thnbln2 " +
                            //"and qty>0 and process='i99' and ID in (select IDrec from vw_KartuStockListplank where process='Bevel' and qty<0 and Stat='BvToR1')) as Data1 "+
                            //"INNER JOIN BM_Destacking B ON Data1.DestID=B.ID "+
                            //"INNER JOIN FC_Items C ON C.ID=Data1.itemid ) as Data2 "+ 
                            //"INNER JOIN BM_PlantGroup B1 ON Data2.PlantGroupID=B1.ID "+
                            //"INNER JOIN BM_Plant C1 ON C1.ID=Data2.PlantID ) as Data3  ) as Data4 group by PlantName,[group] ) as Data5 "+
                            //"union all "+
                            ///** BP dari Strapping **/  
                            //"select PlantName,[group],Qty from (select PlantName,[group],sum(qty)Qty "+
                            //"from (select A6.PlantName,A5.[group],A4.Qty "+
                            //"from (select A3.PlantID,A3.PlantGroupID,A2.Tanggal,A2.Qty,A2.ItemID "+
                            //"from (select (select A1.PartNo from FC_Items A1 where A1.ID=A.ItemID)Partno,A.DestID,A.TglTrans Tanggal,A.QtyIn Qty,A.ItemID "+
                            //"from T3_Rekap A INNER JOIN T1_Straping B ON A.DestID=B.DestID and A.T1SerahID=B.ID "+
                            //"where CONVERT(varchar,A.TglTrans,112)>=@thnbln1 and CONVERT(varchar,A.TglTrans,112)<=@thnbln2 " +
                            //"and A.sfrom='straping' and A.RowStatus>-1 and A.ItemID in (select ID from FC_Items where partno like'%-P-%') ) as A2 "+
                            //"INNER JOIN BM_Destacking A3 ON A2.DestID=A3.ID ) as A4 "+
                            //"INNER JOIN BM_PlantGroup A5 ON A4.PlantGroupID=A5.ID "+
                            //"INNER JOIN BM_Plant A6 ON A6.ID=A4.PlantID INNER JOIN FC_Items A7 ON A7.ID=A4.ItemID ) as A8 "+
                            //"group by PlantName,[Group] ) as A9 ) as Final  group by PlantName,[Group] "+
                            //"union all "+
                            ///** II. OK KW ListPlank ( Pemasukan dari Bevel ) **/
                            //"select sum(Qty)Qty,PlantName,[Group] from (select x.*,B.[Group],C.PlantName  " +
                            //"from (select sum(QtyIn)Qty,DestID,ItemID from T1_Straping "+
                            //"where CONVERT(varchar,TglTrans,112)>=@thnbln1 and CONVERT(varchar,TglTrans,112)<=@thnbln2 " +
                            //"and RowStatus>-1 and L1ID in (select ID from T1_Bevel where RowStatus >-1) group by DestID,ItemID ) as x "+
                            //"LEFT JOIN BM_Destacking A ON A.ID=x.DestID "+
                            //"LEFT JOIN BM_PlantGroup B ON B.ID=A.PlantGroupID "+
                            //"LEFT JOIN BM_Plant C ON C.ID=A.PlantID "+
                            //"LEFT JOIN FC_Items D ON D.ID=x.ItemID) as x2 group by [group],PlantName ) as DataFinal group by [group],PlantName "+

                            //"union all "+
                            ///** Pengurangan BP straping  **/
                            //"select Qty * -1 Qty,PlantName,[Group] from (select PlantName,[group],sum(qty)Qty  "+
                            //"from (select A6.PlantName,A5.[group],A4.Qty "+
                            //"from (select A3.PlantID,A3.PlantGroupID,A2.Tanggal,A2.Qty,A2.ItemID "+
                            //"from (select (select A1.PartNo from FC_Items A1 where A1.ID=A.ItemID)Partno,A.DestID,A.TglTrans Tanggal,A.QtyIn Qty,A.ItemID "+
                            //"from T3_Rekap A INNER JOIN T1_Straping B ON A.DestID=B.DestID and A.T1SerahID=B.ID "+
                            //"where CONVERT(varchar,A.TglTrans,112)>=@thnbln1 and CONVERT(varchar,A.TglTrans,112)<=@thnbln2   " +
                            //"and A.sfrom='straping' and A.RowStatus>-1 and A.ItemID in (select ID from FC_Items where partno like'%-P-%') ) as A2  "+
                            //"INNER JOIN BM_Destacking A3 ON A2.DestID=A3.ID ) as A4 "+
                            //"INNER JOIN BM_PlantGroup A5 ON A4.PlantGroupID=A5.ID  "+
                            //"INNER JOIN BM_Plant A6 ON A6.ID=A4.PlantID INNER JOIN FC_Items A7 ON A7.ID=A4.ItemID ) as A8  "+
                            //"group by PlantName,[Group] ) as A9 "+
                            ///** end Pengurangan BP straping  **/
                            ///** end tempDefectOKBPNew **/

                            ///** Total Serah Tahap I ke Tahap III **/
                            //"IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTotalSerah_Lmb]') AND type in (N'U')) DROP TABLE [dbo].tempTotalSerah_Lmb " +
                            //"IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTotalSerahF]') AND type in (N'U')) DROP TABLE [dbo].tempTotalSerahF "+
                            //"select Qty,[group],PlantName into tempTotalSerah_Lmb from ( " +
                            //"select sum(Qty)Qty,[group],PlantName from ( "+
                            //"select * from ( "+
                            //"select cast(Qty as decimal(10,2)) +   "+
                            //"(select sum(qty)/@TotalGroup Qty from (select sum(QtyIn)Qty from T3_Simetris " +
                            //"where ID in (select CutID from vw_KartuStockBJNew where CONVERT(varchar,tanggal,112)>=@thnbln1 and CONVERT(varchar,tanggal,112)<=@thnbln2 " +
                            //"and ItemID IN (SELECT ID from FC_Items where partno like'%-3-%' or partno like'%-M-%') and Process like'%simetris%' "+
                            //"and Keterangan like'%-1-%' and CutID in (select ID from T3_Simetris where QtyIn<QtyOut and RowStatus>-1)) "+
                            //"and RowStatus>-1 union all "+
                            //"select sum(QtyIn)Qty from T3_Simetris "+
                            //"where ID in (select CutID from vw_KartuStockBJNew where CONVERT(varchar,tanggal,112)>=@thnbln1 and CONVERT(varchar,tanggal,112)<=@thnbln2 " +
                            //"and ItemID IN (SELECT ID from FC_Items where partno like'%-P-%') and Process like'%simetris%' and Keterangan like'%-1-%' "+
                            //"and CutID in (select ID from T3_Simetris where QtyIn<QtyOut and RowStatus>-1)) and RowStatus>-1  "+
                            //"union all "+
                            //"select sum(qty) Qty from vw_KartuStockBJNew where CONVERT(varchar,tanggal,112)>=@thnbln1 and CONVERT(varchar,tanggal,112)<=@thnbln2 " +
                            //"and ItemID IN (SELECT ID from FC_Items where partno like'%-3-%' or PartNo like'%-M-%' or PartNo like'%-P-%') and "+
                            //"Process like'%simetris%' and Keterangan like'%-1-%' and CutID in (select ID from T3_Simetris "+
                            //"where QtyIn=QtyOut and RowStatus>-1)) as xx) Qty,[group],PlantName "+
                            //"from ( "+
                            //"select sum(qty)Qty,[group],PlantName from ( "+
                            //"select cast(sum(qty) as decimal(10,2)) Qty,[group],PlantName from (select xx1.*,B.[Group],C.PlantName  "+
                            //"from (select xx.*,A.PlantGroupID,A.PlantID from ( "+
                            ///** Mutasi WiP **/
                            //"select qty * -1 qty,destid from vw_KartustockWIP where CONVERT(varchar,tanggal,112)>=@thnbln1 and CONVERT(varchar,tanggal,112)<=@thnbln2 " +
                            //"and Lokasi in ('B99','H99') and qty<0  and destid in (select ID from BM_Destacking "+
                            //"where LokasiID not in (select ID from FC_Lokasi where Lokasi like'%adj%')) "+
                            //"union all "+
                            //"select cast(qty as decimal(10,2))*-1 Qty,DestID from vw_KartustockWIP2 "+
                            //"where CONVERT(varchar,tanggal,112)>=@thnbln1 and CONVERT(varchar,tanggal,112)<=@thnbln2 and qty<0 " +
                            //"AND ItemID IN (SELECT ID from FC_Items where partno like'%-3-%' or PartNo like'%-M-%' or PartNo like'%-P-%') "+
                            //"and destid in (select ID from BM_Destacking where LokasiID not in (select ID from FC_Lokasi where Lokasi like'%adj%')) "+
                            ///** end Mutasi WiP **/
                            //") as xx "+
                            //"left join BM_Destacking A ON A.ID=xx.destid ) as xx1 "+
                            //"left join BM_PlantGroup B ON B.ID=xx1.PlantGroupID left join BM_Plant C ON C.ID=xx1.PlantID ) as AA  group by [group],PlantName "+
                            //"union all "+
                            //"select cast(Qty as decimal(10,2))Qty,GroupP [group],PlantName from tempD3 ) as Datax group by [group],PlantName ) as x0  ) as x00 "+
                            //"union all "+
                            //"select cast(Qty as decimal(10,2))Qty,[group],PlantName from tempDefectOKBPNew ) as x01 group by [group],PlantName ) as D "+
                            ///** end Tambahan Baruuuuuuuuu **/

                            //"IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTotalSerah_lmbr]') AND type in (N'U')) DROP TABLE [dbo].tempTotalSerah_lmbr "+
                            //"IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTotalSerah_lmbr2]') AND type in (N'U')) DROP TABLE [dbo].tempTotalSerah_lmbr2 "+

                            "declare @BagiRata decimal(10,2) " +
                            "declare @TotalGroupAktif decimal(10,2) " +

                            /** Tambahan or partno like'%-P-%' **/
                            "set @BagiRata= " +
                            "(select cast(sum(Qty)as decimal(10,2)) Qty " +
                            "from ( select sum(Qty)Qty from ( select sum(A1.QtyIn) Qty from T3_Simetris A1 inner join T3_Serah A2 ON A1.SerahID=A2.ID " +
                            "inner join FC_Items A3 ON A3.ID=A2.ItemID where A1.ID in (select CutID from vw_KartuStockBJNew " +
                            "where CONVERT(varchar,tanggal,112)>=@thnbln1 and CONVERT(varchar,tanggal,112)<=@thnbln2 and ItemID " +
                            "IN (SELECT ID from FC_Items where partno like'%-3-%' or partno like'%-M-%' or partno like'%-P-%') and /**Process like'%simetris%'**/ " +
                            "Process='simetris' and Keterangan like'%-1-%' and CutID in (select ID from T3_Simetris where QtyIn<QtyOut and RowStatus>-1)) " +
                            " and A1.RowStatus>-1 group by A3.Tebal,A3.Lebar,A3.Panjang ) as xx " +

                            " union all " +

                            /** ASimetris OK KW - Defect Ukuran Khusus **/
                            " /** ASimetris OK KW - Defect Ukuran Khusus **/  " +
                            "select sum(Qty)*-1 Qty from ( select qty from vw_KartuStockBJNew where PartNo like'%-1-%' and qty<0 and  " +
                            "CONVERT(varchar,tanggal,112)>=@thnbln1 and CONVERT(varchar,tanggal,112)<=@thnbln2 and Process='ASimetris') as xx  " +

                            "union all " +

                            "select sum(qty)Qty from vw_KartuStockBJNew A inner join FC_Items B ON A.ItemID=B.ID " +
                            "where CONVERT(varchar,tanggal,112)>=@thnbln1 and CONVERT(varchar,tanggal,112)<=@thnbln2 and " +
                            "ItemID IN (SELECT ID from FC_Items where partno like'%-3-%' or PartNo like'%-M-%' or PartNo like'%-P-%') and " +
                            "Process='simetris' and Keterangan like'%-1-%' and CutID in (select ID from T3_Simetris where QtyIn=QtyOut and RowStatus>-1)) " +

                            /**
                            "union all " +
                            
                            "select sum(Qty)Qty from ( select sum(QtyIn)Qty from T3_Simetris B1 inner join T3_Serah B2 ON B1.SerahID=B2.ID " +
                            "inner join FC_Items B3 ON B3.ID=B2.ItemID where B1.ID in (select CutID from vw_KartuStockBJNew " +
                            "where CONVERT(varchar,tanggal,112)>=@thnbln1 and CONVERT(varchar,tanggal,112)<=@thnbln2 and " +
                            "ItemID IN (SELECT ID from FC_Items where partno like'%-P-%') and Process like'%simetris%' and " +
                            "Keterangan like'%-1-%' and CutID in (select ID from T3_Simetris where QtyIn<QtyOut and RowStatus>-1)) " +
                            "and B1.RowStatus>-1  group by B3.Tebal,B3.Lebar,B3.Panjang ) as xxx )  
                            **/

                            "as x ) " +


                            "select Qty,[group],PlantName into tempTotalSerah_lmbr from ( " +
                            "select sum(Qty)Qty,[group],PlantName from ( " +
                            "select Qty,[group],PlantName from ( " +
                            "select Qty,[group],PlantName " +
                            "from ( " +
                            "select sum(qty)Qty,[group],PlantName from ( " +
                            "select cast(sum(qty) as decimal(10,2)) Qty,[group],PlantName from (select xx1.*,B.[Group],C.PlantName  " +
                            "from (select xx.*,A.PlantGroupID,A.PlantID from ( " +
                            /** Mutasi WiP **/
                            "select qty * -1 qty,destid from vw_KartustockWIP A inner join FC_Items B ON A.itemid0=B.ID " +
                            "where CONVERT(varchar,tanggal,112)>=@thnbln1 and CONVERT(varchar,tanggal,112)<=@thnbln2 " +
                            "and Lokasi in ('B99','H99') and qty<0  and destid in (select ID from BM_Destacking " +
                            "where LokasiID not in (select ID from FC_Lokasi where Lokasi like'%adj%')) " +
                            "union all " +
                            "select cast(A1.Qty as decimal(10,2))*-1 Qty,DestID from vw_KartustockWIP2 A1 " +
                            "inner join FC_Items B1 ON A1.itemid0=B1.ID " +
                            "where CONVERT(varchar,tanggal,112)>=@thnbln1 and CONVERT(varchar,tanggal,112)<=@thnbln2 " +
                            "and qty<0 AND ItemID IN (SELECT ID from FC_Items where partno like'%-3-%' or PartNo like'%-M-%' or PartNo like'%-P-%') " +
                            "and destid in (select ID from BM_Destacking where LokasiID not in (select ID from FC_Lokasi where Lokasi like'%adj%')) " +
                            /** end Mutasi WiP **/

                            ") as xx left join BM_Destacking A ON A.ID=xx.destid ) as xx1 left join BM_PlantGroup B ON B.ID=xx1.PlantGroupID " +
                            "left join BM_Plant C ON C.ID=xx1.PlantID ) as AA  group by [group],PlantName " +
                            "union all " +
                            /** total adjust **/
                            "select cast(Qty as decimal(10,2))Qty,GroupP [group],PlantName from tempD3 ) as Datax " +
                            "group by [group],PlantName ) as x0  ) as x00 ) as x01 group by [group],PlantName ) as D " +

                            "select * into tempTotalSerah_lmbr2 from ( " +
                            "select 'A'Urut,cast(sum(Qty) as decimal(10,3)) Qty,[group],PlantName from tempTotalSerah_lmbr  group by [group],PlantName " +
                            "union all " +
                            "select 'B'Urut,cast(sum(Qty) as decimal(10,3)) Qty,[group],PlantName from tempDefectOKBPNew  group by [group],PlantName ) as xm  " +

                            "set @TotalGroupAktif = (select count(distinct [group])Total from tempTotalSerah_lmbr2  where qty > 0) " +

                            "select cast(Qty+(cast(@BagiRata as decimal(10,4))/(select count(distinct [group])Total from tempTotalSerah_lmbr2)) as decimal(10,2))Qty,[group],PlantName " +
                            "into tempTotalSerah_lmbr3 from (select sum(Qty)Qty,[group],PlantName from tempTotalSerah_lmbr2  group by [group],PlantName ) as xx " +


                            /** Defect Produksi **/
                            /** BP yang keluar dari proses Simetris u/ produk Ukuran Khusus **/
                            "declare @DefectBMperGroup decimal(18,2) " +
                            "set @DefectBMperGroup = (select cast((sum(Qty)/@TotalGroup) as decimal(10,2)) Qty from (select sum(xx.Qty) Qty " +
                            "from (select sum(QtyIn) Qty,SerahID from T3_Simetris where ID in (select CutID from vw_KartuStockBJNew " +
                            "where CONVERT(varchar,tanggal,112)>=@thnbln1 and CONVERT(varchar,tanggal,112)<=@thnbln2 and ItemID IN (SELECT ID from FC_Items where partno like'%-P-%') and " +
                            "Process like'%simetris%' and Keterangan like'%-1-%' and CutID in (select ID from T3_Simetris where QtyIn<QtyOut and RowStatus>-1)) " +
                            "and RowStatus>-1 group by SerahID ) as xx inner join T3_Serah A ON A.ID=xx.SerahID inner join FC_Items B ON B.ID=A.ItemID " +
                            "union all " +
                            "/** BP yg keluar dari Mesin Cutter dan ketika di potong menghasilkan 1 Produk **/ " +
                            "select cast(sum(xx.Qty) as decimal(10,2)) Qty from (select sum(Qty)qty,SerahID from vw_KartuStockBJNew  " +
                            "where CONVERT(varchar,tanggal,112)>=@thnbln1 and CONVERT(varchar,tanggal,112)<=@thnbln2 and ItemID IN (SELECT ID from FC_Items where  PartNo like'%-P-%') " +
                            "and Process like'%simetris%' and Keterangan like'%-1-%' and CutID in (select ID from T3_Simetris where QtyIn=QtyOut and RowStatus>-1) " +
                            "group by SerahID ) as xx inner join T3_Serah A1 ON A1.ID=xx.SerahID inner join FC_Items A2 ON A2.ID=A1.ItemID ) as xx1) " +

                            /** temp Table tempDataDefectBM **/

                            "declare @DefectBagi decimal(18,2) " +

                            "set @DefectBagi=(select cast((sum(Qty)/(select count(distinct [group]) from tempTotalSerah_lmbr2)) as decimal(10,2)) Qty from (select sum(xx.Qty) Qty  " +
                            "from (select sum(QtyIn) Qty,SerahID from T3_Simetris where ID in (select CutID from vw_KartuStockBJNew " +
                            "where CONVERT(varchar,tanggal,112)>=@thnbln1 and CONVERT(varchar,tanggal,112)<=@thnbln2 " +
                            "and ItemID IN (SELECT ID from FC_Items where partno like'%-P-%') and " +
                            " /**Process like'%simetris%'**/ Process='Simetris' and Keterangan like'%-1-%' and CutID in (select ID from T3_Simetris where QtyIn<QtyOut and RowStatus>-1)) " +
                            "and RowStatus>-1 group by SerahID ) as xx inner join T3_Serah A ON A.ID=xx.SerahID " +
                            "inner join FC_Items B ON B.ID=A.ItemID " +
                            "union all " +
                            /** BP yg keluar dari Mesin Cutter dan ketika di potong menghasilkan 1 Produk **/
                            "select cast(sum(xx.Qty) as decimal(10,2)) Qty from (select sum(Qty)qty,SerahID from vw_KartuStockBJNew   " +
                            "where CONVERT(varchar,tanggal,112)>=@thnbln1 and CONVERT(varchar,tanggal,112)<=@thnbln2 and " +
                            "ItemID IN (SELECT ID from FC_Items where  PartNo like'%-P-%')  " +
                            "and /**Process like'%simetris%'**/ Process='Simetris' and Keterangan like'%-1-%' and CutID in (select ID from T3_Simetris where QtyIn=QtyOut and RowStatus>-1) " +
                            "group by SerahID ) as xx inner join T3_Serah A1 ON A1.ID=xx.SerahID inner join FC_Items A2 ON A2.ID=A1.ItemID ) as xx1) " +

                            "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempT]') AND type in (N'U')) DROP TABLE [dbo].[tempT] " +
                            "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDataDefectBM]') AND type in (N'U')) DROP TABLE [dbo].[tempDataDefectBM] " +

                            "select cast(Qty as decimal(10,2))Qty,[group],PlantName into tempT from (select cast(sum(Qty) as decimal(10,2)) Qty,[group],PlantName from ( " +
                            /** BP ListPlank ada informasi Group Produksi **/
                            "select qty,[group],PlantName from tempdefectListP  " +
                            "union all  " +
                            /** BP yg keluar dari proses Tahap I (Produk Pelarian - Produk Normal ) ada informasi Group Produksi **/
                            "select qty,[group],PlantName from (select sum(qty)Qty,[group],PlantName from (select xx.*,A2.[Group],A3.PlantName from ( " +
                            "select sum(qty*-1)qty,destid from vw_KartustockWIP A inner join FC_Items B ON A.itemid0=B.ID  " +
                            "where CONVERT(varchar,tanggal,112)>=@thnbln1 and CONVERT(varchar,tanggal,112)<=@thnbln2 " +
                            "and Lokasi='B99' and destid not in (select ID from BM_Destacking where LokasiID in (select ID from FC_Lokasi " +
                            "where Lokasi like'%adj%')) and qty<0  group by destid " +
                            "union all  " +
                            "select sum(qty *-1)qty,destid from vw_KartustockWIP2 A inner join FC_Items B ON A.itemid0=B.ID  " +
                            "where CONVERT(varchar,tanggal,112)>=@thnbln1 and CONVERT(varchar,tanggal,112)<=@thnbln2 and qty<0 " +
                            "AND ItemID IN (SELECT ID from FC_Items where partno like'%-P-%' ) " +
                            "and destid not in (select ID from BM_Destacking where LokasiID in (select ID from FC_Lokasi where Lokasi like'%adj%')) " +
                            "group by DestID) as xx inner join BM_Destacking A1 ON A1.ID=xx.destid inner join BM_PlantGroup A2 ON A2.ID=A1.PlantGroupID " +
                            "inner join BM_Plant A3 ON A3.ID=A1.PlantID ) as xx1 group by [group],PlantName ) as bb ) as xx2 group by [group],PlantName ) as xx3   " +
                            /** End Defect Produksi **/

                            "select Qty,[group],PlantName into tempDataDefectBM from ( " +
                            "select sum(Qty)+ (@DefectBagi) Qty,[group],PlantName from ( " +
                            "select Qty,[group],PlantName from ( " +
                            "select 0'Qty',x.[group],x2.PlantName from (select distinct [group] from tempTotalSerah_lmbr2) as x " +
                            "inner join BM_PlantGroup x1 ON x.[group]=x1.[Group] inner join BM_Plant x2 ON x2.ID=x1.PlantID ) as x3 " +
                            "union all " +
                            "select * from tempT " +
                            "union all " +
                            "select Qty,[group],PlantName from (select *,(select distinct qty / count(destid) Qty from tempD2 where RowStatus=1 " +
                            "group by qty)Qty from ( " +
                            "select x1.[Group],x2.PlantName from (select PlantGroupID,PlantID from tempD2 where RowStatus=1 ) as x  " +
                            "inner join BM_PlantGroup x1 ON x.PlantGroupID=x1.ID " +
                            "inner join BM_Plant x2 ON x2.ID=x.PlantID ) as xx ) as xx2 " +
                            ") as x5 group by [group],PlantName ) as cc " +

                            //"select round(sum(Qty),0)Qty from tempDataDefectBM "+


                            //"select cast(Qty as decimal(10,2))Qty,[group],PlantName into tempDataDefectBM from (select cast(sum(Qty) as decimal(10,2))+ " +
                            //"@DefectBMperGroup Qty,[group],PlantName from ( " +
                            //"/** BP ListPlank ada informasi Group Produksi **/ " +
                            //"select qty,[group],PlantName from tempdefectListP " +
                            //"union all " +
                            //"/** BP yg keluar dari proses Tahap I (Produk Pelarian - Produk Normal ) ada informasi Group Produksi **/ " +
                            //"select qty,[group],PlantName from (select sum(qty)Qty,[group],PlantName from (select xx.*,A2.[Group],A3.PlantName from ( " +
                            //"select sum(qty*-1)qty,destid from vw_KartustockWIP A inner join FC_Items B ON A.itemid0=B.ID " +
                            //"where CONVERT(varchar,tanggal,112)>=@thnbln1 and CONVERT(varchar,tanggal,112)<=@thnbln2 and Lokasi='B99' and qty<0  group by destid " +
                            //"union all " +
                            //"select sum(qty *-1)qty,destid from vw_KartustockWIP2 A inner join FC_Items B ON A.itemid0=B.ID " +
                            //"where CONVERT(varchar,tanggal,112)>=@thnbln1 and CONVERT(varchar,tanggal,112)<=@thnbln2 and qty<0 AND ItemID IN (SELECT ID from FC_Items where partno like'%-P-%' ) " +
                            //"group by DestID) as xx inner join BM_Destacking A1 ON A1.ID=xx.destid inner join BM_PlantGroup A2 ON A2.ID=A1.PlantGroupID " +
                            //"inner join BM_Plant A3 ON A3.ID=A1.PlantID ) as xx1 group by [group],PlantName ) as bb ) as xx2 group by [group],PlantName ) as xx3  " +
                            //"/** End Defect Produksi **/ " +
                            /**Baru**/

                            /** temp Table tempBST1Lembar **/
                            " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempitembsauto2L]') AND type in (N'U')) " +
                            " DROP TABLE [dbo].[tempitembsauto2L]  " +

                            " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempKartuStockBJNew2L]') AND type in (N'U')) " +
                            " DROP TABLE [dbo].[tempKartuStockBJNew2L]  " +

                            " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempitembs]') AND type in (N'U')) " +
                            " DROP TABLE [dbo].[tempitembs] " +

                            " select distinct itemid into tempitembsauto2L from vw_KartuStockBJNew " +
                            " where itemid in (select ID from fc_items where partno like '%-s-%') and LokID in (select ID from FC_Lokasi where Lokasi='bsauto') " +

                            " select * into tempitembs from vw_KartuStockBJNew where left(CONVERT(char, tanggal ,112),8)>=@thnbln1 " +
                            " and left(CONVERT(char, tanggal ,112),8)<=@thnbln2 and itemID not in  (select itemid from tempitembsauto2)  " +

                            " select * into tempKartuStockBJNew2L from vw_KartuStockBJNew " +
                            " where left(CONVERT(char, tanggal ,112),8)>=@thnbln1 and left(CONVERT(char, tanggal ,112),8)<=@thnbln2 and " +
                            " itemID in  (select itemid from tempitembsauto2L)  " +

                            "set @bagi2= " +

                            " ( select (round(sum(Qty),1)/@TotalGroup) Qty from ( " +
                            " select sum(Qty) Qty from (select (x1.Qty)Qty " +
                            " from (select X.qty,A.ItemID  from (select sum(qty)qty,SerahID from tempKartuStockBJNew2L " +
                            " where (process='direct' or process='Simetris') and (isnull(sfrom,'-')='-' or isnull(sfrom,'bevel')='-' or " +
                            " isnull(sfrom,'-')='straping') and substring(Keterangan,1,21) " +
                            " like '%-1-%' and ItemID in (select ID from FC_Items where PartNo like'%-S-%') and CONVERT(varchar,Tanggal,112)>=@thnbln1 and " +
                            " CONVERT(varchar,Tanggal,112)<=@thnbln2 group by SerahID ) " +
                            "as x inner join T3_Serah A ON A.ID=x.SerahID) as x1 inner join FC_Items A1 ON A1.ID=x1.ItemID ) as x0 " +

                            " union all " +

                            " select sum(Qty) Qty from (select (x1.Qty)Qty " +
                            "from (select X.qty,A.ItemID  from (select sum(qty)qty,SerahID from tempitembs " +
                            " where (process='direct' or process='Simetris') and (isnull(sfrom,'-')='-' or isnull(sfrom,'bevel')='-' or " +
                            " isnull(sfrom,'-')='straping') and substring(Keterangan,1,21) " +
                            " like '%-1-%' and ItemID in (select ID from FC_Items where PartNo like'%-S-%') and CONVERT(varchar,Tanggal,112)>=@thnbln1 and " +
                            " CONVERT(varchar,Tanggal,112)<=@thnbln2 group by SerahID ) " +
                            "as x inner join T3_Serah A ON A.ID=x.SerahID) as x1 inner join FC_Items A1 ON A1.ID=x1.ItemID ) as x1 " +

                            ") as AA )" +

                            "select [group],PlantName,cast(sum(Qty) as decimal(10,2))Qty into tempBST1Lembar from  (select groupP [group],case when GroupP in ('KA','KB','KC','KD') " +
                            "then 'LINE 1' when GroupP in ('KE','KF','KG','KH') then 'LINE 2' when GroupP in ('KI','KJ','KK','KL') then 'LINE 3' " +
                            "when GroupP in ('KM','KN','KO','KP') then 'LINE 4' when GroupP in ('KQ','KR','KS','KT') then 'LINE 5' " +
                            "when GroupP in ('KU','KV','KW','KX') then 'LINE 6' end PlantName,'0' + cast(@bagi2 as decimal(10,2)) Qty  " +
                            "from (select GroupP from (select [group] GroupP from (select xx.*,A.PlantGroupID,A.PlantID " +
                            "from ( select qty Qty,destid from vw_KartustockWIP " +
                            "where CONVERT(varchar,Tanggal,112)>=@thnbln1 and CONVERT(varchar,Tanggal,112)<=@thnbln2 " +
                            "and Lokasi in ('B99','H99') and qty<0 union all select cast(qty as decimal(10,2)) Qty,DestID " +
                            "from vw_KartustockWIP2 " +
                            "where CONVERT(varchar,Tanggal,112)>=@thnbln1 and CONVERT(varchar,Tanggal,112)<=@thnbln2 and qty<0 AND ItemID IN " +
                            "(SELECT ID from FC_Items where partno like'%-3-%' or PartNo like'%-M-%' or PartNo like'%-P-%')) as xx " +
                            "left join BM_Destacking A ON A.ID=xx.destid where A.PlantGroupID>0 and A.PlantID>0) as xx1 " +
                            "left join BM_PlantGroup B ON B.ID=xx1.PlantGroupID left join BM_Plant C ON C.ID=xx1.PlantID  group by [group] ) as Data1) as p  " +
                            "union all " +
                            /** BS dari Listplank pertama **/
                            "select [group],PlantName,cast(sum(Qty) as decimal(10,2)) Qty from (select x2.DestID,x2.Qty,B1.[Group],B2.PlantName " +
                            "from (select x1.DestID,(x1.QtyIn)Qty from (select *,case when sfrom='straping' " +
                            "then (select A.ItemID0 from T1_Straping A where A.ID=T1SerahID) when sfrom='Bevel' then (select A1.ItemID0 from T1_Bevel A1 " +
                            "where A1.ID=T1SerahID) end ItemID0 from (select Sfrom,QtyIn,DestID,T1SerahID from T3_Rekap where Keterangan like'%-1-%' " +
                            "and ItemID in (select ID from FC_Items where partno like'%-S-%') and CONVERT(varchar,TglTrans,112)>=@thnbln1 and " +
                            "CONVERT(varchar,TglTrans,112)<=@thnbln2 and Process='direct' and (sfrom='straping' or Sfrom='Bevel')) as x ) as x1 inner join FC_Items A2 ON A2.ID=x1.ItemID0 ) as x2 " +
                            "inner join BM_Destacking B ON B.ID=x2.DestID inner join BM_PlantGroup B1 ON B1.ID=B.PlantGroupID " +
                            "inner join BM_Plant B2 ON B2.ID=B.PlantID ) as x3 group by [Group],PlantName) as Dt group by [group],PlantName " +
                            /** end Data BS Tahap I **/

                            "/** Temp Table = tempTotalSerahDfct **/ " +
                            "select * into tempTotalSerahDfct from (select cast(sum(qty *-1) as decimal(10,2)) + " +
                            "(select sum(qty)/@TotalGroup Qty from (select sum(QtyIn)Qty from T3_Simetris where ID in (select CutID from vw_KartuStockBJNew " +
                            "where CONVERT(varchar,tanggal,112)>=@thnbln1 and CONVERT(varchar,tanggal,112)<=@thnbln2 and ItemID IN (SELECT ID from FC_Items " +
                            "where partno like'%-3-%' or " +
                            "partno like'%-M-%') and Process like'%simetris%' and Keterangan like'%-1-%' and CutID in (select ID from T3_Simetris " +
                            "where QtyIn<QtyOut and RowStatus>-1)) and RowStatus>-1 " +
                            "union all " +
                            "select sum(QtyIn)Qty from T3_Simetris where ID in (select CutID from vw_KartuStockBJNew where " +
                            "CONVERT(varchar,tanggal,112)>=@thnbln1 and CONVERT(varchar,tanggal,112)<=@thnbln2 and ItemID IN (SELECT ID from FC_Items " +
                            "where partno like'%-P-%') " +
                            "and Process like'%simetris%' and Keterangan like'%-1-%' and CutID in (select ID from T3_Simetris " +
                            "where QtyIn<QtyOut and RowStatus>-1)) and RowStatus>-1 " +
                            "union all " +
                            "select sum(qty) Qty from vw_KartuStockBJNew where CONVERT(varchar,tanggal,112)>=@thnbln1 and CONVERT(varchar,tanggal,112)<=@thnbln2 " +
                            "and ItemID " +
                            "IN (SELECT ID from FC_Items where partno like'%-3-%' or PartNo like'%-M-%' or PartNo like'%-P-%') and Process like'%simetris%' " +
                            "and Keterangan like'%-1-%' and CutID in (select ID from T3_Simetris where QtyIn=QtyOut and RowStatus>-1)) as xx) Qty, " +
                            "PlantName,[group] from (select xx1.*,B.[Group],C.PlantName  from (select xx.*,A.PlantGroupID,A.PlantID from (select qty,destid " +
                            "from vw_KartustockWIP where CONVERT(varchar,tanggal,112)>=@thnbln1 and CONVERT(varchar,tanggal,112)<=@thnbln2 and Lokasi " +
                            "in ('B99','H99') and qty<0 " +
                            "union all " +
                            "select cast(qty as decimal(10,2)) Qty,DestID from vw_KartustockWIP2 where CONVERT(varchar,tanggal,112)>=@thnbln1 and " +
                            "CONVERT(varchar,tanggal,112)<=@thnbln2 and qty<0 AND ItemID IN (SELECT ID from FC_Items where partno like'%-3-%' or " +
                            "PartNo like'%-M-%' or PartNo like'%-P-%')) as xx left join BM_Destacking A ON A.ID=xx.destid ) as xx1 " +
                            "left join BM_PlantGroup B ON B.ID=xx1.PlantGroupID left join BM_Plant C ON C.ID=xx1.PlantID ) as DataFinal " +
                            "group by [group],PlantName) as z " +

                            "/** Temp Table = tempTotalSerahLP **/ " +
                            "select sum(Qty)Qty,sum(M3)M3,PlantName,[Group] into tempTotalSerahLP from ( " +
                            "/** Bevel Out**/ " +
                             "select sum(Qty)Qty,sum(M3 * Qty)M3,PlantName,[Group] from (select x.*,B.[Group],C.PlantName,((D.Tebal*D.Lebar*D.Panjang)/1000000000)M3 " +
                             " from (select sum(QtyIn)Qty,DestID,ItemID from T1_Straping where CONVERT(varchar,TglTrans,112)>=@thnbln1 and " +
                             "CONVERT(varchar,TglTrans,112)<=@thnbln2 and RowStatus>-1 and L1ID in (select ID from T1_Bevel where RowStatus >-1) " +
                             "group by DestID,ItemID ) as x " +
                             "LEFT JOIN BM_Destacking A ON A.ID=x.DestID " +
                             "LEFT JOIN BM_PlantGroup B ON B.ID=A.PlantGroupID " +
                             "LEFT JOIN BM_Plant C ON C.ID=A.PlantID " +
                             "LEFT JOIN FC_Items D ON D.ID=x.ItemID) as x2 group by PlantName,[Group] " +
                             "union all " +
                             "select sum(Qty)Qty,sum(M3 * Qty)M3,PlantName,[Group] from (select x.*,B.[Group],C.PlantName,((D.Tebal*D.Lebar*D.Panjang)/1000000000)M3 " +
                             "from (select sum(QtyIn)Qty,DestID,ItemID from T1_LR1_Listplank where CONVERT(varchar,TglTrans,112)>=@thnbln1 and " +
                             "CONVERT(varchar,TglTrans,112)<=@thnbln2 and Status>-1 and L1ID in (select ID from T1_Bevel where RowStatus >-1) " +
                             "group by DestID,ItemID ) as x  " +
                             "LEFT JOIN BM_Destacking A ON A.ID=x.DestID " +
                             "LEFT JOIN BM_PlantGroup B ON B.ID=A.PlantGroupID  " +
                             "LEFT JOIN BM_Plant C ON C.ID=A.PlantID " +
                             "LEFT JOIN FC_Items D ON D.ID=x.ItemID) as x2 group by PlantName,[Group] " +
                             "union all " +
                             "/** BP dari Bevel **/ " +
                             " select sum(Qty * -1)Qty,sum(M3 * Qty)M3,PlantName,[Group] from (select x.*,B.[Group],C.PlantName,((D.Tebal*D.Lebar*D.Panjang)/1000000000)M3 " +
                             "from (select sum(QtyIn)Qty,DestID,ItemID from T1_LR1_Listplank where CONVERT(varchar,TglTrans,112)>=@thnbln1 and " +
                             "CONVERT(varchar,TglTrans,112)<=@thnbln2 and Status>-1 and L1ID in (select ID from T1_Bevel where RowStatus >-1) " +
                             "group by DestID,ItemID ) as x  " +
                             " LEFT JOIN BM_Destacking A ON A.ID=x.DestID " +
                             "LEFT JOIN BM_PlantGroup B ON B.ID=A.PlantGroupID " +
                             " LEFT JOIN BM_Plant C ON C.ID=A.PlantID " +
                             "LEFT JOIN FC_Items D ON D.ID=x.ItemID) as x2 group by PlantName,[Group] " +
                             "union all " +
                            "/** BP dari Straping **/ " +
                            "select sum(Qty * -1)Qty,sum(M3 * Qty)M3,PlantName,[Group] from tempdefectListP2 group by PlantName,[Group] " +
                             ") as DataA group by PlantName,[Group] " +

                             /** tempdefectListP3 **/
                             " select sum(qty)Qty,PlantName,[Group] into tempdefectListP3  from ( " +
                             "select A.qty * -1 Qty,(((E.Tebal*E.Lebar*E.Panjang)/1000000000)*A.qty *-1)M3,C.[Group],D.PlantName from vw_KartustockWIP A LEFT JOIN BM_Destacking B ON A.destid=B.ID LEFT JOIN BM_PlantGroup C ON C.ID=B.PlantGroupID LEFT JOIN BM_Plant D ON D.ID=B.PlantID LEFT JOIN FC_Items E ON E.ID=A.ItemID where left(convert(char,A.tanggal,112),6)='201911' and A.Lokasi='B99' and A.qty<0 " +
                             "union all " +
                             "select A.qty * -1 Qty,(((E.Tebal*E.Lebar*E.Panjang)/1000000000)*A.qty *-1)M3,C.[Group],D.PlantName from vw_KartustockWIP2 A LEFT JOIN BM_Destacking B ON A.destid=B.ID LEFT JOIN BM_PlantGroup C ON C.ID=B.PlantGroupID LEFT JOIN BM_Plant D ON D.ID=B.PlantID LEFT JOIN FC_Items E ON E.ID=A.ItemID where left(convert(char,A.tanggal,112),6)='201911'  and A.qty<0 and A.ItemID IN (SELECT ID from FC_Items where partno like'%-P-%' ) " +
                             ") as x1 group by PlantName,[Group] " +

                            "/** Selesai **/ " +

                            " " +
                            QueryTotalPotong +
                            " " +
                            "declare @DefectFin decimal(18,2) " +
                            "set @DefectFin= (select sum(Qty) from (  " +
                            "select case when D.DeptID=0 then  " +
                            "case when GJ.GroupJemurName In ('M','N','O','P','Q','R','S','T','U','V','W','X') then   " +
                            "case when D.DefName='retak' then 2   " +
                            "when D.DefName='gompal' then 3  " +
                            "else D.DeptID end   " +
                            "else    " +
                            "case when (B.Qty/E.Qty) *100 >5 then 2 else 3 end   " +
                            "end  " +
                            "else D.DeptID end deptID1,A.CreatedTime as tglInput,A.Tgl as TglPeriksa,E.TglProduksi as TglProd,  D.DefCode,BP.PlantName as Line, PG.[Group],BF.FormulaCode as Jenis,   " +
                            "D.DefName,D.DeptID,B.ID,B.DefectID,B.MasterID,B.Qty,A.ID  DestID,isnull(A.TPotong,0)  QtyIn,B.Qty*I.Volume as Kubik,isnull(A.TPotong,0) as TotPotong,'' sfrom  " +
                            "from Def_DefectDetail B inner join Def_Defect A on A.Id=B.DefectID   " +
                            "left join Def_MasterDefect D on B.MasterID=D.ID left join BM_Destacking E on E.ID=A.DestID   " +
                            "left join BM_PlantGroup PG on A.GroupProdID=PG.ID left join BM_Formula BF on BF.ID=E.FormulaID    " +
                            "left join BM_Plant BP on BP.ID=E.PlantID left join FC_Items I on I.ID=E.ItemID inner join Def_GroupJemur GJ on GJ.ID=A.GroupJemurID  " +
                            "where B.RowStatus>-1  and D.RowStatus >-1) as Def    " +
                            "where DeptID1<>2 and CONVERT(varchar,TglPeriksa,112)>=@thnbln1 and CONVERT(varchar,TglPeriksa,112)<=@thnbln2) " +
                            " " +
                            "select * into tempdefectFin from ( " +
                            "select 'OKKW' fin, sum(qtyin) lembar,sum(qtyin * kubik)kubik from ( " +
                            "select I1.PartNo partno1,I1.Panjang * I1.Lebar luas1,  S.qtyin,I2.PartNo partno2,I2.Panjang * I2.Lebar luas2,  S.qtyout ,(I1.Tebal * I1.Panjang * I1.Lebar)/1000000000 kubik " +
                            "from t3_simetris S inner join T3_Serah Se on S.SerahID =Se.ID inner join fc_items I1 on Se.ItemID=I1.ID inner join fc_items I2 on S.ItemID=I2.id  " +
                            "where S.RowStatus>-1 and CONVERT(varchar,S.tgltrans,112)>=@thnbln1 and CONVERT(varchar,S.tgltrans,112)<=@thnbln2 )a  " +
                            "where partno1 like '%-1-%' and luas2/luas1 *100<60 and partno2 like '%-p-%' " +
                            "union all " +
                            "select 'BP' fin, sum(qtyin) lembar,sum(qtyin * kubik)kubik from ( " +
                            "select I1.PartNo partno1,I1.Panjang * I1.Lebar luas1,  S.qtyin,I2.PartNo partno2,I2.Panjang * I2.Lebar luas2,  S.qtyout ,(I1.Tebal * I1.Panjang * I1.Lebar)/1000000000 kubik " +
                            "from t3_simetris S inner join T3_Serah Se on S.SerahID =Se.ID inner join fc_items I1 on Se.ItemID=I1.ID inner join fc_items I2 on S.ItemID=I2.id  " +
                            "where S.RowStatus>-1 and CONVERT(varchar,S.tgltrans,112)>=@thnbln1 and CONVERT(varchar,S.tgltrans,112)<=@thnbln2  )a where partno1 like '%-1-%' and luas2/luas1 *100<60 and  " +
                            "(partno2 like '%-3-%' or partno2 like '%-w-%' or partno2 like '%-m-%') " +
                            "union all " +
                            "select 'BS' fin,sum(R.QtyIn) Lembar,sum(R.QtyIn *((I.tebal*I.panjang*I.lebar)/1000000000)) kubik from T3_Rekap R inner join  " +
                            "FC_Items I on R.ItemID=I.id inner join fc_lokasi L on R.LokID =L.id where R.RowStatus>-1 and  " +
                            "CONVERT(varchar,R.tgltrans,112)>=@thnbln1 and CONVERT(varchar,R.tgltrans,112)<=@thnbln2   and I.PartNo like '%-s-%' and Process='direct' " +
                            "and (sfrom not like'%R1%' and sfrom not like'%R2%' and sfrom not like'%R3%'))A " +
                            " " +
                            "declare @TotalPotong decimal(18,2) " +
                            "declare @TotalDefKhusus decimal(18,2) " +
                            "declare @DefKhusus decimal(18,2) " +
                            "declare @Ttotalkw1kw2 decimal(18,2) " +
                            "declare @NCSortir decimal(18,2) " +
                            "declare @Retur decimal(18,2) " +

                            //Rubah total potong
                            //"set @TotalPotong=isnull((select sum(totpotong ) from tempdefectGPIsoTot),0) " +
                            "set @TotalPotong=isnull((select sum(Qty ) from tempTotalSerah_lmbr3),0) " +

                            "declare @SelisihTotalPotong decimal(18,2) " +
                            "declare @TotalAccReport decimal(18,2) " +
                            "set @TotalAccReport=(select lembar from( " +
                            "select  sum(lembar) lembar,sum(kubik)kubik from ( " +
                            "select 'AccReport' fin, sum(qtyin) lembar,sum(qtyin * kubik)kubik from ( " +
                            "select I1.PartNo partno1,I1.Panjang * I1.Lebar luas1,  S.qtyin,I2.PartNo partno2,I2.Panjang * I2.Lebar luas2,  S.qtyout ,(I1.Tebal * I1.Panjang * I1.Lebar)/1000000000 kubik " +
                            "from t3_simetris S inner join T3_Serah Se on S.SerahID =Se.ID inner join fc_items I1 on Se.ItemID=I1.ID inner join fc_items I2 on S.ItemID=I2.id  " +
                            "where S.RowStatus>-1 and CONVERT(varchar,S.tgltrans,112)>=@thnbln1 and CONVERT(varchar,S.tgltrans,112)<=@thnbln2 )a  " +
                            "where partno1 like '%-1-%' and luas2/luas1 *100>90  and (partno2 like '%-p-%' or partno2 like '%-3-%' or partno2 like '%-M-%') " +
                            "union all " +
                            "select 'AccReport' fin, sum(qtyin) lembar,sum(qtyin * kubik)kubik from ( " +
                            "select I1.PartNo partno1,I1.Panjang * I1.Lebar luas1,  S.qtyin,I2.PartNo partno2,I2.Panjang * I2.Lebar luas2,  S.qtyout ,(I1.Tebal * I1.Panjang * I1.Lebar)/1000000000 kubik " +
                            "from t1_serah S  inner join fc_items I1 on S.ItemID0=I1.ID inner join fc_items I2 on S.ItemID=I2.id  " +
                            "where S.Status>-1 and CONVERT(varchar,S.tglserah,112)>=@thnbln1 and CONVERT(varchar,S.tglserah,112)<=@thnbln2 )a  " +
                            "where (partno2 like '%-p-%' or partno2 like '%-3-%' or partno2 like '%-M-%'))a)B) " +
                            "set @SelisihTotalPotong= @TotalAccReport-@TotalPotong " +
                            "if @TotalPotong >0  " +
                            "begin " +
                            "set @TotalDefKhusus=isnull((select sum(Lembar) from tempdefectFin),0) " +
                            "set @DefKhusus=isnull((select sum(Lembar) from tempdefectFin where fin<>'bp'),0) " +
                            "set @Ttotalkw1kw2 =isnull((select sum(qtyin) from T3_Rekap R inner join fc_items I on R.itemid=I.ID  " +
                            "where R.rowstatus>-1 and R.Process  like '%simetris%' and CONVERT(varchar,R.tgltrans,112)>=@thnbln1 and CONVERT(varchar,R.tgltrans,112)<=@thnbln2   " +
                            "and I.lebar=1200 and I.panjang=2400 and R.keterangan like '%-p-%' and (I.partno like '%-3-%' or I.partno like '%-W-%' or I.partno like '%-M-%' )),0) " +
                            "set @NCSortir=isnull((select sum(QtyAkhirSS)+sum(QtyAkhirSE)/*sum(M3AkhirSS)+sum(M3AkhirSE)*/ from (  " +
                            "SELECT B.tgltrans as Tanggal, I1.PartNo as PartnoAwal, sum(B.QtyIn) as QtyAwal,sum(I1.Volume*B.QtyIn) M3Awal,   " +
                            "I2.PartNo AS PartnoAkhir, case when B.NCSS>0 then sum(B.QtyOut) else 0 end QtyAkhirSS,  " +
                            "case when B.NCSS>0 then sum(I2.Volume*B.QtyOut) else 0 end M3AkhirSS,case when B.NCSE>0 then sum(B.QtyOut) else 0 end QtyAkhirSE,  " +
                            "case when B.NCSE>0 then sum(I2.Volume*B.QtyOut) else 0 end M3AkhirSE,B.NCSS,B.NCSE  FROM T3_Serah AS A   " +
                            "INNER JOIN T3_Simetris AS B ON A.ID = B.SerahID INNER JOIN FC_Items AS I1 ON A.ItemID = I1.ID INNER JOIN   " +
                            "FC_Items AS I2 ON B.ItemID = I2.ID LEFT JOIN T3_GroupM AS D ON B.GroupID = D.ID   " +
                            "where (B.NCSS>0 or B.NCSE>0) and B.rowstatus>-1 and CONVERT(varchar,B.tgltrans,112)>=@thnbln1 and CONVERT(varchar,B.tgltrans,112)<=@thnbln2   " +
                            "group by B.tgltrans,I1.PartNo,I2.PartNo,B.NCSS,B.NCSE) S),0) " +
                            " " +
                            "set @Retur=isnull((select sum(qty) from (  " +
                            "select sum(qty ) qty from t3_retur R inner join fc_items I on R.itemid=I.id where R.rowstatus>-1 and   " +
                            "R.typer=1 and (I.partno like '%-p-%' or I.partno like '%-S-%')  and CONVERT(varchar,R.tgltrans,112)>=@thnbln1 and CONVERT(varchar,R.tgltrans,112)<=@thnbln2   " +
                            "union all  " +
                            "select sum(qty )*-1 qty from t3_retur R inner join fc_items I on R.itemid=I.id where R.rowstatus>-1 and   " +
                            "R.typer=2 and (I.partno like '%-p-%' or I.partno like '%-S-%')and CONVERT(varchar,R.tgltrans,112)>=@thnbln1 and CONVERT(varchar,R.tgltrans,112)<=@thnbln2  " +
                            "union all  " +
                            "select sum(qty) qty from t3_returO R inner join fc_items I on R.itemid=I.id where R.rowstatus>-1 and   " +
                            "(I.partno like '%-p-%' or I.partno like '%-S-%') and CONVERT(varchar,R.tgltrans,112)>=@thnbln1 and CONVERT(varchar,R.tgltrans,112)<=@thnbln2)A),0) " +
                            " " +
                        #endregion

                        #region tempdefectL1
 "declare @TotalPotongL1 decimal(18,2) " +
                            "declare @TotDefKhususL1 decimal(18,2) " +
                            "declare @DefKhususL1 decimal(18,2) " +
                            "declare @Ttotalkw1kw2L1 decimal(18,2) " +
                            "declare @NCSortirL1 decimal(18,2) " +
                            "declare @ReturL1 decimal(18,2) " +
                            "declare @DefectFinL1 decimal(18,2) " +

                            //"set @TotalPotongL1=(select sum(totpotong ) from tempdefectGPIsoTot where [group]in (select [group] from BM_PlantGroup  " +
                            //"set @TotalPotongL1=(select isnull(sum(qty),0)Qty from ( " +
                            //"select isnull(sum(qty),0)Qty from tempTotalSerah_lmbr3 where [group] in (select [group] from BM_PlantGroup " +
                            //"where PlantID in (select id from BM_Plant where PlantName='line 1')) " +
                            //"union all " +
                            //"select isnull(sum(qty),0)Qty from tempDataDefectBM where [group] in (select [group] from BM_PlantGroup " +
                            //"where PlantID in (select id from BM_Plant where PlantName='line 1'))) as x) " +

                            " set @TotalPotongL1=(select isnull(sum(qty),0)Qty from ( select isnull(sum(qty),0)Qty from " +
                            " tempTotalSerah_lmbr3 where [group] in (select [group] from BM_PlantGroup " +
                            " where PlantID in (select id from BM_Plant where PlantName='line 1'))) as x)   " +

                            "set @TotDefKhususL1=(@TotalPotongL1/@TotalPotong)*@TotalDefKhusus " +
                            "set @DefKhususL1=(@TotalPotongL1/@TotalPotong)*@DefKhusus " +
                            "set @Ttotalkw1kw2L1=(@TotalPotongL1/@TotalPotong)*@Ttotalkw1kw2 " +
                            "set @NCSortirL1=(@TotalPotongL1/@TotalPotong)*@NCSortir " +
                            "set @ReturL1=(@TotalPotongL1/@TotalPotong)*@Retur " +
                            "set @DefectFinL1=(@TotalPotongL1/@TotalPotong)*@DefectFin " +
                            "declare @SelisihTotalPotongL1 decimal(18,2) " +
                            "set @SelisihTotalPotongL1=(@TotalPotongL1/@TotalPotong)*@SelisihTotalPotong " +

                            /** tempdefectL1 **/
                            "if @TotalPotongL1>0 " +
                            "begin " +
                            "select * into tempdefectL1 from ( " +
                            "select [Group],b+h b,c,d,e,f,h,c-d+e+f i,case when b>0 then (c-d+e+f)/(b+h) *100 else 0  end j from ( " +
                            "select [Group], " +
                            //"case when @TotalPotongL1>0 then " +
                            //"isnull((select cast(Qty as decimal(10,2)) from tempTotalSerahDfct where [group]=BM_PlantGroup.[Group] and PlantName='LINE 1'),0) + " +
                            //"isnull((select cast(A.Qty as decimal(10,2)) from tempdefectListP A where [group]=BM_PlantGroup.[Group]),0) + " +
                            //"isnull((select cast(A.Qty as decimal(10,2)) from tempTotalSerahLP A where [group]=BM_PlantGroup.[Group]),0) else 0 end b, " +
                            //" case when @TotalPotongL1>0 then isnull((select isnull(cast(Qty as decimal(10,2)),0)Qty from tempTotalSerahDfct where [group]=BM_PlantGroup.[Group]),0) else 0 end b, " +
                            " case when @TotalPotongL1>0 then isnull((select isnull(cast(Qty as decimal(10,2)),0)Qty from tempTotalSerah_lmbr3 where [group]=BM_PlantGroup.[Group]),0) else 0 end b, " +
                            " case when @TotalPotongL1>0 then isnull((select Qty from tempDataDefectBM where [group]=BM_PlantGroup.[Group] ),0)  else 0 end c, " +
                            " case when @TotalPotongL1>0 then ((isnull((select Qty from tempTotalSerah_lmbr3 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@Ttotalkw1kw2L1) else 0 end  d, " +
                            " case when @TotalPotongL1>0 then ((isnull((select Qty from tempTotalSerah_lmbr3 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@NCSortirL1)  else 0 end  e, " +
                            " case when @TotalPotongL1>0 then ((isnull((select Qty from tempTotalSerah_lmbr3 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@ReturL1)  else 0 end  f, " +
                            " case when @TotalPotongL1>0 then ((isnull((select Qty from tempTotalSerah_lmbr3 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@DefectFinL1)  else 0 end g, " +

                            //" case when @TotalPotongL1>0 then ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@DefKhususL1) " +
                            //" + isnull((select cast(A.Qty as decimal(10,2)) from tempdefectListP A where [group]=BM_PlantGroup.[Group]),0)  else 0 end  h " +
                            " " + query1 + " " +

                            " from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 1') )A " +
                            "union all  " +
                            "select 'Total' [Group],sum(b)+sum(h) b,sum(c)c,sum(d)d,sum(e)e,sum(f)f,sum(h)h,sum(c)-sum(d)+sum(e)+sum(f) i " +
                            ",(sum(c)-sum(d)+sum(e)+sum(f))/(sum(b)+sum(h))*100 j from( " +
                            "select [Group], " +
                            //"case when @TotalPotongL1>0 then " +
                            //"isnull((select cast(Qty as decimal(10,2)) from tempTotalSerahDfct where [group]=BM_PlantGroup.[Group] and PlantName='LINE 1'),0) + " +
                            //"isnull((select cast(A.Qty as decimal(10,2)) from tempdefectListP A where [group]=BM_PlantGroup.[Group]),0) + " +
                            //"isnull((select cast(A.Qty as decimal(10,2)) from tempTotalSerahLP A where [group]=BM_PlantGroup.[Group]),0) else 0 end b, " +
                            " case when @TotalPotongL1>0 then isnull((select isnull(cast(Qty as decimal(10,2)),0)Qty from tempTotalSerah_lmbr3 where [group]=BM_PlantGroup.[Group]),0) else 0 end b, " +
                            " case when @TotalPotongL1>0 then isnull((select Qty from tempDataDefectBM where [group]=BM_PlantGroup.[Group] ),0)  else 0 end c, " +
                            " case when @TotalPotongL1>0 then ((isnull((select Qty from tempTotalSerah_lmbr3 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@Ttotalkw1kw2L1) else 0 end  d, " +
                            " case when @TotalPotongL1>0 then ((isnull((select Qty from tempTotalSerah_lmbr3 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@NCSortirL1)  else 0 end  e, " +
                            " case when @TotalPotongL1>0 then ((isnull((select Qty from tempTotalSerah_lmbr3 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@ReturL1)  else 0 end  f, " +
                            " case when @TotalPotongL1>0 then ((isnull((select Qty from tempTotalSerah_lmbr3 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@DefectFinL1)  else 0 end g, " +

                            //" case when @TotalPotongL1>0 then cast(((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@DefKhususL1) " +
                            //" + isnull((select cast(A.Qty as decimal(10,2)) from tempdefectListP A where [group]=BM_PlantGroup.[Group]),0) as decimal(10,2)) else 0 end  h, " +
                            " " + query2 + " " +

                            " 0 i,0 j from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 1'))A )B " +
                            " end " +
                            " else " +
                            " begin " +
                            " select '' [group],0 b,0 c,0 d,0 e,0 f,0 h,0 i, 0 j into tempdefectL1 " +
                            " end " +
                            " " +
                        #endregion

                        #region tempdefectL2
 "declare @TotalPotongL2 decimal(18,2) " +
                            "declare @TotDefKhususL2 decimal(18,2) " +
                            "declare @DefKhususL2 decimal(18,2) " +
                            "declare @Ttotalkw1kw2L2 decimal(18,2) " +
                            "declare @NCSortirL2 decimal(18,2) " +
                            "declare @ReturL2 decimal(18,2) " +
                            "declare @DefectFinL2 decimal(18,2) " +
                            //"set @TotalPotongL2=(select sum(totpotong ) from tempdefectGPIsoTot where [group]in (select [group] from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 2'))) " +
                            //"set @TotalPotongL2=(select isnull(sum(qty),0)Qty from ( " +
                            //"select isnull(sum(qty),0)Qty from tempTotalSerah_lmbr3 where [group] in (select [group] from BM_PlantGroup " +
                            //"where PlantID in (select id from BM_Plant where PlantName='line 2')) " +
                            //"union all " +
                            //"select isnull(sum(qty),0)Qty from tempDataDefectBM where [group] in (select [group] from BM_PlantGroup " +
                            //"where PlantID in (select id from BM_Plant where PlantName='line 2'))) as x) " +

                            " set @TotalPotongL2=(select isnull(sum(qty),0)Qty from ( select isnull(sum(qty),0)Qty from " +
                            " tempTotalSerah_lmbr3 where [group] in (select [group] from BM_PlantGroup " +
                            " where PlantID in (select id from BM_Plant where PlantName='line 2'))) as x) " +

                            " " +
                            "set @TotDefKhususL2=(@TotalPotongL2/@TotalPotong)*@TotalDefKhusus " +
                            "set @DefKhususL2=(@TotalPotongL2/@TotalPotong)*@DefKhusus " +
                            "set @Ttotalkw1kw2L2=(@TotalPotongL2/@TotalPotong)*@Ttotalkw1kw2 " +
                            "set @NCSortirL2=(@TotalPotongL2/@TotalPotong)*@NCSortir " +
                            "set @ReturL2=(@TotalPotongL2/@TotalPotong)*@Retur " +
                            "set @DefectFinL2=(@TotalPotongL2/@TotalPotong)*@DefectFin " +
                            "declare @SelisihTotalPotongL2 decimal(18,2) " +
                            "set @SelisihTotalPotongL2=(@TotalPotongL2/@TotalPotong)*@SelisihTotalPotong " +

                            /** tempdefectL2 **/
                            "if @TotalPotongL2>0 " +
                            "begin " +
                            "select * into tempdefectL2 from ( " +
                            "select [Group],b+h b,c,d,e,f,h,c-d+e+f i,case when b>0 then (c-d+e+f)/(b+h)*100 else 0  end j from ( " +
                            "select [Group], " +
                            //"case when @TotalPotongL2>0 then " +
                            //"isnull((select cast(Qty as decimal(10,2)) from tempTotalSerahDfct where [group]=BM_PlantGroup.[Group] and PlantName='LINE 2'),0) + " +
                            //"isnull((select cast(A.Qty as decimal(10,2)) from tempdefectListP A where [group]=BM_PlantGroup.[Group]),0) + " +
                            //"isnull((select cast(A.Qty as decimal(10,2)) from tempTotalSerahLP A where [group]=BM_PlantGroup.[Group]),0) else 0 end b, " +
                            " case when @TotalPotongL2>0 then isnull((select isnull(cast(Qty as decimal(10,2)),0)Qty from tempTotalSerah_lmbr3 where [group]=BM_PlantGroup.[Group]),0) else 0 end b, " +
                            //" case when @TotalPotongL2>0 then isnull((select totdefect from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) else 0 end c, " +
                            " case when @TotalPotongL2>0 then isnull((select Qty from tempDataDefectBM where [group]=BM_PlantGroup.[Group] ),0) else 0 end c, " +
                            " case when @TotalPotongL2>0 then ((isnull((select Qty from tempTotalSerah_lmbr3 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL2)*@Ttotalkw1kw2L2) else 0 end  d, " +
                            " case when @TotalPotongL2>0 then ((isnull((select Qty from tempTotalSerah_lmbr3 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL2)*@NCSortirL2) else 0 end  e, " +
                            " case when @TotalPotongL2>0 then ((isnull((select Qty from tempTotalSerah_lmbr3 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL2)*@ReturL2)  else 0 end f, " +
                            " case when @TotalPotongL2>0 then ((isnull((select Qty from tempTotalSerah_lmbr3 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL2)*@DefectFinL2) else 0 end  g, " +

                            //" case when @TotalPotongL2>0 then ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL2)*@DefKhususL2) " +
                            //" + isnull((select cast(A.Qty as decimal(10,2)) from tempdefectListP A where [group]=BM_PlantGroup.[Group]),0) else 0 end  h " +

                            " " + query3 + " " +

                            "  from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 2') )A " +
                            "union all  " +
                            "select 'Total' [Group],sum(b)+sum(h) b,sum(c)c,sum(d)d,sum(e)e,sum(f)f,sum(h)h,sum(c)-sum(d)+sum(e)+sum(f) i " +
                            ",(sum(c)-sum(d)+sum(e)+sum(f)+sum(g)+sum(h))/(sum(b)+sum(h))*100 j from( " +
                            "select [Group], " +
                            //"case when @TotalPotongL2>0 then " +
                            //"isnull((select cast(Qty as decimal(10,2)) from tempTotalSerahDfct where [group]=BM_PlantGroup.[Group] and PlantName='LINE 2'),0) + " +
                            //"isnull((select cast(A.Qty as decimal(10,2)) from tempdefectListP A where [group]=BM_PlantGroup.[Group]),0) + " +
                            //"isnull((select cast(A.Qty as decimal(10,2)) from tempTotalSerahLP A where [group]=BM_PlantGroup.[Group]),0) else 0 end b, " +
                            " case when @TotalPotongL2>0 then isnull((select isnull(cast(Qty as decimal(10,2)),0)Qty from tempTotalSerah_lmbr3 where [group]=BM_PlantGroup.[Group]),0) else 0 end b, " +
                            " case when @TotalPotongL2>0 then isnull((select Qty from tempDataDefectBM where [group]=BM_PlantGroup.[Group] ),0) else 0 end c, " +
                            " case when @TotalPotongL2>0 then ((isnull((select Qty from tempTotalSerah_lmbr3 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL2)*@Ttotalkw1kw2L2) else 0 end  d, " +
                            " case when @TotalPotongL2>0 then ((isnull((select Qty from tempTotalSerah_lmbr3 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL2)*@NCSortirL2) else 0 end  e, " +
                            " case when @TotalPotongL2>0 then ((isnull((select Qty from tempTotalSerah_lmbr3 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL2)*@ReturL2)  else 0 end f, " +
                            " case when @TotalPotongL2>0 then ((isnull((select Qty from tempTotalSerah_lmbr3 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL2)*@DefectFinL2) else 0 end  g, " +

                            //" case when @TotalPotongL2>0 then cast(((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL2)*@DefKhususL2) " +
                            //" + isnull((select cast(A.Qty as decimal(10,2)) from tempdefectListP A where [group]=BM_PlantGroup.[Group]),0) as decimal(10,2)) else 0 end  h, " +
                            " " + query4 + " " +

                            " 0 i,0 j from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 2'))A )B " +
                            " end " +
                            " else " +
                            " begin " +
                            " select '' [group],0 b,0 c,0 d,0 e,0 f,0 h,0 i, 0 j into tempdefectL2 " +
                            " end " +
                            " " +
                        #endregion

                        #region tempdefectL3
 "declare @TotalPotongL3 decimal(18,2) " +
                            "declare @TotDefKhususL3 decimal(18,2) " +
                            "declare @DefKhususL3 decimal(18,2) " +
                            "declare @Ttotalkw1kw2L3 decimal(18,2) " +
                            "declare @NCSortirL3 decimal(18,2) " +
                            "declare @ReturL3 decimal(18,2) " +
                            "declare @DefectFinL3 decimal(18,2) " +
                            //"set @TotalPotongL3=(select sum(totpotong ) from tempdefectGPIsoTot where [group]in (select [group] from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 3'))) " +
                            //"set @TotalPotongL3=(select isnull(sum(qty),0)Qty from ( " +
                            //"select isnull(sum(qty),0)Qty from tempTotalSerah_lmbr3 where [group] in (select [group] from BM_PlantGroup " +
                            //"where PlantID in (select id from BM_Plant where PlantName='line 3')) " +
                            //"union all " +
                            //"select isnull(sum(qty),0)Qty from tempDataDefectBM where [group] in (select [group] from BM_PlantGroup " +
                            //"where PlantID in (select id from BM_Plant where PlantName='line 3'))) as x) " +

                            " set @TotalPotongL3=(select isnull(sum(qty),0)Qty from ( select isnull(sum(qty),0)Qty from " +
                            " tempTotalSerah_lmbr3 where [group] in (select [group] from BM_PlantGroup " +
                            " where PlantID in (select id from BM_Plant where PlantName='line 3'))) as x)  " +

                            "set @TotDefKhususL3=(@TotalPotongL3/@TotalPotong)*@TotalDefKhusus " +
                            "set @DefKhususL3=(@TotalPotongL3/@TotalPotong)*@DefKhusus " +
                            "set @Ttotalkw1kw2L3=(@TotalPotongL3/@TotalPotong)*@Ttotalkw1kw2 " +
                            "set @NCSortirL3=(@TotalPotongL3/@TotalPotong)*@NCSortir " +
                            "set @ReturL3=(@TotalPotongL3/@TotalPotong)*@Retur " +
                            "set @DefectFinL3=(@TotalPotongL3/@TotalPotong)*@DefectFin " +
                            "declare @SelisihTotalPotongL3 decimal(18,2) " +
                            "set @SelisihTotalPotongL3=(@TotalPotongL3/@TotalPotong)*@SelisihTotalPotong " +

                            "if @TotalPotongL3>0 " +
                            "begin " +
                            "select * into tempdefectL3 from ( " +
                            "select [Group],b+h b,c,d,e,f,h,c-d+e+f i,case when b>0 then (c-d+e+f)/(b+h)*100 else 0  end j from ( " +
                            "select [Group], " +
                            //"case when @TotalPotongL3>0 then " +
                            //"isnull((select cast(Qty as decimal(10,2)) from tempTotalSerahDfct where [group]=BM_PlantGroup.[Group] and PlantName='LINE 3'),0) + " +
                            //"isnull((select cast(A.Qty as decimal(10,2)) from tempdefectListP A where [group]=BM_PlantGroup.[Group]),0) + " +
                            //"isnull((select cast(A.Qty as decimal(10,2)) from tempTotalSerahLP A where [group]=BM_PlantGroup.[Group]),0) else 0 end b, " +
                            " case when @TotalPotongL3>0 then isnull((select isnull(cast(Qty as decimal(10,2)),0)Qty from tempTotalSerah_lmbr3 where [group]=BM_PlantGroup.[Group]),0) else 0 end b, " +
                            " case when @TotalPotongL3>0 then isnull((select Qty from tempDataDefectBM where [group]=BM_PlantGroup.[Group] ),0) else 0 end c, " +
                            " case when @TotalPotongL3>0 then ((isnull((select Qty from tempTotalSerah_lmbr3 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@Ttotalkw1kw2L3) else 0 end  d, " +
                            " case when @TotalPotongL3>0 then ((isnull((select Qty from tempTotalSerah_lmbr3 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@NCSortirL3) else 0 end  e, " +
                            " case when @TotalPotongL3>0 then ((isnull((select Qty from tempTotalSerah_lmbr3 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@ReturL3) else 0 end  f, " +
                            " case when @TotalPotongL3>0 then ((isnull((select Qty from tempTotalSerah_lmbr3 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@DefectFinL3) else 0 end  g, " +

                            //" case when @TotalPotongL3>0 then ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@DefKhususL3) " +
                            //" + isnull((select cast(A.Qty as decimal(10,2)) from tempdefectListP A where [group]=BM_PlantGroup.[Group]),0) else 0 end  h " +
                            " " + query5 + " " +

                            "  from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 3') )A " +
                            "union all  " +
                            "select 'Total' [Group],sum(b)+sum(h) b,sum(c)c,sum(d)d,sum(e)e,sum(f)f,sum(h)h,sum(c)-sum(d)+sum(e)+sum(f) i " +
                            ",(sum(c)-sum(d)+sum(e)+sum(f))/(sum(b)+sum(h))*100 j from( " +
                            "select [Group], " +
                            //"isnull((select cast(Qty as decimal(10,2)) from tempTotalSerahDfct where [group]=BM_PlantGroup.[Group] and PlantName='LINE 3'),0) + " +
                            //"isnull((select cast(A.Qty as decimal(10,2)) from tempdefectListP A where [group]=BM_PlantGroup.[Group]),0) + " +
                            //"isnull((select cast(A.Qty as decimal(10,2)) from tempTotalSerahLP A where [group]=BM_PlantGroup.[Group]),0) b, " +
                            " isnull((select isnull(cast(Qty as decimal(10,2)),0)Qty from tempTotalSerah_lmbr3 where [group]=BM_PlantGroup.[Group]),0) b, " +
                            " isnull((select Qty from tempDataDefectBM where [group]=BM_PlantGroup.[Group] ),0)c, " +
                            " ((isnull((select Qty from tempTotalSerah_lmbr3 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@Ttotalkw1kw2L3) d, " +
                            " ((isnull((select Qty from tempTotalSerah_lmbr3 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@NCSortirL3) e, " +
                            " ((isnull((select Qty from tempTotalSerah_lmbr3 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@ReturL3) f, " +
                            " ((isnull((select Qty from tempTotalSerah_lmbr3 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@DefectFinL3) g, " +

                            //" cast(((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@DefKhususL3) " +
                            //" + isnull((select cast(A.Qty as decimal(10,2)) from tempdefectListP A where [group]=BM_PlantGroup.[Group]),0) as decimal(10,2)) h, " +
                            " " + query6 + " " +

                            " 0 i,0 j from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 3'))A )B " +
                            " end " +
                            " else " +
                            " begin " +
                            " select '' [group],0 b,0 c,0 d,0 e,0 f,0 h,0 i, 0 j into tempdefectL3 " +
                            " end " +
                            " " +
                        #endregion

                        #region tempdefectL4
 "declare @TotalPotongL4 decimal(18,2) " +
                            "declare @TotDefKhususL4 decimal(18,2) " +
                            "declare @DefKhususL4 decimal(18,2) " +
                            "declare @Ttotalkw1kw2L4 decimal(18,2) " +
                            "declare @NCSortirL4 decimal(18,2) " +
                            "declare @ReturL4 decimal(18,2) " +
                            "declare @DefectFinL4 decimal(18,2) " +
                            //"set @TotalPotongL4=(select sum(totpotong ) from tempdefectGPIsoTot where [group]in (select [group] from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 4'))) " +
                            //"set @TotalPotongL4=(select isnull(sum(qty),0)Qty from ( " +
                            //"select isnull(sum(qty),0)Qty from tempTotalSerah_lmbr3 where [group] in (select [group] from BM_PlantGroup " +
                            //"where PlantID in (select id from BM_Plant where PlantName='line 4')) " +
                            //"union all " +
                            //"select isnull(sum(qty),0)Qty from tempDataDefectBM where [group] in (select [group] from BM_PlantGroup " +
                            //"where PlantID in (select id from BM_Plant where PlantName='line 4'))) as x) " +

                            " set @TotalPotongL4=(select isnull(sum(qty),0)Qty from ( select isnull(sum(qty),0)Qty from " +
                            " tempTotalSerah_lmbr3 where [group] in (select [group] from BM_PlantGroup " +
                            " where PlantID in (select id from BM_Plant where PlantName='line 4'))) as x)  " +

                            "set @TotDefKhususL4=(@TotalPotongL4/@TotalPotong)*@TotalDefKhusus " +
                            "set @DefKhususL4=(@TotalPotongL4/@TotalPotong)*@DefKhusus " +
                            "set @Ttotalkw1kw2L4=(@TotalPotongL4/@TotalPotong)*@Ttotalkw1kw2 " +
                            "set @NCSortirL4=(@TotalPotongL4/@TotalPotong)*@NCSortir " +
                            "set @ReturL4=(@TotalPotongL4/@TotalPotong)*@Retur " +
                            "set @DefectFinL4=(@TotalPotongL4/@TotalPotong)*@DefectFin " +
                            "declare @SelisihTotalPotongL4 decimal(18,2) " +
                            "set @SelisihTotalPotongL4=(@TotalPotongL4/@TotalPotong)*@SelisihTotalPotong " +

                            "if @TotalPotongL4>0 " +
                            "begin " +
                            "select * into tempdefectL4 from ( " +
                            "select [Group],b+h b,c,d,e,f,h,c-d+e+f i,case when b>0 then (c-d+e+f)/(b+h)*100 else 0  end j from ( " +
                            "select [Group], " +
                            //"case when @TotalPotongL4>0 then " +
                            //"isnull((select cast(Qty as decimal(10,2)) from tempTotalSerahDfct where [group]=BM_PlantGroup.[Group] and PlantName='LINE 4'),0) + " +
                            //"isnull((select cast(A.Qty as decimal(10,2)) from tempdefectListP A where [group]=BM_PlantGroup.[Group]),0) + " +
                            //"isnull((select cast(A.Qty as decimal(10,2)) from tempTotalSerahLP A where [group]=BM_PlantGroup.[Group]),0) else 0 end b, " +
                            " case when @TotalPotongL4>0 then isnull((select isnull(cast(Qty as decimal(10,2)),0)Qty from tempTotalSerah_lmbr3 where [group]=BM_PlantGroup.[Group]),0) else 0 end b, " +
                            " case when @TotalPotongL4>0 then isnull((select Qty from tempDataDefectBM where [group]=BM_PlantGroup.[Group] ),0) else 0 end c, " +
                            " case when @TotalPotongL4>0 then ((isnull((select Qty from tempTotalSerah_lmbr3 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@Ttotalkw1kw2L4) else 0 end  d, " +
                            " case when @TotalPotongL4>0 then ((isnull((select Qty from tempTotalSerah_lmbr3 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@NCSortirL4) else 0 end  e, " +
                            " case when @TotalPotongL4>0 then ((isnull((select Qty from tempTotalSerah_lmbr3 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@ReturL4) else 0 end  f, " +
                            " case when @TotalPotongL4>0 then ((isnull((select Qty from tempTotalSerah_lmbr3 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@DefectFinL4) else 0 end  g, " +

                            //" case when @TotalPotongL4>0 then ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@DefKhususL4) " +
                            //" + isnull((select cast(A.Qty as decimal(10,2)) from tempdefectListP A where [group]=BM_PlantGroup.[Group]),0) else 0 end  h " +
                            " " + query7 + " " +

                            "  from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 4') )A " +
                            "union all  " +
                            "select 'Total' [Group],sum(b)+sum(h)b,sum(c)c,sum(d)d,sum(e)e,sum(f)f,sum(h)h,sum(c)-sum(d)+sum(e)+sum(f) i " +
                            ",(sum(c)-sum(d)+sum(e)+sum(f))/(sum(b)+sum(h))*100 j from( " +
                            "select [Group]," +
                            //"isnull((select cast(Qty as decimal(10,2)) from tempTotalSerahDfct where [group]=BM_PlantGroup.[Group] and PlantName='LINE 4'),0) + " +
                            //"isnull((select cast(A.Qty as decimal(10,2)) from tempdefectListP A where [group]=BM_PlantGroup.[Group]),0) + " +
                            //"isnull((select cast(A.Qty as decimal(10,2)) from tempTotalSerahLP A where [group]=BM_PlantGroup.[Group]),0) b, " +
                            " isnull((select isnull(cast(Qty as decimal(10,2)),0)Qty from tempTotalSerah_lmbr3 where [group]=BM_PlantGroup.[Group]),0) b, " +
                            " isnull((select Qty from tempDataDefectBM where [group]=BM_PlantGroup.[Group] ),0)c, " +
                            " ((isnull((select Qty from tempTotalSerah_lmbr3 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@Ttotalkw1kw2L4) d, " +
                            " ((isnull((select Qty from tempTotalSerah_lmbr3 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@NCSortirL4) e, " +
                            " ((isnull((select Qty from tempTotalSerah_lmbr3 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@ReturL4) f, " +
                            " ((isnull((select Qty from tempTotalSerah_lmbr3 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@DefectFinL4) g, " +

                            //" cast(((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@DefKhususL4) " +
                            //" + isnull((select cast(A.Qty as decimal(10,2)) from tempdefectListP A where [group]=BM_PlantGroup.[Group]),0) as decimal(10,2)) h, " +
                            " " + query8 + " " +

                            " 0 i,0 j from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 4'))A )B " +
                            " end " +
                            " else " +
                            " begin " +
                            " select '' [group],0 b,0 c,0 d,0 e,0 f,0 h,0 i, 0 j into tempdefectL4 " +
                            " end " +
                            " " +
                        #endregion

                        #region tempdefectL5
 "declare @TotalPotongL5 decimal(18,2) " +
                            "declare @TotDefKhususL5 decimal(18,2) " +
                            "declare @DefKhususL5 decimal(18,2) " +
                            "declare @Ttotalkw1kw2L5 decimal(18,2) " +
                            "declare @NCSortirL5 decimal(18,2) " +
                            "declare @ReturL5 decimal(18,2) " +
                            "declare @DefectFinL5 decimal(18,2) " +
                            //"set @TotalPotongL5=(select sum(totpotong ) from tempdefectGPIsoTot where [group]in (select [group] from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 5'))) " +
                            //"set @TotalPotongL5=(select isnull(sum(qty),0)Qty from ( " +
                            //"select isnull(sum(qty),0)Qty from tempTotalSerah_lmbr3 where [group] in (select [group] from BM_PlantGroup " +
                            //"where PlantID in (select id from BM_Plant where PlantName='line 5')) " +
                            //"union all " +
                            //"select isnull(sum(qty),0)Qty from tempDataDefectBM where [group] in (select [group] from BM_PlantGroup " +
                            //"where PlantID in (select id from BM_Plant where PlantName='line 5'))) as x) " +

                            " set @TotalPotongL5=(select isnull(sum(qty),0)Qty from ( select isnull(sum(qty),0)Qty from " +
                            " tempTotalSerah_lmbr3 where [group] in (select [group] from BM_PlantGroup " +
                            " where PlantID in (select id from BM_Plant where PlantName='line 5'))) as x)  " +

                            "set @TotDefKhususL5=(@TotalPotongL5/@TotalPotong)*@TotalDefKhusus " +
                            "set @DefKhususL5=(@TotalPotongL5/@TotalPotong)*@DefKhusus " +
                            "set @Ttotalkw1kw2L5=(@TotalPotongL5/@TotalPotong)*@Ttotalkw1kw2 " +
                            "set @NCSortirL5=(@TotalPotongL5/@TotalPotong)*@NCSortir " +
                            "set @ReturL5=(@TotalPotongL5/@TotalPotong)*@Retur " +
                            "set @DefectFinL5=(@TotalPotongL5/@TotalPotong)*@DefectFin " +
                            "declare @SelisihTotalPotongL5 decimal(18,2) " +
                            "set @SelisihTotalPotongL5=(@TotalPotongL5/@TotalPotong)*@SelisihTotalPotong " +



                            "if @TotalPotongL5>0 " +
                            "begin " +
                            "select * into tempdefectL5 from ( " +
                            "select [Group],b+h b,c,d,e,f,h,c-d+e+f i,case when b>0 then (c-d+e+f)/(b+h)*100 else 0  end j from ( " +
                            "select [Group], " +
                            //"case when @TotalPotongL5>0 then " +
                            //"isnull((select cast(Qty as decimal(10,2)) from tempTotalSerahDfct where [group]=BM_PlantGroup.[Group] and PlantName='LINE 5'),0) + " +
                            //"isnull((select cast(A.Qty as decimal(10,2)) from tempdefectListP A where [group]=BM_PlantGroup.[Group]),0) + " +
                            //"isnull((select cast(A.Qty as decimal(10,2)) from tempTotalSerahLP A where [group]=BM_PlantGroup.[Group]),0) else 0 end b, " +
                            " case when @TotalPotongL5>0 then isnull((select isnull(cast(Qty as decimal(10,2)),0)Qty from tempTotalSerah_lmbr3 where [group]=BM_PlantGroup.[Group]),0) else 0 end b, " +
                            " case when @TotalPotongL5>0 then isnull((select Qty from tempDataDefectBM where [group]=BM_PlantGroup.[Group] ),0) else 0 end c, " +
                            " case when @TotalPotongL5>0 then ((isnull((select Qty from tempTotalSerah_lmbr3 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@Ttotalkw1kw2L5) else 0 end  d, " +
                            " case when @TotalPotongL5>0 then ((isnull((select Qty from tempTotalSerah_lmbr3 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@NCSortirL5) else 0 end  e, " +
                            " case when @TotalPotongL5>0 then ((isnull((select Qty from tempTotalSerah_lmbr3 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@ReturL5) else 0 end  f, " +
                            " case when @TotalPotongL5>0 then ((isnull((select Qty from tempTotalSerah_lmbr3 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@DefectFinL5) else 0 end  g, " +

                            //" case when @TotalPotongL5>0 then ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@DefKhususL5) " +
                            //" + isnull((select cast(A.Qty as decimal(10,2)) from tempdefectListP A where [group]=BM_PlantGroup.[Group]),0) else 0 end  h " +
                            " " + query9 + " " +

                            "  from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 5') )A " +
                            "union all  " +
                            "select 'Total' [Group],sum(b)+sum(h)b,sum(c)c,sum(d)d,sum(e)e,sum(f)f,sum(h)h,sum(c)-sum(d)+sum(e)+sum(f) i " +
                            ",(sum(c)-sum(d)+sum(e)+sum(f))/(sum(b)+sum(h))*100 j from( " +
                            "select [Group]," +
                            //"isnull((select cast(Qty as decimal(10,2)) from tempTotalSerahDfct where [group]=BM_PlantGroup.[Group] and PlantName='LINE 5'),0) + " +
                            //"isnull((select cast(A.Qty as decimal(10,2)) from tempdefectListP A where [group]=BM_PlantGroup.[Group]),0) + " +
                            //"isnull((select cast(A.Qty as decimal(10,2)) from tempTotalSerahLP A where [group]=BM_PlantGroup.[Group]),0) b, " +
                            " isnull((select isnull(cast(Qty as decimal(10,2)),0)Qty from tempTotalSerah_lmbr3 where [group]=BM_PlantGroup.[Group]),0) b, " +
                            " isnull((select Qty from tempDataDefectBM where [group]=BM_PlantGroup.[Group] ),0)c, " +
                            " ((isnull((select Qty from tempTotalSerah_lmbr3 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@Ttotalkw1kw2L5) d, " +
                            " ((isnull((select Qty from tempTotalSerah_lmbr3 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@NCSortirL5) e, " +
                            " ((isnull((select Qty from tempTotalSerah_lmbr3 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@ReturL5) f, " +
                            " ((isnull((select Qty from tempTotalSerah_lmbr3 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@DefectFinL5) g, " +

                            //" cast(((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@DefKhususL5) " +
                            //" + isnull((select cast(A.Qty as decimal(10,2)) from tempdefectListP A where [group]=BM_PlantGroup.[Group]),0) as decimal(10,2)) h, " +
                            " " + query10 + " " +

                            " 0 i,0 j from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 5'))A )B " +
                            " end " +
                            " else " +
                            " begin " +
                            " select '' [group],0 b,0 c,0 d,0 e,0 f,0 h,0 i, 0 j into tempdefectL5 " +
                            " end " +
                            " " +
                        #endregion

                        #region tempdefectL6
 "declare @TotalPotongL6 decimal(18,2) " +
                            "declare @TotDefKhususL6 decimal(18,2) " +
                            "declare @DefKhususL6 decimal(18,2) " +
                            "declare @Ttotalkw1kw2L6 decimal(18,2) " +
                            "declare @NCSortirL6 decimal(18,2) " +
                            "declare @ReturL6 decimal(18,2) " +
                            "declare @DefectFinL6 decimal(18,2) " +
                            //"set @TotalPotongL6=(select sum(totpotong ) from tempdefectGPIsoTot where [group]in (select [group] from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 6'))) " +

                            //"set @TotalPotongL6=(select isnull(sum(qty),0)Qty from ( " +
                            //"select isnull(sum(qty),0)Qty from tempTotalSerah_lmbr3 where [group] in (select [group] from BM_PlantGroup " +
                            //"where PlantID in (select id from BM_Plant where PlantName='line 6')) "+
                            //"union all "+
                            //"select isnull(sum(qty),0)Qty from tempDataDefectBM where [group] in (select [group] from BM_PlantGroup " +
                            //"where PlantID in (select id from BM_Plant where PlantName='line 6'))) as x) "+

                            " set @TotalPotongL6=(select isnull(sum(qty),0)Qty from ( select isnull(sum(qty),0)Qty from " +
                            " tempTotalSerah_lmbr3 where [group] in (select [group] from BM_PlantGroup " +
                            " where PlantID in (select id from BM_Plant where PlantName='line 6'))) as x)  " +

                            "set @TotDefKhususL6=(@TotalPotongL6/@TotalPotong)*@TotalDefKhusus " +
                            "set @DefKhususL6=(@TotalPotongL6/@TotalPotong)*@DefKhusus " +
                            "set @Ttotalkw1kw2L6=(@TotalPotongL6/@TotalPotong)*@Ttotalkw1kw2 " +
                            "set @NCSortirL6=(@TotalPotongL6/@TotalPotong)*@NCSortir " +
                            "set @ReturL6=(@TotalPotongL6/@TotalPotong)*@Retur " +
                            "set @DefectFinL6=(@TotalPotongL6/@TotalPotong)*@DefectFin " +
                            "declare @SelisihTotalPotongL6 decimal(18,2) " +
                            "set @SelisihTotalPotongL6=(@TotalPotongL6/@TotalPotong)*@SelisihTotalPotong " +

                            "if @TotalPotongL6>0 " +
                            "begin " +
                            "select * into tempdefectL6 from ( " +
                            //"select [Group],b+h b,c,d,e,f,h,c-d+e+f i,case when b>0 then (c-d+e+f)/(b+h) *100 else 0  end j from ( " +
                            "select [Group],b+h b,c,d,e,f,h,c-d+e+f i,0 j from ( " +
                            "select [Group], " +
                            //"case when @TotalPotongL6>0 then " +
                            //"isnull((select cast(Qty as decimal(10,2)) from tempTotalSerahDfct where [group]=BM_PlantGroup.[Group] and PlantName='LINE 6'),0) + " +
                            //"isnull((select cast(A.Qty as decimal(10,2)) from tempdefectListP A where [group]=BM_PlantGroup.[Group]),0) + " +
                            //"isnull((select cast(A.Qty as decimal(10,2)) from tempTotalSerahLP A where [group]=BM_PlantGroup.[Group]),0) else 0 end b, " +
                            " case when @TotalPotongL6>0 then isnull((select isnull(cast(Qty as decimal(10,2)),0)Qty from tempTotalSerah_lmbr3 where [group]=BM_PlantGroup.[Group]),0) else 0 end b, " +
                            " case when @TotalPotongL6>0 then isnull((select Qty from tempDataDefectBM where [group]=BM_PlantGroup.[Group] ),0) else 0 end c, " +
                            " case when @TotalPotongL6>0 then ((isnull((select Qty from tempTotalSerah_lmbr3 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@Ttotalkw1kw2L6)  else 0 end d, " +
                            " case when @TotalPotongL6>0 then ((isnull((select Qty from tempTotalSerah_lmbr3 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@NCSortirL6)  else 0 end e, " +
                            " case when @TotalPotongL6>0 then ((isnull((select Qty from tempTotalSerah_lmbr3 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@ReturL6)  else 0 end f, " +
                            " case when @TotalPotongL6>0 then ((isnull((select Qty from tempTotalSerah_lmbr3 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@DefectFinL6)  else 0 end g, " +

                            //" case when @TotalPotongL6>0 then ((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@DefKhususL6) " +
                            //" + isnull((select cast(A.Qty as decimal(10,2)) from tempdefectListP A where [group]=BM_PlantGroup.[Group]),0) else 0 end  h " +
                            " " + query11 + " " +

                            "  from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 6') )A " +
                            "union all  " +
                            "select 'Total' [Group],sum(b)+sum(h)b,sum(c)c,sum(d)d,sum(e)e,sum(f)f,sum(h)h,sum(c)-sum(d)+sum(e)+sum(f) i " +
                            //",(sum(c)-sum(d)+sum(e)+sum(f))/(sum(b)+sum(h))*100 j from( " +
                            ",0 j from( " +
                            "select [Group]," +
                            //"isnull((select cast(Qty as decimal(10,2)) from tempTotalSerahDfct where [group]=BM_PlantGroup.[Group] and PlantName='LINE 6'),0) + " +
                            //"isnull((select cast(A.Qty as decimal(10,2)) from tempdefectListP A where [group]=BM_PlantGroup.[Group]),0) + " +
                            //"isnull((select cast(A.Qty as decimal(10,2)) from tempTotalSerahLP A where [group]=BM_PlantGroup.[Group]),0) b, " +
                            " isnull((select isnull(cast(Qty as decimal(10,2)),0)Qty from tempTotalSerah_lmbr3 where [group]=BM_PlantGroup.[Group]),0) b, " +
                            " isnull((select Qty from tempDataDefectBM where [group]=BM_PlantGroup.[Group] ),0)c, " +
                            " ((isnull((select Qty from tempTotalSerah_lmbr3 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@Ttotalkw1kw2L6) d, " +
                            " ((isnull((select Qty from tempTotalSerah_lmbr3 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@NCSortirL6) e, " +
                            " ((isnull((select Qty from tempTotalSerah_lmbr3 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@ReturL6) f, " +
                            " ((isnull((select Qty from tempTotalSerah_lmbr3 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@DefectFinL6) g, " +

                            //" cast(((isnull((select totpotong from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@DefKhususL6) " +
                            //" + isnull((select cast(A.Qty as decimal(10,2)) from tempdefectListP A where [group]=BM_PlantGroup.[Group]),0) as decimal(10,2)) h, " +
                            " " + query12 + " " +

                            " 0 i,0 j from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 6'))A )B " +
                            " end " +
                            " else " +
                            " begin " +
                            " select '' [group],0 b,0 c,0 d,0 e,0 f,0 h,0 i, 0 j into tempdefectL6 " +
                            " end " +
                            " " +
                        #endregion
 " end " +
                            " else " +
                            " begin " +
                            " select '' [group],0 b,0 c,0 d,0 e,0 f,0 h,0 i, 0 j into tempdefectL1 " +
                            " select '' [group],0 b,0 c,0 d,0 e,0 f,0 h,0 i, 0 j into tempdefectL2 " +
                            " select '' [group],0 b,0 c,0 d,0 e,0 f,0 h,0 i, 0 j into tempdefectL3 " +
                            " select '' [group],0 b,0 c,0 d,0 e,0 f,0 h,0 i, 0 j into tempdefectL4 " +
                            " select '' [group],0 b,0 c,0 d,0 e,0 f,0 h,0 i, 0 j into tempdefectL5 " +
                            " select '' [group],0 b,0 c,0 d,0 e,0 f,0 h,0 i, 0 j into tempdefectL6 " +
                            " end " +


                            " select * from tempdefectL1 ";
                    }
                    #endregion
                    #region Baru II
                    else if (Convert.ToInt32(strtgl1.Substring(0, 6)) > 202008)
                    {
                        strSQL =
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectGPIso]') AND type in (N'U')) DROP TABLE [dbo].[tempdefectGPIso] " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectGPIsoTot]') AND type in (N'U')) DROP TABLE [dbo].tempdefectGPIsoTot  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectFin]') AND type in (N'U')) DROP TABLE [dbo].tempdefectFin  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectL1]') AND type in (N'U')) DROP TABLE [dbo].tempdefectL1 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectL2]') AND type in (N'U')) DROP TABLE [dbo].tempdefectL2 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectL3]') AND type in (N'U')) DROP TABLE [dbo].tempdefectL3 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectL4]') AND type in (N'U')) DROP TABLE [dbo].tempdefectL4 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectL5]') AND type in (N'U')) DROP TABLE [dbo].tempdefectL5 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectL6]') AND type in (N'U')) DROP TABLE [dbo].tempdefectL6 " +

                        " /** Baru **/ " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectGPIso2]') AND type in (N'U')) DROP TABLE [dbo].tempdefectGPIso2 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[detailDfctSystemBM]') AND type in (N'U')) DROP TABLE [dbo].detailDfctSystemBM " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[DtlDefectSystemFN]') AND type in (N'U')) DROP TABLE [dbo].DtlDefectSystemFN " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[DtlSelisih]') AND type in (N'U')) DROP TABLE [dbo].DtlSelisih " +
                        " /** end Baru **/ " +

                        " declare @thnbln1 varchar(8) declare @thnbln2 varchar(8) declare @BlnThn varchar(6) " +

                        " set @thnbln1='" + strtgl1 + "' " +
                        " set @thnbln2='" + strtgl2 + "' " +
                        " set @BlnThn='" + Periode + "' " +

                        " select *  into tempdefectGPIso from (  select case when D.DeptID=0 then  case when GJ.GroupJemurName In ('M','N','O','P','Q','R','S','T','U','V','W','X') then " +
                        " case when D.DefName='retak' then 2 when D.DefName='gompal' then 3 else D.DeptID end else " +
                        " case when (B.Qty/E.Qty) *100 >5 then 2 else 3 end   end  else D.DeptID end deptID1,A.CreatedTime as tglInput,A.Tgl as TglPeriksa, " +
                        " E.TglProduksi as TglProd,  D.DefCode,BP.PlantName as Line, PG.[Group],BF.FormulaCode as Jenis,D.DefName,D.DeptID,B.ID,B.DefectID, " +
                        " B.MasterID,B.Qty,A.ID  DestID,isnull(A.TPotong,0)  QtyIn, " +
                        " I.Volume*B.Qty Kubik,isnull(A.TPotong,0) as TotPotong,'' sfrom  " +
                        " from Def_DefectDetail B " +
                        " inner join Def_Defect A on A.Id=B.DefectID   " +
                        " left join Def_MasterDefect D on B.MasterID=D.ID " +
                        " left join BM_Destacking E on E.ID=A.DestID  " +
                        " left join BM_PlantGroup PG on A.GroupProdID=PG.ID " +
                        " left join BM_Formula BF on BF.ID=E.FormulaID   " +
                        " left join BM_Plant BP on BP.ID=E.PlantID " +
                        " left join FC_Items I on I.ID=E.ItemID " +
                        " inner join Def_GroupJemur GJ on GJ.ID=A.GroupJemurID  " +
                        " where B.RowStatus>-1  and D.RowStatus >-1) as Def    " +
                        " where DeptID1=2 and CONVERT(varchar,TglPeriksa,112)>=@thnbln1 and CONVERT(varchar,TglPeriksa,112)<=@thnbln2   " +

                        " /** Baru **/ " +
                        " declare @ttlDefectBM int " +
                        " declare @ttlDefectFN int " +
                        " declare @Selisih_ttl_defect int " +
                        " declare @dtlSelisih_ttl_defect int " +
                        " declare @Selisih_ttl_defect2 int " +
                        " declare @TtlDfctSystemBM int " +
                        " declare @TtlDfctSystemFN int " +
                        " declare @TtlDfctBMFN int " +
                        //" declare @TtlDefectBM decimal(10,5) "+
                        " declare @TtlDfctBMFN_OKKW int " +

                        " select * into tempdefectGPIso2 " +
                        " from (  select case when D.DeptID=0 then  case when GJ.GroupJemurName In ('M','N','O','P','Q','R','S','T','U','V','W','X') then  " +
                        " case when D.DefName='retak' then 2 when D.DefName='gompal' then 3 else D.DeptID end else case when (B.Qty/E.Qty) *100 >5 then 2 " +
                        " else 3 end   end  else D.DeptID end deptID1,A.CreatedTime as tglInput,A.Tgl as TglPeriksa,E.TglProduksi as TglProd, " +
                        " D.DefCode,BP.PlantName as Line, PG.[Group],BF.FormulaCode as Jenis,D.DefName,D.DeptID,B.ID,B.DefectID,B.MasterID,B.Qty,A.ID " +
                        " DestID,isnull(A.TPotong,0)  QtyIn,B.Qty*I.Volume as Kubik,isnull(A.TPotong,0) as TotPotong,'' sfrom  " +
                        " from Def_DefectDetail B inner join Def_Defect A on A.Id=B.DefectID   left join Def_MasterDefect D on B.MasterID=D.ID " +
                        " left join BM_Destacking E on E.ID=A.DestID   left join BM_PlantGroup PG on A.GroupProdID=PG.ID " +
                        " left join BM_Formula BF on BF.ID=E.FormulaID    left join BM_Plant BP on BP.ID=E.PlantID left join FC_Items I on I.ID=E.ItemID " +
                        " inner join Def_GroupJemur GJ on GJ.ID=A.GroupJemurID  where B.RowStatus>-1  and D.RowStatus >-1) as Def  " +
                        " where DeptID1=3 and CONVERT(varchar,TglPeriksa,112)>=@thnbln1 and CONVERT(varchar,TglPeriksa,112)<=@thnbln2  " +

                        " /** Detail data transaksi Defect System BM per Group **/ " +
                        " select [Group],Qty into detailDfctSystemBM from ( " +
                        " select [Group],sum(Qty)Qty  from tempdefectGPIso group by [Group] ) as x " +
                        " /** end Detail Defect System BM **/ " +

                        " /** Total Defect BM dan Finishing BP**/ " +
                        " set @TtlDfctBMFN = ( " +
                        " select sum(Qty)Qty  from ( " +
                        " select sum(Qty)Qty,sum(M3)M3 from ( " +
                        " select *,round((Qty*Volume),2)M3 from ( " +
                        " select sum(A.qty *-1) Qty,(B.Tebal*B.Lebar*B.Panjang)/1000000000 Volume from vw_KartustockWIP A  " +
                        " inner join FC_Items B ON A.itemid0=B.ID " +
                        " where qty<0   and lokasi='B99' and process<>'lari' and process<>'listplank' and left(convert(char,tanggal,112),8)>=@thnbln1 and " +
                        " left(convert(char,tanggal,112),8)<=@thnbln2   group by tebal,lebar,panjang ) as x ) as x1 " +
                        " union all " +
                        " select sum(Qty)Qty,sum(M3)M3 from ( " +
                        " select *,round((Qty*Volume),2)M3 from ( " +
                        " select isnull(SUM(qty)*-1,0)Qty,(I.Tebal*I.Lebar*I.Panjang)/1000000000 Volume from vw_KartustockWIP2 V  " +
                        " inner join FC_Items I on V.itemID=I.ID and (I.partno  like '%-p-%'  ) " +
                        " where qty<0  and idrec not like '%ou%'    and process='lari'and lokid1 not in (select ID from fc_lokasi where lokasi='I99') and " +
                        " left(convert(char,tanggal,112),8)>=@thnbln1 and left(convert(char,tanggal,112),8)<=@thnbln2  group by tebal,lebar,panjang) as x ) as x1 ) as xx ) " +
                        " /** Total Defect BM dan Finishing BP**/ " +

                        " /** Total Defect BM dan Finishing OK KW **/ " +
                        " set @TtlDfctBMFN_OKKW = ( " +
                        " select sum(Qty)Qty from ( " +
                        " select sum(Qty)Qty,sum(M3)M3 from ( " +
                        " select *,round((Qty*Volume),2)M3 from ( " +
                        " select sum(A.qty *-1) Qty,(B.Tebal*B.Lebar*B.Panjang)/1000000000 Volume from vw_KartustockWIP A  " +
                        " inner join FC_Items B ON A.itemid0=B.ID " +
                        " where qty<0   and lokasi='H99' and process<>'lari' and process<>'listplank' and left(convert(char,tanggal,112),8)>=@thnbln1 " +
                        " and left(convert(char,tanggal,112),8)<=@thnbln2   group by tebal,lebar,panjang ) as x ) as x1 " +
                        " union all " +
                        " select sum(Qty)Qty,sum(M3)M3 from ( " +
                        " select *,round((Qty*Volume),2)M3 from ( " +
                        " select isnull(SUM(qty)*-1,0)Qty,(I.Tebal*I.Lebar*I.Panjang)/1000000000 Volume from vw_KartustockWIP2 V  " +
                        " inner join FC_Items I on V.itemID=I.ID and (I.partno  like '%-3-%' or I.partno  like '%-M-%'  )     " +
                        " where qty<0  and idrec not like '%ou%'    and process='lari'and lokid1 not in (select ID from fc_lokasi where lokasi='I99') and " +
                        " left(convert(char,tanggal,112),8)>=@thnbln1 and left(convert(char,tanggal,112),8)<=@thnbln2  group by tebal,lebar,panjang) as x ) as x1 ) as xx ) " +
                        " /** Total Defect BM dan Finishing OK KW **/ " +

                        " set @TtlDfctSystemBM = (select sum(Qty)Qty from detailDfctSystemBM) " +
                        " set @TtlDfctSystemFN = (select sum(Qty)Qty from tempdefectGPIso2) " +
                        " set @TtlDefectBM = (select sum(Qty)Qty from detailDfctSystemBM) " +

                        " /** Detail data transaksi Defect System Finishing per Group **/ " +
                        " select [Group],round(((Qty/@TtlDfctSystemBM)*@TtlDfctSystemFN),2)Qty into DtlDefectSystemFN from detailDfctSystemBM " +
                        " /** End Detail data transaksi Defect System Finishing per Group **/ " +

                        " set @Selisih_ttl_defect = (select @TtlDfctBMFN - @TtlDefectBM - @TtlDfctSystemFN) " +
                        " select [Group],(Qty/@TtlDfctSystemBM)*@Selisih_ttl_defect Qty into DtlSelisih from detailDfctSystemBM order by [group] " +

                        " /** Defect Ukuran Khusus BP **/ " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tes1_lmbr]') AND type in (N'U')) DROP TABLE [dbo].tes1_lmbr " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tes2_lmbr]') AND type in (N'U')) DROP TABLE [dbo].tes2_lmbr " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tes3_lmbr]') AND type in (N'U')) DROP TABLE [dbo].tes3_lmbr " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tes4_lmbr]') AND type in (N'U')) DROP TABLE [dbo].tes4_lmbr " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tes5_lmbr]') AND type in (N'U')) DROP TABLE [dbo].tes5_lmbr " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDfctUKhusus_lmbr]') AND type in (N'U')) DROP TABLE [dbo].tempDfctUKhusus_lmbr " +

                        " select * into tes1_lmbr from ( " +
                        " select SUBSTRING(A.partno,1,9)Part,A.PartNo,x.*,((A.Tebal*A.Lebar*A.Panjang)/1000000000)*x.Qty M3 from ( " +
                        " select ItemID,isnull(SUM(Qty),0)  * -1 Qty from vw_KartuStockBJNew where qty <0 and (process  like '%simetris%' ) and " +
                        " (/**Keterangan like '%-3-%' or Keterangan like '%-w-%' or Keterangan like '%-m-%' or **/Keterangan like '%-P-%') and " +
                        " LokID not In (select ID from FC_Lokasi where lokasi='q99')   and left(convert(char,tanggal,112),8)>=@thnbln1 and " +
                        " left(convert(char,tanggal,112),8)<=@thnbln2 and ItemID in (select ID from FC_Items where PartNo like'%-1-%') group by ItemID ) as x " +
                        " inner join FC_Items A ON A.ID=x.ItemID ) as xx " +

                        " select A.PartNo,A.Qty,A.M3,B.Line,B.Prosen into tes2_lmbr from tes1_lmbr A left join Def_UKhususProsen B ON A.PartNo=B.Partno " +
                        " and B.Noted='B.Noted='Defect ukuran khusus'' and left(convert(char,B.Periode,112),6)=left(convert(char,@thnbln1,112),6) " +

                        " select Line,round(sum(Prosentase*Qty),2) Qty into tes3_lmbr from ( " +
                        " select *,cast(Prosen as decimal(10,2))*0.01 Prosentase from tes2_lmbr ) as x group by Line " +

                        " select case when Line=1 then 'KA,KB,KC,KD' when Line=2 then 'KE,KF,KG,KH' when Line=3 then 'KI,KJ,KK,KL' when Line=4 then 'KM,KN,KO,KP' " +
                        " when Line=5 then 'KQ,KR,KS,KT' when Line=6 then 'KU,KV,KW,KX' end [Group],* into tes4_lmbr from tes3_lmbr " +

                        " SELECT A.[Line],   " +
                        "     Split.a.value('.', 'VARCHAR(100)') AS [Group]  ,round((Qty/4),2) Qty into tes5_lmbr " +
                        " FROM  (SELECT [Line],   " +
                        "        CAST ('<M>' + REPLACE([Group], ',', '</M><M>') + '</M>' AS XML) AS String  ,Qty " +
                        "   FROM  tes4_lmbr) AS A CROSS APPLY String.nodes ('/M') AS Split(a); " +

                        " select [Group],Qty into tempDfctUKhusus_lmbr from tes5_lmbr  " +
                        " /** End Defect Ukuran Khusus BP **/ " +

                        " /** Defect Ukuran Khusus OK **/ " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tes1_OK_Lmbr]') AND type in (N'U')) DROP TABLE [dbo].tes1_OK_Lmbr  " +

                        " select * into tes1_OK_Lmbr from ( " +
                        " select SUBSTRING(A.partno,1,9)Part,A.PartNo,x.*,((A.Tebal*A.Lebar*A.Panjang)/1000000000)*x.Qty M3 from ( " +
                        " select ItemID,isnull(SUM(Qty),0)  * -1 Qty from vw_KartuStockBJNew where qty <0 and (process  like '%simetris%' ) and " +
                        " (Keterangan like '%-3-%' or Keterangan like '%-w-%' or Keterangan like '%-m-%') and LokID not In (select ID from FC_Lokasi where lokasi='q99') " +
                        " and left(convert(char,tanggal,112),8)>=@thnbln1 and left(convert(char,tanggal,112),8)<=@thnbln2 and ItemID in (select ID from FC_Items where PartNo like'%-1-%') " +
                        " group by ItemID ) as x inner join FC_Items A ON A.ID=x.ItemID ) as xx " +
                        " /** End Defect Ukuran Khusus OK **/ " +

                        " /** Defect ListPlank **/ " +
                        " /** 1. Out Running Saw **/ " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesLPRs1_Lbr]') AND type in (N'U')) DROP TABLE [dbo].tesLPRs1_Lbr " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesLPRs2_Lbr]') AND type in (N'U')) DROP TABLE [dbo].tesLPRs2_Lbr " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesLPRs3_Lbr]') AND type in (N'U')) DROP TABLE [dbo].tesLPRs3_Lbr  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesLPRs4_Lbr]') AND type in (N'U')) DROP TABLE [dbo].tesLPRs4_Lbr  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesLPRs5_Lbr]') AND type in (N'U')) DROP TABLE [dbo].tesLPRs5_Lbr  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempRSOut_Lbr]') AND type in (N'U')) DROP TABLE [dbo].tempRSOut_Lbr  " +

                        " select PartNo,sum(Qty)Qty,round(sum(M3),4)M3 into tesLPRs1_Lbr from ( " +
                        " select PartNo,Qty,round(((Tebal*Lebar*Panjang)/1000000000)*Qty,4)M3  from ( " +
                        " select PartNo,PartNo2,sum(Qty)Qty,Tebal,Lebar,Panjang  from ( " +
                        " select x1.PartNo,x2.PartNo PartNo2,x2.Tebal,x2.Lebar,x2.Panjang,x.Qty from ( " +
                        " select ItemID0,itemid,Qty * -1 Qty from vw_KartuStockListplank where left(convert(char,tanggal,112),8)>=@thnbln1 and " +
                        " left(convert(char,tanggal,112),8)<=@thnbln2 and process='runingsaw' and qty<0 ) as x  " +
                        " inner join FC_Items x1 ON x.ItemID0=x1.ID " +
                        " inner join FC_Items x2 ON x.ItemID=x2.ID) as A group by PartNo,PartNo2,Tebal,Lebar,Panjang ) as xx ) as xx1 group by PartNo  " +

                        " select A.PartNo,A.M3,A.Qty,B.Line,B.Prosen into tesLPRs2_Lbr from tesLPRs1_Lbr A left join Def_UKhususProsen B ON A.PartNo=B.Partno " +
                        " where B.Noted='Defect ListPlank'  and left(convert(char,B.Periode,112),6)=left(convert(char,@thnbln1,112),6) " +

                        " select Line,sum(M3)M3,sum(Qty)Qty into tesLPRs3_Lbr from ( " +
                        " select * from tesLPRs2_Lbr ) as x group by Line " +

                        " select [Group],Line ,cast(sum(M3) as decimal(10,5))M3,sum(Qty)Qty into tesLPRs4_Lbr  from (  " +
                        " select case when Line=1 then 'KA,KB,KC,KD' when Line=2 then 'KE,KF,KG,KH' when Line=3 then 'KI,KJ,KK,KL' when Line=4 then 'KM,KN,KO,KP' " +
                        " when Line=5 then 'KQ,KR,KS,KT' when Line=6 then 'KU,KV,KW,KX' end [Group],Line,round(M3,5)M3,Qty from tesLPRs3_Lbr  " +
                        " union all  " +
                        " select 'KA,KB,KC,KD'[Group],'1'Line,'0'M3,'0'Qty  " +
                        " union all  " +
                        " select 'KE,KF,KG,KH'[Group],'2'Line,'0'M3,'0'Qty  " +
                        " union all " +
                        " select 'KI,KJ,KK,KL'[Group],'3'Line,'0'M3,'0'Qty  " +
                        " union all  " +
                        " select 'KM,KN,KO,KP'[Group],'4'Line,'0'M3,'0'Qty  " +
                        " union all  " +
                        " select 'KQ,KR,KS,KT'[Group],'5'Line,'0'M3,'0'Qty  " +
                        " union all  " +
                        " select 'KQ,KR,KS,KT'[Group],'6'Line,'0'M3,'0'Qty ) as x group by [Group],Line   " +

                        " SELECT A.[Line],Split.a.value('.', 'VARCHAR(100)') AS [Group]  ,round((Qty/4),4) Qty,round((M3/4),4) M3 into tesLPRs5_Lbr " +
                        " FROM  (SELECT [Line],CAST ('<M>' + REPLACE([Group], ',', '</M><M>') + '</M>' AS XML) AS String,M3,Qty FROM  tesLPRs4_Lbr) AS A " +
                        " CROSS APPLY String.nodes ('/M') AS Split(a); " +

                        " select Line,round(Qty,5)Qty into tempRSOut_Lbr from tesLPRs5_Lbr order by Line " +
                        " /** 1 End **/ " +

                        " /** 2. Saldo Awal Running Saw **/ " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesSAwal_RS_Lbr]') AND type in (N'U')) DROP TABLE [dbo].tesSAwal_RS_Lbr   " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesSAwal_RS1_Lbr]') AND type in (N'U')) DROP TABLE [dbo].tesSAwal_RS1_Lbr  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesSAwal_RS2_Lbr]') AND type in (N'U')) DROP TABLE [dbo].tesSAwal_RS2_Lbr  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesSAwal_RS3_Lbr]') AND type in (N'U')) DROP TABLE [dbo].tesSAwal_RS3_Lbr  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempSAwal_RS_Lbr]') AND type in (N'U')) DROP TABLE [dbo].tempSAwal_RS_Lbr  " +

                        " select PartNo,sum((Volume*Qty))M3,sum(Qty)Qty into tesSAwal_RS_Lbr from ( " +
                        " select x1.PartNo,cast(((x1.Tebal*x1.Lebar*x1.Panjang)/1000000000) as decimal(10,2))Volume,x.Qty from ( " +
                        " select sum(saldo)Qty ,ItemID0 from T1_SaldoListPlank where Process='runingsaw' and thnbln=@BlnThn and Saldo>0 group by ItemID0 ) as x  " +
                        " inner join FC_Items x1 ON x.ItemID0=x1.ID ) as A group by PartNo " +

                        " select A.PartNo,A.Qty,A.M3,B.Line,B.Prosen into tesSAwal_RS1_Lbr from tesSAwal_RS_Lbr A left join Def_UKhususProsen B ON A.PartNo=B.Partno " +
                        " where B.Noted='Defect ListPlank' and left(convert(char,B.Periode,112),6)=left(convert(char,@thnbln1,112),6) " +

                        " select sum(M3)M3,sum(Qty)Qty,Line into tesSAwal_RS2_Lbr from tesSAwal_RS1_Lbr group by Line " +

                        " select [Group],Line ,cast(sum(M3) as decimal(10,5))M3,sum(Qty)Qty into tesSAwal_RS3_Lbr from ( " +
                        " select case when Line=1 then 'KA,KB,KC,KD' when Line=2 then 'KE,KF,KG,KH' when Line=3 then 'KI,KJ,KK,KL' when Line=4 " +
                        " then 'KM,KN,KO,KP' when Line=5 then 'KQ,KR,KS,KT' when Line=6 then 'KU,KV,KW,KX' end [Group],Line,round(M3,5)M3,Qty " +
                        " from tesSAwal_RS2_Lbr " +
                        " union all " +
                        " select 'KA,KB,KC,KD'[Group],'1'Line,'0'M3,'0'Qty " +
                        " union all " +
                        " select 'KE,KF,KG,KH'[Group],'2'Line,'0'M3,'0'Qty " +
                        " union all " +
                        " select 'KI,KJ,KK,KL'[Group],'3'Line,'0'M3,'0'Qty " +
                        " union all " +
                        " select 'KM,KN,KO,KP'[Group],'4'Line,'0'M3,'0'Qty " +
                        " union all " +
                        " select 'KQ,KR,KS,KT'[Group],'5'Line,'0'M3,'0'Qty " +
                        " union all " +
                        " select 'KQ,KR,KS,KT'[Group],'6'Line,'0'M3,'0'Qty ) as x group by [Group],Line  " +

                        " select Line,sum(Qty)Qty into tempSAwal_RS_Lbr from tesSAwal_RS3_Lbr  group by Line " +
                        " /** 2 End **/ " +

                        " /** 3. Saldo Akhir RunningSaw **/ " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesSAkhir_RS0_Lbr]') AND type in (N'U')) DROP TABLE [dbo].tesSAkhir_RS0_Lbr " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesSAkhir_RS1_Lbr]') AND type in (N'U')) DROP TABLE [dbo].tesSAkhir_RS1_Lbr " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesSAkhir_RS2_Lbr]') AND type in (N'U')) DROP TABLE [dbo].tesSAkhir_RS2_Lbr  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesSAkhir_RS3_Lbr]') AND type in (N'U')) DROP TABLE [dbo].tesSAkhir_RS3_Lbr " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesSAkhir_RS4_Lbr]') AND type in (N'U')) DROP TABLE [dbo].tesSAkhir_RS4_Lbr " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempSAkhir_RS_Lbr]') AND type in (N'U')) DROP TABLE [dbo].tempSAkhir_RS_Lbr " +

                        " select PartNo,sum(Qty)Qty,round(sum(M3),4)M3 into tesSAkhir_RS0_Lbr from ( " +
                        " select PartNo,Qty,round(((Tebal*Lebar*Panjang)/1000000000)*Qty,4)M3  from ( " +
                        " select PartNo,PartNo2,sum(Qty)Qty,Tebal,Lebar,Panjang  from ( " +
                        " select x1.PartNo,x2.PartNo PartNo2,x2.Tebal,x2.Lebar,x2.Panjang,x.Qty from ( " +
                        " select sum(Saldo)Qty,ItemID0,ItemID from T1_SaldoListPlank where Process='runingsaw' and thnbln=left(convert(char,@thnbln1,112),6) and Saldo>0 " +
                        " group by ItemID0,ItemID ) as x  " +
                        " inner join FC_Items x1 ON x.ItemID0=x1.ID " +
                        " inner join FC_Items x2 ON x.ItemID=x2.ID) as A group by PartNo,PartNo2,Tebal,Lebar,Panjang ) as xx ) as xx1 group by PartNo  " +

                        " select A.PartNo,A.M3,A.Qty,B.Line,B.Prosen into tesSAkhir_RS1_Lbr from tesSAkhir_RS0_Lbr A left join Def_UKhususProsen B ON A.PartNo=B.Partno " +
                        " where B.Noted='Defect ListPlank' and left(convert(char,B.Periode,112),6)=left(convert(char,@thnbln1,112),6) " +

                        " select Line,sum(M3)M3,sum(Qty)Qty into tesSAkhir_RS2_Lbr from (select * from tesSAkhir_RS1_Lbr ) as x group by Line  " +

                        " select [Group],Line ,cast(sum(M3) as decimal(10,5))M3,sum(Qty)Qty into tesSAkhir_RS3_Lbr from (  " +
                        " select case when Line=1 then 'KA,KB,KC,KD' when Line=2 then 'KE,KF,KG,KH' when Line=3 then 'KI,KJ,KK,KL' when Line=4 then 'KM,KN,KO,KP' " +
                        " when Line=5 then 'KQ,KR,KS,KT' when Line=6 then 'KU,KV,KW,KX' end [Group],Line,round(M3,5)M3,Qty  from tesSAkhir_RS2_Lbr " +
                        " union all " +
                        " select 'KA,KB,KC,KD'[Group],'1'Line,'0'M3,'0'Qty " +
                        " union all " +
                        " select 'KE,KF,KG,KH'[Group],'2'Line,'0'M3,'0'Qty " +
                        " union all " +
                        " select 'KI,KJ,KK,KL'[Group],'3'Line,'0'M3,'0'Qty " +
                        " union all " +
                        " select 'KM,KN,KO,KP'[Group],'4'Line,'0'M3,'0'Qty " +
                        " union all " +
                        " select 'KQ,KR,KS,KT'[Group],'5'Line,'0'M3,'0'Qty " +
                        " union all " +
                        " select 'KQ,KR,KS,KT'[Group],'6'Line,'0'M3,'0'Qty ) as x group by [Group],Line  " +

                        " SELECT A.[Line],   " +
                        "    Split.a.value('.', 'VARCHAR(100)') AS [Group]  ,cast(round((Qty/4),4) as decimal(10,4)) Qty,round((M3/4),4) M3 into tesSAkhir_RS4_Lbr " +
                        " FROM  (SELECT [Line],   " +
                        "        CAST ('<M>' + REPLACE([Group], ',', '</M><M>') + '</M>' AS XML) AS String  ,M3,cast(Qty as decimal(10,4))Qty " +
                        "    FROM  tesSAkhir_RS3_Lbr) AS A CROSS APPLY String.nodes ('/M') AS Split(a); " +

                        " select Line,round(Qty,3)Qty into tempSAkhir_RS_Lbr from tesSAkhir_RS4_Lbr   order by Line " +
                        " /** 3 End **/ " +

                        " /** 4. Saldo Awal Bevel **/ " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesSAwal_Bv0_Lbr]') AND type in (N'U')) DROP TABLE [dbo].tesSAwal_Bv0_Lbr " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesSAwal_Bv1_Lbr]') AND type in (N'U')) DROP TABLE [dbo].tesSAwal_Bv1_Lbr " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesSAwal_Bv2_Lbr]') AND type in (N'U')) DROP TABLE [dbo].tesSAwal_Bv2_Lbr " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesSAwal_Bv3_Lbr]') AND type in (N'U')) DROP TABLE [dbo].tesSAwal_Bv3_Lbr " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesSAwal_Bv4_Lbr]') AND type in (N'U')) DROP TABLE [dbo].tesSAwal_Bv4_Lbr " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempSAwal_Bv_Lbr]') AND type in (N'U')) DROP TABLE [dbo].tempSAwal_Bv_Lbr " +

                        " select PartNo,sum(Qty)Qty,round(sum(M3),4)M3 into tesSAwal_Bv0_Lbr from ( " +
                        " select PartNo,Qty,round(((Tebal*Lebar*Panjang)/1000000000)*Qty,4)M3  from ( " +
                        " select PartNo,PartNo2,sum(Qty)Qty,Tebal,Lebar,Panjang  from ( " +
                        " select x1.PartNo,x2.PartNo PartNo2,x2.Tebal,x2.Lebar,x2.Panjang,x.Qty from ( " +
                        " select sum(Saldo)Qty,ItemID0,ItemID from T1_SaldoListPlank where Process='bevel' and thnbln=@BlnThn and Saldo>0 group by ItemID0,ItemID ) as x  " +
                        " inner join FC_Items x1 ON x.ItemID0=x1.ID " +
                        " inner join FC_Items x2 ON x.ItemID=x2.ID) as A group by PartNo,PartNo2,Tebal,Lebar,Panjang ) as xx ) as xx1 group by PartNo  " +

                        " select A.PartNo,A.M3,A.Qty,B.Line,B.Prosen into tesSAwal_Bv1_Lbr from tesSAwal_Bv0_Lbr A left join Def_UKhususProsen B ON A.PartNo=B.Partno " +
                        " where B.Noted='Defect ListPlank' and left(convert(char,B.Periode,112),6)=left(convert(char,@thnbln1,112),6) " +

                        " select Line,sum(M3)M3,sum(Qty)Qty into tesSAwal_Bv2_Lbr from ( " +
                        " select * from tesSAwal_Bv1_Lbr ) as x group by Line " +

                        " select [Group],Line ,cast(sum(M3) as decimal(10,5))M3,sum(Qty)Qty into tesSAwal_Bv3_Lbr from ( " +
                        " select case when Line=1 then 'KA,KB,KC,KD' when Line=2 then 'KE,KF,KG,KH' when Line=3 then 'KI,KJ,KK,KL' when Line=4 " +
                        " then 'KM,KN,KO,KP' when Line=5 then 'KQ,KR,KS,KT' when Line=6 then 'KU,KV,KW,KX' end [Group],Line,round(M3,2)M3,Qty " +
                        " from tesSAwal_Bv2_Lbr " +
                        " union all " +
                        " select 'KA,KB,KC,KD'[Group],'1'Line,'0'M3,'0'Qty " +
                        " union all " +
                        " select 'KE,KF,KG,KH'[Group],'2'Line,'0'M3,'0'Qty " +
                        " union all " +
                        " select 'KI,KJ,KK,KL'[Group],'3'Line,'0'M3,'0'Qty " +
                        " union all " +
                        " select 'KM,KN,KO,KP'[Group],'4'Line,'0'M3,'0'Qty " +
                        " union all " +
                        " select 'KQ,KR,KS,KT'[Group],'5'Line,'0'M3,'0'Qty " +
                        " union all " +
                        " select 'KQ,KR,KS,KT'[Group],'6'Line,'0'M3,'0'Qty ) as x group by [Group],Line  " +

                        " SELECT A.[Line],   " +
                        "    Split.a.value('.', 'VARCHAR(100)') AS [Group]  ,cast(round((Qty/4),2) as decimal(10,2)) Qty,round((M3/4),2) M3 into tesSAwal_Bv4_Lbr " +
                        " FROM  (SELECT [Line],   " +
                        "        CAST ('<M>' + REPLACE([Group], ',', '</M><M>') + '</M>' AS XML) AS String  ,M3,cast(Qty as decimal(10,2))Qty " +
                        "    FROM  tesSAwal_Bv3_Lbr) AS A CROSS APPLY String.nodes ('/M') AS Split(a); " +

                        " select Line,Qty into tempSAwal_Bv_Lbr from tesSAwal_Bv4_Lbr   order by Line " +
                        " /** End 4 **/ " +

                        " /** 5. Saldo Akhir Bevel **/ " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesSAkhir_Bv0_Lbr]') AND type in (N'U')) DROP TABLE [dbo].tesSAkhir_Bv0_Lbr " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesSAkhir_Bv1_Lbr]') AND type in (N'U')) DROP TABLE [dbo].tesSAkhir_Bv1_Lbr " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesSAkhir_Bv2_Lbr]') AND type in (N'U')) DROP TABLE [dbo].tesSAkhir_Bv2_Lbr " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesSAkhir_Bv3_Lbr]') AND type in (N'U')) DROP TABLE [dbo].tesSAkhir_Bv3_Lbr " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesSAkhir_Bv4_Lbr]') AND type in (N'U')) DROP TABLE [dbo].tesSAkhir_Bv4_Lbr " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempSAkhir_Bv_Lbr]') AND type in (N'U')) DROP TABLE [dbo].tempSAkhir_Bv_Lbr " +

                        " select PartNo,sum(Qty)Qty,round(sum(M3),4)M3 into tesSAkhir_Bv0_Lbr from ( " +
                        " select PartNo,Qty,round(((Tebal*Lebar*Panjang)/1000000000)*Qty,4)M3  from ( " +
                        " select PartNo,PartNo2,sum(Qty)Qty,Tebal,Lebar,Panjang  from ( " +
                        " select x1.PartNo,x2.PartNo PartNo2,x2.Tebal,x2.Lebar,x2.Panjang,x.Qty from ( " +
                        " select sum(Saldo)Qty,ItemID0,ItemID from T1_SaldoListPlank where Process='bevel' and thnbln=left(convert(char,@thnbln1,112),6) and Saldo>0 " +
                        " group by ItemID0,ItemID ) as x  " +
                        " inner join FC_Items x1 ON x.ItemID0=x1.ID " +
                        " inner join FC_Items x2 ON x.ItemID=x2.ID) as A group by PartNo,PartNo2,Tebal,Lebar,Panjang ) as xx ) as xx1 group by PartNo  " +

                        " select A.PartNo,A.M3,A.Qty,B.Line,B.Prosen into tesSAkhir_Bv1_Lbr from tesSAkhir_Bv0_Lbr A left join Def_UKhususProsen B ON A.PartNo=B.Partno " +
                        " where B.Noted='Defect ListPlank' and left(convert(char,B.Periode,112),6)=left(convert(char,@thnbln1,112),6) " +

                        " select Line,sum(M3)M3,sum(Qty)Qty into tesSAkhir_Bv2_Lbr from ( " +
                        "select * from tesSAkhir_Bv1_Lbr ) as x group by Line " +

                        " select [Group],Line ,cast(sum(M3) as decimal(10,5))M3,sum(Qty)Qty into tesSAkhir_Bv3_Lbr from ( " +
                        " select case when Line=1 then 'KA,KB,KC,KD' when Line=2 then 'KE,KF,KG,KH' when Line=3 then 'KI,KJ,KK,KL' when Line=4 then 'KM,KN,KO,KP' " +
                        " when Line=5 then 'KQ,KR,KS,KT' when Line=6 then 'KU,KV,KW,KX' end [Group],Line,round(M3,2)M3,Qty from tesSAkhir_Bv2_Lbr " +
                        " union all " +
                        " select 'KA,KB,KC,KD'[Group],'1'Line,'0'M3,'0'Qty " +
                        " union all " +
                        " select 'KE,KF,KG,KH'[Group],'2'Line,'0'M3,'0'Qty " +
                        " union all " +
                        " select 'KI,KJ,KK,KL'[Group],'3'Line,'0'M3,'0'Qty " +
                        " union all " +
                        " select 'KM,KN,KO,KP'[Group],'4'Line,'0'M3,'0'Qty " +
                        " union all " +
                        " select 'KQ,KR,KS,KT'[Group],'5'Line,'0'M3,'0'Qty " +
                        " union all " +
                        " select 'KQ,KR,KS,KT'[Group],'6'Line,'0'M3,'0'Qty ) as x group by [Group],Line  " +

                        " SELECT A.[Line],   " +
                        "    Split.a.value('.', 'VARCHAR(100)') AS [Group]  ,cast(round((Qty/4),2) as decimal(10,2)) Qty,round((M3/4),2) M3 into tesSAkhir_Bv4_Lbr " +
                        " FROM  (SELECT [Line],  " +
                        "        CAST ('<M>' + REPLACE([Group], ',', '</M><M>') + '</M>' AS XML) AS String  ,M3,cast(Qty as decimal(10,2))Qty " +
                        "    FROM  tesSAkhir_Bv3_Lbr) AS A CROSS APPLY String.nodes ('/M') AS Split(a); " +

                        " select Line,Qty into tempSAkhir_Bv_Lbr from tesSAkhir_Bv4_Lbr   order by Line " +
                        " /** End 5 **/ " +

                        " /** 6. Saldo Awal Strapping **/ " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesSAwal_Str0_Lbr]') AND type in (N'U')) DROP TABLE [dbo].tesSAwal_Str0_Lbr " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesSAwal_Str1_Lbr]') AND type in (N'U')) DROP TABLE [dbo].tesSAwal_Str1_Lbr " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesSAwal_Str2_Lbr]') AND type in (N'U')) DROP TABLE [dbo].tesSAwal_Str2_Lbr " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesSAwal_Str3_Lbr]') AND type in (N'U')) DROP TABLE [dbo].tesSAwal_Str3_Lbr " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesSAwal_Str4_Lbr]') AND type in (N'U')) DROP TABLE [dbo].tesSAwal_Str4_Lbr " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempSAwal_Str_Lbr]') AND type in (N'U')) DROP TABLE [dbo].tempSAwal_Str_Lbr " +

                        " select PartNo,sum(Qty)Qty,round(sum(M3),4)M3 into tesSAwal_Str0_Lbr from ( " +
                        " select PartNo,Qty,round(((Tebal*Lebar*Panjang)/1000000000)*Qty,4)M3  from ( " +
                        " select PartNo,PartNo2,sum(Qty)Qty,Tebal,Lebar,Panjang  from ( " +
                        " select x1.PartNo,x2.PartNo PartNo2,x2.Tebal,x2.Lebar,x2.Panjang,x.Qty from ( " +
                        " select sum(Saldo)Qty,ItemID0,ItemID from T1_SaldoListPlank where Process='straping' and thnbln=@BlnThn and Saldo>0 group by ItemID0,ItemID ) as x  " +
                        " inner join FC_Items x1 ON x.ItemID0=x1.ID " +
                        " inner join FC_Items x2 ON x.ItemID=x2.ID) as A group by PartNo,PartNo2,Tebal,Lebar,Panjang ) as xx ) as xx1 group by PartNo  " +

                        " select A.PartNo,A.M3,A.Qty,B.Line,B.Prosen into tesSAwal_Str1_Lbr from tesSAwal_Str0_Lbr A left join Def_UKhususProsen B ON A.PartNo=B.Partno " +
                        " where B.Noted='Defect ListPlank' and  left(convert(char,B.Periode,112),6)=left(convert(char,@thnbln1,112),6) " +

                        " select Line,sum(M3)M3,sum(Qty)Qty into tesSAwal_Str2_Lbr from ( " +
                        " select * from tesSAwal_Str1_Lbr ) as x group by Line " +

                        " select [Group],Line ,cast(sum(M3) as decimal(10,5))M3,sum(Qty)Qty into tesSAwal_Str3_Lbr from (  " +
                        " select case when Line=1 then 'KA,KB,KC,KD' when Line=2 then 'KE,KF,KG,KH' when Line=3 then 'KI,KJ,KK,KL' when Line=4 then 'KM,KN,KO,KP' " +
                        " when Line=5 then 'KQ,KR,KS,KT' when Line=6 then 'KU,KV,KW,KX' end [Group],Line,round(M3,5)M3,Qty  from tesSAwal_Str2_Lbr  " +
                        " union all " +
                        " select 'KA,KB,KC,KD'[Group],'1'Line,'0'M3,'0'Qty " +
                        " union all " +
                        " select 'KE,KF,KG,KH'[Group],'2'Line,'0'M3,'0'Qty " +
                        " union all " +
                        " select 'KI,KJ,KK,KL'[Group],'3'Line,'0'M3,'0'Qty " +
                        " union all " +
                        " select 'KM,KN,KO,KP'[Group],'4'Line,'0'M3,'0'Qty " +
                        " union all " +
                        " select 'KQ,KR,KS,KT'[Group],'5'Line,'0'M3,'0'Qty " +
                        " union all " +
                        " select 'KQ,KR,KS,KT'[Group],'6'Line,'0'M3,'0'Qty ) as x group by [Group],Line  " +

                        " SELECT A.[Line],  " +
                        "    Split.a.value('.', 'VARCHAR(100)') AS [Group]  ,cast(round((Qty/4),3) as decimal(10,3)) Qty,round((M3/4),4) M3 into tesSAwal_Str4_Lbr " +
                        " FROM  (SELECT [Line],  " +
                        "        CAST ('<M>' + REPLACE([Group], ',', '</M><M>') + '</M>' AS XML) AS String  ,M3,cast(Qty as decimal(10,3))Qty " +
                        "    FROM  tesSAwal_Str3_Lbr) AS A CROSS APPLY String.nodes ('/M') AS Split(a); " +

                        " select Line,round(Qty,5)Qty into tempSAwal_Str_Lbr from tesSAwal_Str4_Lbr   order by Line " +
                        " /** End 6 **/ " +

                        " /** 7. Saldo Akhir Strapping **/ " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesSAkhir_Str0_Lbr]') AND type in (N'U')) DROP TABLE [dbo].tesSAkhir_Str0_Lbr " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesSAkhir_Str1_Lbr]') AND type in (N'U')) DROP TABLE [dbo].tesSAkhir_Str1_Lbr " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesSAkhir_Str2_Lbr]') AND type in (N'U')) DROP TABLE [dbo].tesSAkhir_Str2_Lbr " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesSAkhir_Str3_Lbr]') AND type in (N'U')) DROP TABLE [dbo].tesSAkhir_Str3_Lbr " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesSAkhir_Str4_Lbr]') AND type in (N'U')) DROP TABLE [dbo].tesSAkhir_Str4_Lbr " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempSAkhir_Str_Lbr]') AND type in (N'U')) DROP TABLE [dbo].tempSAkhir_Str_Lbr " +

                        " select PartNo,sum(Qty)Qty,round(sum(M3),4)M3 into tesSAkhir_Str0_Lbr from ( " +
                        " select PartNo,Qty,round(((Tebal*Lebar*Panjang)/1000000000)*Qty,4)M3  from ( " +
                        " select PartNo,PartNo2,sum(Qty)Qty,Tebal,Lebar,Panjang  from ( " +
                        " select x1.PartNo,x2.PartNo PartNo2,x2.Tebal,x2.Lebar,x2.Panjang,x.Qty from ( " +
                        " select sum(Saldo)Qty,ItemID0,ItemID from T1_SaldoListPlank where Process='straping' and thnbln=left(convert(char,@thnbln1,112),6) and Saldo>0 " +
                        " group by ItemID0,ItemID ) as x  " +
                        " inner join FC_Items x1 ON x.ItemID0=x1.ID " +
                        " inner join FC_Items x2 ON x.ItemID=x2.ID) as A group by PartNo,PartNo2,Tebal,Lebar,Panjang ) as xx ) as xx1 group by PartNo  " +

                        " select A.PartNo,A.M3,A.Qty,B.Line,B.Prosen into tesSAkhir_Str1_Lbr from tesSAkhir_Str0_Lbr A left join Def_UKhususProsen B ON A.PartNo=B.Partno " +
                        " where B.Noted='Defect ListPlank' and left(convert(char,B.Periode,112),6)=left(convert(char,@thnbln1,112),6) " +

                        " select Line,sum(M3)M3,sum(Qty)Qty into tesSAkhir_Str2_Lbr from ( " +
                        " select * from tesSAkhir_Str1_Lbr ) as x group by Line " +

                        " select [Group],Line ,cast(sum(M3) as decimal(10,5))M3,sum(Qty)Qty into tesSAkhir_Str3_Lbr from ( " +
                        " select case when Line=1 then 'KA,KB,KC,KD' when Line=2 then 'KE,KF,KG,KH' when Line=3 then 'KI,KJ,KK,KL' when Line=4 then 'KM,KN,KO,KP' " +
                        " when Line=5 then 'KQ,KR,KS,KT' when Line=6 then 'KU,KV,KW,KX' end [Group],Line,round(M3,5)M3,Qty  from tesSAkhir_Str2_Lbr  " +
                        " union all " +
                        " select 'KA,KB,KC,KD'[Group],'1'Line,'0'M3,'0'Qty " +
                        " union all " +
                        " select 'KE,KF,KG,KH'[Group],'2'Line,'0'M3,'0'Qty " +
                        " union all " +
                        " select 'KI,KJ,KK,KL'[Group],'3'Line,'0'M3,'0'Qty " +
                        " union all " +
                        " select 'KM,KN,KO,KP'[Group],'4'Line,'0'M3,'0'Qty " +
                        " union all " +
                        " select 'KQ,KR,KS,KT'[Group],'5'Line,'0'M3,'0'Qty " +
                        " union all " +
                        " select 'KQ,KR,KS,KT'[Group],'6'Line,'0'M3,'0'Qty ) as x group by [Group],Line  " +

                        " SELECT A.[Line],    " +
                        "    Split.a.value('.', 'VARCHAR(100)') AS [Group]  ,cast(round((Qty/4),3) as decimal(10,3)) Qty,round((M3/4),4) M3 into tesSAkhir_Str4_Lbr  " +
                        " FROM  (SELECT [Line],   " +
                        "        CAST ('<M>' + REPLACE([Group], ',', '</M><M>') + '</M>' AS XML) AS String  ,M3,cast(Qty as decimal(10,3))Qty  " +
                        "    FROM  tesSAkhir_Str3_Lbr) AS A CROSS APPLY String.nodes ('/M') AS Split(a);  " +

                        " select Line,round(Qty,5)Qty into tempSAkhir_Str_Lbr from tesSAkhir_Str4_Lbr   order by Line  " +
                        " /** End 7 **/  " +

                        " /** 8. Tahap III OK **/ " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesTahap3_OK0_Lbr]') AND type in (N'U')) DROP TABLE [dbo].tesTahap3_OK0_Lbr " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesTahap3_OK1_Lbr]') AND type in (N'U')) DROP TABLE [dbo].tesTahap3_OK1_Lbr " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesTahap3_OK2_Lbr]') AND type in (N'U')) DROP TABLE [dbo].tesTahap3_OK2_Lbr " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesTahap3_OK3_Lbr]') AND type in (N'U')) DROP TABLE [dbo].tesTahap3_OK3_Lbr " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesTahap3_OK4_Lbr]') AND type in (N'U')) DROP TABLE [dbo].tesTahap3_OK4_Lbr " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTahap3_OK_Lbr]') AND type in (N'U')) DROP TABLE [dbo].tempTahap3_OK_Lbr " +

                        " select PartNo,sum(Qty)Qty,round(sum(M3),4)M3 into tesTahap3_OK0_Lbr from ( " +
                        " select PartNo,Qty,round(((Tebal*Lebar*Panjang)/1000000000)*Qty,4)M3  from ( " +
                        " select PartNo,sum(Qty)Qty,Tebal,Lebar,Panjang  from ( " +
                        " select x.PartNo ,x2.Tebal,x2.Lebar,x2.Panjang,x.Qty from ( " +
                        " select sum(Qty)Qty,ItemID,Keterangan Partno from vw_KartuStockBJNew " +
                        " where sfrom='straping' and left(convert(char,tanggal,112),6)=left(convert(char,@thnbln1,112),6) and ItemID in " +
                        " (select ID from FC_Items where PartNo like'%-M-%' or PartNo like'%-3-%')  group by ItemID,Keterangan ) as x  " +
                        " inner join FC_Items x2 ON x.ItemID=x2.ID) as A group by PartNo,Tebal,Lebar,Panjang ) as xx ) as xx1 group by PartNo  " +

                        " select A.PartNo,A.M3,A.Qty,B.Line,B.Prosen into tesTahap3_OK1_Lbr from tesTahap3_OK0_Lbr A left join Def_UKhususProsen B ON A.PartNo=B.Partno " +
                        " where B.Noted='Defect ListPlank' and left(convert(char,B.Periode,112),6)=left(convert(char,@thnbln1,112),6) " +

                        " select Line,sum(M3)M3,sum(Qty)Qty into tesTahap3_OK2_Lbr from ( " +
                        " select * from tesTahap3_OK1_Lbr ) as x group by Line " +

                        " select [Group],Line ,cast(sum(M3) as decimal(10,5))M3,sum(Qty)Qty into tesTahap3_OK3_Lbr from ( " +
                        " select case when Line=1 then 'KA,KB,KC,KD' when Line=2 then 'KE,KF,KG,KH' when Line=3 then 'KI,KJ,KK,KL' when Line=4 then 'KM,KN,KO,KP' " +
                        " when Line=5 then 'KQ,KR,KS,KT' when Line=6 then 'KU,KV,KW,KX' end [Group],Line,round(M3,4)M3,Qty from tesTahap3_OK2_Lbr " +
                        " union all " +
                        " select 'KA,KB,KC,KD'[Group],'1'Line,'0'M3,'0'Qty " +
                        " union all " +
                        " select 'KE,KF,KG,KH'[Group],'2'Line,'0'M3,'0'Qty " +
                        " union all " +
                        " select 'KI,KJ,KK,KL'[Group],'3'Line,'0'M3,'0'Qty " +
                        " union all " +
                        " select 'KM,KN,KO,KP'[Group],'4'Line,'0'M3,'0'Qty " +
                        " union all " +
                        " select 'KQ,KR,KS,KT'[Group],'5'Line,'0'M3,'0'Qty " +
                        " union all " +
                        " select 'KQ,KR,KS,KT'[Group],'6'Line,'0'M3,'0'Qty ) as x group by [Group],Line  " +

                        " SELECT A.[Line],   " +
                        "    Split.a.value('.', 'VARCHAR(100)') AS [Group]  ,cast(round((Qty/4),4) as decimal(10,4)) Qty,round((M3/4),4) M3 into tesTahap3_OK4_Lbr " +
                        " FROM  (SELECT [Line], " +
                        "        CAST ('<M>' + REPLACE([Group], ',', '</M><M>') + '</M>' AS XML) AS String  ,M3,cast(Qty as decimal(10,4))Qty " +
                        "    FROM  tesTahap3_OK3_Lbr) AS A CROSS APPLY String.nodes ('/M') AS Split(a);	 " +

                        " select line,round(Qty,2)Qty into tempTahap3_OK_Lbr from ( " +
                        " select sum(Qty)Qty,line from tesTahap3_OK4_Lbr group by line ) as x " +
                        " /** End 8 **/ " +

                        " /** 9. Tahap III BP **/ " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesTahap3_BP0_Lbr]') AND type in (N'U')) DROP TABLE [dbo].tesTahap3_BP0_Lbr " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesTahap3_BP1_Lbr]') AND type in (N'U')) DROP TABLE [dbo].tesTahap3_BP1_Lbr " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesTahap3_BP2_Lbr]') AND type in (N'U')) DROP TABLE [dbo].tesTahap3_BP2_Lbr " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesTahap3_BP3_Lbr]') AND type in (N'U')) DROP TABLE [dbo].tesTahap3_BP3_Lbr " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesTahap3_BP4_Lbr]') AND type in (N'U')) DROP TABLE [dbo].tesTahap3_BP4_Lbr " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTahap3_BP_Lbr]') AND type in (N'U')) DROP TABLE [dbo].tempTahap3_BP_Lbr " +

                        " select PartNo,sum(Qty)Qty,round(sum(M3),4)M3 into tesTahap3_BP0_Lbr from ( " +
                        " select PartNo,Qty,round(((Tebal*Lebar*Panjang)/1000000000)*Qty,4)M3  from ( " +
                        " select PartNo,sum(Qty)Qty,Tebal,Lebar,Panjang  from ( " +
                        " select x.PartNo ,x2.Tebal,x2.Lebar,x2.Panjang,x.Qty from ( " +
                        " select sum(Qty)Qty,ItemID,Keterangan Partno from vw_KartuStockBJNew " +
                        " where sfrom='straping' and left(convert(char,tanggal,112),6)=left(convert(char,@thnbln1,112),6) and " +
                        " ItemID in (select ID from FC_Items where PartNo like'%-P-%')  group by ItemID,Keterangan ) as x  " +
                        " inner join FC_Items x2 ON x.ItemID=x2.ID) as A group by PartNo,Tebal,Lebar,Panjang ) as xx ) as xx1 group by PartNo  " +

                        " select A.PartNo,A.M3,A.Qty,B.Line,B.Prosen into tesTahap3_BP1_Lbr from tesTahap3_BP0_Lbr A left join Def_UKhususProsen B ON A.PartNo=B.Partno " +
                        " where B.Noted='Defect ListPlank' and left(convert(char,B.Periode,112),6)=left(convert(char,@thnbln1,112),6) " +

                        " select Line,sum(M3)M3,sum(Qty)Qty into tesTahap3_BP2_Lbr from ( " +
                        " select * from tesTahap3_BP1_Lbr ) as x group by Line " +

                        " select [Group],Line ,cast(sum(M3) as decimal(10,5))M3,sum(Qty)Qty into tesTahap3_BP3_Lbr from ( " +
                        " select case when Line=1 then 'KA,KB,KC,KD' when Line=2 then 'KE,KF,KG,KH' when Line=3 then 'KI,KJ,KK,KL' when Line=4 then 'KM,KN,KO,KP'  " +
                        " when Line=5 then 'KQ,KR,KS,KT' when Line=6 then 'KU,KV,KW,KX' end [Group],Line,round(M3,4)M3,Qty  from tesTahap3_BP2_Lbr " +
                        " union all " +
                        " select 'KA,KB,KC,KD'[Group],'1'Line,'0'M3,'0'Qty " +
                        " union all " +
                        " select 'KE,KF,KG,KH'[Group],'2'Line,'0'M3,'0'Qty " +
                        " union all " +
                        " select 'KI,KJ,KK,KL'[Group],'3'Line,'0'M3,'0'Qty " +
                        " union all " +
                        " select 'KM,KN,KO,KP'[Group],'4'Line,'0'M3,'0'Qty " +
                        " union all " +
                        " select 'KQ,KR,KS,KT'[Group],'5'Line,'0'M3,'0'Qty " +
                        " union all " +
                        " select 'KQ,KR,KS,KT'[Group],'6'Line,'0'M3,'0'Qty ) as x group by [Group],Line  " +

                        " SELECT A.[Line],   " +
                        "     Split.a.value('.', 'VARCHAR(100)') AS [Group]  ,cast(round((Qty/4),2) as decimal(10,2)) Qty,round((M3/4),4) M3 into tesTahap3_BP4_Lbr " +
                        " FROM  (SELECT [Line],   " +
                        "         CAST ('<M>' + REPLACE([Group], ',', '</M><M>') + '</M>' AS XML) AS String  ,M3,cast(Qty as decimal(10,2))Qty " +
                        "     FROM  tesTahap3_BP3_Lbr) AS A CROSS APPLY String.nodes ('/M') AS Split(a); " +

                        " select line,round(Qty,4)Qty into tempTahap3_BP_Lbr from (select sum(Qty)Qty,line from tesTahap3_BP4_Lbr group by line ) as x " +
                        " /** End 9 **/ " +

                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempBagiDefect_LP_Lr]') AND type in (N'U')) DROP TABLE [dbo].tempBagiDefect_LP_Lr " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempBagiDefect_LP1_Lr]') AND type in (N'U')) DROP TABLE [dbo].tempBagiDefect_LP1_Lr " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempBagiDefect_LP2_Lr]') AND type in (N'U')) DROP TABLE [dbo].tempBagiDefect_LP2_Lr " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempBagiDefect_LP3_Lr]') AND type in (N'U')) DROP TABLE [dbo].tempBagiDefect_LP3_Lr " +

                        " select Line,round(sum(Qty),1)Qty into tempBagiDefect_LP_Lr from ( " +
                        " select line,sum(Qty)Qty from ( " +
                        " select line,sum(Qty)Qty from ( " +
                        " select line,round(sum(Qty),2)Qty from ( " +
                        " select Line,round(Qty,4)Qty from tempRSOut_Lbr ) as x group by line " +
                        " union all " +
                        " select line,sum(Qty)Qty from ( " +
                        " /** 1 **/ " +
                        " select Line,round(sum(Qty),5)Qty from ( " +
                        " select line,round(Qty,5)Qty from tempSAwal_RS_Lbr " +
                        " union all " +
                        " select Line,round(Qty*-1,5) Qty from tempSAkhir_RS_Lbr ) as x group by line " +
                        " /** 1 **/ " +
                        " union all " +
                        " /** 2 **/ " +
                        " select Line,sum(Qty)Qty from ( " +
                        " select * from tempSAwal_Bv_Lbr " +
                        " union all " +
                        " select Line,Qty*-1 Qty from tempSAkhir_Bv_Lbr ) as x group by line " +
                        "/** 2 **/ " +
                        "union all " +
                        "/** 3 **/ " +
                        "select Line,round(sum(Qty),2)Qty from ( " +
                        "select Line,round(sum(Qty),3)Qty from tempSAwal_Str_Lbr group by line " +
                        "union all " +
                        "select Line,Qty*-1 Qty from tempSAkhir_Str_Lbr ) as x group by line  " +
                        "/** 3 **/ " +
                        ") as A group by line ) as B group by line " +
                        "union all " +
                        "select Line,Qty*-1 Qty from tempTahap3_OK_Lbr " +
                        ") as C group by line " +
                        "union all " +
                        "select Line,round(Qty,5)Qty from tempTahap3_BP_Lbr  " +
                        ") as D  group by line " +

                        " select [Group],Line ,cast(sum(Qty) as decimal(10,5))Qty into tempBagiDefect_LP1_Lr from ( " +
                        " select case when Line=1 then 'KA,KB,KC,KD' when Line=2 then 'KE,KF,KG,KH' when Line=3 then 'KI,KJ,KK,KL' " +
                        " when Line=4 then 'KM,KN,KO,KP' when Line=5 then 'KQ,KR,KS,KT' when Line=6 then 'KU,KV,KW,KX' end [Group],Line,round(Qty,2)Qty " +
                        " from tempBagiDefect_LP_Lr " +
                        " union all " +
                        " select 'KA,KB,KC,KD'[Group],'1'Line,'0'Qty " +
                        " union all " +
                        " select 'KE,KF,KG,KH'[Group],'2'Line,'0'Qty " +
                        " union all " +
                        " select 'KI,KJ,KK,KL'[Group],'3'Line,'0'Qty " +
                        " union all " +
                        " select 'KM,KN,KO,KP'[Group],'4'Line,'0'Qty " +
                        " union all " +
                        " select 'KQ,KR,KS,KT'[Group],'5'Line,'0'Qty " +
                        " union all " +
                        " select 'KQ,KR,KS,KT'[Group],'6'Line,'0'Qty ) as x group by [Group],Line " +

                        " SELECT A.[Line],   " +
                        "    Split.a.value('.', 'VARCHAR(100)') AS [Group]  ,round((Qty/4),2) Qty into tempBagiDefect_LP2_Lr " +
                        " FROM  (SELECT [Line],  " +
                        "        CAST ('<M>' + REPLACE([Group], ',', '</M><M>') + '</M>' AS XML) AS String  ,Qty " +
                        "    FROM  tempBagiDefect_LP1_Lr) AS A CROSS APPLY String.nodes ('/M') AS Split(a); " +

                        " select [Group],Qty into tempBagiDefect_LP3_Lr from tempBagiDefect_LP2_Lr order by [group] " +

                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDefect_Prod_lbr]') AND type in (N'U')) DROP TABLE [dbo].tempDefect_Prod_lbr " +

                        " select [Group],round(Qty,2)Qty into tempDefect_Prod_lbr from ( " +
                        " select [Group],round(sum(Qty),2)Qty from ( " +
                        " select * from detailDfctSystemBM  " +
                        " union all " +
                        " select [Group],Qty from DtlDefectSystemFN " +
                        " union all " +
                        " select * from DtlSelisih  " +
                        " union all " +
                        " select * from tempDfctUKhusus_lmbr " +
                        " union all " +
                        " select * from tempBagiDefect_LP3_Lr " +
                        " ) as x group by [group] ) as x1 order by [group] " +
                        " /** End Defect ListPlank **/  " +

                        " /** Total Defect ListPlank OK **/ " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTtl_LP_OK_lbr]') AND type in (N'U')) DROP TABLE [dbo].tempTtl_LP_OK_lbr " +

                        " select round(sum(Qty),0)Qty into tempTtl_LP_OK_lbr from ( " +
                        " select sum(Qty)Qty from ( " +
                        " select line,round(sum(Qty),2)Qty from ( " +
                        " select Line,round(Qty,5)Qty from tempRSOut_lbr ) as x group by line " +
                        " union all " +
                        " select line,sum(Qty)Qty from ( " +
                        " /** 1 **/ " +
                        " select Line,round(sum(Qty),5)Qty from ( " +
                        " select line,round(Qty,5)Qty from tempSAwal_RS_lbr " +
                        " union all " +
                        " select Line,round(Qty*-1,5) Qty from tempSAkhir_RS_lbr ) as x group by line " +
                        " /** 1 **/ " +
                        " union all " +
                        " /** 2 **/ " +
                        " select Line,sum(Qty)Qty from ( " +
                        " select * from tempSAwal_Bv_lbr " +
                        " union all " +
                        " select Line,Qty*-1 Qty from tempSAkhir_Bv_lbr ) as x group by line " +
                        " /** 2 **/ " +
                        " union all " +
                        " /** 3 **/ " +
                        " select Line,round(sum(Qty),5)Qty from ( " +
                        " select Line,round(sum(Qty),5)Qty from tempSAwal_Str_lbr group by line " +
                        " union all " +
                        " select Line,Qty*-1 Qty from tempSAkhir_Str_lbr ) as x group by line  " +
                        " /** 3 **/ " +
                        " ) as A group by line ) as B group by line ) as x1 " +
                        " /** End Total Defect ListPlank OK **/ " +

                        " /** Data BS Tahap I **/ " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDataBSauto]') AND type in (N'U')) DROP TABLE [dbo].tempDataBSauto  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempKSBJNewBSAuto]') AND type in (N'U')) DROP TABLE [dbo].tempKSBJNewBSAuto  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempKSBJNewBSAuto1]') AND type in (N'U')) DROP TABLE [dbo].tempKSBJNewBSAuto1 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempKSBJNew]') AND type in (N'U')) DROP TABLE [dbo].tempKSBJNew  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempKSBJNew1]') AND type in (N'U')) DROP TABLE [dbo].tempKSBJNew1   " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempBSTahap1]') AND type in (N'U')) DROP TABLE [dbo].tempBSTahap1   " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDetailBSTahap1_lbr]') AND type in (N'U')) DROP TABLE [dbo].tempDetailBSTahap1_lbr  " +

                        " declare @periode varchar(10)  select @periode=left(convert(char,@thnbln1,112),6) " +

                        " select distinct itemid into tempDataBSauto from vw_KartuStockBJNew where itemid in (select ID from fc_items where partno like '%-s-%') and " +
                        " LokID in (select ID from FC_Lokasi where Lokasi='bsauto') " +

                        " select * into tempKSBJNewBSAuto from vw_KartuStockBJNew where left(CONVERT(char, tanggal ,112),6)=@periode and itemID in  " +
                        " (select itemid from tempDataBSauto)  " +
                        " select * into tempKSBJNew from vw_KartuStockBJNew where left(CONVERT(char, tanggal ,112),6)=@periode and itemID not in  " +
                        " (select itemid from tempDataBSauto) " +

                        " select sum(Qty)Qty,round(sum(Qty*Volume),2)M3 into tempKSBJNewBSAuto1 from ( " +
                        " select x.qty Qty,((x1.Tebal*x1.Lebar*x1.Panjang)/1000000000)Volume from ( " +
                        " select Qty,ItemID from tempKSBJNewBSAuto where (process='direct' or process like'%Simetris%') and (isnull(sfrom,'-')='-' or isnull(sfrom,'bevel')='-' " +
                        " or isnull(sfrom,'-')='straping') and lokid in (select ID from FC_Lokasi where Lokasi='BSAUTO') and substring(Keterangan,1,21) like '%-1-%' " +
                        " and left(convert(char,tanggal,112),6)=@periode and PartNo  like'%-S-%') as x inner join FC_Items x1 ON x.ItemID=x1.ID ) as A " +

                        " select sum(Qty)Qty,sum(Qty*Volume)M3 into tempKSBJNew1 from ( " +
                        " select x.qty Qty,((x1.Tebal*x1.Lebar*x1.Panjang)/1000000000)Volume from ( " +
                        " select Qty,ItemID from tempKSBJNew where (process='direct' or process like'%Simetris%') and (isnull(sfrom,'-')='-' or isnull(sfrom,'bevel')='-' " +
                        " or isnull(sfrom,'-')='straping') and lokid not in (select ID from FC_Lokasi where Lokasi='BSAUTO') and substring(Keterangan,1,21) like '%-1-%' " +
                        " and left(convert(char,tanggal,112),6)=@periode and PartNo  like'%-S-%') as x inner join FC_Items x1 ON x.ItemID=x1.ID ) as A " +

                        " select sum(Qty)Qty,round(sum(M3),1)M3 into tempBSTahap1 from ( " +
                        " select * from tempKSBJNewBSAuto1 union all " +
                        " select * from tempKSBJNew1 ) as x " +

                        " declare @TtlBS_Tahap1_lbr varchar(10) " +
                        " set @TtlBS_Tahap1_lbr = (select Qty from tempBSTahap1) " +

                        " select [Group],round((Qty/@TtlDfctSystemBM)* @TtlBS_Tahap1_lbr,2) Qty into tempDetailBSTahap1_lbr from detailDfctSystemBM order by [group] " +
                        " /** end Data BS Tahap I **/ " +

                        " /** Total Potong QA **/ " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTotPotong_QA_lbr]') AND type in (N'U')) DROP TABLE [dbo].tempTotPotong_QA_lbr  " +

                        " select  B.[Group],round(sum(qtyin),2) TotPotong into tempTotPotong_QA_lbr from BM_Destacking A left join BM_PlantGroup B on A.PlantGroupID=B.ID " +
                        " inner join (  select C.ID DestID , A.TPotong qtyin,A.TPotong*I.Volume as kubik,A.TPotong*I.Volume TPotongM3 from Def_Defect A  " +
                        " inner join BM_Destacking C on A.DestID=C.ID left join FC_Items I on I.ID=C.ItemID where A.Status>-1 and CONVERT(char,A.tgl,112)>=@thnbln1 and " +
                        " CONVERT(char,A.tgl,112)<=@thnbln2 ) as C  on A.ID=C.DestID group by B.[Group] " +
                        " /** End Total Potong QA **/ " +

                        " /** Total Potong Defect Ukuran Khusus **/ " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDef1_OKBP_lbr]') AND type in (N'U')) DROP TABLE [dbo].tempDef1_OKBP_lbr " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDef2_OKBP_lbr]') AND type in (N'U')) DROP TABLE [dbo].tempDef2_OKBP_lbr  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDef_Khusus_OKBP_lbr]') AND type in (N'U')) DROP TABLE [dbo].tempDef_Khusus_OKBP_lbr " +

                        " select * into tempDef1_OKBP_lbr from ( " +
                        " select SUBSTRING(A.partno,1,9)Part,A.PartNo,x.*,((A.Tebal*A.Lebar*A.Panjang)/1000000000)*x.Qty M3 from ( " +
                        " select ItemID,isnull(SUM(Qty),0)  * -1 Qty from vw_KartuStockBJNew where qty <0 and (process  like '%simetris%' ) and " +
                        " (Keterangan like '%-3-%' or Keterangan like '%-w-%' or Keterangan like '%-m-%'or Keterangan like '%-P-%') and LokID not In " +
                        " (select ID from FC_Lokasi where lokasi='q99')   and left(convert(char,tanggal,112),8)>=@thnbln1 " +
                        " and left(convert(char,tanggal,112),8)<=@thnbln2 and ItemID in (select ID from FC_Items where PartNo like'%-1-%') " +
                        " group by ItemID ) as x inner join FC_Items A ON A.ID=x.ItemID ) as xx " +

                        " select A.PartNo,A.Qty,A.M3,B.Line,B.Prosen2 into tempDef2_OKBP_lbr " +
                        " from tempDef1_OKBP_lbr A left join Def_UKhususProsen B ON A.PartNo=B.Partno where B.Noted='Defect ukuran khusus' " +
                        " and left(convert(char,B.Periode,112),6)=left(convert(char,@thnbln1,112),6) " +

                        " select Line,round(sum(Prosentase*Qty),4) Qty into tempDef_Khusus_OKBP_lbr from ( " +
                        " select *,cast(Prosen2 as decimal(10,4))*0.01 Prosentase from tempDef2_OKBP_lbr ) as x group by Line " +
                        " /** End Total Potong Defect Ukuran Khusus **/ " +

                        " /** Total Potong Defect ListPlank **/ " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDef_LP_lbr]') AND type in (N'U')) DROP TABLE [dbo].tempDef_LP_lbr " +

                        " select Line,sum(Qty)Qty into tempDef_LP_lbr from ( " +
                        " select line,sum(Qty)Qty from ( " +
                        " select line,sum(Qty)Qty from ( " +
                        " select line,round(sum(Qty),2)Qty from ( " +
                        " select Line,round(Qty,4)Qty from tempRSOut_lbr ) as x group by line " +
                        " union all " +
                        " select line,sum(Qty)Qty from ( " +
                        " /** 1 **/ " +
                        " select Line,round(sum(Qty),5)Qty from ( " +
                        " select line,round(Qty,5)Qty from tempSAwal_RS_lbr " +
                        " union all " +
                        " select Line,round(Qty*-1,5) Qty from tempSAkhir_RS_lbr ) as x group by line " +
                        " /** 1 **/ " +
                        " union all " +
                        " /** 2 **/ " +
                        " select Line,sum(Qty)Qty from ( " +
                        " select * from tempSAwal_Bv_lbr " +
                        " union all " +
                        " select Line,Qty*-1 Qty from tempSAkhir_Bv_lbr ) as x group by line " +
                        " /** 2 **/ " +
                        " union all " +
                        " /** 3 **/ " +
                        " select Line,round(sum(Qty),2)Qty from ( " +
                        " select Line,round(sum(Qty),3)Qty from tempSAwal_Str_lbr group by line " +
                        " union all " +
                        " select Line,Qty*-1 Qty from tempSAkhir_Str_lbr ) as x group by line  " +
                        " /** 3 **/ " +
                        " ) as A group by line ) as B group by line) as C where Qty>0 group by line  " +
                        " union all " +
                        " select * from tempBagiDefect_LP_Lr where Qty>0 or Qty<0 ) as A1 group by Line " +
                        " /** End Total Potong Defect ListPlank **/ " +

                        " /** Total Potong Defect ListPlank dan Defect Ukuran Khusus **/ " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTtlPot1_LPU_lbr]') AND type in (N'U')) DROP TABLE [dbo].tempTtlPot1_LPU_lbr " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTtlPot2_LPU_lbr]') AND type in (N'U')) DROP TABLE [dbo].tempTtlPot2_LPU_lbr " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTtlPot3_LPU_lbr]') AND type in (N'U')) DROP TABLE [dbo].tempTtlPot3_LPU_lbr " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTtlPot_LPU_lbr]') AND type in (N'U')) DROP TABLE [dbo].tempTtlPot_LPU_lbr " +

                        " select Line,sum(Qty)Qty into tempTtlPot1_LPU_lbr from ( " +
                        " select * from tempDef_Khusus_OKBP_lbr " +
                        " union all " +
                        " select * from tempDef_LP_lbr ) as x group by Line " +

                        " select [Group],Line ,sum(Qty)Qty into tempTtlPot2_LPU_lbr  from ( " +
                        " select case when Line=1 then 'KA,KB,KC,KD' when Line=2 then 'KE,KF,KG,KH' when Line=3 then 'KI,KJ,KK,KL' when Line=4 then 'KM,KN,KO,KP' " +
                        " when Line=5 then 'KQ,KR,KS,KT' when Line=6 then 'KU,KV,KW,KX' end [Group],Line,round(Qty,5)Qty from tempTtlPot1_LPU_lbr " +
                        " union all " +
                        " select 'KA,KB,KC,KD'[Group],'1'Line,'0'Qty " +
                        " union all " +
                        " select 'KE,KF,KG,KH'[Group],'2'Line,'0'Qty " +
                        " union all " +
                        " select 'KI,KJ,KK,KL'[Group],'3'Line,'0'Qty " +
                        " union all " +
                        " select 'KM,KN,KO,KP'[Group],'4'Line,'0'Qty " +
                        " union all " +
                        " select 'KQ,KR,KS,KT'[Group],'5'Line,'0'Qty " +
                        " union all " +
                        " select 'KQ,KR,KS,KT'[Group],'6'Line,'0'Qty ) as x group by [Group],Line  " +

                        " SELECT A.[Line],   " +
                        "     Split.a.value('.', 'VARCHAR(100)') AS [Group]  ,round((Qty/4),2) Qty into tempTtlPot3_LPU_lbr " +
                        " FROM  (SELECT [Line],  " +
                         "        CAST ('<M>' + REPLACE([Group], ',', '</M><M>') + '</M>' AS XML) AS String  ,Qty " +
                         "    FROM  tempTtlPot2_LPU_lbr) AS A CROSS APPLY String.nodes ('/M') AS Split(a); " +

                        " select [Group],round(Qty,2)Qty into tempTtlPot_LPU_lbr from tempTtlPot3_LPU_lbr order by [group] " +
                        " /** End Total Potong Defect ListPlank dan Defect Ukuran Khusus **/ " +

                        " /** Total Potong System dan ListPlank **/ " +
                        " declare @TtlPot_LPSystem_lbr decimal(10,2) " +
                        " set @TtlPot_LPSystem_lbr = ( " +
                        " select sum(Qty)Qty from ( " +
                        " select @TtlDfctBMFN Qty /**Defect_BP**/ union all " +
                        " select @TtlDfctBMFN_OKKW Qty /**Defect_OK**/ union all " +
                        " select round(sum(Qty),1)Qty /**Khusus_BP**/ from tempDfctUKhusus_lmbr union all " +
                        " select round(sum(Qty),1)Qty /**Khusus_OK**/ from tes1_OK_Lmbr union all " +
                        " select round(sum(Qty),1)Qty /**ListPlank_BP**/ from tempBagiDefect_LP3_Lr union all " +
                        " select round(sum(Qty),1)Qty /**ListPlank_OK**/ from tempTtl_LP_OK_lbr union all " +
                        " select round(sum(Qty),1)Qty /**BS_BP**/ from tempBSTahap1 ) as x )  " +
                        " /** End Total Potong System dan ListPlank **/ " +

                        " /** Detail Total Potong System dan ListPlank **/ " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDtlTtlPot_LP_lbr]') AND type in (N'U')) DROP TABLE [dbo].tempDtlTtlPot_LP_lbr " +

                        " select [Group],round(sum(Qty),1)Qty into tempDtlTtlPot_LP_lbr from ( " +
                        " select [Group],TotPotong Qty from tempTotPotong_QA_lbr union all " +
                        " select * from tempTtlPot_LPU_lbr ) as x group by [Group] " +
                        " /** End Detail Total Potong System dan ListPlank **/  " +

                        " /** Selisih Total Potong **/ " +
                        " declare @TtlPot_Selisih_lbr decimal(10,2) " +
                        " declare @TtlPotSystem_ListPlank_lbr decimal(10,2) " +

                        " set @TtlPotSystem_ListPlank_lbr =(select sum(Qty)Qty from tempDtlTtlPot_LP_lbr) " +
                        " set @TtlPot_Selisih_lbr = ( @TtlPot_LPSystem_lbr - @TtlPotSystem_ListPlank_lbr) " +
                        " /** End Selisih Total Potong **/ " +

                        " /** Total Group Produksi **/ " +
                        " declare @TtlGroup varchar(3) " +
                        " set @TtlGroup=(select count([Group])TtlGroup from ( " +
                        " select [Group] from ( " +
                        " select [Group] from detailDfctSystemBM union all " +
                        " select [Group] from DtlDefectSystemFN ) as x group by [Group] ) as x1) " +
                        " /** End Total Group Produksi **/ " +

                        " /** Detail Selisih Total Potong **/ " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[DtlSelisihTtlPot_LP_lbr]') AND type in (N'U')) DROP TABLE [dbo].DtlSelisihTtlPot_LP_lbr " +

                        " select [Group],round(@TtlPot_Selisih_lbr/@TtlGroup,1) Qty into DtlSelisihTtlPot_LP_lbr from ( " +
                        " select [Group] from detailDfctSystemBM union all " +
                        " select [Group] from DtlDefectSystemFN ) as x group by [Group] " +
                        " /** End Detail Selisih Total Potong **/ " +

                        " /** Detail Total Potong **/ " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDetail_TtlPot_lbr]') AND type in (N'U')) DROP TABLE [dbo].tempDetail_TtlPot_lbr " +

                        " select [Group],round(sum(Qty),0)Qty into tempDetail_TtlPot_lbr from ( " +
                        " select * from tempDtlTtlPot_LP_lbr union all " +
                        " select * from DtlSelisihTtlPot_LP_lbr ) as x group by [Group] " +
                        " /** End Detail Total Potong **/ " +
                        " /** End Tambahan Baru **/ " +
                        " " +
                         QueryTotalPotong +
                        " " +
                        "declare @DefectFin decimal(18,2) " +
                        "set @DefectFin= (select sum(kubik) from (  " +
                        "select case when D.DeptID=0 then  " +
                        "case when GJ.GroupJemurName In ('M','N','O','P','Q','R','S','T','U','V','W','X') then   " +
                        "case when D.DefName='retak' then 2   " +
                        "when D.DefName='gompal' then 3  " +
                        "else D.DeptID end   " +
                        "else    " +
                        "case when (B.Qty/E.Qty) *100 >5 then 2 else 3 end   " +
                        "end  " +
                        "else D.DeptID end deptID1,A.CreatedTime as tglInput,A.Tgl as TglPeriksa,E.TglProduksi as TglProd,  D.DefCode,BP.PlantName as Line, PG.[Group],BF.FormulaCode as Jenis,   " +
                        "D.DefName,D.DeptID,B.ID,B.DefectID,B.MasterID,B.Qty,A.ID  DestID,isnull(A.TPotong,0)  QtyIn,B.Qty*I.Volume as Kubik,isnull(A.TPotong,0) as TotPotong,'' sfrom  " +
                        "from Def_DefectDetail B inner join Def_Defect A on A.Id=B.DefectID   " +
                        "left join Def_MasterDefect D on B.MasterID=D.ID left join BM_Destacking E on E.ID=A.DestID   " +
                        "left join BM_PlantGroup PG on A.GroupProdID=PG.ID left join BM_Formula BF on BF.ID=E.FormulaID    " +
                        "left join BM_Plant BP on BP.ID=E.PlantID left join FC_Items I on I.ID=E.ItemID inner join Def_GroupJemur GJ on GJ.ID=A.GroupJemurID  " +
                        "where B.RowStatus>-1  and D.RowStatus >-1) as Def    " +
                        "where DeptID1<>2 and CONVERT(varchar,TglPeriksa,112)>=@thnbln1 and CONVERT(varchar,TglPeriksa,112)<=@thnbln2) " +
                        " " +
                        "select * into tempdefectFin from ( " +
                        "select 'OKKW' fin, sum(qtyout) lembar,sum(qtyout * kubik)kubik from ( " +
                        "select I1.PartNo partno1,I1.Panjang * I1.Lebar luas1,  S.qtyin,I2.PartNo partno2,I2.Panjang * I2.Lebar luas2,  S.qtyout ,(I2.Tebal * I2.Panjang * I2.Lebar)/1000000000 kubik " +
                        "from t3_simetris S inner join T3_Serah Se on S.SerahID =Se.ID inner join fc_items I1 on Se.ItemID=I1.ID inner join fc_items I2 on S.ItemID=I2.id  " +
                        "where I2.lebar>500 and S.RowStatus>-1 and CONVERT(varchar,S.tgltrans,112)>=@thnbln1 and CONVERT(varchar,S.tgltrans,112)<=@thnbln2 )a where partno1 like '%-1-%' and luas1>=luas2*2 and partno2 like '%-p-%' " +
                        "union all " +
                        "select 'BP' fin, sum(qtyout) lembar,sum(qtyout * kubik)kubik from ( " +
                        "select I1.PartNo partno1,I1.Panjang * I1.Lebar luas1,  S.qtyin,I2.PartNo partno2,I2.Panjang * I2.Lebar luas2,  S.qtyout ,(I2.Tebal * I2.Panjang * I2.Lebar)/1000000000 kubik " +
                        "from t3_simetris S inner join T3_Serah Se on S.SerahID =Se.ID inner join fc_items I1 on Se.ItemID=I1.ID inner join fc_items I2 on S.ItemID=I2.id  " +
                        "where I2.lebar>500 and S.RowStatus>-1 and CONVERT(varchar,S.tgltrans,112)>=@thnbln1 and CONVERT(varchar,S.tgltrans,112)<=@thnbln2  )a where partno1 like '%-1-%' and luas1>=luas2*2 and  " +
                        "(partno2 like '%-3-%' or partno2 like '%-w-%' or partno2 like '%-m-%') " +
                        "union all " +
                        "select 'BS' fin,sum(R.QtyIn) Lembar,sum(R.QtyIn *((I.tebal*I.panjang*I.lebar)/1000000000)) kubik from T3_Rekap R inner join FC_Items I on R.ItemID=I.id inner join fc_lokasi L on R.LokID =L.id where R.RowStatus>-1 and  " +
                        "CONVERT(varchar,R.tgltrans,112)>=@thnbln1 and CONVERT(varchar,R.tgltrans,112)<=@thnbln2 and I.PartNo like '%-s-%' and Process='direct')A " +
                        " " +
                        "declare @TotalPotong decimal(18,2) " +
                        "declare @TotalDefKhusus decimal(18,2) " +
                        "declare @DefKhusus decimal(18,2) " +
                        "declare @Ttotalkw1kw2 decimal(18,2) " +
                        "declare @NCSortir decimal(18,2) " +
                        "declare @Retur decimal(18,2) " +
                        "set @TotalPotong=isnull((select sum(totkubik ) from tempdefectGPIsoTot),0) " +
                        "if @TotalPotong >0  " +
                        "begin " +
                        "set @TotalDefKhusus=isnull((select sum(kubik) from tempdefectFin),0) " +
                        "set @DefKhusus=isnull((select sum(kubik) from tempdefectFin where fin<>'bp'),0) " +

                        "set @Ttotalkw1kw2 =isnull((select sum(qtyin)qty from T3_Rekap R inner join fc_items I on R.itemid=I.ID  " +
                        "where R.rowstatus>-1 and R.Process  like '%simetris%' and CONVERT(varchar,R.tgltrans,112)>=@thnbln1 and CONVERT(varchar,R.tgltrans,112)<=@thnbln2   " +
                        "and I.lebar=1200 and I.panjang=2400 and R.keterangan like '%-p-%' and (I.partno like '%-3-%' or I.partno like '%-W-%' or I.partno like '%-M-%' )),0) " +

                        "set @NCSortir=isnull((select sum(QtyAkhirSS)+sum(QtyAkhirSE) from (  " +
                        "SELECT B.tgltrans as Tanggal, I1.PartNo as PartnoAwal, sum(B.QtyIn) as QtyAwal,sum(I1.Volume*B.QtyIn) M3Awal,   " +
                        "I2.PartNo AS PartnoAkhir, case when B.NCSS>0 then sum(B.QtyOut) else 0 end QtyAkhirSS,  " +
                        "case when B.NCSS>0 then sum(I2.Volume*B.QtyOut) else 0 end M3AkhirSS,case when B.NCSE>0 then sum(B.QtyOut) else 0 end QtyAkhirSE,  " +
                        "case when B.NCSE>0 then sum(I2.Volume*B.QtyOut) else 0 end M3AkhirSE,B.NCSS,B.NCSE  FROM T3_Serah AS A   " +
                        "INNER JOIN T3_Simetris AS B ON A.ID = B.SerahID INNER JOIN FC_Items AS I1 ON A.ItemID = I1.ID INNER JOIN   " +
                        "FC_Items AS I2 ON B.ItemID = I2.ID LEFT JOIN T3_GroupM AS D ON B.GroupID = D.ID   " +
                        "where (B.NCSS>0 or B.NCSE>0) and B.rowstatus>-1 and CONVERT(varchar,B.tgltrans,112)>=@thnbln1 and CONVERT(varchar,B.tgltrans,112)<=@thnbln2   " +
                        "group by B.tgltrans,I1.PartNo,I2.PartNo,B.NCSS,B.NCSE) S),0) " +

                        "set @Retur=isnull((select sum(qty) from ( " +
                        "select sum(Qty)Qty from t3_retur R inner join fc_items I on R.itemid=I.id where R.rowstatus>-1 and  " +
                        "R.typer=1 and (I.partno like '%-p-%' or I.partno like '%-S-%')  and CONVERT(varchar,R.tgltrans,112)>=@thnbln1 and CONVERT(varchar,R.tgltrans,112)<=@thnbln2  " +
                        "union all " +
                        "select sum(qty *(I.tebal*I.panjang*I.lebar)/1000000000)*-1 qty from t3_retur R inner join fc_items I on R.itemid=I.id where R.rowstatus>-1 and  " +
                        "R.typer=2 and (I.partno like '%-p-%' or I.partno like '%-S-%')and CONVERT(varchar,R.tgltrans,112)>=@thnbln1 and CONVERT(varchar,R.tgltrans,112)<=@thnbln2 " +
                        "union all " +
                        "select sum(qty *(I.tebal*I.panjang*I.lebar)/1000000000) qty from t3_returO R inner join fc_items I on R.itemid=I.id where R.rowstatus>-1 and  " +
                        "(I.partno like '%-p-%' or I.partno like '%-S-%') and CONVERT(varchar,R.tgltrans,112)>=@thnbln1 and CONVERT(varchar,R.tgltrans,112)<=@thnbln2)A),0) " +
                        " " +
                        "declare @TotalPotongL1 decimal(18,2) " +
                        "declare @TotDefKhususL1 decimal(18,2) " +
                        "declare @DefKhususL1 decimal(18,2) " +
                        "declare @Ttotalkw1kw2L1 decimal(18,2) " +
                        "declare @NCSortirL1 decimal(18,2) " +
                        "declare @ReturL1 decimal(18,2) " +
                        "declare @DefectFinL1 decimal(18,2) " +
                        "set @TotalPotongL1=(select sum(totkubik ) from tempdefectGPIsoTot where [group]in (select [group] from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 1'))) " +
                        "set @TotDefKhususL1=(@TotalPotongL1/@TotalPotong)*@TotalDefKhusus " +
                        "set @DefKhususL1=(@TotalPotongL1/@TotalPotong)*@DefKhusus " +
                        "set @Ttotalkw1kw2L1=(@TotalPotongL1/@TotalPotong)*@Ttotalkw1kw2 " +
                        "set @NCSortirL1=(@TotalPotongL1/@TotalPotong)*@NCSortir " +
                        "set @ReturL1=(@TotalPotongL1/@TotalPotong)*@Retur " +
                        "set @DefectFinL1=isnull((@TotalPotongL1/@TotalPotong)*@DefectFin,0) " +

                        " /** Tambahan OK KM **/ " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempOKKM_lbr]') AND type in (N'U')) DROP TABLE [dbo].tempOKKM_lbr " +
                        " select [Group],round((Qty/@TtlDfctSystemBM)*@Ttotalkw1kw2,2) Qty into tempOKKM_lbr from detailDfctSystemBM order by [group] " +
                        " /** End Tambahan **/ " +

                        " /** Tambahan Sortir **/ " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempSortir_lbr]') AND type in (N'U')) DROP TABLE [dbo].tempSortir_lbr " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempSortir_1_lbr]') AND type in (N'U')) DROP TABLE [dbo].tempSortir_1_lbr " +

                        " select [Group],round((Qty/@TtlDfctSystemBM)*@NCSortir,2) Qty into tempSortir_lbr from detailDfctSystemBM order by [group] " +

                        " select [Group],round(Qty,2)Qty into tempSortir_1_lbr from ( " +
                        " select [Group],round(Qty,2)Qty from ( " +
                        " select * from tempSortir_lbr ) as x ) as x1 " +
                        " /** End Tambahan **/ " +

                        " /** Tambahan Return **/ " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempRetur_lbr]') AND type in (N'U')) DROP TABLE [dbo].tempRetur_lbr " +
                        " select [Group],round((Qty/@TtlDfctSystemBM)*@Retur,2) Qty into tempRetur_lbr from detailDfctSystemBM order by [group] " +
                        " /** End Tambahan **/ " +
                        #region Line -1
 "if @TotalPotongL1>0 " +
                        "begin " +
                        "select * into tempdefectL1 from ( " +
                        "select *,c-d+e+f+g i,case when b>0 then ((c-d+e+f+g)/b)*100 else 0  end j from ( " +
                        "select [Group], " +
                        //"case when @TotalPotongL1>0 then isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) +  " +
                        //"  (( isnull(( select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@TotDefKhususL1)  else 0 end b, " +
                        " case when @TotalPotongL1>0 then isnull((select round(Qty,0)Qty from tempDetail_TtlPot_lbr where [group]=BM_PlantGroup.[Group] ),0)  else 0 end b, " +
                        //" case when @TotalPotongL1>0 then isnull((select totdefectK from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)  else 0 end c, " +
                        " case when @TotalPotongL1>0 then isnull((select round(Qty,0)Qty from tempDefect_Prod_lbr where [group]=BM_PlantGroup.[Group] ),0)  else 0 end c, " +
                        //" case when @TotalPotongL1>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@Ttotalkw1kw2L1) else 0 end  d, " +
                        " case when @TotalPotongL1>0 then ((isnull((select round(Qty,0)Qty from tempOKKM_lbr where [group]=BM_PlantGroup.[Group] ),0))) else 0 end  d,  " +
                        //" case when @TotalPotongL1>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@NCSortirL1)  else 0 end  e, " +
                        " case when @TotalPotongL1>0 then ((isnull((select round(Qty,0)Qty from tempSortir_1_lbr where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  e, " +
                        //" case when @TotalPotongL1>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@ReturL1)  else 0 end  f, " +
                        " case when @TotalPotongL1>0 then ((isnull((select round(Qty,0)Qty from tempRetur_lbr where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  f, " +
                        //" case when @TotalPotongL1>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@DefectFinL1)  else 0 end g, " +
                        " case when @TotalPotongL1>0 then ((isnull((select round(Qty,0)Qty from tempDetailBSTahap1_lbr where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end g  " +
                        //" case when @TotalPotongL1>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@DefKhususL1) else 0 end  h " +
                        " from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 1') )A " +

                        "union all  " +

                        "select 'Total' [Group],sum(b)b,sum(c)c,sum(d)d,sum(e)e,sum(f)f,sum(g)g,sum(c)-sum(d)+sum(e)+sum(f)+sum(g) i " +
                        ",(sum(c)-sum(d)+sum(e)+sum(f)+sum(g))/sum(b)*100 j from( " +
                        "select [Group], " +
                        //" case when @TotalPotongL1>0 then isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) +  " +
                        //"  (( isnull(( select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@TotDefKhususL1)  else 0 end b, " +
                        " case when @TotalPotongL1>0 then isnull((select round(Qty,1)Qty from tempDetail_TtlPot_lbr where [group]=BM_PlantGroup.[Group] ),0)  else 0 end b,  " +
                        //" case when @TotalPotongL1>0 then isnull((select totdefectK from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)  else 0 end c, " +
                        " case when @TotalPotongL1>0 then isnull((select round(Qty,1)Qty from tempDefect_Prod_lbr where [group]=BM_PlantGroup.[Group] ),0)  else 0 end c,  " +
                        //" case when @TotalPotongL1>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@Ttotalkw1kw2L1) else 0 end  d, " +
                        " case when @TotalPotongL1>0 then ((isnull((select round(Qty,1)Qty from tempOKKM_lbr where [group]=BM_PlantGroup.[Group] ),0))) else 0 end  d, " +
                        //" case when @TotalPotongL1>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@NCSortirL1)  else 0 end  e, " +
                        " case when @TotalPotongL1>0 then ((isnull((select round(Qty,1)Qty from tempSortir_1_lbr where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  e,  " +
                        //" case when @TotalPotongL1>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@ReturL1)  else 0 end  f, " +
                        " case when @TotalPotongL1>0 then ((isnull((select round(Qty,1)Qty from tempRetur_lbr where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  f,  " +
                        //" case when @TotalPotongL1>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@DefectFinL1)  else 0 end g, " +
                        " case when @TotalPotongL1>0 then ((isnull((select round(Qty,1)Qty from tempDetailBSTahap1_lbr where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end g,  " +
                        //" case when @TotalPotongL1>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@DefKhususL1) else 0 end  h, " +
                        " 0 i,0 j from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 1'))A )B " +
                        " end " +
                        " else " +
                        " begin " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 i, 0 j into tempdefectL1 " +
                        " end " +
                        #endregion
 " " +
                        "declare @TotalPotongL2 decimal(18,2) " +
                        "declare @TotDefKhususL2 decimal(18,2) " +
                        "declare @DefKhususL2 decimal(18,2) " +
                        "declare @Ttotalkw1kw2L2 decimal(18,2) " +
                        "declare @NCSortirL2 decimal(18,2) " +
                        "declare @ReturL2 decimal(18,2) " +
                        "declare @DefectFinL2 decimal(18,2) " +
                        "set @TotalPotongL2=(select sum(totkubik ) from tempdefectGPIsoTot where [group]in (select [group] from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 2'))) " +
                        " " +
                        "set @TotDefKhususL2=(@TotalPotongL2/@TotalPotong)*@TotalDefKhusus " +
                        "set @DefKhususL2=(@TotalPotongL2/@TotalPotong)*@DefKhusus " +
                        "set @Ttotalkw1kw2L2=(@TotalPotongL2/@TotalPotong)*@Ttotalkw1kw2 " +
                        "set @NCSortirL2=(@TotalPotongL2/@TotalPotong)*@NCSortir " +
                        "set @ReturL2=(@TotalPotongL2/@TotalPotong)*@Retur " +
                        "set @DefectFinL2=isnull((@TotalPotongL2/@TotalPotong)*@DefectFin,0) " +
                        #region Line - 2
 "if @TotalPotongL2>0 " +
                        "begin " +
                        "select * into tempdefectL2 from ( " +
                        "select *,c-d+e+f+g i,case when b>0 then (c-d+e+f+g)/b*100 else 0  end j from ( " +
                        " select [Group], " +
                        //" case when @TotalPotongL2>0 then isnull((select round(M3,0)M3 from tempDetail_TtlPot where [group]=BM_PlantGroup.[Group] ),0)  else 0 end b,  " +                    
                        //" case when @TotalPotongL2>0 then isnull((select round(M3,0)M3 from tempDefect_Prod_m3 where [group]=BM_PlantGroup.[Group] ),0)  else 0 end c,  " +                    
                        //" case when @TotalPotongL2>0 then ((isnull((select round(M3,0)M3 from tempOKKM_m3 where [group]=BM_PlantGroup.[Group] ),0))) else 0 end  d, " +                    
                        //" case when @TotalPotongL2>0 then ((isnull((select round(M3,0)M3 from tempSortir_1_m3 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  e,  " +                    
                        //" case when @TotalPotongL2>0 then ((isnull((select round(M3,0)M3 from tempRetur_m3 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  f,  " +                    
                        //" case when @TotalPotongL2>0 then ((isnull((select round(M3,0)M3 from tempDetailBSTahap1 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end g  " +     
                        //"case when @TotalPotongL1>0 then isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) +  " +

                        " case when @TotalPotongL2>0 then isnull((select round(Qty,0)Qty from tempDetail_TtlPot_lbr where [group]=BM_PlantGroup.[Group] ),0)  else 0 end b, " +
                        " case when @TotalPotongL2>0 then isnull((select round(Qty,0)Qty from tempDefect_Prod_lbr where [group]=BM_PlantGroup.[Group] ),0)  else 0 end c, " +
                        " case when @TotalPotongL2>0 then ((isnull((select round(Qty,0)Qty from tempOKKM_lbr where [group]=BM_PlantGroup.[Group] ),0))) else 0 end  d,  " +
                        " case when @TotalPotongL2>0 then ((isnull((select round(Qty,0)Qty from tempSortir_1_lbr where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  e, " +
                        " case when @TotalPotongL2>0 then ((isnull((select round(Qty,0)Qty from tempRetur_lbr where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  f, " +
                        " case when @TotalPotongL2>0 then ((isnull((select round(Qty,0)Qty from tempDetailBSTahap1_lbr where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end g  " +

                        " from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 2') )A " +
                        "union all  " +
                        "select 'Total' [Group],sum(b)b,sum(c)c,sum(d)d,sum(e)e,sum(f)f,sum(g)g,sum(c)-sum(d)+sum(e)+sum(f)+sum(g) i " +
                        ",(sum(c)-sum(d)+sum(e)+sum(f)+sum(g))/sum(b)*100 j from(select [Group], " +

                        //" case when @TotalPotongL2>0 then isnull((select round(M3,1)M3 from tempDetail_TtlPot where [group]=BM_PlantGroup.[Group] ),0)  else 0 end b,  " +                       
                        //" case when @TotalPotongL2>0 then isnull((select round(M3,1)M3 from tempDefect_Prod_m3 where [group]=BM_PlantGroup.[Group] ),0)  else 0 end c,  " +                       
                        //" case when @TotalPotongL2>0 then ((isnull((select round(M3,1)M3 from tempOKKM_m3 where [group]=BM_PlantGroup.[Group] ),0))) else 0 end  d, " +                        
                        //" case when @TotalPotongL2>0 then ((isnull((select round(M3,1)M3 from tempSortir_1_m3 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  e,  " +                        
                        //" case when @TotalPotongL2>0 then ((isnull((select round(M3,1)M3 from tempRetur_m3 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  f,  " +                        
                        //" case when @TotalPotongL2>0 then ((isnull((select round(M3,1)M3 from tempDetailBSTahap1 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end g,  " +   

                        " case when @TotalPotongL2>0 then isnull((select round(Qty,0)Qty from tempDetail_TtlPot_lbr where [group]=BM_PlantGroup.[Group] ),0)  else 0 end b, " +
                        " case when @TotalPotongL2>0 then isnull((select round(Qty,0)Qty from tempDefect_Prod_lbr where [group]=BM_PlantGroup.[Group] ),0)  else 0 end c, " +
                        " case when @TotalPotongL2>0 then ((isnull((select round(Qty,0)Qty from tempOKKM_lbr where [group]=BM_PlantGroup.[Group] ),0))) else 0 end  d,  " +
                        " case when @TotalPotongL2>0 then ((isnull((select round(Qty,0)Qty from tempSortir_1_lbr where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  e, " +
                        " case when @TotalPotongL2>0 then ((isnull((select round(Qty,0)Qty from tempRetur_lbr where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  f, " +
                        " case when @TotalPotongL2>0 then ((isnull((select round(Qty,0)Qty from tempDetailBSTahap1_lbr where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end g,  " +

                        " 0 i,0 j from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 2'))A )B " +
                        " end " +
                        " else " +
                        " begin " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 i, 0 j into tempdefectL2 " +
                        " end " +
                        #endregion
 " " +
                        "declare @TotalPotongL3 decimal(18,2) " +
                        "declare @TotDefKhususL3 decimal(18,2) " +
                        "declare @DefKhususL3 decimal(18,2) " +
                        "declare @Ttotalkw1kw2L3 decimal(18,2) " +
                        "declare @NCSortirL3 decimal(18,2) " +
                        "declare @ReturL3 decimal(18,2) " +
                        "declare @DefectFinL3 decimal(18,2) " +
                        "set @TotalPotongL3=(select sum(totkubik ) from tempdefectGPIsoTot where [group]in (select [group] from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 3'))) " +
                        "set @TotDefKhususL3=(@TotalPotongL3/@TotalPotong)*@TotalDefKhusus " +
                        "set @DefKhususL3=(@TotalPotongL3/@TotalPotong)*@DefKhusus " +
                        "set @Ttotalkw1kw2L3=(@TotalPotongL3/@TotalPotong)*@Ttotalkw1kw2 " +
                        "set @NCSortirL3=(@TotalPotongL3/@TotalPotong)*@NCSortir " +
                        "set @ReturL3=(@TotalPotongL3/@TotalPotong)*@Retur " +
                        "set @DefectFinL3=isnull((@TotalPotongL3/@TotalPotong)*@DefectFin,0) " +
                        #region Lin3 - 3
 "if @TotalPotongL3>0 " +
                        "begin " +
                        "select * into tempdefectL3 from ( " +
                        "select *,c-d+e+f+g i,case when b>0 then (c-d+e+f+g)/b*100 else 0  end j from ( select [Group], " +
                        //"select [Group],case when @TotalPotongL3>0 then isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) +  " +
                        //" ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@TotDefKhususL3) else 0 end  b, " +
                        //" case when @TotalPotongL3>0 then isnull((select totdefectK from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) else 0 end c, " +
                        //" case when @TotalPotongL3>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@Ttotalkw1kw2L3) else 0 end  d, " +
                        //" case when @TotalPotongL3>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@NCSortirL3) else 0 end  e, " +
                        //" case when @TotalPotongL3>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@ReturL3) else 0 end  f, " +
                        //" case when @TotalPotongL3>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@DefectFinL3) else 0 end  g " +
                        //" case when @TotalPotongL3>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@DefKhususL3) else 0 end  h " +

                        //" case when @TotalPotongL3>0 then isnull((select round(M3,0)M3 from tempDetail_TtlPot where [group]=BM_PlantGroup.[Group] ),0)  else 0 end b,  " +
                        //" case when @TotalPotongL3>0 then isnull((select round(M3,0)M3 from tempDefect_Prod_m3 where [group]=BM_PlantGroup.[Group] ),0)  else 0 end c,  " +
                        //" case when @TotalPotongL3>0 then ((isnull((select round(M3,0)M3 from tempOKKM_m3 where [group]=BM_PlantGroup.[Group] ),0))) else 0 end  d, " +
                        //" case when @TotalPotongL3>0 then ((isnull((select round(M3,0)M3 from tempSortir_1_m3 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  e,  " +
                        //" case when @TotalPotongL3>0 then ((isnull((select round(M3,0)M3 from tempRetur_m3 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  f,  " +
                        //" case when @TotalPotongL3>0 then ((isnull((select round(M3,0)M3 from tempDetailBSTahap1 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end g  " +  

                        " case when @TotalPotongL3>0 then isnull((select round(Qty,0)Qty from tempDetail_TtlPot_lbr where [group]=BM_PlantGroup.[Group] ),0)  else 0 end b, " +
                        " case when @TotalPotongL3>0 then isnull((select round(Qty,0)Qty from tempDefect_Prod_lbr where [group]=BM_PlantGroup.[Group] ),0)  else 0 end c, " +
                        " case when @TotalPotongL3>0 then ((isnull((select round(Qty,0)Qty from tempOKKM_lbr where [group]=BM_PlantGroup.[Group] ),0))) else 0 end  d,  " +
                        " case when @TotalPotongL3>0 then ((isnull((select round(Qty,0)Qty from tempSortir_1_lbr where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  e, " +
                        " case when @TotalPotongL3>0 then ((isnull((select round(Qty,0)Qty from tempRetur_lbr where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  f, " +
                        " case when @TotalPotongL3>0 then ((isnull((select round(Qty,0)Qty from tempDetailBSTahap1_lbr where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end g  " +

                        "  from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 3') )A " +
                        "union all  " +
                        "select 'Total' [Group],sum(b)b,sum(c)c,sum(d)d,sum(e)e,sum(f)f,sum(g)g,sum(c)-sum(d)+sum(e)+sum(f)+sum(g) i " +
                        ",(sum(c)-sum(d)+sum(e)+sum(f)+sum(g))/sum(b)*100 j from( select [Group], " +
                        //"select [Group],isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) +  " +
                        //" ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@TotDefKhususL3) b, " +
                        //" isnull((select totdefectK from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)c, " +
                        //" ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@Ttotalkw1kw2L3) d, " +
                        //" ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@NCSortirL3) e, " +
                        //" ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@ReturL3) f, " +
                        //" ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@DefectFinL3) g, " +
                        ////" ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@DefKhususL3) h, " +

                        //" case when @TotalPotongL3>0 then isnull((select round(M3,1)M3 from tempDetail_TtlPot where [group]=BM_PlantGroup.[Group] ),0)  else 0 end b,  " +
                        //" case when @TotalPotongL3>0 then isnull((select round(M3,1)M3 from tempDefect_Prod_m3 where [group]=BM_PlantGroup.[Group] ),0)  else 0 end c,  " +
                        //" case when @TotalPotongL3>0 then ((isnull((select round(M3,1)M3 from tempOKKM_m3 where [group]=BM_PlantGroup.[Group] ),0))) else 0 end  d, " +
                        //" case when @TotalPotongL3>0 then ((isnull((select round(M3,1)M3 from tempSortir_1_m3 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  e,  " +
                        //" case when @TotalPotongL3>0 then ((isnull((select round(M3,1)M3 from tempRetur_m3 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  f,  " +
                        //" case when @TotalPotongL3>0 then ((isnull((select round(M3,1)M3 from tempDetailBSTahap1 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end g,  " + 

                        " case when @TotalPotongL3>0 then isnull((select round(Qty,0)Qty from tempDetail_TtlPot_lbr where [group]=BM_PlantGroup.[Group] ),0)  else 0 end b, " +
                        " case when @TotalPotongL3>0 then isnull((select round(Qty,0)Qty from tempDefect_Prod_lbr where [group]=BM_PlantGroup.[Group] ),0)  else 0 end c, " +
                        " case when @TotalPotongL3>0 then ((isnull((select round(Qty,0)Qty from tempOKKM_lbr where [group]=BM_PlantGroup.[Group] ),0))) else 0 end  d,  " +
                        " case when @TotalPotongL3>0 then ((isnull((select round(Qty,0)Qty from tempSortir_1_lbr where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  e, " +
                        " case when @TotalPotongL3>0 then ((isnull((select round(Qty,0)Qty from tempRetur_lbr where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  f, " +
                        " case when @TotalPotongL3>0 then ((isnull((select round(Qty,0)Qty from tempDetailBSTahap1_lbr where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end g , " +

                        " 0 i,0 j from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 3'))A )B " +
                        " end " +
                        " else " +
                        " begin " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 i, 0 j into tempdefectL3 " +
                        " end " +
                        #endregion
 " " +
                        "declare @TotalPotongL4 decimal(18,2) " +
                        "declare @TotDefKhususL4 decimal(18,2) " +
                        "declare @DefKhususL4 decimal(18,2) " +
                        "declare @Ttotalkw1kw2L4 decimal(18,2) " +
                        "declare @NCSortirL4 decimal(18,2) " +
                        "declare @ReturL4 decimal(18,2) " +
                        "declare @DefectFinL4 decimal(18,2) " +
                        "set @TotalPotongL4=(select sum(totkubik ) from tempdefectGPIsoTot where [group]in (select [group] from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 4'))) " +
                        "set @TotDefKhususL4=(@TotalPotongL4/@TotalPotong)*@TotalDefKhusus " +
                        "set @DefKhususL4=(@TotalPotongL4/@TotalPotong)*@DefKhusus " +
                        "set @Ttotalkw1kw2L4=(@TotalPotongL4/@TotalPotong)*@Ttotalkw1kw2 " +
                        "set @NCSortirL4=(@TotalPotongL4/@TotalPotong)*@NCSortir " +
                        "set @ReturL4=(@TotalPotongL4/@TotalPotong)*@Retur " +
                        "set @DefectFinL4=isnull((@TotalPotongL4/@TotalPotong)*@DefectFin,0) " +
                        #region Line - 4
 "if @TotalPotongL4>0 " +
                        "begin " +
                        "select * into tempdefectL4 from ( " +
                        "select *,c-d+e+f+g i,case when b>0 then (c-d+e+f+g)/b*100 else 0  end j from ( " +
                        "select [Group], " +
                        //" case when @TotalPotongL4>0 then isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) +  " +
                        //" ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@TotDefKhususL4) else 0 end  b, " +
                        //" case when @TotalPotongL4>0 then isnull((select totdefectK from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) else 0 end c, " +
                        //" case when @TotalPotongL4>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@Ttotalkw1kw2L4) else 0 end  d, " +
                        //" case when @TotalPotongL4>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@NCSortirL4) else 0 end  e, " +
                        //" case when @TotalPotongL4>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@ReturL4) else 0 end  f, " +
                        //" case when @TotalPotongL4>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@DefectFinL4) else 0 end  g " +
                        //" case when @TotalPotongL4>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@DefKhususL4) else 0 end  h " +
                        //" case when @TotalPotongL4>0 then isnull((select round(M3,0)M3 from tempDetail_TtlPot where [group]=BM_PlantGroup.[Group] ),0)  else 0 end b,  " +
                        //" case when @TotalPotongL4>0 then isnull((select round(M3,0)M3 from tempDefect_Prod_m3 where [group]=BM_PlantGroup.[Group] ),0)  else 0 end c,  " +
                        //" case when @TotalPotongL4>0 then ((isnull((select round(M3,0)M3 from tempOKKM_m3 where [group]=BM_PlantGroup.[Group] ),0))) else 0 end  d, " +
                        //" case when @TotalPotongL4>0 then ((isnull((select round(M3,0)M3 from tempSortir_1_m3 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  e,  " +
                        //" case when @TotalPotongL4>0 then ((isnull((select round(M3,0)M3 from tempRetur_m3 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  f,  " +
                        //" case when @TotalPotongL4>0 then ((isnull((select round(M3,0)M3 from tempDetailBSTahap1 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end g  " + 

                        " case when @TotalPotongL4>0 then isnull((select round(Qty,0)Qty from tempDetail_TtlPot_lbr where [group]=BM_PlantGroup.[Group] ),0)  else 0 end b, " +
                        " case when @TotalPotongL4>0 then isnull((select round(Qty,0)Qty from tempDefect_Prod_lbr where [group]=BM_PlantGroup.[Group] ),0)  else 0 end c, " +
                        " case when @TotalPotongL4>0 then ((isnull((select round(Qty,0)Qty from tempOKKM_lbr where [group]=BM_PlantGroup.[Group] ),0))) else 0 end  d,  " +
                        " case when @TotalPotongL4>0 then ((isnull((select round(Qty,0)Qty from tempSortir_1_lbr where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  e, " +
                        " case when @TotalPotongL4>0 then ((isnull((select round(Qty,0)Qty from tempRetur_lbr where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  f, " +
                        " case when @TotalPotongL4>0 then ((isnull((select round(Qty,0)Qty from tempDetailBSTahap1_lbr where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end g  " +

                        "  from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 4') )A " +
                        "union all  " +
                        "select 'Total' [Group],sum(b)b,sum(c)c,sum(d)d,sum(e)e,sum(f)f,sum(g)g,sum(c)-sum(d)+sum(e)+sum(f)+sum(g) i " +
                        ",(sum(c)-sum(d)+sum(e)+sum(f)+sum(g))/sum(b)*100 j from( " +
                        "select [Group], " +
                        //" isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) +  " +
                        //" ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@TotDefKhususL4) b, " +
                        //" isnull((select totdefectK from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)c, " +
                        //" ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@Ttotalkw1kw2L4) d, " +
                        //" ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@NCSortirL4) e, " +
                        //" ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@ReturL4) f, " +
                        //" ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@DefectFinL4) g, " +
                        //" ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@DefKhususL4) h, " +                   

                        //" ((isnull((select round(M3,1)M3 from tempDetail_TtlPot where [group]=BM_PlantGroup.[Group] ),0))) b, " +
                        //" isnull((select round(M3,1)M3 from tempDefect_Prod_m3 where [group]=BM_PlantGroup.[Group] ),0)c, " +
                        //" ((isnull((select round(M3,1)M3 from tempOKKM_m3 where [group]=BM_PlantGroup.[Group] ),0))) d, " +
                        //" ((isnull((select round(M3,1)M3 from tempSortir_1_m3 where [group]=BM_PlantGroup.[Group] ),0))) e, " +
                        //" ((isnull((select round(M3,1)M3 from tempRetur_m3 where [group]=BM_PlantGroup.[Group] ),0))) f, " +
                        //" ((isnull((select round(M3,1)M3 from tempDetailBSTahap1 where [group]=BM_PlantGroup.[Group] ),0))) g, " +

                        " ((isnull((select round(Qty,1)Qty from tempDetail_TtlPot_lbr where [group]=BM_PlantGroup.[Group] ),0))) b, " +
                        " isnull((select round(Qty,1)Qty from tempDefect_Prod_lbr where [group]=BM_PlantGroup.[Group] ),0)c, " +
                        " ((isnull((select round(Qty,1)Qty from tempOKKM_lbr where [group]=BM_PlantGroup.[Group] ),0))) d, " +
                        " ((isnull((select round(Qty,1)Qty from tempSortir_1_lbr where [group]=BM_PlantGroup.[Group] ),0))) e, " +
                        " ((isnull((select round(Qty,1)Qty from tempRetur_lbr where [group]=BM_PlantGroup.[Group] ),0))) f, " +
                        " ((isnull((select round(Qty,1)Qty from tempDetailBSTahap1_lbr where [group]=BM_PlantGroup.[Group] ),0))) g, " +

                        " 0 i,0 j from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 4'))A )B " +
                        " end " +
                        " else " +
                        " begin " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 i, 0 j into tempdefectL4 " +
                        " end " +
                        #endregion
 " " +
                        "declare @TotalPotongL5 decimal(18,2) " +
                        "declare @TotDefKhususL5 decimal(18,2) " +
                        "declare @DefKhususL5 decimal(18,2) " +
                        "declare @Ttotalkw1kw2L5 decimal(18,2) " +
                        "declare @NCSortirL5 decimal(18,2) " +
                        "declare @ReturL5 decimal(18,2) " +
                        "declare @DefectFinL5 decimal(18,2) " +
                        "set @TotalPotongL5=(select sum(totkubik ) from tempdefectGPIsoTot where [group]in (select [group] from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 5'))) " +
                        "set @TotDefKhususL5=(@TotalPotongL5/@TotalPotong)*@TotalDefKhusus " +
                        "set @DefKhususL5=(@TotalPotongL5/@TotalPotong)*@DefKhusus " +
                        "set @Ttotalkw1kw2L5=(@TotalPotongL5/@TotalPotong)*@Ttotalkw1kw2 " +
                        "set @NCSortirL5=(@TotalPotongL5/@TotalPotong)*@NCSortir " +
                        "set @ReturL5=(@TotalPotongL5/@TotalPotong)*@Retur " +
                        "set @DefectFinL5=isnull((@TotalPotongL5/@TotalPotong)*@DefectFin,0) " +
                        #region Line - 5
 "if @TotalPotongL5>0 " +
                        "begin " +
                        "select * into tempdefectL5 from ( " +
                        "select *,c-d+e+f+g i,case when b>0 then (c-d+e+f+g)/b*100 else 0  end j from ( " +
                        "select [Group], " +
                        //" case when @TotalPotongL5>0 then isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) +  " +
                        //" ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@TotDefKhususL5) else 0 end  b, " +
                        //" case when @TotalPotongL5>0 then isnull((select totdefectK from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) else 0 end c, " +
                        //" case when @TotalPotongL5>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@Ttotalkw1kw2L5) else 0 end  d, " +
                        //" case when @TotalPotongL5>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@NCSortirL5) else 0 end  e, " +
                        //" case when @TotalPotongL5>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@ReturL5) else 0 end  f, " +
                        //" case when @TotalPotongL5>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@DefectFinL5) else 0 end  g " +
                        //" case when @TotalPotongL5>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@DefKhususL5) else 0 end  h " +

                        //" case when @TotalPotongL5>0 then isnull((select round(M3,0)M3 from tempDetail_TtlPot where [group]=BM_PlantGroup.[Group] ),0)  else 0 end b,  " +
                        //" case when @TotalPotongL5>0 then isnull((select round(M3,0)M3 from tempDefect_Prod_m3 where [group]=BM_PlantGroup.[Group] ),0)  else 0 end c,  " +
                        //" case when @TotalPotongL5>0 then ((isnull((select round(M3,0)M3 from tempOKKM_m3 where [group]=BM_PlantGroup.[Group] ),0))) else 0 end  d, " +
                        //" case when @TotalPotongL5>0 then ((isnull((select round(M3,0)M3 from tempSortir_1_m3 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  e,  " +
                        //" case when @TotalPotongL5>0 then ((isnull((select round(M3,0)M3 from tempRetur_m3 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  f,  " +
                        //" case when @TotalPotongL5>0 then ((isnull((select round(M3,0)M3 from tempDetailBSTahap1 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end g  " + 

                        " case when @TotalPotongL5>0 then isnull((select round(Qty,0)Qty from tempDetail_TtlPot_lbr where [group]=BM_PlantGroup.[Group] ),0)  else 0 end b, " +
                        " case when @TotalPotongL5>0 then isnull((select round(Qty,0)Qty from tempDefect_Prod_lbr where [group]=BM_PlantGroup.[Group] ),0)  else 0 end c, " +
                        " case when @TotalPotongL5>0 then ((isnull((select round(Qty,0)Qty from tempOKKM_lbr where [group]=BM_PlantGroup.[Group] ),0))) else 0 end  d,  " +
                        " case when @TotalPotongL5>0 then ((isnull((select round(Qty,0)Qty from tempSortir_1_lbr where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  e, " +
                        " case when @TotalPotongL5>0 then ((isnull((select round(Qty,0)Qty from tempRetur_lbr where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  f, " +
                        " case when @TotalPotongL5>0 then ((isnull((select round(Qty,0)Qty from tempDetailBSTahap1_lbr where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end g  " +


                        "  from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 5') )A " +
                        "union all  " +
                        "select 'Total' [Group],sum(b)b,sum(c)c,sum(d)d,sum(e)e,sum(f)f,sum(g)g,sum(c)-sum(d)+sum(e)+sum(f)+sum(g) i " +
                        ",(sum(c)-sum(d)+sum(e)+sum(f)+sum(g))/sum(b)*100 j from( " +
                        "select [Group], " +
                        //" isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) +  " +
                        //" ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@TotDefKhususL5) b, " +
                        //" isnull((select totdefectK from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)c, " +
                        //" ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@Ttotalkw1kw2L5) d, " +
                        //" ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@NCSortirL5) e, " +
                        //" ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@ReturL5) f, " +
                        //" ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@DefectFinL5) g, " +
                        //" ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@DefKhususL5) h, " +

                        //" ((isnull((select round(M3,1)M3 from tempDetail_TtlPot where [group]=BM_PlantGroup.[Group] ),0))) b, " +
                        //" isnull((select round(M3,1)M3 from tempDefect_Prod_m3 where [group]=BM_PlantGroup.[Group] ),0)c, " +
                        //" ((isnull((select round(M3,1)M3 from tempOKKM_m3 where [group]=BM_PlantGroup.[Group] ),0))) d, " +
                        //" ((isnull((select round(M3,1)M3 from tempSortir_1_m3 where [group]=BM_PlantGroup.[Group] ),0))) e, " +
                        //" ((isnull((select round(M3,1)M3 from tempRetur_m3 where [group]=BM_PlantGroup.[Group] ),0))) f, " +
                        //" ((isnull((select round(M3,1)M3 from tempDetailBSTahap1 where [group]=BM_PlantGroup.[Group] ),0))) g, " +

                        " ((isnull((select round(Qty,1)Qty from tempDetail_TtlPot_lbr where [group]=BM_PlantGroup.[Group] ),0))) b, " +
                        " isnull((select round(Qty,1)Qty from tempDefect_Prod_lbr where [group]=BM_PlantGroup.[Group] ),0)c, " +
                        " ((isnull((select round(Qty,1)Qty from tempOKKM_lbr where [group]=BM_PlantGroup.[Group] ),0))) d, " +
                        " ((isnull((select round(Qty,1)Qty from tempSortir_1_lbr where [group]=BM_PlantGroup.[Group] ),0))) e, " +
                        " ((isnull((select round(Qty,1)Qty from tempRetur_lbr where [group]=BM_PlantGroup.[Group] ),0))) f, " +
                        " ((isnull((select round(Qty,1)Qty from tempDetailBSTahap1_lbr where [group]=BM_PlantGroup.[Group] ),0))) g, " +


                        " 0 i,0 j from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 5'))A )B " +
                        " end " +
                        " else " +
                        " begin " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 i, 0 j into tempdefectL5 " +
                        " end " +
                        #endregion
 " " +
                        "declare @TotalPotongL6 decimal(18,2) " +
                        "declare @TotDefKhususL6 decimal(18,2) " +
                        "declare @DefKhususL6 decimal(18,2) " +
                        "declare @Ttotalkw1kw2L6 decimal(18,2) " +
                        "declare @NCSortirL6 decimal(18,2) " +
                        "declare @ReturL6 decimal(18,2) " +
                        "declare @DefectFinL6 decimal(18,2) " +
                        "set @TotalPotongL6=(select sum(totkubik ) from tempdefectGPIsoTot where [group]in (select [group] from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 6'))) " +
                        "set @TotDefKhususL6=(@TotalPotongL6/@TotalPotong)*@TotalDefKhusus " +
                        "set @DefKhususL6=(@TotalPotongL6/@TotalPotong)*@DefKhusus " +
                        "set @Ttotalkw1kw2L6=(@TotalPotongL6/@TotalPotong)*@Ttotalkw1kw2 " +
                        "set @NCSortirL6=(@TotalPotongL6/@TotalPotong)*@NCSortir " +
                        "set @ReturL6=(@TotalPotongL6/@TotalPotong)*@Retur " +
                        "set @DefectFinL6=isnull((@TotalPotongL6/@TotalPotong)*@DefectFin,0) " +
                        #region Line - 6
 "if @TotalPotongL6>0 " +
                        "begin " +
                        "select * into tempdefectL6 from ( " +
                        "select *,c-d+e+f+g i,case when b>0 then (c-d+e+f+g)/b*100 else 0  end j from ( " +
                        "select [Group], " +

                        //" case when @TotalPotongL6>0 then isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) +  " +
                        //" ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@TotDefKhususL6)  else 0 end b, " +
                        //" case when @TotalPotongL6>0 then isnull((select totdefectK from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) else 0 end c, " +
                        //" case when @TotalPotongL6>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@Ttotalkw1kw2L6)  else 0 end d, " +
                        //" case when @TotalPotongL6>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@NCSortirL6)  else 0 end e, " +
                        //" case when @TotalPotongL6>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@ReturL6)  else 0 end f, " +
                        //" case when @TotalPotongL6>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@DefectFinL6)  else 0 end g " +
                        //" case when @TotalPotongL6>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@DefKhususL6) else 0 end  h " +

                        //" case when @TotalPotongL6>0 then isnull((select round(M3,0)M3 from tempDetail_TtlPot where [group]=BM_PlantGroup.[Group] ),0)  else 0 end b,  " +
                        //" case when @TotalPotongL6>0 then isnull((select round(M3,0)M3 from tempDefect_Prod_m3 where [group]=BM_PlantGroup.[Group] ),0)  else 0 end c,  " +
                        //" case when @TotalPotongL6>0 then ((isnull((select round(M3,0)M3 from tempOKKM_m3 where [group]=BM_PlantGroup.[Group] ),0))) else 0 end  d, " +
                        //" case when @TotalPotongL6>0 then ((isnull((select round(M3,0)M3 from tempSortir_1_m3 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  e,  " +
                        //" case when @TotalPotongL6>0 then ((isnull((select round(M3,0)M3 from tempRetur_m3 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  f,  " +
                        //" case when @TotalPotongL6>0 then ((isnull((select round(M3,0)M3 from tempDetailBSTahap1 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end g  " + 

                        " case when @TotalPotongL6>0 then isnull((select round(Qty,0)Qty from tempDetail_TtlPot_lbr where [group]=BM_PlantGroup.[Group] ),0)  else 0 end b, " +
                        " case when @TotalPotongL6>0 then isnull((select round(Qty,0)Qty from tempDefect_Prod_lbr where [group]=BM_PlantGroup.[Group] ),0)  else 0 end c, " +
                        " case when @TotalPotongL6>0 then ((isnull((select round(Qty,0)Qty from tempOKKM_lbr where [group]=BM_PlantGroup.[Group] ),0))) else 0 end  d,  " +
                        " case when @TotalPotongL6>0 then ((isnull((select round(Qty,0)Qty from tempSortir_1_lbr where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  e, " +
                        " case when @TotalPotongL6>0 then ((isnull((select round(Qty,0)Qty from tempRetur_lbr where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  f, " +
                        " case when @TotalPotongL6>0 then ((isnull((select round(Qty,0)Qty from tempDetailBSTahap1_lbr where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end g  " +



                        "  from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 6') )A " +
                        "union all  " +
                        "select 'Total' [Group],sum(b)b,sum(c)c,sum(d)d,sum(e)e,sum(f)f,sum(g)g,sum(c)-sum(d)+sum(e)+sum(f)+sum(g) i " +
                        ",(sum(c)-sum(d)+sum(e)+sum(f)+sum(g))/sum(b)*100 j from( " +
                        "select [Group], " +
                        //" isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) +  " +
                        //" ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@TotDefKhususL6) b, " +
                        //" isnull((select totdefectK from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)c, " +
                        //" ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@Ttotalkw1kw2L6) d, " +
                        //" ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@NCSortirL6) e, " +
                        //" ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@ReturL6) f, " +
                        //" ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@DefectFinL6) g, " +
                        //" ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@DefKhususL6) h, " +

                        //" ((isnull((select round(M3,1)M3 from tempDetail_TtlPot where [group]=BM_PlantGroup.[Group] ),0))) b, " +
                        //" isnull((select round(M3,1)M3 from tempDefect_Prod_m3 where [group]=BM_PlantGroup.[Group] ),0)c, " +
                        //" ((isnull((select round(M3,1)M3 from tempOKKM_m3 where [group]=BM_PlantGroup.[Group] ),0))) d, " +
                        //" ((isnull((select round(M3,1)M3 from tempSortir_1_m3 where [group]=BM_PlantGroup.[Group] ),0))) e, " +
                        //" ((isnull((select round(M3,1)M3 from tempRetur_m3 where [group]=BM_PlantGroup.[Group] ),0))) f, " +
                        //" ((isnull((select round(M3,1)M3 from tempDetailBSTahap1 where [group]=BM_PlantGroup.[Group] ),0))) g, " +

                        " ((isnull((select round(Qty,1)Qty from tempDetail_TtlPot_lbr where [group]=BM_PlantGroup.[Group] ),0))) b, " +
                        " isnull((select round(Qty,1)Qty from tempDefect_Prod_lbr where [group]=BM_PlantGroup.[Group] ),0)c, " +
                        " ((isnull((select round(Qty,1)Qty from tempOKKM_lbr where [group]=BM_PlantGroup.[Group] ),0))) d, " +
                        " ((isnull((select round(Qty,1)Qty from tempSortir_1_lbr where [group]=BM_PlantGroup.[Group] ),0))) e, " +
                        " ((isnull((select round(Qty,1)Qty from tempRetur_lbr where [group]=BM_PlantGroup.[Group] ),0))) f, " +
                        " ((isnull((select round(Qty,1)Qty from tempDetailBSTahap1_lbr where [group]=BM_PlantGroup.[Group] ),0))) g, " +

                        " 0 i,0 j from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 6'))A )B " +
                        " end " +
                        #endregion
 " else " +
                        " begin " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 i, 0 j into tempdefectL6 " +
                        " end " +
                        " " +
                        " end " +
                        " else " +
                        " begin " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 i, 0 j into tempdefectL1 " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 i, 0 j into tempdefectL2 " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 i, 0 j into tempdefectL3 " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 i, 0 j into tempdefectL4 " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 i, 0 j into tempdefectL5 " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 i, 0 j into tempdefectL6 " +
                        " end " +
                        " select [group],round(b,0)b,round(c,0)c,round(d,0)d,round(e,0)e,round(f,0)f,case when [group]<>'total' then round(g,0) when [group]='total' then round(g,0) end g,i,j from tempdefectL1 ";
                    }
                    #endregion
                    #endregion
                }
            }
            #endregion
            /** Plant Jombang **/
            #region Jombang
            else if (users.UnitKerjaID == 13)
            {
                if (RBKubik.Checked == true)
                {
                    /** Beny 13 Mei 2022 **/
                    if (Convert.ToInt32(strtgl1.Substring(0, 6)) > 202203)
                    {
                        logikaretur =
                        " isnull((select cast(Qty1-Qty2+Qty3+Qty4 as decimal(18,2))M3 " +
                        " from (  select cast(sum(Tot1*volume) as decimal(18,2))Qty1,cast(sum(Tot2*volume) as decimal(18,2))Qty2, " +
                        " cast(sum(Tot3*volume) as decimal(18,2))Qty3,cast(sum(Tot4*volume) as decimal(18,2))Qty4 from ( " +
                        " select tanggal,PartNo,volume ,sum(isnull(QtyC1,0))QtyC1,sum(isnull(QtyP1,0)) QtyP1,sum(isnull(QtyS1,0)) QtyS1,sum(isnull(Tot1,0)) " +
                        " Tot1,sum(isnull(TotK1,0)) TotK1, sum(isnull(QtyC2,0)) QtyC2,sum(isnull(QtyP2,0)) QtyP2,sum(isnull(QtyS2,0)) " +
                        " QtyS2,sum(isnull(Tot2,0)) Tot2, sum(isnull(TotK2,0)) TotK2,sum(isnull(QtyC3,0)) QtyC3,sum(isnull(QtyP3,0)) QtyP3, " +
                        " sum(isnull(QtyS3,0)) QtyS3,sum(isnull(Tot3,0)) Tot3,sum(isnull(TotK3,0)) TotK3, sum(isnull(QtyC4,0)) QtyC4,sum(isnull(QtyP4,0)) " +
                        " QtyP4,sum(isnull(QtyS4,0)) QtyS4,sum(isnull(Tot4,0)) Tot4,sum(isnull(TotK4,0)) TotK4, sum(isnull(QtyC5,0)) QtyC5,sum(isnull(QtyP5,0)) " +
                        " QtyP5,sum(isnull(QtyS5,0)) QtyS5,sum(isnull(Tot5,0)) Tot5,sum(isnull(TotK5,0)) TotK5 from ( select tanggal ,PartNo,volume, " +
                        " case when typeR=1 and ((KW='3' or KW='W')or lokasi='cl') then Qty end QtyC1,case when typeR=1 and (KW='P'and lokasi <> 'cl') " +
                        " then Qty end QtyP1, case when typeR=1 and (KW='S'and lokasi <> 'cl') then Qty end QtyS1, case when typeR=1 and ((KW='P' or KW='S') " +
                        " and lokasi <> 'cl') then Qty end Tot1, case when typeR=1 and (KW='P' or KW='S') then QtyK end TotK1, " +
                        " case when typeR=2 and ((KW='3' or KW='W')or lokasi='cl') then Qty end QtyC2, case when typeR=2 and (KW='P' and lokasi <> 'cl') " +
                        " then Qty end QtyP2, case when typeR=2 and (KW='S' and lokasi <> 'cl') then Qty end QtyS2, case when typeR=2 and ((KW='P' or KW='S') " +
                        " and lokasi <> 'cl') then Qty end Tot2, case when typeR=2 and ((KW='P' or KW='S') and lokasi <> 'cl') then QtyK end TotK2, " +
                        " case when typeR=3 and ((KW='3' or KW='W')or lokasi='cl') then Qty end QtyC3, case when typeR=3 and (KW='P' and lokasi <> 'cl') " +
                        " then Qty end QtyP3, case when typeR=3 and (KW='S' and lokasi <> 'cl') then Qty end QtyS3, case when typeR=3 and ((KW='P' or KW='S') " +
                        " and lokasi <> 'cl') then Qty   end Tot3, case when typeR=3 and ((KW='P' or KW='S') and lokasi <> 'cl') then QtyK end TotK3, " +
                        " case when typeR=5 and ((KW='3' or KW='W')or lokasi='cl') then Qty end QtyC4,  case when typeR=5 and (KW='P' and lokasi <> 'cl') " +
                        " then Qty end QtyP4,  case when typeR=5 and (KW='S' and lokasi <> 'cl') then Qty end QtyS4,  case when typeR=5 " +
                        " and ((KW='P' or KW='S') and lokasi <> 'cl') then Qty   end Tot4,  case when typeR=5 and ((KW='P' or KW='S') and lokasi <> 'cl') " +
                        " then QtyK end TotK4,  case when typeR=4 and ((KW='3' or KW='W')or lokasi='cl') then Qty end QtyC5, " +
                        " case when typeR=4 and (KW='P' and lokasi <> 'cl') then Qty end QtyP5,  case when typeR=4 and (KW='S' and lokasi <> 'cl') " +
                        " then Qty end QtyS5,  case when typeR=4 and ((KW='P' or KW='S') and lokasi <> 'cl') then Qty   end Tot5, " +
                        " case when typeR=4 and ((KW='P' or KW='S') and lokasi <> 'cl') then QtyK end TotK5 " +
                        " from (     select R.TglTrans tanggal,I.PartNo,I.volume,SUBSTRING(I.partno,5,1) as KW,sum(R.Qty)Qty,  " +
                        " sum(((I.Panjang*I.Lebar)/(1220*2440) ) * R.Qty) QtyK,isnull(R.TypeR,1)  TypeR,I.ID,L.Lokasi   " +
                        " from T3_Retur R inner join FC_Items I on R.ItemID =I.ID  inner join FC_lokasi L on R.LokID=L.ID " +
                        " where R.RowStatus>-1     group by R.TglTrans,I.PartNo,I.volume,R.TypeR,I.ID,L.Lokasi " +
                        " union all " +
                        " select R.TglTrans tanggal,I.PartNo,I.volume,SUBSTRING(I.partno,5,1) as KW,sum(R.Qty)Qty, " +
                        " sum(((I.Panjang*I.Lebar)/(1220*2440) ) * R.Qty) QtyK,3  TypeR,I.ID,L.Lokasi   " +
                        " from T3_ReturO R inner join FC_Items I on R.ItemID =I.ID  inner join FC_lokasi L on R.LokID=L.ID  where R.RowStatus>-1  " +
                        " group by R.TglTrans,I.PartNo,I.volume,I.ID,L.Lokasi ) as A ) as B " +
                        " where convert(char,tanggal,112)>=@thnbln1  and convert(char,tanggal,112)<=@thnbln2 " +
                        " group by tanggal,PartNo,volume  )  as x ) as xx ),0) ";
                    }
                    else
                    {
                        logikaretur =
                        " isnull((select cast((TotK1/**-TotK2)+TotK3**/) as decimal(18,2))M3 " +
                        " from (  select cast((sum(Volume*Tot1)) as decimal(18,2)) TotK1,cast((sum(Volume*Tot2)) as decimal(18,2)) TotK2, " +
                        " cast((sum(Volume*Tot3)) as decimal(18,2)) TotK3 " +
                        " from (  select tanggal,PartNo,volume ,sum(isnull(QtyC1,0))QtyC1,sum(isnull(QtyP1,0)) QtyP1,sum(isnull(QtyS1,0)) QtyS1, " +
                        " sum(isnull(Tot1,0)) Tot1,sum(isnull(TotK1,0)) TotK1, sum(isnull(QtyC2,0)) QtyC2,sum(isnull(QtyP2,0)) QtyP2,sum(isnull(QtyS2,0)) " +
                        " QtyS2,sum(isnull(Tot2,0)) Tot2, sum(isnull(TotK2,0)) TotK2,sum(isnull(QtyC3,0)) QtyC3,sum(isnull(QtyP3,0)) QtyP3, " +
                        " sum(isnull(QtyS3,0)) QtyS3,sum(isnull(Tot3,0)) Tot3,sum(isnull(TotK3,0)) TotK3 from ( select tanggal ,PartNo,volume, " +
                        " case when typeR=1 and ((KW='3' or KW='W')or lokasi='cl') then Qty end QtyC1,case when typeR=1 and (KW='P'and lokasi <> 'cl') " +
                        " then Qty end QtyP1, case when typeR=1 and (KW='S'and lokasi <> 'cl') then Qty end QtyS1, case when typeR=1 and ((KW='P' or KW='S') " +
                        " and lokasi <> 'cl') then Qty end Tot1, case when typeR=1 and (KW='P' or KW='S') then QtyK end TotK1, case when typeR=2 " +
                        " and ((KW='3' or KW='W')or lokasi='cl') then Qty end QtyC2, case when typeR=2 and (KW='P' and lokasi <> 'cl') then Qty end QtyP2, " +
                        " case when typeR=2 and (KW='S' and lokasi <> 'cl') then Qty end QtyS2, case when typeR=2 and ((KW='P' or KW='S') and lokasi <> 'cl') " +
                        " then Qty end Tot2, case when typeR=2 and ((KW='P' or KW='S') and lokasi <> 'cl') then QtyK end TotK2, " +
                        " case when typeR=3 and ((KW='3' or KW='W')or lokasi='cl') then Qty end QtyC3, case when typeR=3 and (KW='P' and lokasi <> 'cl') " +
                        " then Qty end QtyP3, case when typeR=3 and (KW='S' and lokasi <> 'cl') then Qty end QtyS3, case when typeR=3 and ((KW='P' or KW='S') " +
                        " and lokasi <> 'cl') then Qty   end Tot3, case when typeR=3 and ((KW='P' or KW='S') and lokasi <> 'cl') then QtyK end TotK3 " +
                        " from (select R.TglTrans tanggal,I.PartNo,I.volume,SUBSTRING(I.partno,5,1) as KW,sum(R.Qty)Qty, " +
                        " sum(((I.Panjang*I.Lebar)/(1220*2440) ) * R.Qty) QtyK,isnull(R.TypeR,1)  TypeR,I.ID,L.Lokasi    " +
                        " from T3_Retur R inner join FC_Items I on R.ItemID =I.ID  inner join FC_lokasi L on R.LokID=L.ID  where R.RowStatus>-1   " +
                        " group by R.TglTrans,I.PartNo,I.volume,R.TypeR,I.ID,L.Lokasi " +
                        " union all " +
                        " select R.TglTrans tanggal,I.PartNo,I.volume,SUBSTRING(I.partno,5,1) as KW,sum(R.Qty)Qty," +
                        " sum(((I.Panjang*I.Lebar)/(1220*2440) ) * R.Qty) QtyK,3  TypeR,I.ID,L.Lokasi     " +
                        " from T3_ReturO R inner join FC_Items I on R.ItemID =I.ID  inner join FC_lokasi L on R.LokID=L.ID  where R.RowStatus>-1  " +
                        " group by R.TglTrans,I.PartNo,I.volume,I.ID,L.Lokasi ) as A ) as B where convert(char,tanggal,112)>=@thnbln1 " +
                        " and convert(char,tanggal,112)<=@thnbln2 group by tanggal,PartNo,volume ) as x ) as x1),0)  ";

                    }

                    #region query kubik
                    if (Convert.ToInt32(strtgl1.Substring(0, 6)) < 201911 && users.UnitKerjaID.ToString() != "13")
                    #region Periode Lama
                    {
                        strSQL = "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectGPIso]') AND type in (N'U')) DROP TABLE [dbo].[tempdefectGPIso]  " +
                        "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectGPIsoTot]') AND type in (N'U')) DROP TABLE [dbo].tempdefectGPIsoTot  " +
                        "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectFin]') AND type in (N'U')) DROP TABLE [dbo].tempdefectFin " +
                        "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectL1]') AND type in (N'U')) DROP TABLE [dbo].tempdefectL1 " +
                        "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectL2]') AND type in (N'U')) DROP TABLE [dbo].tempdefectL2 " +
                        "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectL3]') AND type in (N'U')) DROP TABLE [dbo].tempdefectL3 " +
                        "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectL4]') AND type in (N'U')) DROP TABLE [dbo].tempdefectL4 " +
                        "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectL5]') AND type in (N'U')) DROP TABLE [dbo].tempdefectL5 " +
                        "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectL6]') AND type in (N'U')) DROP TABLE [dbo].tempdefectL6 " +
                                    "declare @thnbln1 varchar(8) " +
                        "declare @thnbln2 varchar(8) " +
                        "set @thnbln1='" + strtgl1 + "' " +
                        "set @thnbln2='" + strtgl2 + "' " +
                                    "select *  into tempdefectGPIso from (  " +
                        "select case when D.DeptID=0 then  " +
                        "case when GJ.GroupJemurName In ('M','N','O','P','Q','R','S','T','U','V','W','X') then   " +
                        "    case when D.DefName='retak' then 2   " +
                        "        when D.DefName='gompal' then 3  " +
                        "    else D.DeptID end   " +
                        "else    " +
                        "    case when (B.Qty/E.Qty) *100 >5 then 2 else 3 end   " +
                        "end  " +
                        "else D.DeptID end deptID1,A.CreatedTime as tglInput,A.Tgl as TglPeriksa,E.TglProduksi as TglProd,  D.DefCode,BP.PlantName as Line, PG.[Group],BF.FormulaCode as Jenis,   " +
                        "D.DefName,D.DeptID,B.ID,B.DefectID,B.MasterID,B.Qty,A.ID  DestID,isnull(A.TPotong,0)  QtyIn,B.Qty*I.Volume as Kubik,isnull(A.TPotong,0) as TotPotong,'' sfrom  " +
                        "from Def_DefectDetail B inner join Def_Defect A on A.Id=B.DefectID   " +
                        "left join Def_MasterDefect D on B.MasterID=D.ID left join BM_Destacking E on E.ID=A.DestID   " +
                        "left join BM_PlantGroup PG on A.GroupProdID=PG.ID left join BM_Formula BF on BF.ID=E.FormulaID    " +
                        "left join BM_Plant BP on BP.ID=E.PlantID left join FC_Items I on I.ID=E.ItemID inner join Def_GroupJemur GJ on GJ.ID=A.GroupJemurID  " +
                        "where B.RowStatus>-1  and D.RowStatus >-1) as Def    " +
                        "where DeptID1=2 and CONVERT(varchar,TglPeriksa,112)>=@thnbln1 and CONVERT(varchar,TglPeriksa,112)<=@thnbln2  " +
                        " " +
                         QueryTotalPotong +
                        " " +
                        "declare @DefectFin decimal(18,2) " +
                        "set @DefectFin= (select sum(kubik) from (  " +
                        "select case when D.DeptID=0 then  " +
                        "case when GJ.GroupJemurName In ('M','N','O','P','Q','R','S','T','U','V','W','X') then   " +
                        "case when D.DefName='retak' then 2   " +
                        "when D.DefName='gompal' then 3  " +
                        "else D.DeptID end   " +
                        "else    " +
                        "case when (B.Qty/E.Qty) *100 >5 then 2 else 3 end   " +
                        "end  " +
                        "else D.DeptID end deptID1,A.CreatedTime as tglInput,A.Tgl as TglPeriksa,E.TglProduksi as TglProd,  D.DefCode,BP.PlantName as Line, PG.[Group],BF.FormulaCode as Jenis,   " +
                        "D.DefName,D.DeptID,B.ID,B.DefectID,B.MasterID,B.Qty,A.ID  DestID,isnull(A.TPotong,0)  QtyIn,B.Qty*I.Volume as Kubik,isnull(A.TPotong,0) as TotPotong,'' sfrom  " +
                        "from Def_DefectDetail B inner join Def_Defect A on A.Id=B.DefectID   " +
                        "left join Def_MasterDefect D on B.MasterID=D.ID left join BM_Destacking E on E.ID=A.DestID   " +
                        "left join BM_PlantGroup PG on A.GroupProdID=PG.ID left join BM_Formula BF on BF.ID=E.FormulaID    " +
                        "left join BM_Plant BP on BP.ID=E.PlantID left join FC_Items I on I.ID=E.ItemID inner join Def_GroupJemur GJ on GJ.ID=A.GroupJemurID  " +
                        "where B.RowStatus>-1  and D.RowStatus >-1) as Def    " +
                        "where DeptID1<>2 and CONVERT(varchar,TglPeriksa,112)>=@thnbln1 and CONVERT(varchar,TglPeriksa,112)<=@thnbln2) " +
                        " " +
                        "select * into tempdefectFin from ( " +
                        "select 'OKKW' fin, sum(qtyin) lembar,sum(qtyin * kubik)kubik from ( " +
                        "select I1.PartNo partno1,I1.Panjang * I1.Lebar luas1,  S.qtyin,I2.PartNo partno2,I2.Panjang * I2.Lebar luas2,  S.qtyout ,(I1.Tebal * I1.Panjang * I1.Lebar)/1000000000 kubik " +
                        "from t3_simetris S inner join T3_Serah Se on S.SerahID =Se.ID inner join fc_items I1 on Se.ItemID=I1.ID inner join fc_items I2 on S.ItemID=I2.id  " +
                        "where I2.lebar>500 and S.RowStatus>-1 and CONVERT(varchar,S.tgltrans,112)>=@thnbln1 and CONVERT(varchar,S.tgltrans,112)<=@thnbln2 )a where partno1 like '%-1-%' and luas2/luas1 *100<60 and partno2 like '%-p-%' " +
                        "union all " +
                        "select 'BP' fin, sum(qtyin) lembar,sum(qtyin * kubik)kubik from ( " +
                        "select I1.PartNo partno1,I1.Panjang * I1.Lebar luas1,  S.qtyin,I2.PartNo partno2,I2.Panjang * I2.Lebar luas2,  S.qtyout ,(I1.Tebal * I1.Panjang * I1.Lebar)/1000000000 kubik " +
                        "from t3_simetris S inner join T3_Serah Se on S.SerahID =Se.ID inner join fc_items I1 on Se.ItemID=I1.ID inner join fc_items I2 on S.ItemID=I2.id  " +
                        "where S.RowStatus>-1 and CONVERT(varchar,S.tgltrans,112)>=@thnbln1 and CONVERT(varchar,S.tgltrans,112)<=@thnbln2  )a where partno1 like '%-1-%' and luas2/luas1 *100<60 and  " +
                        "(partno2 like '%-3-%' or partno2 like '%-w-%' or partno2 like '%-m-%') " +
                        "union all " +
                        "select 'BS' fin,sum(R.QtyIn) Lembar,sum(R.QtyIn *((I.tebal*I.panjang*I.lebar)/1000000000)) kubik from T3_Rekap R inner join FC_Items I on R.ItemID=I.id inner join fc_lokasi L on R.LokID =L.id where R.RowStatus>-1 and  " +
                        "CONVERT(varchar,R.tgltrans,112)>=@thnbln1 and CONVERT(varchar,R.tgltrans,112)<=@thnbln2 and I.PartNo like '%-s-%' and Process='direct' " +
                        perubahanlogikalisplank + ")A " +
                        " " +
                        "declare @TotalPotong decimal(18,2) " +
                        "declare @TotalDefKhusus decimal(18,2) " +
                        "declare @DefKhusus decimal(18,2) " +
                        "declare @Ttotalkw1kw2 decimal(18,2) " +
                        "declare @NCSortir decimal(18,2) " +
                        "declare @Retur decimal(18,2) " +
                        "set @TotalPotong=isnull((select sum(totkubik ) from tempdefectGPIsoTot),0) " +
                        "declare @SelisihTotalPotong decimal(18,2) " +
                        "declare @TotalAccReport decimal(18,2) " +
                        "set @TotalAccReport=(select kubik from( " +
                        "    select  sum(lembar) lembar,sum(kubik)kubik from ( " +
                        "    select 'AccReport' fin, sum(qtyin) lembar,sum(qtyin * kubik)kubik from ( " +
                        "    select I1.PartNo partno1,I1.Panjang * I1.Lebar luas1,  S.qtyin,I2.PartNo partno2,I2.Panjang * I2.Lebar luas2,  S.qtyout ,(I1.Tebal * I1.Panjang * I1.Lebar)/1000000000 kubik " +
                        "    from t3_simetris S inner join T3_Serah Se on S.SerahID =Se.ID inner join fc_items I1 on Se.ItemID=I1.ID inner join fc_items I2 on S.ItemID=I2.id  " +
                        "    where S.RowStatus>-1 and CONVERT(varchar,S.tgltrans,112)>=@thnbln1 and CONVERT(varchar,S.tgltrans,112)<=@thnbln2 )a  " +
                        "    where partno1 like '%-1-%' and luas2/luas1 *100>90  and (partno2 like '%-p-%' or partno2 like '%-3-%' or partno2 like '%-M-%') " +
                        "    union all " +
                        "    select 'AccReport' fin, sum(qtyin) lembar,sum(qtyin * kubik)kubik from ( " +
                        "    select I1.PartNo partno1,I1.Panjang * I1.Lebar luas1,  S.qtyin,I2.PartNo partno2,I2.Panjang * I2.Lebar luas2,  S.qtyout ,(I1.Tebal * I1.Panjang * I1.Lebar)/1000000000 kubik " +
                        "    from t1_serah S  inner join fc_items I1 on S.ItemID0=I1.ID inner join fc_items I2 on S.ItemID=I2.id  " +
                        "    where S.Status>-1 and CONVERT(varchar,S.tglserah,112)>=@thnbln1 and CONVERT(varchar,S.tglserah,112)<=@thnbln2 )a  " +
                        "    where (partno2 like '%-p-%' or partno2 like '%-3-%' or partno2 like '%-M-%'))a)B) " +
                        "set @SelisihTotalPotong= @TotalAccReport-@TotalPotong " +
                        "if @TotalPotong >0  " +
                        "begin " +
                        "set @TotalDefKhusus=isnull((select sum(kubik) from tempdefectFin),0) " +
                        "set @DefKhusus=isnull((select sum(kubik) from tempdefectFin where fin<>'bp'),0) " +
                        "set @Ttotalkw1kw2 =isnull((select sum(qtyin *((I.tebal*I.Lebar*I.Panjang)/1000000000)) from T3_Rekap R inner join fc_items I on R.itemid=I.ID  " +
                        "where R.rowstatus>-1 and R.Process  like '%simetris%' and CONVERT(varchar,R.tgltrans,112)>=@thnbln1 and CONVERT(varchar,R.tgltrans,112)<=@thnbln2   " +
                        "and I.lebar=1200 and I.panjang=2400 and R.keterangan like '%-p-%' and (I.partno like '%-3-%' or I.partno like '%-W-%' or I.partno like '%-M-%' )),0) " +
                        "set @NCSortir=isnull((select /*sum(QtyAkhirSS)+sum(QtyAkhirSE)*/sum(M3AkhirSS)+sum(M3AkhirSE) from (  " +
                        "SELECT B.tgltrans as Tanggal, I1.PartNo as PartnoAwal, sum(B.QtyIn) as QtyAwal,sum(I1.Volume*B.QtyIn) M3Awal,   " +
                        "I2.PartNo AS PartnoAkhir, case when B.NCSS>0 then sum(B.QtyOut) else 0 end QtyAkhirSS,  " +
                        "case when B.NCSS>0 then sum(I2.Volume*B.QtyOut) else 0 end M3AkhirSS,case when B.NCSE>0 then sum(B.QtyOut) else 0 end QtyAkhirSE,  " +
                        "case when B.NCSE>0 then sum(I2.Volume*B.QtyOut) else 0 end M3AkhirSE,B.NCSS,B.NCSE  FROM T3_Serah AS A   " +
                        "INNER JOIN T3_Simetris AS B ON A.ID = B.SerahID INNER JOIN FC_Items AS I1 ON A.ItemID = I1.ID INNER JOIN   " +
                        "FC_Items AS I2 ON B.ItemID = I2.ID LEFT JOIN T3_GroupM AS D ON B.GroupID = D.ID   " +
                        "where (B.NCSS>0 or B.NCSE>0) and B.rowstatus>-1 and CONVERT(varchar,B.tgltrans,112)>=@thnbln1 and CONVERT(varchar,B.tgltrans,112)<=@thnbln2   " +
                        "group by B.tgltrans,I1.PartNo,I2.PartNo,B.NCSS,B.NCSE) S),0) " +
                        "set @Retur=isnull((select sum(qty) from ( " +
                        "select sum(qty *(I.tebal*I.panjang*I.lebar)/1000000000) qty from t3_retur R inner join fc_items I on R.itemid=I.id where R.rowstatus>-1 and  " +
                        "R.typer=1 and (I.partno like '%-p-%' or I.partno like '%-S-%')  and CONVERT(varchar,R.tgltrans,112)>=@thnbln1 and CONVERT(varchar,R.tgltrans,112)<=@thnbln2  " +
                        "union all " +
                        "select sum(qty *(I.tebal*I.panjang*I.lebar)/1000000000)*-1 qty from t3_retur R inner join fc_items I on R.itemid=I.id where R.rowstatus>-1 and  " +
                        "R.typer=2 and (I.partno like '%-p-%' or I.partno like '%-S-%')and CONVERT(varchar,R.tgltrans,112)>=@thnbln1 and CONVERT(varchar,R.tgltrans,112)<=@thnbln2 " +
                        "union all " +
                        "select sum(qty *(I.tebal*I.panjang*I.lebar)/1000000000) qty from t3_returO R inner join fc_items I on R.itemid=I.id where R.rowstatus>-1 and  " +
                        "(I.partno like '%-p-%' or I.partno like '%-S-%') and CONVERT(varchar,R.tgltrans,112)>=@thnbln1 and CONVERT(varchar,R.tgltrans,112)<=@thnbln2)A),0) " +
                        " " +
                        "declare @TotalPotongL1 decimal(18,2) " +
                        "declare @TotDefKhususL1 decimal(18,2) " +
                        "declare @DefKhususL1 decimal(18,2) " +
                        "declare @Ttotalkw1kw2L1 decimal(18,2) " +
                        "declare @NCSortirL1 decimal(18,2) " +
                        "declare @ReturL1 decimal(18,2) " +
                        "declare @DefectFinL1 decimal(18,2) " +

                        "set @TotalPotongL1=(select sum(totkubik ) from tempdefectGPIsoTot where [group]in (select [group] from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 1'))) " +
                        "set @TotDefKhususL1=(@TotalPotongL1/@TotalPotong)*@TotalDefKhusus " +
                        "set @DefKhususL1=(@TotalPotongL1/@TotalPotong)*@DefKhusus " +
                        "set @Ttotalkw1kw2L1=(@TotalPotongL1/@TotalPotong)*@Ttotalkw1kw2 " +
                        "set @NCSortirL1=(@TotalPotongL1/@TotalPotong)*@NCSortir " +
                        "set @ReturL1=(@TotalPotongL1/@TotalPotong)*@Retur " +
                        "set @DefectFinL1=isnull((@TotalPotongL1/@TotalPotong)*@DefectFin,0) " +
                        "declare @SelisihTotalPotongL1 decimal(18,2) " +
                        "set @SelisihTotalPotongL1=(@TotalPotongL1/@TotalPotong)*@SelisihTotalPotong " +
                        "if @TotalPotongL1>0 " +
                        "begin " +
                        "select * into tempdefectL1 from ( " +
                        "select *,c-d+e+f+g+h i,case when b>0 then (c-d+e+f+g+h)/b*100 else 0  end j from ( " +
                        "select [Group],case when @TotalPotongL1>0 then isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) +  " +
                        "  (( isnull(( select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@TotDefKhususL1) + " +
                        "(( isnull((   select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@SelisihTotalPotongL1) else 0 end b, " +
                        " case when @TotalPotongL1>0 then isnull((select totdefectK from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)  else 0 end c, " +
                        " case when @TotalPotongL1>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@Ttotalkw1kw2L1) else 0 end  d, " +
                        " case when @TotalPotongL1>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@NCSortirL1)  else 0 end  e, " +
                        " case when @TotalPotongL1>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@ReturL1)  else 0 end  f, " +
                        " case when @TotalPotongL1>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@DefectFinL1)  else 0 end g, " +
                        " case when @TotalPotongL1>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@DefKhususL1) else 0 end  h " +
                        " from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 1') )A " +
                        "union all  " +
                        "select 'Total' [Group],sum(b)b,sum(c)c,sum(d)d,sum(e)e,sum(f)f,sum(g)g,sum(h)h,sum(c)-sum(d)+sum(e)+sum(f)+sum(g)+sum(h) i " +
                        ",cast((sum(c)-sum(d)+sum(e)+sum(f)+sum(g)+sum(h))/sum(b)*100 as decimal(18,1)) j from( " +
                        "select [Group],case when @TotalPotongL1>0 then isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) +  " +
                        "  (( isnull(( select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@TotDefKhususL1) + " +
                        "(( isnull((   select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@SelisihTotalPotongL1) else 0 end b, " +
                        " case when @TotalPotongL1>0 then isnull((select totdefectK from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)  else 0 end c, " +
                        " case when @TotalPotongL1>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@Ttotalkw1kw2L1) else 0 end  d, " +
                        " case when @TotalPotongL1>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@NCSortirL1)  else 0 end  e, " +
                        " case when @TotalPotongL1>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@ReturL1)  else 0 end  f, " +
                        " case when @TotalPotongL1>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@DefectFinL1)  else 0 end g, " +
                        " case when @TotalPotongL1>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@DefKhususL1) else 0 end  h, " +
                        " 0 i,0 j from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 1'))A )B " +
                        " end " +
                        " else " +
                        " begin " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 h,0 i, 0 j into tempdefectL1 " +
                        " end " +
                        " " +
                        "update SPD_Trans set actual=(select j from tempdefectL1 where [group]='total') where approval=0 and Tahun =" + ddTahun.SelectedValue + " and Bulan=" + ddlBulan.SelectedValue.ToString() + " and sarmutdeptid in ( " +
                        "select ID from SPD_Departemen where SarmutDepartemen='Line 1' and SarmutPID in (select ID from SPD_Perusahaan where SarMutPerusahaan ='Defect Board Mill')) " +

                        "declare @TotalPotongL2 decimal(18,2) " +
                        "declare @TotDefKhususL2 decimal(18,2) " +
                        "declare @DefKhususL2 decimal(18,2) " +
                        "declare @Ttotalkw1kw2L2 decimal(18,2) " +
                        "declare @NCSortirL2 decimal(18,2) " +
                        "declare @ReturL2 decimal(18,2) " +
                        "declare @DefectFinL2 decimal(18,2) " +

                        "set @TotalPotongL2=(select sum(totkubik ) from tempdefectGPIsoTot where [group]in (select [group] from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 2'))) " +
                        "set @TotDefKhususL2=(@TotalPotongL2/@TotalPotong)*@TotalDefKhusus " +
                        "set @DefKhususL2=(@TotalPotongL2/@TotalPotong)*@DefKhusus " +
                        "set @Ttotalkw1kw2L2=(@TotalPotongL2/@TotalPotong)*@Ttotalkw1kw2 " +
                        "set @NCSortirL2=(@TotalPotongL2/@TotalPotong)*@NCSortir " +
                        "set @ReturL2=(@TotalPotongL2/@TotalPotong)*@Retur " +
                        "set @DefectFinL2=isnull((@TotalPotongL2/@TotalPotong)*@DefectFin,0) " +
                        "declare @SelisihTotalPotongL2 decimal(18,2) " +
                        "set @SelisihTotalPotongL2=(@TotalPotongL2/@TotalPotong)*@SelisihTotalPotong " +
                        "if @TotalPotongL2>0 " +
                        "begin " +
                        "select * into tempdefectL2 from ( " +
                        "select *,c-d+e+f+g+h i,case when b>0 then (c-d+e+f+g+h)/b*100 else 0  end j from ( " +
                        "select [Group],case when @TotalPotongL2>0 then isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) +  " +
                        " ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL2)*@TotDefKhususL2)+ " +
                        "(( isnull((   select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL2)*@SelisihTotalPotongL2) else 0 end  b, " +
                        " case when @TotalPotongL2>0 then isnull((select totdefectK from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) else 0 end c, " +
                        " case when @TotalPotongL2>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL2)*@Ttotalkw1kw2L2) else 0 end  d, " +
                        " case when @TotalPotongL2>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL2)*@NCSortirL2) else 0 end  e, " +
                        " case when @TotalPotongL2>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL2)*@ReturL2)  else 0 end f, " +
                        " case when @TotalPotongL2>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL2)*@DefectFinL2) else 0 end  g, " +
                        " case when @TotalPotongL2>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL2)*@DefKhususL2) else 0 end  h " +
                        "  from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 2') )A " +
                        "union all  " +
                        "select 'Total' [Group],sum(b)b,sum(c)c,sum(d)d,sum(e)e,sum(f)f,sum(g)g,sum(h)h,sum(c)-sum(d)+sum(e)+sum(f)+sum(g)+sum(h) i " +
                        ",cast((sum(c)-sum(d)+sum(e)+sum(f)+sum(g)+sum(h))/sum(b)*100 as decimal(18,1)) j from( " +
                        "select [Group],case when @TotalPotongL2>0 then isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) +  " +
                        " ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL2)*@TotDefKhususL2) + " +
                        "(( isnull((   select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL2)*@SelisihTotalPotongL2) else 0 end  b, " +
                        " case when @TotalPotongL2>0 then isnull((select totdefectK from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) else 0 end c, " +
                        " case when @TotalPotongL2>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL2)*@Ttotalkw1kw2L2) else 0 end  d, " +
                        " case when @TotalPotongL2>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL2)*@NCSortirL2) else 0 end  e, " +
                        " case when @TotalPotongL2>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL2)*@ReturL2)  else 0 end f, " +
                        " case when @TotalPotongL2>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL2)*@DefectFinL2) else 0 end  g, " +
                        " case when @TotalPotongL2>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL2)*@DefKhususL2) else 0 end  h, " +
                        " 0 i,0 j from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 2'))A )B " +
                        " end " +
                        " else " +
                        " begin " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 h,0 i, 0 j into tempdefectL2 " +
                        " end " +
                        " " +
                        "update SPD_Trans set actual=(select j from tempdefectL2 where [group]='total') where approval=0 and Tahun =" + ddTahun.SelectedValue + " and Bulan=" + ddlBulan.SelectedValue.ToString() + " and sarmutdeptid in ( " +
                        "select ID from SPD_Departemen where SarmutDepartemen='Line 2' and SarmutPID in (select ID from SPD_Perusahaan where SarMutPerusahaan ='Defect Board Mill')) " +

                        "declare @TotalPotongL3 decimal(18,2) " +
                        "declare @TotDefKhususL3 decimal(18,2) " +
                        "declare @DefKhususL3 decimal(18,2) " +
                        "declare @Ttotalkw1kw2L3 decimal(18,2) " +
                        "declare @NCSortirL3 decimal(18,2) " +
                        "declare @ReturL3 decimal(18,2) " +
                        "declare @DefectFinL3 decimal(18,2) " +
                        "set @TotalPotongL3=(select sum(totkubik ) from tempdefectGPIsoTot where [group]in (select [group] from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 3'))) " +
                        "set @TotDefKhususL3=(@TotalPotongL3/@TotalPotong)*@TotalDefKhusus " +
                        "set @DefKhususL3=(@TotalPotongL3/@TotalPotong)*@DefKhusus " +
                        "set @Ttotalkw1kw2L3=(@TotalPotongL3/@TotalPotong)*@Ttotalkw1kw2 " +
                        "set @NCSortirL3=(@TotalPotongL3/@TotalPotong)*@NCSortir " +
                        "set @ReturL3=(@TotalPotongL3/@TotalPotong)*@Retur " +
                        "set @DefectFinL3=isnull((@TotalPotongL3/@TotalPotong)*@DefectFin,0) " +
                        "declare @SelisihTotalPotongL3 decimal(18,2) " +
                        "set @SelisihTotalPotongL3=(@TotalPotongL3/@TotalPotong)*@SelisihTotalPotong " +
                        "if @TotalPotongL3>0 " +
                        "begin " +
                        "select * into tempdefectL3 from ( " +
                        "select *,c-d+e+f+g+h i,case when b>0 then (c-d+e+f+g+h)/b*100 else 0  end j from ( " +
                        "select [Group],case when @TotalPotongL3>0 then isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) +  " +
                        " ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@TotDefKhususL3)+ " +
                        "(( isnull((   select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@SelisihTotalPotongL3) else 0 end  b, " +
                        " case when @TotalPotongL3>0 then isnull((select totdefectK from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) else 0 end c, " +
                        " case when @TotalPotongL3>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@Ttotalkw1kw2L3) else 0 end  d, " +
                        " case when @TotalPotongL3>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@NCSortirL3) else 0 end  e, " +
                        " case when @TotalPotongL3>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@ReturL3) else 0 end  f, " +
                        " case when @TotalPotongL3>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@DefectFinL3) else 0 end  g, " +
                        " case when @TotalPotongL3>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@DefKhususL3) else 0 end  h " +
                        "  from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 3') )A " +
                        "union all  " +
                        "select 'Total' [Group],sum(b)b,sum(c)c,sum(d)d,sum(e)e,sum(f)f,sum(g)g,sum(h)h,sum(c)-sum(d)+sum(e)+sum(f)+sum(g)+sum(h) i " +
                        ",cast((sum(c)-sum(d)+sum(e)+sum(f)+sum(g)+sum(h))/sum(b)*100 as decimal(18,1)) j from( " +
                        "select [Group],isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) +  " +
                        " ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@TotDefKhususL3)+ " +
                        "(( isnull((   select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@SelisihTotalPotongL3) b, " +
                        " isnull((select totdefectK from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)c, " +
                        " ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@Ttotalkw1kw2L3) d, " +
                        " ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@NCSortirL3) e, " +
                        " ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@ReturL3) f, " +
                        " ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@DefectFinL3) g, " +
                        " ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@DefKhususL3) h, " +
                        " 0 i,0 j from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 3'))A )B " +
                        " end " +
                        " else " +
                        " begin " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 h,0 i, 0 j into tempdefectL3 " +
                        " end " +
                        " " +

                        "update SPD_Trans set actual=(select j from tempdefectL3 where [group]='total') where approval=0 and Tahun =" + ddTahun.SelectedValue + " and Bulan=" + ddlBulan.SelectedValue.ToString() + " and sarmutdeptid in ( " +
                        "select ID from SPD_Departemen where SarmutDepartemen='Line 3' and SarmutPID in (select ID from SPD_Perusahaan where SarMutPerusahaan ='Defect Board Mill')) " +
                        "declare @TotalPotongL4 decimal(18,2) " +
                        "declare @TotDefKhususL4 decimal(18,2) " +
                        "declare @DefKhususL4 decimal(18,2) " +
                        "declare @Ttotalkw1kw2L4 decimal(18,2) " +
                        "declare @NCSortirL4 decimal(18,2) " +
                        "declare @ReturL4 decimal(18,2) " +
                        "declare @DefectFinL4 decimal(18,2) " +
                        "set @TotalPotongL4=(select sum(totkubik ) from tempdefectGPIsoTot where [group]in (select [group] from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 4'))) " +
                        "set @TotDefKhususL4=(@TotalPotongL4/@TotalPotong)*@TotalDefKhusus " +
                        "set @DefKhususL4=(@TotalPotongL4/@TotalPotong)*@DefKhusus " +
                        "set @Ttotalkw1kw2L4=(@TotalPotongL4/@TotalPotong)*@Ttotalkw1kw2 " +
                        "set @NCSortirL4=(@TotalPotongL4/@TotalPotong)*@NCSortir " +
                        "set @ReturL4=(@TotalPotongL4/@TotalPotong)*@Retur " +
                        "set @DefectFinL4=isnull((@TotalPotongL4/@TotalPotong)*@DefectFin,0) " +
                        "declare @SelisihTotalPotongL4 decimal(18,2) " +
                        "set @SelisihTotalPotongL4=(@TotalPotongL4/@TotalPotong)*@SelisihTotalPotong " +
                        "if @TotalPotongL4>0 " +
                        "begin " +
                        "select * into tempdefectL4 from ( " +
                        "select *,c-d+e+f+g+h i,case when b>0 then (c-d+e+f+g+h)/b*100 else 0  end j from ( " +
                        "select [Group],case when @TotalPotongL4>0 then isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) +  " +
                        " ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@TotDefKhususL4)+ " +
                        "(( isnull((   select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@SelisihTotalPotongL4) else 0 end  b, " +
                        " case when @TotalPotongL4>0 then isnull((select totdefectK from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) else 0 end c, " +
                        " case when @TotalPotongL4>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@Ttotalkw1kw2L4) else 0 end  d, " +
                        " case when @TotalPotongL4>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@NCSortirL4) else 0 end  e, " +
                        " case when @TotalPotongL4>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@ReturL4) else 0 end  f, " +
                        " case when @TotalPotongL4>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@DefectFinL4) else 0 end  g, " +
                        " case when @TotalPotongL4>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@DefKhususL4) else 0 end  h " +
                        "  from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 4') )A " +
                        "union all  " +
                        "select 'Total' [Group],sum(b)b,sum(c)c,sum(d)d,sum(e)e,sum(f)f,sum(g)g,sum(h)h,sum(c)-sum(d)+sum(e)+sum(f)+sum(g)+sum(h) i " +
                        ",cast((sum(c)-sum(d)+sum(e)+sum(f)+sum(g)+sum(h))/sum(b)*100 as decimal(18,1)) j from( " +
                        "select [Group],isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) +  " +
                        " ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@TotDefKhususL4)+ " +
                        "(( isnull((   select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@SelisihTotalPotongL4) b, " +
                        " isnull((select totdefectK from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)c, " +
                        " ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@Ttotalkw1kw2L4) d, " +
                        " ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@NCSortirL4) e, " +
                        " ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@ReturL4) f, " +
                        " ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@DefectFinL4) g, " +
                        " ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@DefKhususL4) h, " +
                        " 0 i,0 j from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 4'))A )B " +
                        " end " +
                        " else " +
                        " begin " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 h,0 i, 0 j into tempdefectL4 " +
                        " end " +
                        " " +
                        "update SPD_Trans set actual=(select j from tempdefectL4 where [group]='total') where approval=0 and Tahun =" + ddTahun.SelectedValue + " and Bulan=" + ddlBulan.SelectedValue.ToString() + " and sarmutdeptid in ( " +
                        "select ID from SPD_Departemen where SarmutDepartemen='Line 4' and SarmutPID in (select ID from SPD_Perusahaan where SarMutPerusahaan ='Defect Board Mill')) " +
                        "declare @TotalPotongL5 decimal(18,2) " +
                        "declare @TotDefKhususL5 decimal(18,2) " +
                        "declare @DefKhususL5 decimal(18,2) " +
                        "declare @Ttotalkw1kw2L5 decimal(18,2) " +
                        "declare @NCSortirL5 decimal(18,2) " +
                        "declare @ReturL5 decimal(18,2) " +
                        "declare @DefectFinL5 decimal(18,2) " +
                        "set @TotalPotongL5=(select sum(totkubik ) from tempdefectGPIsoTot where [group]in (select [group] from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 5'))) " +
                        "set @TotDefKhususL5=(@TotalPotongL5/@TotalPotong)*@TotalDefKhusus " +
                        "set @DefKhususL5=(@TotalPotongL5/@TotalPotong)*@DefKhusus " +
                        "set @Ttotalkw1kw2L5=(@TotalPotongL5/@TotalPotong)*@Ttotalkw1kw2 " +
                        "set @NCSortirL5=(@TotalPotongL5/@TotalPotong)*@NCSortir " +
                        "set @ReturL5=(@TotalPotongL5/@TotalPotong)*@Retur " +
                        "set @DefectFinL5=isnull((@TotalPotongL5/@TotalPotong)*@DefectFin,0) " +
                        "declare @SelisihTotalPotongL5 decimal(18,2) " +
                        "set @SelisihTotalPotongL5=(@TotalPotongL5/@TotalPotong)*@SelisihTotalPotong " +
                        "if @TotalPotongL5>0 " +
                        "begin " +
                        "select * into tempdefectL5 from ( " +
                        "select *,c-d+e+f+g+h i,case when b>0 then (c-d+e+f+g+h)/b*100 else 0  end j from ( " +
                        "select [Group],case when @TotalPotongL5>0 then isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) +  " +
                        " ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@TotDefKhususL5)+ " +
                        "(( isnull((   select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@SelisihTotalPotongL5) else 0 end  b, " +
                        " case when @TotalPotongL5>0 then isnull((select totdefectK from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) else 0 end c, " +
                        " case when @TotalPotongL5>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@Ttotalkw1kw2L5) else 0 end  d, " +
                        " case when @TotalPotongL5>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@NCSortirL5) else 0 end  e, " +
                        " case when @TotalPotongL5>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@ReturL5) else 0 end  f, " +
                        " case when @TotalPotongL5>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@DefectFinL5) else 0 end  g, " +
                        " case when @TotalPotongL5>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@DefKhususL5) else 0 end  h " +
                        "  from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 5') )A " +
                        "union all  " +
                        "select 'Total' [Group],sum(b)b,sum(c)c,sum(d)d,sum(e)e,sum(f)f,sum(g)g,sum(h)h,sum(c)-sum(d)+sum(e)+sum(f)+sum(g)+sum(h) i " +
                        ",cast((sum(c)-sum(d)+sum(e)+sum(f)+sum(g)+sum(h))/sum(b)*100 as decimal(18,1)) j from( " +
                        "select [Group],isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) +  " +
                        " ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@TotDefKhususL5)+ " +
                        "(( isnull((   select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@SelisihTotalPotongL5) b, " +
                        " isnull((select totdefectK from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)c, " +
                        " ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@Ttotalkw1kw2L5) d, " +
                        " ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@NCSortirL5) e, " +
                        " ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@ReturL5) f, " +
                        " ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@DefectFinL5) g, " +
                        " ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@DefKhususL5) h, " +
                        " 0 i,0 j from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 5'))A )B " +
                        " end " +
                        " else " +
                        " begin " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 h,0 i, 0 j into tempdefectL5 " +
                        " end " +
                        " " +
                        "update SPD_Trans set actual=(select j from tempdefectL5 where [group]='total') where approval=0 and Tahun =" + ddTahun.SelectedValue + " and Bulan=" + ddlBulan.SelectedValue.ToString() + " and sarmutdeptid in ( " +
                        "select ID from SPD_Departemen where SarmutDepartemen='Line 5' and SarmutPID in (select ID from SPD_Perusahaan where SarMutPerusahaan ='Defect Board Mill')) " +
                        "declare @TotalPotongL6 decimal(18,2) " +
                        "declare @TotDefKhususL6 decimal(18,2) " +
                        "declare @DefKhususL6 decimal(18,2) " +
                        "declare @Ttotalkw1kw2L6 decimal(18,2) " +
                        "declare @NCSortirL6 decimal(18,2) " +
                        "declare @ReturL6 decimal(18,2) " +
                        "declare @DefectFinL6 decimal(18,2) " +
                        "set @TotalPotongL6=(select sum(totkubik ) from tempdefectGPIsoTot where [group]in (select [group] from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 6'))) " +
                        "set @TotDefKhususL6=(@TotalPotongL6/@TotalPotong)*@TotalDefKhusus " +
                        "set @DefKhususL6=(@TotalPotongL6/@TotalPotong)*@DefKhusus " +
                        "set @Ttotalkw1kw2L6=(@TotalPotongL6/@TotalPotong)*@Ttotalkw1kw2 " +
                        "set @NCSortirL6=(@TotalPotongL6/@TotalPotong)*@NCSortir " +
                        "set @ReturL6=(@TotalPotongL6/@TotalPotong)*@Retur " +
                        "set @DefectFinL6=isnull((@TotalPotongL6/@TotalPotong)*@DefectFin,0) " +
                        "declare @SelisihTotalPotongL6 decimal(18,2) " +
                        "set @SelisihTotalPotongL6=(@TotalPotongL6/@TotalPotong)*@SelisihTotalPotong " +
                        "if @TotalPotongL6>0 " +
                        "begin " +
                        "select * into tempdefectL6 from ( " +
                        "select *,c-d+e+f+g+h i,case when b>0 then (c-d+e+f+g+h)/b*100 else 0  end j from ( " +
                        "select [Group],case when @TotalPotongL6>0 then isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) +  " +
                        " ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@TotDefKhususL6) + " +
                        "(( isnull((   select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@SelisihTotalPotongL6) else 0 end b, " +
                        " case when @TotalPotongL6>0 then isnull((select totdefectK from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) else 0 end c, " +
                        " case when @TotalPotongL6>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@Ttotalkw1kw2L6)  else 0 end d, " +
                        " case when @TotalPotongL6>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@NCSortirL6)  else 0 end e, " +
                        " case when @TotalPotongL6>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@ReturL6)  else 0 end f, " +
                        " case when @TotalPotongL6>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@DefectFinL6)  else 0 end g, " +
                        " case when @TotalPotongL6>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@DefKhususL6) else 0 end  h " +
                        "  from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 6') )A " +
                        "union all  " +
                        "select 'Total' [Group],sum(b)b,sum(c)c,sum(d)d,sum(e)e,sum(f)f,sum(g)g,sum(h)h,sum(c)-sum(d)+sum(e)+sum(f)+sum(g)+sum(h) i " +
                        ",cast((sum(c)-sum(d)+sum(e)+sum(f)+sum(g)+sum(h))/sum(b)*100 as decimal(18,1)) j from( " +
                        "select [Group],isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) +  " +
                        " ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@TotDefKhususL6)+ " +
                        "(( isnull((   select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@SelisihTotalPotongL6) b, " +
                        " isnull((select totdefectK from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)c, " +
                        " ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@Ttotalkw1kw2L6) d, " +
                        " ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@NCSortirL6) e, " +
                        " ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@ReturL6) f, " +
                        " ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@DefectFinL6) g, " +
                        " ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@DefKhususL6) h, " +
                        " 0 i,0 j from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 6'))A )B " +
                        " end " +
                        " else " +
                        " begin " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 h,0 i, 0 j into tempdefectL6 " +
                        " end " +
                        " " +
                        " end " +
                        " else " +
                        " begin " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 h,0 i, 0 j into tempdefectL1 " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 h,0 i, 0 j into tempdefectL2 " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 h,0 i, 0 j into tempdefectL3 " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 h,0 i, 0 j into tempdefectL4 " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 h,0 i, 0 j into tempdefectL5 " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 h,0 i, 0 j into tempdefectL6 " +
                        " end " +
                        " select * from tempdefectL1 order by [group] " +
                        "update SPD_Trans set actual=(select j from tempdefectL6 where [group]='total') where approval=0 and Tahun =" + ddTahun.SelectedValue + " and Bulan=" + ddlBulan.SelectedValue.ToString() + " and sarmutdeptid in ( " +
                        "select ID from SPD_Departemen where SarmutDepartemen='Line 6' and SarmutPID in (select ID from SPD_Perusahaan where SarMutPerusahaan ='Defect Board Mill')) ";
                    }
                    #endregion
                    else if (Convert.ToInt32(strtgl1.Substring(0, 6)) > 201910 && Convert.ToInt32(strtgl1.Substring(0, 6)) < 202009)
                    #region Periode Baru
                    {

                        if (Convert.ToInt32(strtgl1.Substring(0, 6)) > 201910 && Convert.ToInt32(strtgl1.Substring(0, 6)) < 202003 && users.UnitKerjaID.ToString() != "13")
                        {
                            query1 = " 0 h "; query2 = " 0 h, ";
                            query3 = " 0 h "; query4 = " 0 h, ";
                            query5 = " 0 h "; query6 = " 0 h, ";
                            query7 = " 0 h "; query8 = " 0 h, ";
                            query9 = " 0 h "; query10 = " 0 h, ";
                            query11 = " 0 h "; query12 = " 0 h, ";
                        }
                        else
                        {
                            query1 = " case when @TotalPotongL1>0 then isnull((select cast(A.M3 as decimal(10,4)) from tempBST1 A where [group]=BM_PlantGroup.[Group]),0) else 0 end  h  ";
                            query2 = " case when @TotalPotongL1>0 then isnull((select cast(A.M3 as decimal(10,4)) from tempBST1 A where [group]=BM_PlantGroup.[Group]),0) else 0 end  h, ";
                            query3 = " case when @TotalPotongL2>0 then isnull((select cast(A.M3 as decimal(10,4)) from tempBST1 A where [group]=BM_PlantGroup.[Group]),0) else 0 end  h  ";
                            query4 = " case when @TotalPotongL2>0 then isnull((select cast(A.M3 as decimal(10,4)) from tempBST1 A where [group]=BM_PlantGroup.[Group]),0) else 0 end  h, ";
                            query5 = " case when @TotalPotongL3>0 then isnull((select cast(A.M3 as decimal(10,4)) from tempBST1 A where [group]=BM_PlantGroup.[Group]),0) else 0 end  h  ";
                            query6 = " isnull((select cast(A.M3 as decimal(10,4)) from tempBST1 A where [group]=BM_PlantGroup.[Group]),0) h, ";
                            query7 = " isnull((select cast(A.M3 as decimal(10,4)) from tempBST1 A where [group]=BM_PlantGroup.[Group]),0) h ";
                            query8 = " isnull((select cast(A.M3 as decimal(10,4)) from tempBST1 A where [group]=BM_PlantGroup.[Group]),0) h, ";
                            query9 = " isnull((select cast(A.M3 as decimal(10,4)) from tempBST1 A where [group]=BM_PlantGroup.[Group]),0) h ";
                            query10 = " isnull((select cast(A.M3 as decimal(10,4)) from tempBST1 A where [group]=BM_PlantGroup.[Group]),0) h, ";
                            query11 = " isnull((select cast(A.M3 as decimal(10,4)) from tempBST1 A where [group]=BM_PlantGroup.[Group]),0) h ";
                            query12 = " isnull((select cast(A.M3 as decimal(10,4)) from tempBST1 A where [group]=BM_PlantGroup.[Group]),0) h, ";
                        }

                        strSQL =
                        #region Part1
 "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDM3]') AND type in (N'U')) DROP TABLE [dbo].tempDM3 " +
                            "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempD1M3]') AND type in (N'U')) DROP TABLE [dbo].tempD1M3 " +
                            "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempD2M3]') AND type in (N'U')) DROP TABLE [dbo].tempD2M3 " +
                            "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempD3M3]') AND type in (N'U')) DROP TABLE [dbo].tempD3M3 " +

                            "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectGPIso]') AND type in (N'U')) DROP TABLE [dbo].[tempdefectGPIso]  " +
                            "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectGPIsoTot]') AND type in (N'U')) DROP TABLE [dbo].tempdefectGPIsoTot  " +
                            "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectFin]') AND type in (N'U')) DROP TABLE [dbo].tempdefectFin " +
                            "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectL1]') AND type in (N'U')) DROP TABLE [dbo].tempdefectL1 " +
                            "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectL2]') AND type in (N'U')) DROP TABLE [dbo].tempdefectL2 " +
                            "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectL3]') AND type in (N'U')) DROP TABLE [dbo].tempdefectL3 " +
                            "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectL4]') AND type in (N'U')) DROP TABLE [dbo].tempdefectL4 " +
                            "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectL5]') AND type in (N'U')) DROP TABLE [dbo].tempdefectL5 " +
                            "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectL6]') AND type in (N'U')) DROP TABLE [dbo].tempdefectL6 " +
                            "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectListP]') AND type in (N'U')) DROP TABLE [dbo].tempdefectListP " +
                            "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectListPOK]') AND type in (N'U')) DROP TABLE [dbo].tempdefectListPOK " +
                            "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectListP2]') AND type in (N'U')) DROP TABLE [dbo].tempdefectListP2 " +
                            "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTotalGroup]') AND type in (N'U')) DROP TABLE [dbo].tempTotalGroup " +
                            "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTotalSerahDfctM3]') AND type in (N'U')) DROP TABLE [dbo].tempTotalSerahDfctM3 " +
                            "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTotalSerahLP]') AND type in (N'U')) DROP TABLE [dbo].tempTotalSerahLP " +
                            "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectListP3]') AND type in (N'U')) DROP TABLE [dbo].tempdefectListP3 " +
                            "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTotalBPM3]') AND type in (N'U')) DROP TABLE [dbo].tempTotalBPM3 " +
                            "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempUkuranKhusus]') AND type in (N'U')) DROP TABLE [dbo].tempUkuranKhusus " +
                            "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempBST1]') AND type in (N'U')) DROP TABLE [dbo].tempBST1 " +
                            "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTotalSerahM3]') AND type in (N'U')) DROP TABLE [dbo].tempTotalSerahM3 " +

                            "declare @thnbln1 varchar(8) " +
                            "declare @thnbln2 varchar(8) " +
                            "declare @TotalLine int " +
                            "declare @TotalGroup int " +
                            "declare @SerahPerGroup decimal(18,2) " +
                            "declare @bagi2 decimal(10,3) " +
                            "declare @TotalGroup1 decimal(18,2) " +
                            "declare @TotalGroup2 decimal(18,2) " +
                            "declare @Pembagi1 decimal(18,2) " +
                            "declare @M32 decimal(18,2) " +
                            "declare @M3 decimal(18,2) " +

                            "set @thnbln1='" + strtgl1 + "' " +
                            "set @thnbln2='" + strtgl2 + "' " +

                            /** Temp Table tempdefectGPIso **/
                            "select *  into tempdefectGPIso from (  " +
                            "select case when D.DeptID=0 then  " +
                            "case when GJ.GroupJemurName In ('M','N','O','P','Q','R','S','T','U','V','W','X') then   " +
                            "case when D.DefName='retak' then 2 " +
                            "when D.DefName='gompal' then 3  " +
                            "else D.DeptID end   " +
                            "else    " +
                            "case when (B.Qty/E.Qty) *100 >5 then 2 else 3 end   " +
                            "end  " +
                            "else D.DeptID end deptID1,A.CreatedTime as tglInput,A.Tgl as TglPeriksa,E.TglProduksi as TglProd,  D.DefCode,BP.PlantName as Line, PG.[Group],BF.FormulaCode as Jenis,   " +
                            "D.DefName,D.DeptID,B.ID,B.DefectID,B.MasterID,B.Qty,A.ID  DestID,isnull(A.TPotong,0)  QtyIn,B.Qty*I.Volume as Kubik,isnull(A.TPotong,0) as TotPotong,'' sfrom  " +
                            "from Def_DefectDetail B inner join Def_Defect A on A.Id=B.DefectID   " +
                            "left join Def_MasterDefect D on B.MasterID=D.ID left join BM_Destacking E on E.ID=A.DestID   " +
                            "left join BM_PlantGroup PG on A.GroupProdID=PG.ID left join BM_Formula BF on BF.ID=E.FormulaID    " +
                            "left join BM_Plant BP on BP.ID=E.PlantID left join FC_Items I on I.ID=E.ItemID inner join Def_GroupJemur GJ on GJ.ID=A.GroupJemurID  " +
                            "where B.RowStatus>-1  and D.RowStatus >-1) as Def    " +
                            "where DeptID1=2 and CONVERT(varchar,TglPeriksa,112)>=@thnbln1 and CONVERT(varchar,TglPeriksa,112)<=@thnbln2  " +
                            /** end Temp Table tempdefectGPIso **/
                            " " +

                            /** Temp Table tempdefectListP **/
                            "/** tempdefectListP **/ " +
                            "/** Turunan Bevel **/ " +
                            "select PlantName,[Group],sum(Qty)Qty,sum(M3)M3 into tempdefectListP " +
                            "from ( select PlantName,[group],Qty,M3  from (select PlantName,[Group],sum(Qty)Qty,sum(M3)M3 " +
                            "from (select Data3.PlantName,Data3.[Group],Data3.Qty,Data3.M3 from (select C1.PlantName,B1.[Group],Data2.Qty,M3 " +
                            "from (select B.PlantID,B.PlantGroupID,Data1.*,((C.Tebal*C.Lebar*C.Panjang)/1000000000)* Data1.Qty M3 from (select  tanggal,itemid,PartNo,Qty,DestID " +
                            "from vw_KartuStockListplankR1 " +
                            "where itemid in (select ID from FC_Items where PartNo like'%-P-%')  and CONVERT(varchar,tanggal,112)>=@thnbln1 " +
                            "and CONVERT(varchar,tanggal,112)<=@thnbln2 and qty>0 and process='i99' and ID in (select IDrec from vw_KartuStockListplank " +
                            "where process='Bevel' and qty<0 and Stat='BvToR1')) as Data1 " +
                            "INNER JOIN BM_Destacking B ON Data1.DestID=B.ID " +
                            "INNER JOIN FC_Items C ON C.ID=Data1.itemid ) as Data2 " +
                            "INNER JOIN BM_PlantGroup B1 ON Data2.PlantGroupID=B1.ID " +
                            "INNER JOIN BM_Plant C1 ON C1.ID=Data2.PlantID ) as Data3  ) as Data4 group by PlantName,[group] ) as Data5 " +
                            "union all " +
                            "/** BP dari Strapping **/  " +
                            "select PlantName,[group],Qty,M3 from (select PlantName,[group],sum(qty)Qty,sum(M3)M3 " +
                            "from (select A6.PlantName,A5.[group],A4.Qty,((A7.Tebal*A7.Lebar*A7.Panjang)/1000000000)*A4.Qty  M3 " +
                            "from (select A3.PlantID,A3.PlantGroupID,A2.Tanggal,A2.Qty,A2.ItemID from (select (select A1.PartNo " +
                            "from FC_Items A1 where A1.ID=A.ItemID)Partno,A.DestID,A.TglTrans Tanggal,A.QtyIn Qty,B.ItemID " +
                            "from T3_Rekap A INNER JOIN T1_Straping B ON A.DestID=B.DestID and A.T1SerahID=B.ID where CONVERT(varchar,A.TglTrans,112)>=@thnbln1 " +
                            "and CONVERT(varchar,A.TglTrans,112)<=@thnbln2 and A.sfrom='straping' and A.RowStatus>-1 and A.ItemID in (select ID " +
                            "from FC_Items where partno like'%-P-%') ) as A2 " +
                            "INNER JOIN BM_Destacking A3 ON A2.DestID=A3.ID ) as A4 " +
                            "INNER JOIN BM_PlantGroup A5 ON A4.PlantGroupID=A5.ID " +
                            "INNER JOIN BM_Plant A6 ON A6.ID=A4.PlantID INNER JOIN FC_Items A7 ON A7.ID=A4.ItemID ) as A8 " +
                            "group by PlantName,[Group] ) as A9 ) as Final group by PlantName,[Group] " +
                            "/** end tempdefectListP **/ " +
                            /** end Temp Table tempdefectListP **/

                            /** Temp Table tempdefectListP2 **/
                            "/** Temp Table : tempdefectListP2 **/ " +
                            "select PlantName,[group],Qty,(Qty*M3)M3 into tempdefectListP2 from ( " +
                            "select PlantName,[group],Qty,(Qty*M3)M3 from (select PlantName,[group],sum(qty)Qty,sum(M3)M3 from ( " +
                            "select A6.PlantName,A5.[group],A4.Qty,((A7.Tebal*A7.Lebar*A7.Panjang)/1000000000)M3 from ( " +
                            "select A3.PlantID,A3.PlantGroupID,A2.Tanggal,A2.Qty,A2.ItemID from ( " +
                            "select (select A1.PartNo from FC_Items A1 where A1.ID=A.ItemID)Partno,A.DestID,A.TglTrans Tanggal,A.QtyIn Qty,A.ItemID " +
                            "from T3_Rekap A " +
                            "INNER JOIN T1_Straping B ON A.DestID=B.DestID and A.T1SerahID=B.ID where CONVERT(varchar,A.TglTrans,112)>=@thnbln1 " +
                            "and CONVERT(varchar,A.TglTrans,112)<=@thnbln2 and A.sfrom='straping' and A.RowStatus>-1 and A.ItemID in " +
                            "(select ID from FC_Items where partno like'%-P-%') ) as A2 INNER JOIN BM_Destacking A3 ON A2.DestID=A3.ID ) as A4 " +
                            "INNER JOIN BM_PlantGroup A5 ON A4.PlantGroupID=A5.ID INNER JOIN BM_Plant A6 ON A6.ID=A4.PlantID " +
                            "INNER JOIN FC_Items A7 ON A7.ID=A4.ItemID ) as A8 group by PlantName,[Group] ) as A9 ) as xx " +
                            /** end Temp Table tempdefectListP2 **/

                            /** Temp Table tempdefectListPOK **/
                            "/** tempdefectListPOK **/ " +
                            "/** OK KW dari Strapping **/ " +
                            "select PlantName,[group],Qty,(Qty*M3)M3 into tempdefectListPOK from (select PlantName,[group],sum(qty)Qty,sum(M3)M3 " +
                            "from (select A6.PlantName,A5.[group],A4.Qty,((A7.Tebal*A7.Lebar*A7.Panjang)/1000000000)M3 " +
                            "from (select A3.PlantID,A3.PlantGroupID,A2.Tanggal,A2.Qty,A2.ItemID  from (select (select A1.PartNo " +
                            "from FC_Items A1 where A1.ID=A.ItemID)Partno,A.DestID,A.TglTrans Tanggal,A.QtyIn Qty,A.ItemID from T3_Rekap A " +
                            "INNER JOIN T1_Straping B ON A.DestID=B.DestID and A.T1SerahID=B.ID where CONVERT(varchar,A.TglTrans,112)>=@thnbln1 " +
                            "and CONVERT(varchar,A.TglTrans,112)<=@thnbln2 and A.sfrom='straping' and A.RowStatus>-1 and A.ItemID in (select ID " +
                            "from FC_Items where partno like'%-3-%' or partno like'%-M-%') ) as A2 INNER JOIN BM_Destacking A3 ON A2.DestID=A3.ID ) as A4 " +
                            "INNER JOIN BM_PlantGroup A5 ON A4.PlantGroupID=A5.ID INNER JOIN BM_Plant A6 ON A6.ID=A4.PlantID " +
                            "INNER JOIN FC_Items A7 ON A7.ID=A4.ItemID ) as A8 group by PlantName,[Group] ) as A9 " +
                            "/** end tempdefectListPOK **/ " +
                            /** end Temp Table tempdefectListPOK **/

                            /** Hitung Jumlah Group Produksi  **/
                            "set @TotalGroup = " +
                            "(select count(TotalGroup)Total from (select [group] TotalGroup from (select xx.*,A.PlantGroupID,A.PlantID from ( " +
                            "select qty,destid from vw_KartustockWIP where CONVERT(varchar,tanggal,112)>=@thnbln1 and CONVERT(varchar,tanggal,112)<=@thnbln2 " +
                            "and Lokasi in ('B99','H99') and qty<0 " +
                            "union all " +
                            "select cast(qty as decimal(10,2)) Qty,DestID from vw_KartustockWIP2 where CONVERT(varchar,tanggal,112)>=@thnbln1 and " +
                            "CONVERT(varchar,tanggal,112)<=@thnbln2 and qty<0 AND ItemID IN (SELECT ID from FC_Items where partno like'%-3-%' or " +
                            "PartNo like'%-M-%' or PartNo like'%-P-%')) as xx left join BM_Destacking A ON A.ID=xx.destid ) as xx1 " +
                            "left join BM_PlantGroup B ON B.ID=xx1.PlantGroupID left join BM_Plant C ON C.ID=xx1.PlantID  group by [group] ) as Data1) " +

                            /** Hitung Jumlah Line Produksi  **/
                            "set @TotalLine = " +
                            "(select count(PlantName)TotalLine from(select distinct C.PlantName  from (select xx.*,A.PlantGroupID,A.PlantID from ( " +
                            "select qty,destid from vw_KartustockWIP where CONVERT(varchar,tanggal,112)>=@thnbln1 and CONVERT(varchar,tanggal,112)<=@thnbln2 " +
                            "and Lokasi in ('B99','H99') and qty<0 " +
                            "union all " +
                            "select cast(qty as decimal(10,2)) Qty,DestID from vw_KartustockWIP2 where CONVERT(varchar,tanggal,112)>=@thnbln1 " +
                            "and CONVERT(varchar,tanggal,112)<=@thnbln2 and qty<0 AND ItemID IN (SELECT ID from FC_Items where partno like'%-3-%' or " +
                            "PartNo like'%-M-%' or PartNo like'%-P-%')) as xx left join BM_Destacking A ON A.ID=xx.destid ) as xx1 " +
                            "left join BM_PlantGroup B ON B.ID=xx1.PlantGroupID left join BM_Plant C ON C.ID=xx1.PlantID ) as DataXX ) " +

                            "set @TotalGroup1 = " +
                            "(select count([group])Total from ( " +
                            "select distinct([Group]) from ( " +
                            "select sum(xx.Qty)Qty,sum(M3)M3,PlantName,[group] from (select sum(QtyIn)Qty,sum((((B.Tebal*B.Lebar*B.Panjang)/1000000000)*A.QtyIn))M3," +
                            "DestID from t3_rekap A inner join FC_Items B ON B.ID=A.ItemID where CONVERT(varchar,A.TglTrans,112)>=@thnbln1 " +
                            "and CONVERT(varchar,A.TglTrans,112)<=@thnbln2 and Sfrom='straping' and ItemID in (select ID from FC_Items where partno like'%-P-%') and A.RowStatus>-1 " +
                            "group by B.Tebal,B.Lebar,B.Panjang,A.DestID ) as xx inner join BM_Destacking A ON A.ID=xx.DestID " +
                            "inner join BM_PlantGroup B ON B.ID=A.PlantGroupID inner join BM_Plant C ON C.ID=A.PlantID group by PlantName,[group] " +
                            "union all " +
                            "select sum(xx.Qty)Qty,sum(M3)M3,PlantName,[group] from (select sum(A.QtyIn)Qty,sum((((C.Tebal*C.Lebar*C.Panjang)/1000000000)*A.QtyIn))" +
                            "M3,A.DestID from T1_LR1_Listplank A inner join T1_Bevel B ON A.L1ID=B.ID inner join FC_Items C ON C.ID=B.ItemID " +
                            "where CONVERT(varchar,A.TglTrans,112)>=@thnbln1 and CONVERT(varchar,A.TglTrans,112)<=@thnbln2 and Status>-1 and A.L1ID in (select ID from T1_Bevel " +
                            "where RowStatus>-1) " +
                            "group by A.DestID ) as xx inner join BM_Destacking A ON A.ID=xx.DestID inner join BM_PlantGroup B ON B.ID=A.PlantGroupID " +
                            "inner join BM_Plant C ON C.ID=A.PlantID group by PlantName,[group] ) as Data1 ) as cc )" +

                            "set @Pembagi1 = " +
                            "(select sum((((B.Tebal*B.Lebar*B.Panjang)/1000000000)*xx.Qty)) / @TotalGroup1 M3 " +
                            "from (select sum(QtyIn) Qty,SerahID from T3_Simetris where ID in (select CutID from vw_KartuStockBJNew " +
                            "where CONVERT(varchar,tanggal,112)>=@thnbln1 and CONVERT(varchar,tanggal,112)<=@thnbln2 and ItemID IN (SELECT ID from FC_Items where partno like'%-P-%') and " +
                            "Process like'%simetris%' and Keterangan like'%-1-%' and CutID in (select ID from T3_Simetris where QtyIn<QtyOut and RowStatus>-1)) " +
                            "and RowStatus>-1 group by SerahID ) as xx inner join T3_Serah A ON A.ID=xx.SerahID inner join FC_Items B ON B.ID=A.ItemID) " +


                            "set @M32 = " +
                            "(select sum(M3)/@TotalGroup M3 from ( " +
                            "select sum((((A2.Tebal*A2.Lebar*A2.Panjang)/1000000000)*xx.Qty)) M3 from (select sum(Qty)qty,SerahID from vw_KartuStockBJNew  " +
                            "where CONVERT(varchar,tanggal,112)>=@thnbln1 and CONVERT(varchar,tanggal,112)<=@thnbln2 and ItemID IN (SELECT ID from FC_Items where  PartNo like'%-P-%') and " +
                            "Process like'%simetris%' and Keterangan like'%-1-%' and CutID in (select ID from T3_Simetris where QtyIn=QtyOut and RowStatus>-1) " +
                            "group by SerahID ) as xx inner join T3_Serah A1 ON A1.ID=xx.SerahID inner join FC_Items A2 ON A2.ID=A1.ItemID " +
                            "union all " +
                            "select round(sum((((A2.Tebal*A2.Lebar*A2.Panjang)/1000000000)*xx.Qty)),1)M3 from (select sum(QtyIn)Qty,SerahID from T3_Simetris " +
                            "where ID in (select CutID from vw_KartuStockBJNew where CONVERT(varchar,tanggal,112)>=@thnbln1 and CONVERT(varchar,tanggal,112)<=@thnbln2 and ItemID IN " +
                            "(SELECT ID from FC_Items where partno like'%-P-%') and Process like'%simetris%' and Keterangan like'%-1-%' and CutID in " +
                            "(select ID from T3_Simetris where QtyIn<QtyOut and RowStatus>-1)) and RowStatus>-1 group by SerahID ) as xx " +
                            "inner join t3_Serah A1 ON A1.ID=xx.SerahID inner join FC_Items A2 ON A2.ID=A1.ItemID ) as xx )" +

                            "set @M3 = " +
                            "(select sum(M3)/@TotalGroup M3 from ( " +
                            "select cast(sum(xx.Qty) as decimal(10,2)) Qty,sum((((A2.Tebal*A2.Lebar*A2.Panjang)/1000000000)*xx.Qty)) M3 " +
                            "from (select sum(Qty)qty,SerahID from vw_KartuStockBJNew  where CONVERT(varchar,tanggal,112)>=@thnbln1 and " +
                            "CONVERT(varchar,tanggal,112)<=@thnbln2 and ItemID IN (SELECT ID from FC_Items where partno like'%-3-%' or PartNo like'%-M-%' or " +
                            "PartNo like'%-P-%') and Process like'%simetris%' and Keterangan like'%-1-%' and CutID in (select ID from T3_Simetris " +
                            "where QtyIn=QtyOut and RowStatus>-1) group by SerahID ) as xx inner join T3_Serah A1 ON A1.ID=xx.SerahID " +
                            "inner join FC_Items A2 ON A2.ID=A1.ItemID  " +
                            "union all " +
                            "select sum(qty)Qty,sum(m3)M3 from ( " +
                            "select x.Qty,(((A2.Tebal*A2.Lebar*A2.Panjang)/1000000000)*x.Qty)M3 from ( " +
                            "select sum(QtyIn)Qty,serahID from T3_Simetris where ID in (select CutID from vw_KartuStockBJNew " +
                            "where CONVERT(varchar,tanggal,112)>=@thnbln1 and CONVERT(varchar,tanggal,112)<=@thnbln2 and ItemID IN (SELECT ID from FC_Items where partno like'%-3-%' or " +
                            "partno like'%-M-%' or partno like'%-P-%') and Process like'%simetris%' and Keterangan like'%-1-%' and CutID in " +
                            "(select ID from T3_Simetris where QtyIn<QtyOut and RowStatus>-1)) and RowStatus>-1 group by serahiD ) as x " +
                            "inner join t3_serah A1 ON A1.ID=x.SerahID inner join FC_Items A2 ON A2.ID=A1.ItemID ) as AA ) as BB) " +

                             "set @TotalGroup2 = " +
                            "(select count([group])Total from (select sum(Qty)Qty,sum(M3)M3,[group],PlantName " +
                            "from (select QtyIn Qty,M3,B1.[Group],B2.PlantName from (select x1.*,(((A2.Tebal*A2.Lebar*A2.Panjang)/1000000000)*x1.QtyIn)M3 " +
                            "from (select *,case when sfrom='straping' then (select A.ItemID0 from T1_Straping A where A.ID=T1SerahID) " +
                            "when sfrom='Bevel' then (select A1.ItemID0 from T1_Bevel A1 where A1.ID=T1SerahID) end ItemID0 " +
                            "from (select Sfrom,QtyIn,DestID,T1SerahID from T3_Rekap where Keterangan like'%-1-%' and ItemID in (select ID from FC_Items " +
                            "where partno like'%-S-%') and CONVERT(varchar,TglTrans,112)>=@thnbln1 and CONVERT(varchar,TglTrans,112)<=@thnbln2 and Process='direct' and (sfrom='straping' or " +
                            "Sfrom='Bevel')) as x ) as x1 inner join FC_Items A2 ON A2.ID=x1.ItemID0 ) as x2 inner join BM_Destacking B ON B.ID=x2.DestID " +
                            "inner join BM_PlantGroup B1 ON B1.ID=B.PlantGroupID inner join BM_Plant B2 ON B2.ID=B.PlantID ) as x3 " +
                            "group by [Group],PlantName ) as data1 ) " +

                            /** BSAuto T1 **/
                            " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempitembsauto2]') AND type in (N'U')) " +
                            " DROP TABLE [dbo].[tempitembsauto2]  " +

                            " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempKartuStockBJNew2]') AND type in (N'U')) " +
                            " DROP TABLE [dbo].[tempKartuStockBJNew2]  " +

                            " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempitembs]') AND type in (N'U')) " +
                            " DROP TABLE [dbo].[tempitembs] " +



                            " select distinct itemid into tempitembsauto2 from vw_KartuStockBJNew " +
                            " where itemid in (select ID from fc_items where partno like '%-s-%') and LokID in (select ID from FC_Lokasi where Lokasi='bsauto') " +

                            " select * into tempitembs from vw_KartuStockBJNew " +
                            " where left(CONVERT(char, tanggal ,112),8)>=@thnbln1 and left(CONVERT(char, tanggal ,112),8)<=@thnbln2 and itemID " +
                            " not in  (select itemid from tempitembsauto2) " +

                            " select * into tempKartuStockBJNew2 from vw_KartuStockBJNew " +
                            " where left(CONVERT(char, tanggal ,112),8)>=@thnbln1 and left(CONVERT(char, tanggal ,112),8)<=@thnbln2 and itemID in " +
                            " (select itemid from tempitembsauto2) " +

                            "set @bagi2= " +
                            " (select (round(sum(M3),2)/@TotalGroup) M3 from ( " +
                            " select (sum(M3)) M3 from ( " +
                            " select ((A.Tebal*A.Lebar*A.Panjang)/1000000000)*x.Qty M3 from ( " +
                            " select isnull(SUM(Qty),0)Qty,ItemID from tempKartuStockBJNew2 " +
                            " where (process='direct' or process='Simetris' ) and substring(Keterangan,1,21) like '%-1-%' /** and " +
                            " lokid in (select ID from FC_Lokasi where Lokasi='BSAUTO') **/ group by ItemID ) as x " +
                            " inner join FC_Items A ON A.ID=x.ItemID ) as x1 " +

                            " union all " +

                            " select (round(sum(M3),3)) M3 from ( " +
                            " select ((A.Tebal*A.Lebar*A.Panjang)/1000000000)*x.Qty M3 from ( " +
                            " select isnull(SUM(Qty),0)Qty,ItemID from tempitembs " +
                            " where (process='direct' or process='Simetris') and (isnull(sfrom,'-')='-' or isnull(sfrom,'bevel')='-' " +
                            " or isnull(sfrom,'-')='straping') and  lokid not in (select ID from FC_Lokasi where Lokasi='BSAUTO') and " +
                            " substring(Keterangan,1,21) like '%-1-%' group by ItemID ) as x inner join FC_Items A ON A.ID=x.ItemID " +
                            " where A.PartNo like'%-S-%') as A ) as A1) " +



                            //" (select sum(round(Qty*Volume,2)/@TotalGroup)  M3 from (select (A1.Tebal*A1.Lebar*A1.Panjang)/1000000000 Volume,Qty  from ( " +
                            //" select sum(qty)qty,ItemID from vw_KartuStockBJNew where  (process='direct' or process='Simetris') and (isnull(sfrom,'-')='-' "+
                            //" or isnull(sfrom,'bevel')='-' or  isnull(sfrom,'-')='straping') and /** lokid not in (select ID from FC_Lokasi where Lokasi='BSAUTO') "+
                            //" and **/ substring(Keterangan,1,21) like '%-1-%' and ItemID in (select ID from FC_Items where PartNo like'%-S-%') and "+
                            //" CONVERT(varchar,Tanggal,112)>=@thnbln1 and CONVERT(varchar,Tanggal,112)<=@thnbln2  group by ItemID " +
                            //" ) as x inner join FC_Items A1 ON A1.ID=x.ItemID ) as x ) "+


                            /** temp Table tempUkuranKhusus **/
                            "select  sum(M3) + @Pembagi1 M3,PlantName,[group] into tempUkuranKhusus from ( " +
                            "select sum(xx.Qty)Qty,sum(M3)M3,PlantName,[group] from (select sum(QtyIn)Qty,sum((((B.Tebal*B.Lebar*B.Panjang)/1000000000)*A.QtyIn))" +
                            "M3,DestID from t3_rekap A inner join FC_Items B ON B.ID=A.ItemID where CONVERT(varchar,A.TglTrans,112)>=@thnbln1 and CONVERT(varchar,A.TglTrans,112)<=@thnbln2 and " +
                            "Sfrom='straping' and ItemID in (select ID from FC_Items where partno like'%-P-%') and A.RowStatus>-1 " +
                            "group by B.Tebal,B.Lebar,B.Panjang,A.DestID ) as xx inner join BM_Destacking A ON A.ID=xx.DestID " +
                            "inner join BM_PlantGroup B ON B.ID=A.PlantGroupID inner join BM_Plant C ON C.ID=A.PlantID group by PlantName,[group] " +
                            "union all " +
                            "select sum(xx.Qty)Qty,sum(M3)M3,PlantName,[group] from (select sum(A.QtyIn)Qty,sum((((C.Tebal*C.Lebar*C.Panjang)/1000000000)*A.QtyIn)) " +
                            "M3,A.DestID from T1_LR1_Listplank A inner join T1_Bevel B ON A.L1ID=B.ID inner join FC_Items C ON C.ID=B.ItemID " +
                            "where CONVERT(varchar,A.TglTrans,112)>=@thnbln1 and CONVERT(varchar,A.TglTrans,112)<=@thnbln2 and Status>-1 and A.L1ID in (select ID from T1_Bevel where RowStatus>-1) " +
                            "group by A.DestID ) as xx inner join BM_Destacking A ON A.ID=xx.DestID inner join BM_PlantGroup B ON B.ID=A.PlantGroupID " +
                            "inner join BM_Plant C ON C.ID=A.PlantID group by PlantName,[group] " +
                            ") as xxx group by PlantName,[group] " +
                            /** end temp Table tempUkuranKhusus **/

                            /** temp Table tempTotalBPM3 **/
                            //"select sum(M3) + @M32 M3,PlantName,[group] into tempTotalBPM3 from ( " +
                            //"select sum(m3)m3,PlantName,[group]  from ( " +
                            //"select sum(M3)M3,PlantName,[group] from (select sum(qty*-1)qty,sum((((B.Tebal*B.Lebar*B.Panjang)/1000000000)*A.qty * -1))M3,destid " +
                            //"from vw_KartustockWIP A inner join FC_Items B ON A.itemid0=B.ID where CONVERT(varchar,Tanggal,112)>=@thnbln1 and CONVERT(varchar,Tanggal,112)<=@thnbln2 and Lokasi='B99' " +
                            //"and qty<0  group by destid ) as xx inner join BM_Destacking A1 ON A1.ID=xx.DestID inner join BM_PlantGroup A2 " +
                            //"ON A2.ID=A1.PlantGroupID inner join BM_Plant A3 ON A3.ID=A1.PlantID  group  by PlantName,[group] " +
                            //"union all " +
                            //"select sum(M3)M3,PlantName,[group] from (select sum(qty *-1)qty,sum((((B.Tebal*B.Lebar*B.Panjang)/1000000000)*A.qty * -1))M3,DestID " +
                            //"from vw_KartustockWIP2 A inner join FC_Items B ON A.itemid0=B.ID where CONVERT(varchar,Tanggal,112)>=@thnbln1 and CONVERT(varchar,Tanggal,112)<=@thnbln2 and qty<0 " +
                            //"AND ItemID IN (SELECT ID from FC_Items where partno like'%-P-%' ) group by DestID) as xx inner join BM_Destacking A1 " +
                            //"ON A1.ID=xx.DestID inner join BM_PlantGroup A2 ON A2.ID=A1.PlantGroupID inner join BM_Plant A3 ON A3.ID=A1.PlantID " +
                            //"group  by PlantName,[group]) as xx1 group  by PlantName,[group] " +
                            //"union all " +
                            //"select  round(sum(M3),1)M3,PlantName,[group] from ( " +
                            //"select sum(M3)M3,A3.PlantName,A2.[Group] from (select sum(QtyIn)Qty,sum((((B.Tebal*B.Lebar*B.Panjang)/1000000000)*A.QtyIn))M3,DestID " +
                            //"from t3_rekap A inner join FC_Items B ON B.ID=A.ItemID where CONVERT(varchar,TglTrans,112)>=@thnbln1 and CONVERT(varchar,TglTrans,112)<=@thnbln2 and Sfrom='straping' " +
                            //"and ItemID in (select ID from FC_Items where partno like'%-P-%') and A.RowStatus>-1 group by B.Tebal,B.Lebar,B.Panjang,A.DestID ) " +
                            //"as xx inner join BM_Destacking A1 ON A1.ID=xx.DestID inner join BM_PlantGroup A2 ON A2.ID=A1.PlantGroupID inner join BM_Plant A3 " +
                            //"ON A3.ID=A1.PlantID group by PlantName,[group] " +
                            //"union all " +
                            //"select sum(M3)M3,A3.PlantName,A2.[Group] from (select sum(A.QtyIn)Qty,sum((((C.Tebal*C.Lebar*C.Panjang)/1000000000)*A.QtyIn))M3," +
                            //"A.DestID from T1_LR1_Listplank A inner join T1_Bevel B ON A.L1ID=B.ID inner join FC_Items C ON C.ID=B.ItemID " +
                            //"where CONVERT(varchar,A.TglTrans,112)>=@thnbln1 and CONVERT(varchar,A.TglTrans,112)<=@thnbln2 and Status>-1 and A.L1ID in (select ID from T1_Bevel where RowStatus>-1) " +
                            //"group by A.DestID ) as xx inner join BM_Destacking A1 ON A1.ID=xx.DestID inner join BM_PlantGroup A2 ON A2.ID=A1.PlantGroupID " +
                            //"inner join BM_Plant A3 ON A3.ID=A1.PlantID group by PlantName,[group] " +
                            //") as xxx group  by PlantName,[group] " +
                            //") as xx2 group  by PlantName,[group] " +
                            /** end temp Table tempTotalBPM3 **/


                            /** temp Table tempBST1 **/
                            "select [group],PlantName,sum(M3)M3 into tempBST1 from  (select groupP [group],case when GroupP in ('KA','KB','KC','KD') " +
                            "then 'LINE 1' when GroupP in ('KE','KF','KG','KH') then 'LINE 2' when GroupP in ('KI','KJ','KK','KL') then 'LINE 3' " +
                            "when GroupP in ('KM','KN','KO','KP') then 'LINE 4' when GroupP in ('KQ','KR','KS','KT') then 'LINE 5' " +
                            "when GroupP in ('KU','KV','KW','KX') then 'LINE 6' end PlantName,'0' + cast(@bagi2 as decimal(10,3)) M3  " +
                            "from (select GroupP from (select [group] GroupP from (select xx.*,A.PlantGroupID,A.PlantID " +
                            "from ( select qty,destid from vw_KartustockWIP " +
                            "where CONVERT(varchar,Tanggal,112)>=@thnbln1 and CONVERT(varchar,Tanggal,112)<=@thnbln2 " +
                            "and Lokasi in ('B99','H99') and qty<0 union all select cast(qty as decimal(10,2)) Qty,DestID " +
                            "from vw_KartustockWIP2 " +
                            "where CONVERT(varchar,Tanggal,112)>=@thnbln1 and CONVERT(varchar,Tanggal,112)<=@thnbln2 and qty<0 AND ItemID IN " +
                            "(SELECT ID from FC_Items where partno like'%-3-%' or PartNo like'%-M-%' or PartNo like'%-P-%')) as xx " +
                            "left join BM_Destacking A ON A.ID=xx.destid where A.PlantGroupID>0 and A.PlantID>0) as xx1 " +
                            "left join BM_PlantGroup B ON B.ID=xx1.PlantGroupID left join BM_Plant C ON C.ID=xx1.PlantID  group by [group] ) as Data1) as p  " +
                            "union all " +
                            /** BS dari Listplank pertama **/
                            "select [group],PlantName,(sum(M3)) M3 from (select QtyIn Qty,M3,B1.[Group],B2.PlantName " +
                            "from (select x1.*,(((A2.Tebal*A2.Lebar*A2.Panjang)/1000000000)*x1.QtyIn)M3 from (select *,case when sfrom='straping' " +
                            "then (select A.ItemID0 from T1_Straping A where A.ID=T1SerahID) when sfrom='Bevel' then (select A1.ItemID0 from T1_Bevel A1 " +
                            "where A1.ID=T1SerahID) end ItemID0 from (select Sfrom,QtyIn,DestID,T1SerahID from T3_Rekap where Keterangan like'%-1-%' " +
                            "and ItemID in (select ID from FC_Items where partno like'%-S-%') and CONVERT(varchar,TglTrans,112)>=@thnbln1 and " +
                            "CONVERT(varchar,TglTrans,112)<=@thnbln2 and Process='direct' and (sfrom='straping' or Sfrom='Bevel')) as x ) as x1 inner join FC_Items A2 ON A2.ID=x1.ItemID0 ) as x2 " +
                            "inner join BM_Destacking B ON B.ID=x2.DestID inner join BM_PlantGroup B1 ON B1.ID=B.PlantGroupID " +
                            "inner join BM_Plant B2 ON B2.ID=B.PlantID ) as x3 group by [Group],PlantName) as Dt group by [group],PlantName " +
                            /** end Data BS Tahap I **/

                            /** temp Table tempTotalSerahDfctM3 **/
                            "select sum(M3)M3,PlantName,[group] into tempTotalSerahDfctM3 from ( " +
                            "select sum(M3)M3,PlantName,[group] from ( " +
                            "select sum(M3) + /**14.633890**/@M3 M3,PlantName,[group]   from ( " +
                            "select sum(M3*-1)M3,PlantName,[group]  from ( " +
                            "select sum((((B.Tebal*B.Lebar*B.Panjang)/1000000000)*A.qty)) M3,PlantName,[group] from vw_KartustockWIP A " +
                            "inner join FC_Items B ON A.itemid0=B.ID inner join BM_Destacking C ON C.ID=A.destid inner join BM_PlantGroup D ON D.ID=C.PlantGroupID " +
                            "inner join BM_Plant E ON E.ID=C.PlantID where CONVERT(varchar,tanggal,112)>=@thnbln1 and CONVERT(varchar,tanggal,112)<=@thnbln2 and " +
                            "Lokasi in ('H99','B99') and A.qty<0  group by PlantName,[group] " +
                            "union all " +
                            "select sum((((B.Tebal*B.Lebar*B.Panjang)/1000000000)*A.qty)) M3,PlantName,[group] from vw_KartustockWIP2 A " +
                            "inner join FC_Items B ON A.itemid0=B.ID inner join BM_Destacking C ON C.ID=A.destid inner join BM_PlantGroup D " +
                            "ON D.ID=C.PlantGroupID inner join BM_Plant E ON E.ID=C.PlantID where CONVERT(varchar,tanggal,112)>=@thnbln1 and " +
                            "CONVERT(varchar,tanggal,112)<=@thnbln2 and A.qty<0 AND A.ItemID IN (SELECT ID from FC_Items where partno like'%-3-%' or " +
                            "PartNo like'%-M-%' or PartNo like'%-P-%') group by PlantName,[group] " +
                            ") as x1 group by PlantName,[group] ) as x2 group by PlantName,[group] ) as cc group by PlantName,[group] " +
                            "union all " +
                            "select sum(M3)M3,PlantName,[group] from ( " +
                            "select M3,PlantName,[group] from (select sum(A.QtyIn)Qty,sum((((C.Tebal*C.Lebar*C.Panjang)/1000000000)*A.QtyIn))M3,A.DestID " +
                            "from T1_Straping A inner join T1_Bevel B ON A.L1ID=B.ID inner join FC_Items C ON C.ID=B.ItemID where A.RowStatus>-1 and " +
                            "CONVERT(varchar,A.TglTrans,112)>=@thnbln1 and CONVERT(varchar,A.TglTrans,112)<=@thnbln2 and A.L1ID in (select ID from T1_Bevel " +
                            "where RowStatus>-1) group by A.DestID) as A1 inner join BM_Destacking B1 ON B1.ID=A1.DestID inner join BM_PlantGroup C1 " +
                            "ON C1.ID=B1.PlantGroupID inner join BM_Plant D1 ON D1.ID=B1.PlantID " +
                            "union all " +
                            "select M3,PlantName,[group] from (select sum(Qty)Qty,sum((((B1.Tebal*B1.Lebar*B1.Panjang)/1000000000)*A1.Qty))M3,ItemID,DestID " +
                            "from (select sum(A.QtyIn)Qty,B.ItemID,A.DestID from T1_LR1_Listplank A inner join T1_Bevel B ON A.L1ID=B.ID where A.L1ID in " +
                            "(select ID from T1_Bevel where RowStatus>-1) and CONVERT(varchar,A.TglTrans,112)>=@thnbln1 and " +
                            "CONVERT(varchar,A.TglTrans,112)<=@thnbln2 and Status>-1 group by B.ItemID,A.DestID) as A1 inner join FC_Items B1 ON B1.ID=A1.ItemID " +
                            "group by A1.ItemID,A1.DestID ) as X1 inner join BM_Destacking X2 ON X2.ID=X1.DestID " +
                            "inner join BM_PlantGroup X3 ON X3.ID=X2.PlantGroupID inner join BM_Plant X4 ON X4.ID=X2.PlantID ) as AAA " +
                            "group by PlantName,[group] ) as A2 group by PlantName,[group] " +
                            /** end temp Table tempTotalSerahDfctM3 **/

                            /** temp Table tempTotalSerahLP **/
                            "select sum(Qty)Qty,sum(M3)M3,PlantName,[Group] into tempTotalSerahLP from ( " +
                            "/** Bevel Out**/ " +
                             "select sum(Qty)Qty,sum(M3 * Qty)M3,PlantName,[Group] from (select x.*,B.[Group],C.PlantName,((D.Tebal*D.Lebar*D.Panjang)/1000000000)M3 " +
                             " from (select sum(QtyIn)Qty,DestID,ItemID from T1_Straping where CONVERT(varchar,TglTrans,112)>=@thnbln1 and " +
                             "CONVERT(varchar,TglTrans,112)<=@thnbln2 and RowStatus>-1 and L1ID in (select ID from T1_Bevel where RowStatus >-1) " +
                             "group by DestID,ItemID ) as x " +
                             "LEFT JOIN BM_Destacking A ON A.ID=x.DestID " +
                             "LEFT JOIN BM_PlantGroup B ON B.ID=A.PlantGroupID " +
                             "LEFT JOIN BM_Plant C ON C.ID=A.PlantID " +
                             "LEFT JOIN FC_Items D ON D.ID=x.ItemID) as x2 group by PlantName,[Group] " +
                             "union all " +
                             "select sum(Qty)Qty,sum(M3 * Qty)M3,PlantName,[Group] from (select x.*,B.[Group],C.PlantName,((D.Tebal*D.Lebar*D.Panjang)/1000000000)M3 " +
                             "from (select sum(QtyIn)Qty,DestID,ItemID from T1_LR1_Listplank where CONVERT(varchar,TglTrans,112)>=@thnbln1 and " +
                             "CONVERT(varchar,TglTrans,112)<=@thnbln2 and Status>-1 and L1ID in (select ID from T1_Bevel where RowStatus >-1) " +
                             "group by DestID,ItemID ) as x  " +
                             "LEFT JOIN BM_Destacking A ON A.ID=x.DestID " +
                             "LEFT JOIN BM_PlantGroup B ON B.ID=A.PlantGroupID  " +
                             "LEFT JOIN BM_Plant C ON C.ID=A.PlantID " +
                             "LEFT JOIN FC_Items D ON D.ID=x.ItemID) as x2 group by PlantName,[Group] " +
                             "union all " +
                             "/** BP dari Bevel **/ " +
                             " select sum(Qty * -1)Qty,sum(M3 * Qty)M3,PlantName,[Group] from (select x.*,B.[Group],C.PlantName,((D.Tebal*D.Lebar*D.Panjang)/1000000000)M3 " +
                             "from (select sum(QtyIn)Qty,DestID,ItemID from T1_LR1_Listplank where CONVERT(varchar,TglTrans,112)>=@thnbln1 and " +
                             "CONVERT(varchar,TglTrans,112)<=@thnbln2 and Status>-1 and L1ID in (select ID from T1_Bevel where RowStatus >-1) " +
                             "group by DestID,ItemID ) as x  " +
                             " LEFT JOIN BM_Destacking A ON A.ID=x.DestID " +
                             "LEFT JOIN BM_PlantGroup B ON B.ID=A.PlantGroupID " +
                             " LEFT JOIN BM_Plant C ON C.ID=A.PlantID " +
                             "LEFT JOIN FC_Items D ON D.ID=x.ItemID) as x2 group by PlantName,[Group] " +
                             "union all " +
                            "/** BP dari Straping **/ " +
                            "select sum(Qty * -1)Qty,sum(M3 * Qty)M3,PlantName,[Group] from tempdefectListP2 group by PlantName,[Group] " +
                             ") as DataA group by PlantName,[Group] " +
                             /** end temp Table tempTotalSerahLP **/

                             /** temp Table tempdefectListP3 **/
                             " select sum(qty)Qty,PlantName,[Group] into tempdefectListP3  from ( " +
                             "select A.qty * -1 Qty,(((E.Tebal*E.Lebar*E.Panjang)/1000000000)*A.qty *-1)M3,C.[Group],D.PlantName from vw_KartustockWIP A LEFT JOIN BM_Destacking B ON A.destid=B.ID LEFT JOIN BM_PlantGroup C ON C.ID=B.PlantGroupID LEFT JOIN BM_Plant D ON D.ID=B.PlantID LEFT JOIN FC_Items E ON E.ID=A.ItemID where left(convert(char,A.tanggal,112),6)='201911' and A.Lokasi='B99' and A.qty<0 " +
                             "union all " +
                             "select A.qty * -1 Qty,(((E.Tebal*E.Lebar*E.Panjang)/1000000000)*A.qty *-1)M3,C.[Group],D.PlantName from vw_KartustockWIP2 A LEFT JOIN BM_Destacking B ON A.destid=B.ID LEFT JOIN BM_PlantGroup C ON C.ID=B.PlantGroupID LEFT JOIN BM_Plant D ON D.ID=B.PlantID LEFT JOIN FC_Items E ON E.ID=A.ItemID where left(convert(char,A.tanggal,112),6)='201911'  and A.qty<0 and A.ItemID IN (SELECT ID from FC_Items where partno like'%-P-%' ) " +
                             ") as x1 group by PlantName,[Group] " +
                            /** end temp Table tempdefectListP3 **/

                            /** Data Adjust yg sdh serah **/
                            //"IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDM3]') AND type in (N'U')) DROP TABLE [dbo].tempDM3 " +
                            //"IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempD1M3]') AND type in (N'U')) DROP TABLE [dbo].tempD1M3 " +
                            //"IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempD2M3]') AND type in (N'U')) DROP TABLE [dbo].tempD2M3 " +
                            //"IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempD3M3]') AND type in (N'U')) DROP TABLE [dbo].tempD3M3 " +

                            "select A.Qty,A.M3,substring(A2.PartNo,7,11)PartNo,destid into tempDM3 from ( " +
                            "select DestID,A.Qty * -1 Qty,(((B.Tebal*B.Lebar*B.Panjang)/1000000000)*A.qty)*-1 M3 from vw_KartustockWIP A " +
                            "inner join FC_Items B ON A.itemid0=B.ID where CONVERT(varchar,tanggal,112)>=@thnbln1 and CONVERT(varchar,tanggal,112)<=@thnbln2 " +
                            "and Lokasi in ('B99','H99') and qty<0  and destid in (select ID from BM_Destacking " +
                            "where LokasiID in (select ID from FC_Lokasi where Lokasi like'%adj%')) " +
                            "union all  " +
                            "select DestID,cast(qty as decimal(10,2))*-1 Qty,(((B1.Tebal*B1.Lebar*B1.Panjang)/1000000000)*A1.qty)*-1 M3 " +
                            "from vw_KartustockWIP2 A1 inner join FC_Items B1 ON A1.itemid0=B1.ID where  " +
                            "CONVERT(varchar,tanggal,112)>=@thnbln1 and CONVERT(varchar,tanggal,112)<=@thnbln2 and qty<0 AND ItemID IN (SELECT ID from FC_Items where partno like'%-3-%' or " +
                            "PartNo like'%-M-%' or PartNo like'%-P-%') and destid in (select ID from BM_Destacking where LokasiID in (select ID from FC_Lokasi " +
                            " where Lokasi like'%adj%'))) as A " +
                            "inner join BM_Destacking A1 ON A1.ID=A.destid " +
                            "inner join FC_Items A2 ON A2.ID=A1.ItemID " +

                            "select A.*,B.PlantID,B.RowStatus into tempD1M3 from tempDM3 A left join FC_ItemsAdjustDefect B ON A.PartNo=B.PartNo and B.RowStatus>-1 " +

                            "select destid,qty,M3,PlantGroupID,PlantID,RowStatus into tempD2M3 from (select distinct destid,qty,M3,PlantGroupID,PlantID,RowStatus " +
                            "from (select x.destid,x.PartNo,x.qty,x.M3,x1.PlantGroupID,x1.PlantID,x.RowStatus from tempD1M3 as x inner join (select PlantID,PlantGroupID " +
                            "from BM_Destacking where LokasiID not in (select ID from FC_Lokasi where Lokasi like'%adj%') and " +
                            "CONVERT(varchar,tglproduksi,112)>=@thnbln1 and CONVERT(varchar,tglproduksi,112)<=@thnbln2 and RowStatus>-1) x1 ON x1.PlantID=x.PlantID ) as xx " +
                            "group by destid,PlantGroupID,qty,PlantID,RowStatus,M3 ) as x2 " +

                            "select GroupP,PlantName,SubQty Qty,SubM3 M3 into tempD3M3 from (select GroupP,PlantName,SubQty,SubM3 " +
                            "from (select *,cast((qty/Ttl) as decimal(10,2)) SubQty,cast((M3/Ttl) as decimal(10,2)) SubM3 from (select B1.PlantName,x3.*,A1.[Group]GroupP " +
                            "from (select COUNT(A.destid)Ttl,B.* from tempD2M3 A inner join tempD2M3 B ON A.destid=B.destid " +
                            "group by A.destid,B.destid,B.qty,B.PlantGroupID,B.PlantID,B.RowStatus,B.M3 ) as x3 " +
                            "inner join BM_PlantGroup A1 ON A1.ID=x3.PlantGroupID " +
                            "inner join BM_Plant B1 ON B1.ID=A1.PlantID) as A1 ) as A2 ) as A3 group by GroupP,PlantName,SubQty,SubM3 " +
                            /** end Data Adjust yg sdh serah **/

                            ///** Defect Produksi **/
                            ///** temp Table tempDataDefectBM_m3 **/
                            //"declare @DefectBagi decimal(18,2) " +
                            ////"declare @tgl1 varchar(8) "+
                            ////"declare @tgl2 varchar(8) "+

                            //"set @DefectBagi=(select cast((sum(M3)/(select count(distinct [group]) from tempTtlSerah_m33)) as decimal(10,2)) M3 " +
                            //"from (select isnull(sum((((B.Tebal*B.Lebar*B.Panjang)/1000000000) * xx.Qty )),0) M3 " +
                            //"from (select sum(QtyIn) Qty,SerahID from T3_Simetris where ID in (select CutID from vw_KartuStockBJNew " +
                            //"where CONVERT(varchar,tanggal,112)>=@thnbln1 and CONVERT(varchar,tanggal,112)<=@thnbln2 and ItemID " +
                            //"IN (SELECT ID from FC_Items where partno like'%-P-%') and " +
                            //"Process like'%simetris%' and Keterangan like'%-1-%' and CutID in (select ID from T3_Simetris where QtyIn<QtyOut and RowStatus>-1))  " +
                            //"and RowStatus>-1 group by SerahID ) as xx inner join T3_Serah A ON A.ID=xx.SerahID inner join FC_Items B ON B.ID=A.ItemID  " +
                            //"union all  " +
                            ///** BP yg keluar dari Mesin Cutter dan ketika di potong menghasilkan 1 Produk **/
                            //"select sum((((A2.Tebal*A2.Lebar*A2.Panjang)/1000000000) * xx.Qty )) M3  from (select sum(Qty)qty,SerahID from vw_KartuStockBJNew   " +
                            //"where CONVERT(varchar,tanggal,112)>=@thnbln1 and CONVERT(varchar,tanggal,112)<=@thnbln2 and ItemID IN (SELECT ID from FC_Items " +
                            //"where  PartNo like'%-P-%')  " +
                            //"and Process like'%simetris%' and Keterangan like'%-1-%' and CutID in (select ID from T3_Simetris " +
                            //"where QtyIn=QtyOut and RowStatus>-1) " +
                            //"group by SerahID ) as xx inner join T3_Serah A1 ON A1.ID=xx.SerahID inner join FC_Items A2 ON A2.ID=A1.ItemID ) as xx1) " +


                            //"IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTm3]') AND type in (N'U')) DROP TABLE [dbo].[tempTm3] " +
                            //"IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDataDefectBM_m3]') AND type in (N'U')) DROP TABLE [dbo].[tempDataDefectBM_m3] " +

                            //"select cast(M3 as decimal(10,2)) M3,[group],PlantName into tempTm3 from (select cast(sum(M3) as decimal(10,2)) M3,[group],PlantName from ( " +
                            ///** BP ListPlank ada informasi Group Produksi **/
                            //"select M3,[group],PlantName from tempdefectListP  " +
                            //"union all  " +
                            ///** BP yg keluar dari proses Tahap I (Produk Pelarian - Produk Normal ) ada informasi Group Produksi **/
                            //"select M3,[group],PlantName from (select sum(M3)M3,[group],PlantName from (select xx.*,A2.[Group],A3.PlantName from ( " +
                            //"select sum((((B.Tebal*B.Lebar*B.Panjang)/1000000000)*A.qty))*-1 M3,destid from vw_KartustockWIP A inner join FC_Items B ON A.itemid0=B.ID " +
                            //"where CONVERT(varchar,tanggal,112)>=@thnbln1 and CONVERT(varchar,tanggal,112)<=@thnbln2 " +
                            //"and Lokasi='B99' and destid not in (select ID from BM_Destacking where LokasiID in (select ID from FC_Lokasi " +
                            //"where Lokasi like'%adj%')) and qty<0  group by destid,Tebal,Lebar,Panjang " +
                            //"union all  " +
                            //"select sum((((B.Tebal*B.Lebar*B.Panjang)/1000000000)*A.qty))*-1 M3,destid from vw_KartustockWIP2 A " +
                            //"inner join FC_Items B ON A.itemid0=B.ID  " +
                            //"where CONVERT(varchar,tanggal,112)>=@thnbln1 and CONVERT(varchar,tanggal,112)<=@thnbln2 and qty<0 AND " +
                            //"ItemID IN (SELECT ID from FC_Items where partno like'%-P-%' )  and destid not in (select ID from BM_Destacking " +
                            //"where LokasiID in (select ID from FC_Lokasi where Lokasi like'%adj%')) " +
                            //"group by DestID,Tebal,Lebar,Panjang) as xx inner join BM_Destacking A1 ON A1.ID=xx.destid " +
                            //"left join BM_PlantGroup A2 ON A2.ID=A1.PlantGroupID " +
                            //"inner join BM_Plant A3 ON A3.ID=A1.PlantID ) as xx1 group by [group],PlantName ) as bb ) as xx2 " +
                            //"group by [group],PlantName ) as xx3   " +
                            ///** End Defect Produksi **/

                            //"select M3,[group],PlantName into tempDataDefectBM_m3 from ( " +
                            //"select cast(sum(M3) + (@DefectBagi)as decimal(10,2)) M3,[group],PlantName from ( " +
                            //"select M3,[group],PlantName from ( " +
                            //"select 0'M3',x.[group],x2.PlantName from (select distinct [group] from tempTotalSerah_lmbr2) as x " +
                            //"inner join BM_PlantGroup x1 ON x.[group]=x1.[Group] inner join BM_Plant x2 ON x2.ID=x1.PlantID ) as x3  " +
                            //"union all " +
                            //"select * from tempTm3 " +
                            //"union all " +
                            //"select M3,[group],PlantName from (select *,(select distinct M3 / count(destid) M3 from tempD2M3 " +
                            //"where RowStatus=1 group by M3)M3 from ( " +
                            //"select x1.[Group],x2.PlantName from (select PlantGroupID,PlantID from tempD2M3 where RowStatus=1 ) as x  " +
                            //"inner join BM_PlantGroup x1 ON x.PlantGroupID=x1.ID " +
                            //"inner join BM_Plant x2 ON x2.ID=x.PlantID ) as xx ) as xx2 " +
                            //") as x5 group by [group],PlantName ) as cc " +

                            /** Total Defect ListPlank OK BP **/
                            "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDefectOKBPNew]') AND type in (N'U')) DROP TABLE [dbo].tempDefectOKBPNew " +

                            "select sum(Qty)Qty,sum(M3)M3,PlantName,[Group] into tempDefectOKBPNew from (  " +

                            /** Pemasukan ke Bevel **/
                            "select sum(Qty)Qty,sum(M3)M3,PlantName,[Group]  from (select x.*,B.[Group],C.PlantName, " +
                            "((D.Tebal*D.Lebar*D.Panjang)/1000000000)*x.Qty M3   " +
                            "from (select sum(QtyIn)Qty,DestID,ItemID from T1_Straping " +
                            "where CONVERT(varchar,TglTrans,112)>=@thnbln1 and CONVERT(varchar,TglTrans,112)<=@thnbln2  " +
                            "and RowStatus>-1 and L1ID in (select ID from T1_Bevel where RowStatus >-1) group by DestID,ItemID ) as x  " +
                            "LEFT JOIN BM_Destacking A ON A.ID=x.DestID  " +
                            "LEFT JOIN BM_PlantGroup B ON B.ID=A.PlantGroupID  " +
                            "LEFT JOIN BM_Plant C ON C.ID=A.PlantID  " +
                            "LEFT JOIN FC_Items D ON D.ID=x.ItemID) as x2 group by [group],PlantName  " +
                            "union all  " +
                            /** BP Strapping dah OK **/
                            "select sum(Qty)*-1 Qty,sum(M3)*-1 M3,PlantName,[Group] from (select PlantName,[group],sum(qty)Qty,sum(M3)M3  " +
                            "from (select A6.PlantName,A5.[group],A4.Qty,((A7.Tebal*A7.Lebar*A7.Panjang)/1000000000)*A4.Qty M3  " +
                            "from (select A3.PlantID,A3.PlantGroupID,A2.Tanggal,A2.Qty,A2.ItemID  " +
                            "from (select (select A1.PartNo from FC_Items A1 where A1.ID=A.ItemID)Partno,A.DestID,A.TglTrans Tanggal,A.QtyIn Qty,B.ItemID  " +
                            "from T3_Rekap A INNER JOIN T1_Straping B ON A.DestID=B.DestID and A.T1SerahID=B.ID " +
                            "where CONVERT(varchar,A.TglTrans,112)>=@thnbln1 and CONVERT(varchar,A.TglTrans,112)<=@thnbln2   " +
                            "and A.sfrom='straping' and A.RowStatus>-1 and A.ItemID in (select ID from FC_Items where partno like'%-P-%') ) as A2 " +
                            "INNER JOIN BM_Destacking A3 ON A2.DestID=A3.ID ) as A4 " +
                            "INNER JOIN BM_PlantGroup A5 ON A4.PlantGroupID=A5.ID " +
                            "INNER JOIN BM_Plant A6 ON A6.ID=A4.PlantID INNER JOIN FC_Items A7 ON A7.ID=A4.ItemID ) as A8 group by PlantName,[Group] ) as A9  " +
                            "group by [group],PlantName  " +
                            "union all  " +
                            /** Defect ListPlank BP **/
                            "select sum(Qty)Qty,sum(M3)M3,PlantName,[Group] from tempdefectListP group by [group],PlantName  " +
                            ") as DataFinal group by [group],PlantName  " +
                            /** end Total Defect ListPlank OK BP **/

                            /** I. BP ListPlank **/
                            /** BP dari Bevel **/
                            //"select sum(Qty)Qty,ROUND(sum(M3),1)M3,PlantName,[Group] into tempDefectOKBPNew  from ( " +
                            //"select sum(Qty)Qty,sum(M3)M3,PlantName,[Group]  from ( select PlantName,[group],Qty,M3  " +
                            //"from (select PlantName,[Group],sum(Qty)Qty,sum(M3)M3 from (select Data3.PlantName,Data3.[Group],Data3.Qty,Data3.M3 " +
                            //"from (select C1.PlantName,B1.[Group],Data2.Qty,M3 from (select B.PlantID,B.PlantGroupID,Data1.*, " +
                            //"(((C.Tebal*C.Lebar*C.Panjang)/1000000000)*Data1.Qty) M3 from (select  tanggal,itemid,PartNo,Qty,DestID from vw_KartuStockListplankR1 " +
                            //"where itemid in (select ID from FC_Items where PartNo like'%-P-%')  and CONVERT(varchar,tanggal,112)>=@thnbln1 and CONVERT(varchar,tanggal,112)<=@thnbln2 " +
                            //"and qty>0 and process='i99' and ID in (select IDrec from vw_KartuStockListplank where process='Bevel' and qty<0 and Stat='BvToR1')) as Data1 " +
                            //"INNER JOIN BM_Destacking B ON Data1.DestID=B.ID " +
                            //"INNER JOIN FC_Items C ON C.ID=Data1.itemid ) as Data2 " +
                            //"INNER JOIN BM_PlantGroup B1 ON Data2.PlantGroupID=B1.ID " +
                            //"INNER JOIN BM_Plant C1 ON C1.ID=Data2.PlantID ) as Data3  ) as Data4 group by PlantName,[group] ) as Data5 " +
                            //"union all " +
                            ///** BP dari Strapping **/
                            //"select PlantName,[group],Qty,M3 from (select PlantName,[group],sum(qty)Qty,sum(M3)M3 " +
                            //"from (select A6.PlantName,A5.[group],A4.Qty,(((A7.Tebal*A7.Lebar*A7.Panjang)/1000000000)* A4.Qty) M3 " +
                            //"from (select A3.PlantID,A3.PlantGroupID,A2.Tanggal,A2.Qty,A2.ItemID " +
                            //"from (select (select A1.PartNo from FC_Items A1 where A1.ID=A.ItemID)Partno,A.DestID,A.TglTrans Tanggal,A.QtyIn Qty,A.ItemID " +
                            //"from T3_Rekap A INNER JOIN T1_Straping B ON A.DestID=B.DestID and A.T1SerahID=B.ID " +
                            //"where CONVERT(varchar,A.TglTrans,112)>=@thnbln1 and CONVERT(varchar,A.TglTrans,112)<=@thnbln2 " +
                            //"and A.sfrom='straping' and A.RowStatus>-1 and A.ItemID in (select ID from FC_Items where partno like'%-P-%') ) as A2 " +
                            //"INNER JOIN BM_Destacking A3 ON A2.DestID=A3.ID ) as A4 " +
                            //"INNER JOIN BM_PlantGroup A5 ON A4.PlantGroupID=A5.ID " +
                            //"INNER JOIN BM_Plant A6 ON A6.ID=A4.PlantID INNER JOIN FC_Items A7 ON A7.ID=A4.ItemID ) as A8 " +
                            //"group by PlantName,[Group] ) as A9 ) as Final  group by PlantName,[Group] " +
                            //"union all " +
                            ///** II. OK KW ListPlank ( Pemasukan dari Bevel ) **/
                            //"select sum(Qty)Qty,sum(M3)M3,PlantName,[Group] from (select x.*,B.[Group],C.PlantName,(((D.Tebal*D.Lebar*D.Panjang)/1000000000)*x.Qty) M3  " +
                            //"from (select sum(QtyIn)Qty,DestID,ItemID from T1_Straping " +
                            //"where CONVERT(varchar,TglTrans,112)>=@thnbln1 and CONVERT(varchar,TglTrans,112)<=@thnbln2 " +
                            //"and RowStatus>-1 and L1ID in (select ID from T1_Bevel where RowStatus >-1) group by DestID,ItemID ) as x " +
                            //"LEFT JOIN BM_Destacking A ON A.ID=x.DestID " +
                            //"LEFT JOIN BM_PlantGroup B ON B.ID=A.PlantGroupID " +
                            //"LEFT JOIN BM_Plant C ON C.ID=A.PlantID " +
                            //"LEFT JOIN FC_Items D ON D.ID=x.ItemID) as x2 group by [group],PlantName ) as DataFinal group by [group],PlantName " +

                            /** Total Serah Tahap I ke Tahap III **/
                            //"IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTotalSerahM3]') AND type in (N'U')) DROP TABLE [dbo].tempTotalSerahM3 " +
                            //"select M3,[group],PlantName into tempTotalSerahM3 from ( " +
                            //"select sum(M3)M3,[group],PlantName from ( " +
                            //"select M3,[group],PlantName from ( " +
                            //"select M3 +  " +
                            //"(select sum(M3)/@TotalGroup M3 from (" +
                            ///** Defect Ukuran Khusus OK KM **/
                            //"select round(isnull(sum(M3),0),1)M3 from ( " +
                            //"select (((A3.Tebal*A3.Lebar*A3.Panjang)/1000000000)*sum(A1.QtyIn))M3 " +
                            //"from T3_Simetris A1 inner join T3_Serah A2 ON A1.SerahID=A2.ID inner join FC_Items A3 ON A3.ID=A2.ItemID " +
                            //"where A1.ID in (select CutID from vw_KartuStockBJNew " +
                            //"where CONVERT(varchar,tanggal,112)>=@thnbln1 and CONVERT(varchar,tanggal,112)<=@thnbln2 " +
                            //"and ItemID IN (SELECT ID from FC_Items where partno like'%-3-%' or partno like'%-M-%') and Process like'%simetris%' " +
                            //"and Keterangan like'%-1-%' and CutID in (select ID from T3_Simetris where QtyIn<QtyOut and RowStatus>-1)) and A1.RowStatus>-1 " +
                            //"group by A3.Tebal,A3.Lebar,A3.Panjang ) as xx " +
                            ///** end Defect Ukuran Khusus OK KM **/
                            //"union all " +
                            ///** Defect Ukuran Khusus BP **/
                            //"select round(isnull(sum(M3),0),1)M3 from ( " +
                            //"select (((B3.Tebal*B3.Lebar*B3.Panjang)/1000000000)*sum(B1.QtyIn))M3 from T3_Simetris B1 " +
                            //"inner join T3_Serah B2 ON B1.SerahID=B2.ID inner join FC_Items B3 ON B3.ID=B2.ItemID " +
                            //"where B1.ID in (select CutID from vw_KartuStockBJNew " +
                            //"where CONVERT(varchar,tanggal,112)>=@thnbln1 and CONVERT(varchar,tanggal,112)<=@thnbln2 " +
                            //"and ItemID IN (SELECT ID from FC_Items where partno like'%-P-%') and Process like'%simetris%' and Keterangan like'%-1-%' " +
                            //"and CutID in (select ID from T3_Simetris where QtyIn<QtyOut and RowStatus>-1)) and B1.RowStatus>-1  " +
                            //"group by B3.Tebal,B3.Lebar,B3.Panjang ) as xxx " +
                            ///** end Defect Ukuran Khusus BP **/
                            //"union all " +
                            ///** Mutasi BJ T1**/
                            //"select round(sum(M3),2) M3 from " +
                            //"(select SerahID,(((A2.Tebal*A2.Lebar*A2.Panjang)/1000000000)*x.Qty)M3 from ( " +
                            //"select sum(A.qty) Qty,A.SerahID from vw_KartuStockBJNew A inner join FC_Items B ON A.ItemID=B.ID " +
                            //"where CONVERT(varchar,tanggal,112)>=@thnbln1 and CONVERT(varchar,tanggal,112)<=@thnbln2 " +
                            //"and ItemID IN (SELECT ID from FC_Items where PartNo like'%-3-%' or PartNo like'%-M-%' or PartNo like'%-W-%' or PartNo like'%-P-%') " +
                            //"and Process like'%simetris%' and Keterangan like'%-1-%' and " +
                            //"CutID in (select ID from T3_Simetris where QtyIn=QtyOut and RowStatus>-1) group by A.SerahID ) as x " +
                            //"inner join T3_Serah A1 ON A1.ID=x.SerahID inner join FC_Items A2 ON A2.ID=A1.ItemID ) as x " +
                            ///** end Mutasi BJ T1**/
                            //") as xx) M3,[group],PlantName " +
                            //"from (" +
                            //"select sum(M3)M3,[group],PlantName from ( " +
                            //"select round(sum(M3),2)M3,[group],PlantName from (select xx1.*,B.[Group],C.PlantName  " +
                            //"from (select xx.*,A.PlantGroupID,A.PlantID from ( " +
                            ///** Mutasi WiP **/
                            //"select destid,(((B.Tebal*B.Lebar*B.Panjang)/1000000000)*(A.qty * -1))M3 from vw_KartustockWIP A " +
                            //"inner join FC_Items B ON A.itemid0=B.ID " +
                            //"where CONVERT(varchar,tanggal,112)>=@thnbln1 and CONVERT(varchar,tanggal,112)<=@thnbln2 " +
                            //"and Lokasi in ('B99','H99') and qty<0  and destid in (select ID from BM_Destacking where LokasiID " +
                            //"not in (select ID from FC_Lokasi where Lokasi like'%adj%')) " +
                            //"union all " +
                            //"select DestID,(((B1.Tebal*B1.Lebar*B1.Panjang)/1000000000)*(A1.Qty * -1))M3 from vw_KartustockWIP2 A1 " +
                            //"inner join FC_Items B1 ON A1.itemid0=B1.ID " +
                            //"where CONVERT(varchar,tanggal,112)>=@thnbln1 and CONVERT(varchar,tanggal,112)<=@thnbln2 " +
                            //"and qty<0 AND ItemID IN (SELECT ID from FC_Items where partno like'%-3-%' or PartNo like'%-M-%' or PartNo like'%-P-%') " +
                            //"and destid in (select ID from BM_Destacking where LokasiID not in (select ID from FC_Lokasi where Lokasi like'%adj%')) " +
                            ///** end Mutasi WiP **/
                            //") as xx left join BM_Destacking A ON A.ID=xx.destid ) as xx1 " +
                            //"left join BM_PlantGroup B ON B.ID=xx1.PlantGroupID left join BM_Plant C ON C.ID=xx1.PlantID ) as AA  " +
                            //"group by [group],PlantName " +
                            //"union all " +
                            //"select M3,GroupP [group],PlantName from tempD3M3 ) as Datax group by [group],PlantName ) as x0  ) as x00 " +
                            //"union all " +
                            //"select M3,[group],PlantName from tempDefectOKBPNew ) as x01 group by [group],PlantName ) as D " +
                            /** end Tambahan Baruuuuuuuuu **/
                            "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTtlSerah_m3]') AND type in (N'U')) DROP TABLE [dbo].tempTtlSerah_m3 " +
                            "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTtlSerah_m32]') AND type in (N'U')) DROP TABLE [dbo].tempTtlSerah_m32 " +
                            "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTtlSerah_m33]') AND type in (N'U')) DROP TABLE [dbo].tempTtlSerah_m33 " +

                            //"declare @tgl1 varchar(8) "+
                            //"declare @tgl2 varchar(8) "+
                            "declare @BagiRata decimal(10,2) " +
                            "declare @TotalGroupAktif decimal(10,2) " +

                            "set @BagiRata= " +
                            //"(select cast(sum(M3)as decimal(10,2)) M3 from ( "+
                            ///** Defect Ukuran Khusus OK KM **/
                            //"select sum(Qty)Qty,sum(M3)M3 from ( "+
                            //"select sum(A1.QtyIn)Qty,sum(((A3.Tebal*A3.Lebar*A3.Panjang)/1000000000)* A1.QtyIn) M3 "+
                            //"from T3_Simetris A1 inner join T3_Serah A2 ON A1.SerahID=A2.ID "+
                            //"inner join FC_Items A3 ON A3.ID=A2.ItemID where A1.ID in (select CutID from vw_KartuStockBJNew "+
                            //"where CONVERT(varchar,tanggal,112)>=@thnbln1 and CONVERT(varchar,tanggal,112)<=@thnbln2 "+
                            //"and ItemID IN (SELECT ID from FC_Items where partno like'%-3-%' or partno like'%-M-%') and Process like'%simetris%' "+
                            //"and Keterangan like'%-1-%' and CutID in (select ID from T3_Simetris where QtyIn<QtyOut and RowStatus>-1)) and A1.RowStatus>-1 "+
                            //"group by A3.Tebal,A3.Lebar,A3.Panjang ) as xx "+
                            ///** end Defect Ukuran Khusus OK KM **/
                            //"union all  "+
                            ///** Defect Ukuran Khusus BP **/
                            //"select sum(Qty)Qty,sum(M3)M3 from ( "+
                            //"select sum(QtyIn)Qty,sum(((B3.Tebal*B3.Lebar*B3.Panjang)/1000000000)* B1.QtyIn) M3 from T3_Simetris B1 "+
                            //"inner join T3_Serah B2 ON B1.SerahID=B2.ID inner join FC_Items B3 ON B3.ID=B2.ItemID "+
                            //"where B1.ID in (select CutID from vw_KartuStockBJNew "+
                            //"where CONVERT(varchar,tanggal,112)>=@thnbln1 and CONVERT(varchar,tanggal,112)<=@thnbln2 "+
                            //"and ItemID IN (SELECT ID from FC_Items where partno like'%-P-%') and Process like'%simetris%' and Keterangan like'%-1-%' and "+
                            //"CutID in (select ID from T3_Simetris where QtyIn<QtyOut and RowStatus>-1)) and B1.RowStatus>-1  "+
                            //"group by B3.Tebal,B3.Lebar,B3.Panjang ) as xxx "+
                            ///** end Defect Ukuran Khusus BP **/
                            //"union all "+
                            ///** Mutasi BJ T1**/
                            //"select sum(Qty)Qty,sum(M3)M3 from ( "+
                            //"select sum(x2.Qty)Qty,sum(((x4.Tebal*x4.Lebar*x4.Panjang)/1000000000)*x2.Qty) M3 from ( "+
                            //"select sum(qty)Qty,C.SerahID from vw_KartuStockBJNew A inner join FC_Items B ON A.ItemID=B.ID "+
                            //"inner join T3_Simetris C ON C.ID=A.CutID "+
                            //"where CONVERT(varchar,tanggal,112)>=@thnbln1 and CONVERT(varchar,tanggal,112)<=@thnbln2 "+
                            //"and A.ItemID IN (SELECT ID from FC_Items where partno like'%-3-%' "+
                            //"or PartNo like'%-M-%' or PartNo like'%-P-%') and Process like'%simetris%' and Keterangan like'%-1-%' and "+
                            //"CutID in (select ID from T3_Simetris where QtyIn=QtyOut and RowStatus>-1) group by B.Tebal,B.Lebar,B.Panjang,C.SerahID ) as x2 "+
                            //"inner join T3_Serah x3 ON x3.ID=x2.SerahID inner join FC_Items x4 ON x4.ID=x3.ItemID ) as x "+
                            ///** end Mutasi BJ T1**/
                            //") as xx) "+

                            " /** @BagiRata **/ " +
                            "(select cast(sum(M3)as decimal(10,2)) M3 from ( " +
                            "select sum(Qty*Volume) M3 from ( select sum(A1.QtyIn)Qty,((A3.Tebal*A3.Lebar*A3.Panjang)/1000000000)Volume " +
                            "from T3_Simetris A1 inner join T3_Serah A2 ON A1.SerahID=A2.ID inner join FC_Items A3 ON A3.ID=A2.ItemID " +
                            "where A1.ID in (select CutID from vw_KartuStockBJNew where CONVERT(varchar,tanggal,112)>=@thnbln1 " +
                            "and CONVERT(varchar,tanggal,112)<=@thnbln2 and ItemID IN (SELECT ID from FC_Items where partno like'%-3-%' or partno like'%-M-%') " +
                            "and Process='simetris' and Keterangan like'%-1-%' and CutID in (select ID from T3_Simetris " +
                            "where QtyIn<QtyOut and RowStatus>-1)) and A1.RowStatus>-1 group by A3.Tebal,A3.Lebar,A3.Panjang ) as xx " +
                            "union all " +
                            "/** Tambahan ASimetris**/ " +
                            "select Qty*Volume M3 from ( " +
                            "select sum(Qty)*-1 Qty,((A.Tebal*A.Lebar*A.Panjang)/1000000000)Volume " +
                            "from ( select qty,ItemID from vw_KartuStockBJNew where PartNo like'%-1-%' and qty<0 and " +
                            "CONVERT(varchar,tanggal,112)>=@thnbln1 and CONVERT(varchar,tanggal,112)<=@thnbln2 and Process='ASimetris') as xx " +
                            "inner join FC_Items A ON A.ID=xx.ItemID group by A.Tebal,A.Lebar,A.Panjang ) as xx " +
                            "union all " +
                            "/** Defect System Simetris  **/ " +
                            "select sum(Qty*Volume)M3 from ( " +
                            "select sum(qty)Qty,((B.Tebal*B.Lebar*B.Panjang)/1000000000)Volume " +
                            "from vw_KartuStockBJNew A inner join FC_Items B ON A.ItemID=B.ID " +
                            "where CONVERT(varchar,tanggal,112)>=@thnbln1 and CONVERT(varchar,tanggal,112)<=@thnbln2 and ItemID IN " +
                            "(SELECT ID from FC_Items where partno like'%-3-%' or PartNo like'%-M-%' or PartNo like'%-P-%') and Process='simetris' " +
                            "and Keterangan like'%-1-%' and CutID in (select ID from T3_Simetris where QtyIn=QtyOut and RowStatus>-1) " +
                            "group by B.Tebal,B.Lebar,B.Panjang ) as AA " +
                            "union all " +
                            "select sum(Qty*Volume)M3 from ( select sum(QtyIn)Qty,((B3.Tebal*B3.Lebar*B3.Panjang)/1000000000)Volume " +
                            "from T3_Simetris B1 inner join T3_Serah B2 ON B1.SerahID=B2.ID inner join FC_Items B3 ON B3.ID=B2.ItemID " +
                            "where B1.ID in (select CutID from vw_KartuStockBJNew " +
                            "where CONVERT(varchar,tanggal,112)>=@thnbln1 and CONVERT(varchar,tanggal,112)<=@thnbln2 " +
                            "and ItemID IN (SELECT ID from FC_Items where partno like'%-P-%') and /**Process like'%simetris%'**/ Process='Simetris' and " +
                            "Keterangan like'%-1-%' and CutID in (select ID from T3_Simetris where QtyIn<QtyOut and RowStatus>-1)) and B1.RowStatus>-1  " +
                            "group by B3.Tebal,B3.Lebar,B3.Panjang ) as xxx ) as x4 )" +

                            "select M3,[group],PlantName into tempTtlSerah_m3 from ( " +
                            "select sum(M3)M3,[group],PlantName from ( " +
                            "select M3,[group],PlantName from ( " +
                            "select M3,[group],PlantName " +
                            "from ( " +
                            "select sum(M3)M3,[group],PlantName from ( " +
                            "select cast(sum(M3) as decimal(10,2)) M3,[group],PlantName " +
                            "from (select xx1.*,B.[Group],C.PlantName  from (select xx.*,A.PlantGroupID,A.PlantID from ( " +
                            /** Mutasi WiP **/
                            "select (((B.Tebal*B.Lebar*B.Panjang)/1000000000)*A.qty) *-1 M3,destid " +
                            "from vw_KartustockWIP A inner join FC_Items B ON A.itemid0=B.ID " +
                            "where CONVERT(varchar,tanggal,112)>=@thnbln1 and CONVERT(varchar,tanggal,112)<=@thnbln2 " +
                            "and Lokasi in ('B99','H99') and qty<0  and destid in (select ID from BM_Destacking " +
                            "where LokasiID not in (select ID from FC_Lokasi where Lokasi like'%adj%')) " +
                            "union all " +
                            "select (((B1.Tebal*B1.Lebar*B1.Panjang)/1000000000)*A1.qty) *-1 M3,DestID " +
                            "from vw_KartustockWIP2 A1 inner join FC_Items B1 ON A1.itemid0=B1.ID " +
                            "where CONVERT(varchar,tanggal,112)>=@thnbln1 and CONVERT(varchar,tanggal,112)<=@thnbln2 " +
                            "and qty<0 AND ItemID IN (SELECT ID from FC_Items where partno like'%-3-%' or PartNo like'%-M-%' or PartNo like'%-P-%') and " +
                            " destid in (select ID from BM_Destacking where LokasiID not in (select ID from FC_Lokasi where Lokasi like'%adj%')) " +
                            /** end Mutasi WiP **/

                            ") as xx left join BM_Destacking A ON A.ID=xx.destid ) as xx1 " +
                            "left join BM_PlantGroup B ON B.ID=xx1.PlantGroupID left join BM_Plant C ON C.ID=xx1.PlantID ) as AA  group by [group],PlantName " +
                            "union all " +
                            /** total adjust **/
                            "select cast(M3 as decimal(10,2))M3,GroupP [group],PlantName from tempD3M3 ) as Datax " +
                            "group by [group],PlantName ) as x0  ) as x00 ) as x01 group by [group],PlantName ) as D " +

                            "select * into tempTtlSerah_m32 from ( " +
                            "select 'A'Urut,cast(sum(M3) as decimal(10,3)) M3,[group],PlantName from tempTtlSerah_m3  group by [group],PlantName " +
                            "union all " +
                            "select 'B'Urut,cast(sum(M3) as decimal(10,3)) M3,[group],PlantName from tempDefectOKBPNew  group by [group],PlantName ) as xm  " +

                            "set @TotalGroupAktif = (select count(distinct [group])Total from tempTtlSerah_m32) " +

                            "select cast(M3+(@BagiRata/(select count(distinct [group])Total from tempTtlSerah_m32)) as decimal(10,2))M3,[group],PlantName " +
                            "into tempTtlSerah_m33 from (select sum(M3)M3,[group],PlantName from tempTtlSerah_m32  group by [group],PlantName ) as xx " +

                            /** Defect Produksi **/
                            /** temp Table tempDataDefectBM_m3 **/
                            "declare @DefectBagi decimal(18,2) " +
                            //"declare @tgl1 varchar(8) "+
                            //"declare @tgl2 varchar(8) "+

                            "set @DefectBagi=(select cast((sum(M3)/(select count(distinct [group]) from tempTtlSerah_m33)) as decimal(10,2)) M3 " +
                            "from (select isnull(sum((((B.Tebal*B.Lebar*B.Panjang)/1000000000) * xx.Qty )),0) M3 " +
                            "from (select sum(QtyIn) Qty,SerahID from T3_Simetris where ID in (select CutID from vw_KartuStockBJNew " +
                            "where CONVERT(varchar,tanggal,112)>=@thnbln1 and CONVERT(varchar,tanggal,112)<=@thnbln2 and ItemID " +
                            "IN (SELECT ID from FC_Items where partno like'%-P-%') and " +
                            " /**Process like'%simetris%'**/Process='Simetris' and Keterangan like'%-1-%' and CutID in (select ID from T3_Simetris where QtyIn<QtyOut and RowStatus>-1))  " +
                            "and RowStatus>-1 group by SerahID ) as xx inner join T3_Serah A ON A.ID=xx.SerahID inner join FC_Items B ON B.ID=A.ItemID  " +
                            "union all  " +
                            /** BP yg keluar dari Mesin Cutter dan ketika di potong menghasilkan 1 Produk **/
                            "select sum((((A2.Tebal*A2.Lebar*A2.Panjang)/1000000000) * xx.Qty )) M3  from (select sum(Qty)qty,SerahID from vw_KartuStockBJNew   " +
                            "where CONVERT(varchar,tanggal,112)>=@thnbln1 and CONVERT(varchar,tanggal,112)<=@thnbln2 and ItemID IN (SELECT ID from FC_Items " +
                            "where  PartNo like'%-P-%') and " +
                            " /**Process like'%simetris%'**/Process='Simetris' and Keterangan like'%-1-%' and CutID in (select ID from T3_Simetris " +
                            "where QtyIn=QtyOut and RowStatus>-1) " +
                            "group by SerahID ) as xx inner join T3_Serah A1 ON A1.ID=xx.SerahID inner join FC_Items A2 ON A2.ID=A1.ItemID ) as xx1) " +


                            "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTm3]') AND type in (N'U')) DROP TABLE [dbo].[tempTm3] " +
                            "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDataDefectBM_m3]') AND type in (N'U')) DROP TABLE [dbo].[tempDataDefectBM_m3] " +

                            "select cast(M3 as decimal(10,2)) M3,[group],PlantName into tempTm3 from (select cast(sum(M3) as decimal(10,2)) M3,[group],PlantName from ( " +
                            /** BP ListPlank ada informasi Group Produksi **/
                            "select M3,[group],PlantName from tempdefectListP  " +
                            "union all  " +
                            /** BP yg keluar dari proses Tahap I (Produk Pelarian - Produk Normal ) ada informasi Group Produksi **/
                            "select M3,[group],PlantName from (select sum(M3)M3,[group],PlantName from (select xx.*,A2.[Group],A3.PlantName from ( " +
                            "select sum((((B.Tebal*B.Lebar*B.Panjang)/1000000000)*A.qty))*-1 M3,destid from vw_KartustockWIP A inner join FC_Items B ON A.itemid0=B.ID " +
                            "where CONVERT(varchar,tanggal,112)>=@thnbln1 and CONVERT(varchar,tanggal,112)<=@thnbln2 " +
                            "and Lokasi='B99' and destid not in (select ID from BM_Destacking where LokasiID in (select ID from FC_Lokasi " +
                            "where Lokasi like'%adj%')) and qty<0  group by destid,Tebal,Lebar,Panjang " +
                            "union all  " +
                            "select sum((((B.Tebal*B.Lebar*B.Panjang)/1000000000)*A.qty))*-1 M3,destid from vw_KartustockWIP2 A " +
                            "inner join FC_Items B ON A.itemid0=B.ID  " +
                            "where CONVERT(varchar,tanggal,112)>=@thnbln1 and CONVERT(varchar,tanggal,112)<=@thnbln2 and qty<0 AND " +
                            "ItemID IN (SELECT ID from FC_Items where partno like'%-P-%' )  and destid not in (select ID from BM_Destacking " +
                            "where LokasiID in (select ID from FC_Lokasi where Lokasi like'%adj%')) " +
                            "group by DestID,Tebal,Lebar,Panjang) as xx inner join BM_Destacking A1 ON A1.ID=xx.destid " +
                            "left join BM_PlantGroup A2 ON A2.ID=A1.PlantGroupID " +
                            "inner join BM_Plant A3 ON A3.ID=A1.PlantID ) as xx1 group by [group],PlantName ) as bb ) as xx2 " +
                            "group by [group],PlantName ) as xx3   " +
                            /** End Defect Produksi **/

                            "select M3,[group],PlantName into tempDataDefectBM_m3 from ( " +
                            "select cast(sum(M3) + (@DefectBagi)as decimal(10,2)) M3,[group],PlantName from ( " +
                            "select M3,[group],PlantName from ( " +
                            "select 0'M3',x.[group],x2.PlantName from (select distinct [group] from tempTtlSerah_m33) as x " +
                            "inner join BM_PlantGroup x1 ON x.[group]=x1.[Group] inner join BM_Plant x2 ON x2.ID=x1.PlantID ) as x3  " +
                            "union all " +
                            "select * from tempTm3 " +
                            "union all " +
                            "select M3,[group],PlantName from (select *,(select distinct M3 / count(destid) M3 from tempD2M3 " +
                            "where RowStatus=1 group by M3)M3 from ( " +
                            "select x1.[Group],x2.PlantName from (select PlantGroupID,PlantID from tempD2M3 where RowStatus=1 ) as x  " +
                            "inner join BM_PlantGroup x1 ON x.PlantGroupID=x1.ID " +
                            "inner join BM_Plant x2 ON x2.ID=x.PlantID ) as xx ) as xx2 " +
                            ") as x5 group by [group],PlantName ) as cc " +


                            " " +
                             QueryTotalPotong +
                            " " +
                            "declare @DefectFin decimal(18,2) " +
                            "set @DefectFin= (select sum(kubik) from (  " +
                            "select case when D.DeptID=0 then  " +
                            "case when GJ.GroupJemurName In ('M','N','O','P','Q','R','S','T','U','V','W','X') then   " +
                            "case when D.DefName='retak' then 2   " +
                            "when D.DefName='gompal' then 3  " +
                            "else D.DeptID end   " +
                            "else    " +
                            "case when (B.Qty/E.Qty) *100 >5 then 2 else 3 end   " +
                            "end  " +
                            "else D.DeptID end deptID1,A.CreatedTime as tglInput,A.Tgl as TglPeriksa,E.TglProduksi as TglProd,  D.DefCode,BP.PlantName as Line, PG.[Group],BF.FormulaCode as Jenis,   " +
                            "D.DefName,D.DeptID,B.ID,B.DefectID,B.MasterID,B.Qty,A.ID  DestID,isnull(A.TPotong,0)  QtyIn,B.Qty*I.Volume as Kubik,isnull(A.TPotong,0) as TotPotong,'' sfrom  " +
                            "from Def_DefectDetail B inner join Def_Defect A on A.Id=B.DefectID   " +
                            "left join Def_MasterDefect D on B.MasterID=D.ID left join BM_Destacking E on E.ID=A.DestID   " +
                            "left join BM_PlantGroup PG on A.GroupProdID=PG.ID left join BM_Formula BF on BF.ID=E.FormulaID    " +
                            "left join BM_Plant BP on BP.ID=E.PlantID left join FC_Items I on I.ID=E.ItemID inner join Def_GroupJemur GJ on GJ.ID=A.GroupJemurID  " +
                            "where B.RowStatus>-1  and D.RowStatus >-1) as Def    " +
                            "where DeptID1<>2 and CONVERT(varchar,TglPeriksa,112)>=@thnbln1 and CONVERT(varchar,TglPeriksa,112)<=@thnbln2) " +
                            " " +

                            /** temp Table tempdefectFin **/
                            "select * into tempdefectFin from ( " +
                            "select 'OKKW' fin, sum(qtyin) lembar,sum(qtyin * kubik)kubik from ( " +
                            "select I1.PartNo partno1,I1.Panjang * I1.Lebar luas1,  S.qtyin,I2.PartNo partno2,I2.Panjang * I2.Lebar luas2,  S.qtyout ,(I1.Tebal * I1.Panjang * I1.Lebar)/1000000000 kubik " +
                            "from t3_simetris S inner join T3_Serah Se on S.SerahID =Se.ID inner join fc_items I1 on Se.ItemID=I1.ID inner join fc_items I2 on S.ItemID=I2.id  " +
                            "where I2.lebar>500 and S.RowStatus>-1 and CONVERT(varchar,S.tgltrans,112)>=@thnbln1 and CONVERT(varchar,S.tgltrans,112)<=@thnbln2 )a where partno1 like '%-1-%' and luas2/luas1 *100<60 and partno2 like '%-p-%' " +
                            "union all " +
                            "select 'BP' fin, sum(qtyin) lembar,sum(qtyin * kubik)kubik from ( " +
                            "select I1.PartNo partno1,I1.Panjang * I1.Lebar luas1,  S.qtyin,I2.PartNo partno2,I2.Panjang * I2.Lebar luas2,  S.qtyout ,(I1.Tebal * I1.Panjang * I1.Lebar)/1000000000 kubik " +
                            "from t3_simetris S inner join T3_Serah Se on S.SerahID =Se.ID inner join fc_items I1 on Se.ItemID=I1.ID inner join fc_items I2 on S.ItemID=I2.id  " +
                            "where S.RowStatus>-1 and CONVERT(varchar,S.tgltrans,112)>=@thnbln1 and CONVERT(varchar,S.tgltrans,112)<=@thnbln2  )a where partno1 like '%-1-%' and luas2/luas1 *100<60 and  " +
                            "(partno2 like '%-3-%' or partno2 like '%-w-%' or partno2 like '%-m-%') " +
                            "union all " +
                            "select 'BS' fin,sum(R.QtyIn) Lembar,sum(R.QtyIn *((I.tebal*I.panjang*I.lebar)/1000000000)) kubik from T3_Rekap R inner join FC_Items I on R.ItemID=I.id inner join fc_lokasi L on R.LokID =L.id where R.RowStatus>-1 and  " +
                            "CONVERT(varchar,R.tgltrans,112)>=@thnbln1 and CONVERT(varchar,R.tgltrans,112)<=@thnbln2 and I.PartNo like '%-s-%' and Process='direct' " +
                            perubahanlogikalisplank + ")A " +
                            /** end temp Table tempdefectFin **/
                            " " +

                            "declare @TotalPotong decimal(18,2) " +
                            "declare @TotalDefKhusus decimal(18,2) " +
                            "declare @DefKhusus decimal(18,2) " +
                            "declare @Ttotalkw1kw2 decimal(18,2) " +
                            "declare @NCSortir decimal(18,2) " +
                            "declare @Retur decimal(18,2) " +

                            //"set @TotalPotong=isnull((select sum(totkubik ) from tempdefectGPIsoTot),0) " +
                            "set @TotalPotong=isnull((select sum(m3) from tempTtlSerah_m33),0) " +

                            "declare @SelisihTotalPotong decimal(18,2) " +
                            "declare @TotalAccReport decimal(18,2) " +
                            "set @TotalAccReport=(select kubik from( " +
                            "    select  sum(lembar) lembar,sum(kubik)kubik from ( " +
                            "    select 'AccReport' fin, sum(qtyin) lembar,sum(qtyin * kubik)kubik from ( " +
                            "    select I1.PartNo partno1,I1.Panjang * I1.Lebar luas1,  S.qtyin,I2.PartNo partno2,I2.Panjang * I2.Lebar luas2,  S.qtyout ,(I1.Tebal * I1.Panjang * I1.Lebar)/1000000000 kubik " +
                            "    from t3_simetris S inner join T3_Serah Se on S.SerahID =Se.ID inner join fc_items I1 on Se.ItemID=I1.ID inner join fc_items I2 on S.ItemID=I2.id  " +
                            "    where S.RowStatus>-1 and CONVERT(varchar,S.tgltrans,112)>=@thnbln1 and CONVERT(varchar,S.tgltrans,112)<=@thnbln2 )a  " +
                            "    where partno1 like '%-1-%' and luas2/luas1 *100>90  and (partno2 like '%-p-%' or partno2 like '%-3-%' or partno2 like '%-M-%') " +
                            "    union all " +
                            "    select 'AccReport' fin, sum(qtyin) lembar,sum(qtyin * kubik)kubik from ( " +
                            "    select I1.PartNo partno1,I1.Panjang * I1.Lebar luas1,  S.qtyin,I2.PartNo partno2,I2.Panjang * I2.Lebar luas2,  S.qtyout ,(I1.Tebal * I1.Panjang * I1.Lebar)/1000000000 kubik " +
                            "    from t1_serah S  inner join fc_items I1 on S.ItemID0=I1.ID inner join fc_items I2 on S.ItemID=I2.id  " +
                            "    where S.Status>-1 and CONVERT(varchar,S.tglserah,112)>=@thnbln1 and CONVERT(varchar,S.tglserah,112)<=@thnbln2 )a  " +
                            "    where (partno2 like '%-p-%' or partno2 like '%-3-%' or partno2 like '%-M-%'))a)B) " +
                            "set @SelisihTotalPotong= @TotalAccReport-@TotalPotong " +
                            "if @TotalPotong >0  " +
                            "begin " +
                            "set @TotalDefKhusus=isnull((select sum(kubik) from tempdefectFin),0) " +
                            "set @DefKhusus=isnull((select sum(kubik) from tempdefectFin where fin<>'bp'),0) " +
                            "set @Ttotalkw1kw2 =isnull((select sum(qtyin *((I.tebal*I.Lebar*I.Panjang)/1000000000)) from T3_Rekap R inner join fc_items I on R.itemid=I.ID  " +
                            "where R.rowstatus>-1 and R.Process  like '%simetris%' and CONVERT(varchar,R.tgltrans,112)>=@thnbln1 and CONVERT(varchar,R.tgltrans,112)<=@thnbln2   " +
                            "and I.lebar=1200 and I.panjang=2400 and R.keterangan like '%-p-%' and (I.partno like '%-3-%' or I.partno like '%-W-%' or I.partno like '%-M-%' )),0) " +
                            "set @NCSortir=isnull((select /*sum(QtyAkhirSS)+sum(QtyAkhirSE)*/sum(M3AkhirSS)+sum(M3AkhirSE) from (  " +
                            "SELECT B.tgltrans as Tanggal, I1.PartNo as PartnoAwal, sum(B.QtyIn) as QtyAwal,sum(I1.Volume*B.QtyIn) M3Awal,   " +
                            "I2.PartNo AS PartnoAkhir, case when B.NCSS>0 then sum(B.QtyOut) else 0 end QtyAkhirSS,  " +
                            "case when B.NCSS>0 then sum(I2.Volume*B.QtyOut) else 0 end M3AkhirSS,case when B.NCSE>0 then sum(B.QtyOut) else 0 end QtyAkhirSE,  " +
                            "case when B.NCSE>0 then sum(I2.Volume*B.QtyOut) else 0 end M3AkhirSE,B.NCSS,B.NCSE  FROM T3_Serah AS A   " +
                            "INNER JOIN T3_Simetris AS B ON A.ID = B.SerahID INNER JOIN FC_Items AS I1 ON A.ItemID = I1.ID INNER JOIN   " +
                            "FC_Items AS I2 ON B.ItemID = I2.ID LEFT JOIN T3_GroupM AS D ON B.GroupID = D.ID   " +
                            "where (B.NCSS>0 or B.NCSE>0) and B.rowstatus>-1 and CONVERT(varchar,B.tgltrans,112)>=@thnbln1 and CONVERT(varchar,B.tgltrans,112)<=@thnbln2   " +
                            "group by B.tgltrans,I1.PartNo,I2.PartNo,B.NCSS,B.NCSE) S),0) " +
                            "set @Retur=isnull((select sum(qty) from ( " +
                            "select sum(qty *(I.tebal*I.panjang*I.lebar)/1000000000) qty from t3_retur R inner join fc_items I on R.itemid=I.id where R.rowstatus>-1 and  " +
                            "R.typer=1 and (I.partno like '%-p-%' or I.partno like '%-S-%')  and CONVERT(varchar,R.tgltrans,112)>=@thnbln1 and CONVERT(varchar,R.tgltrans,112)<=@thnbln2  " +
                            "union all " +
                            "select sum(qty *(I.tebal*I.panjang*I.lebar)/1000000000)*-1 qty from t3_retur R inner join fc_items I on R.itemid=I.id where R.rowstatus>-1 and  " +
                            "R.typer=2 and (I.partno like '%-p-%' or I.partno like '%-S-%')and CONVERT(varchar,R.tgltrans,112)>=@thnbln1 and CONVERT(varchar,R.tgltrans,112)<=@thnbln2 " +
                            "union all " +
                            "select sum(qty *(I.tebal*I.panjang*I.lebar)/1000000000) qty from t3_returO R inner join fc_items I on R.itemid=I.id where R.rowstatus>-1 and  " +
                            "(I.partno like '%-p-%' or I.partno like '%-S-%') and CONVERT(varchar,R.tgltrans,112)>=@thnbln1 and CONVERT(varchar,R.tgltrans,112)<=@thnbln2)A),0) " +
                            " " +
                            "declare @TotalPotongL1 decimal(18,2) " +
                            "declare @TotDefKhususL1 decimal(18,2) " +
                            "declare @DefKhususL1 decimal(18,2) " +
                            "declare @Ttotalkw1kw2L1 decimal(18,2) " +
                            "declare @NCSortirL1 decimal(18,2) " +
                            "declare @ReturL1 decimal(18,2) " +
                            "declare @DefectFinL1 decimal(18,2) " +

                            /** Area tempdefectL1 **/
                            //"set @TotalPotongL1=(select sum(totkubik ) from tempdefectGPIsoTot where [group]in (select [group] from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 1'))) " +

                            //"set @TotalPotongL1=(select isnull(sum(M3),0)M3 from ( " +
                            //"select isnull(sum(M3),0)M3 from tempTtlSerah_m33 where [group] in (select [group] from BM_PlantGroup " +
                            //"where PlantID in (select id from BM_Plant where PlantName='line 1')) " +
                            //"union all " +
                            //"select isnull(sum(M3),0)M3 from tempDataDefectBM_m3 where [group] in (select [group] from BM_PlantGroup " +
                            //"where PlantID in (select id from BM_Plant where PlantName='line 1'))) as x) " +

                            "set @TotalPotongL1=(select isnull(sum(M3),0)M3 from ( " +
                            "select isnull(sum(M3),0)M3 from tempTtlSerah_m33 where [group] in (select [group] from BM_PlantGroup " +
                            "where PlantID in (select id from BM_Plant where PlantName='line 1'))) as x) " +

                            "set @TotDefKhususL1=(@TotalPotongL1/@TotalPotong)*@TotalDefKhusus " +
                            "set @DefKhususL1=(@TotalPotongL1/@TotalPotong)*@DefKhusus " +
                            "set @Ttotalkw1kw2L1=(@TotalPotongL1/@TotalPotong)*@Ttotalkw1kw2 " +
                            "set @NCSortirL1=(@TotalPotongL1/@TotalPotong)*@NCSortir " +
                            "set @ReturL1=(@TotalPotongL1/@TotalPotong)*@Retur " +
                            "set @DefectFinL1=isnull((@TotalPotongL1/@TotalPotong)*@DefectFin,0) " +
                            "declare @SelisihTotalPotongL1 decimal(18,2) " +
                            "set @SelisihTotalPotongL1=(@TotalPotongL1/@TotalPotong)*@SelisihTotalPotong " +
                        #endregion

                        #region tempdefectL1
 "if @TotalPotongL1>0 " +
                            "begin " +
                            "select * into tempdefectL1 from ( " +
                            //"select [Group],b+h b,c,d,e,f,h,c-d+e+f i,((c-d+e+f)/(b+h))*100 j from ( " +
                            "select [Group],b+h b,c,d,e,f,h,c-d+e+f i,case when (b+h)=0 then 0 else ((c-d+e+f)/(b+h))*100 end j from ( " +
                            "select [Group],case when @TotalPotongL1>0 then " +
                            //"isnull((select isnull(cast(M3 as decimal(10,2)),0)M3 from tempTotalSerahDfctM3 where [group]=BM_PlantGroup.[Group]),0) else 0 end b,  " +
                            "isnull((select isnull(cast(M3 as decimal(10,2)),0)M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group]),0) else 0 end b,  " +
                            "case when @TotalPotongL1>0 then isnull((select M3 from tempDataDefectBM_m3 where [group]=BM_PlantGroup.[Group] ),0)  else 0 end c, " +
                            "case when @TotalPotongL1>0 then ((isnull((select M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@Ttotalkw1kw2L1) else 0 end  d, " +
                            "case when @TotalPotongL1>0 then ((isnull((select M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@NCSortirL1)  else 0 end  e, " +
                            "case when @TotalPotongL1>0 then ((isnull((select M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@ReturL1)  else 0 end  f, " +
                            "case when @TotalPotongL1>0 then ((isnull((select M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@DefectFinL1)  else 0 end g, " +
                            " " + query1 + " " +
                            //" case when @TotalPotongL1>0 then "+
                            //"isnull((select isnull(cast(M3 as decimal(10,2)),0)M3 from tempTotalSerahDfctM3 where [group]=BM_PlantGroup.[Group]),0) / "+
                            //"isnull((select isnull(cast(M3 as decimal(10,2)),0)M3 from tempTotalBPM3 where [group]=BM_PlantGroup.[Group]),0) else 0 end j "+
                            " from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 1') )A " +

                            "union all  " +

                            "select 'Total' [Group],sum(b)+sum(h) b,sum(c)c,sum(d)d,sum(e)e,sum(f)f,sum(h)h,sum(c)-sum(d)+sum(e)+sum(f) i " +
                            //"((sum(c)-sum(d)+sum(e)+sum(f))/(sum(b)+sum(h)))*100 j from ( " +
                            ",case when (sum(b)+sum(h))=0 then 0 else ((sum(c)-sum(d)+sum(e)+sum(f))/(sum(b)+sum(h)))*100 end j from ( " +
                            "select [Group],case when @TotalPotongL1>0 then " +
                            //"isnull((select isnull(cast(M3 as decimal(10,2)),0)M3 from tempTotalSerahDfctM3 where [group]=BM_PlantGroup.[Group]),0) else 0 end b,  " +
                            "isnull((select isnull(cast(M3 as decimal(10,2)),0)M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group]),0) else 0 end b,  " +
                            " case when @TotalPotongL1>0 then isnull((select M3 from tempDataDefectBM_m3 where [group]=BM_PlantGroup.[Group] ),0)  else 0 end c, " +
                            " case when @TotalPotongL1>0 then ((isnull((select M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@Ttotalkw1kw2L1) else 0 end  d, " +
                            " case when @TotalPotongL1>0 then ((isnull((select M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@NCSortirL1)  else 0 end  e, " +
                            " case when @TotalPotongL1>0 then ((isnull((select M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@ReturL1)  else 0 end  f, " +
                            " case when @TotalPotongL1>0 then ((isnull((select M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@DefectFinL1)  else 0 end g, " +
                            " " + query2 + " " +
                            " case when @TotalPotongL1>0 then " +
                            "isnull((select isnull(cast(M3 as decimal(10,2)),0)M3 from tempTotalSerahDfctM3 where [group]=BM_PlantGroup.[Group]),0) / " +
                            "isnull((select isnull(cast(M3 as decimal(10,2)),0)M3 from tempDataDefectBM_m3 where [group]=BM_PlantGroup.[Group]),0) else 0 end j,0 i " +
                            "from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 1'))A )B " +
                            " end " +
                            " else " +
                            " begin " +
                            " select '' [group],0 b,0 c,0 d,0 e,0 f,0 h,0 i, 0 j into tempdefectL1 " +
                            " end " +
                            " " +

                            "update SPD_Trans set actual=(select j from tempdefectL1 where [group]='total') where approval=0 and Tahun =" + ddTahun.SelectedValue + " and Bulan=" + ddlBulan.SelectedValue.ToString() + " and sarmutdeptid in ( " +
                            "select ID from SPD_Departemen where SarmutDepartemen='Line 1' and SarmutPID in (select ID from SPD_Perusahaan where SarMutPerusahaan ='Defect Board Mill')) " +
                            /** end Area tempdefectL1 **/
                        #endregion

                        #region tempdefectL2
                            /** Area tempdefectL2 **/
                            "declare @TotalPotongL2 decimal(18,2) " +
                            "declare @TotDefKhususL2 decimal(18,2) " +
                            "declare @DefKhususL2 decimal(18,2) " +
                            "declare @Ttotalkw1kw2L2 decimal(18,2) " +
                            "declare @NCSortirL2 decimal(18,2) " +
                            "declare @ReturL2 decimal(18,2) " +
                            "declare @DefectFinL2 decimal(18,2) " +

                            //"set @TotalPotongL2=(select sum(totkubik ) from tempdefectGPIsoTot where [group]in (select [group] from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 2'))) " +
                            //"set @TotalPotongL2=(select isnull(sum(M3),0)M3 from ( " +
                            //"select isnull(sum(M3),0)M3 from tempTtlSerah_m33 where [group] in (select [group] from BM_PlantGroup " +
                            //"where PlantID in (select id from BM_Plant where PlantName='line 2')) " +
                            //"union all " +
                            //"select isnull(sum(M3),0)M3 from tempDataDefectBM_m3 where [group] in (select [group] from BM_PlantGroup " +
                            //"where PlantID in (select id from BM_Plant where PlantName='line 2'))) as x) " +

                            "set @TotalPotongL2=(select isnull(sum(M3),0)M3 from ( " +
                            "select isnull(sum(M3),0)M3 from tempTtlSerah_m33 where [group] in (select [group] from BM_PlantGroup " +
                            "where PlantID in (select id from BM_Plant where PlantName='line 2'))) as x) " +

                            "set @TotDefKhususL2=(@TotalPotongL2/@TotalPotong)*@TotalDefKhusus " +
                            "set @DefKhususL2=(@TotalPotongL2/@TotalPotong)*@DefKhusus " +
                            "set @Ttotalkw1kw2L2=(@TotalPotongL2/@TotalPotong)*@Ttotalkw1kw2 " +
                            "set @NCSortirL2=(@TotalPotongL2/@TotalPotong)*@NCSortir " +
                            "set @ReturL2=(@TotalPotongL2/@TotalPotong)*@Retur " +
                            "set @DefectFinL2=isnull((@TotalPotongL2/@TotalPotong)*@DefectFin,0) " +
                            "declare @SelisihTotalPotongL2 decimal(18,2) " +
                            "set @SelisihTotalPotongL2=(@TotalPotongL2/@TotalPotong)*@SelisihTotalPotong " +

                            "if @TotalPotongL2>0 " +
                            "begin " +
                            "select * into tempdefectL2 from ( " +
                            //"select [Group],b+h b,c,d,e,f,h,c-d+e+f i,case when b>0 then ((c-d+e+f)/(b+h))*100  else 0  end j from ( " +
                            "select [Group],b+h b,c,d,e,f,h,c-d+e+f i,case when (b+h)=0 then 0 else ((c-d+e+f)/(b+h))*100 end j from ( " +
                            "select [Group],case when @TotalPotongL2>0 then " +
                            "isnull((select isnull(cast(M3 as decimal(10,2)),0)M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group]),0) else 0 end b,  " +
                            "case when @TotalPotongL2>0 then isnull((select M3 from tempDataDefectBM_m3 where [group]=BM_PlantGroup.[Group] ),0)  else 0 end c, " +
                            "case when @TotalPotongL2>0 then ((isnull((select M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL2)*@Ttotalkw1kw2L2) else 0 end  d, " +
                            "case when @TotalPotongL2>0 then ((isnull((select M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL2)*@NCSortirL2) else 0 end  e, " +
                            "case when @TotalPotongL2>0 then ((isnull((select M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL2)*@ReturL2)  else 0 end f, " +
                            "case when @TotalPotongL2>0 then ((isnull((select M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL2)*@DefectFinL2) else 0 end  g, " +
                            " " + query3 + " " +
                            "from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 2') )A " +
                            "union all  " +
                            "select 'Total' [Group],sum(b)+sum(h) b,sum(c)c,sum(d)d,sum(e)e,sum(f)f,sum(h)h,sum(c)-sum(d)+sum(e)+sum(f) i " +
                            //",((sum(c)-sum(d)+sum(e)+sum(f))/sum(b))*100 j from( " +
                            ",case when (sum(b)+sum(h))=0 then 0 else ((sum(c)-sum(d)+sum(e)+sum(f))/(sum(b)+sum(h)))*100 end j from ( " +
                            "select [Group],case when @TotalPotongL2>0 then " +
                            "isnull((select isnull(cast(M3 as decimal(10,2)),0)M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group]),0) else 0 end b,  " +
                            "case when @TotalPotongL2>0 then isnull((select M3 from tempDataDefectBM_m3 where [group]=BM_PlantGroup.[Group] ),0)  else 0 end c, " +
                            "case when @TotalPotongL2>0 then ((isnull((select M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL2)*@Ttotalkw1kw2L2) else 0 end  d, " +
                            "case when @TotalPotongL2>0 then ((isnull((select M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL2)*@NCSortirL2) else 0 end  e, " +
                            "case when @TotalPotongL2>0 then ((isnull((select M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL2)*@ReturL2)  else 0 end f, " +
                            "case when @TotalPotongL2>0 then ((isnull((select M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL2)*@DefectFinL2) else 0 end  g, " +
                            " " + query4 + " " +
                            " 0 i,0 j from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 2'))A )B " +
                            " end " +
                            " else " +
                            " begin " +
                            " select '' [group],0 b,0 c,0 d,0 e,0 f,0 h,0 i, 0 j into tempdefectL2 " +
                            " end " +
                            " " +
                            "update SPD_Trans set actual=(select j from tempdefectL2 where [group]='total') where approval=0 and Tahun =" + ddTahun.SelectedValue + " and Bulan=" + ddlBulan.SelectedValue.ToString() + " and sarmutdeptid in ( " +
                            "select ID from SPD_Departemen where SarmutDepartemen='Line 2' and SarmutPID in (select ID from SPD_Perusahaan where SarMutPerusahaan ='Defect Board Mill')) " +
                            /** end Area tempdefectL2 **/
                        #endregion

                        #region tempdefectL3
                            /** Area tempdefectL3 **/
                            "declare @TotalPotongL3 decimal(18,2) " +
                            "declare @TotDefKhususL3 decimal(18,2) " +
                            "declare @DefKhususL3 decimal(18,2) " +
                            "declare @Ttotalkw1kw2L3 decimal(18,2) " +
                            "declare @NCSortirL3 decimal(18,2) " +
                            "declare @ReturL3 decimal(18,2) " +
                            "declare @DefectFinL3 decimal(18,2) " +

                            //"set @TotalPotongL3=(select sum(totkubik ) from tempdefectGPIsoTot where [group]in (select [group] from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 3'))) " +
                            //"set @TotalPotongL3=(select isnull(sum(M3),0)M3 from ( " +
                            //"select isnull(sum(M3),0)M3 from tempTtlSerah_m33 where [group] in (select [group] from BM_PlantGroup " +
                            //"where PlantID in (select id from BM_Plant where PlantName='line 3')) " +
                            //"union all " +
                            //"select isnull(sum(M3),0)M3 from tempDataDefectBM_m3 where [group] in (select [group] from BM_PlantGroup " +
                            //"where PlantID in (select id from BM_Plant where PlantName='line 3'))) as x) " +

                            "set @TotalPotongL3=(select isnull(sum(M3),0)M3 from ( " +
                            "select isnull(sum(M3),0)M3 from tempTtlSerah_m33 where [group] in (select [group] from BM_PlantGroup " +
                            "where PlantID in (select id from BM_Plant where PlantName='line 3'))) as x) " +

                            "set @TotDefKhususL3=(@TotalPotongL3/@TotalPotong)*@TotalDefKhusus " +
                            "set @DefKhususL3=(@TotalPotongL3/@TotalPotong)*@DefKhusus " +
                            "set @Ttotalkw1kw2L3=(@TotalPotongL3/@TotalPotong)*@Ttotalkw1kw2 " +
                            "set @NCSortirL3=(@TotalPotongL3/@TotalPotong)*@NCSortir " +
                            "set @ReturL3=(@TotalPotongL3/@TotalPotong)*@Retur " +
                            "set @DefectFinL3=isnull((@TotalPotongL3/@TotalPotong)*@DefectFin,0) " +
                            "declare @SelisihTotalPotongL3 decimal(18,2) " +
                            "set @SelisihTotalPotongL3=(@TotalPotongL3/@TotalPotong)*@SelisihTotalPotong " +

                            "if @TotalPotongL3>0 " +
                            "begin " +
                            "select * into tempdefectL3 from ( " +
                            //"select [Group],b+h b,c,d,e,f,h,c-d+e+f i,case when b>0 then ((c-d+e+f)/(b+h))*100 else 0  end j from ( " +
                            "select [Group],b+h b,c,d,e,f,h,c-d+e+f i,case when (b+h)=0 then 0 else ((c-d+e+f)/(b+h))*100 end j from ( " +
                            "select [Group],case when @TotalPotongL3>0 then " +
                            "isnull((select isnull(cast(M3 as decimal(10,2)),0)M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group]),0) else 0 end b,  " +
                            "case when @TotalPotongL3>0 then isnull((select M3 from tempDataDefectBM_m3 where [group]=BM_PlantGroup.[Group] ),0)  else 0 end c, " +
                            "case when @TotalPotongL3>0 then ((isnull((select M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@Ttotalkw1kw2L3) else 0 end  d, " +
                            "case when @TotalPotongL3>0 then ((isnull((select M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@NCSortirL3) else 0 end  e, " +
                            "case when @TotalPotongL3>0 then ((isnull((select M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@ReturL3) else 0 end  f, " +
                            "case when @TotalPotongL3>0 then ((isnull((select M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@DefectFinL3) else 0 end  g, " +
                            " " + query5 + " " +
                            "from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 3') )A " +
                            "union all  " +
                            "select 'Total' [Group],sum(b)+sum(h) b,sum(c)c,sum(d)d,sum(e)e,sum(f)f,sum(h)h,sum(c)-sum(d)+sum(e)+sum(f) i " +
                            //",((sum(c)-sum(d)+sum(e)+sum(f))/sum(b))*100 j from( " +
                            ",case when (sum(b)+sum(h))=0 then 0 else ((sum(c)-sum(d)+sum(e)+sum(f))/(sum(b)+sum(h)))*100 end j from ( " +
                            "select [Group], " +
                            "isnull((select isnull(cast(M3 as decimal(10,2)),0)M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group]),0) b,  " +
                            "isnull((select M3 from tempDataDefectBM_m3 where [group]=BM_PlantGroup.[Group] ),0)c, " +
                            "((isnull((select M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@Ttotalkw1kw2L3) d, " +
                            "((isnull((select M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@NCSortirL3) e, " +
                            "((isnull((select M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@ReturL3) f, " +
                            "((isnull((select M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@DefectFinL3) g, " +
                            " " + query6 + " " +
                            " 0 i,0 j from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 3'))A )B " +
                            " end " +
                            " else " +
                            " begin " +
                            " select '' [group],0 b,0 c,0 d,0 e,0 f,0 h,0 i, 0 j into tempdefectL3 " +
                            " end " +
                            " " +

                            "update SPD_Trans set actual=(select j from tempdefectL3 where [group]='total') where approval=0 and Tahun =" + ddTahun.SelectedValue + " and Bulan=" + ddlBulan.SelectedValue.ToString() + " and sarmutdeptid in ( " +
                            "select ID from SPD_Departemen where SarmutDepartemen='Line 3' and SarmutPID in (select ID from SPD_Perusahaan where SarMutPerusahaan ='Defect Board Mill')) " +
                            //** end Area tempdefectL3 **/
                        #endregion

                        #region tempdefectL4
                            //** Area tempdefectL4 **/
                            "declare @TotalPotongL4 decimal(18,2) " +
                            "declare @TotDefKhususL4 decimal(18,2) " +
                            "declare @DefKhususL4 decimal(18,2) " +
                            "declare @Ttotalkw1kw2L4 decimal(18,2) " +
                            "declare @NCSortirL4 decimal(18,2) " +
                            "declare @ReturL4 decimal(18,2) " +
                            "declare @DefectFinL4 decimal(18,2) " +
                            //"set @TotalPotongL4=(select sum(totkubik ) from tempdefectGPIsoTot where [group]in (select [group] from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 4'))) " +
                            //"set @TotalPotongL4=(select isnull(sum(M3),0)M3 from ( " +
                            //"select isnull(sum(M3),0)M3 from tempTtlSerah_m33 where [group] in (select [group] from BM_PlantGroup " +
                            //"where PlantID in (select id from BM_Plant where PlantName='line 4')) " +
                            //"union all " +
                            //"select isnull(sum(M3),0)M3 from tempDataDefectBM_m3 where [group] in (select [group] from BM_PlantGroup " +
                            //"where PlantID in (select id from BM_Plant where PlantName='line 4'))) as x) " +

                            "set @TotalPotongL4=(select isnull(sum(M3),0)M3 from ( " +
                            "select isnull(sum(M3),0)M3 from tempTtlSerah_m33 where [group] in (select [group] from BM_PlantGroup " +
                            "where PlantID in (select id from BM_Plant where PlantName='line 4'))) as x) " +

                            "set @TotDefKhususL4=(@TotalPotongL4/@TotalPotong)*@TotalDefKhusus " +
                            "set @DefKhususL4=(@TotalPotongL4/@TotalPotong)*@DefKhusus " +
                            "set @Ttotalkw1kw2L4=(@TotalPotongL4/@TotalPotong)*@Ttotalkw1kw2 " +
                            "set @NCSortirL4=(@TotalPotongL4/@TotalPotong)*@NCSortir " +
                            "set @ReturL4=(@TotalPotongL4/@TotalPotong)*@Retur " +
                            "set @DefectFinL4=isnull((@TotalPotongL4/@TotalPotong)*@DefectFin,0) " +
                            "declare @SelisihTotalPotongL4 decimal(18,2) " +
                            "set @SelisihTotalPotongL4=(@TotalPotongL4/@TotalPotong)*@SelisihTotalPotong " +


                            "if @TotalPotongL4>0 " +
                            "begin " +
                            "select * into tempdefectL4 from ( " +
                            //"select [Group],b+h b,c,d,e,f,h,c-d+e+f i,case when b>0 then ((c-d+e+f)/(b+h))*100 else 0  end j from ( " +
                            "select [Group],b+h b,c,d,e,f,h,c-d+e+f i,case when (b+h)=0 then 0 else ((c-d+e+f)/(b+h))*100 end j from ( " +
                            "select [Group],case when @TotalPotongL4>0 then " +
                            "isnull((select isnull(cast(M3 as decimal(10,2)),0)M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group]),0) else 0 end b,  " +
                            " case when @TotalPotongL4>0 then isnull((select M3 from tempDataDefectBM_m3 where [group]=BM_PlantGroup.[Group] ),0)  else 0 end c, " +
                            " case when @TotalPotongL4>0 then ((isnull((select M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@Ttotalkw1kw2L4) else 0 end  d, " +
                            " case when @TotalPotongL4>0 then ((isnull((select M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@NCSortirL4) else 0 end  e, " +
                            " case when @TotalPotongL4>0 then ((isnull((select M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@ReturL4) else 0 end  f, " +
                            " case when @TotalPotongL4>0 then ((isnull((select M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@DefectFinL4) else 0 end  g, " +
                            " " + query7 + " " +
                            "from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 4') )A " +
                            "union all  " +
                            "select 'Total' [Group],sum(b)+sum(h) b,sum(c)c,sum(d)d,sum(e)e,sum(f)f,sum(h)h,sum(c)-sum(d)+sum(e)+sum(f) i " +
                            //",((sum(c)-sum(d)+sum(e)+sum(f))/sum(b))*100 j from( " +
                            ",case when (sum(b)+sum(h))=0 then 0 else ((sum(c)-sum(d)+sum(e)+sum(f))/(sum(b)+sum(h)))*100 end j from ( " +
                            "select [Group], " +
                            "isnull((select isnull(cast(M3 as decimal(10,2)),0)M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group]),0) b,  " +
                            " isnull((select M3 from tempDataDefectBM_m3 where [group]=BM_PlantGroup.[Group] ),0)c, " +
                            " ((isnull((select M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@Ttotalkw1kw2L4) d, " +
                            " ((isnull((select M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@NCSortirL4) e, " +
                            " ((isnull((select M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@ReturL4) f, " +
                            " ((isnull((select M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@DefectFinL4) g, " +
                            " " + query8 + " " +
                            " 0 i,0 j from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 4'))A )B " +
                            " end " +
                            " else " +
                            " begin " +
                            " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 h,0 i, 0 j into tempdefectL4 " +
                            " end " +
                            " " +

                            "update SPD_Trans set actual=(select j from tempdefectL4 where [group]='total') where approval=0 and Tahun =" + ddTahun.SelectedValue + " and Bulan=" + ddlBulan.SelectedValue.ToString() + " and sarmutdeptid in ( " +
                            "select ID from SPD_Departemen where SarmutDepartemen='Line 4' and SarmutPID in (select ID from SPD_Perusahaan where SarMutPerusahaan ='Defect Board Mill')) " +
                            //** end Area tempdefectL4 **/
                        #endregion

                        #region tempdefectL5
                            //** Area tempdefectL5 **/
                            "declare @TotalPotongL5 decimal(18,2) " +
                            "declare @TotDefKhususL5 decimal(18,2) " +
                            "declare @DefKhususL5 decimal(18,2) " +
                            "declare @Ttotalkw1kw2L5 decimal(18,2) " +
                            "declare @NCSortirL5 decimal(18,2) " +
                            "declare @ReturL5 decimal(18,2) " +
                            "declare @DefectFinL5 decimal(18,2) " +

                            //"set @TotalPotongL5=(select sum(totkubik ) from tempdefectGPIsoTot where [group]in (select [group] from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 5'))) " +
                            //"set @TotalPotongL5=(select isnull(sum(M3),0)M3 from ( " +
                            //"select isnull(sum(M3),0)M3 from tempTtlSerah_m33 where [group] in (select [group] from BM_PlantGroup " +
                            //"where PlantID in (select id from BM_Plant where PlantName='line 5')) " +
                            //"union all " +
                            //"select isnull(sum(M3),0)M3 from tempDataDefectBM_m3 where [group] in (select [group] from BM_PlantGroup " +
                            //"where PlantID in (select id from BM_Plant where PlantName='line 5'))) as x) " +

                            "set @TotalPotongL5=(select isnull(sum(M3),0)M3 from ( " +
                            "select isnull(sum(M3),0)M3 from tempTtlSerah_m33 where [group] in (select [group] from BM_PlantGroup " +
                            "where PlantID in (select id from BM_Plant where PlantName='line 5'))) as x) " +

                            "set @TotDefKhususL5=(@TotalPotongL5/@TotalPotong)*@TotalDefKhusus " +
                            "set @DefKhususL5=(@TotalPotongL5/@TotalPotong)*@DefKhusus " +
                            "set @Ttotalkw1kw2L5=(@TotalPotongL5/@TotalPotong)*@Ttotalkw1kw2 " +
                            "set @NCSortirL5=(@TotalPotongL5/@TotalPotong)*@NCSortir " +
                            "set @ReturL5=(@TotalPotongL5/@TotalPotong)*@Retur " +
                            "set @DefectFinL5=isnull((@TotalPotongL5/@TotalPotong)*@DefectFin,0) " +
                            "declare @SelisihTotalPotongL5 decimal(18,2) " +
                            "set @SelisihTotalPotongL5=(@TotalPotongL5/@TotalPotong)*@SelisihTotalPotong " +

                            "if @TotalPotongL5>0 " +
                            "begin " +
                            "select * into tempdefectL5 from ( " +
                            //"select [Group],b+h b,c,d,e,f,h,c-d+e+f i,case when b>0 then ((c-d+e+f)/b)*100 else 0  end j from ( " +
                            "select [Group],b+h b,c,d,e,f,h,c-d+e+f i,case when (b+h)=0 then 0 else ((c-d+e+f)/(b+h))*100 end j from ( " +
                            "select [Group],case when @TotalPotongL5>0 then " +
                            "isnull((select isnull(cast(M3 as decimal(10,2)),0)M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group]),0) else 0 end b,  " +
                            "case when @TotalPotongL5>0 then isnull((select M3 from tempDataDefectBM_m3 where [group]=BM_PlantGroup.[Group] ),0)  else 0 end c, " +
                            "case when @TotalPotongL5>0 then ((isnull((select M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@Ttotalkw1kw2L5) else 0 end  d, " +
                            "case when @TotalPotongL5>0 then ((isnull((select M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@NCSortirL5) else 0 end  e, " +
                            "case when @TotalPotongL5>0 then ((isnull((select M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@ReturL5) else 0 end  f, " +
                            "case when @TotalPotongL5>0 then ((isnull((select M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@DefectFinL5) else 0 end  g, " +
                            " " + query9 + " " +
                            "from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 5') )A " +
                            "union all  " +
                            "select 'Total' [Group],sum(b)+sum(h) b,sum(c)c,sum(d)d,sum(e)e,sum(f)f,sum(h)h,sum(c)-sum(d)+sum(e)+sum(f) i " +
                            //",((sum(c)-sum(d)+sum(e)+sum(f))/sum(b))*100 j from( " +
                            ",case when (sum(b)+sum(h))=0 then 0 else ((sum(c)-sum(d)+sum(e)+sum(f))/(sum(b)+sum(h)))*100 end j from ( " +
                            "select [Group], " +
                            "isnull((select isnull(cast(M3 as decimal(10,2)),0)M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group]),0) b,  " +
                            " isnull((select M3 from tempDataDefectBM_m3 where [group]=BM_PlantGroup.[Group] ),0) c, " +
                            " ((isnull((select M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@Ttotalkw1kw2L5) d, " +
                            " ((isnull((select M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@NCSortirL5) e, " +
                            " ((isnull((select M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@ReturL5) f, " +
                            " ((isnull((select M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@DefectFinL5) g, " +
                            " " + query10 + " " +
                            " 0 i,0 j from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 5'))A )B " +
                            " end " +
                            " else " +
                            " begin " +
                            " select '' [group],0 b,0 c,0 d,0 e,0 f,0 h,0 i, 0 j into tempdefectL5 " +
                            " end " +
                            " " +

                            "update SPD_Trans set actual=(select j from tempdefectL5 where [group]='total') where approval=0 and Tahun =" + ddTahun.SelectedValue + " and Bulan=" + ddlBulan.SelectedValue.ToString() + " and sarmutdeptid in ( " +
                            "select ID from SPD_Departemen where SarmutDepartemen='Line 5' and SarmutPID in (select ID from SPD_Perusahaan where SarMutPerusahaan ='Defect Board Mill')) " +
                            //** Area tempdefectL5 **/
                        #endregion

                        #region tempdefectL6
                            //** Area tempdefectL6 **/
                            "declare @TotalPotongL6 decimal(18,2) " +
                            "declare @TotDefKhususL6 decimal(18,2) " +
                            "declare @DefKhususL6 decimal(18,2) " +
                            "declare @Ttotalkw1kw2L6 decimal(18,2) " +
                            "declare @NCSortirL6 decimal(18,2) " +
                            "declare @ReturL6 decimal(18,2) " +
                            "declare @DefectFinL6 decimal(18,2) " +

                            //"set @TotalPotongL6=(select sum(totkubik ) from tempdefectGPIsoTot where [group]in (select [group] from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 6'))) " +
                            //"set @TotalPotongL6=(select isnull(sum(M3),0)M3 from ( " +
                            //"select isnull(sum(M3),0)M3 from tempTtlSerah_m33 where [group] in (select [group] from BM_PlantGroup " +
                            //"where PlantID in (select id from BM_Plant where PlantName='line 6')) " +
                            //"union all " +
                            //"select isnull(sum(M3),0)M3 from tempDataDefectBM_m3 where [group] in (select [group] from BM_PlantGroup " +
                            //"where PlantID in (select id from BM_Plant where PlantName='line 6'))) as x) " +

                            "set @TotalPotongL6=(select isnull(sum(M3),0)M3 from ( " +
                            "select isnull(sum(M3),0)M3 from tempTtlSerah_m33 where [group] in (select [group] from BM_PlantGroup " +
                            "where PlantID in (select id from BM_Plant where PlantName='line 6'))) as x) " +

                            "set @TotDefKhususL6=(@TotalPotongL6/@TotalPotong)*@TotalDefKhusus " +
                            "set @DefKhususL6=(@TotalPotongL6/@TotalPotong)*@DefKhusus " +
                            "set @Ttotalkw1kw2L6=(@TotalPotongL6/@TotalPotong)*@Ttotalkw1kw2 " +
                            "set @NCSortirL6=(@TotalPotongL6/@TotalPotong)*@NCSortir " +
                            "set @ReturL6=(@TotalPotongL6/@TotalPotong)*@Retur " +
                            "set @DefectFinL6=isnull((@TotalPotongL6/@TotalPotong)*@DefectFin,0) " +
                            "declare @SelisihTotalPotongL6 decimal(18,2) " +
                            "set @SelisihTotalPotongL6=(@TotalPotongL6/@TotalPotong)*@SelisihTotalPotong " +

                            "if @TotalPotongL6>0 " +
                            "begin " +
                            "select * into tempdefectL6 from ( " +
                            "select [Group],b+h b,c,d,e,f,h,c-d+e+f i " +
                            ",case when (b+h)=0 then 0 else ((c-d+e+f)/(b+h))*100 end j from ( " +
                            "select [Group],case when @TotalPotongL6>0 then " +
                            "isnull((select isnull(cast(M3 as decimal(10,2)),0)M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group]),0) else 0 end b,  " +
                            " case when @TotalPotongL6>0 then isnull((select M3 from tempDataDefectBM_m3 where [group]=BM_PlantGroup.[Group] ),0)  else 0 end c, " +
                            " case when @TotalPotongL6>0 then ((isnull((select M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@Ttotalkw1kw2L6)  else 0 end d, " +
                            " case when @TotalPotongL6>0 then ((isnull((select M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@NCSortirL6)  else 0 end e, " +
                            " case when @TotalPotongL6>0 then ((isnull((select M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@ReturL6)  else 0 end f, " +
                            " case when @TotalPotongL6>0 then ((isnull((select M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@DefectFinL6)  else 0 end g, " +
                            " " + query11 + " " +
                            "  from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 6') )A " +
                            "union all  " +
                            "select 'Total' [Group],sum(b)+sum(h) b,sum(c)c,sum(d)d,sum(e)e,sum(f)f,sum(h)h,sum(c)-sum(d)+sum(e)+sum(f) i " +
                            //",((sum(c)-sum(d)+sum(e)+sum(f))/sum(b))*100 j from( " +
                            ",case when (sum(b)+sum(h))=0 then 0 else ((sum(c)-sum(d)+sum(e)+sum(f))/(sum(b)+sum(h)))*100 end j from ( " +
                            "select [Group], " +
                            "isnull((select isnull(cast(M3 as decimal(10,2)),0)M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group]),0) b,  " +
                            "isnull((select M3 from tempDataDefectBM_m3 where [group]=BM_PlantGroup.[Group] ),0) c, " +
                            "((isnull((select M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@Ttotalkw1kw2L6) d, " +
                            "((isnull((select M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@NCSortirL6) e, " +
                            "((isnull((select M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@ReturL6) f, " +
                            "((isnull((select M3 from tempTtlSerah_m33 where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@DefectFinL6) g, " +
                            " " + query12 + " " +
                            " 0 i,0 j from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 6'))A )B " +
                            " end " +
                            " else " +
                            " begin " +
                            " select '' [group],0 b,0 c,0 d,0 e,0 f,0 h,0 i, 0 j into tempdefectL6 " +
                            " end " +
                            " " +
                            " end " +
                            " else " +
                            " begin " +
                            " select '' [group],0 b,0 c,0 d,0 e,0 f,0 h,0 i, 0 j into tempdefectL1 " +
                            " select '' [group],0 b,0 c,0 d,0 e,0 f,0 h,0 i, 0 j into tempdefectL2 " +
                            " select '' [group],0 b,0 c,0 d,0 e,0 f,0 h,0 i, 0 j into tempdefectL3 " +
                            " select '' [group],0 b,0 c,0 d,0 e,0 f,0 h,0 i, 0 j into tempdefectL4 " +
                            " select '' [group],0 b,0 c,0 d,0 e,0 f,0 h,0 i, 0 j into tempdefectL5 " +
                            " select '' [group],0 b,0 c,0 d,0 e,0 f,0 h,0 i, 0 j into tempdefectL6 " +
                            " end " +
                            " select * from tempdefectL1 order by [group] " +

                            "update SPD_Trans set actual=(select j from tempdefectL6 where [group]='total') where approval=0 and Tahun =" + ddTahun.SelectedValue + " and Bulan=" + ddlBulan.SelectedValue.ToString() + " and sarmutdeptid in ( " +
                            "select ID from SPD_Departemen where SarmutDepartemen='Line 6' and SarmutPID in (select ID from SPD_Perusahaan where SarMutPerusahaan ='Defect Board Mill')) ";
                        //** end Area tempdefectL6 **/
                        #endregion
                    }
                    #endregion
                    #region Periode TerBaru added 30 Oktober 2020
                    else if (Convert.ToInt32(strtgl1.Substring(0, 6)) > 202008 && Convert.ToInt32(strtgl1.Substring(0, 6)) < 202103 && users.UnitKerjaID.ToString() != "13")
                    {
                        string Query1 = string.Empty; string Query2 = string.Empty; string Query3 = string.Empty;
                        if (users.UnitKerjaID == 1)
                        {
                            Query1 =
                             " when Line=1 then 'CA,CB,CC,CD' " +
                             " when Line=2 then 'CE,CF,CG,CH' " +
                             " when Line=3 then 'CI,CJ,CK,CL' " +
                             " when Line=4 then 'CM,CN,CO,CP' ";

                            Query2 =
                            " union all  " +
                            " select 'CA,CB,CC,CD'[Group],'1'Line,'0'M3,'0'Qty  " +
                            " union all  " +
                            " select 'CE,CF,CG,CH'[Group],'2'Line,'0'M3,'0'Qty  " +
                            " union all " +
                            " select 'CI,CJ,CK,CL'[Group],'3'Line,'0'M3,'0'Qty  " +
                            " union all  " +
                            " select 'CM,CN,CO,CP'[Group],'4'Line,'0'M3,'0'Qty  ";

                            Query3 =
                            " union all  " +
                            " select 'CA,CB,CC,CD'[Group],'1'Line,'0'M3 " +
                            " union all  " +
                            " select 'CE,CF,CG,CH'[Group],'2'Line,'0'M3 " +
                            " union all " +
                            " select 'CI,CJ,CK,CL'[Group],'3'Line,'0'M3 " +
                            " union all  " +
                            " select 'CM,CN,CO,CP'[Group],'4'Line,'0'M3 ";

                        }
                        else if (users.UnitKerjaID == 7)
                        {
                            Query1 =
                            " when Line=1 then 'KA,KB,KC,KD' " +
                            " when Line=2 then 'KE,KF,KG,KH' " +
                            " when Line=3 then 'KI,KJ,KK,KL' " +
                            " when Line=4 then 'KM,KN,KO,KP' " +
                            " when Line=5 then 'KQ,KR,KS,KT' " +
                            " when Line=6 then 'KU,KV,KW,KX' ";

                            Query2 =
                            " union all  " +
                            " select 'KA,KB,KC,KD'[Group],'1'Line,'0'M3,'0'Qty  " +
                            " union all  " +
                            " select 'KE,KF,KG,KH'[Group],'2'Line,'0'M3,'0'Qty  " +
                            " union all " +
                            " select 'KI,KJ,KK,KL'[Group],'3'Line,'0'M3,'0'Qty  " +
                            " union all  " +
                            " select 'KM,KN,KO,KP'[Group],'4'Line,'0'M3,'0'Qty  " +
                            " union all  " +
                            " select 'KQ,KR,KS,KT'[Group],'5'Line,'0'M3,'0'Qty  " +
                            " union all  " +
                            " select 'KQ,KR,KS,KT'[Group],'6'Line,'0'M3,'0'Qty ";

                            Query3 =
                            " union all  " +
                            " select 'KA,KB,KC,KD'[Group],'1'Line,'0'M3  " +
                            " union all  " +
                            " select 'KE,KF,KG,KH'[Group],'2'Line,'0'M3  " +
                            " union all " +
                            " select 'KI,KJ,KK,KL'[Group],'3'Line,'0'M3  " +
                            " union all  " +
                            " select 'KM,KN,KO,KP'[Group],'4'Line,'0'M3  " +
                            " union all  " +
                            " select 'KQ,KR,KS,KT'[Group],'5'Line,'0'M3  " +
                            " union all  " +
                            " select 'KQ,KR,KS,KT'[Group],'6'Line,'0'M3 ";
                        }
                        else
                        {
                            Query1 =
                             " when Line=1 then 'JA,JB,JC,JD' " +
                             " when Line=2 then 'JE,JF,JG,JH' " +
                             " when Line=3 then 'JI,JJ,JK,JL' " +
                             " when Line=4 then 'JM,JN,JO,JP' ";

                            Query2 =
                            " union all  " +
                            " select 'JA,JB,JC,JD'[Group],'1'Line,'0'M3,'0'Qty  " +
                            " union all  " +
                            " select 'JE,JF,JG,JH'[Group],'2'Line,'0'M3,'0'Qty  " +
                            " union all " +
                            " select 'JI,JJ,JK,JL'[Group],'3'Line,'0'M3,'0'Qty  " +
                            " union all  " +
                            " select 'JM,JN,JO,JP'[Group],'4'Line,'0'M3,'0'Qty  ";

                            Query3 =
                            " union all  " +
                            " select 'JA,JB,JC,JD'[Group],'1'Line,'0'M3  " +
                            " union all  " +
                            " select 'JE,JF,JG,JH'[Group],'2'Line,'0'M3  " +
                            " union all " +
                            " select 'JI,JJ,JK,JL'[Group],'3'Line,'0'M3  " +
                            " union all  " +
                            " select 'JM,JN,JO,JP'[Group],'4'Line,'0'M3  ";
                        }

                        string New1 = string.Empty; string New2 = string.Empty; string New3 = string.Empty; string New4 = string.Empty;
                        string New5 = string.Empty; string New6 = string.Empty; string New7 = string.Empty; string New8 = string.Empty;
                        string New9 = string.Empty; string New10 = string.Empty; string New11 = string.Empty; string New12 = string.Empty;
                        string Old1 = string.Empty; string Old2 = string.Empty; string Old3 = string.Empty; string Old4 = string.Empty;
                        string Old5 = string.Empty; string Old6 = string.Empty; string Old7 = string.Empty; string Old8 = string.Empty;
                        string Old9 = string.Empty; string Old10 = string.Empty; string Old11 = string.Empty; string Old12 = string.Empty;

                        if (Convert.ToInt32(strtgl1.Substring(0, 6)) > 202102 && users.UnitKerjaID == 1)
                        {
                            Old1 = ""; Old2 = ""; Old3 = ""; Old4 = ""; Old5 = ""; Old6 = ""; Old7 = ""; Old8 = ""; Old9 = ""; Old10 = ""; Old11 = "";

                            New1 =
                            " select *,(select top 1 B.ThnBln from Bm04 B where B.Part=A.Part order by B.ThnBln desc)Flag into Link0  " +
                            " from tes1 A " +

                            " select PartNo,M3,Qty,Line  into tes2  from ( " +
                            " select A.PartNo,Persen*M3/100 M3,A.Qty,PlantID Line  from Link0 A " +
                            " left join Bm04 B ON substring(A.PartNo,1,9)=B.Part  and A.Flag=B.ThnBln " +
                            " ) as x group by PartNo,M3,Qty,Line ";

                            New2 =
                            " select *,(select top 1 B.ThnBln from Bm04 B where B.Part=substring(A.PartNo,1,9) order by B.ThnBln desc)Flag into Link  " +
                            " from tesLPRs1_m3 A " +
                            " select A.PartNo,Persen*M3/100 M3,A.Qty,PlantID Line into tesLPRs2_m3 from Link A " +
                            " left join Bm04 B ON substring(A.PartNo,1,9)=B.Part  and A.Flag=B.ThnBln ";

                            New3 =
                            " select *,(select top 1 B.ThnBln from Bm04 B where B.Part=substring(A.PartNo,1,9) order by B.ThnBln desc)Flag into Link1 " +
                            " from tesSAwal_RS_m3 A " +
                            " select A.PartNo,Persen*M3/100 M3,A.Qty,PlantID Line into tesSAwal_RS1_m3 from Link1 A " +
                            " left join Bm04 B ON substring(A.PartNo,1,9)=B.Part  and A.Flag=B.ThnBln ";
                            New4 =
                            " select *,(select top 1 B.ThnBln from Bm04 B where B.Part=substring(A.PartNo,1,9) order by B.ThnBln desc)Flag into Link2 " +
                            " from tesSAkhir_RS A " +
                            " select A.PartNo,Persen*M3/100 M3,A.Qty,PlantID Line into tesSAkhir_RS1 from Link2 A " +
                            " left join Bm04 B ON substring(A.PartNo,1,9)=B.Part  and A.Flag=B.ThnBln ";
                            New5 =
                            " select *,(select top 1 B.ThnBln from Bm04 B where B.Part=substring(A.PartNo,1,9) order by B.ThnBln desc)Flag into Link3 " +
                            " from tesSAwal_Bv A " +
                            " select A.PartNo,Persen*M3/100 M3,A.Qty,PlantID Line into tesSAwal_Bv1 from Link3 A " +
                            " left join Bm04 B ON substring(A.PartNo,1,9)=B.Part  and A.Flag=B.ThnBln ";
                            New6 =
                            " select *,(select top 1 B.ThnBln from Bm04 B where B.Part=substring(A.PartNo,1,9) order by B.ThnBln desc)Flag into Link4  " +
                            " from tesSAkhir_Bv A " +
                            " select A.PartNo,Persen*M3/100 M3,A.Qty,PlantID Line into tesSAkhir_Bv1 from Link4 A " +
                            " left join Bm04 B ON substring(A.PartNo,1,9)=B.Part  and A.Flag=B.ThnBln ";
                            New7 =
                            " select *,(select top 1 B.ThnBln from Bm04 B where B.Part=substring(A.PartNo,1,9) order by B.ThnBln desc)Flag into Link5 " +
                            " from tesSAwal_Str A " +
                            " select A.PartNo,Persen*M3/100 M3,A.Qty,PlantID Line into tesSAwal_Str1 from Link5 A  " +
                            " left join Bm04 B ON substring(A.PartNo,1,9)=B.Part  and A.Flag=B.ThnBln ";
                            New8 =
                            " select *,(select top 1 B.ThnBln from Bm04 B where B.Part=substring(A.PartNo,1,9) order by B.ThnBln desc)Flag into Link6 " +
                            " from tesSAkhir_Str A " +
                            " select A.PartNo,Persen*M3/100 M3,A.Qty,PlantID Line into tesSAkhir_Str1 from Link6 A " +
                            " left join Bm04 B ON substring(A.PartNo,1,9)=B.Part  and A.Flag=B.ThnBln ";
                            New9 =
                            " select *,(select top 1 B.ThnBln from Bm04 B where B.Part=substring(A.PartNo,1,9) order by B.ThnBln desc)Flag into Link7  " +
                            " from tesTahap3_OK A " +
                            " select A.PartNo,Persen*M3/100 M3,A.Qty,PlantID Line into tesTahap3_OK1 from Link7 A " +
                            " left join Bm04 B ON substring(A.PartNo,1,9)=B.Part  and A.Flag=B.ThnBln ";
                            New10 =
                            " select *,(select top 1 B.ThnBln from Bm04 B where B.Part=substring(A.PartNo,1,9) order by B.ThnBln desc)Flag into Link8  " +
                            " from tesTahap3_BP A " +
                            " select A.PartNo,Persen*M3/100 M3,A.Qty,PlantID Line into tesTahap3_BP1 from Link8 A  " +
                            " left join Bm04 B ON substring(A.PartNo,1,9)=B.Part  and A.Flag=B.ThnBln ";
                            New11 =
                            " select *,(select top 1 B.ThnBln from Bm04 B where B.Part=A.Part order by B.ThnBln desc)Flag into Link9 " +
                            " from tempDef1_OKBP A " +
                            " select A.PartNo,Persen*M3/100 M3,A.Qty,PlantID Line into tempDef2_OKBP from Link9 A " +
                            " left join Bm04 B ON A.Part=B.Part  and A.Flag=B.ThnBln ";
                        }
                        else
                        {
                            New1 = ""; New2 = ""; New3 = ""; New4 = ""; New5 = ""; New6 = ""; New7 = ""; New8 = ""; New9 = ""; New10 = ""; New11 = "";
                            Old1 =
                            " select A.PartNo,A.Qty,case when B.Prosen=100 then A.M3 else A.M3*B.Prosen/100 end M3,B.Line,B.Prosen into tes2 from tes1 A left join Def_UKhususProsen B ON A.PartNo=B.Partno " +
                            " where left(convert(char,B.Periode,112),6)=left(convert(char,@thnbln1,112),6) and B.Noted='Defect ukuran khusus' ";
                            Old2 =
                            " select A.PartNo,case when B.Prosen=100 then A.M3 else A.M3*B.Prosen/100 end M3,A.Qty,B.Line,B.Prosen into tesLPRs2_m3 from tesLPRs1_m3 A left join Def_UKhususProsen B ON A.PartNo=B.Partno " +
                            " where B.Noted='Defect ListPlank'  and left(convert(char,B.Periode,112),6)=left(convert(char,@thnbln1,112),6) ";
                            Old3 =
                            " select A.PartNo,A.Qty,case when B.Prosen=100 then A.M3 else A.M3*B.Prosen/100 end M3,B.Line,B.Prosen into tesSAwal_RS1_m3 from tesSAwal_RS_m3 A left join Def_UKhususProsen B ON A.PartNo=B.Partno  where B.Noted='Defect ListPlank' and left(convert(char,B.Periode,112),6)=left(convert(char,@thnbln1,112),6)  ";
                            Old4 =
                            " select A.PartNo,case when B.Prosen=100 then A.M3 else A.M3*B.Prosen/100 end M3,A.Qty,B.Line,B.Prosen into tesSAkhir_RS1 from tesSAkhir_RS A left join Def_UKhususProsen B ON A.PartNo=B.Partno  where B.Noted='Defect ListPlank' and left(convert(char,B.Periode,112),6)=left(convert(char,@thnbln1,112),6) ";
                            Old5 =
                            " select A.PartNo,case when B.Prosen=100 then A.M3 else A.M3*B.Prosen/100 end M3,A.Qty,B.Line,B.Prosen into tesSAwal_Bv1 from tesSAwal_Bv A left join Def_UKhususProsen B ON A.PartNo=B.Partno  where B.Noted='Defect ListPlank' and left(convert(char,B.Periode,112),6)=left(convert(char,@thnbln1,112),6)  ";
                            Old6 =
                            " select A.PartNo,case when B.Prosen=100 then A.M3 else A.M3*B.Prosen/100 end M3,A.Qty,B.Line,B.Prosen into tesSAkhir_Bv1 from tesSAkhir_Bv A left join Def_UKhususProsen B ON A.PartNo=B.Partno  where B.Noted='Defect ListPlank' and left(convert(char,B.Periode,112),6)=left(convert(char,@thnbln1,112),6)   ";
                            Old7 =
                            " select A.PartNo,case when B.Prosen=100 then A.M3 else A.M3*B.Prosen/100 end M3,A.Qty,B.Line,B.Prosen into tesSAwal_Str1 from tesSAwal_Str A left join Def_UKhususProsen B ON A.PartNo=B.Partno  where B.Noted='Defect ListPlank' and  left(convert(char,B.Periode,112),6)=left(convert(char,@thnbln1,112),6)  ";
                            Old8 =
                            " select A.PartNo,case when B.Prosen=100 then A.M3 else A.M3*B.Prosen/100 end M3,A.Qty,B.Line,B.Prosen into tesSAkhir_Str1 from tesSAkhir_Str A left join Def_UKhususProsen B ON A.PartNo=B.Partno  where B.Noted='Defect ListPlank' and left(convert(char,B.Periode,112),6)=left(convert(char,@thnbln1,112),6)  ";
                            Old9 =
                            " select A.PartNo,case when B.Prosen=100 then A.M3 else A.M3*B.Prosen/100 end M3,A.Qty,B.Line,B.Prosen into tesTahap3_OK1 from tesTahap3_OK A left join Def_UKhususProsen B ON A.PartNo=B.Partno  where B.Noted='Defect ListPlank' and left(convert(char,B.Periode,112),6)=left(convert(char,@thnbln1,112),6) ";
                            Old10 =
                            " select A.PartNo,case when B.Prosen=100 then A.M3 else A.M3*B.Prosen/100 end M3,A.Qty,B.Line,B.Prosen into tesTahap3_BP1 from tesTahap3_BP A left join Def_UKhususProsen B ON A.PartNo=B.Partno  where B.Noted='Defect ListPlank' and left(convert(char,B.Periode,112),6)=left(convert(char,@thnbln1,112),6)  ";
                            Old11 =
                            " select A.PartNo,A.Qty,case when B.Prosen2=100 then A.M3 else (B.Prosen2*A.M3)/100 end M3,B.Line,B.Prosen2 into tempDef2_OKBP  from tempDef1_OKBP A left join Def_UKhususProsen B ON A.PartNo=B.Partno where B.Noted='Defect ukuran khusus'  and left(convert(char,B.Periode,112),6)=left(convert(char,@thnbln1,112),6) ";
                        }
                        if (users.UnitKerjaID == 7)
                        {
                            New1 = ""; New2 = ""; New3 = ""; New4 = ""; New5 = ""; New6 = ""; New7 = ""; New8 = ""; New9 = ""; New10 = ""; New11 = "";
                            Old1 =
                            " select A.PartNo,A.Qty,case when B.Prosen=100 then A.M3 else A.M3*B.Prosen/100 end M3,B.Line,B.Prosen into tes2 from tes1 A left join Def_UKhususProsen B ON A.PartNo=B.Partno " +
                            " where left(convert(char,B.Periode,112),6)=left(convert(char,@thnbln1,112),6) and B.Noted='Defect ukuran khusus' ";
                            Old2 =
                            " select A.PartNo,case when B.Prosen=100 then A.M3 else A.M3*B.Prosen/100 end M3,A.Qty,B.Line,B.Prosen into tesLPRs2_m3 from tesLPRs1_m3 A left join Def_UKhususProsen B ON A.PartNo=B.Partno " +
                            " where B.Noted='Defect ListPlank'  and left(convert(char,B.Periode,112),6)=left(convert(char,@thnbln1,112),6) ";
                            Old3 =
                            " select A.PartNo,A.Qty,case when B.Prosen=100 then A.M3 else A.M3*B.Prosen/100 end M3,B.Line,B.Prosen into tesSAwal_RS1_m3 from tesSAwal_RS_m3 A left join Def_UKhususProsen B ON A.PartNo=B.Partno  where B.Noted='Defect ListPlank' and left(convert(char,B.Periode,112),6)=left(convert(char,@thnbln1,112),6)  ";
                            Old4 =
                            " select A.PartNo,case when B.Prosen=100 then A.M3 else A.M3*B.Prosen/100 end M3,A.Qty,B.Line,B.Prosen into tesSAkhir_RS1 from tesSAkhir_RS A left join Def_UKhususProsen B ON A.PartNo=B.Partno  where B.Noted='Defect ListPlank' and left(convert(char,B.Periode,112),6)=left(convert(char,@thnbln1,112),6) ";
                            Old5 =
                            " select A.PartNo,case when B.Prosen=100 then A.M3 else A.M3*B.Prosen/100 end M3,A.Qty,B.Line,B.Prosen into tesSAwal_Bv1 from tesSAwal_Bv A left join Def_UKhususProsen B ON A.PartNo=B.Partno  where B.Noted='Defect ListPlank' and left(convert(char,B.Periode,112),6)=left(convert(char,@thnbln1,112),6)  ";
                            Old6 =
                            " select A.PartNo,case when B.Prosen=100 then A.M3 else A.M3*B.Prosen/100 end M3,A.Qty,B.Line,B.Prosen into tesSAkhir_Bv1 from tesSAkhir_Bv A left join Def_UKhususProsen B ON A.PartNo=B.Partno  where B.Noted='Defect ListPlank' and left(convert(char,B.Periode,112),6)=left(convert(char,@thnbln1,112),6)   ";
                            Old7 =
                            " select A.PartNo,case when B.Prosen=100 then A.M3 else A.M3*B.Prosen/100 end M3,A.Qty,B.Line,B.Prosen into tesSAwal_Str1 from tesSAwal_Str A left join Def_UKhususProsen B ON A.PartNo=B.Partno  where B.Noted='Defect ListPlank' and  left(convert(char,B.Periode,112),6)=left(convert(char,@thnbln1,112),6)  ";
                            Old8 =
                            " select A.PartNo,case when B.Prosen=100 then A.M3 else A.M3*B.Prosen/100 end M3,A.Qty,B.Line,B.Prosen into tesSAkhir_Str1 from tesSAkhir_Str A left join Def_UKhususProsen B ON A.PartNo=B.Partno  where B.Noted='Defect ListPlank' and left(convert(char,B.Periode,112),6)=left(convert(char,@thnbln1,112),6)  ";
                            Old9 =
                            " select A.PartNo,case when B.Prosen=100 then A.M3 else A.M3*B.Prosen/100 end M3,A.Qty,B.Line,B.Prosen into tesTahap3_OK1 from tesTahap3_OK A left join Def_UKhususProsen B ON A.PartNo=B.Partno  where B.Noted='Defect ListPlank' and left(convert(char,B.Periode,112),6)=left(convert(char,@thnbln1,112),6) ";
                            Old10 =
                            " select A.PartNo,case when B.Prosen=100 then A.M3 else A.M3*B.Prosen/100 end M3,A.Qty,B.Line,B.Prosen into tesTahap3_BP1 from tesTahap3_BP A left join Def_UKhususProsen B ON A.PartNo=B.Partno  where B.Noted='Defect ListPlank' and left(convert(char,B.Periode,112),6)=left(convert(char,@thnbln1,112),6)  ";
                            Old11 =
                            " select A.PartNo,A.Qty,case when B.Prosen2=100 then A.M3 else (B.Prosen2*A.M3)/100 end M3,B.Line,B.Prosen2 into tempDef2_OKBP  from tempDef1_OKBP A left join Def_UKhususProsen B ON A.PartNo=B.Partno where B.Noted='Defect ukuran khusus'  and left(convert(char,B.Periode,112),6)=left(convert(char,@thnbln1,112),6) ";
                        }


                        strSQL =
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectGPIso]') AND type in (N'U')) DROP TABLE [dbo].[tempdefectGPIso] " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectGPIsoTot]') AND type in (N'U')) DROP TABLE [dbo].tempdefectGPIsoTot  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectFin]') AND type in (N'U')) DROP TABLE [dbo].tempdefectFin  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectL1]') AND type in (N'U')) DROP TABLE [dbo].tempdefectL1 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectL2]') AND type in (N'U')) DROP TABLE [dbo].tempdefectL2 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectL3]') AND type in (N'U')) DROP TABLE [dbo].tempdefectL3 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectL4]') AND type in (N'U')) DROP TABLE [dbo].tempdefectL4 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectL5]') AND type in (N'U')) DROP TABLE [dbo].tempdefectL5 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectL6]') AND type in (N'U')) DROP TABLE [dbo].tempdefectL6 " +

                        " /** Baru **/ " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectGPIso2]') AND type in (N'U')) DROP TABLE [dbo].tempdefectGPIso2 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[detailDfctSystemBM_M3]') AND type in (N'U')) DROP TABLE [dbo].detailDfctSystemBM_M3 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[DtlDefectSystemFN_M3]') AND type in (N'U')) DROP TABLE [dbo].DtlDefectSystemFN_M3 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[DtlSelisih_M3]') AND type in (N'U')) DROP TABLE [dbo].DtlSelisih_M3 " +
                        " /** end Baru **/ " +

                        " declare @thnbln1 varchar(8) declare @thnbln2 varchar(8) declare @BlnThn varchar(6) " +

                        " set @thnbln1='" + strtgl1 + "' " +
                        " set @thnbln2='" + strtgl2 + "' " +
                        " set @BlnThn='" + Periode + "' " +

                        " select *  into tempdefectGPIso from (  select case when D.DeptID=0 then  case when GJ.GroupJemurName In ('M','N','O','P','Q','R','S','T','U','V','W','X') then " +
                        " case when D.DefName='retak' then 2 when D.DefName='gompal' then 3 else D.DeptID end else " +
                        " case when (B.Qty/E.Qty) *100 >5 then 2 else 3 end   end  else D.DeptID end deptID1,A.CreatedTime as tglInput,A.Tgl as TglPeriksa, " +
                        " E.TglProduksi as TglProd,  D.DefCode,BP.PlantName as Line, PG.[Group],BF.FormulaCode as Jenis,D.DefName,D.DeptID,B.ID,B.DefectID, " +
                        " B.MasterID,B.Qty,A.ID  DestID,isnull(A.TPotong,0)  QtyIn, " +
                        " I.Volume*B.Qty Kubik,isnull(A.TPotong,0) as TotPotong,'' sfrom  " +
                        " from Def_DefectDetail B " +
                        " inner join Def_Defect A on A.Id=B.DefectID   " +
                        " left join Def_MasterDefect D on B.MasterID=D.ID " +
                        " left join BM_Destacking E on E.ID=A.DestID  " +
                        " left join BM_PlantGroup PG on A.GroupProdID=PG.ID " +
                        " left join BM_Formula BF on BF.ID=E.FormulaID   " +
                        " left join BM_Plant BP on BP.ID=E.PlantID " +
                        " left join FC_Items I on I.ID=E.ItemID " +
                        " inner join Def_GroupJemur GJ on GJ.ID=A.GroupJemurID  " +
                        " where B.RowStatus>-1  and D.RowStatus >-1) as Def    " +
                        " where DeptID1=2 and CONVERT(varchar,TglPeriksa,112)>=@thnbln1 and CONVERT(varchar,TglPeriksa,112)<=@thnbln2   " +

                        " /** Baru **/ " +
                        " declare @ttlDefectBM decimal(10,5) " +
                        " declare @ttlDefectFN decimal(10,5) " +
                        " declare @Selisih_ttl_defect decimal(10,5) " +
                        " declare @dtlSelisih_ttl_defect decimal(10,5) " +
                        " declare @Selisih_ttl_defect2 decimal(10,5) " +
                        " declare @TtlDfctSystemBM_M3 decimal(10,5) " +
                        " declare @TtlDfctSystemFN_M3 decimal(10,5) " +
                        " declare @TtlDfctBMFN_M3 decimal(10,5) " +
                        " declare @TtlDefectBM_M3 decimal(10,5) " +
                        " declare @TtlDfctBMFN_M3_OKKW decimal(10,5) " +

                        " select * into tempdefectGPIso2 " +
                        " from (  select case when D.DeptID=0 then  case when GJ.GroupJemurName In ('M','N','O','P','Q','R','S','T','U','V','W','X') then  " +
                        " case when D.DefName='retak' then 2 when D.DefName='gompal' then 3 else D.DeptID end else case when (B.Qty/E.Qty) *100 >5 then 2 " +
                        " else 3 end   end  else D.DeptID end deptID1,A.CreatedTime as tglInput,A.Tgl as TglPeriksa,E.TglProduksi as TglProd, " +
                        " D.DefCode,BP.PlantName as Line, PG.[Group],BF.FormulaCode as Jenis,D.DefName,D.DeptID,B.ID,B.DefectID,B.MasterID,B.Qty,A.ID " +
                        " DestID,isnull(A.TPotong,0)  QtyIn,B.Qty*I.Volume as Kubik,isnull(A.TPotong,0) as TotPotong,'' sfrom  " +
                        " from Def_DefectDetail B inner join Def_Defect A on A.Id=B.DefectID   left join Def_MasterDefect D on B.MasterID=D.ID " +
                        " left join BM_Destacking E on E.ID=A.DestID   left join BM_PlantGroup PG on A.GroupProdID=PG.ID " +
                        " left join BM_Formula BF on BF.ID=E.FormulaID    left join BM_Plant BP on BP.ID=E.PlantID left join FC_Items I on I.ID=E.ItemID " +
                        " inner join Def_GroupJemur GJ on GJ.ID=A.GroupJemurID  where B.RowStatus>-1  and D.RowStatus >-1) as Def  " +
                        " where DeptID1=3 and CONVERT(varchar,TglPeriksa,112)>=@thnbln1 and CONVERT(varchar,TglPeriksa,112)<=@thnbln2  " +

                        " /** Detail data transaksi Defect System BM per Group **/ " +
                        " select [Group],round(M3,1)M3 into detailDfctSystemBM_M3 from ( " +
                        " select [Group],round(sum(kubik),2) M3  from tempdefectGPIso group by [Group] ) as x " +
                        " /** end Detail Defect System BM **/ " +

                        " /** Total Defect BM dan Finishing BP**/ " +
                        " set @TtlDfctBMFN_M3 = ( " +
                        " select round(sum(M3),1)BP_M3  from ( " +
                        " select sum(Qty)Qty,sum(M3)M3 from ( " +
                        " select *,round((Qty*Volume),2)M3 from ( " +
                        " select sum(A.qty *-1) Qty,(B.Tebal*B.Lebar*B.Panjang)/1000000000 Volume from vw_KartustockWIP A  " +
                        " inner join FC_Items B ON A.itemid0=B.ID " +
                        " where qty<0   and lokasi='B99' and process<>'lari' and process<>'listplank' and left(convert(char,tanggal,112),8)>=@thnbln1 and " +
                        " left(convert(char,tanggal,112),8)<=@thnbln2   group by tebal,lebar,panjang ) as x ) as x1 " +
                        " union all " +
                        " select sum(Qty)Qty,sum(M3)M3 from ( " +
                        " select *,round((Qty*Volume),2)M3 from ( " +
                        " select isnull(SUM(qty)*-1,0)Qty,(A.Tebal*A.Lebar*A.Panjang)/1000000000 Volume from vw_KartustockWIP2 V  " +
                        " inner join FC_Items I on V.itemID=I.ID inner join FC_Items A ON A.ID=V.itemid0 and (I.partno  like '%-p-%'  ) " +
                        " where qty<0  and idrec not like '%ou%'    and process='lari'and lokid1 not in (select ID from fc_lokasi where lokasi='I99') and " +
                        " left(convert(char,tanggal,112),8)>=@thnbln1 and left(convert(char,tanggal,112),8)<=@thnbln2  group by A.tebal,A.lebar,A.panjang) as x ) as x1 ) as xx ) " +
                        " /** Total Defect BM dan Finishing BP**/ " +

                        " /** Total Defect BM dan Finishing OK KW **/ " +
                        " set @TtlDfctBMFN_M3_OKKW = ( " +
                        " select round(sum(M3),1)BP_M3  from ( " +
                        " select sum(Qty)Qty,sum(M3)M3 from ( " +
                        " select *,round((Qty*Volume),2)M3 from ( " +
                        " select sum(A.qty *-1) Qty,(B.Tebal*B.Lebar*B.Panjang)/1000000000 Volume from vw_KartustockWIP A  " +
                        " inner join FC_Items B ON A.itemid0=B.ID " +
                        " where qty<0   and lokasi='H99' and process<>'lari' and process<>'listplank' and left(convert(char,tanggal,112),8)>=@thnbln1 " +
                        " and left(convert(char,tanggal,112),8)<=@thnbln2   group by tebal,lebar,panjang ) as x ) as x1 " +
                        " union all " +
                        " select sum(Qty)Qty,sum(M3)M3 from ( " +
                        " select *,round((Qty*Volume),2)M3 from ( " +
                        " select isnull(SUM(qty)*-1,0)Qty,(A.Tebal*A.Lebar*A.Panjang)/1000000000 Volume from vw_KartustockWIP2 V  " +
                        " inner join FC_Items I on V.itemID=I.ID inner join FC_Items A ON A.ID=V.itemid0 and (I.partno  like '%-3-%' or I.partno  like '%-M-%'  )     " +
                        " where qty<0  and idrec not like '%ou%'    and process='lari'and lokid1 not in (select ID from fc_lokasi where lokasi='I99') and " +
                        " left(convert(char,tanggal,112),8)>=@thnbln1 and left(convert(char,tanggal,112),8)<=@thnbln2  group by A.tebal,A.lebar,A.panjang) as x ) as x1 ) as xx ) " +
                        " /** Total Defect BM dan Finishing OK KW **/ " +

                        " set @TtlDfctSystemBM_M3 = (select M3 from (select round(sum(M3),3)M3 from detailDfctSystemBM_M3) as x) " +
                        " set @TtlDfctSystemFN_M3 = (select M3 from (select round(sum(kubik),5)M3 from tempdefectGPIso2) as x) " +
                        " set @TtlDefectBM_M3 = (select M3 from (select round(sum(M3),3)M3 from detailDfctSystemBM_M3) as x) " +

                        " /** Detail data transaksi Defect System Finishing per Group **/ " +
                        "  select [Group],round(((round(M3,6)/@TtlDfctSystemBM_M3)*@TtlDfctSystemFN_M3),6)M3 into DtlDefectSystemFN_M3 from detailDfctSystemBM_M3  " +
                        " /** End Detail data transaksi Defect System Finishing per Group **/ " +

                        " set @Selisih_ttl_defect = (select @TtlDfctBMFN_M3 - round(@TtlDefectBM_M3,5) - round(@TtlDfctSystemFN_M3,4)) " +
                        " select [Group],round((M3/@TtlDfctSystemBM_M3)*@Selisih_ttl_defect,4) M3 into DtlSelisih_M3 from detailDfctSystemBM_M3 order by [group] " +

                        /** Tambahan **/
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Bm01]') AND type in (N'U')) DROP TABLE [dbo].Bm01 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Bm02]') AND type in (N'U')) DROP TABLE [dbo].Bm02 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Bm03]') AND type in (N'U')) DROP TABLE [dbo].Bm03 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Bm04]') AND type in (N'U')) DROP TABLE [dbo].Bm04 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Bm05]') AND type in (N'U')) DROP TABLE [dbo].Bm05 " +

                        " select * into Bm01 from ( " +
                        " select distinct ItemID,PlantID,left(convert(char,tglproduksi,112),6)ThnBln from BM_Destacking where RowStatus>-1 " +
                        " group by ItemID,PlantiD,TglProduksi " +
                        " ) as x order by ThnBln,ItemID desc " +

                        " select * into Bm02 from ( " +
                        " select *,(select count(ItemID) from Bm01 B where B.ItemID=A.ItemID and B.ThnBln=A.ThnBln and ItemID>0)ttl " +
                        " from Bm01 A where ItemID>0) as x " +

                        " select *,case when ttl=0 then 0 else cast(100 as decimal(10,2))/cast(ttl as decimal(10,2)) end PerSen into Bm03 " +
                        " from Bm02 order by ThnBln desc " +

                        " select Substring(B.PartNo,1,9)Part,A.* into Bm04 from Bm03 A inner join FC_Items B ON A.ItemID=B.ID " +
                        " select ItemID,ThnBln into Bm05 from Bm04 group by ItemID,ThnBln " +
                        /** End Tambahan **/

                        " /** Defect Ukuran Khusus BP **/ " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tes1]') AND type in (N'U')) DROP TABLE [dbo].tes1 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tes2]') AND type in (N'U')) DROP TABLE [dbo].tes2 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tes3]') AND type in (N'U')) DROP TABLE [dbo].tes3 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tes4]') AND type in (N'U')) DROP TABLE [dbo].tes4 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tes5]') AND type in (N'U')) DROP TABLE [dbo].tes5 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDefectUKhusus]') AND type in (N'U')) DROP TABLE [dbo].tempDefectUKhusus " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Link0]') AND type in (N'U')) DROP TABLE [dbo].Link0 " +

                        " select * into tes1  from (  " +
                        " select SUBSTRING(replace(x.partno,',',''),1,9)Part,SUBSTRING(replace(x.partno,',',''),1,17)PartNo,x.PartnoAsal,x.Qty,((A.Tebal*A.Lebar*A.Panjang)/1000000000)*x.Qty M3 from (  " +
                        " select REPLACE(substring(Keterangan,0,19),'-P-','-1-')Partno,PartNo PartnoAsal,ItemID,isnull(SUM(Qty),0)  * -1 Qty from vw_KartuStockBJNew " +
                        " where qty <0 and (process  like '%simetris%' ) and  (/**Keterangan like '%-3-%' or Keterangan like '%-w-%' or " +
                        " Keterangan like '%-m-%' or **/Keterangan like '%-P-%') and  LokID not In (select ID from FC_Lokasi where lokasi='q99')  " +
                        " and left(convert(char,tanggal,112),8)>=@thnbln1 and  left(convert(char,tanggal,112),8)<=@thnbln2 and ItemID in (select ID " +
                        " from FC_Items where PartNo like'%-1-%' ) group by ItemID,Keterangan,PartNo   " +
                        " ) as x  inner join FC_Items A ON A.ID=x.ItemID ) as xx " +

                        //" select A.PartNo,A.Qty,case when B.Prosen=100 then A.M3 else A.M3*B.Prosen/100 end M3,B.Line,B.Prosen into tes2 from tes1 A left join Def_UKhususProsen B ON A.PartNo=B.Partno " +
                        //"  where left(convert(char,B.Periode,112),6)=left(convert(char,@thnbln1,112),6) and B.Noted='Defect ukuran khusus' " +

                        " " + New1 + " " +
                        " " + Old1 + " " +

                        " select Line,round(sum(M3),2) M3 into tes3 from ( " +
                        " select * from tes2 ) as x group by Line " +

                        " select case " +
                        " " + Query1 + " " +
                        " end [Group],* into tes4 from tes3 " +

                        " SELECT A.[Line],   " +
                        "     Split.a.value('.', 'VARCHAR(100)') AS [Group]  ,round((M3/4),3) M3 into tes5 " +
                        " FROM  (SELECT [Line],   " +
                        "        CAST ('<M>' + REPLACE([Group], ',', '</M><M>') + '</M>' AS XML) AS String  ,M3 " +
                        "   FROM  tes4) AS A CROSS APPLY String.nodes ('/M') AS Split(a); " +

                        " select [Group],round(M3,3)M3 into tempDefectUKhusus from tes5  " +
                        " /** End Defect Ukuran Khusus BP **/ " +

                        " /** Defect Ukuran Khusus OK **/ " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tes1_OK]') AND type in (N'U')) DROP TABLE [dbo].tes1_OK  " +

                        " select * into tes1_OK from ( " +
                        " select SUBSTRING(A.partno,1,9)Part,A.PartNo,x.*,((A.Tebal*A.Lebar*A.Panjang)/1000000000)*x.Qty M3 from ( " +
                        " select ItemID,isnull(SUM(Qty),0)  * -1 Qty from vw_KartuStockBJNew where qty <0 and (process  like '%simetris%' ) and " +
                        " (Keterangan like '%-3-%' or Keterangan like '%-w-%' or Keterangan like '%-m-%') and LokID not In (select ID from FC_Lokasi where lokasi='q99') " +
                        " and left(convert(char,tanggal,112),8)>=@thnbln1 and left(convert(char,tanggal,112),8)<=@thnbln2 and ItemID in (select ID from FC_Items where PartNo like'%-1-%') " +
                        " /**and CutID in (select ID from T3_Simetris where RowStatus>-1 and QtyOut>QtyIn)**/ group by ItemID ) as x inner join FC_Items A ON A.ID=x.ItemID ) as xx " +
                        " /** End Defect Ukuran Khusus OK **/ " +

                        " /** Defect ListPlank **/ " +
                        " /** 1. Out Running Saw **/ " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesLPRs1_m3]') AND type in (N'U')) DROP TABLE [dbo].tesLPRs1_m3 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesLPRs2_m3]') AND type in (N'U')) DROP TABLE [dbo].tesLPRs2_m3 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesLPRs3_m3]') AND type in (N'U')) DROP TABLE [dbo].tesLPRs3_m3  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesLPRs4_m3]') AND type in (N'U')) DROP TABLE [dbo].tesLPRs4_m3  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesLPRs5_m3]') AND type in (N'U')) DROP TABLE [dbo].tesLPRs5_m3  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempRSOut_m3]') AND type in (N'U')) DROP TABLE [dbo].tempRSOut_m3  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Link]') AND type in (N'U')) DROP TABLE [dbo].Link " +

                        " select PartNo,sum(Qty)Qty,round(sum(M3),4)M3 into tesLPRs1_m3 from ( " +
                        " select PartNo,Qty,round(((Tebal*Lebar*Panjang)/1000000000)*Qty,4)M3  from ( " +
                        " select PartNo,PartNo2,sum(Qty)Qty,Tebal,Lebar,Panjang  from ( " +
                        " select x1.PartNo,x2.PartNo PartNo2,x2.Tebal,x2.Lebar,x2.Panjang,x.Qty from ( " +
                        " select ItemID0,itemid,Qty * -1 Qty from vw_KartuStockListplank where left(convert(char,tanggal,112),8)>=@thnbln1 and " +
                        " left(convert(char,tanggal,112),8)<=@thnbln2 and process='runingsaw' and qty<0 ) as x  " +
                        " inner join FC_Items x1 ON x.ItemID0=x1.ID " +
                        " inner join FC_Items x2 ON x.ItemID=x2.ID) as A group by PartNo,PartNo2,Tebal,Lebar,Panjang ) as xx ) as xx1 group by PartNo  " +

                        //" select A.PartNo,case when B.Prosen=100 then A.M3 else A.M3*B.Prosen/100 end M3,A.Qty,B.Line,B.Prosen into tesLPRs2_m3 from tesLPRs1_m3 A left join Def_UKhususProsen B ON A.PartNo=B.Partno " +
                        //" where B.Noted='Defect ListPlank'  and left(convert(char,B.Periode,112),6)=left(convert(char,@thnbln1,112),6) " +
                        "" + New2 + "" +
                        "" + Old2 + "" +

                        " select Line,sum(M3)M3,sum(Qty)Qty into tesLPRs3_m3 from ( " +
                        " select * from tesLPRs2_m3 ) as x group by Line " +

                        " select [Group],Line ,cast(sum(M3) as decimal(10,5))M3,sum(Qty)Qty into tesLPRs4_m3  from (  " +
                        " select case " +
                        //" when Line=1 then 'KA,KB,KC,KD' when Line=2 then 'KE,KF,KG,KH' when Line=3 then 'KI,KJ,KK,KL' when Line=4 then 'KM,KN,KO,KP' "+
                        //" when Line=5 then 'KQ,KR,KS,KT' when Line=6 then 'KU,KV,KW,KX' "+
                        " " + Query1 + " " +
                        " end [Group],Line,round(M3,5)M3,Qty from tesLPRs3_m3  " +
                        //" union all  "+
                        //" select 'KA,KB,KC,KD'[Group],'1'Line,'0'M3,'0'Qty  "+
                        //" union all  "+
                        //" select 'KE,KF,KG,KH'[Group],'2'Line,'0'M3,'0'Qty  "+
                        //" union all "+
                        //" select 'KI,KJ,KK,KL'[Group],'3'Line,'0'M3,'0'Qty  "+
                        //" union all  "+
                        //" select 'KM,KN,KO,KP'[Group],'4'Line,'0'M3,'0'Qty  "+
                        //" union all  "+
                        //" select 'KQ,KR,KS,KT'[Group],'5'Line,'0'M3,'0'Qty  "+
                        //" union all  "+
                        //" select 'KQ,KR,KS,KT'[Group],'6'Line,'0'M3,'0'Qty "+
                        " " + Query2 + " " +
                        " ) as x group by [Group],Line   " +

                        " SELECT A.[Line],Split.a.value('.', 'VARCHAR(100)') AS [Group]  ,round((Qty/4),4) Qty,round((M3/4),4) M3 into tesLPRs5_m3 " +
                        " FROM  (SELECT [Line],CAST ('<M>' + REPLACE([Group], ',', '</M><M>') + '</M>' AS XML) AS String,M3,Qty FROM  tesLPRs4_m3) AS A " +
                        " CROSS APPLY String.nodes ('/M') AS Split(a); " +

                        " select Line,round(M3,5)M3 into tempRSOut_m3 from tesLPRs5_m3 order by Line " +
                        " /** 1 End **/ " +

                        " /** 2. Saldo Awal Running Saw **/ " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesSAwal_RS_m3]') AND type in (N'U')) DROP TABLE [dbo].tesSAwal_RS_m3   " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesSAwal_RS1_m3]') AND type in (N'U')) DROP TABLE [dbo].tesSAwal_RS1_m3  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesSAwal_RS2_m3]') AND type in (N'U')) DROP TABLE [dbo].tesSAwal_RS2_m3  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesSAwal_RS3_m3]') AND type in (N'U')) DROP TABLE [dbo].tesSAwal_RS3_m3  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempSAwal_RS_m3]') AND type in (N'U')) DROP TABLE [dbo].tempSAwal_RS_m3  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Link1]') AND type in (N'U')) DROP TABLE [dbo].Link1 " +

                        " select PartNo,sum((Volume*Qty))M3,sum(Qty)Qty into tesSAwal_RS_m3 " +
                        " from (  select x2.PartNo,cast(((x1.Tebal*x1.Lebar*x1.Panjang)/1000000000) as decimal(10,5))Volume,x.Qty " +
                        " from (  select sum(saldo)Qty ,ItemID,ItemID0 from T1_SaldoListPlank where Process='runingsaw' and thnbln=@BlnThn and Saldo>0 " +
                        " and ItemID<>ItemID0 group by ItemID,ItemID0 ) as x   " +
                        " inner join FC_Items x1 ON x.ItemID=x1.ID " +
                        " inner join FC_Items x2 ON x.ItemID0=x2.ID) as A group by PartNo " +

                        //" select A.PartNo,A.Qty,case when B.Prosen=100 then A.M3 else A.M3*B.Prosen/100 end M3,B.Line,B.Prosen into tesSAwal_RS1_m3 from tesSAwal_RS_m3 A left join Def_UKhususProsen B ON A.PartNo=B.Partno " +
                        //" where B.Noted='Defect ListPlank' and left(convert(char,B.Periode,112),6)=left(convert(char,@thnbln1,112),6) " +
                        " " + New3 + " " +
                        " " + Old3 + " " +

                        " select sum(M3)M3,sum(Qty)Qty,Line into tesSAwal_RS2_m3 from tesSAwal_RS1_m3 group by Line " +

                        " select [Group],Line ,cast(sum(M3) as decimal(10,5))M3,sum(Qty)Qty into tesSAwal_RS3_m3 from ( " +
                        " select case " +
                        " " + Query1 + " " +
                        " end [Group],Line,round(M3,5)M3,Qty " +
                        " from tesSAwal_RS2_m3 " +
                        " " + Query2 + " " +
                        " ) as x group by [Group],Line  " +

                        " select Line,sum(M3)M3 into tempSAwal_RS_m3 from tesSAwal_RS3_m3  group by Line " +
                        " /** 2 End **/ " +

                        " /** 3. Saldo Akhir RunningSaw **/ " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesSAkhir_RS]') AND type in (N'U')) DROP TABLE [dbo].tesSAkhir_RS " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesSAkhir_RS1]') AND type in (N'U')) DROP TABLE [dbo].tesSAkhir_RS1 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesSAkhir_RS2]') AND type in (N'U')) DROP TABLE [dbo].tesSAkhir_RS2  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesSAkhir_RS3]') AND type in (N'U')) DROP TABLE [dbo].tesSAkhir_RS3 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesSAkhir_RS4]') AND type in (N'U')) DROP TABLE [dbo].tesSAkhir_RS4 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempSAkhir_RS_m3]') AND type in (N'U')) DROP TABLE [dbo].tempSAkhir_RS_m3 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Link2]') AND type in (N'U')) DROP TABLE [dbo].Link2 " +

                        " select PartNo,sum(Qty)Qty,round(sum(M3),4)M3 into tesSAkhir_RS from ( " +
                        " select PartNo,Qty,round(((Tebal*Lebar*Panjang)/1000000000)*Qty,4)M3  from ( " +
                        " select PartNo,PartNo2,sum(Qty)Qty,Tebal,Lebar,Panjang  from ( " +
                        " select x1.PartNo,x2.PartNo PartNo2,x2.Tebal,x2.Lebar,x2.Panjang,x.Qty from ( " +
                        " select sum(Saldo)Qty,ItemID0,ItemID from T1_SaldoListPlank where Process='runingsaw' and thnbln=left(convert(char,@thnbln1,112),6) and Saldo>0 " +
                        " and ItemID<>ItemID0 group by ItemID0,ItemID ) as x  " +
                        " inner join FC_Items x1 ON x.ItemID0=x1.ID " +
                        " inner join FC_Items x2 ON x.ItemID=x2.ID) as A group by PartNo,PartNo2,Tebal,Lebar,Panjang ) as xx ) as xx1 group by PartNo  " +

                        //" select A.PartNo,case when B.Prosen=100 then A.M3 else A.M3*B.Prosen/100 end M3,A.Qty,B.Line,B.Prosen into tesSAkhir_RS1 from tesSAkhir_RS A left join Def_UKhususProsen B ON A.PartNo=B.Partno " +
                        //" where B.Noted='Defect ListPlank' and left(convert(char,B.Periode,112),6)=left(convert(char,@thnbln1,112),6) " +
                        " " + New4 + " " +
                        " " + Old4 + " " +

                        " select Line,sum(M3)M3,sum(Qty)Qty into tesSAkhir_RS2 from (select * from tesSAkhir_RS1 ) as x group by Line  " +

                        " select [Group],Line ,cast(sum(M3) as decimal(10,5))M3,sum(Qty)Qty into tesSAkhir_RS3 from (  " +
                        " select case " +
                        " " + Query1 + " " +
                        " end [Group],Line,round(M3,5)M3,Qty  from tesSAkhir_RS2 " +
                        " " + Query2 + " " +
                        " ) as x group by [Group],Line  " +

                        " SELECT A.[Line],   " +
                        "    Split.a.value('.', 'VARCHAR(100)') AS [Group]  ,cast(round((Qty/4),4) as decimal(10,4)) Qty,round((M3/4),4) M3 into tesSAkhir_RS4 " +
                        " FROM  (SELECT [Line],   " +
                        "        CAST ('<M>' + REPLACE([Group], ',', '</M><M>') + '</M>' AS XML) AS String  ,M3,cast(Qty as decimal(10,4))Qty " +
                        "    FROM  tesSAkhir_RS3) AS A CROSS APPLY String.nodes ('/M') AS Split(a); " +

                        " select Line,round(M3,3)M3 into tempSAkhir_RS_m3 from tesSAkhir_RS4   order by Line " +
                        " /** 3 End **/ " +

                        " /** 4. Saldo Awal Bevel **/ " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesSAwal_Bv]') AND type in (N'U')) DROP TABLE [dbo].tesSAwal_Bv " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesSAwal_Bv1]') AND type in (N'U')) DROP TABLE [dbo].tesSAwal_Bv1 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesSAwal_Bv2]') AND type in (N'U')) DROP TABLE [dbo].tesSAwal_Bv2 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesSAwal_Bv3]') AND type in (N'U')) DROP TABLE [dbo].tesSAwal_Bv3 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesSAwal_Bv4]') AND type in (N'U')) DROP TABLE [dbo].tesSAwal_Bv4 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempSAwal_Bv_m3]') AND type in (N'U')) DROP TABLE [dbo].tempSAwal_Bv_m3 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Link3]') AND type in (N'U')) DROP TABLE [dbo].Link3 " +

                        " select PartNo,sum(Qty)Qty,round(sum(M3),4)M3 into tesSAwal_Bv from ( " +
                        " select PartNo,Qty,round(((Tebal*Lebar*Panjang)/1000000000)*Qty,4)M3  from ( " +
                        " select PartNo,PartNo2,sum(Qty)Qty,Tebal,Lebar,Panjang  from ( " +
                        " select x1.PartNo,x2.PartNo PartNo2,x2.Tebal,x2.Lebar,x2.Panjang,x.Qty from ( " +
                        " select sum(Saldo)Qty,ItemID0,ItemID from T1_SaldoListPlank where Process='bevel' and thnbln=@BlnThn and Saldo>0 and ItemID<>ItemID0 group by ItemID0,ItemID ) as x  " +
                        " inner join FC_Items x1 ON x.ItemID0=x1.ID " +
                        " inner join FC_Items x2 ON x.ItemID=x2.ID) as A group by PartNo,PartNo2,Tebal,Lebar,Panjang ) as xx ) as xx1 group by PartNo  " +

                        //" select A.PartNo,case when B.Prosen=100 then A.M3 else A.M3*B.Prosen/100 end M3,A.Qty,B.Line,B.Prosen into tesSAwal_Bv1 from tesSAwal_Bv A left join Def_UKhususProsen B ON A.PartNo=B.Partno " +
                        //" where B.Noted='Defect ListPlank' and left(convert(char,B.Periode,112),6)=left(convert(char,@thnbln1,112),6) " +
                        " " + New5 + " " +
                        " " + Old5 + " " +

                        " select Line,sum(M3)M3,sum(Qty)Qty into tesSAwal_Bv2 from ( " +
                        " select * from tesSAwal_Bv1 ) as x group by Line " +

                        " select [Group],Line ,cast(sum(M3) as decimal(10,5))M3,sum(Qty)Qty into tesSAwal_Bv3 from ( " +
                        " select case " +
                        //" when Line=1 then 'KA,KB,KC,KD' when Line=2 then 'KE,KF,KG,KH' when Line=3 then 'KI,KJ,KK,KL' when Line=4 "+
                        //" then 'KM,KN,KO,KP' when Line=5 then 'KQ,KR,KS,KT' when Line=6 then 'KU,KV,KW,KX' "+
                        " " + Query1 + " " +
                        " end [Group],Line,round(M3,2)M3,Qty " +
                        " from tesSAwal_Bv2 " +
                        //" union all "+ 
                        //" select 'KA,KB,KC,KD'[Group],'1'Line,'0'M3,'0'Qty "+
                        //" union all "+
                        //" select 'KE,KF,KG,KH'[Group],'2'Line,'0'M3,'0'Qty "+
                        //" union all "+
                        //" select 'KI,KJ,KK,KL'[Group],'3'Line,'0'M3,'0'Qty "+
                        //" union all "+
                        //" select 'KM,KN,KO,KP'[Group],'4'Line,'0'M3,'0'Qty "+
                        //" union all "+
                        //" select 'KQ,KR,KS,KT'[Group],'5'Line,'0'M3,'0'Qty "+
                        //" union all "+
                        //" select 'KQ,KR,KS,KT'[Group],'6'Line,'0'M3,'0'Qty "+
                        " " + Query2 + " " +
                        " ) as x group by [Group],Line  " +

                        " SELECT A.[Line],   " +
                        "    Split.a.value('.', 'VARCHAR(100)') AS [Group]  ,cast(round((Qty/4),4) as decimal(10,4)) Qty,round((M3/4),4) M3 into tesSAwal_Bv4 " +
                        " FROM  (SELECT [Line],   " +
                        "        CAST ('<M>' + REPLACE([Group], ',', '</M><M>') + '</M>' AS XML) AS String  ,M3,cast(Qty as decimal(10,4))Qty " +
                        "    FROM  tesSAwal_Bv3) AS A CROSS APPLY String.nodes ('/M') AS Split(a); " +

                        " select Line,M3 into tempSAwal_Bv_m3 from tesSAwal_Bv4   order by Line " +
                        " /** End 4 **/ " +

                        " /** 5. Saldo Akhir Bevel **/ " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesSAkhir_Bv]') AND type in (N'U')) DROP TABLE [dbo].tesSAkhir_Bv " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesSAkhir_Bv1]') AND type in (N'U')) DROP TABLE [dbo].tesSAkhir_Bv1 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesSAkhir_Bv2]') AND type in (N'U')) DROP TABLE [dbo].tesSAkhir_Bv2 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesSAkhir_Bv3]') AND type in (N'U')) DROP TABLE [dbo].tesSAkhir_Bv3 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesSAkhir_Bv4]') AND type in (N'U')) DROP TABLE [dbo].tesSAkhir_Bv4 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempSAkhir_Bv_m3]') AND type in (N'U')) DROP TABLE [dbo].tempSAkhir_Bv_m3 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Link4]') AND type in (N'U')) DROP TABLE [dbo].Link4 " +

                        " select PartNo,sum(Qty)Qty,round(sum(M3),4)M3 into tesSAkhir_Bv from ( " +
                        " select PartNo,Qty,round(((Tebal*Lebar*Panjang)/1000000000)*Qty,4)M3  from ( " +
                        " select PartNo,PartNo2,sum(Qty)Qty,Tebal,Lebar,Panjang  from ( " +
                        " select x1.PartNo,x2.PartNo PartNo2,x2.Tebal,x2.Lebar,x2.Panjang,x.Qty from ( " +
                        " select sum(Saldo)Qty,ItemID0,ItemID from T1_SaldoListPlank where Process='bevel' and thnbln=left(convert(char,@thnbln1,112),6) and Saldo>0 " +
                        " and ItemID<>ItemID0 group by ItemID0,ItemID ) as x  " +
                        " inner join FC_Items x1 ON x.ItemID0=x1.ID " +
                        " inner join FC_Items x2 ON x.ItemID=x2.ID) as A group by PartNo,PartNo2,Tebal,Lebar,Panjang ) as xx ) as xx1 group by PartNo  " +

                        //" select A.PartNo,case when B.Prosen=100 then A.M3 else A.M3*B.Prosen/100 end M3,A.Qty,B.Line,B.Prosen into tesSAkhir_Bv1 from tesSAkhir_Bv A left join Def_UKhususProsen B ON A.PartNo=B.Partno " +
                        //" where B.Noted='Defect ListPlank' and left(convert(char,B.Periode,112),6)=left(convert(char,@thnbln1,112),6) " +
                        " " + New6 + " " +
                        " " + Old6 + " " +

                        " select Line,sum(M3)M3,sum(Qty)Qty into tesSAkhir_Bv2 from ( " +
                        "select * from tesSAkhir_Bv1 ) as x group by Line " +

                        " select [Group],Line ,cast(sum(M3) as decimal(10,5))M3,sum(Qty)Qty into tesSAkhir_Bv3 from ( " +
                        " select case " +
                        //" when Line=1 then 'KA,KB,KC,KD' when Line=2 then 'KE,KF,KG,KH' when Line=3 then 'KI,KJ,KK,KL' when Line=4 then 'KM,KN,KO,KP' "+
                        //" when Line=5 then 'KQ,KR,KS,KT' when Line=6 then 'KU,KV,KW,KX' "+
                        " " + Query1 + " " +
                        " end [Group],Line,round(M3,5)M3,Qty from tesSAkhir_Bv2 " +
                        //" union all "+ 
                        //" select 'KA,KB,KC,KD'[Group],'1'Line,'0'M3,'0'Qty "+
                        //" union all "+
                        //" select 'KE,KF,KG,KH'[Group],'2'Line,'0'M3,'0'Qty "+
                        //" union all "+
                        //" select 'KI,KJ,KK,KL'[Group],'3'Line,'0'M3,'0'Qty "+
                        //" union all "+
                        //" select 'KM,KN,KO,KP'[Group],'4'Line,'0'M3,'0'Qty "+
                        //" union all "+
                        //" select 'KQ,KR,KS,KT'[Group],'5'Line,'0'M3,'0'Qty "+
                        //" union all "+
                        //" select 'KQ,KR,KS,KT'[Group],'6'Line,'0'M3,'0'Qty "+
                        " " + Query2 + " " +
                        " ) as x group by [Group],Line  " +

                        " SELECT A.[Line],   " +
                        "    Split.a.value('.', 'VARCHAR(100)') AS [Group]  ,cast(round((Qty/4),4) as decimal(10,4)) Qty,round((M3/4),4) M3 into tesSAkhir_Bv4 " +
                        " FROM  (SELECT [Line],  " +
                        "        CAST ('<M>' + REPLACE([Group], ',', '</M><M>') + '</M>' AS XML) AS String  ,M3,cast(Qty as decimal(10,4))Qty " +
                        "    FROM  tesSAkhir_Bv3) AS A CROSS APPLY String.nodes ('/M') AS Split(a); " +

                        " select Line,M3 into tempSAkhir_Bv_m3 from tesSAkhir_Bv4   order by Line " +
                        " /** End 5 **/ " +

                        " /** 6. Saldo Awal Strapping **/ " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesSAwal_Str]') AND type in (N'U')) DROP TABLE [dbo].tesSAwal_Str " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesSAwal_Str1]') AND type in (N'U')) DROP TABLE [dbo].tesSAwal_Str1 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesSAwal_Str2]') AND type in (N'U')) DROP TABLE [dbo].tesSAwal_Str2 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesSAwal_Str3]') AND type in (N'U')) DROP TABLE [dbo].tesSAwal_Str3 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesSAwal_Str4]') AND type in (N'U')) DROP TABLE [dbo].tesSAwal_Str4 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempSAwal_Str_m3]') AND type in (N'U')) DROP TABLE [dbo].tempSAwal_Str_m3 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Link5]') AND type in (N'U')) DROP TABLE [dbo].Link5 " +

                        " select PartNo,sum(Qty)Qty,round(sum(M3),4)M3 into tesSAwal_Str from ( " +
                        " select PartNo,Qty,round(((Tebal*Lebar*Panjang)/1000000000)*Qty,4)M3  from ( " +
                        " select PartNo,PartNo2,sum(Qty)Qty,Tebal,Lebar,Panjang  from ( " +
                        " select x1.PartNo,x2.PartNo PartNo2,x2.Tebal,x2.Lebar,x2.Panjang,x.Qty from ( " +
                        " select sum(Saldo)Qty,ItemID0,ItemID from T1_SaldoListPlank where Process='straping' and thnbln=@BlnThn and Saldo>0 and ItemID<>ItemID0 group by ItemID0,ItemID ) as x  " +
                        " inner join FC_Items x1 ON x.ItemID0=x1.ID " +
                        " inner join FC_Items x2 ON x.ItemID=x2.ID) as A group by PartNo,PartNo2,Tebal,Lebar,Panjang ) as xx ) as xx1 group by PartNo  " +

                        //" select A.PartNo,case when B.Prosen=100 then A.M3 else A.M3*B.Prosen/100 end M3,A.Qty,B.Line,B.Prosen into tesSAwal_Str1 from tesSAwal_Str A left join Def_UKhususProsen B ON A.PartNo=B.Partno " +
                        //" where B.Noted='Defect ListPlank' and  left(convert(char,B.Periode,112),6)=left(convert(char,@thnbln1,112),6) " +
                        " " + New7 + " " +
                        " " + Old7 + " " +

                        " select Line,sum(M3)M3,sum(Qty)Qty into tesSAwal_Str2 from ( " +
                        " select * from tesSAwal_Str1 ) as x group by Line " +

                        " select [Group],Line ,cast(sum(M3) as decimal(10,5))M3,sum(Qty)Qty into tesSAwal_Str3 from (  " +
                        " select case " +
                        //" when Line=1 then 'KA,KB,KC,KD' when Line=2 then 'KE,KF,KG,KH' when Line=3 then 'KI,KJ,KK,KL' when Line=4 then 'KM,KN,KO,KP' "+
                        //" when Line=5 then 'KQ,KR,KS,KT' when Line=6 then 'KU,KV,KW,KX' "+
                        " " + Query1 + " " +
                        " end [Group],Line,round(M3,5)M3,Qty  from tesSAwal_Str2  " +
                        //" union all "+ 
                        //" select 'KA,KB,KC,KD'[Group],'1'Line,'0'M3,'0'Qty "+
                        //" union all "+
                        //" select 'KE,KF,KG,KH'[Group],'2'Line,'0'M3,'0'Qty "+
                        //" union all "+
                        //" select 'KI,KJ,KK,KL'[Group],'3'Line,'0'M3,'0'Qty "+
                        //" union all "+
                        //" select 'KM,KN,KO,KP'[Group],'4'Line,'0'M3,'0'Qty "+
                        //" union all "+
                        //" select 'KQ,KR,KS,KT'[Group],'5'Line,'0'M3,'0'Qty "+
                        //" union all "+
                        //" select 'KQ,KR,KS,KT'[Group],'6'Line,'0'M3,'0'Qty "+
                        " " + Query2 + " " +
                        " ) as x group by [Group],Line  " +

                        " SELECT A.[Line],  " +
                        "    Split.a.value('.', 'VARCHAR(100)') AS [Group]  ,cast(round((Qty/4),4) as decimal(10,4)) Qty,round((M3/4),4) M3 into tesSAwal_Str4 " +
                        " FROM  (SELECT [Line],  " +
                        "        CAST ('<M>' + REPLACE([Group], ',', '</M><M>') + '</M>' AS XML) AS String  ,M3,cast(Qty as decimal(10,4))Qty " +
                        "    FROM  tesSAwal_Str3) AS A CROSS APPLY String.nodes ('/M') AS Split(a); " +

                        " select Line,round(M3,5)M3 into tempSAwal_Str_m3 from tesSAwal_Str4   order by Line " +
                        " /** End 6 **/ " +

                        " /** 7. Saldo Akhir Strapping **/ " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesSAkhir_Str]') AND type in (N'U')) DROP TABLE [dbo].tesSAkhir_Str " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesSAkhir_Str1]') AND type in (N'U')) DROP TABLE [dbo].tesSAkhir_Str1 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesSAkhir_Str2]') AND type in (N'U')) DROP TABLE [dbo].tesSAkhir_Str2 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesSAkhir_Str3]') AND type in (N'U')) DROP TABLE [dbo].tesSAkhir_Str3 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesSAkhir_Str4]') AND type in (N'U')) DROP TABLE [dbo].tesSAkhir_Str4 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempSAkhir_Str_m3]') AND type in (N'U')) DROP TABLE [dbo].tempSAkhir_Str_m3 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Link6]') AND type in (N'U')) DROP TABLE [dbo].Link6 " +

                        " select PartNo,sum(Qty)Qty,round(sum(M3),4)M3 into tesSAkhir_Str from ( " +
                        " select PartNo,Qty,round(((Tebal*Lebar*Panjang)/1000000000)*Qty,4)M3  from ( " +
                        " select PartNo,PartNo2,sum(Qty)Qty,Tebal,Lebar,Panjang  from ( " +
                        " select x1.PartNo,x2.PartNo PartNo2,x2.Tebal,x2.Lebar,x2.Panjang,x.Qty from ( " +
                        " select sum(Saldo)Qty,ItemID0,ItemID from T1_SaldoListPlank where Process='straping' and thnbln=left(convert(char,@thnbln1,112),6) and ItemID<>ItemID0 and Saldo>0 " +
                        " group by ItemID0,ItemID ) as x  " +
                        " inner join FC_Items x1 ON x.ItemID0=x1.ID " +
                        " inner join FC_Items x2 ON x.ItemID=x2.ID) as A group by PartNo,PartNo2,Tebal,Lebar,Panjang ) as xx ) as xx1 group by PartNo  " +

                        //" select A.PartNo,case when B.Prosen=100 then A.M3 else A.M3*B.Prosen/100 end M3,A.Qty,B.Line,B.Prosen into tesSAkhir_Str1 from tesSAkhir_Str A left join Def_UKhususProsen B ON A.PartNo=B.Partno " +
                        //" where B.Noted='Defect ListPlank' and left(convert(char,B.Periode,112),6)=left(convert(char,@thnbln1,112),6) " +
                        " " + New8 + " " +
                        " " + Old8 + " " +

                        " select Line,sum(M3)M3,sum(Qty)Qty into tesSAkhir_Str2 from ( " +
                        " select * from tesSAkhir_Str1 ) as x group by Line " +

                        " select [Group],Line ,cast(sum(M3) as decimal(10,5))M3,sum(Qty)Qty into tesSAkhir_Str3 from ( " +
                        " select case " +
                        //" when Line=1 then 'KA,KB,KC,KD' when Line=2 then 'KE,KF,KG,KH' when Line=3 then 'KI,KJ,KK,KL' when Line=4 then 'KM,KN,KO,KP' "+
                        //" when Line=5 then 'KQ,KR,KS,KT' when Line=6 then 'KU,KV,KW,KX' "+
                        " " + Query1 + " " +
                        " end [Group],Line,round(M3,5)M3,Qty  from tesSAkhir_Str2  " +
                        //" union all "+ 
                        //" select 'KA,KB,KC,KD'[Group],'1'Line,'0'M3,'0'Qty "+
                        //" union all "+
                        //" select 'KE,KF,KG,KH'[Group],'2'Line,'0'M3,'0'Qty "+
                        //" union all "+
                        //" select 'KI,KJ,KK,KL'[Group],'3'Line,'0'M3,'0'Qty "+
                        //" union all "+
                        //" select 'KM,KN,KO,KP'[Group],'4'Line,'0'M3,'0'Qty "+
                        //" union all "+
                        //" select 'KQ,KR,KS,KT'[Group],'5'Line,'0'M3,'0'Qty "+
                        //" union all "+
                        //" select 'KQ,KR,KS,KT'[Group],'6'Line,'0'M3,'0'Qty "+
                        " " + Query2 + " " +
                        " ) as x group by [Group],Line  " +

                        " SELECT A.[Line],    " +
                        "    Split.a.value('.', 'VARCHAR(100)') AS [Group]  ,cast(round((Qty/4),4) as decimal(10,4)) Qty,round((M3/4),4) M3 into tesSAkhir_Str4  " +
                        " FROM  (SELECT [Line],   " +
                        "        CAST ('<M>' + REPLACE([Group], ',', '</M><M>') + '</M>' AS XML) AS String  ,M3,cast(Qty as decimal(10,4))Qty  " +
                        "    FROM  tesSAkhir_Str3) AS A CROSS APPLY String.nodes ('/M') AS Split(a);  " +

                        " select Line,round(M3,5)M3 into tempSAkhir_Str_m3 from tesSAkhir_Str4   order by Line  " +
                        " /** End 7 **/  " +

                        " /** 8. Tahap III OK **/ " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesTahap3_OK]') AND type in (N'U')) DROP TABLE [dbo].tesTahap3_OK " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesTahap3_OK1]') AND type in (N'U')) DROP TABLE [dbo].tesTahap3_OK1 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesTahap3_OK2]') AND type in (N'U')) DROP TABLE [dbo].tesTahap3_OK2 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesTahap3_OK3]') AND type in (N'U')) DROP TABLE [dbo].tesTahap3_OK3 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesTahap3_OK4]') AND type in (N'U')) DROP TABLE [dbo].tesTahap3_OK4 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTahap3_OK_m3]') AND type in (N'U')) DROP TABLE [dbo].tempTahap3_OK_m3 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Link7]') AND type in (N'U')) DROP TABLE [dbo].Link7 " +

                        " select PartNo,sum(Qty)Qty,round(sum(M3),5)M3 into tesTahap3_OK from ( " +
                        " select PartNo,Qty,round(((Tebal*Lebar*Panjang)/1000000000)*Qty,5)M3  from ( " +
                        " select PartNo,sum(Qty)Qty,Tebal,Lebar,Panjang  from ( " +
                        " select x.PartNo ,x2.Tebal,x2.Lebar,x2.Panjang,x.Qty from ( " +
                        " select sum(Qty)Qty,ItemID,Keterangan Partno from vw_KartuStockBJNew " +
                        " where sfrom='straping' and left(convert(char,tanggal,112),6)=left(convert(char,@thnbln1,112),6) and ItemID in " +
                        " (select ID from FC_Items where PartNo like'%-M-%' or PartNo like'%-3-%')  group by ItemID,Keterangan ) as x  " +
                        " inner join FC_Items x2 ON x.ItemID=x2.ID) as A group by PartNo,Tebal,Lebar,Panjang ) as xx ) as xx1 group by PartNo  " +

                        //" select A.PartNo,case when B.Prosen=100 then A.M3 else A.M3*B.Prosen/100 end M3,A.Qty,B.Line,B.Prosen into tesTahap3_OK1 from tesTahap3_OK A left join Def_UKhususProsen B ON A.PartNo=B.Partno " +
                        //" where B.Noted='Defect ListPlank' and left(convert(char,B.Periode,112),6)=left(convert(char,@thnbln1,112),6) " +
                        " " + New9 + " " +
                        " " + Old9 + " " +

                        " select Line,sum(M3)M3,sum(Qty)Qty into tesTahap3_OK2 from ( " +
                        " select * from tesTahap3_OK1 ) as x group by Line " +

                        " select [Group],Line ,cast(sum(M3) as decimal(10,5))M3,sum(Qty)Qty into tesTahap3_OK3 from ( " +
                        " select case " +
                        //" when Line=1 then 'KA,KB,KC,KD' when Line=2 then 'KE,KF,KG,KH' when Line=3 then 'KI,KJ,KK,KL' when Line=4 then 'KM,KN,KO,KP' "+
                        //" when Line=5 then 'KQ,KR,KS,KT' when Line=6 then 'KU,KV,KW,KX' "+
                        " " + Query1 + " " +
                        " end [Group],Line,round(M3,5)M3,Qty from tesTahap3_OK2 " +
                        //" union all "+ 
                        //" select 'KA,KB,KC,KD'[Group],'1'Line,'0'M3,'0'Qty "+
                        //" union all "+
                        //" select 'KE,KF,KG,KH'[Group],'2'Line,'0'M3,'0'Qty "+
                        //" union all "+
                        //" select 'KI,KJ,KK,KL'[Group],'3'Line,'0'M3,'0'Qty "+
                        //" union all "+
                        //" select 'KM,KN,KO,KP'[Group],'4'Line,'0'M3,'0'Qty "+
                        //" union all "+
                        //" select 'KQ,KR,KS,KT'[Group],'5'Line,'0'M3,'0'Qty "+
                        //" union all "+
                        //" select 'KQ,KR,KS,KT'[Group],'6'Line,'0'M3,'0'Qty "+
                        " " + Query2 + " " +
                        " ) as x group by [Group],Line  " +

                        " SELECT A.[Line],   " +
                        "    Split.a.value('.', 'VARCHAR(100)') AS [Group]  ,cast(round((Qty/4),4) as decimal(10,4)) Qty,round((M3/4),4) M3 into tesTahap3_OK4 " +
                        " FROM  (SELECT [Line], " +
                        "        CAST ('<M>' + REPLACE([Group], ',', '</M><M>') + '</M>' AS XML) AS String  ,M3,cast(Qty as decimal(10,4))Qty " +
                        "    FROM  tesTahap3_OK3) AS A CROSS APPLY String.nodes ('/M') AS Split(a);	 " +

                        " select line,round(m3,5)M3 into tempTahap3_OK_m3 from ( " +
                        " select sum(M3)M3,line from tesTahap3_OK4 group by line ) as x " +
                        " /** End 8 **/ " +

                        " /** 9. Tahap III BP **/ " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesTahap3_BP]') AND type in (N'U')) DROP TABLE [dbo].tesTahap3_BP " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesTahap3_BP1]') AND type in (N'U')) DROP TABLE [dbo].tesTahap3_BP1 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesTahap3_BP2]') AND type in (N'U')) DROP TABLE [dbo].tesTahap3_BP2 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesTahap3_BP3]') AND type in (N'U')) DROP TABLE [dbo].tesTahap3_BP3 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tesTahap3_BP4]') AND type in (N'U')) DROP TABLE [dbo].tesTahap3_BP4 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTahap3_BP_m3]') AND type in (N'U')) DROP TABLE [dbo].tempTahap3_BP_m3 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Link8]') AND type in (N'U')) DROP TABLE [dbo].Link8 " +

                        " select PartNo,sum(Qty)Qty,round(sum(M3),5)M3 into tesTahap3_BP from ( " +
                        " select PartNo,Qty,round(((Tebal*Lebar*Panjang)/1000000000)*Qty,5)M3  from ( " +
                        " select PartNo,sum(Qty)Qty,Tebal,Lebar,Panjang  from ( " +
                        " select x.PartNo ,x2.Tebal,x2.Lebar,x2.Panjang,x.Qty from ( " +
                        " select sum(Qty)Qty,ItemID,Keterangan Partno from vw_KartuStockBJNew " +
                        " where sfrom='straping' and left(convert(char,tanggal,112),6)=left(convert(char,@thnbln1,112),6) and " +
                        " ItemID in (select ID from FC_Items where PartNo like'%-P-%' or PartNo like'%-S-%')  group by ItemID,Keterangan ) as x  " +
                        " inner join FC_Items x2 ON x.ItemID=x2.ID) as A group by PartNo,Tebal,Lebar,Panjang ) as xx ) as xx1 group by PartNo  " +

                        //" select A.PartNo,case when B.Prosen=100 then A.M3 else A.M3*B.Prosen/100 end M3,A.Qty,B.Line,B.Prosen into tesTahap3_BP1 from tesTahap3_BP A left join Def_UKhususProsen B ON A.PartNo=B.Partno " +
                        //" where B.Noted='Defect ListPlank' and left(convert(char,B.Periode,112),6)=left(convert(char,@thnbln1,112),6) " +
                        " " + New10 + " " +
                        " " + Old10 + " " +

                        " select Line,sum(M3)M3,sum(Qty)Qty into tesTahap3_BP2 from ( " +
                        " select * from tesTahap3_BP1 ) as x group by Line " +

                        " select [Group],Line ,cast(sum(M3) as decimal(10,5))M3,sum(Qty)Qty into tesTahap3_BP3 from ( " +
                        " select case " +
                        //" when Line=1 then 'KA,KB,KC,KD' when Line=2 then 'KE,KF,KG,KH' when Line=3 then 'KI,KJ,KK,KL' when Line=4 then 'KM,KN,KO,KP'  "+
                        //" when Line=5 then 'KQ,KR,KS,KT' when Line=6 then 'KU,KV,KW,KX' "+
                        " " + Query1 + " " +
                        " end [Group],Line,round(M3,5)M3,Qty  from tesTahap3_BP2 " +
                        //" union all "+ 
                        //" select 'KA,KB,KC,KD'[Group],'1'Line,'0'M3,'0'Qty "+
                        //" union all "+
                        //" select 'KE,KF,KG,KH'[Group],'2'Line,'0'M3,'0'Qty "+
                        //" union all "+
                        //" select 'KI,KJ,KK,KL'[Group],'3'Line,'0'M3,'0'Qty "+
                        //" union all "+
                        //" select 'KM,KN,KO,KP'[Group],'4'Line,'0'M3,'0'Qty "+
                        //" union all "+
                        //" select 'KQ,KR,KS,KT'[Group],'5'Line,'0'M3,'0'Qty "+
                        //" union all "+
                        //" select 'KQ,KR,KS,KT'[Group],'6'Line,'0'M3,'0'Qty "+
                        " " + Query2 + " " +
                        " ) as x group by [Group],Line  " +

                        " SELECT A.[Line],   " +
                        "     Split.a.value('.', 'VARCHAR(100)') AS [Group]  ,cast(round((Qty/4),4) as decimal(10,4)) Qty,round((M3/4),4) M3 into tesTahap3_BP4 " +
                        " FROM  (SELECT [Line],   " +
                        "         CAST ('<M>' + REPLACE([Group], ',', '</M><M>') + '</M>' AS XML) AS String  ,M3,cast(Qty as decimal(10,4))Qty " +
                        "     FROM  tesTahap3_BP3) AS A CROSS APPLY String.nodes ('/M') AS Split(a); " +

                        " select line,round(m3,5)M3 into tempTahap3_BP_m3 from (select sum(M3)M3,line from tesTahap3_BP4 group by line ) as x " +
                        " /** End 9 **/ " +

                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempBagiDefectLP_m3]') AND type in (N'U')) DROP TABLE [dbo].tempBagiDefectLP_m3 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempBagiDefect_LP1_m3]') AND type in (N'U')) DROP TABLE [dbo].tempBagiDefect_LP1_m3 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempBagiDefect_LP2_m3]') AND type in (N'U')) DROP TABLE [dbo].tempBagiDefect_LP2_m3 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempBagiDefect_LP3_m3]') AND type in (N'U')) DROP TABLE [dbo].tempBagiDefect_LP3_m3 " +

                        " select Line,round(sum(M3),1)M3 into tempBagiDefectLP_m3 from ( " +
                        " select line,sum(M3)M3 from ( " +
                        " select line,sum(M3)M3 from ( " +
                        " select line,round(sum(M3),2)M3 from ( " +
                        " select Line,round(M3,4)M3 from tempRSOut_m3 ) as x group by line " +
                        " union all " +
                        " select line,sum(M3)M3 from ( " +
                        " /** 1 **/ " +
                        " select Line,round(sum(M3),5)M3 from ( " +
                        " select line,round(M3,5)M3 from tempSAwal_RS_m3 " +
                        " union all " +
                        " select Line,round(M3*-1,5) M3 from tempSAkhir_RS_m3 ) as x group by line " +
                        " /** 1 **/ " +
                        " union all " +
                        " /** 2 **/ " +
                        " select Line,sum(M3)M3 from ( " +
                        " select * from tempSAwal_Bv_m3 " +
                        " union all " +
                        " select Line,M3*-1 M3 from tempSAkhir_Bv_m3 ) as x group by line " +
                        "/** 2 **/ " +
                        "union all " +
                        "/** 3 **/ " +
                        "select Line,round(sum(M3),2)M3 from ( " +
                        "select Line,round(sum(M3),3)M3 from tempSAwal_Str_m3 group by line " +
                        "union all " +
                        "select Line,M3*-1 M3 from tempSAkhir_Str_m3 ) as x group by line  " +
                        "/** 3 **/ " +
                        ") as A group by line ) as B group by line " +
                        "union all " +
                        "select Line,M3*-1 M3 from tempTahap3_OK_m3 " +
                        ") as C group by line " +
                        "union all " +
                        "select Line,round(M3,5)M3 from tempTahap3_BP_m3  " +
                        ") as D  group by line " +

                        " select [Group],Line ,cast(sum(M3) as decimal(10,5))M3 into tempBagiDefect_LP1_m3 from ( " +
                        " select case " +
                        //" when Line=1 then 'KA,KB,KC,KD' when Line=2 then 'KE,KF,KG,KH' when Line=3 then 'KI,KJ,KK,KL' "+
                        //" when Line=4 then 'KM,KN,KO,KP' when Line=5 then 'KQ,KR,KS,KT' when Line=6 then 'KU,KV,KW,KX' "+
                        " " + Query1 + " " +
                        " end [Group],Line,round(M3,2)M3 " +
                        " from tempBagiDefectLP_m3 " +
                        //" union all "+
                        //" select 'KA,KB,KC,KD'[Group],'1'Line,'0'M3 "+
                        //" union all "+
                        //" select 'KE,KF,KG,KH'[Group],'2'Line,'0'M3 "+
                        //" union all "+
                        //" select 'KI,KJ,KK,KL'[Group],'3'Line,'0'M3 "+
                        //" union all "+
                        //" select 'KM,KN,KO,KP'[Group],'4'Line,'0'M3 "+
                        //" union all "+
                        //" select 'KQ,KR,KS,KT'[Group],'5'Line,'0'M3 "+
                        //" union all "+
                        //" select 'KQ,KR,KS,KT'[Group],'6'Line,'0'M3 "+
                        " " + Query3 + " " +
                        " ) as x group by [Group],Line " +

                        " SELECT A.[Line],   " +
                        "    Split.a.value('.', 'VARCHAR(100)') AS [Group]  ,round((M3/4),2) M3 into tempBagiDefect_LP2_m3 " +
                        " FROM  (SELECT [Line],  " +
                        "        CAST ('<M>' + REPLACE([Group], ',', '</M><M>') + '</M>' AS XML) AS String  ,M3 " +
                        "    FROM  tempBagiDefect_LP1_m3) AS A CROSS APPLY String.nodes ('/M') AS Split(a); " +

                        " select [Group],M3 into tempBagiDefect_LP3_m3 from tempBagiDefect_LP2_m3 order by [group] " +

                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDefect_Prod_m3]') AND type in (N'U')) DROP TABLE [dbo].tempDefect_Prod_m3 " +

                        " select [Group],round(M3,2)M3 into tempDefect_Prod_m3 from ( " +
                        " select [Group],round(sum(M3),2)M3 from ( " +
                        " select * from detailDfctSystemBM_M3  " +
                        " union all " +
                        " select [Group],M3 from DtlDefectSystemFN_M3 " +
                        " union all " +
                        " select * from DtlSelisih_M3  " +
                        " union all " +
                        " select * from tempDefectUKhusus " +
                        " union all " +
                        " select * from tempBagiDefect_LP3_m3 " +
                        " ) as x group by [group] ) as x1 order by [group] " +
                        " /** End Defect ListPlank **/  " +

                        " /** Total Defect ListPlank OK **/ " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTtl_LP_OK]') AND type in (N'U')) DROP TABLE [dbo].tempTtl_LP_OK " +

                        " select round(sum(M3),4)M3 into tempTtl_LP_OK from tempTahap3_OK_m3 " +
                        //" select round(sum(M3),0)M3 into tempTtl_LP_OK from ( "+
                        //" select sum(M3)M3 from ( "+
                        //" select line,round(sum(M3),2)M3 from ( "+
                        //" select Line,round(M3,5)M3 from tempRSOut_m3 ) as x group by line "+
                        //" union all "+
                        //" select line,sum(M3)M3 from ( "+
                        //" /** 1 **/ "+
                        //" select Line,round(sum(M3),5)M3 from ( "+
                        //" select line,round(M3,5)M3 from tempSAwal_RS_m3 "+
                        //" union all "+
                        //" select Line,round(M3*-1,5) M3 from tempSAkhir_RS_m3 ) as x group by line "+
                        //" /** 1 **/ "+
                        //" union all "+
                        //" /** 2 **/ "+
                        //" select Line,sum(M3)M3 from ( "+
                        //" select * from tempSAwal_Bv_m3 "+
                        //" union all "+
                        //" select Line,M3*-1 M3 from tempSAkhir_Bv_m3 ) as x group by line "+
                        //" /** 2 **/ "+
                        //" union all "+
                        //" /** 3 **/ "+
                        //" select Line,round(sum(M3),5)M3 from ( "+
                        //" select Line,round(sum(M3),5)M3 from tempSAwal_Str_m3 group by line "+
                        //" union all "+
                        //" select Line,M3*-1 M3 from tempSAkhir_Str_m3 ) as x group by line  "+
                        //" /** 3 **/ "+
                        //" ) as A group by line ) as B group by line ) as x1 "+
                        " /** End Total Defect ListPlank OK **/ " +

                        " /** Data BS Tahap I **/ " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDataBSauto]') AND type in (N'U')) DROP TABLE [dbo].tempDataBSauto  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempKSBJNewBSAuto]') AND type in (N'U')) DROP TABLE [dbo].tempKSBJNewBSAuto  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempKSBJNewBSAuto1]') AND type in (N'U')) DROP TABLE [dbo].tempKSBJNewBSAuto1 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempKSBJNew]') AND type in (N'U')) DROP TABLE [dbo].tempKSBJNew  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempKSBJNew1]') AND type in (N'U')) DROP TABLE [dbo].tempKSBJNew1   " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempBSTahap1]') AND type in (N'U')) DROP TABLE [dbo].tempBSTahap1   " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDetailBSTahap1]') AND type in (N'U')) DROP TABLE [dbo].tempDetailBSTahap1  " +

                        " declare @periode varchar(10)  select @periode=left(convert(char,@thnbln1,112),6) " +

                        " select distinct itemid into tempDataBSauto from vw_KartuStockBJNew where itemid in (select ID from fc_items where partno like '%-s-%') and " +
                        " LokID in (select ID from FC_Lokasi where Lokasi='bsauto') " +

                        " select * into tempKSBJNewBSAuto from vw_KartuStockBJNew where left(CONVERT(char, tanggal ,112),6)=@periode and itemID in  " +
                        " (select itemid from tempDataBSauto)  " +
                        " select * into tempKSBJNew from vw_KartuStockBJNew where left(CONVERT(char, tanggal ,112),6)=@periode and itemID not in  " +
                        " (select itemid from tempDataBSauto) " +

                        " select sum(Qty)Qty,round(sum(Qty*Volume),2)M3 into tempKSBJNewBSAuto1 from ( " +
                        " select x.qty Qty,((x1.Tebal*x1.Lebar*x1.Panjang)/1000000000)Volume from ( " +
                        " select Qty,ItemID from tempKSBJNewBSAuto where (process='direct' or process like'%Simetris%') and (isnull(sfrom,'-')='-' or isnull(sfrom,'bevel')='-' " +
                        " or isnull(sfrom,'-')='straping') and lokid in (select ID from FC_Lokasi where Lokasi='BSAUTO') and substring(Keterangan,1,21) like '%-1-%' " +
                        " and left(convert(char,tanggal,112),6)=@periode and PartNo  like'%-S-%') as x inner join FC_Items x1 ON x.ItemID=x1.ID ) as A " +

                        " select sum(Qty)Qty,sum(Qty*Volume)M3 into tempKSBJNew1 from ( " +
                        " select x.qty Qty,((x1.Tebal*x1.Lebar*x1.Panjang)/1000000000)Volume from ( " +
                        " select Qty,ItemID from tempKSBJNew where (process='direct' or process like'%Simetris%') and (isnull(sfrom,'-')='-' or isnull(sfrom,'bevel')='-' " +
                        " or isnull(sfrom,'-')='straping') and lokid not in (select ID from FC_Lokasi where Lokasi='BSAUTO') and substring(Keterangan,1,21) like '%-1-%' " +
                        " and left(convert(char,tanggal,112),6)=@periode and PartNo  like'%-S-%') as x inner join FC_Items x1 ON x.ItemID=x1.ID ) as A " +

                        " select sum(Qty)Qty,round(sum(M3),4)M3 into tempBSTahap1 from ( " +
                        " select * from tempKSBJNewBSAuto1 union all " +
                        " select * from tempKSBJNew1 ) as x " +

                        " declare @TtlBS_Tahap1 varchar(10) " +
                        " set @TtlBS_Tahap1 = (select M3 from tempBSTahap1) " +

                        " select [Group],round((M3/@TtlDfctSystemBM_M3)* @TtlBS_Tahap1,4) M3 into tempDetailBSTahap1 from detailDfctSystemBM_M3 order by [group] " +
                        " /** end Data BS Tahap I **/ " +

                        " /** Total Potong QA **/ " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTotPotong_QA]') AND type in (N'U')) DROP TABLE [dbo].tempTotPotong_QA  " +

                        " select  B.[Group],round(sum(TPotongM3),2) TotPotongM3 into tempTotPotong_QA from BM_Destacking A left join BM_PlantGroup B on A.PlantGroupID=B.ID " +
                        " inner join (  select C.ID DestID , A.TPotong qtyin,A.TPotong*I.Volume as kubik,A.TPotong*I.Volume TPotongM3 from Def_Defect A  " +
                        " inner join BM_Destacking C on A.DestID=C.ID left join FC_Items I on I.ID=C.ItemID where A.Status>-1 and CONVERT(char,A.tgl,112)>=@thnbln1 and " +
                        " CONVERT(char,A.tgl,112)<=@thnbln2 ) as C  on A.ID=C.DestID group by B.[Group] " +
                        " /** End Total Potong QA **/ " +

                        " /** Total Potong Defect Ukuran Khusus **/ " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDef1_OKBP]') AND type in (N'U')) DROP TABLE [dbo].tempDef1_OKBP " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDef2_OKBP]') AND type in (N'U')) DROP TABLE [dbo].tempDef2_OKBP  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDef_Khusus_OKBP]') AND type in (N'U')) DROP TABLE [dbo].tempDef_Khusus_OKBP " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Link9]') AND type in (N'U')) DROP TABLE [dbo].Link9 " +

                        //" select * into tempDef1_OKBP from ( "+
                        //" select SUBSTRING(A.partno,1,9)Part,A.PartNo,x.*,((A.Tebal*A.Lebar*A.Panjang)/1000000000)*x.Qty M3 from ( "+
                        //" select ItemID,isnull(SUM(Qty),0)  * -1 Qty from vw_KartuStockBJNew where qty <0 and (process  like '%simetris%' ) and "+
                        //" (Keterangan like '%-3-%' or Keterangan like '%-w-%' or Keterangan like '%-m-%'or Keterangan like '%-P-%') and LokID not In "+
                        //" (select ID from FC_Lokasi where lokasi='q99')   and left(convert(char,tanggal,112),8)>=@thnbln1 "+
                        //" and left(convert(char,tanggal,112),8)<=@thnbln2 and ItemID in (select ID from FC_Items where PartNo like'%-1-%') "+
                        //" group by ItemID ) as x inner join FC_Items A ON A.ID=x.ItemID ) as xx "+

                        " select * into tempDef1_OKBP from (  select Part,SUBSTRING(Partno,1,17)Partno,sum(Qty)Qty,sum(M3)M3 from ( " +
                        " select SUBSTRING(x.PartNo2,1,9)Part,x.Keterangan Partno,PartNo2,x.Qty,((A.Tebal*A.Lebar*A.Panjang)/1000000000)*x.Qty M3 from ( " +
                        " select PartNo PartNo2,REPLACE(substring(replace(Keterangan1,',',''),0,19),'-3-','-1-')Keterangan,ItemID,sum(Qty)Qty from ( " +
                        " select  REPLACE(substring(Keterangan,0,19),'-P-','-1-')Keterangan1,PartNo,ItemID,isnull(SUM(Qty),0)  * -1 Qty " +
                        " from vw_KartuStockBJNew where qty <0 and (process  like '%simetris%' ) and  (Keterangan like '%-3-%' or Keterangan like '%-w-%' or  " +
                        " Keterangan like '%-m-%'or Keterangan like '%-P-%') and LokID not In  (select ID from FC_Lokasi where lokasi='q99') " +
                        " and left(convert(char,tanggal,112),8)>=@thnbln1  and left(convert(char,tanggal,112),8)<=@thnbln2 and ItemID in  " +
                        " (select ID from FC_Items where PartNo like'%-1-%')  group by ItemID,Keterangan,PartNo) as x group by Keterangan1,ItemID,PartNo ) as x " +
                        " inner join FC_Items A ON A.ID=x.ItemID ) as x1 group by Part,Partno ) as xx " +

                        //" select A.PartNo,A.Qty,case when B.Prosen2=100 then A.M3 else (B.Prosen2*A.M3)/100 end M3,B.Line,B.Prosen2 into tempDef2_OKBP " +
                        //" from tempDef1_OKBP A left join Def_UKhususProsen B ON A.PartNo=B.Partno where B.Noted='Defect ukuran khusus' " +
                        //" and left(convert(char,B.Periode,112),6)=left(convert(char,@thnbln1,112),6) " +
                        " " + New11 + " " +
                        " " + Old11 + " " +

                        " select Line,/**round(sum(Prosentase*M3),4)**/sum(M3)M3 into tempDef_Khusus_OKBP from ( " +
                        " select * /**,cast(Prosen2 as decimal(10,4))*0.01 Prosentase **/ from tempDef2_OKBP ) as x group by Line " +
                        " /** End Total Potong Defect Ukuran Khusus **/ " +

                        " /** Total Potong Defect ListPlank **/ " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDef_LP]') AND type in (N'U')) DROP TABLE [dbo].tempDef_LP " +

                        //" select Line,sum(M3)M3 into tempDef_LP from tempBagiDefectLP_m3 group by Line "+
                        " select Line,sum(M3)M3 into tempDef_LP from ( " +
                        " select line,sum(M3)M3 from ( " +
                        " select line,sum(M3)M3 from ( " +
                        " select line,round(sum(M3),2)M3 from ( " +
                        " select Line,round(M3,4)M3 from tempRSOut_m3 ) as x group by line " +
                        " union all " +
                        " select line,sum(M3)M3 from ( " +
                        " /** 1 **/ " +
                        " select Line,round(sum(M3),5)M3 from ( " +
                        " select line,round(M3,5)M3 from tempSAwal_RS_m3 " +
                        " union all " +
                        " select Line,round(M3*-1,5) M3 from tempSAkhir_RS_m3 ) as x group by line " +
                        " /** 1 **/ " +
                        " union all " +
                        " /** 2 **/ " +
                        " select Line,sum(M3)M3 from ( " +
                        " select * from tempSAwal_Bv_m3 " +
                        " union all " +
                        " select Line,M3*-1 M3 from tempSAkhir_Bv_m3 ) as x group by line " +
                        " /** 2 **/ " +
                        " union all " +
                        " /** 3 **/ " +
                        " select Line,round(sum(M3),2)M3 from ( " +
                        " select Line,round(sum(M3),3)M3 from tempSAwal_Str_m3 group by line " +
                        " union all " +
                        " select Line,M3*-1 M3 from tempSAkhir_Str_m3 ) as x group by line  " +
                        " /** 3 **/ " +
                        " ) as A group by line ) as B group by line) as C where m3>0 group by line  " +
                        " union all " +
                        //" select * from tempBagiDefectLP_m3 where m3>0 or m3<0 ) as A1 group by Line " +
                        " select Line,M3 * -1 M3 from tempTahap3_OK_m3 " +
                        " union all  " +
                        " select * from tempTahap3_BP_m3 " +
                        " union all " +
                        " select * from tempTahap3_OK_m3 " +
                        " ) as A1 group by Line  " +
                        " /** End Total Potong Defect ListPlank **/ " +

                        " /** Total Potong Defect ListPlank dan Defect Ukuran Khusus **/ " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTtlPot1_LPU]') AND type in (N'U')) DROP TABLE [dbo].tempTtlPot1_LPU " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTtlPot2_LPU]') AND type in (N'U')) DROP TABLE [dbo].tempTtlPot2_LPU " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTtlPot3_LPU]') AND type in (N'U')) DROP TABLE [dbo].tempTtlPot3_LPU " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTtlPot_LPU]') AND type in (N'U')) DROP TABLE [dbo].tempTtlPot_LPU " +

                        " select Line,sum(M3)M3 into tempTtlPot1_LPU from ( " +
                        " select * from tempDef_Khusus_OKBP " +
                        " union all " +
                        " select * from tempDef_LP ) as x group by Line " +

                        " select [Group],Line ,cast(sum(M3) as decimal(10,5))M3 into tempTtlPot2_LPU  from ( " +
                        " select case " +
                        //" when Line=1 then 'KA,KB,KC,KD' when Line=2 then 'KE,KF,KG,KH' when Line=3 then 'KI,KJ,KK,KL' when Line=4 then 'KM,KN,KO,KP' "+
                        //" when Line=5 then 'KQ,KR,KS,KT' when Line=6 then 'KU,KV,KW,KX' "+
                        " " + Query1 + " " +
                        " end [Group],Line,round(M3,5)M3 from tempTtlPot1_LPU " +
                        //" union all "+
                        //" select 'KA,KB,KC,KD'[Group],'1'Line,'0'M3 "+
                        //" union all "+
                        //" select 'KE,KF,KG,KH'[Group],'2'Line,'0'M3 "+
                        //" union all "+
                        //" select 'KI,KJ,KK,KL'[Group],'3'Line,'0'M3 "+
                        //" union all "+
                        //" select 'KM,KN,KO,KP'[Group],'4'Line,'0'M3 "+
                        //" union all "+
                        //" select 'KQ,KR,KS,KT'[Group],'5'Line,'0'M3 "+
                        //" union all "+
                        //" select 'KQ,KR,KS,KT'[Group],'6'Line,'0'M3 "+
                        " " + Query3 + " " +
                        " ) as x group by [Group],Line  " +

                        " SELECT A.[Line],   " +
                        "     Split.a.value('.', 'VARCHAR(100)') AS [Group]  ,round((M3/4),2) M3 into tempTtlPot3_LPU " +
                        " FROM  (SELECT [Line],  " +
                         "        CAST ('<M>' + REPLACE([Group], ',', '</M><M>') + '</M>' AS XML) AS String  ,M3 " +
                         "    FROM  tempTtlPot2_LPU) AS A CROSS APPLY String.nodes ('/M') AS Split(a); " +

                        " select [Group],round(M3,2)M3 into tempTtlPot_LPU from tempTtlPot3_LPU order by [group] " +
                        " /** End Total Potong Defect ListPlank dan Defect Ukuran Khusus **/ " +

                        " /** Total Potong System dan ListPlank **/ " +
                        " declare @TtlPot_LPSystem decimal(10,2) " +
                        " set @TtlPot_LPSystem = ( " +
                        " select round(sum(M3),0)M3 from ( " +
                        " select @TtlDfctBMFN_M3 M3 /**Defect_BP**/ union all " +
                        " select @TtlDfctBMFN_M3_OKKW M3 /**Defect_OK**/ union all " +
                        " select round(sum(M3),1)M3 /**Khusus_BP**/ from tempDefectUKhusus union all " +
                        " select round(sum(M3),1)M3 /**Khusus_OK**/ from tes1_OK union all " +
                        " select round(sum(M3),1)M3 /**ListPlank_BP**/ from tempBagiDefect_LP3_m3 union all " +
                        " select round(sum(M3),1)M3 /**ListPlank_OK**/ from tempTtl_LP_OK union all " +
                        " select round(sum(M3),1)M3 /**BS_BP**/ from tempBSTahap1 ) as x )  " +
                        " /** End Total Potong System dan ListPlank **/ " +

                        " /** Detail Total Potong System dan ListPlank **/ " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDtlTtlPot_LP]') AND type in (N'U')) DROP TABLE [dbo].tempDtlTtlPot_LP " +

                        " select [Group],round(sum(M3),1)M3 into tempDtlTtlPot_LP from ( " +
                        " select [Group],TotPotongM3 M3 from tempTotPotong_QA union all " +
                        " select * from tempTtlPot_LPU ) as x group by [Group] " +
                        " /** End Detail Total Potong System dan ListPlank **/  " +

                        " /** Selisih Total Potong **/ " +
                        " declare @TtlPot_Selisih decimal(10,2) " +
                        " declare @TtlPotSystem_ListPlank decimal(10,2) " +

                        " set @TtlPotSystem_ListPlank =(select sum(M3)M3 from tempDtlTtlPot_LP) " +
                        " set @TtlPot_Selisih = ( @TtlPot_LPSystem - @TtlPotSystem_ListPlank) " +
                        " /** End Selisih Total Potong **/ " +

                        " /** Total Group Produksi **/ " +
                        " declare @TtlGroup varchar(3) " +
                        " set @TtlGroup=(select count([Group])TtlGroup from ( " +
                        " select [Group] from ( " +
                        " select [Group] from detailDfctSystemBM_M3 union all " +
                        " select [Group] from DtlDefectSystemFN_M3 ) as x group by [Group] ) as x1) " +
                        " /** End Total Group Produksi **/ " +

                        " /** Detail Selisih Total Potong **/ " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[DtlSelisihTtlPot_LP]') AND type in (N'U')) DROP TABLE [dbo].DtlSelisihTtlPot_LP " +

                        " select [Group],round(@TtlPot_Selisih/@TtlGroup,1) M3 into DtlSelisihTtlPot_LP from ( " +
                        " select [Group] from detailDfctSystemBM_M3 union all " +
                        " select [Group] from DtlDefectSystemFN_M3 ) as x group by [Group] " +
                        " /** End Detail Selisih Total Potong **/ " +

                        " /** Detail Total Potong **/ " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDetail_TtlPot]') AND type in (N'U')) DROP TABLE [dbo].tempDetail_TtlPot " +

                        " select [Group],round(sum(M3),0)M3 into tempDetail_TtlPot from ( " +
                        " select * from tempDtlTtlPot_LP union all " +
                        " select * from DtlSelisihTtlPot_LP ) as x group by [Group] " +
                        " /** End Detail Total Potong **/ " +
                        " /** End Tambahan Baru **/ " +
                        " " +
                         QueryTotalPotong +
                        " " +
                        "declare @DefectFin decimal(18,2) " +
                        "set @DefectFin= (select sum(kubik) from (  " +
                        "select case when D.DeptID=0 then  " +
                        "case when GJ.GroupJemurName In ('M','N','O','P','Q','R','S','T','U','V','W','X') then   " +
                        "case when D.DefName='retak' then 2   " +
                        "when D.DefName='gompal' then 3  " +
                        "else D.DeptID end   " +
                        "else    " +
                        "case when (B.Qty/E.Qty) *100 >5 then 2 else 3 end   " +
                        "end  " +
                        "else D.DeptID end deptID1,A.CreatedTime as tglInput,A.Tgl as TglPeriksa,E.TglProduksi as TglProd,  D.DefCode,BP.PlantName as Line, PG.[Group],BF.FormulaCode as Jenis,   " +
                        "D.DefName,D.DeptID,B.ID,B.DefectID,B.MasterID,B.Qty,A.ID  DestID,isnull(A.TPotong,0)  QtyIn,B.Qty*I.Volume as Kubik,isnull(A.TPotong,0) as TotPotong,'' sfrom  " +
                        "from Def_DefectDetail B inner join Def_Defect A on A.Id=B.DefectID   " +
                        "left join Def_MasterDefect D on B.MasterID=D.ID left join BM_Destacking E on E.ID=A.DestID   " +
                        "left join BM_PlantGroup PG on A.GroupProdID=PG.ID left join BM_Formula BF on BF.ID=E.FormulaID    " +
                        "left join BM_Plant BP on BP.ID=E.PlantID left join FC_Items I on I.ID=E.ItemID inner join Def_GroupJemur GJ on GJ.ID=A.GroupJemurID  " +
                        "where B.RowStatus>-1  and D.RowStatus >-1) as Def    " +
                        "where DeptID1<>2 and CONVERT(varchar,TglPeriksa,112)>=@thnbln1 and CONVERT(varchar,TglPeriksa,112)<=@thnbln2) " +
                        " " +
                        "select * into tempdefectFin from ( " +
                        "select 'OKKW' fin, sum(qtyout) lembar,sum(qtyout * kubik)kubik from ( " +
                        "select I1.PartNo partno1,I1.Panjang * I1.Lebar luas1,  S.qtyin,I2.PartNo partno2,I2.Panjang * I2.Lebar luas2,  S.qtyout ,(I2.Tebal * I2.Panjang * I2.Lebar)/1000000000 kubik " +
                        "from t3_simetris S inner join T3_Serah Se on S.SerahID =Se.ID inner join fc_items I1 on Se.ItemID=I1.ID inner join fc_items I2 on S.ItemID=I2.id  " +
                        "where I2.lebar>500 and S.RowStatus>-1 and CONVERT(varchar,S.tgltrans,112)>=@thnbln1 and CONVERT(varchar,S.tgltrans,112)<=@thnbln2 )a where partno1 like '%-1-%' and luas1>=luas2*2 and partno2 like '%-p-%' " +
                        "union all " +
                        "select 'BP' fin, sum(qtyout) lembar,sum(qtyout * kubik)kubik from ( " +
                        "select I1.PartNo partno1,I1.Panjang * I1.Lebar luas1,  S.qtyin,I2.PartNo partno2,I2.Panjang * I2.Lebar luas2,  S.qtyout ,(I2.Tebal * I2.Panjang * I2.Lebar)/1000000000 kubik " +
                        "from t3_simetris S inner join T3_Serah Se on S.SerahID =Se.ID inner join fc_items I1 on Se.ItemID=I1.ID inner join fc_items I2 on S.ItemID=I2.id  " +
                        "where I2.lebar>500 and S.RowStatus>-1 and CONVERT(varchar,S.tgltrans,112)>=@thnbln1 and CONVERT(varchar,S.tgltrans,112)<=@thnbln2  )a where partno1 like '%-1-%' and luas1>=luas2*2 and  " +
                        "(partno2 like '%-3-%' or partno2 like '%-w-%' or partno2 like '%-m-%') " +
                        "union all " +
                        "select 'BS' fin,sum(R.QtyIn) Lembar,sum(R.QtyIn *((I.tebal*I.panjang*I.lebar)/1000000000)) kubik from T3_Rekap R inner join FC_Items I on R.ItemID=I.id inner join fc_lokasi L on R.LokID =L.id where R.RowStatus>-1 and  " +
                        "CONVERT(varchar,R.tgltrans,112)>=@thnbln1 and CONVERT(varchar,R.tgltrans,112)<=@thnbln2 and I.PartNo like '%-s-%' and Process='direct')A " +
                        " " +
                        "declare @TotalPotong decimal(18,2) " +
                        "declare @TotalDefKhusus decimal(18,2) " +
                        "declare @DefKhusus decimal(18,2) " +
                        "declare @Ttotalkw1kw2 decimal(18,2) " +
                        "declare @NCSortir decimal(18,2) " +
                        "declare @Retur decimal(18,2) " +
                        "set @TotalPotong=isnull((select sum(totkubik ) from tempdefectGPIsoTot),0) " +
                        "if @TotalPotong >0  " +
                        "begin " +
                        "set @TotalDefKhusus=isnull((select sum(kubik) from tempdefectFin),0) " +
                        "set @DefKhusus=isnull((select sum(kubik) from tempdefectFin where fin<>'bp'),0) " +
                        "set @Ttotalkw1kw2 =isnull((select sum(qtyin *((I.tebal*I.Lebar*I.Panjang)/1000000000)) from T3_Rekap R inner join fc_items I on R.itemid=I.ID  " +
                        "where R.rowstatus>-1 and R.Process  like '%simetris%' and CONVERT(varchar,R.tgltrans,112)>=@thnbln1 and CONVERT(varchar,R.tgltrans,112)<=@thnbln2   " +
                        "and I.lebar=1200 and I.panjang=2400 and R.keterangan like '%-p-%' and (I.partno like '%-3-%' or I.partno like '%-W-%' or I.partno like '%-M-%' )),0) " +
                        "set @NCSortir=isnull((select /*sum(QtyAkhirSS)+sum(QtyAkhirSE)*/sum(M3AkhirSS)+sum(M3AkhirSE) from (  " +
                        "SELECT B.tgltrans as Tanggal, I1.PartNo as PartnoAwal, sum(B.QtyIn) as QtyAwal,sum(I1.Volume*B.QtyIn) M3Awal,   " +
                        "I2.PartNo AS PartnoAkhir, case when B.NCSS>0 then sum(B.QtyOut) else 0 end QtyAkhirSS,  " +
                        "case when B.NCSS>0 then sum(I2.Volume*B.QtyOut) else 0 end M3AkhirSS,case when B.NCSE>0 then sum(B.QtyOut) else 0 end QtyAkhirSE,  " +
                        "case when B.NCSE>0 then sum(I2.Volume*B.QtyOut) else 0 end M3AkhirSE,B.NCSS,B.NCSE  FROM T3_Serah AS A   " +
                        "INNER JOIN T3_Simetris AS B ON A.ID = B.SerahID INNER JOIN FC_Items AS I1 ON A.ItemID = I1.ID INNER JOIN   " +
                        "FC_Items AS I2 ON B.ItemID = I2.ID LEFT JOIN T3_GroupM AS D ON B.GroupID = D.ID   " +
                        "where (B.NCSS>0 or B.NCSE>0) and B.rowstatus>-1 and CONVERT(varchar,B.tgltrans,112)>=@thnbln1 and CONVERT(varchar,B.tgltrans,112)<=@thnbln2   " +
                        "group by B.tgltrans,I1.PartNo,I2.PartNo,B.NCSS,B.NCSE) S),0) " +

                        //"set @Retur=isnull((select sum(qty) from ( " +
                        //"select sum(qty *(I.tebal*I.panjang*I.lebar)/1000000000) qty from t3_retur R inner join fc_items I on R.itemid=I.id where R.rowstatus>-1 and  " +
                        //"R.typer=1 and (I.partno like '%-p-%' or I.partno like '%-S-%')  and CONVERT(varchar,R.tgltrans,112)>=@thnbln1 and CONVERT(varchar,R.tgltrans,112)<=@thnbln2  " +
                        //"union all " +
                        //"select sum(qty *(I.tebal*I.panjang*I.lebar)/1000000000)*-1 qty from t3_retur R inner join fc_items I on R.itemid=I.id where R.rowstatus>-1 and  " +
                        //"R.typer=2 and (I.partno like '%-p-%' or I.partno like '%-S-%')and CONVERT(varchar,R.tgltrans,112)>=@thnbln1 and CONVERT(varchar,R.tgltrans,112)<=@thnbln2 " +
                        //"union all " +
                        //"select sum(qty *(I.tebal*I.panjang*I.lebar)/1000000000) qty from t3_returO R inner join fc_items I on R.itemid=I.id where R.rowstatus>-1 and  " +
                        //"(I.partno like '%-p-%' or I.partno like '%-S-%') and CONVERT(varchar,R.tgltrans,112)>=@thnbln1 and CONVERT(varchar,R.tgltrans,112)<=@thnbln2)A),0) " +
                        //" " +

                        "set @Retur=isnull((select round((TotK1-TotK2)+TotK3,2)TotM3 from ( " +
                        "select round(sum(Volume*Tot1),3)TotK1,round(sum(Volume*Tot2),3)TotK2,round(sum(Volume*Tot3),3)TotK3 from ( " +
                        "select tanggal,PartNo,volume ,sum(isnull(QtyC1,0))QtyC1,sum(isnull(QtyP1,0)) QtyP1,sum(isnull(QtyS1,0)) QtyS1, " +
                        "sum(isnull(Tot1,0)) Tot1,sum(isnull(TotK1,0)) TotK1, sum(isnull(QtyC2,0)) QtyC2,sum(isnull(QtyP2,0)) QtyP2, " +
                        "sum(isnull(QtyS2,0)) QtyS2,sum(isnull(Tot2,0)) Tot2, sum(isnull(TotK2,0)) TotK2,sum(isnull(QtyC3,0)) QtyC3, " +
                        "sum(isnull(QtyP3,0)) QtyP3,sum(isnull(QtyS3,0)) QtyS3,sum(isnull(Tot3,0)) Tot3,sum(isnull(TotK3,0)) TotK3 from ( " +
                        "select tanggal ,PartNo,volume,case when typeR=1 and ((KW='3' or KW='W')or lokasi='cl') then Qty end QtyC1, " +
                        "case when typeR=1 and (KW='P'and lokasi <> 'cl') then Qty end QtyP1, case when typeR=1 and (KW='S'and lokasi <> 'cl') " +
                        "then Qty end QtyS1, case when typeR=1 and ((KW='P' or KW='S') and lokasi <> 'cl') then Qty end Tot1, " +
                        "case when typeR=1 and (KW='P' or KW='S') then QtyK end TotK1, case when typeR=2 and ((KW='3' or KW='W')or lokasi='cl') " +
                        "then Qty end QtyC2, case when typeR=2 and (KW='P' and lokasi <> 'cl') then Qty end QtyP2, case when typeR=2 and (KW='S' and " +
                        "lokasi <> 'cl') then Qty end QtyS2, case when typeR=2 and ((KW='P' or KW='S') and lokasi <> 'cl') then Qty end Tot2, " +
                        "case when typeR=2 and ((KW='P' or KW='S') and lokasi <> 'cl') then QtyK end TotK2, case when typeR=3 and ((KW='3' or KW='W') " +
                        "or lokasi='cl') then Qty end QtyC3, case when typeR=3 and (KW='P' and lokasi <> 'cl') then Qty end QtyP3, " +
                        "case when typeR=3 and (KW='S' and lokasi <> 'cl') then Qty end QtyS3, case when typeR=3 and ((KW='P' or KW='S') and lokasi <> 'cl') " +
                        "then Qty   end Tot3, case when typeR=3 and ((KW='P' or KW='S') and lokasi <> 'cl') then QtyK end TotK3 from (  " +
                        "select R.TglTrans tanggal,I.PartNo,I.volume,SUBSTRING(I.partno,5,1) as KW,sum(R.Qty)Qty,sum(((I.Panjang*I.Lebar)/(1220*2440) ) * R.Qty) QtyK, " +
                        "isnull(R.TypeR,1)  TypeR,I.ID,L.Lokasi     from T3_Retur R inner join FC_Items I on R.ItemID =I.ID  " +
                        "inner join FC_lokasi L on R.LokID=L.ID  where R.RowStatus>-1     group by R.TglTrans,I.PartNo,I.volume,R.TypeR,I.ID,L.Lokasi " +
                        "union all select R.TglTrans tanggal,I.PartNo,I.volume,SUBSTRING(I.partno,5,1) as KW,sum(R.Qty)Qty,sum(((I.Panjang*I.Lebar)/(1220*2440))* R.Qty) " +
                        "QtyK,3  TypeR,I.ID,L.Lokasi     from T3_ReturO R inner join FC_Items I on R.ItemID =I.ID  inner join FC_lokasi L on R.LokID=L.ID " +
                        "where R.RowStatus>-1     group by R.TglTrans,I.PartNo,I.volume,I.ID,L.Lokasi ) as A ) as B " +
                        "where convert(char,tanggal,112)>=@thnbln1 and convert(char,tanggal,112)<=@thnbln2 group by tanggal,PartNo,volume ) as x ) as x1),0) " +

                        "declare @TotalPotongL1 decimal(18,2) " +
                        "declare @TotDefKhususL1 decimal(18,2) " +
                        "declare @DefKhususL1 decimal(18,2) " +
                        "declare @Ttotalkw1kw2L1 decimal(18,2) " +
                        "declare @NCSortirL1 decimal(18,2) " +
                        "declare @ReturL1 decimal(18,2) " +
                        "declare @DefectFinL1 decimal(18,2) " +

                        "set @TotalPotongL1=(select isnull(sum(totkubik ),0) from tempdefectGPIsoTot where [group]in (select [group] from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 1'))) " +
                        "set @TotDefKhususL1=(@TotalPotongL1/@TotalPotong)*@TotalDefKhusus " +
                        "set @DefKhususL1=(@TotalPotongL1/@TotalPotong)*@DefKhusus " +
                        "set @Ttotalkw1kw2L1=(@TotalPotongL1/@TotalPotong)*@Ttotalkw1kw2 " +
                        "set @NCSortirL1=(@TotalPotongL1/@TotalPotong)*@NCSortir " +
                        "set @ReturL1=(@TotalPotongL1/@TotalPotong)*@Retur " +
                        "set @DefectFinL1=isnull((@TotalPotongL1/@TotalPotong)*@DefectFin,0) " +

                        " /** Tambahan OK KM **/ " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempOKKM_m3]') AND type in (N'U')) DROP TABLE [dbo].tempOKKM_m3 " +
                        " select [Group],round((M3/@TtlDfctSystemBM_M3)*@Ttotalkw1kw2,2) M3 into tempOKKM_m3 from detailDfctSystemBM_M3 order by [group] " +
                        " /** End Tambahan **/ " +

                        " /** Tambahan Sortir **/ " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempSortir_m3]') AND type in (N'U')) DROP TABLE [dbo].tempSortir_m3 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempSortir_1_m3]') AND type in (N'U')) DROP TABLE [dbo].tempSortir_1_m3 " +

                        " select [Group],round((M3/@TtlDfctSystemBM_M3)*@NCSortir,4) M3 into tempSortir_m3 from detailDfctSystemBM_M3 order by [group] " +

                        " select [Group],round(M3,4)M3 into tempSortir_1_m3 from ( " +
                        " select [Group],round(M3,4)M3 from ( " +
                        " select * from tempSortir_m3 ) as x ) as x1 " +
                        " /** End Tambahan **/ " +

                        " /** Tambahan Return **/ " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempRetur_m3]') AND type in (N'U')) DROP TABLE [dbo].tempRetur_m3 " +
                        " select [Group],round((M3/@TtlDfctSystemBM_M3)*@Retur,4) M3 into tempRetur_m3 from detailDfctSystemBM_M3 order by [group] " +
                        " /** End Tambahan **/ " +

    /** Tambahan 15 April 2021 **/

    /** Baru **/

    //select @TtlDfctBMFN_M3 /** Total Defect **/
    //select @TtlDefectBM_M3 /** Total Defect System BM **/
    //select @TtlDfctSystemFN_M3 /** Total Defect System Finishing **/
    //select sum(m3)m3 from tes1 /** Total Defect Ukuran Khusus **/
    //select sum(m3) from tempBagiDefectLP_m3 /** Total Defect ListPlank **/

    "declare @SelisihTtlDefect varchar(30) " +

    "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[DetailSTtlDefect]') AND type in (N'U')) DROP TABLE [dbo].DetailSTtlDefect  " +
    "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[DetailDefectBMFin]') AND type in (N'U')) DROP TABLE [dbo].DetailDefectBMFin  " +

    "set @SelisihTtlDefect = @TtlDfctBMFN_M3 - @TtlDefectBM_M3 - @TtlDfctSystemFN_M3 - (select sum(m3) from tes1) - (select sum(m3) from tempBagiDefectLP_m3) " +

    /** Detail Selisih Total Defect **/
    "select [Group],round(((m3/@TtlDefectBM_M3)* @SelisihTtlDefect),1)M3 into DetailSTtlDefect from detailDfctSystemBM_M3 order by [Group]  " +

    /** Detail Defect BM + Finishing **/
    "select [Group],round(sum(M3),1)M3 into DetailDefectBMFin from ( " +
    "select * from detailDfctSystemBM_M3 union all " +
    "select * from DtlDefectSystemFN_M3 union all " +
    "select * from DetailSTtlDefect ) as x group by [group] " +


    /** Detail Defect Ukuran Khusus **/
    "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Bm01]') AND type in (N'U')) DROP TABLE [dbo].Bm01 " +
    "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Bm02]') AND type in (N'U')) DROP TABLE [dbo].Bm02   " +
    "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Bm03]') AND type in (N'U')) DROP TABLE [dbo].Bm03 " +
    "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Bm04]') AND type in (N'U')) DROP TABLE [dbo].Bm04 " +
    "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Bm05]') AND type in (N'U')) DROP TABLE [dbo].Bm05 " +
    "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Dataxx]') AND type in (N'U')) DROP TABLE [dbo].Dataxx " +
    "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Dataxxx]') AND type in (N'U')) DROP TABLE [dbo].Dataxxx " +
    "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Dataxx01]') AND type in (N'U')) DROP TABLE [dbo].Dataxx01 " +
    "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Dataxx02]') AND type in (N'U')) DROP TABLE [dbo].Dataxx02 " +
    "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Dataxx03]') AND type in (N'U')) DROP TABLE [dbo].Dataxx03 " +
    "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[DetailDefectKhusus]') AND type in (N'U')) DROP TABLE [dbo].DetailDefectKhusus " +

     "select * into Bm01 from ( " +
    "select distinct ItemID,PlantID,left(convert(char,tglproduksi,112),6)ThnBln from BM_Destacking where RowStatus>-1 group by ItemID,PlantiD,TglProduksi  " +
    ") as x order by ThnBln,ItemID desc " +

    "select x.*,x1.PartNo into Bm02 from ( " +
    "select *,(select count(ItemID) from Bm01 B where B.ItemID=A.ItemID and B.ThnBln=A.ThnBln and ItemID>0)ttl from Bm01 A where ItemID>0) as x inner join FC_Items x1 ON x1.ID=x.ItemID " +

    "select *,case when ttl=0 then 0 else cast(100 as decimal(10,2))/cast(ttl as decimal(10,2)) end PerSen into Bm03 from Bm02 order by ThnBln desc " +

    "select ItemID into Dataxx  from ( " +
    "select A.ID ItemID from ( " +
    " select distinct PartNo from vw_KartuStockBJNew  where qty <0 and (process  like '%simetris%' ) and  (Keterangan like '%-P-%') and  LokID not In (select ID from FC_Lokasi where lokasi='q99')   and left(convert(char,tanggal,112),6)=SUBSTRING(@thnbln1,1,6) and ItemID in (select ID  from FC_Items where PartNo like'%-1-%')) as x inner join FC_Items A ON A.PartNo=x.PartNo ) as xx " +

    "select B.PlantID,B.PerSen into Dataxxx from Dataxx A left join Bm03 B ON B.ItemID=A.ItemID where B.ThnBln=SUBSTRING(@thnbln1,1,6) " +
    "select distinct PlantID,'1'Flag into Dataxx01 from Dataxxx " +

    "select [Group],sum(cast(Flag as int)) Flag,Line into Dataxx02 from ( " +
    " select case  " +
    " when PlantID=1 then 'CA,CB,CC,CD'  " +
    " when PlantID=2 then 'CE,CF,CG,CH'  " +
    " when PlantID=3 then 'CI,CJ,CK,CL'  " +
    " when PlantID=4 then 'CM,CN,CO,CP'   " +
    " end [Group],Flag,PlantID Line from Dataxx01 " +
    " union all  select 'CA,CB,CC,CD'[Group],'0'Flag,'1'Line " +
    " union all  select 'CE,CF,CG,CH'[Group],'0'Flag,'2'Line " +
    " union all  select 'CI,CJ,CK,CL'[Group],'0'Flag,'3'Line " +
    " union all  select 'CM,CN,CO,CP'[Group],'0'Flag,'4'Line ) as x group by [Group],Line " +

    " SELECT A.[Line],A.Flag,Split.a.value('.', 'VARCHAR(100)') AS [Group]  into Dataxx03   FROM  (SELECT [Line],Flag,CAST ('<M>' + REPLACE([Group], ',', '</M><M>') + '</M>' AS XML) AS String FROM  Dataxx02) AS A CROSS APPLY String.nodes ('/M') AS Split(a);  " +

    " select [Group],case when Flag >0 then (select sum(m3) from tes1)/(select @TtlGroup) else 0 end M3 into DetailDefectKhusus from Dataxx03  " +



    /** Detail Defect ListPlank **/
    " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[TempBm01]') AND type in (N'U')) DROP TABLE [dbo].TempBm01 " +
    "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[TempBm02]') AND type in (N'U')) DROP TABLE [dbo].TempBm02 " +
    "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[TempBm03]') AND type in (N'U')) DROP TABLE [dbo].TempBm03 " +
    "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[TempBm04]') AND type in (N'U')) DROP TABLE [dbo].TempBm04 " +
    "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[TempBm05]') AND type in (N'U')) DROP TABLE [dbo].TempBm05 " +
    "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[TempBm06]') AND type in (N'U')) DROP TABLE [dbo].TempBm06 " +
    "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[TempBm07]') AND type in (N'U')) DROP TABLE [dbo].TempBm07 " +
    "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[TempBm08]') AND type in (N'U')) DROP TABLE [dbo].TempBm08 " +
    "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[TempBm09]') AND type in (N'U')) DROP TABLE [dbo].TempBm09 " +
    "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[TempBm10]') AND type in (N'U')) DROP TABLE [dbo].TempBm10 " +
    "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[DetailDefectListPlank]') AND type in (N'U')) DROP TABLE [dbo].DetailDefectListPlank " +

    "select A.*,B.ID ItemID into TempBm01 from ( " +
    "select PartNo,SUBSTRING(PartNo,7,3)/10 Tebal,SUBSTRING(PartNo,1,3)Jenis from ( " +
    "select PartNo from tesLPRs1_m3 union all " +
    "select PartNo from tesSAwal_RS_m3 union all " +
    "select PartNo from tesSAkhir_RS union all " +
    "select PartNo from tesSAwal_Bv union all " +
    "select PartNo from tesSAkhir_Bv union all " +
    "select PartNo from tesSAwal_Str union all " +
    "select PartNo from tesSAkhir_Str union all " +
    "select PartNo from tesSAkhir_Str union all " +
    "select PartNo from tesTahap3_OK union all " +
    "select PartNo from tesTahap3_BP ) as x group by PartNo  " +
    ") as A inner join FC_Items B ON A.PartNo=B.PartNo " +

    " select x.*,SUBSTRING(x1.PartNo,1,3)Kode into TempBm02 from ( " +
    "select distinct ItemID,PlantID,left(convert(char,tglproduksi,112),6)ThnBln from BM_Destacking where RowStatus>-1 and LokasiID not in (select ID from FC_Lokasi where Lokasi like'%adj%' ) group by ItemID,PlantiD,TglProduksi  " +
    ") as x inner join FC_Items x1 ON x.ItemID=x1.ID " +

    "select *,SUBSTRING(@thnbln1,1,6)ThnBln into TempBm03 from ( " +
    "select Kode,PlantID  from ( " +
    "select Kode,PlantID from TempBm02 where ThnBln=SUBSTRING(@thnbln1,1,6) and kode in (select Jenis from TempBm01)) as x group by Kode,PlantID " +
    "union all " +
    "select Jenis,'0'PlantID from TempBm01 where Jenis not in (select Kode from TempBm02 where ThnBln=SUBSTRING(@thnbln1,1,6))) as xx  " +

    "select xx.Kode,AA.PlantID,AA.ThnBln into TempBm04 from ( " +
    "select Kode,PlantID  from ( " +
    "select Kode,PlantID from TempBm02 where ThnBln=SUBSTRING(@thnbln1,1,6) and kode in (select Jenis from TempBm01)) as x group by Kode,PlantID " +
    "union all " +
    "select Jenis,'0'PlantID from TempBm01 where Jenis not in (select Kode from TempBm02 where ThnBln=SUBSTRING(@thnbln1,1,6))) as xx left join TempBm02 AA ON AA.Kode=xx.Kode where xx.PlantID=0  group by xx.Kode,AA.PlantID,AA.ThnBln order by ThnBln desc " +

    "select Kode,COUNT(PlantID)Ttl,ThnBln into TempBm06 from ( " +
    "select * from TempBm04 ) as x group by Kode,ThnBln " +

    "select *,case when PlantID=0 then (select top 1 ThnBln from TempBm06 order by ThnBln desc) else '0' end ThnBln2 into TempBm07 from TempBm03 A " +

    "select PlantID,'1'flag into TempBm08 from ( " +
    "select B.Kode,B.PlantID from TempBm07 A inner join TempBm04 B ON A.Kode=B.Kode and A.ThnBln2=B.ThnBln " +
    "union all " +
    "select Kode,PlantID from TempBm07 where PlantID>0 ) as x " +

    "select [Group],Line,sum(cast(flag as int))Flag  into TempBm09 from ( " +
    "select case  " +
    " when PlantID=1 then 'CA,CB,CC,CD'  " +
    " when PlantID=2 then 'CE,CF,CG,CH' " +
    " when PlantID=3 then 'CI,CJ,CK,CL' " +
    " when PlantID=4 then 'CM,CN,CO,CP'   " +
    "end [Group],PlantID Line,flag from TempBm08   " +
    " union all  select 'CA,CB,CC,CD'[Group],'1'Line,'0'Flag " +
    " union all  select 'CE,CF,CG,CH'[Group],'2'Line,'0'Flag " +
    " union all  select 'CI,CJ,CK,CL'[Group],'3'Line,'0'Flag " +
    " union all  select 'CM,CN,CO,CP'[Group],'4'Line,'0'Flag " +
    " ) as x group by [Group],Line  " +

    "SELECT A.[Line],A.Flag,Split.a.value('.', 'VARCHAR(100)') AS [Group] into  TempBm10  FROM  (SELECT [Line],Flag,CAST ('<M>' + REPLACE([Group], ',', '</M><M>') + '</M>' AS XML) AS String FROM  TempBm09) AS A CROSS APPLY String.nodes ('/M') AS Split(a);  " +

    "select [Group],case when Flag >0 then (select sum(M3) from tempBagiDefect_LP2_m3)/(select @TtlGroup) else 0 end M3 into DetailDefectListPlank from TempBm10 " +



    /** Detail Defect Produksi **/
    "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDetailDP]') AND type in (N'U')) DROP TABLE [dbo].tempDetailDP " +

    "select [Group],sum(M3)M3 into tempDetailDP from ( " +
    "select * from DetailDefectBMFin union all " +
    "select * from DetailDefectKhusus union all " +
    "select * from DetailDefectListPlank ) as x group by [group] " +

    /** Detail BS Tahap-1 **/
    //"--select * from tempDetailBSTahap1

    /** Detail Total Defect **/
    "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDetailTotalDefect]') AND type in (N'U')) DROP TABLE [dbo].tempDetailTotalDefect " +

    "select [Group],sum(M3)M3 into tempDetailTotalDefect from ( " +
    "select [Group],sum(Kubik) M3 from tempdefectGPIso2  group by [Group] union all " +
    "select [Group],M3 from detailDfctSystemBM_M3 union all " +
    "select [Group],M3 from DetailDefectBMFin  union all " +
    "select [Group],M3 from DetailDefectKhusus union all " +
    "select [Group],M3 from DetailDefectListPlank  union all " +
    "select [Group],M3 from tempDetailBSTahap1 ) as x group by [Group] " +

    /** Detail Total Defect Produksi **/
    "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDetailTotalDefectProd]') AND type in (N'U')) DROP TABLE [dbo].tempDetailTotalDefectProd " +

    "select [Group],sum(M3)M3 into tempDetailTotalDefectProd from ( " +
    "select * from DetailDefectListPlank union all " +
    "select * from DetailDefectBMFin union all " +
    "select * from Dataxx04 ) as x group by [Group] " +

    /** Detail Total potong system QA **/
    //--select * from tempTotPotong_QA

    /** Detail Total potong system QA **/
    "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTotalDefect2]') AND type in (N'U')) DROP TABLE [dbo].tempTotalDefect2 " +

    "select sum(M3)M3 into tempTotalDefect2 from ( " +
    " select sum(M3)M3 from tes1 union all " +
    "  select sum(M3)M3 from tes1_OK union all " +
    "  select sum(M3)M3 from tempTtl_LP_OK union all  " +
    "  select sum(m3)M3 from tempBagiDefectLP_m3) as x " +

     /** Total potong ListPlank dan Ukuran Khusus **/
     " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTotPotLU]') AND type in (N'U')) DROP TABLE [dbo].tempTotPotLU " +
     " select [Group],case when M3>0 then ((select * from tempTotalDefect2)/(select @TtlGroup)) else 0 end M3 into tempTotPotLU from tempDetailTotalDefectProd " +

    /** Total potong System dan ListPlank **/
    "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTotPotSystemLP]') AND type in (N'U')) DROP TABLE [dbo].tempTotPotSystemLP " +

    "select [Group],sum(M3)M3 into tempTotPotSystemLP from ( " +
    "select  [Group],TotPotongM3 M3 from tempTotPotong_QA union all " +
    "select [Group],M3 from tempTotPotLU ) as x group by [Group] " +

    /** Selisih Total Potong **/
    "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempSelisihTP]') AND type in (N'U')) DROP TABLE [dbo].tempSelisihTP " +
    "declare @SelisihTP varchar(30) " +
    "set @SelisihTP=(select (select sum(M3) from tempDetail_TtlPot) - (select sum(M3) from tempTotPotSystemLP)) " +

    "select [Group],case when M3>0 then (select cast(@SelisihTP as decimal(10,2)))/(select @TtlGroup) else 0 end M3 into tempSelisihTP from tempDetailTotalDefectProd " +

    /** Total Potong **/
    "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTotalPotong]') AND type in (N'U')) DROP TABLE [dbo].tempTotalPotong " +
    "select [Group],sum(M3)M3 into tempTotalPotong from ( " +
    "select * from tempSelisihTP union all " +
    "select * from tempTotPotSystemLP ) as x group by [Group] " +

    /** Detail OK KM **/
    "IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempOKKM]') AND type in (N'U')) DROP TABLE [dbo].tempOKKM " +

    "select [Group], (M3/(select sum(M3) from detailDfctSystemBM_M3))*(select sum(M3) from tempOKKM_m3)M3 into tempOKKM from detailDfctSystemBM_M3 " +
                    /** End Baru **/


                        #region Line -1
                    "if @TotalPotongL1>0 " +
                        "begin " +
                        "select [Group],round(b,4)b,round(c,4)c,round(d,4)d,round(e,4)e,round(f,4)f,round(g,4)g,round(i,4)i,j into tempdefectL1 from ( " +
                        "select *,/**c-d+e+f+g i**/ (c+e+f+g)-d i,case when b>0 then round(((c-d+e+f+g)/b)*100,1) else 0  end j from ( " +
                        "select [Group], " +
                        //"case when @TotalPotongL1>0 then isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) +  " +
                        //"  (( isnull(( select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@TotDefKhususL1)  else 0 end b, " +
                        " case when @TotalPotongL1>0 then isnull((select round(M3,5)M3 from tempTotalPotong where [group]=BM_PlantGroup.[Group] ),0)  else 0 end b, " +
                        //" case when @TotalPotongL1>0 then isnull((select totdefectK from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)  else 0 end c, " +
                        " case when @TotalPotongL1>0 then isnull((select round(M3,5)M3 from tempDetailDP where [group]=BM_PlantGroup.[Group] ),0)  else 0 end c, " +
                        //" case when @TotalPotongL1>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@Ttotalkw1kw2L1) else 0 end  d, " +
                        " case when @TotalPotongL1>0 then ((isnull((select round(M3,5)M3 from tempOKKM where [group]=BM_PlantGroup.[Group] ),0))) else 0 end  d,  " +
                        //" case when @TotalPotongL1>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@NCSortirL1)  else 0 end  e, " +
                        " case when @TotalPotongL1>0 then ((isnull((select round(M3,5)M3 from tempSortir_1_m3 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  e, " +
                        //" case when @TotalPotongL1>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@ReturL1)  else 0 end  f, " +
                        " case when @TotalPotongL1>0 then ((isnull((select round(M3,5)M3 from tempRetur_m3 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  f, " +
                        //" case when @TotalPotongL1>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@DefectFinL1)  else 0 end g, " +
                        " case when @TotalPotongL1>0 then ((isnull((select round(M3,5)M3 from tempDetailBSTahap1 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end g  " +
                        //" case when @TotalPotongL1>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@DefKhususL1) else 0 end  h " +
                        " from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 1') )A " +

                        "union all  " +

                        "select 'Total' [Group],sum(b)b,sum(c)c,sum(d)d,sum(e)e,sum(f)f,sum(g)g,/**sum(c)-sum(d)+sum(e)+sum(f)+sum(g) i**/ (sum(c)+sum(e)+sum(f)+sum(g))-sum(d) i" +
                        ",case when sum(b)>0 then round((sum(c)-sum(d)+sum(e)+sum(f)+sum(g))/sum(b)*100,1) else 0 end j from( " +
                        "select [Group], " +
                        //" case when @TotalPotongL1>0 then isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) +  " +
                        //"  (( isnull(( select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@TotDefKhususL1)  else 0 end b, " +
                        " case when @TotalPotongL1>0 then isnull((select round(M3,4)M3 from tempTotalPotong where [group]=BM_PlantGroup.[Group] ),0)  else 0 end b,  " +
                        //" case when @TotalPotongL1>0 then isnull((select totdefectK from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)  else 0 end c, " +
                        " case when @TotalPotongL1>0 then isnull((select round(M3,4)M3 from tempDetailDP where [group]=BM_PlantGroup.[Group] ),0)  else 0 end c,  " +
                        //" case when @TotalPotongL1>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@Ttotalkw1kw2L1) else 0 end  d, " +
                        " case when @TotalPotongL1>0 then ((isnull((select round(M3,4)M3 from tempOKKM where [group]=BM_PlantGroup.[Group] ),0))) else 0 end  d, " +
                        //" case when @TotalPotongL1>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@NCSortirL1)  else 0 end  e, " +
                        " case when @TotalPotongL1>0 then ((isnull((select round(M3,4)M3 from tempSortir_1_m3 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  e,  " +
                        //" case when @TotalPotongL1>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@ReturL1)  else 0 end  f, " +
                        " case when @TotalPotongL1>0 then ((isnull((select round(M3,4)M3 from tempRetur_m3 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  f,  " +
                        //" case when @TotalPotongL1>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@DefectFinL1)  else 0 end g, " +
                        " case when @TotalPotongL1>0 then ((isnull((select round(M3,4)M3 from tempDetailBSTahap1 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end g,  " +
                        //" case when @TotalPotongL1>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL1)*@DefKhususL1) else 0 end  h, " +
                        " 0 i,0 j from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 1'))A )B " +
                        " end " +
                        " else " +
                        " begin " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 i, 0 j into tempdefectL1 " +
                        " end " +
                        #endregion
 " " +
                        "declare @TotalPotongL2 decimal(18,2) " +
                        "declare @TotDefKhususL2 decimal(18,2) " +
                        "declare @DefKhususL2 decimal(18,2) " +
                        "declare @Ttotalkw1kw2L2 decimal(18,2) " +
                        "declare @NCSortirL2 decimal(18,2) " +
                        "declare @ReturL2 decimal(18,2) " +
                        "declare @DefectFinL2 decimal(18,2) " +
                        "set @TotalPotongL2=(select isnull(sum(totkubik ),0) from tempdefectGPIsoTot where [group]in (select [group] from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 2'))) " +
                        " " +
                        "set @TotDefKhususL2=(@TotalPotongL2/@TotalPotong)*@TotalDefKhusus " +
                        "set @DefKhususL2=(@TotalPotongL2/@TotalPotong)*@DefKhusus " +
                        "set @Ttotalkw1kw2L2=(@TotalPotongL2/@TotalPotong)*@Ttotalkw1kw2 " +
                        "set @NCSortirL2=(@TotalPotongL2/@TotalPotong)*@NCSortir " +
                        "set @ReturL2=(@TotalPotongL2/@TotalPotong)*@Retur " +
                        "set @DefectFinL2=isnull((@TotalPotongL2/@TotalPotong)*@DefectFin,0) " +

                        #region Line - 2
 "if @TotalPotongL2>0 " +
                        "begin " +
                        "select [Group],round(b,4)b,round(c,4)c,round(d,4)d,round(e,4)e,round(f,4)f,round(g,4)g,round(i,4)i,j into tempdefectL2 from ( " +
                        "select *,/**c-d+e+f+g i**/ (c+e+f+g)-d i,case when b>0 then round((c-d+e+f+g)/b*100,1) else 0  end j from ( " +
                        " select [Group], " +
                        " case when @TotalPotongL2>0 then isnull((select round(M3,5)M3 from tempTotalPotong where [group]=BM_PlantGroup.[Group] ),0)  else 0 end b,  " +
                        " case when @TotalPotongL2>0 then isnull((select round(M3,5)M3 from tempDetailDP where [group]=BM_PlantGroup.[Group] ),0)  else 0 end c,  " +
                        " case when @TotalPotongL2>0 then ((isnull((select round(M3,5)M3 from tempOKKM where [group]=BM_PlantGroup.[Group] ),0))) else 0 end  d, " +
                        " case when @TotalPotongL2>0 then ((isnull((select round(M3,5)M3 from tempSortir_1_m3 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  e,  " +
                        " case when @TotalPotongL2>0 then ((isnull((select round(M3,5)M3 from tempRetur_m3 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  f,  " +
                        " case when @TotalPotongL2>0 then ((isnull((select round(M3,5)M3 from tempDetailBSTahap1 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end g  " +
                        " from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 2') )A " +

                        "union all  " +

                        "select 'Total' [Group],sum(b)b,sum(c)c,sum(d)d,sum(e)e,sum(f)f,sum(g)g,/**sum(c)-sum(d)+sum(e)+sum(f)+sum(g) i**/ (sum(c)+sum(e)+sum(f)+sum(g))-sum(d) i " +
                        ",case when sum(b)>0 then round((sum(c)-sum(d)+sum(e)+sum(f)+sum(g))/sum(b)*100,1) else 0 end j from(select [Group], " +
                        " case when @TotalPotongL2>0 then isnull((select round(M3,4)M3 from tempTotalPotong where [group]=BM_PlantGroup.[Group] ),0)  else 0 end b,  " +
                        " case when @TotalPotongL2>0 then isnull((select round(M3,4)M3 from tempDetailDP where [group]=BM_PlantGroup.[Group] ),0)  else 0 end c,  " +
                        " case when @TotalPotongL2>0 then ((isnull((select round(M3,4)M3 from tempOKKM where [group]=BM_PlantGroup.[Group] ),0))) else 0 end  d, " +
                        " case when @TotalPotongL2>0 then ((isnull((select round(M3,4)M3 from tempSortir_1_m3 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  e,  " +
                        " case when @TotalPotongL2>0 then ((isnull((select round(M3,4)M3 from tempRetur_m3 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  f,  " +
                        " case when @TotalPotongL2>0 then ((isnull((select round(M3,4)M3 from tempDetailBSTahap1 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end g,  " +
                        " 0 i,0 j from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 2'))A )B " +
                        " end " +
                        " else " +
                        " begin " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 i, 0 j into tempdefectL2 " +
                        " end " +
                        #endregion
 " " +
                        "declare @TotalPotongL3 decimal(18,2) " +
                        "declare @TotDefKhususL3 decimal(18,2) " +
                        "declare @DefKhususL3 decimal(18,2) " +
                        "declare @Ttotalkw1kw2L3 decimal(18,2) " +
                        "declare @NCSortirL3 decimal(18,2) " +
                        "declare @ReturL3 decimal(18,2) " +
                        "declare @DefectFinL3 decimal(18,2) " +
                        "set @TotalPotongL3=(select isnull(sum(totkubik ),0) from tempdefectGPIsoTot where [group]in (select [group] from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 3'))) " +
                        "set @TotDefKhususL3=(@TotalPotongL3/@TotalPotong)*@TotalDefKhusus " +
                        "set @DefKhususL3=(@TotalPotongL3/@TotalPotong)*@DefKhusus " +
                        "set @Ttotalkw1kw2L3=(@TotalPotongL3/@TotalPotong)*@Ttotalkw1kw2 " +
                        "set @NCSortirL3=(@TotalPotongL3/@TotalPotong)*@NCSortir " +
                        "set @ReturL3=(@TotalPotongL3/@TotalPotong)*@Retur " +
                        "set @DefectFinL3=isnull((@TotalPotongL3/@TotalPotong)*@DefectFin,0) " +
                        #region Lin3 - 3
 "if @TotalPotongL3>0 " +
                        "begin " +
                        "select [Group],round(b,4)b,round(c,4)c,round(d,4)d,round(e,4)e,round(f,4)f,round(g,4)g,round(i,4)i,j into tempdefectL3 from ( " +
                        "select *,/**c-d+e+f+g i**/ (c+e+f+g)-d i,case when b>0 then round((c-d+e+f+g)/b*100,1) else 0  end j from ( select [Group], " +
                        //"select [Group],case when @TotalPotongL3>0 then isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) +  " +
                        //" ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@TotDefKhususL3) else 0 end  b, " +
                        //" case when @TotalPotongL3>0 then isnull((select totdefectK from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) else 0 end c, " +
                        //" case when @TotalPotongL3>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@Ttotalkw1kw2L3) else 0 end  d, " +
                        //" case when @TotalPotongL3>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@NCSortirL3) else 0 end  e, " +
                        //" case when @TotalPotongL3>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@ReturL3) else 0 end  f, " +
                        //" case when @TotalPotongL3>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@DefectFinL3) else 0 end  g " +
                        //" case when @TotalPotongL3>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@DefKhususL3) else 0 end  h " +
                        " case when @TotalPotongL3>0 then isnull((select round(M3,5)M3 from tempTotalPotong where [group]=BM_PlantGroup.[Group] ),0)  else 0 end b,  " +
                        " case when @TotalPotongL3>0 then isnull((select round(M3,5)M3 from tempDetailDP where [group]=BM_PlantGroup.[Group] ),0)  else 0 end c,  " +
                        " case when @TotalPotongL3>0 then ((isnull((select round(M3,5)M3 from tempOKKM where [group]=BM_PlantGroup.[Group] ),0))) else 0 end  d, " +
                        " case when @TotalPotongL3>0 then ((isnull((select round(M3,5)M3 from tempSortir_1_m3 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  e,  " +
                        " case when @TotalPotongL3>0 then ((isnull((select round(M3,5)M3 from tempRetur_m3 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  f,  " +
                        " case when @TotalPotongL3>0 then ((isnull((select round(M3,5)M3 from tempDetailBSTahap1 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end g  " +
                        "  from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 3') )A " +

                        "union all  " +

                        "select 'Total' [Group],sum(b)b,sum(c)c,sum(d)d,sum(e)e,sum(f)f,sum(g)g,/**sum(c)-sum(d)+sum(e)+sum(f)+sum(g) i**/ (sum(c)+sum(e)+sum(f)+sum(g))-sum(d) i " +
                        ",case when sum(b)>0 then round((sum(c)-sum(d)+sum(e)+sum(f)+sum(g))/sum(b)*100,1) else 0 end j from( select [Group], " +
                         //"select [Group],isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) +  " +
                         //" ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@TotDefKhususL3) b, " +
                         //" isnull((select totdefectK from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)c, " +
                         //" ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@Ttotalkw1kw2L3) d, " +
                         //" ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@NCSortirL3) e, " +
                         //" ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@ReturL3) f, " +
                         //" ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@DefectFinL3) g, " +
                         ////" ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL3)*@DefKhususL3) h, " +
                         " case when @TotalPotongL3>0 then isnull((select round(M3,4)M3 from tempTotalPotong where [group]=BM_PlantGroup.[Group] ),0)  else 0 end b,  " +
                        " case when @TotalPotongL3>0 then isnull((select round(M3,4)M3 from tempDetailDP where [group]=BM_PlantGroup.[Group] ),0)  else 0 end c,  " +
                        " case when @TotalPotongL3>0 then ((isnull((select round(M3,4)M3 from tempOKKM where [group]=BM_PlantGroup.[Group] ),0))) else 0 end  d, " +
                        " case when @TotalPotongL3>0 then ((isnull((select round(M3,4)M3 from tempSortir_1_m3 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  e,  " +
                        " case when @TotalPotongL3>0 then ((isnull((select round(M3,4)M3 from tempRetur_m3 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  f,  " +
                        " case when @TotalPotongL3>0 then ((isnull((select round(M3,4)M3 from tempDetailBSTahap1 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end g,  " +
                        " 0 i,0 j from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 3'))A )B " +
                        " end " +
                        " else " +
                        " begin " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 i, 0 j into tempdefectL3 " +
                        " end " +
                        #endregion
 " " +
                        "declare @TotalPotongL4 decimal(18,2) " +
                        "declare @TotDefKhususL4 decimal(18,2) " +
                        "declare @DefKhususL4 decimal(18,2) " +
                        "declare @Ttotalkw1kw2L4 decimal(18,2) " +
                        "declare @NCSortirL4 decimal(18,2) " +
                        "declare @ReturL4 decimal(18,2) " +
                        "declare @DefectFinL4 decimal(18,2) " +
                        "set @TotalPotongL4=(select isnull(sum(totkubik ),0) from tempdefectGPIsoTot where [group]in (select [group] from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 4'))) " +
                        "set @TotDefKhususL4=(@TotalPotongL4/@TotalPotong)*@TotalDefKhusus " +
                        "set @DefKhususL4=(@TotalPotongL4/@TotalPotong)*@DefKhusus " +
                        "set @Ttotalkw1kw2L4=(@TotalPotongL4/@TotalPotong)*@Ttotalkw1kw2 " +
                        "set @NCSortirL4=(@TotalPotongL4/@TotalPotong)*@NCSortir " +
                        "set @ReturL4=(@TotalPotongL4/@TotalPotong)*@Retur " +
                        "set @DefectFinL4=isnull((@TotalPotongL4/@TotalPotong)*@DefectFin,0) " +
                        #region Line - 4
 "if @TotalPotongL4>0 " +
                        "begin " +
                        "select [Group],round(b,4)b,round(c,4)c,round(d,4)d,round(e,4)e,round(f,4)f,round(g,4)g,round(i,4)i,j into tempdefectL4 from ( " +
                        "select *,/**c-d+e+f+g i**/ (c+e+f+g)-d i,case when b>0 then round((c-d+e+f+g)/b*100,1) else 0  end j from ( " +
                        "select [Group], " +
                        //" case when @TotalPotongL4>0 then isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) +  " +
                        //" ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@TotDefKhususL4) else 0 end  b, " +
                        //" case when @TotalPotongL4>0 then isnull((select totdefectK from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) else 0 end c, " +
                        //" case when @TotalPotongL4>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@Ttotalkw1kw2L4) else 0 end  d, " +
                        //" case when @TotalPotongL4>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@NCSortirL4) else 0 end  e, " +
                        //" case when @TotalPotongL4>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@ReturL4) else 0 end  f, " +
                        //" case when @TotalPotongL4>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@DefectFinL4) else 0 end  g " +
                        //" case when @TotalPotongL4>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@DefKhususL4) else 0 end  h " +
                        " case when @TotalPotongL4>0 then isnull((select round(M3,5)M3 from tempTotalPotong where [group]=BM_PlantGroup.[Group] ),0)  else 0 end b,  " +
                        " case when @TotalPotongL4>0 then isnull((select round(M3,5)M3 from tempDetailDP where [group]=BM_PlantGroup.[Group] ),0)  else 0 end c,  " +
                        " case when @TotalPotongL4>0 then ((isnull((select round(M3,5)M3 from tempOKKM where [group]=BM_PlantGroup.[Group] ),0))) else 0 end  d, " +
                        " case when @TotalPotongL4>0 then ((isnull((select round(M3,5)M3 from tempSortir_1_m3 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  e,  " +
                        " case when @TotalPotongL4>0 then ((isnull((select round(M3,5)M3 from tempRetur_m3 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  f,  " +
                        " case when @TotalPotongL4>0 then ((isnull((select round(M3,5)M3 from tempDetailBSTahap1 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end g  " +
                        "  from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 4') )A " +

                        "union all  " +

                        "select 'Total' [Group],sum(b)b,sum(c)c,sum(d)d,sum(e)e,sum(f)f,sum(g)g,/**sum(c)-sum(d)+sum(e)+sum(f)+sum(g) i**/ (sum(c)+sum(e)+sum(f)+sum(g))-sum(d) i" +
                        ",case when sum(b)>0 then round((sum(c)-sum(d)+sum(e)+sum(f)+sum(g))/sum(b)*100,1) else 0 end j from( " +
                        "select [Group], " +
                        //" isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) +  " +
                        //" ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@TotDefKhususL4) b, " +
                        //" isnull((select totdefectK from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)c, " +
                        //" ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@Ttotalkw1kw2L4) d, " +
                        //" ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@NCSortirL4) e, " +
                        //" ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@ReturL4) f, " +
                        //" ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@DefectFinL4) g, " +
                        //" ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL4)*@DefKhususL4) h, " +                   
                        " ((isnull((select round(M3,4)M3 from tempTotalPotong where [group]=BM_PlantGroup.[Group] ),0))) b, " +
                        " isnull((select round(M3,4)M3 from tempDetailDP where [group]=BM_PlantGroup.[Group] ),0)c, " +
                        " ((isnull((select round(M3,4)M3 from tempOKKM where [group]=BM_PlantGroup.[Group] ),0))) d, " +
                        " ((isnull((select round(M3,4)M3 from tempSortir_1_m3 where [group]=BM_PlantGroup.[Group] ),0))) e, " +
                        " ((isnull((select round(M3,4)M3 from tempRetur_m3 where [group]=BM_PlantGroup.[Group] ),0))) f, " +
                        " ((isnull((select round(M3,4)M3 from tempDetailBSTahap1 where [group]=BM_PlantGroup.[Group] ),0))) g, " +
                        " 0 i,0 j from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 4'))A )B " +
                        " end " +
                        " else " +
                        " begin " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 i, 0 j into tempdefectL4 " +
                        " end " +
                        #endregion
 " " +
                        "declare @TotalPotongL5 decimal(18,2) " +
                        "declare @TotDefKhususL5 decimal(18,2) " +
                        "declare @DefKhususL5 decimal(18,2) " +
                        "declare @Ttotalkw1kw2L5 decimal(18,2) " +
                        "declare @NCSortirL5 decimal(18,2) " +
                        "declare @ReturL5 decimal(18,2) " +
                        "declare @DefectFinL5 decimal(18,2) " +
                        "set @TotalPotongL5=(select isnull(sum(totkubik ),0) from tempdefectGPIsoTot where [group]in (select [group] from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 5'))) " +
                        "set @TotDefKhususL5=(@TotalPotongL5/@TotalPotong)*@TotalDefKhusus " +
                        "set @DefKhususL5=(@TotalPotongL5/@TotalPotong)*@DefKhusus " +
                        "set @Ttotalkw1kw2L5=(@TotalPotongL5/@TotalPotong)*@Ttotalkw1kw2 " +
                        "set @NCSortirL5=(@TotalPotongL5/@TotalPotong)*@NCSortir " +
                        "set @ReturL5=(@TotalPotongL5/@TotalPotong)*@Retur " +
                        "set @DefectFinL5=isnull((@TotalPotongL5/@TotalPotong)*@DefectFin,0) " +
                        #region Line - 5
 "if @TotalPotongL5>0 " +
                        "begin " +
                        "select [Group],round(b,4)b,round(c,4)c,round(d,4)d,round(e,4)e,round(f,4)f,round(g,4)g,round(i,0)i,j into tempdefectL5 from ( " +
                        "select *,/**c-d+e+f+g i**/ (c+e+f+g)-d i,case when b>0 then round((c-d+e+f+g)/b*100,1) else 0  end j from ( " +
                        "select [Group], " +
                        //" case when @TotalPotongL5>0 then isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) +  " +
                        //" ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@TotDefKhususL5) else 0 end  b, " +
                        //" case when @TotalPotongL5>0 then isnull((select totdefectK from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) else 0 end c, " +
                        //" case when @TotalPotongL5>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@Ttotalkw1kw2L5) else 0 end  d, " +
                        //" case when @TotalPotongL5>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@NCSortirL5) else 0 end  e, " +
                        //" case when @TotalPotongL5>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@ReturL5) else 0 end  f, " +
                        //" case when @TotalPotongL5>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@DefectFinL5) else 0 end  g " +
                        //" case when @TotalPotongL5>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@DefKhususL5) else 0 end  h " +
                        " case when @TotalPotongL5>=0 then isnull((select round(M3,5)M3 from tempTotalPotong where [group]=BM_PlantGroup.[Group] ),0)  else 0 end b,  " +
                        " case when @TotalPotongL5>=0 then isnull((select round(M3,5)M3 from tempDetailDP where [group]=BM_PlantGroup.[Group] ),0)  else 0 end c,  " +
                        " case when @TotalPotongL5>=0 then ((isnull((select round(M3,5)M3 from tempOKKM where [group]=BM_PlantGroup.[Group] ),0))) else 0 end  d, " +
                        " case when @TotalPotongL5>=0 then ((isnull((select round(M3,5)M3 from tempSortir_1_m3 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  e,  " +
                        " case when @TotalPotongL5>=0 then ((isnull((select round(M3,5)M3 from tempRetur_m3 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  f,  " +
                        " case when @TotalPotongL5>=0 then ((isnull((select round(M3,5)M3 from tempDetailBSTahap1 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end g  " +
                        "  from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 5') )A " +

                        "union all  " +

                        "select 'Total' [Group],sum(b)b,sum(c)c,sum(d)d,sum(e)e,sum(f)f,sum(g)g,/**sum(c)-sum(d)+sum(e)+sum(f)+sum(g) i**/ (sum(c)+sum(e)+sum(f)+sum(g))-sum(d) i " +
                        ",case when sum(b)>0 then round((sum(c)-sum(d)+sum(e)+sum(f)+sum(g))/sum(b)*100,1) else 0 end j from( " +
                        "select [Group], " +
                        //" isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) +  " +
                        //" ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@TotDefKhususL5) b, " +
                        //" isnull((select totdefectK from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)c, " +
                        //" ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@Ttotalkw1kw2L5) d, " +
                        //" ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@NCSortirL5) e, " +
                        //" ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@ReturL5) f, " +
                        //" ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@DefectFinL5) g, " +
                        //" ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL5)*@DefKhususL5) h, " +
                        " ((isnull((select round(M3,4)M3 from tempTotalPotong where [group]=BM_PlantGroup.[Group] ),0))) b, " +
                        " isnull((select round(M3,4)M3 from tempDetailDP where [group]=BM_PlantGroup.[Group] ),0)c, " +
                        " ((isnull((select round(M3,4)M3 from tempOKKM where [group]=BM_PlantGroup.[Group] ),0))) d, " +
                        " ((isnull((select round(M3,4)M3 from tempSortir_1_m3 where [group]=BM_PlantGroup.[Group] ),0))) e, " +
                        " ((isnull((select round(M3,4)M3 from tempRetur_m3 where [group]=BM_PlantGroup.[Group] ),0))) f, " +
                        " ((isnull((select round(M3,4)M3 from tempDetailBSTahap1 where [group]=BM_PlantGroup.[Group] ),0))) g, " +
                        " 0 i,0 j from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 5'))A )B " +
                        " end " +
                        " else " +
                        " begin " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 i, 0 j into tempdefectL5 " +
                        " end " +
                        #endregion
 " " +
                        "declare @TotalPotongL6 decimal(18,2) " +
                        "declare @TotDefKhususL6 decimal(18,2) " +
                        "declare @DefKhususL6 decimal(18,2) " +
                        "declare @Ttotalkw1kw2L6 decimal(18,2) " +
                        "declare @NCSortirL6 decimal(18,2) " +
                        "declare @ReturL6 decimal(18,2) " +
                        "declare @DefectFinL6 decimal(18,2) " +
                        "set @TotalPotongL6=(select isnull(sum(totkubik ),0) from tempdefectGPIsoTot where [group]in (select [group] from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 6'))) " +
                        "set @TotDefKhususL6=(@TotalPotongL6/@TotalPotong)*@TotalDefKhusus " +
                        "set @DefKhususL6=(@TotalPotongL6/@TotalPotong)*@DefKhusus " +
                        "set @Ttotalkw1kw2L6=(@TotalPotongL6/@TotalPotong)*@Ttotalkw1kw2 " +
                        "set @NCSortirL6=(@TotalPotongL6/@TotalPotong)*@NCSortir " +
                        "set @ReturL6=(@TotalPotongL6/@TotalPotong)*@Retur " +
                        "set @DefectFinL6=isnull((@TotalPotongL6/@TotalPotong)*@DefectFin,0) " +
                        #region Line - 6
 "if @TotalPotongL6>0 " +
                        "begin " +
                        "select [Group],round(b,4)b,round(c,4)c,round(d,4)d,round(e,4)e,round(f,4)f,round(g,4)g,round(i,0)i,j into tempdefectL6 from ( " +
                        "select *,/**c-d+e+f+g i**/ (c+e+f+g)-d i,case when b>0 then round((c-d+e+f+g)/b*100,1) else 0  end j from ( " +
                        "select [Group], " +
                        //" case when @TotalPotongL6>0 then isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) +  " +
                        //" ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@TotDefKhususL6)  else 0 end b, " +
                        //" case when @TotalPotongL6>0 then isnull((select totdefectK from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) else 0 end c, " +
                        //" case when @TotalPotongL6>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@Ttotalkw1kw2L6)  else 0 end d, " +
                        //" case when @TotalPotongL6>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@NCSortirL6)  else 0 end e, " +
                        //" case when @TotalPotongL6>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@ReturL6)  else 0 end f, " +
                        //" case when @TotalPotongL6>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@DefectFinL6)  else 0 end g " +
                        //" case when @TotalPotongL6>0 then ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@DefKhususL6) else 0 end  h " +
                        " case when @TotalPotongL6>=0 then isnull((select round(M3,5)M3 from tempTotalPotong where [group]=BM_PlantGroup.[Group] ),0)  else 0 end b,  " +
                        " case when @TotalPotongL6>=0 then isnull((select round(M3,5)M3 from tempDetailDP where [group]=BM_PlantGroup.[Group] ),0)  else 0 end c,  " +
                        " case when @TotalPotongL6>=0 then ((isnull((select round(M3,5)M3 from tempOKKM where [group]=BM_PlantGroup.[Group] ),0))) else 0 end  d, " +
                        " case when @TotalPotongL6>=0 then ((isnull((select round(M3,5)M3 from tempSortir_1_m3 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  e,  " +
                        " case when @TotalPotongL6>=0 then ((isnull((select round(M3,5)M3 from tempRetur_m3 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  f,  " +
                        " case when @TotalPotongL6>=0 then ((isnull((select round(M3,5)M3 from tempDetailBSTahap1 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end g  " +
                        "  from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 6') )A " +

                        "union all  " +

                        "select 'Total' [Group],sum(b)b,sum(c)c,sum(d)d,sum(e)e,sum(f)f,sum(g)g,/**sum(c)-sum(d)+sum(e)+sum(f)+sum(g) i**/ (sum(c)+sum(e)+sum(f)+sum(g))-sum(d) i" +
                        ",case when sum(b)>0 then round((sum(c)-sum(d)+sum(e)+sum(f)+sum(g))/sum(b)*100,1) else 0 end j from( " +
                        "select [Group], " +
                        //" isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0) +  " +
                        //" ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@TotDefKhususL6) b, " +
                        //" isnull((select totdefectK from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)c, " +
                        //" ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@Ttotalkw1kw2L6) d, " +
                        //" ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@NCSortirL6) e, " +
                        //" ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@ReturL6) f, " +
                        //" ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@DefectFinL6) g, " +
                        //" ((isnull((select totkubik from tempdefectGPIsoTot where [group]=BM_PlantGroup.[Group] ),0)/@TotalPotongL6)*@DefKhususL6) h, " +
                        " ((isnull((select round(M3,4)M3 from tempTotalPotong where [group]=BM_PlantGroup.[Group] ),0))) b, " +
                        " isnull((select round(M3,4)M3 from tempDetailDP where [group]=BM_PlantGroup.[Group] ),0)c, " +
                        " ((isnull((select round(M3,4)M3 from tempOKKM where [group]=BM_PlantGroup.[Group] ),0))) d, " +
                        " ((isnull((select round(M3,4)M3 from tempSortir_1_m3 where [group]=BM_PlantGroup.[Group] ),0))) e, " +
                        " ((isnull((select round(M3,4)M3 from tempRetur_m3 where [group]=BM_PlantGroup.[Group] ),0))) f, " +
                        " ((isnull((select round(M3,4)M3 from tempDetailBSTahap1 where [group]=BM_PlantGroup.[Group] ),0))) g, " +
                        " 0 i,0 j from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 6'))A )B " +
                        " end " +
                        #endregion
 " else " +
                        " begin " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 i, 0 j into tempdefectL6 " +
                        " end " +
                        " " +
                        " end " +
                        " else " +
                        " begin " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 i, 0 j into tempdefectL1 " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 i, 0 j into tempdefectL2 " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 i, 0 j into tempdefectL3 " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 i, 0 j into tempdefectL4 " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 i, 0 j into tempdefectL5 " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 i, 0 j into tempdefectL6 " +
                        " end " +
                        " select [group],round(b,1)b,round(c,1)c,round(d,1)d,round(e,1)e,round(f,1)f,case when [group]<>'total' then round(g,1) when [group]='total' then round(g,1) end g,i,j from tempdefectL1 ";
                    }
                    #endregion
                    #endregion
                    #region added 07 Mei 2021
                    else if (Convert.ToInt32(strtgl1.Substring(0, 6)) > 202102 && Convert.ToInt32(strtgl1.Substring(0, 6)) < 202106 && users.UnitKerjaID.ToString() == "1" ||
                             Convert.ToInt32(strtgl1.Substring(0, 6)) > 202102 && Convert.ToInt32(strtgl1.Substring(0, 6)) < 202106 && users.UnitKerjaID.ToString() == "7" ||
                             Convert.ToInt32(strtgl1.Substring(0, 6)) < 202108 && users.UnitKerjaID.ToString() == "13")
                    {
                        string logika1 = string.Empty;
                        if (users.UnitKerjaID == 7)
                        {
                            logika1 =
                            " select cast(@selisihTotalPot//**@TtlGroup**/24 as decimal(18,1))M3,[Group] into DtlSelisihTtlPot from ( " +
                            " select [Group] from detailDfctSystemBM_M3  " +
                            " union all   " +
                            " select [Group] from DtlDefectSystemFN_M3 " +
                            " union all " +
                            " select [Group] from BM_PlantGroup where PlantID>0) as x group by [Group] ";


                        }
                        else if (users.UnitKerjaID == 1)
                        {
                            logika1 =
                                " select sum(M3)M3,[Group]  into DtlSelisihTtlPot from ( " +
                                " select (@selisihTotalPot/(select count([Group])ttl from tempDetailTotPotong_LPUK where m3>0))M3,[Group] from tempDetailTotPotong_LPUK  where m3>0 union all " +
                                " select '0'M3,[Group] from BM_PlantGroup where PlantID>0) as x group by [Group] ";
                            //" select cast(@selisihTotalPot/@TtlGroup as decimal(18,1))M3,[Group] into DtlSelisihTtlPot " +
                            //" from (  select [Group] from detailDfctSystemBM_M3  " +
                            //" union all  " +
                            //" select [Group] from DtlDefectSystemFN_M3 " +
                            //" union all  select [Group] from BM_PlantGroup where PlantID>0) as x group by [Group] ";
                        }
                        else if (users.UnitKerjaID == 13)
                        {
                            logika1 =
                            " select cast(@selisihTotalPot/@TtlGroup as decimal(18,1))M3,[Group] into DtlSelisihTtlPot from ( " +
                            " select [Group] from detailDfctSystemBM_M3  " +
                            " union all   " +
                            " select [Group] from DtlDefectSystemFN_M3 " +
                            " union all " +
                            " select [Group] from BM_PlantGroup where PlantID>0) as x group by [Group] ";

                        }

                        if (Convert.ToInt32(strtgl1.Substring(0, 6)) > 202105)
                        {
                            logika2 = " select M3,[Group] from AtempDetail_Listplank ";
                            //logika3 = " ,case when sum(b)>0 then cast((sum(i))/sum(b)*100 as decimal(18,1)) else 0 end j from ( ";
                        }
                        else
                        {
                            //" select M3 *-1 M3,[Group] from tempDetail_Listplank0 "+
                            //" /**select M3,[Group] from AtempDetail_Listplank**/ "+
                            logika2 = " select M3 *-1 M3,[Group] from tempDetail_Listplank0 ";
                            //logika3 = " ,case when sum(b)>0 then cast((sum(c)-sum(d)+sum(e)+sum(f))/sum(b)*100 as decimal(18,1)) else 0 end j from (  ";
                        }

                        if (Convert.ToInt32(strtgl1.Substring(0, 6)) > 202106 && users.UnitKerjaID == 7 || Convert.ToInt32(strtgl1.Substring(0, 6)) > 202106 && users.UnitKerjaID == 1)
                        {
                            logika3 = " ,case when sum(b)>0 then cast((sum(i))/sum(b)*100 as decimal(18,1)) else 0 end j from ( ";
                        }
                        else
                        {
                            logika3 = " ,case when sum(b)>0 then cast((sum(c)-sum(d)+sum(e)+sum(f))/sum(b)*100 as decimal(18,1)) else 0 end j from (  ";
                        }

                        if (Convert.ToInt32(strtgl1.Substring(0, 6)) > 202105 && users.UnitKerjaID == 13)
                        {
                            logika3 = " ,case when sum(b)>0 then cast((sum(i))/sum(b)*100 as decimal(18,1)) else 0 end j from ( ";
                        }
                        else
                        {
                            logika3 = " ,case when sum(b)>0 then cast((sum(c)-sum(d)+sum(e)+sum(f))/sum(b)*100 as decimal(18,1)) else 0 end j from (  ";
                        }

                        strSQL =

                        #region Temp Table

     " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectGPIso]') AND type in (N'U')) DROP TABLE [dbo].[tempdefectGPIso] " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectGPIsoTot]') AND type in (N'U')) DROP TABLE [dbo].tempdefectGPIsoTot   " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectFin]') AND type in (N'U')) DROP TABLE [dbo].tempdefectFin   " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectL1]') AND type in (N'U')) DROP TABLE [dbo].tempdefectL1  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectL2]') AND type in (N'U')) DROP TABLE [dbo].tempdefectL2  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectL3]') AND type in (N'U')) DROP TABLE [dbo].tempdefectL3  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectL4]') AND type in (N'U')) DROP TABLE [dbo].tempdefectL4  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectL5]') AND type in (N'U')) DROP TABLE [dbo].tempdefectL5  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectL6]') AND type in (N'U')) DROP TABLE [dbo].tempdefectL6 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectGPIso2]') AND type in (N'U')) DROP TABLE [dbo].tempdefectGPIso2 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[detailDfctSystemBM_M3]') AND type in (N'U')) DROP TABLE [dbo].detailDfctSystemBM_M3 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[DtlDefectSystemFN_M3]') AND type in (N'U')) DROP TABLE [dbo].DtlDefectSystemFN_M3  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[DtlSelisih_M3]') AND type in (N'U')) DROP TABLE [dbo].DtlSelisih_M3 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTotPotong_QA]') AND type in (N'U')) DROP TABLE [dbo].tempTotPotong_QA " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempOKKM_m3]') AND type in (N'U')) DROP TABLE [dbo].tempOKKM_m3  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempSortir_1_m3]') AND type in (N'U')) DROP TABLE [dbo].tempSortir_1_m3 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempRetur_m3]') AND type in (N'U')) DROP TABLE [dbo].tempRetur_m3 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempOKKM]') AND type in (N'U')) DROP TABLE [dbo].tempOKKM " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDefectBMFin]') AND type in (N'U')) DROP TABLE [dbo].tempDefectBMFin " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDetail_Listplank]') AND type in (N'U')) DROP TABLE [dbo].tempDetail_Listplank " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDetail_Listplank0]') AND type in (N'U')) DROP TABLE [dbo].tempDetail_Listplank0 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDetailDefect_UkuranKhusus]') AND type in (N'U')) DROP TABLE [dbo].tempDetailDefect_UkuranKhusus " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDetailDefect_UkuranKhususOK]') AND type in (N'U')) DROP TABLE [dbo].tempDetailDefect_UkuranKhususOK " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDefectProduksi]') AND type in (N'U')) DROP TABLE [dbo].tempDefectProduksi " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTotalBSTahap1]') AND type in (N'U')) DROP TABLE [dbo].tempTotalBSTahap1  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDetailBSTahap1]') AND type in (N'U')) DROP TABLE [dbo].tempDetailBSTahap1 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDetailTotalDefect]') AND type in (N'U')) DROP TABLE [dbo].tempDetailTotalDefect " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDetailTotalDefect_P]') AND type in (N'U')) DROP TABLE [dbo].tempDetailTotalDefect_P " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTotPotong_QA]') AND type in (N'U')) DROP TABLE [dbo].tempTotPotong_QA  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDetailTotPotong_LPUK]') AND type in (N'U')) DROP TABLE [dbo].tempDetailTotPotong_LPUK  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDetailTotPotong_LPUK2]') AND type in (N'U')) DROP TABLE [dbo].tempDetailTotPotong_LPUK2 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[DtlSelisihTtlPot]') AND type in (N'U')) DROP TABLE [dbo].DtlSelisihTtlPot  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[DtlTotalPotongProposionet]') AND type in (N'U')) DROP TABLE [dbo].DtlTotalPotongProposionet " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[DtlTotalDefect]') AND type in (N'U')) DROP TABLE [dbo].DtlTotalDefect " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[AtempDetail_Listplank]') AND type in (N'U')) DROP TABLE [dbo].AtempDetail_Listplank " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDataBSauto]') AND type in (N'U')) DROP TABLE [dbo].[tempDataBSauto]  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDataSarmut_Defect]') AND type in (N'U')) DROP TABLE [dbo].[tempDataSarmut_Defect] " +
                        #endregion

                        #region Logika
 " declare @thnbln1 varchar(8) declare @thnbln2 varchar(8) declare @BlnThn varchar(6) " +

                        " set @thnbln1='" + strtgl1 + "' " +
                        " set @thnbln2='" + strtgl2 + "' " +
                        " set @BlnThn='" + Periode + "' " +

                        " select *  into tempdefectGPIso from (  select case when D.DeptID=0 then  case when GJ.GroupJemurName In ('M','N','O','P','Q','R','S','T','U','V','W','X') then " +
                        " case when D.DefName='retak' then 2 when D.DefName='gompal' then 3 else D.DeptID end else " +
                        " case when (B.Qty/E.Qty) *100 >5 then 2 else 3 end   end  else D.DeptID end deptID1,A.CreatedTime as tglInput,A.Tgl as TglPeriksa, " +
                        " E.TglProduksi as TglProd,  D.DefCode,BP.PlantName as Line, PG.[Group],BF.FormulaCode as Jenis,D.DefName,D.DeptID,B.ID,B.DefectID, " +
                        " B.MasterID,B.Qty,A.ID  DestID,isnull(A.TPotong,0)  QtyIn, " +
                        " I.Volume*B.Qty Kubik,isnull(A.TPotong,0) as TotPotong,'' sfrom  " +
                        " from Def_DefectDetail B " +
                        " inner join Def_Defect A on A.Id=B.DefectID   " +
                        " left join Def_MasterDefect D on B.MasterID=D.ID " +
                        " left join BM_Destacking E on E.ID=A.DestID  " +
                        " left join BM_PlantGroup PG on A.GroupProdID=PG.ID " +
                        " left join BM_Formula BF on BF.ID=E.FormulaID   " +
                        " left join BM_Plant BP on BP.ID=E.PlantID " +
                        " left join FC_Items I on I.ID=E.ItemID " +
                        " inner join Def_GroupJemur GJ on GJ.ID=A.GroupJemurID  " +
                        " where B.RowStatus>-1  and D.RowStatus >-1) as Def    " +
                        " where DeptID1=2 and CONVERT(varchar,TglPeriksa,112)>=@thnbln1 and CONVERT(varchar,TglPeriksa,112)<=@thnbln2   " +

                        " declare @ttlDefectBM decimal(10,5) " +
                        " declare @ttlDefectFN decimal(10,5) " +
                        " declare @Selisih_ttl_defect decimal(10,5) " +
                        " declare @dtlSelisih_ttl_defect decimal(10,5) " +
                        " declare @Selisih_ttl_defect2 decimal(10,5) " +
                        " declare @TtlDfctSystemBM_M3 decimal(10,5) " +
                        " declare @TtlDfctSystemFN_M3 decimal(10,5) " +
                        " declare @TtlDfctBMFN_M3 decimal(10,5) " +
                        " declare @TtlDefectBM_M3 decimal(10,5) " +
                        " declare @TtlDfctBMFN_M3_OKKW decimal(10,5) " +

                        " select * into tempdefectGPIso2 " +
                        " from (  select case when D.DeptID=0 then  case when GJ.GroupJemurName In ('M','N','O','P','Q','R','S','T','U','V','W','X') then  " +
                        " case when D.DefName='retak' then 2 when D.DefName='gompal' then 3 else D.DeptID end else case when (B.Qty/E.Qty) *100 >5 then 2 " +
                        " else 3 end   end  else D.DeptID end deptID1,A.CreatedTime as tglInput,A.Tgl as TglPeriksa,E.TglProduksi as TglProd, " +
                        " D.DefCode,BP.PlantName as Line, PG.[Group],BF.FormulaCode as Jenis,D.DefName,D.DeptID,B.ID,B.DefectID,B.MasterID,B.Qty,A.ID " +
                        " DestID,isnull(A.TPotong,0)  QtyIn,B.Qty*I.Volume as Kubik,isnull(A.TPotong,0) as TotPotong,'' sfrom  " +
                        " from Def_DefectDetail B inner join Def_Defect A on A.Id=B.DefectID   left join Def_MasterDefect D on B.MasterID=D.ID " +
                        " left join BM_Destacking E on E.ID=A.DestID   left join BM_PlantGroup PG on A.GroupProdID=PG.ID " +
                        " left join BM_Formula BF on BF.ID=E.FormulaID    left join BM_Plant BP on BP.ID=E.PlantID left join FC_Items I on I.ID=E.ItemID " +
                        " inner join Def_GroupJemur GJ on GJ.ID=A.GroupJemurID  where B.RowStatus>-1  and D.RowStatus >-1) as Def  " +
                        " where DeptID1=3 and CONVERT(varchar,TglPeriksa,112)>=@thnbln1 and CONVERT(varchar,TglPeriksa,112)<=@thnbln2  " +

                        "  /** 1. Defect System BM ( Kolom ) **/  " +
                        " select [Group],cast((M3) as decimal(18,5))M3 into detailDfctSystemBM_M3 from (select [Group],cast((sum(kubik)) as decimal(18,5)) M3  from tempdefectGPIso group by [Group] ) as x   " +

                        " /** Total Defect BM dan Finishing BP ( Kolom Defect System BP )**/  " +
                        " /** Accounting Report Mutasi WiP : Pengeluaran B99 **/ " +
                        " set @TtlDfctBMFN_M3 = (  select cast((sum(M3)) as decimal(18,0))BP_M3  from (  select sum(Qty)Qty,sum(M3)M3 from (  select *,cast(((Qty*Volume)) as decimal(18,2))M3 from (  select sum(A.qty *-1) Qty,(B.Tebal*B.Lebar*B.Panjang)/1000000000 Volume from vw_KartustockWIP A   inner join FC_Items B ON A.itemid0=B.ID  where qty<0   and lokasi='B99' and process<>'lari' and process<>'listplank' and left(convert(char,tanggal,112),8)>=@thnbln1 and  left(convert(char,tanggal,112),8)<=@thnbln2   group by tebal,lebar,panjang ) as x ) as x1  " +
                        " union all  " +
                        " select sum(Qty)Qty,sum(M3)M3 from (  select *,cast(((Qty*Volume)) as decimal(18,2))M3 from (  select isnull(SUM(qty)*-1,0)Qty,(I2.Tebal*I2.Lebar*I2.Panjang)/1000000000 Volume from vw_KartustockWIP2 V   inner join FC_Items I on V.itemID=I.ID inner join FC_Items I2 on I2.ID=V.itemid0 and (I.partno  like '%-p-%'  )  where qty<0  and idrec not like '%ou%'    and process='lari'and lokid1 not in (select ID from fc_lokasi where lokasi='I99') and  left(convert(char,tanggal,112),8)>=@thnbln1 and left(convert(char,tanggal,112),8)<=@thnbln2  group by I2.tebal,I2.lebar,I2.panjang) as x ) as x1 ) as xx )  " +

                        "  /** Total Defect BM dan Finishing BP ( Kolom Defect System OK KW ) **/  " +
                        " /** Total Defect BM dan Finishing OK KW **/  " +
                        " set @TtlDfctBMFN_M3_OKKW = (  select cast((sum(M3)) as decimal(18,2))BP_M3  from (  select sum(Qty)Qty,sum(M3)M3 from (  select *,cast(((Qty*Volume)) as decimal(18,2))M3 from (  select sum(A.qty *-1) Qty,(B.Tebal*B.Lebar*B.Panjang)/1000000000 Volume from vw_KartustockWIP A   inner join FC_Items B ON A.itemid0=B.ID  where qty<0   and lokasi='H99' and process<>'lari' and process<>'listplank' and left(convert(char,tanggal,112),8)>=@thnbln1  and left(convert(char,tanggal,112),8)<=@thnbln2   group by tebal,lebar,panjang ) as x ) as x1  " +
                        " union all  " +
                        " select sum(Qty)Qty,sum(M3)M3 from (  select *,cast(((Qty*Volume)) as decimal(18,2))M3 from (  select isnull(SUM(qty)*-1,0)Qty,(I2.Tebal*I2.Lebar*I2.Panjang)/1000000000 Volume from vw_KartustockWIP2 V   inner join FC_Items I on V.itemID=I.ID inner join FC_Items I2 on I2.ID=V.itemid0 and (I.partno  like '%-3-%' or I.partno  like '%-M-%'  )      where qty<0  and idrec not like '%ou%'    and process='lari'and lokid1 not in (select ID from fc_lokasi where lokasi='I99') and  left(convert(char,tanggal,112),8)>=@thnbln1 and left(convert(char,tanggal,112),8)<=@thnbln2  group by I2.tebal,I2.lebar,I2.panjang) as x ) as x1 ) as xx )  " +

                        "  /** Total Defect BM dan Finishing OK KW **/  " +
                        " set @TtlDfctSystemBM_M3 = (select M3 from (select cast((sum(M3)) as decimal(18,5))M3 from detailDfctSystemBM_M3) as x)  " +
                        " set @TtlDfctSystemFN_M3 = (select M3 from (select cast((sum(kubik)) as decimal(18,1))M3 from tempdefectGPIso2) as x)  " +
                        " set @TtlDefectBM_M3 = (select M3 from (select cast((sum(M3)) as decimal(18,0))M3 from detailDfctSystemBM_M3) as x)  " +

                        " /** 2. Defect System Finishing ( Kolom ) **/   " +
                        " select [Group],cast((((M3/@TtlDfctSystemBM_M3)*@TtlDfctSystemFN_M3)) as decimal(18,5))M3 into DtlDefectSystemFN_M3 from detailDfctSystemBM_M3 " +
                        " /** End Detail data transaksi Defect System Finishing per Group **/ " +

                        "   /** 3. Selisih Total Defect ( Kolom ) **/ " +
                        " set @Selisih_ttl_defect = (select @TtlDfctBMFN_M3 - cast((@TtlDefectBM_M3) as decimal(18,5)) - cast((@TtlDfctSystemFN_M3) as decimal(18,5))) " +
                        " select [Group],cast(((M3/@TtlDfctSystemBM_M3)*@Selisih_ttl_defect) as decimal(18,5)) M3 into DtlSelisih_M3 from detailDfctSystemBM_M3 order by [group] " +

                        " /** 4. Detail Defect BM + Finishing ( Kolom ) **/ " +
                        " select [group],cast(sum(M3) as decimal(18,5))M3 into tempDefectBMFin from ( " +
                        " select * from detailDfctSystemBM_M3 union all  select * from DtlDefectSystemFN_M3 union all select * from  DtlSelisih_M3 ) as x group by [group] ; " +

                        " /** 5. Detail Defect Ukuran Khusus BP **/ " +
                        //" with dataDestacking as (select distinct ItemID,PlantID,left(convert(char,tglproduksi,112),6)ThnBln from BM_Destacking where RowStatus>-1 group by ItemID,PlantiD,TglProduksi ), "+
                        //" dataDestacking1 as (select B.PartNo,PlantID,ThnBln from dataDestacking A inner join FC_Items B ON A.ItemID=B.ID), "+
                        //" dataDestacking2 as (select x.ItemID,x.PartnoAsal,x.Qty,((A.Tebal*A.Lebar*A.Panjang)/1000000000)*x.Qty M3 from (   select PartNo PartnoAsal,ItemID,isnull(SUM(Qty),0)  * -1 Qty from vw_KartuStockBJNew  where qty <0 and (process  like '%simetris%' ) and  (Keterangan like '%-P-%') and  LokID not In (select ID from FC_Lokasi where lokasi='q99')   and left(convert(char,tanggal,112),8)>=@thnbln1 and  left(convert(char,tanggal,112),8)<=@thnbln2 and ItemID in (select ID  from FC_Items where PartNo like'%-1-%') group by ItemID,Keterangan,PartNo,ItemID   ) as x  inner join FC_Items A ON A.ID=x.ItemID), " +        
                        //" dataDestacking3 as (select *,(select top 1 A1.ThnBln from dataDestacking1 A1 where A1.PartNo=A.PartnoAsal and A1.ThnBln<=left(convert(char,@thnbln1,112),6) order by A1.ThnBln desc)ThnBln from dataDestacking2 A) , " +
                        //" dataDestacking4 as (select PartnoAsal,sum(M3)M3,ThnBln,PlantID from (select A.*,B.PlantID from dataDestacking3 A left join dataDestacking1 B ON A.PartnoAsal=B.PartNo and A.ThnBln=B.ThnBln ) as x group by PartnoAsal,ThnBln,PlantID), " +
                        //" dataDestacking04 as (select *,(select top 1 A1.Line from Def_UKhususProsen A1 where A1.rowstatus>-1 and A1.Partno=A.PartnoAsal and A1.Periode=left(convert(char,@thnbln1,112),6))PlantID2 from dataDestacking4 A ), " +
                        //" dataDestacking5 as (select PartnoAsal,M3,case when PlantID2 is null then PlantID else PlantID2 end PlantID from dataDestacking04 xx), "+
                        //" dataDestacking051 as (select PartnoAsal,M3,PlantID from dataDestacking5 xx group by PartnoAsal,M3,PlantID ), "+
                        //" dataDestacking05 as (select PartnoAsal,M3,PlantID,(select count(PartnoAsal) from dataDestacking051 A where A.PartnoAsal=dataDestacking051.PartnoAsal)ttl from dataDestacking051 group by PartnoAsal,M3,PlantID), " +
                        //" dataDestacking6 as (select PartnoAsal,sum(m3)m3,PlantID,ttl from dataDestacking05 group by PlantID,ttl,PartnoAsal), "+
                        //" dataDestacking06 as (select PartnoAsal,case when ttl=1 then m3 when ttl>1 then m3/ttl end m3,PlantID from dataDestacking6 group by PlantID,m3,ttl,PartnoAsal), "+
                        //" dataDestacking7 as ( "+
                        //" select sum(M3)M3,[Group] from ( "+
                        //" select M3/4 M3,B.[Group] from dataDestacking06 A inner join BM_PlantGroup B ON A.PlantID=B.PlantID where B.PlantID>0 "+
                        //" union all "+
                        //" select 0'M3',[Group] from BM_PlantGroup where PlantID>0 ) as x group by [Group] ) "+
                        //" select * into tempDetailDefect_UkuranKhusus from dataDestacking7; "+
                        " /** 5. Detail Defect Ukuran Khusus BP **/ " +
                        " with dataDestacking as (select distinct ItemID,PlantID,left(convert(char,tglproduksi,112),6)ThnBln from BM_Destacking where RowStatus>-1 group by ItemID,PlantiD,TglProduksi ), " +
                        " dataDestacking1 as (select B.PartNo,PlantID,ThnBln from dataDestacking A inner join FC_Items B ON A.ItemID=B.ID), " +
                        " dataDestacking2 as (select x.ItemID,x.PartnoAsal,x.Qty,((A.Tebal*A.Lebar*A.Panjang)/1000000000)*x.Qty M3 from (   select PartNo PartnoAsal,ItemID,isnull(SUM(Qty),0)  * -1 Qty from vw_KartuStockBJNew  where qty <0 and (process  like '%simetris%' ) and  (Keterangan like '%-P-%') and  LokID not In (select ID from FC_Lokasi where lokasi='q99')   and left(convert(char,tanggal,112),8)>=@thnbln1 and  left(convert(char,tanggal,112),8)<=@thnbln2 and ItemID in (select ID  from FC_Items where PartNo like'%-1-%') group by ItemID,Keterangan,PartNo,ItemID   ) as x  inner join FC_Items A ON A.ID=x.ItemID), " +
                        " dataDestacking3 as (select *,(select top 1 A1.ThnBln from dataDestacking1 A1 where A1.PartNo=A.PartnoAsal and A1.ThnBln<=left(convert(char,@thnbln1,112),6) order by A1.ThnBln desc)ThnBln from dataDestacking2 A) , " +
                        " dataDestacking4 as (select PartnoAsal,sum(M3)M3,ThnBln,PlantID from (select A.*,B.PlantID from dataDestacking3 A left join dataDestacking1 B ON A.PartnoAsal=B.PartNo and A.ThnBln=B.ThnBln ) as x group by PartnoAsal,ThnBln,PlantID), " +
                        " dataDestacking04 as (select *,(select top 1 A1.Line from Def_UKhususProsen A1 where A1.Partno=A.PartnoAsal and A1.Periode=left(convert(char,@thnbln1,112),6))PlantID2 from dataDestacking4 A ), " +
                        " dataDestacking5 as (select PartnoAsal,M3,case when PlantID2 is null then PlantID else PlantID2 end PlantID from dataDestacking04 xx), " +
                        " dataDestacking051 as (select PartnoAsal,M3,PlantID from dataDestacking5 xx group by PartnoAsal,M3,PlantID ), " +
                        " dataDestacking05 as (select PartnoAsal,M3,PlantID,(select count(PartnoAsal) from dataDestacking051 A where A.PartnoAsal=dataDestacking051.PartnoAsal)ttl from dataDestacking051 group by PartnoAsal,M3,PlantID), " +
                        " dataDestacking6 as (select PartnoAsal,sum(m3)m3,PlantID,ttl from dataDestacking05 group by PlantID,ttl,PartnoAsal), " +
                        " dataDestacking06 as (select PartnoAsal,case when ttl=1 then m3 when ttl>1 then m3/ttl end m3,PlantID from dataDestacking6 group by PlantID,m3,ttl,PartnoAsal), " +
                        " dataDestacking7 as ( " +
                        " select sum(M3)M3,[Group] from ( " +
                        " select M3/4 M3,B.[Group] from dataDestacking06 A inner join BM_PlantGroup B ON A.PlantID=B.PlantID where B.PlantID>0 " +
                        " union all " +
                        " select 0'M3',[Group] from BM_PlantGroup where PlantID>0 ) as x group by [Group] ) " +
                        " select * into tempDetailDefect_UkuranKhusus  from dataDestacking7; " +

                        " /** 5.1. Detail Defect Ukuran Khusus OK **/ " +
                        //" with dataDestackingOK as (select distinct ItemID,PlantID,left(convert(char,tglproduksi,112),6)ThnBln from BM_Destacking where RowStatus>-1 group by ItemID,PlantiD,TglProduksi ), "+
                        //" dataDestackingOK1 as (select B.PartNo,PlantID,ThnBln from dataDestackingOK A inner join FC_Items B ON A.ItemID=B.ID), "+
                        //" dataDestackingOK2 as (select x.ItemID,x.PartnoAsal,x.Qty,((A.Tebal*A.Lebar*A.Panjang)/1000000000)*x.Qty M3 from (   select PartNo PartnoAsal,ItemID,isnull(SUM(Qty),0)  * -1 Qty from vw_KartuStockBJNew  where qty <0 and (process  like '%simetris%' ) and  (Keterangan like '%-3-%' or Keterangan like '%-M-%') and  LokID not In (select ID from FC_Lokasi where lokasi='q99')   and left(convert(char,tanggal,112),8)>=@thnbln1 and  left(convert(char,tanggal,112),8)<=@thnbln2 and ItemID in (select ID  from FC_Items where PartNo like'%-1-%') group by ItemID,Keterangan,PartNo,ItemID   ) as x  inner join FC_Items A ON A.ID=x.ItemID), " +
                        //" dataDestackingOK3 as (select *,(select top 1 A1.ThnBln from dataDestackingOK1 A1 where A1.PartNo=A.PartnoAsal and A1.ThnBln<=left(convert(char,@thnbln1,112),6) order by A1.ThnBln desc)ThnBln from dataDestackingOK2 A) , " +
                        //" dataDestackingOK4 as (select PartnoAsal,sum(M3)M3,ThnBln,PlantID from (select A.*,B.PlantID from dataDestackingOK3 A left join dataDestackingOK1 B ON A.PartnoAsal=B.PartNo and A.ThnBln=B.ThnBln ) as x group by PartnoAsal,ThnBln,PlantID), "+
                        //" dataDestackingOK04 as (select *,(select top 1 A1.Line from Def_UKhususProsen A1 where A1.rowstatus>-1 and A1.Partno=A.PartnoAsal and A1.Periode=left(convert(char,@thnbln1,112),6))PlantID2 from dataDestackingOK4 A ), "+
                        //" dataDestackingOK5 as (select PartnoAsal,M3,PlantID2 PlantID from dataDestackingOK04 xx), "+
                        //" dataDestackingOK05 as (select PartnoAsal,M3,PlantID from dataDestackingOK5 group by PartnoAsal,M3,PlantID), "+
                        //" dataDestackingOK6 as (select sum(M3)M3,PlantID from dataDestackingOK05 group by PlantID), "+
                        //" dataDestackingOK7 as ( "+
                        //" select sum(M3)M3,[Group] from ( "+
                        //" select M3/4 M3,B.[Group] from dataDestackingOK6 A inner join BM_PlantGroup B ON A.PlantID=B.PlantID where B.PlantID>0 "+
                        //" union all "+
                        //" select 0'M3',[Group] from BM_PlantGroup where PlantID>0 ) as x group by [Group] ) "+
                        //" select * into tempDetailDefect_UkuranKhususOK from dataDestackingOK7; "+ 

                        " with dataDestackingOK as (select distinct ItemID,PlantID,left(convert(char,tglproduksi,112),6)ThnBln from BM_Destacking where RowStatus>-1 group by ItemID,PlantiD,TglProduksi ), " +
                        " dataDestackingOK1 as (select B.PartNo,PlantID,ThnBln from dataDestackingOK A inner join FC_Items B ON A.ItemID=B.ID), " +
                        " dataDestackingOK2 as (select x.ItemID,x.PartnoAsal,x.Qty,((A.Tebal*A.Lebar*A.Panjang)/1000000000)*x.Qty M3 from (   select PartNo PartnoAsal,ItemID,isnull(SUM(Qty),0)  * -1 Qty from vw_KartuStockBJNew  where qty <0 and (process  like '%simetris%' ) and  (Keterangan like '%-3-%' or Keterangan like '%-M-%') and  LokID not In (select ID from FC_Lokasi where lokasi='q99')   and left(convert(char,tanggal,112),8)>=@thnbln1 and  left(convert(char,tanggal,112),8)<=@thnbln2 and ItemID in (select ID  from FC_Items where PartNo like'%-1-%') group by ItemID,Keterangan,PartNo,ItemID   ) as x  inner join FC_Items A ON A.ID=x.ItemID), " +
                        " dataDestackingOK3 as (select *,(select top 1 A1.ThnBln from dataDestackingOK1 A1 where A1.PartNo=A.PartnoAsal and A1.ThnBln<=left(convert(char,@thnbln1,112),6) order by A1.ThnBln desc)ThnBln from dataDestackingOK2 A) , " +
                        " dataDestackingOK4 as (select PartnoAsal,sum(M3)M3,ThnBln,PlantID from (select A.*,B.PlantID from dataDestackingOK3 A left join dataDestackingOK1 B ON A.PartnoAsal=B.PartNo and A.ThnBln=B.ThnBln ) as x group by PartnoAsal,ThnBln,PlantID), " +
                        //" dataDestackingOK04 as (select *,(select top 1 A1.Line from Def_UKhususProsen A1 where A1.Partno=A.PartnoAsal and A1.Periode=left(convert(char,@thnbln1,112),6))PlantID2 from dataDestackingOK4 A ), "+
                        " dataDestackingOK04 as (select *,case when ThnBln is null then (select top 1 A2.Periode from Def_UKhususProsen A2 where A2.PartNo=A.PartNoAsal and A2.rowstatus>-1 and Periode=left(convert(char,@thnbln1,112),6)) else ThnBln end ThnBln2,(select top 1 A1.Line from Def_UKhususProsen A1 where A1.Partno=A.PartnoAsal and A1.Periode=left(convert(char,@thnbln1,112),6))PlantID2 from dataDestackingOK4 A ), " +
                        //" dataDestackingOK5 as (select PartnoAsal,M3,PlantID2 PlantID from dataDestackingOK04 xx), "+
                        //" dataDestackingOK05 as (select PartnoAsal,M3,PlantID from dataDestackingOK5 group by PartnoAsal,M3,PlantID), "+
                        //" dataDestackingOK5 as (select PartnoAsal,M3,case when plantid is null then PlantID2 else PlantID end PlantID from dataDestackingOK04 xx), "+
                        " dataDestackingOK5 as (select PartnoAsal,M3,case when plantid is null then PlantID2 when PlantID2 is null then PlantID else PlantID2 end PlantID from dataDestackingOK04 xx), " +
                        " dataDestackingOK05 as (select PartnoAsal,M3,PlantID from dataDestackingOK5 group by PartnoAsal,M3,PlantID), " +

                        " dataDestackingOK005 as (select A.*,(select count(A1.PartnoAsal) from dataDestackingOK05 A1 where A1.PartnoAsal=A.PartnoAsal and A1.M3=A.M3)Ttl from dataDestackingOK05 A), " +
                        " dataDestackingOK06 as (select PartnoAsal,M3/ttl M3,PlantID from dataDestackingOK005), " +

                        " dataDestackingOK6 as (select sum(M3)M3,PlantID from dataDestackingOK06 group by PlantID), " +
                        " dataDestackingOK7 as ( " +
                        " select sum(M3)M3,[Group] from ( " +
                        " select M3/4 M3,B.[Group] from dataDestackingOK6 A inner join BM_PlantGroup B ON A.PlantID=B.PlantID where B.PlantID>0 " +
                        " union all " +
                        " select 0'M3',[Group] from BM_PlantGroup where PlantID>0 ) as x group by [Group] ) " +
                        " select * into tempDetailDefect_UkuranKhususOK from dataDestackingOK7; " +

                        " /** 6. Perhitungan Defect ListPlank BP ( Detail Defect ListPlank ) **/   " +
                        " with  " +
                        " Listplank as (select distinct ItemID,PlantID,left(convert(char,tglproduksi,112),6)ThnBln from BM_Destacking where RowStatus>-1 group by ItemID,PlantiD,TglProduksi ), " +
                        " Listplank1 as (select B.PartNo,PlantID,ThnBln from Listplank A inner join FC_Items B ON A.ItemID=B.ID), " +
                        " Listplank2 as ( " +
                        " select PartnoAsal,isnull(cast((sum(M3)) as decimal(18,1)),0) M3  from ( " +
                        " select PartnoAsal,isnull(cast((sum(M3)) as decimal(18,2)),0)M3  from (  select PartnoAsal,Qty,cast((((Tebal*Lebar*Panjang)/1000000000)*Qty) as decimal(18,5)) M3  from (  select PartnoAsal,PartNo2,sum(Qty)Qty,Tebal,Lebar,Panjang  from (  select x1.PartNo PartnoAsal,x2.PartNo PartNo2,x2.Tebal,x2.Lebar,x2.Panjang,x.Qty from (  select ItemID0,itemid,Qty * -1 Qty from vw_KartuStockListplank where left(convert(char,tanggal,112),8)>=@thnbln1 and  left(convert(char,tanggal,112),8)<=@thnbln2 and process='runingsaw' and qty<0 ) as x   inner join FC_Items x1 ON x.ItemID0=x1.ID  inner join FC_Items x2 ON x.ItemID=x2.ID) as A group by PartnoAsal,PartNo2,Tebal,Lebar,Panjang ) as xx ) as xx1  group by PartnoAsal " +
                        " union all " +
                        " /** 2. Saldo Awal Running Saw **/   " +
                        " select PartnoAsal,isnull(cast((sum((Volume*Qty))) as decimal(18,2)),0) M3  from (  select x2.PartNo PartnoAsal,cast(((x1.Tebal*x1.Lebar*x1.Panjang)/1000000000) as decimal(10,5))Volume,x.Qty  from (  select sum(saldo)Qty ,ItemID,ItemID0 from T1_SaldoListPlank where Process='runingsaw' and thnbln=@BlnThn and Saldo>0 and ItemID<>ItemID0 group by ItemID,ItemID0 ) as x    inner join FC_Items x1 ON x.ItemID=x1.ID  inner join FC_Items x2 ON x.ItemID0=x2.ID) as A group by PartnoAsal " +
                        " union all  " +
                        " /** 3. Saldo Akhir RunningSaw **/ " +
                        " select PartnoAsal,isnull(cast((sum(M3)) as decimal(18,2)) * -1,0) M3 from (  select PartnoAsal,Qty,cast((((Tebal*Lebar*Panjang)/1000000000)*Qty) as decimal(18,5)) M3  from (  select PartnoAsal,PartNo2,sum(Qty)Qty,Tebal,Lebar,Panjang  from (  select x1.PartNo PartnoAsal,x2.PartNo PartNo2,x2.Tebal,x2.Lebar,x2.Panjang,x.Qty from (  select sum(Saldo)Qty,ItemID0,ItemID from T1_SaldoListPlank where Process='runingsaw' and thnbln=left(convert(char,@thnbln1,112),6) and Saldo>0 and ItemID<>ItemID0  group by ItemID0,ItemID ) as x   inner join FC_Items x1 ON x.ItemID0=x1.ID  inner join FC_Items x2 ON x.ItemID=x2.ID) as A group by PartnoAsal,PartNo2,Tebal,Lebar,Panjang ) as xx ) as xx1    group by PartnoAsal " +
                        " union all  " +
                        " /** 4. Saldo Awal Bevel **/  " +
                        " select PartnoAsal,isnull(cast((sum(M3)) as decimal(18,2)),0) M3  from (  select PartnoAsal,Qty,cast((((Tebal*Lebar*Panjang)/1000000000)*Qty) as decimal(18,5)) M3  from (  select PartnoAsal,PartNo2,sum(Qty)Qty,Tebal,Lebar,Panjang  from (  select x1.PartNo PartnoAsal,x2.PartNo PartNo2,x2.Tebal,x2.Lebar,x2.Panjang,x.Qty from (  select sum(Saldo)Qty,ItemID0,ItemID from T1_SaldoListPlank where Process='bevel' and thnbln=@BlnThn and Saldo>0 group by ItemID0,ItemID ) as x   inner join FC_Items x1 ON x.ItemID0=x1.ID  inner join FC_Items x2 ON x.ItemID=x2.ID) as A group by PartnoAsal,PartNo2,Tebal,Lebar,Panjang ) as xx ) as xx1 group by PartnoAsal  " +
                        " union all  " +
                        " /** 5. Saldo Akhir Bevel **/   " +
                        " select PartnoAsal,isnull(cast((sum(M3)) as decimal(18,2)) * -1,0) M3 from (  select PartnoAsal,Qty,cast((((Tebal*Lebar*Panjang)/1000000000)*Qty) as decimal(18,5)) M3  from (  select PartnoAsal,PartNo2,sum(Qty)Qty,Tebal,Lebar,Panjang  from (  select x1.PartNo PartnoAsal,x2.PartNo PartNo2,x2.Tebal,x2.Lebar,x2.Panjang,x.Qty from (  select sum(Saldo)Qty,ItemID0,ItemID from T1_SaldoListPlank where Process='bevel' and thnbln=left(convert(char,@thnbln1,112),6) and Saldo>0 and ItemID<>ItemID0  group by ItemID0,ItemID ) as x   inner join FC_Items x1 ON x.ItemID0=x1.ID  inner join FC_Items x2 ON x.ItemID=x2.ID) as A group by PartnoAsal,PartNo2,Tebal,Lebar,Panjang ) as xx ) as xx1   group by PartnoAsal  " +
                        " union all " +
                        " /** 6. Saldo Awal Strapping **/   " +
                        " select PartnoAsal,isnull(cast((sum(M3)) as decimal(18,2)),0) M3 from (select PartnoAsal,Qty,cast((((Tebal*Lebar*Panjang)/1000000000)*Qty) as decimal(18,5)) M3  from (  select PartnoAsal,PartNo2,sum(Qty)Qty,Tebal,Lebar,Panjang  from (  select x1.PartNo PartnoAsal,x2.PartNo PartNo2,x2.Tebal,x2.Lebar,x2.Panjang,x.Qty from (  select sum(Saldo)Qty,ItemID0,ItemID from T1_SaldoListPlank where Process='straping' and thnbln=@BlnThn and Saldo>0 group by ItemID0,ItemID ) as x   inner join FC_Items x1 ON x.ItemID0=x1.ID  inner join FC_Items x2 ON x.ItemID=x2.ID) as A group by PartnoAsal,PartNo2,Tebal,Lebar,Panjang ) as xx ) as xx1 group by PartnoAsal " +
                        " union all  " +
                        " /** 7. Saldo Akhir Strapping **/ " +
                        " select PartnoAsal,isnull(cast((sum(M3)) as decimal(18,2))* -1,0) M3 from (  select PartnoAsal,Qty,cast((((Tebal*Lebar*Panjang)/1000000000)*Qty) as decimal(18,5)) M3  from (  select PartnoAsal,PartNo2,sum(Qty)Qty,Tebal,Lebar,Panjang  from (  select x1.PartNo PartnoAsal,x2.PartNo PartNo2,x2.Tebal,x2.Lebar,x2.Panjang,x.Qty from (  select sum(Saldo)Qty,ItemID0,ItemID from T1_SaldoListPlank where Process='straping' and thnbln=left(convert(char,@thnbln1,112),6) and Saldo>0 and ItemID<>ItemID0  group by ItemID0,ItemID ) as x   inner join FC_Items x1 ON x.ItemID0=x1.ID  inner join FC_Items x2 ON x.ItemID=x2.ID) as A group by PartnoAsal,PartNo2,Tebal,Lebar,Panjang ) as xx ) as xxx group by PartnoAsal " +
                        " union all " +
                        " /** 8. Tahap III OK **/    " +
                        " select PartnoAsal,isnull(cast((sum(M3))*-1 as decimal(18,2)),0) M3 from (  select PartnoAsal,Qty,cast((((Tebal*Lebar*Panjang)/1000000000)*Qty) as decimal(18,5)) M3  from (  select PartnoAsal,sum(Qty)Qty,Tebal,Lebar,Panjang  from (  select x.PartNo PartnoAsal,x2.Tebal,x2.Lebar,x2.Panjang,x.Qty from (  select sum(Qty)Qty,ItemID,Keterangan Partno from vw_KartuStockBJNew  where sfrom='straping' and left(convert(char,tanggal,112),6)=left(convert(char,@thnbln1,112),6) and ItemID in  (select ID from FC_Items where PartNo like'%-M-%' or PartNo like'%-3-%')  group by ItemID,Keterangan ) as x   inner join FC_Items x2 ON x.ItemID=x2.ID) as A group by PartnoAsal,Tebal,Lebar,Panjang ) as xx ) as xx1 group by PartnoAsal " +
                        " union all  " +
                        " /** 9. Tahap III BP **/  " +
                        " select PartnoAsal,isnull(cast((sum(M3)) as decimal(18,2)),0) M3  from (  select PartnoAsal,Qty,cast((((Tebal*Lebar*Panjang)/1000000000)*Qty) as decimal(18,5))  M3  from (  select PartnoAsal,sum(Qty)Qty,Tebal,Lebar,Panjang  from (  select x.PartNo PartnoAsal,x2.Tebal,x2.Lebar,x2.Panjang,x.Qty from (  select sum(Qty)Qty,ItemID,Keterangan Partno from vw_KartuStockBJNew  where sfrom='straping' and left(convert(char,tanggal,112),6)=left(convert(char,@thnbln1,112),6) and  ItemID in (select ID from FC_Items where PartNo like'%-P-%' or PartNo like'%-S-%')  group by ItemID,Keterangan ) as x   inner join FC_Items x2 ON x.ItemID=x2.ID) as A group by PartnoAsal,Tebal,Lebar,Panjang ) as xx ) as xx1 group by PartnoAsal " +
                        " ) as DataFinall group by PartnoAsal ) ,  " +

                        //" Listplank3 as (select *,(select top 1 A1.ThnBln from Listplank1 A1 where A1.PartNo=A.PartnoAsal and A1.ThnBln<=left(convert(char,@thnbln1,112),6) order by A1.ThnBln desc)ThnBln from Listplank2 A) , "+
                        //" Listplank4 as (select PartnoAsal,sum(M3)M3,ThnBln,PlantID from (select A.*,B.PlantID from Listplank3 A left join Listplank1 B ON A.PartnoAsal=B.PartNo and A.ThnBln=B.ThnBln ) as x group by PartnoAsal,ThnBln,PlantID), "+
                        //" Listplank04 as (select *,(select top 1 A1.Line from Def_UKhususProsen A1 where A1.rowstatus>-1 and A1.Partno=A.PartnoAsal and A1.Periode=left(convert(char,@thnbln1,112),6))PlantID2 from Listplank4 A ), "+
                        //" Listplank5 as (select PartnoAsal,M3,case when PlantID2 is null then PlantID else PlantID2 end PlantID from Listplank04 xx), " +
                        //" Listplank051 as (select PartnoAsal,M3,PlantID from Listplank5 xx group by PartnoAsal,M3,PlantID ), "+
                        //" Listplank05 as (select PartnoAsal,M3,PlantID,(select count(PartnoAsal) from Listplank051 A where A.PartnoAsal=Listplank051.PartnoAsal)ttl from Listplank051 group by PartnoAsal,M3,PlantID), " +
                        //" Listplank6 as (select PartnoAsal,sum(m3)m3,PlantID,ttl from Listplank05 group by PlantID,ttl,PartnoAsal), "+
                        //" Listplank06 as (select PartnoAsal,case when ttl=1 then m3 when ttl>1 then m3/ttl end m3,PlantID from Listplank6 group by PlantID,m3,ttl,PartnoAsal), "+
                        //" Listplank7 as ( "+
                        //" select sum(M3)M3,[Group] from ( "+
                        //" select M3/4 M3,B.[Group] from Listplank06 A inner join BM_PlantGroup B ON A.PlantID=B.PlantID where B.PlantID>0 "+
                        //" union all "+
                        //" select 0'M3',[Group] from BM_PlantGroup where PlantID>0 ) as x group by [Group] ) "+
                        //" select * into tempDetail_Listplank from Listplank7; "+

                        " Listplank3 as (select *,(select top 1 A1.ThnBln from Listplank1 A1 where A1.PartNo=A.PartnoAsal and A1.ThnBln<=left(convert(char,@thnbln1,112),6) order by A1.ThnBln desc)ThnBln from Listplank2 A) , " +
                        " Listplank4 as (select PartnoAsal,sum(M3)M3,ThnBln,PlantID from (select A.*,B.PlantID from Listplank3 A left join Listplank1 B ON A.PartnoAsal=B.PartNo and A.ThnBln=B.ThnBln ) as x group by PartnoAsal,ThnBln,PlantID), " +
                        " Listplank04 as (select *,(select top 1 A1.Line from Def_UKhususProsen A1 where A1.Partno=A.PartnoAsal and A1.Periode=left(convert(char,@thnbln1,112),6))PlantID2 from Listplank4 A ), " +
                        " Listplank5 as (select PartnoAsal,M3,case when PlantID2 is null then PlantID else PlantID2 end PlantID from Listplank04 xx), " +
                        " Listplank051 as (select PartnoAsal,M3,PlantID from Listplank5 xx group by PartnoAsal,M3,PlantID ), " +
                        " Listplank05 as (select PartnoAsal,M3,PlantID,(select count(PartnoAsal) from Listplank051 A where A.PartnoAsal=Listplank051.PartnoAsal)ttl from Listplank051 group by PartnoAsal,M3,PlantID), " +
                        " Listplank6 as (select PartnoAsal,sum(m3)m3,PlantID,ttl from Listplank05 group by PlantID,ttl,PartnoAsal), " +
                        " Listplank06 as (select PartnoAsal,case when ttl=1 then m3 when ttl>1 then m3/ttl end m3,PlantID from Listplank6 group by PlantID,m3,ttl,PartnoAsal), " +
                        " Listplank7 as ( " +
                        " select sum(M3)M3,[Group] from ( " +
                        " select M3/4 M3,B.[Group] from Listplank06 A inner join BM_PlantGroup B ON A.PlantID=B.PlantID where B.PlantID>0 " +
                        " union all " +
                        " select 0'M3',[Group] from BM_PlantGroup where PlantID>0 ) as x group by [Group] ) " +
                        " select *  into tempDetail_Listplank from Listplank7; " +

                        /** tambahan **/
                        " with   AListplank as (select distinct ItemID,PlantID,left(convert(char,tglproduksi,112),6)ThnBln from BM_Destacking where RowStatus>-1 group by ItemID,PlantiD,TglProduksi ),  " +

                        " AListplank1 as (select B.PartNo,PlantID,ThnBln from AListplank A inner join FC_Items B ON A.ItemID=B.ID),  Listplank2 as (  select PartnoAsal,isnull(cast((sum(M3)) as decimal(18,1)),0) M3  from (  select PartnoAsal,isnull(cast((sum(M3)) as decimal(18,2)),0)M3  from (  select PartnoAsal,Qty,cast((((Tebal*Lebar*Panjang)/1000000000)*Qty) as decimal(18,5)) M3  from (  select PartnoAsal,PartNo2,sum(Qty)Qty,Tebal,Lebar,Panjang  from (  select x1.PartNo PartnoAsal,x2.PartNo PartNo2,x2.Tebal,x2.Lebar,x2.Panjang,x.Qty from (  select ItemID0,itemid,Qty * -1 Qty from vw_KartuStockListplank where left(convert(char,tanggal,112),8)>=@thnbln1 and  left(convert(char,tanggal,112),8)<=@thnbln2 and process='runingsaw' and qty<0 ) as x   inner join FC_Items x1 ON x.ItemID0=x1.ID  inner join FC_Items x2 ON x.ItemID=x2.ID) as A group by PartnoAsal,PartNo2,Tebal,Lebar,Panjang ) as xx ) as xx1  group by PartnoAsal  " +
                        " union all " +
                        " /** 2. Saldo Awal Running Saw **/  " +
                        " select PartnoAsal,isnull(cast((sum((Volume*Qty))) as decimal(18,2)),0) M3  from (  select x2.PartNo PartnoAsal,cast(((x1.Tebal*x1.Lebar*x1.Panjang)/1000000000) as decimal(10,5))Volume,x.Qty  from (  select sum(saldo)Qty ,ItemID,ItemID0 from T1_SaldoListPlank where Process='runingsaw' and thnbln=@BlnThn and Saldo>0 and ItemID<>ItemID0 group by ItemID,ItemID0 ) as x    inner join FC_Items x1 ON x.ItemID=x1.ID  inner join FC_Items x2 ON x.ItemID0=x2.ID) as A group by PartnoAsal  " +
                        "  union all " +
                        "  /** 3. Saldo Akhir RunningSaw **/  " +
                        "  select PartnoAsal,isnull(cast((sum(M3)) as decimal(18,2)) * -1,0) M3 from (  select PartnoAsal,Qty,cast((((Tebal*Lebar*Panjang)/1000000000)*Qty) as decimal(18,5)) M3  from (  select PartnoAsal,PartNo2,sum(Qty)Qty,Tebal,Lebar,Panjang  from (  select x1.PartNo PartnoAsal,x2.PartNo PartNo2,x2.Tebal,x2.Lebar,x2.Panjang,x.Qty from (  select sum(Saldo)Qty,ItemID0,ItemID from T1_SaldoListPlank where Process='runingsaw' and thnbln=left(convert(char,@thnbln1,112),6) and Saldo>0 and ItemID<>ItemID0  group by ItemID0,ItemID ) as x   inner join FC_Items x1 ON x.ItemID0=x1.ID  inner join FC_Items x2 ON x.ItemID=x2.ID) as A group by PartnoAsal,PartNo2,Tebal,Lebar,Panjang ) as xx ) as xx1    group by PartnoAsal  " +
                        " union all   " +
                        " /** 4. Saldo Awal Bevel **/   " +
                        " select PartnoAsal,isnull(cast((sum(M3)) as decimal(18,2)),0) M3  from (  select PartnoAsal,Qty,cast((((Tebal*Lebar*Panjang)/1000000000)*Qty) as decimal(18,5)) M3  from (  select PartnoAsal,PartNo2,sum(Qty)Qty,Tebal,Lebar,Panjang  from (  select x1.PartNo PartnoAsal,x2.PartNo PartNo2,x2.Tebal,x2.Lebar,x2.Panjang,x.Qty from (  select sum(Saldo)Qty,ItemID0,ItemID from T1_SaldoListPlank where Process='bevel' and thnbln=@BlnThn and Saldo>0 group by ItemID0,ItemID ) as x   inner join FC_Items x1 ON x.ItemID0=x1.ID  inner join FC_Items x2 ON x.ItemID=x2.ID) as A group by PartnoAsal,PartNo2,Tebal,Lebar,Panjang ) as xx ) as xx1 group by PartnoAsal   union all   " +
                        " /** 5. Saldo Akhir Bevel **/   " +
                        " select PartnoAsal,isnull(cast((sum(M3)) as decimal(18,2)) * -1,0) M3 from (  select PartnoAsal,Qty,cast((((Tebal*Lebar*Panjang)/1000000000)*Qty) as decimal(18,5)) M3  from (  select PartnoAsal,PartNo2,sum(Qty)Qty,Tebal,Lebar,Panjang  from (  select x1.PartNo PartnoAsal,x2.PartNo PartNo2,x2.Tebal,x2.Lebar,x2.Panjang,x.Qty from (  select sum(Saldo)Qty,ItemID0,ItemID from T1_SaldoListPlank where Process='bevel' and thnbln=left(convert(char,@thnbln1,112),6) and Saldo>0 and ItemID<>ItemID0  group by ItemID0,ItemID ) as x   inner join FC_Items x1 ON x.ItemID0=x1.ID  inner join FC_Items x2 ON x.ItemID=x2.ID) as A group by PartnoAsal,PartNo2,Tebal,Lebar,Panjang ) as xx ) as xx1   group by PartnoAsal   union all  " +
                        " /** 6. Saldo Awal Strapping **/  " +
                        " select PartnoAsal,isnull(cast((sum(M3)) as decimal(18,2)),0) M3 from (select PartnoAsal,Qty,cast((((Tebal*Lebar*Panjang)/1000000000)*Qty) as decimal(18,5)) M3  from (  select PartnoAsal,PartNo2,sum(Qty)Qty,Tebal,Lebar,Panjang  from (  select x1.PartNo PartnoAsal,x2.PartNo PartNo2,x2.Tebal,x2.Lebar,x2.Panjang,x.Qty from (  select sum(Saldo)Qty,ItemID0,ItemID from T1_SaldoListPlank where Process='straping' and thnbln=@BlnThn and Saldo>0 group by ItemID0,ItemID ) as x   inner join FC_Items x1 ON x.ItemID0=x1.ID  inner join FC_Items x2 ON x.ItemID=x2.ID) as A group by PartnoAsal,PartNo2,Tebal,Lebar,Panjang ) as xx ) as xx1 group by PartnoAsal  " +
                        " union all   " +
                        " /** 7. Saldo Akhir Strapping **/  " +
                        " select PartnoAsal,isnull(cast((sum(M3)) as decimal(18,2))* -1,0) M3 from (  select PartnoAsal,Qty,cast((((Tebal*Lebar*Panjang)/1000000000)*Qty) as decimal(18,5)) M3  from (  select PartnoAsal,PartNo2,sum(Qty)Qty,Tebal,Lebar,Panjang  from (  select x1.PartNo PartnoAsal,x2.PartNo PartNo2,x2.Tebal,x2.Lebar,x2.Panjang,x.Qty from (  select sum(Saldo)Qty,ItemID0,ItemID from T1_SaldoListPlank where Process='straping' and thnbln=left(convert(char,@thnbln1,112),6) and Saldo>0 and ItemID<>ItemID0  group by ItemID0,ItemID ) as x   inner join FC_Items x1 ON x.ItemID0=x1.ID  inner join FC_Items x2 ON x.ItemID=x2.ID) as A group by PartnoAsal,PartNo2,Tebal,Lebar,Panjang ) as xx ) as xxx group by PartnoAsal  " +
                        "  ) as DataFinall group by PartnoAsal ) ,  " +
                        " AListplank3 as (select *,(select top 1 A1.ThnBln from AListplank1 A1 where A1.PartNo=A.PartnoAsal and A1.ThnBln<=left(convert(char,@thnbln1,112),6) order by A1.ThnBln desc)ThnBln from Listplank2 A) , " +
                        " AListplank4 as (select PartnoAsal,sum(M3)M3,ThnBln,PlantID from (select A.*,B.PlantID from AListplank3 A left join AListplank1 B ON A.PartnoAsal=B.PartNo and A.ThnBln=B.ThnBln ) as x group by PartnoAsal,ThnBln,PlantID),  " +
                        " AListplank04 as (select *,(select top 1 A1.Line from Def_UKhususProsen A1 where A1.Partno=A.PartnoAsal and A1.Periode=left(convert(char,@thnbln1,112),6))PlantID2 from AListplank4 A ),  " +
                        " AListplank5 as (select PartnoAsal,M3,case when PlantID2 is null then PlantID else PlantID2 end PlantID from AListplank04 xx), " +
                        " AListplank051 as (select PartnoAsal,M3,PlantID from AListplank5 xx group by PartnoAsal,M3,PlantID ),  " +
                        " AListplank05 as (select PartnoAsal,M3,PlantID,(select count(PartnoAsal) from AListplank051 A where A.PartnoAsal=AListplank051.PartnoAsal)ttl from AListplank051 group by PartnoAsal,M3,PlantID),  " +
                        " AListplank6 as (select PartnoAsal,sum(m3)m3,PlantID,ttl from AListplank05 group by PlantID,ttl,PartnoAsal), " +
                        " AListplank06 as (select PartnoAsal,case when ttl=1 then m3 when ttl>1 then m3/ttl end m3,PlantID from AListplank6 group by PlantID,m3,ttl,PartnoAsal), " +
                        " AListplank7 as (  select sum(M3)M3,[Group] from (  select M3/4 M3,B.[Group] from AListplank06 A inner join BM_PlantGroup B ON A.PlantID=B.PlantID where B.PlantID>0  " +
                        " union all " +
                        " select 0'M3',[Group] from BM_PlantGroup where PlantID>0 ) as x group by [Group] )  " +

                        " select * into AtempDetail_Listplank from AListplank7; " +

                        " /** 6. Perhitungan Defect ListPlank dikurangi OK - BP ( Detail Defect ListPlank ) **/   " +
                        " with  " +
                        " LP as (select distinct ItemID,PlantID,left(convert(char,tglproduksi,112),6)ThnBln from BM_Destacking where RowStatus>-1 group by ItemID,PlantiD,TglProduksi ), " +
                        " LP01 as (select B.PartNo,PlantID,ThnBln from LP A inner join FC_Items B ON A.ItemID=B.ID), " +
                        " LP02 as ( " +
                        " select PartnoAsal,isnull(cast((sum(M3)) as decimal(18,1)),0) M3  from ( " +
                        " /** 1. Tahap III OK **/   " +
                        " select PartnoAsal,isnull(cast((sum(M3))*-1 as decimal(18,2)),0) M3 from (  select PartnoAsal,Qty,cast((((Tebal*Lebar*Panjang)/1000000000)*Qty) as decimal(18,5)) M3  from (  select PartnoAsal,sum(Qty)Qty,Tebal,Lebar,Panjang  from (  select x.PartNo PartnoAsal,x2.Tebal,x2.Lebar,x2.Panjang,x.Qty from (  select sum(Qty)Qty,ItemID,Keterangan Partno from vw_KartuStockBJNew  where sfrom='straping' and left(convert(char,tanggal,112),6)=left(convert(char,@thnbln1,112),6) and ItemID in  (select ID from FC_Items where PartNo like'%-M-%' or PartNo like'%-3-%')  group by ItemID,Keterangan ) as x   inner join FC_Items x2 ON x.ItemID=x2.ID) as A group by PartnoAsal,Tebal,Lebar,Panjang ) as xx ) as xx1 group by PartnoAsal " +
                        " /** union all " +
                        " /** 2. Tahap III BP **/ " +
                        " select PartnoAsal,isnull(cast((sum(M3)) as decimal(18,2)),0) M3  from (  select PartnoAsal,Qty,cast((((Tebal*Lebar*Panjang)/1000000000)*Qty) as decimal(18,5))  M3  from (  select PartnoAsal,sum(Qty)Qty,Tebal,Lebar,Panjang  from (  select x.PartNo PartnoAsal,x2.Tebal,x2.Lebar,x2.Panjang,x.Qty from (  select sum(Qty)Qty,ItemID,Keterangan Partno from vw_KartuStockBJNew  where sfrom='straping' and left(convert(char,tanggal,112),6)=left(convert(char,@thnbln1,112),6) and  ItemID in (select ID from FC_Items where PartNo like'%-P-%' or PartNo like'%-S-%')  group by ItemID,Keterangan ) as x   inner join FC_Items x2 ON x.ItemID=x2.ID) as A group by PartnoAsal,Tebal,Lebar,Panjang ) as xx ) as xx1 group by PartnoAsal **/ " +
                        " ) as DataFinall group by PartnoAsal ) ,  " +

                        " LP03 as (select *,(select top 1 A1.ThnBln from LP01 A1 where A1.PartNo=A.PartnoAsal and A1.ThnBln<=left(convert(char,@thnbln1,112),6) order by A1.ThnBln desc)ThnBln from LP02 A) , " +
                        " LP04 as (select PartnoAsal,sum(M3)M3,ThnBln,PlantID from (select A.*,B.PlantID from LP03 A left join LP01 B ON A.PartnoAsal=B.PartNo and A.ThnBln=B.ThnBln ) as x group by PartnoAsal,ThnBln,PlantID), " +
                        " LP004 as (select *,(select top 1 A1.Line from Def_UKhususProsen A1 where A1.rowstatus>-1 and A1.Partno=A.PartnoAsal and A1.Periode=left(convert(char,@thnbln1,112),6))PlantID2 from LP04 A ), " +
                        " LP05 as (select PartnoAsal,M3,case when PlantID2 is null then PlantID else PlantID2 end PlantID from LP004 xx),  " +
                        " LP005 as (select PartnoAsal,M3,PlantID from LP05 group by PartnoAsal,M3,PlantID), " +
                        " LP06 as (select sum(M3)M3,PlantID from LP005 group by PlantID), " +
                        " LP07 as ( " +
                        " select sum(M3)M3,[Group] from ( " +
                        " select M3/4 M3,B.[Group] from LP06 A inner join BM_PlantGroup B ON A.PlantID=B.PlantID where B.PlantID>0 " +
                        " union all " +
                        " select 0'M3',[Group] from BM_PlantGroup where PlantID>0 ) as x group by [Group] ) " +
                        " select * into tempDetail_Listplank0 from LP07; " +

                        " /** 7. Detail Defect Produksi **/ " +
                        " select sum(M3)M3,[Group] into tempDefectProduksi from ( " +
                        " select M3,[Group] from tempDefectBMFin union all  " +
                        " select M3,[Group] from tempDetail_Listplank union all  " +
                        " select M3,[Group] from tempDetailDefect_UkuranKhusus ) as x group by [Group] " +

                        " /** Total Group Produksi **/  " +
                        " declare @TtlGroup varchar(3)  " +
                        " set @TtlGroup=(select count([Group])TtlGroup from (  select [Group] from (  select [Group] from detailDfctSystemBM_M3  " +
                        " union all   " +
                        " select [Group] from DtlDefectSystemFN_M3 ) as x group by [Group] ) as x1)  ; " +
                        " /** End Total Group Produksi **/ " +

                        " /** 8.1. Total BS Tahap 1 **/ " +

                        " select distinct itemid into tempDataBSauto from vw_KartuStockBJNew where itemid in (select ID from fc_items where partno like '%-s-%') and LokID in (select ID from FC_Lokasi where Lokasi='bsauto') " +

                        " ;with BSTahap as (select distinct itemid from vw_KartuStockBJNew where itemid in (select ID from fc_items where partno like '%-s-%') and  LokID in (select ID from FC_Lokasi where Lokasi='bsauto')  ), " +
                        " BSTahap1 as (select * from vw_KartuStockBJNew where left(CONVERT(char, tanggal ,112),6)=left(convert(char,@thnbln1,112),6) and itemID in   (select itemid from tempDataBSauto)), " +
                        " BSTahap2 as (select * from vw_KartuStockBJNew where left(CONVERT(char, tanggal ,112),6)=left(convert(char,@thnbln1,112),6) and itemID not in   (select itemid from tempDataBSauto) ), " +
                        " BSTahap3 as (select isnull(sum(Qty),0)Qty,isnull(sum(Qty*Volume),0)M3  from (  select x.qty Qty,((x1.Tebal*x1.Lebar*x1.Panjang)/1000000000)Volume from (  select Qty,ItemID from BSTahap1 where (process='direct' or process like'%Simetris%') and (isnull(sfrom,'-')='-' or isnull(sfrom,'bevel')='-'  or isnull(sfrom,'-')='straping') and lokid in (select ID from FC_Lokasi where Lokasi='BSAUTO') and substring(Keterangan,1,21) like '%-1-%'  and left(convert(char,tanggal,112),6)=left(convert(char,@thnbln1,112),6) and PartNo  like'%-S-%') as x inner join FC_Items x1 ON x.ItemID=x1.ID ) as A  ), " +
                        " BSTahap4 as (select isnull(sum(Qty),0)Qty,isnull(sum(Qty*Volume),0)M3 from (  select x.qty Qty,((x1.Tebal*x1.Lebar*x1.Panjang)/1000000000)Volume from (  select Qty,ItemID from BSTahap2 where (process='direct' or process like'%Simetris%') and (isnull(sfrom,'-')='-' or isnull(sfrom,'bevel')='-'  or isnull(sfrom,'-')='straping') and lokid not in (select ID from FC_Lokasi where Lokasi='BSAUTO') and substring(Keterangan,1,21) like '%-1-%'  and left(convert(char,tanggal,112),6)=left(convert(char,@thnbln1,112),6) and PartNo  like'%-S-%') as x inner join FC_Items x1 ON x.ItemID=x1.ID ) as A ), " +
                        " BSTahap5 as (select isnull(cast(sum(M3) as decimal(18,1)),0) M3 from (select M3 from BSTahap3 union all select M3 from BSTahap4) as x ) " +
                        " select * into tempTotalBSTahap1 from BSTahap5 " +

                        " declare @TtlBS_Tahap1 varchar(10)   " +
                        " set @TtlBS_Tahap1 = (select M3 from tempTotalBSTahap1)   " +

                        " /** 8.2. Detail BS Tahap 1 **/ " +
                        " select [Group],cast(((M3/@TtlDfctSystemBM_M3)* @TtlBS_Tahap1) as decimal(18,2))  M3 into tempDetailBSTahap1 from detailDfctSystemBM_M3 order by [group]  " +

                        " /** 9. Detail Total Defect Proposionet **/ " +
                        " select sum(M3)M3,[Group] into tempDetailTotalDefect_P from ( " +
                        " select M3,[Group] from tempDefectBMFin  " +
                        " union all " +
                        " select M3,[Group] from tempDetailDefect_UkuranKhusus " +
                        " union all " +
                        " select M3,[Group] from tempDetail_Listplank  " +
                        " union all " +
                        " select M3,[Group] from tempDetailBSTahap1 ) as x group by [Group] " +

                        " /** 10. Total Potong QA **/   " +
                        " select  B.[Group],cast((sum(TPotongM3)) as decimal(18,2))  TotPotongM3 into tempTotPotong_QA from BM_Destacking A left join BM_PlantGroup B on A.PlantGroupID=B.ID  inner join (  select C.ID DestID , A.TPotong qtyin,A.TPotong*I.Volume as kubik,A.TPotong*I.Volume TPotongM3 from Def_Defect A   inner join BM_Destacking C on A.DestID=C.ID left join FC_Items I on I.ID=C.ItemID where A.Status>-1 and CONVERT(char,A.tgl,112)>=@thnbln1 and  CONVERT(char,A.tgl,112)<=@thnbln2 ) as C  on A.ID=C.DestID group by B.[Group] ; " +
                        " /** End Total Potong QA **/   " +

                        " /** 11. Detail Total Potong ListPlank dan Ukuran Khusus **/ " +
                        " select sum(M3)M3,[Group] into tempDetailTotPotong_LPUK from ( " +
                        " select * from tempDetailDefect_UkuranKhusus union all " +
                        " select * from tempDetailDefect_UkuranKhususOK union all " +
                        " select * from tempDetail_Listplank union all " +
                        " " + logika2 + " " +
                        //" select M3 *-1 M3,[Group] from tempDetail_Listplank0 "+
                        //" /**select M3,[Group] from AtempDetail_Listplank**/ "+
                        " ) as x group by [Group] " +

                        " /** 12. Detail Total Potong System QA,ListPlank dan Ukuran Khusus **/ " +
                        " select sum(M3)M3,[Group] into tempDetailTotPotong_LPUK2 from ( " +
                        " select * from tempDetailTotPotong_LPUK " +
                        " union all " +
                        " select TotPotongM3 M3,[Group] from tempTotPotong_QA ) as x group by [Group] " +

                        " /** 13. Selisih Total Potong **/ " +
                        " /** 13.1 Total Potong Keseluruhan ( Accounting Report ) **/ " +
                        " declare @ttlPotongSemua varchar(30) " +
                        " set @ttlPotongSemua=( " +
                        " select cast(sum(M3) as decimal(18,0)) M3 from ( " +
                        " select sum(M3)M3 from tempDetailBSTahap1 " +
                        " union all " +
                        " select cast(sum(M3) as decimal(18,1))M3 from ( " +
                        " select sum(M3)M3 from tempDetail_Listplank " +
                        " union all " +
                        " select sum(M3) * -1 M3 from tempDetail_Listplank0 ) as x " +
                        " union all " +
                        " select cast(sum(M3) as decimal(18,1))M3 from ( " +
                        " select sum(M3)M3 from tempDetailDefect_UkuranKhusus " +
                        " union all " +
                        " select sum(M3)M3 from tempDetailDefect_UkuranKhususOK ) as x " +
                        " union all " +
                        " select @TtlDfctBMFN_M3 M3 " +
                        " union all " +
                        " select @TtlDfctBMFN_M3_OKKW M3 ) as x) " +

                        " /** 13.2 Total Selisih Total Potong **/ " +
                        " declare @selisihTotalPot decimal(18,1) " +
                        " set @selisihTotalPot=( " +
                        " select sum(M3) M3 from ( " +
                        " select @ttlPotongSemua M3 " +
                        " union all " +
                        " select round(sum(M3),1)* -1 M3 from tempDetailTotPotong_LPUK2 ) as x ) " +

                        " /** 13.3 Detail Selisih Total Potong **/ " +

                        "" + logika1 + "" +

                        //" select cast(@selisihTotalPot/24 as decimal(18,1))M3,[Group] into DtlSelisihTtlPot from ( " +
                        //" select [Group] from detailDfctSystemBM_M3  " +
                        //" union all   " +
                        //" select [Group] from DtlDefectSystemFN_M3 " +
                        //" union all " +
                        //" select [Group] from BM_PlantGroup where PlantID>0) as x group by [Group] " +

                        //" select sum(M3)M3,[Group]  into DtlSelisihTtlPot from ( "+
                        //" select (@selisihTotalPot/(select count([Group])ttl from tempDetailTotPotong_LPUK where m3>0))M3,[Group] from tempDetailTotPotong_LPUK  where m3>0 union all " +
                        //" select '0'M3,[Group] from BM_PlantGroup where PlantID>0) as x group by [Group] "+

                        " /** 14. Total Potong Proposionet **/ " +
                        " select sum(M3)M3,[Group] into DtlTotalPotongProposionet from ( " +
                        " select * from tempDetailTotPotong_LPUK2 " +
                        " union all " +
                        " select * from DtlSelisihTtlPot ) as x group by [Group] " +

                        " select *,isnull((select sum(qty) from tempdefectGPIso where [group]=A.[Group] ),0) totdefect, isnull((select sum(kubik) from tempdefectGPIso where [group]=A.[Group] ),0) totdefectK into tempdefectGPIsoTot from ( select  B.[Group],SUM(C.qtyin) as totpotong,SUM(kubik) as totkubik    from BM_Destacking A left join BM_PlantGroup B on A.PlantGroupID=B.ID  inner join (  select C.destid,C.qtyin,C.QtyIn*I1.Volume as kubik from T1_Serah C Inner join fc_items I  on C.itemid=I.ID Inner join fc_items I1 on C.itemid0=I1.ID  where C.Status>-1 and CONVERT(char,C.tglserah,112)>=@thnbln1 and   CONVERT(char,C.tglserah,112)<=@thnbln2 and (I.PartNo like '%-w-%' or I.PartNo like '%-3-%' )  union all   select C.DestID , B.Qty qtyin,B.Qty*I.Volume as kubik from Def_Defect A inner join Def_DefectDetail B on A.ID=B.DefectID  inner join T1_Serah C on A.SerahID=C.ID  left join FC_Items I on I.ID=C.ItemID0  where CONVERT(char,A.tgl,112)>=@thnbln1 and  CONVERT(char,A.tgl,112)<=@thnbln2 and B.RowStatus>-1 ) as C   on A.ID=C.DestID group by B.[Group])A  " +

                        " declare @DefectFin decimal(18,2) " +
                        " set @DefectFin= (select sum(kubik) from (  select case when D.DeptID=0 then  case when GJ.GroupJemurName In ('M','N','O','P','Q','R','S','T','U','V','W','X') then   case when D.DefName='retak' then 2   when D.DefName='gompal' then 3  else D.DeptID end   else    case when (B.Qty/E.Qty) *100 >5 then 2 else 3 end   end  else D.DeptID end deptID1,A.CreatedTime as tglInput,A.Tgl as TglPeriksa,E.TglProduksi as TglProd,  D.DefCode,BP.PlantName as Line, PG.[Group],BF.FormulaCode as Jenis,   D.DefName,D.DeptID,B.ID,B.DefectID,B.MasterID,B.Qty,A.ID  DestID,isnull(A.TPotong,0)  QtyIn,B.Qty*I.Volume as Kubik,isnull(A.TPotong,0) as TotPotong,'' sfrom  from Def_DefectDetail B inner join Def_Defect A on A.Id=B.DefectID   left join Def_MasterDefect D on B.MasterID=D.ID left join BM_Destacking E on E.ID=A.DestID   left join BM_PlantGroup PG on A.GroupProdID=PG.ID left join BM_Formula BF on BF.ID=E.FormulaID    left join BM_Plant BP on BP.ID=E.PlantID left join FC_Items I on I.ID=E.ItemID inner join Def_GroupJemur GJ on GJ.ID=A.GroupJemurID  where B.RowStatus>-1  and D.RowStatus >-1) as Def    where DeptID1<>2 and CONVERT(varchar,TglPeriksa,112)>=@thnbln1 and CONVERT(varchar,TglPeriksa,112)<=@thnbln2)  " +

                        " select * into tempdefectFin from ( select 'OKKW' fin, sum(qtyout) lembar,sum(qtyout * kubik)kubik from ( select I1.PartNo partno1,I1.Panjang * I1.Lebar luas1,  S.qtyin,I2.PartNo partno2,I2.Panjang * I2.Lebar luas2,  S.qtyout ,(I2.Tebal * I2.Panjang * I2.Lebar)/1000000000 kubik from t3_simetris S inner join T3_Serah Se on S.SerahID =Se.ID inner join fc_items I1 on Se.ItemID=I1.ID inner join fc_items I2 on S.ItemID=I2.id  where I2.lebar>500 and S.RowStatus>-1 and CONVERT(varchar,S.tgltrans,112)>=@thnbln1 and CONVERT(varchar,S.tgltrans,112)<=@thnbln2 )a where partno1 like '%-1-%' and luas1>=luas2*2 and partno2 like '%-p-%' union all select 'BP' fin, sum(qtyout) lembar,sum(qtyout * kubik)kubik from ( select I1.PartNo partno1,I1.Panjang * I1.Lebar luas1,  S.qtyin,I2.PartNo partno2,I2.Panjang * I2.Lebar luas2,  S.qtyout ,(I2.Tebal * I2.Panjang * I2.Lebar)/1000000000 kubik from t3_simetris S inner join T3_Serah Se on S.SerahID =Se.ID inner join fc_items I1 on Se.ItemID=I1.ID inner join fc_items I2 on S.ItemID=I2.id  where I2.lebar>500 and S.RowStatus>-1 and CONVERT(varchar,S.tgltrans,112)>=@thnbln1 and CONVERT(varchar,S.tgltrans,112)<=@thnbln2  )a where partno1 like '%-1-%' and luas1>=luas2*2 and  (partno2 like '%-3-%' or partno2 like '%-w-%' or partno2 like '%-m-%') union all select 'BS' fin,sum(R.QtyIn) Lembar,sum(R.QtyIn *((I.tebal*I.panjang*I.lebar)/1000000000)) kubik from T3_Rekap R inner join FC_Items I on R.ItemID=I.id inner join fc_lokasi L on R.LokID =L.id where R.RowStatus>-1 and  CONVERT(varchar,R.tgltrans,112)>=@thnbln1 and CONVERT(varchar,R.tgltrans,112)<=@thnbln2 and I.PartNo like '%-s-%' and Process='direct')A  " +

                        " declare @TotalPotong decimal(18,2) " +
                        " declare @TotalDefKhusus decimal(18,2)  " +
                        " declare @DefKhusus decimal(18,2)  " +
                        " declare @Ttotalkw1kw2 decimal(18,2) " +
                        " declare @NCSortir decimal(18,2)  " +
                        " declare @Retur decimal(18,2)  " +
                        " set @TotalPotong=isnull((select sum(totkubik ) from tempdefectGPIsoTot),0)  " +

                        " if @TotalPotong >0  begin " +
                        " set @TotalDefKhusus=isnull((select sum(kubik) from tempdefectFin),0)  " +
                        " set @DefKhusus=isnull((select sum(kubik) from tempdefectFin where fin<>'bp'),0)  " +
                        " set @Ttotalkw1kw2 =isnull((select sum(qtyin *((I.tebal*I.Lebar*I.Panjang)/1000000000)) from T3_Rekap R inner join fc_items I on R.itemid=I.ID  where R.rowstatus>-1 and R.Process  like '%simetris%' and CONVERT(varchar,R.tgltrans,112)>=@thnbln1 and CONVERT(varchar,R.tgltrans,112)<=@thnbln2   and I.lebar=1200 and I.panjang=2400 and R.keterangan like '%-p-%' and (I.partno like '%-3-%' or I.partno like '%-W-%' or I.partno like '%-M-%' )),0) " +

                        " set @NCSortir=isnull((select sum(M3AkhirSS)+sum(M3AkhirSE) from (  SELECT B.tgltrans as Tanggal, I1.PartNo as PartnoAwal, sum(B.QtyIn) as QtyAwal,sum(I1.Volume*B.QtyIn) M3Awal,   I2.PartNo AS PartnoAkhir, case when B.NCSS>0 then sum(B.QtyOut) else 0 end QtyAkhirSS,  case when B.NCSS>0 then sum(I2.Volume*B.QtyOut) else 0 end M3AkhirSS,case when B.NCSE>0 then sum(B.QtyOut) else 0 end QtyAkhirSE,  case when B.NCSE>0 then sum(I2.Volume*B.QtyOut) else 0 end M3AkhirSE,B.NCSS,B.NCSE  FROM T3_Serah AS A   INNER JOIN T3_Simetris AS B ON A.ID = B.SerahID INNER JOIN FC_Items AS I1 ON A.ItemID = I1.ID INNER JOIN   FC_Items AS I2 ON B.ItemID = I2.ID LEFT JOIN T3_GroupM AS D ON B.GroupID = D.ID   where (B.NCSS>0 or B.NCSE>0) and B.rowstatus>-1 and CONVERT(varchar,B.tgltrans,112)>=@thnbln1 and CONVERT(varchar,B.tgltrans,112)<=@thnbln2   group by B.tgltrans,I1.PartNo,I2.PartNo,B.NCSS,B.NCSE) S),0) " +

                        " set @Retur=isnull((select cast(((TotK1-TotK2)+TotK3) as decimal(18,2)) TotM3 from ( " +
                        " select cast((sum(Volume*Tot1)) as decimal(18,2)) TotK1,cast((sum(Volume*Tot2)) as decimal(18,2)) TotK2,cast((sum(Volume*Tot3)) as decimal(18,2)) TotK3 from ( " +
                        " select tanggal,PartNo,volume ,sum(isnull(QtyC1,0))QtyC1,sum(isnull(QtyP1,0)) QtyP1,sum(isnull(QtyS1,0)) QtyS1,sum(isnull(Tot1,0)) Tot1,sum(isnull(TotK1,0)) TotK1, sum(isnull(QtyC2,0)) QtyC2,sum(isnull(QtyP2,0)) QtyP2,sum(isnull(QtyS2,0)) QtyS2,sum(isnull(Tot2,0)) Tot2, sum(isnull(TotK2,0)) TotK2,sum(isnull(QtyC3,0)) QtyC3,sum(isnull(QtyP3,0)) QtyP3,sum(isnull(QtyS3,0)) QtyS3,sum(isnull(Tot3,0)) Tot3,sum(isnull(TotK3,0)) TotK3 from ( select tanggal ,PartNo,volume,case when typeR=1 and ((KW='3' or KW='W')or lokasi='cl') then Qty end QtyC1,case when typeR=1 and (KW='P'and lokasi <> 'cl') then Qty end QtyP1, case when typeR=1 and (KW='S'and lokasi <> 'cl') then Qty end QtyS1, case when typeR=1 and ((KW='P' or KW='S') and lokasi <> 'cl') then Qty end Tot1, case when typeR=1 and (KW='P' or KW='S') then QtyK end TotK1, case when typeR=2 and ((KW='3' or KW='W')or lokasi='cl') then Qty end QtyC2, case when typeR=2 and (KW='P' and lokasi <> 'cl') then Qty end QtyP2, case when typeR=2 and (KW='S' and lokasi <> 'cl') then Qty end QtyS2, case when typeR=2 and ((KW='P' or KW='S') and lokasi <> 'cl') then Qty end Tot2, case when typeR=2 and ((KW='P' or KW='S') and lokasi <> 'cl') then QtyK end TotK2, case when typeR=3 and ((KW='3' or KW='W')or lokasi='cl') then Qty end QtyC3, case when typeR=3 and (KW='P' and lokasi <> 'cl') then Qty end QtyP3, case when typeR=3 and (KW='S' and lokasi <> 'cl') then Qty end QtyS3, case when typeR=3 and ((KW='P' or KW='S') and lokasi <> 'cl') then Qty   end Tot3, case when typeR=3 and ((KW='P' or KW='S') and lokasi <> 'cl') then QtyK end TotK3 from (     select R.TglTrans tanggal,I.PartNo,I.volume,SUBSTRING(I.partno,5,1) as KW,sum(R.Qty)Qty,     sum(((I.Panjang*I.Lebar)/(1220*2440) ) * R.Qty) QtyK,isnull(R.TypeR,1)  TypeR,I.ID,L.Lokasi     from T3_Retur R inner join FC_Items I on R.ItemID =I.ID  inner join FC_lokasi L on R.LokID=L.ID  where R.RowStatus>-1     group by R.TglTrans,I.PartNo,I.volume,R.TypeR,I.ID,L.Lokasi union all select R.TglTrans tanggal,I.PartNo,I.volume,SUBSTRING(I.partno,5,1) as KW,sum(R.Qty)Qty,    sum(((I.Panjang*I.Lebar)/(1220*2440) ) * R.Qty) QtyK,3  TypeR,I.ID,L.Lokasi     from T3_ReturO R inner join FC_Items I on R.ItemID =I.ID  inner join FC_lokasi L on R.LokID=L.ID  where R.RowStatus>-1     group by R.TglTrans,I.PartNo,I.volume,I.ID,L.Lokasi ) as A ) as B where convert(char,tanggal,112)>=@thnbln1 and convert(char,tanggal,112)<=@thnbln2 group by tanggal,PartNo,volume ) as x ) as x1),0) " +

                        " /** 15. Detail OK KM **/ " +
                        " select [Group],cast(((M3/@TtlDfctSystemBM_M3)*@Ttotalkw1kw2) as decimal(18,1)) M3 into tempOKKM_m3 from detailDfctSystemBM_M3  " +
                        " select [Group], (M3/(select sum(M3) from detailDfctSystemBM_M3))*(select sum(M3) from tempOKKM_m3)M3 into tempOKKM from detailDfctSystemBM_M3 " +

                        " /** 16. Detail Retur **/  " +
                        " select [Group],cast(((M3/@TtlDfctSystemBM_M3)*@Retur) as decimal(18,2)) M3 into tempRetur_m3 from detailDfctSystemBM_M3 order by [group]  ; " +

                        " /** 17. Detail Sortir **/   " +
                        " with Sortir as (select [Group],cast(((M3/@TtlDfctSystemBM_M3)*@NCSortir) as decimal(18,2)) M3 from detailDfctSystemBM_M3 ), " +
                        " Sortir01 as (select [Group],cast((M3) as decimal(18,2))M3 from (  select [Group],cast((M3) as decimal(18,2))M3 from (  select * from Sortir ) as x ) as x1 ) " +

                        " select * into tempSortir_1_m3 from Sortir01 " +

                        " /** 18. Total Defect **/  " +
                        " select sum(M3)M3,[Group] into DtlTotalDefect from ( " +
                        " select cast(M3 as decimal(18,2))M3,[Group] from tempDetailTotalDefect_P  " +
                        " union all " +
                        " select M3,[Group] from tempRetur_m3 " +
                        " union all " +
                        " select M3,[Group] from tempSortir_1_m3 " +
                        " union all " +
                        " select M3 * -1,[Group] from tempOKKM_m3 ) as x group by [Group] " +
                        #endregion

                        #region Line - 1
 " declare @TotalPotongL1 decimal(18,2) " +
                        " declare @TotDefKhususL1 decimal(18,2)  " +
                        " declare @DefKhususL1 decimal(18,2)  " +
                        " declare @Ttotalkw1kw2L1 decimal(18,2)  " +
                        " declare @NCSortirL1 decimal(18,2)  " +
                        " declare @ReturL1 decimal(18,2)  " +
                        " declare @DefectFinL1 decimal(18,2) " +

                        " set @TotalPotongL1=(select isnull(sum(totkubik ),0) from tempdefectGPIsoTot where [group]in (select [group] from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 1'))) " +
                        " set @TotDefKhususL1=(@TotalPotongL1/@TotalPotong)*@TotalDefKhusus " +
                        " set @DefKhususL1=(@TotalPotongL1/@TotalPotong)*@DefKhusus " +
                        " set @Ttotalkw1kw2L1=(@TotalPotongL1/@TotalPotong)*@Ttotalkw1kw2 " +
                        " set @NCSortirL1=(@TotalPotongL1/@TotalPotong)*@NCSortir " +
                        " set @ReturL1=(@TotalPotongL1/@TotalPotong)*@Retur " +
                        " set @DefectFinL1=isnull((@TotalPotongL1/@TotalPotong)*@DefectFin,0) " +

                        " if @TotalPotongL1>0 " +
                        " begin " +
                        " select [Group],cast((b) as decimal(18,2))b,cast((c) as decimal(18,2))c,cast((d) as decimal(18,2))d,cast((e) as decimal(18,2))e,cast((f) as decimal(18,2))f,cast((g) as decimal(18,2))g,cast((i) as decimal(18,2))i,j into tempdefectL1 from ( " +
                        " select *,case when b>0 then cast((((c-d+e+f)/b)*100) as decimal(18,2)) else 0  end j from ( " +
                        " select [Group], " +
                        " case when @TotalPotongL1>0 then isnull((select cast((M3) as decimal(18,2))M3 from DtlTotalPotongProposionet where [group]=BM_PlantGroup.[Group] ),0)  else 0 end b, " +
                        " case when @TotalPotongL1>0 then isnull((select cast((M3) as decimal(18,2))M3 from tempDefectProduksi where [group]=BM_PlantGroup.[Group] ),0)  else 0 end c, " +
                        " case when @TotalPotongL1>0 then ((isnull((select cast((M3) as decimal(18,2))M3 from tempOKKM where [group]=BM_PlantGroup.[Group] ),0))) else 0 end  d,  " +
                        " case when @TotalPotongL1>0 then ((isnull((select cast((M3) as decimal(18,2))M3 from tempSortir_1_m3 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  e, " +
                        " case when @TotalPotongL1>0 then ((isnull((select cast((M3) as decimal(18,2))M3 from tempRetur_m3 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  f, " +
                        " case when @TotalPotongL1>0 then ((isnull((select cast((M3) as decimal(18,2))M3 from tempDetailBSTahap1 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end g,  " +
                        " case when @TotalPotongL1>0 then ((isnull((select cast((M3) as decimal(18,2))M3 from DtlTotalDefect where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end i " +
                        " from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 1') )A " +

                        " union all  " +

                        " select 'Total' [Group],sum(b)b,sum(c)c,sum(d)d,sum(e)e,sum(f)f,sum(g)g,sum(i) i" +
                        //" ,case when sum(b)>0 then cast((sum(c)-sum(d)+sum(e)+sum(f))/sum(b)*100 as decimal(18,1)) else 0 end j from( " +
                        " " + logika3 + " " +
                        " select [Group], " +
                        " case when @TotalPotongL1>0 then isnull((select cast((M3) as decimal(18,2))M3 from DtlTotalPotongProposionet where [group]=BM_PlantGroup.[Group] ),0)  else 0 end b,  " +
                        " case when @TotalPotongL1>0 then isnull((select cast((M3) as decimal(18,2))M3 from tempDefectProduksi where [group]=BM_PlantGroup.[Group] ),0)  else 0 end c,  " +
                        " case when @TotalPotongL1>0 then ((isnull((select cast((M3) as decimal(18,2))M3 from tempOKKM where [group]=BM_PlantGroup.[Group] ),0))) else 0 end  d, " +
                        " case when @TotalPotongL1>0 then ((isnull((select cast((M3) as decimal(18,2))M3 from tempSortir_1_m3 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  e,  " +
                        " case when @TotalPotongL1>0 then ((isnull((select cast((M3) as decimal(18,2))M3 from tempRetur_m3 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  f,  " +
                        " case when @TotalPotongL1>0 then ((isnull((select cast((M3) as decimal(18,2))M3 from tempDetailBSTahap1 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end g,  " +
                        " case when @TotalPotongL1>0 then ((isnull((select cast((M3) as decimal(18,2))M3 from DtlTotalDefect where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end i, " +
                        " 0 j from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 1'))A )B " +
                        " end " +
                        " else " +
                        " begin " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 i, 0 j into tempdefectL1 " +
                        " end " +
                        #endregion
 " " +
                        #region Line - 2
 " declare @TotalPotongL2 decimal(18,2) " +
                        " declare @TotDefKhususL2 decimal(18,2) " +
                        " declare @DefKhususL2 decimal(18,2) " +
                        " declare @Ttotalkw1kw2L2 decimal(18,2) " +
                        " declare @NCSortirL2 decimal(18,2) " +
                        " declare @ReturL2 decimal(18,2) " +
                        " declare @DefectFinL2 decimal(18,2) " +

                        " set @TotalPotongL2=(select isnull(sum(totkubik ),0) from tempdefectGPIsoTot where [group]in (select [group] from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 2'))) " +
                        " set @TotDefKhususL2=(@TotalPotongL2/@TotalPotong)*@TotalDefKhusus " +
                        " set @DefKhususL2=(@TotalPotongL2/@TotalPotong)*@DefKhusus " +
                        " set @Ttotalkw1kw2L2=(@TotalPotongL2/@TotalPotong)*@Ttotalkw1kw2 " +
                        " set @NCSortirL2=(@TotalPotongL2/@TotalPotong)*@NCSortir " +
                        " set @ReturL2=(@TotalPotongL2/@TotalPotong)*@Retur " +
                        " set @DefectFinL2=isnull((@TotalPotongL2/@TotalPotong)*@DefectFin,0) " +

                        " if @TotalPotongL2>0 " +
                        " begin " +
                        " select [Group],cast((b) as decimal(18,1))b,cast((c) as decimal(18,1))c,cast((d) as decimal(18,1))d,cast((e) as decimal(18,1))e,cast((f) as decimal(18,1))f,cast((g) as decimal(18,1))g,cast((i) as decimal(18,1))i,j into tempdefectL2 from ( " +
                        " select *,case when b>0 then cast((((c-d+e+f)/b)*100) as decimal(18,1))  else 0  end j from ( " +
                        " select [Group], " +
                        " case when @TotalPotongL2>0 then isnull((select cast((M3) as decimal(18,2))M3 from DtlTotalPotongProposionet where [group]=BM_PlantGroup.[Group] ),0)  else 0 end b,  " +
                        " case when @TotalPotongL2>0 then isnull((select cast((M3) as decimal(18,2))M3 from tempDefectProduksi where [group]=BM_PlantGroup.[Group] ),0)  else 0 end c,  " +
                        " case when @TotalPotongL2>0 then ((isnull((select cast((M3) as decimal(18,2))M3 from tempOKKM where [group]=BM_PlantGroup.[Group] ),0))) else 0 end  d, " +
                        " case when @TotalPotongL2>0 then ((isnull((select cast((M3) as decimal(18,2))M3 from tempSortir_1_m3 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  e,  " +
                        " case when @TotalPotongL2>0 then ((isnull((select cast((M3) as decimal(18,2))M3 from tempRetur_m3 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  f,  " +
                        " case when @TotalPotongL2>0 then ((isnull((select cast((M3) as decimal(18,2))M3 from tempDetailBSTahap1 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end g , " +
                        " case when @TotalPotongL2>0 then ((isnull((select cast((M3) as decimal(18,2))M3 from DtlTotalDefect where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end i " +
                        " from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 2') )A " +

                        " union all  " +

                        " select 'Total' [Group],sum(b)b,sum(c)c,sum(d)d,sum(e)e,sum(f)f,sum(g)g,sum(i) i " +
                         //" ,case when sum(b)>0 then cast((sum(c)-sum(d)+sum(e)+sum(f))/sum(b)*100 as decimal(18,1)) else 0 end j from( "+

                         " " + logika3 + " " +
                         " select [Group], " +
                        " case when @TotalPotongL2>0 then isnull((select cast((M3) as decimal(18,2))M3 from DtlTotalPotongProposionet where [group]=BM_PlantGroup.[Group] ),0)  else 0 end b,  " +
                        " case when @TotalPotongL2>0 then isnull((select cast((M3) as decimal(18,2))M3 from tempDefectProduksi where [group]=BM_PlantGroup.[Group] ),0)  else 0 end c,  " +
                        " case when @TotalPotongL2>0 then ((isnull((select cast((M3) as decimal(18,2))M3 from tempOKKM where [group]=BM_PlantGroup.[Group] ),0))) else 0 end  d, " +
                        " case when @TotalPotongL2>0 then ((isnull((select cast((M3) as decimal(18,2))M3 from tempSortir_1_m3 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  e,  " +
                        " case when @TotalPotongL2>0 then ((isnull((select cast((M3) as decimal(18,2))M3 from tempRetur_m3 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  f,  " +
                        " case when @TotalPotongL2>0 then ((isnull((select cast((M3) as decimal(18,2))M3 from tempDetailBSTahap1 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end g,  " +
                        " case when @TotalPotongL2>0 then ((isnull((select cast((M3) as decimal(18,2))M3 from DtlTotalDefect where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end i, " +
                        " 0 j from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 2'))A )B " +
                        " end " +
                        " else " +
                        " begin " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 i, 0 j into tempdefectL2 " +
                        " end " +
                        #endregion
 " " +
                        #region Lin3 - 3
 " declare @TotalPotongL3 decimal(18,2) " +
                        " declare @TotDefKhususL3 decimal(18,2) " +
                        " declare @DefKhususL3 decimal(18,2) " +
                        " declare @Ttotalkw1kw2L3 decimal(18,2) " +
                        " declare @NCSortirL3 decimal(18,2) " +
                        " declare @ReturL3 decimal(18,2) " +
                        " declare @DefectFinL3 decimal(18,2) " +

                        " set @TotalPotongL3=(select isnull(sum(totkubik ),0) from tempdefectGPIsoTot where [group]in (select [group] from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 3'))) " +
                        " set @TotDefKhususL3=(@TotalPotongL3/@TotalPotong)*@TotalDefKhusus " +
                        " set @DefKhususL3=(@TotalPotongL3/@TotalPotong)*@DefKhusus " +
                        " set @Ttotalkw1kw2L3=(@TotalPotongL3/@TotalPotong)*@Ttotalkw1kw2 " +
                        " set @NCSortirL3=(@TotalPotongL3/@TotalPotong)*@NCSortir " +
                        " set @ReturL3=(@TotalPotongL3/@TotalPotong)*@Retur " +
                        " set @DefectFinL3=isnull((@TotalPotongL3/@TotalPotong)*@DefectFin,0) " +

                        " if @TotalPotongL3>0 " +
                        " begin " +
                        " select [Group],cast((b) as decimal(18,1))b,cast((c) as decimal(18,1))c,cast((d) as decimal(18,1))d,cast((e) as decimal(18,1))e,cast((f) as decimal(18,1))f,cast((g) as decimal(18,1))g,cast((i) as decimal(18,1))i,j into tempdefectL3 from ( " +
                        " select *,case when b>0 then cast((((c-d+e+f)/b)*100) as decimal(18,1))  else 0  end j from ( select [Group], " +
                        " case when @TotalPotongL3>0 then isnull((select cast((M3) as decimal(18,2))M3 from DtlTotalPotongProposionet where [group]=BM_PlantGroup.[Group] ),0)  else 0 end b,  " +
                        " case when @TotalPotongL3>0 then isnull((select cast((M3) as decimal(18,2))M3 from tempDefectProduksi where [group]=BM_PlantGroup.[Group] ),0)  else 0 end c,  " +
                        " case when @TotalPotongL3>0 then ((isnull((select cast((M3) as decimal(18,2))M3 from tempOKKM where [group]=BM_PlantGroup.[Group] ),0))) else 0 end  d, " +
                        " case when @TotalPotongL3>0 then ((isnull((select cast((M3) as decimal(18,2))M3 from tempSortir_1_m3 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  e,  " +
                        " case when @TotalPotongL3>0 then ((isnull((select cast((M3) as decimal(18,2))M3 from tempRetur_m3 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  f,  " +
                        " case when @TotalPotongL3>0 then ((isnull((select cast((M3) as decimal(18,2))M3 from tempDetailBSTahap1 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end g,  " +
                        " case when @TotalPotongL3>0 then ((isnull((select cast((M3) as decimal(18,2))M3 from DtlTotalDefect where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end i " +
                        "  from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 3') )A " +

                        " union all  " +

                        " select 'Total' [Group],sum(b)b,sum(c)c,sum(d)d,sum(e)e,sum(f)f,sum(g)g,sum(i) i " +
                        //" ,case when sum(b)>0 then cast((sum(c)-sum(d)+sum(e)+sum(f))/sum(b)*100 as decimal(18,1))  else 0 end j from( select [Group], " +

                        " " + logika3 + " " +
                        " select [Group], " +
                        " case when @TotalPotongL3>0 then isnull((select cast((M3) as decimal(18,2))M3 from DtlTotalPotongProposionet where [group]=BM_PlantGroup.[Group] ),0)  else 0 end b,  " +
                        " case when @TotalPotongL3>0 then isnull((select cast((M3) as decimal(18,2))M3 from tempDefectProduksi where [group]=BM_PlantGroup.[Group] ),0)  else 0 end c,  " +
                        " case when @TotalPotongL3>0 then ((isnull((select cast((M3) as decimal(18,2))M3 from tempOKKM where [group]=BM_PlantGroup.[Group] ),0))) else 0 end  d, " +
                        " case when @TotalPotongL3>0 then ((isnull((select cast((M3) as decimal(18,2))M33 from tempSortir_1_m3 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  e,  " +
                        " case when @TotalPotongL3>0 then ((isnull((select cast((M3) as decimal(18,2))M3 from tempRetur_m3 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  f,  " +
                        " case when @TotalPotongL3>0 then ((isnull((select cast((M3) as decimal(18,2))M3 from tempDetailBSTahap1 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end g,  " +
                        " case when @TotalPotongL3>0 then ((isnull((select cast((M3) as decimal(18,2))M3 from DtlTotalDefect where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end i, " +
                        " 0 j from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 3'))A )B " +
                        " end " +
                        " else " +
                        " begin " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 i, 0 j into tempdefectL3 " +
                        " end " +
                        #endregion
 " " +
                        #region Line - 4
 " declare @TotalPotongL4 decimal(18,2) " +
                        " declare @TotDefKhususL4 decimal(18,2) " +
                        " declare @DefKhususL4 decimal(18,2) " +
                        " declare @Ttotalkw1kw2L4 decimal(18,2) " +
                        " declare @NCSortirL4 decimal(18,2) " +
                        " declare @ReturL4 decimal(18,2) " +
                        " declare @DefectFinL4 decimal(18,2) " +

                        " set @TotalPotongL4=(select isnull(sum(totkubik ),0) from tempdefectGPIsoTot where [group]in (select [group] from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 4'))) " +
                        " set @TotDefKhususL4=(@TotalPotongL4/@TotalPotong)*@TotalDefKhusus " +
                        " set @DefKhususL4=(@TotalPotongL4/@TotalPotong)*@DefKhusus " +
                        " set @Ttotalkw1kw2L4=(@TotalPotongL4/@TotalPotong)*@Ttotalkw1kw2 " +
                        " set @NCSortirL4=(@TotalPotongL4/@TotalPotong)*@NCSortir " +
                        " set @ReturL4=(@TotalPotongL4/@TotalPotong)*@Retur " +
                        " set @DefectFinL4=isnull((@TotalPotongL4/@TotalPotong)*@DefectFin,0) " +

                        " if @TotalPotongL4>0 " +
                        " begin " +
                        " select [Group],cast((b) as decimal(18,1))b,cast((c) as decimal(18,1))c,cast((d) as decimal(18,1))d,cast((e) as decimal(18,1))e,cast((f) as decimal(18,1))f,cast((g) as decimal(18,1))g,cast((i) as decimal(18,1))i,j into tempdefectL4 from ( " +
                        " select *,case when b>0 then cast((((c-d+e+f)/b)*100) as decimal(18,1)) else 0  end j from ( " +
                        " select [Group], " +
                        " case when @TotalPotongL4>0 then isnull((select cast((M3) as decimal(18,2))M3 from DtlTotalPotongProposionet where [group]=BM_PlantGroup.[Group] ),0)  else 0 end b,  " +
                        " case when @TotalPotongL4>0 then isnull((select cast((M3) as decimal(18,2))M3 from tempDefectProduksi where [group]=BM_PlantGroup.[Group] ),0)  else 0 end c,  " +
                        " case when @TotalPotongL4>0 then ((isnull((select cast((M3) as decimal(18,2))M3 from tempOKKM where [group]=BM_PlantGroup.[Group] ),0))) else 0 end  d, " +
                        " case when @TotalPotongL4>0 then ((isnull((select cast((M3) as decimal(18,2))M33 from tempSortir_1_m3 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  e,  " +
                        " case when @TotalPotongL4>0 then ((isnull((select cast((M3) as decimal(18,2))M3 from tempRetur_m3 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  f,  " +
                        " case when @TotalPotongL4>0 then ((isnull((select cast((M3) as decimal(18,2))M3 from tempDetailBSTahap1 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end g,  " +
                        " case when @TotalPotongL4>0 then ((isnull((select cast((M3) as decimal(18,2))M3 from DtlTotalDefect where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end i " +
                        " from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 4') )A " +

                        " union all  " +

                        " select 'Total' [Group],sum(b)b,sum(c)c,sum(d)d,sum(e)e,sum(f)f,sum(g)g,sum(i) i" +
                        // " ,case when sum(b)>0 then cast((sum(c)-sum(d)+sum(e)+sum(f))/sum(b)*100 as decimal(18,1)) else 0 end j from( " +

                        " " + logika3 + " " +

                        " select [Group], " +
                        " ((isnull((select cast((M3) as decimal(18,2))M3 from DtlTotalPotongProposionet where [group]=BM_PlantGroup.[Group] ),0))) b, " +
                        " isnull((select cast((M3) as decimal(18,2))M3 from tempDefectProduksi where [group]=BM_PlantGroup.[Group] ),0)c, " +
                        " ((isnull((select cast((M3) as decimal(18,2))M3 from tempOKKM where [group]=BM_PlantGroup.[Group] ),0))) d, " +
                        " ((isnull((select cast((M3) as decimal(18,2))M3 from tempSortir_1_m3 where [group]=BM_PlantGroup.[Group] ),0))) e, " +
                        " ((isnull((select cast((M3) as decimal(18,2))M33 from tempRetur_m3 where [group]=BM_PlantGroup.[Group] ),0))) f, " +
                        " ((isnull((select cast((M3) as decimal(18,2))M3 from tempDetailBSTahap1 where [group]=BM_PlantGroup.[Group] ),0))) g, " +
                        " ((isnull((select cast((M3) as decimal(18,2))M3 from DtlTotalDefect where [group]=BM_PlantGroup.[Group] ),0))) i, " +
                        " 0 j from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 4'))A )B " +
                        " end " +
                        " else " +
                        " begin " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 i, 0 j into tempdefectL4 " +
                        " end " +
                        #endregion
 " " +
                        #region Line - 5
 " declare @TotalPotongL5 decimal(18,2) " +
                        " declare @TotDefKhususL5 decimal(18,2) " +
                        " declare @DefKhususL5 decimal(18,2) " +
                        " declare @Ttotalkw1kw2L5 decimal(18,2) " +
                        " declare @NCSortirL5 decimal(18,2) " +
                        " declare @ReturL5 decimal(18,2) " +
                        " declare @DefectFinL5 decimal(18,2) " +

                        " set @TotalPotongL5=(select isnull(sum(totkubik ),0) from tempdefectGPIsoTot where [group]in (select [group] from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 5'))) " +
                        " set @TotDefKhususL5=(@TotalPotongL5/@TotalPotong)*@TotalDefKhusus " +
                        " set @DefKhususL5=(@TotalPotongL5/@TotalPotong)*@DefKhusus " +
                        " set @Ttotalkw1kw2L5=(@TotalPotongL5/@TotalPotong)*@Ttotalkw1kw2 " +
                        " set @NCSortirL5=(@TotalPotongL5/@TotalPotong)*@NCSortir " +
                        " set @ReturL5=(@TotalPotongL5/@TotalPotong)*@Retur " +
                        " set @DefectFinL5=isnull((@TotalPotongL5/@TotalPotong)*@DefectFin,0) " +

                        " if @TotalPotongL5>0 " +
                        " begin " +
                        " select [Group],cast((b) as decimal(18,1))b,cast((c) as decimal(18,1))c,cast((d) as decimal(18,1))d,cast((e) as decimal(18,1))e,cast((f) as decimal(18,1))f,cast((g) as decimal(18,1))g,cast((i) as decimal(18,1))i,j into tempdefectL5 from ( " +
                        " select *,case when b>0 then cast(((c-d+e+f)/b)*100 as decimal(18,1)) else 0  end j from ( " +
                        " select [Group], " +
                        " case when @TotalPotongL5>0 then isnull((select cast((M3) as decimal(18,2))M3 from DtlTotalPotongProposionet where [group]=BM_PlantGroup.[Group] ),0)  else 0 end b,  " +
                        " case when @TotalPotongL5>0 then isnull((select cast((M3) as decimal(18,2))M3 from tempDefectProduksi where [group]=BM_PlantGroup.[Group] ),0)  else 0 end c,  " +
                        " case when @TotalPotongL5>0 then ((isnull((select cast((M3) as decimal(18,2))M3 from tempOKKM where [group]=BM_PlantGroup.[Group] ),0))) else 0 end  d, " +
                        " case when @TotalPotongL5>0 then ((isnull((select cast((M3) as decimal(18,2))M3 from tempSortir_1_m3 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  e,  " +
                        " case when @TotalPotongL5>0 then ((isnull((select cast((M3) as decimal(18,2))M3 from tempRetur_m3 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  f,  " +
                        " case when @TotalPotongL5>0 then ((isnull((select cast((M3) as decimal(18,2))M3 from tempDetailBSTahap1 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end g,  " +
                        " case when @TotalPotongL5>0 then ((isnull((select cast((M3) as decimal(18,2))M3 from DtlTotalDefect where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end i " +
                        " from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 5') )A " +

                        "union all  " +

                        " select 'Total' [Group],sum(b)b,sum(c)c,sum(d)d,sum(e)e,sum(f)f,sum(g)g,sum(i) i " +
                        // " ,case when sum(b)>0 then cast((sum(c)-sum(d)+sum(e)+sum(f))/sum(b)*100 as decimal(18,1)) else 0 end j from( " +

                        " " + logika3 + " " +

                       " select [Group], " +
                        " ((isnull((select cast((M3) as decimal(18,2))M3 from DtlTotalPotongProposionet where [group]=BM_PlantGroup.[Group] ),0))) b, " +
                        " isnull((select cast((M3) as decimal(18,2))M3 from tempDefectProduksi where [group]=BM_PlantGroup.[Group] ),0)c, " +
                        " ((isnull((select cast((M3) as decimal(18,2))M3 from tempOKKM where [group]=BM_PlantGroup.[Group] ),0))) d, " +
                        " ((isnull((select cast((M3) as decimal(18,2))M3 from tempSortir_1_m3 where [group]=BM_PlantGroup.[Group] ),0))) e, " +
                        " ((isnull((select cast((M3) as decimal(18,2))M3 from tempRetur_m3 where [group]=BM_PlantGroup.[Group] ),0))) f, " +
                        " ((isnull((select cast((M3) as decimal(18,2))M3 from tempDetailBSTahap1 where [group]=BM_PlantGroup.[Group] ),0))) g, " +
                        " ((isnull((select cast((M3) as decimal(18,2))M3 from DtlTotalDefect where [group]=BM_PlantGroup.[Group] ),0))) i, " +
                        " 0 j from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 5'))A )B " +
                        " end " +
                        " else " +
                        " begin " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 i, 0 j into tempdefectL5 " +
                        " end " +
                        #endregion
 " " +
                        #region Line - 6
 " declare @TotalPotongL6 decimal(18,2) " +
                        " declare @TotDefKhususL6 decimal(18,2) " +
                        " declare @DefKhususL6 decimal(18,2) " +
                        " declare @Ttotalkw1kw2L6 decimal(18,2) " +
                        " declare @NCSortirL6 decimal(18,2) " +
                        " declare @ReturL6 decimal(18,2) " +
                        " declare @DefectFinL6 decimal(18,2) " +

                        " set @TotalPotongL6=(select isnull(sum(totkubik ),0) from tempdefectGPIsoTot where [group]in (select [group] from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 6'))) " +
                        " set @TotDefKhususL6=(@TotalPotongL6/@TotalPotong)*@TotalDefKhusus " +
                        " set @DefKhususL6=(@TotalPotongL6/@TotalPotong)*@DefKhusus " +
                        " set @Ttotalkw1kw2L6=(@TotalPotongL6/@TotalPotong)*@Ttotalkw1kw2 " +
                        " set @NCSortirL6=(@TotalPotongL6/@TotalPotong)*@NCSortir " +
                        " set @ReturL6=(@TotalPotongL6/@TotalPotong)*@Retur " +
                        " set @DefectFinL6=isnull((@TotalPotongL6/@TotalPotong)*@DefectFin,0) " +

                        " if @TotalPotongL6>0 " +
                        " begin " +
                        " select [Group],cast((b) as decimal(18,1))b,cast((c) as decimal(18,1))c,cast((d) as decimal(18,1))d,cast((e) as decimal(18,1))e,cast((f) as decimal(18,1))f,cast((g) as decimal(18,1))g,cast((i) as decimal(18,1))i,j into tempdefectL6 from ( " +
                        " select *,case when b>0 then cast((((c-d+e+f)/b)*100) as decimal(18,1)) else 0  end j from ( " +
                        " select [Group], " +
                        " case when @TotalPotongL6>0 then isnull((select cast((M3) as decimal(18,2))M3 from DtlTotalPotongProposionet where [group]=BM_PlantGroup.[Group] ),0)  else 0 end b,  " +
                        " case when @TotalPotongL6>0 then isnull((select cast((M3) as decimal(18,2))M3 from tempDefectProduksi where [group]=BM_PlantGroup.[Group] ),0)  else 0 end c,  " +
                        " case when @TotalPotongL6>0 then ((isnull((select cast((M3) as decimal(18,2))M3 from tempOKKM where [group]=BM_PlantGroup.[Group] ),0))) else 0 end  d, " +
                        " case when @TotalPotongL6>0 then ((isnull((select cast((M3) as decimal(18,2))M3 from tempSortir_1_m3 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  e,  " +
                        " case when @TotalPotongL6>0 then ((isnull((select cast((M3) as decimal(18,2))M3 from tempRetur_m3 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  f,  " +
                        " case when @TotalPotongL6>0 then ((isnull((select cast((M3) as decimal(18,2))M3 from tempDetailBSTahap1 where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end g,  " +
                        " case when @TotalPotongL6>0 then ((isnull((select cast((M3) as decimal(18,2))M3 from DtlTotalDefect where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end i " +
                        " from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 6') )A " +

                        "union all  " +

                        " select 'Total' [Group],sum(b)b,sum(c)c,sum(d)d,sum(e)e,sum(f)f,sum(g)g,sum(i) i" +
                        //" ,case when sum(b)>0 then cast((sum(c)-sum(d)+sum(e)+sum(f))/sum(b)*100 as decimal(18,1)) else 0 end j from( " +

                        " " + logika3 + " " +

                        " select [Group], " +
                        " ((isnull((select cast((M3) as decimal(18,2))M3 from DtlTotalPotongProposionet where [group]=BM_PlantGroup.[Group] ),0))) b, " +
                        " isnull((select cast((M3) as decimal(18,2))M3 from tempDefectProduksi where [group]=BM_PlantGroup.[Group] ),0)c, " +
                        " ((isnull((select cast((M3) as decimal(18,2))M3 from tempOKKM where [group]=BM_PlantGroup.[Group] ),0))) d, " +
                        " ((isnull((select cast((M3) as decimal(18,2))M3 from tempSortir_1_m3 where [group]=BM_PlantGroup.[Group] ),0))) e, " +
                        " ((isnull((select cast((M3) as decimal(18,2))M3 from tempRetur_m3 where [group]=BM_PlantGroup.[Group] ),0))) f, " +
                        " ((isnull((select cast((M3) as decimal(18,2))M3 from tempDetailBSTahap1 where [group]=BM_PlantGroup.[Group] ),0))) g, " +
                        " ((isnull((select cast((M3) as decimal(18,2))M3 from DtlTotalDefect where [group]=BM_PlantGroup.[Group] ),0))) i, " +
                        " 0 j from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 6'))A )B " +
                        " end " +
                        #endregion

     " else " +
                        " begin " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 i, 0 j into tempdefectL6 " +
                        " end " +
                        " " +
                        " end " +
                        " else " +
                        " begin " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 i, 0 j into tempdefectL1 " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 i, 0 j into tempdefectL2 " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 i, 0 j into tempdefectL3 " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 i, 0 j into tempdefectL4 " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 i, 0 j into tempdefectL5 " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 i, 0 j into tempdefectL6 " +
                        " end " +
                        " select [group],cast((b) as decimal(18,2))b,cast((c) as decimal(18,2))c,cast((d) as decimal(18,2))d,cast((e) as decimal(18,2))e,cast((f) as decimal(18,2))f,case when [group]<>'total' then cast((g) as decimal(18,2)) when [group]='total' then cast((g) as decimal(18,2)) end g,i,j from tempdefectL1 " +

                        " select GP,i NilaiDefect,b NilaiSerah,'" + DateTime.Parse(txtdrtanggal.Text).ToString("yyyyMM") + "'Periode  into tempDataSarmut_Defect from " +
                        " ( " +
                        " select case when [Group]='Total' then 'Total_L1' else [Group] end GP,b,i from tempdefectL1 union all " +
                        " select case when [Group]='Total' then 'Total_L2' else [Group] end GP,b,i from tempdefectL2 union all  " +
                        " select case when [Group]='Total' then 'Total_L3' else [Group] end GP,b,i from tempdefectL3 union all  " +
                        " select case when [Group]='Total' then 'Total_L4' else [Group] end GP,b,i from tempdefectL4 union all " +
                        " select case when [Group]='Total' then 'Total_L5' else [Group] end GP,b,i from tempdefectL5 union all " +
                        " select case when [Group]='Total' then 'Total_L6' else [Group] end GP,b,i from tempdefectL6   " +
                        " )A  where GP<>'' ";

                    }
                    #endregion
                    #region Baru > Mei 2021
                    else if (Convert.ToInt32(strtgl1.Substring(0, 6)) > 202105 && users.UnitKerjaID.ToString() == "1" ||
                             Convert.ToInt32(strtgl1.Substring(0, 6)) > 202107 && users.UnitKerjaID.ToString() == "13" ||
                             Convert.ToInt32(strtgl1.Substring(0, 6)) < 202107 && users.UnitKerjaID.ToString() == "7")
                    {
                        strSQL =
                        #region Temp Table
 " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempData_Group]') AND type in (N'U')) DROP TABLE [dbo].[tempData_Group] " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDefect_BM]') AND type in (N'U')) DROP TABLE [dbo].[tempDefect_BM] " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDefect_Fin]') AND type in (N'U')) DROP TABLE [dbo].[tempDefect_Fin] " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDefect_Fin0]') AND type in (N'U')) DROP TABLE [dbo].[tempDefect_Fin0] " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDefect_BM_detail0]') AND type in (N'U')) DROP TABLE [dbo].[tempDefect_BM_detail0] " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDefect_BM_detail]') AND type in (N'U')) DROP TABLE [dbo].[tempDefect_BM_detail] " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDefect_Fin_detail]') AND type in (N'U')) DROP TABLE [dbo].[tempDefect_Fin_detail] " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDefect_Fin_detail0]') AND type in (N'U')) DROP TABLE [dbo].[tempDefect_Fin_detail0] " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Selisih_ttl_defect_Detail]') AND type in (N'U')) DROP TABLE [dbo].[Selisih_ttl_defect_Detail] " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDefect_BM_FN_detail]') AND type in (N'U')) DROP TABLE [dbo].[tempDefect_BM_FN_detail] " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDefect_UkuranKhusus_detail]') AND type in (N'U')) DROP TABLE [dbo].[tempDefect_UkuranKhusus_detail] " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDefect_ListPlank_detail]') AND type in (N'U')) DROP TABLE [dbo].[tempDefect_ListPlank_detail] " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDefect_Produksi_detail]') AND type in (N'U')) DROP TABLE [dbo].[tempDefect_Produksi_detail] " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempMasterDataBSauto]') AND type in (N'U')) DROP TABLE [dbo].[tempMasterDataBSauto]  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempBS_Tahap1]') AND type in (N'U')) DROP TABLE [dbo].[tempBS_Tahap1]  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempBS_Tahap1_detail]') AND type in (N'U')) DROP TABLE [dbo].[tempBS_Tahap1_detail] " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTotalDefect_detail]') AND type in (N'U')) DROP TABLE [dbo].[tempTotalDefect_detail]  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTotalDefect_Pro_detail]') AND type in (N'U')) DROP TABLE [dbo].[tempTotalDefect_Pro_detail] " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTotalPot_QA]') AND type in (N'U')) DROP TABLE [dbo].[tempTotalPot_QA]  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDefect_Master_ListPlank]') AND type in (N'U')) DROP TABLE [dbo].[tempDefect_Master_ListPlank] " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTtlBP_LP]') AND type in (N'U')) DROP TABLE [dbo].[tempTtlBP_LP]  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTtlOK_LP]') AND type in (N'U')) DROP TABLE [dbo].[tempTtlOK_LP]  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTtl_LP]') AND type in (N'U')) DROP TABLE [dbo].[tempTtl_LP]  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTotalPotong_BP_LP]') AND type in (N'U')) DROP TABLE [dbo].[tempTotalPotong_BP_LP] " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTotalPotong_LP]') AND type in (N'U')) DROP TABLE [dbo].[tempTotalPotong_LP]  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTotalPotong_UkuranKhusus]') AND type in (N'U')) DROP TABLE [dbo].[tempTotalPotong_UkuranKhusus] " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempGroup]') AND type in (N'U')) DROP TABLE [dbo].[tempGroup]  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempGroup2]') AND type in (N'U')) DROP TABLE [dbo].[tempGroup2]  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempGroup3]') AND type in (N'U')) DROP TABLE [dbo].[tempGroup3]  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTotalPot_LP_UkuranKhusus]') AND type in (N'U')) DROP TABLE [dbo].[tempTotalPot_LP_UkuranKhusus] " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTotalPot_SystemLP]') AND type in (N'U')) DROP TABLE [dbo].[tempTotalPot_SystemLP]  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempSelisih_TotPot]') AND type in (N'U')) DROP TABLE [dbo].[tempSelisih_TotPot]  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTotPot_Proposionet]') AND type in (N'U')) DROP TABLE [dbo].[tempTotPot_Proposionet] " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempGroup_LPUK]') AND type in (N'U')) DROP TABLE [dbo].[tempGroup_LPUK]  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[temp_OKKM]') AND type in (N'U')) DROP TABLE [dbo].[temp_OKKM]  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[temp_Retur]') AND type in (N'U')) DROP TABLE [dbo].[temp_Retur]  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[temp_Sortir]') AND type in (N'U')) DROP TABLE [dbo].[temp_Sortir]  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[temp_TotalDefect]') AND type in (N'U')) DROP TABLE [dbo].[temp_TotalDefect] " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[temp_Persen]') AND type in (N'U')) DROP TABLE [dbo].[temp_Persen]  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[temp_Total]') AND type in (N'U')) DROP TABLE [dbo].[temp_Total]  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[temp_DataDefectISO]') AND type in (N'U')) DROP TABLE [dbo].[temp_DataDefectISO] " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectGPIsoTot]') AND type in (N'U')) DROP TABLE [dbo].[tempdefectGPIsoTot]  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectL1]') AND type in (N'U')) DROP TABLE [dbo].tempdefectL1  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectL2]') AND type in (N'U')) DROP TABLE [dbo].tempdefectL2  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectL3]') AND type in (N'U')) DROP TABLE [dbo].tempdefectL3  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectL4]') AND type in (N'U')) DROP TABLE [dbo].tempdefectL4  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectL5]') AND type in (N'U')) DROP TABLE [dbo].tempdefectL5  " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectL6]') AND type in (N'U')) DROP TABLE [dbo].tempdefectL6 " +
                        " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDataSarmut_Defect]') AND type in (N'U')) DROP TABLE [dbo].tempDataSarmut_Defect " +

                        #endregion
                        #region Logika
 " declare @Total_tempDefect_BM_detail decimal(18,5) " +
                        " declare @Total_tempDefect_Fin_detail decimal(10,5) " +
                        " declare @Selisih_ttl_defect decimal(10,5) " +
                        " declare @dtlSelisih_ttl_defect decimal(10,5) " +
                        " declare @Selisih_ttl_defect2 decimal(10,5) " +
                        " declare @Total_Defect_ListPlank decimal(10,5) " +
                        " declare @Total_Defect_UkuranKhusus decimal(10,5) " +
                        " declare @OutBP_WiP decimal(10,5) " +
                        " declare @Total_tempDefect_BM decimal(10,5) " +
                        " declare @Total_Defect_BMFin decimal(10,5)  " +
                        " declare @Total_DefectProduksi decimal(10,5)  " +
                        " declare @TtlBS_Tahap1 decimal(10,5)   " +
                        " declare @TtlPot_All decimal(10,5)   " +
                        " declare @Selisih_TotPot decimal(10,5)  " +
                        " declare @TotPot_LP_UKhusus decimal(10,5)  " +
                        " declare @TotGroup_LP_UKhusus decimal(10,5)  " +
                        " declare @Tot_Sortir decimal(10,5)  " +
                        " declare @Tot_OKKM decimal(10,5)  " +
                        " declare @Tot_Retur decimal(10,5)  " +
                        " declare @Tot_GP decimal(10,5)  " +

                        " declare @thnbln1 varchar(8) declare @thnbln2 varchar(8) declare @BlnThn varchar(6) " +

                        " set @thnbln1='" + strtgl1 + "' " +
                        " set @thnbln2='" + strtgl2 + "' " +
                        " set @BlnThn='" + Periode + "' " +

                        " select [Group],'0' M3 into tempData_Group from BM_PlantGroup where PlantID>0 " +

                        " set @Tot_GP=isnull(( " +
                        " select count(PlantGroupID)ttl from ( " +
                        " select distinct PlantGroupID from BM_Destacking where left(convert(char,tglproduksi,112),6)=SUBSTRING(@thnbln1,1,6) and RowStatus>-1 " +
                        " and LokasiID not in (select ID from FC_Lokasi where Lokasi like'%adj%') " +
                        " ) as x),0) " +

                        " select A.[Group] into tempGroup3 from ( " +
                        " select distinct PlantGroupID IDGroup from BM_Destacking where left(convert(char,tglproduksi,112),6)=SUBSTRING(@thnbln1,1,6) " +
                        " and RowStatus>-1 and LokasiID not in (select ID from FC_Lokasi where Lokasi like'%adj%')) as x " +
                        " inner join BM_PlantGroup A ON A.ID=x.IDGroup " +

                        /** Defect BM **/
                        " select *  into tempDefect_BM from (  select case when D.DeptID=0 then  case when GJ.GroupJemurName In ('M','N','O','P','Q','R','S','T','U','V','W','X') then " +
                        " case when D.DefName='retak' then 2 when D.DefName='gompal' then 3 else D.DeptID end else " +
                        " case when (B.Qty/E.Qty) *100 >5 then 2 else 3 end   end  else D.DeptID end deptID1,A.CreatedTime as tglInput,A.Tgl as TglPeriksa, " +
                        " E.TglProduksi as TglProd,  D.DefCode,BP.PlantName as Line, PG.[Group],BF.FormulaCode as Jenis,D.DefName,D.DeptID,B.ID,B.DefectID, " +
                        " B.MasterID,B.Qty,A.ID  DestID,isnull(A.TPotong,0)  QtyIn, " +
                        " I.Volume*B.Qty Kubik,isnull(A.TPotong,0) as TotPotong,'' sfrom  " +
                        " from Def_DefectDetail B " +
                        " inner join Def_Defect A on A.Id=B.DefectID   " +
                        " left join Def_MasterDefect D on B.MasterID=D.ID " +
                        " left join BM_Destacking E on E.ID=A.DestID  " +
                        " left join BM_PlantGroup PG on A.GroupProdID=PG.ID " +
                        " left join BM_Formula BF on BF.ID=E.FormulaID   " +
                        " left join BM_Plant BP on BP.ID=E.PlantID " +
                        " left join FC_Items I on I.ID=E.ItemID " +
                        " inner join Def_GroupJemur GJ on GJ.ID=A.GroupJemurID  " +
                        " where B.RowStatus>-1  and D.RowStatus >-1) as Def    " +
                        " where DeptID1=2 and CONVERT(varchar,TglPeriksa,112)>=@thnbln1 and CONVERT(varchar,TglPeriksa,112)<=@thnbln2    " +

                        " select *,isnull((select sum(qty) from tempDefect_BM where [group]=A.[Group] ),0) totdefect, isnull((select sum(kubik) from tempDefect_BM where [group]=A.[Group] ),0) totdefectK into tempdefectGPIsoTot from ( select  B.[Group],SUM(C.qtyin) as totpotong,SUM(kubik) as totkubik    from BM_Destacking A left join BM_PlantGroup B on A.PlantGroupID=B.ID  inner join (  select C.destid,C.qtyin,C.QtyIn*I1.Volume as kubik from T1_Serah C Inner join fc_items I  on C.itemid=I.ID Inner join fc_items I1 on C.itemid0=I1.ID  where C.Status>-1 and CONVERT(char,C.tglserah,112)>=@thnbln1 and   CONVERT(char,C.tglserah,112)<=@thnbln2 and (I.PartNo like '%-w-%' or I.PartNo like '%-3-%' )  union all   select C.DestID , B.Qty qtyin,B.Qty*I.Volume as kubik from Def_Defect A inner join Def_DefectDetail B on A.ID=B.DefectID  inner join T1_Serah C on A.SerahID=C.ID  left join FC_Items I on I.ID=C.ItemID0  where CONVERT(char,A.tgl,112)>=@thnbln1 and  CONVERT(char,A.tgl,112)<=@thnbln2 and B.RowStatus>-1 ) as C   on A.ID=C.DestID group by B.[Group])A  " +

                        /** Defect Finishing **/
                        " select * into tempDefect_Fin " +
                        " from (  select case when D.DeptID=0 then  case when GJ.GroupJemurName In ('M','N','O','P','Q','R','S','T','U','V','W','X') then  " +
                        " case when D.DefName='retak' then 2 when D.DefName='gompal' then 3 else D.DeptID end else case when (B.Qty/E.Qty) *100 >5 then 2 " +
                        " else 3 end   end  else D.DeptID end deptID1,A.CreatedTime as tglInput,A.Tgl as TglPeriksa,E.TglProduksi as TglProd, " +
                        " D.DefCode,BP.PlantName as Line, PG.[Group],BF.FormulaCode as Jenis,D.DefName,D.DeptID,B.ID,B.DefectID,B.MasterID,B.Qty,A.ID " +
                        " DestID,isnull(A.TPotong,0)  QtyIn,B.Qty*I.Volume as Kubik,isnull(A.TPotong,0) as TotPotong,'' sfrom  " +
                        " from Def_DefectDetail B inner join Def_Defect A on A.Id=B.DefectID   left join Def_MasterDefect D on B.MasterID=D.ID " +
                        " left join BM_Destacking E on E.ID=A.DestID   left join BM_PlantGroup PG on A.GroupProdID=PG.ID " +
                        " left join BM_Formula BF on BF.ID=E.FormulaID    left join BM_Plant BP on BP.ID=E.PlantID left join FC_Items I on I.ID=E.ItemID " +
                        " inner join Def_GroupJemur GJ on GJ.ID=A.GroupJemurID  where B.RowStatus>-1  and D.RowStatus >-1) as Def  " +
                        " where DeptID1=3 and CONVERT(varchar,TglPeriksa,112)>=@thnbln1 and CONVERT(varchar,TglPeriksa,112)<=@thnbln2 " +

                        /** Defect Ukuran Khusus **/
                        " ;with dataDestacking as (select distinct ItemID,PlantID,left(convert(char,tglproduksi,112),6)ThnBln from BM_Destacking where RowStatus>-1 group by ItemID,PlantiD,TglProduksi ), " +
                        " dataDestacking1 as (select B.PartNo,PlantID,ThnBln from dataDestacking A inner join FC_Items B ON A.ItemID=B.ID),   " +
                        " dataDestacking2 as (select x.ItemID,x.PartnoAsal,x.Qty,cast(((A.Tebal*A.Lebar*A.Panjang)/1000000000)*x.Qty as decimal(18,2)) M3 from (   select PartNo PartnoAsal,ItemID,isnull(SUM(Qty),0)  * -1 Qty from vw_KartuStockBJNew  where qty <0 and (process  like '%simetris%' ) and  (Keterangan like '%-P-%') and  LokID not In (select ID from FC_Lokasi where lokasi='q99')   and left(convert(char,tanggal,112),8)>=@thnbln1 and  left(convert(char,tanggal,112),8)<=@thnbln2 and ItemID in (select ID  from FC_Items where PartNo like'%-1-%') group by ItemID,Keterangan,PartNo,ItemID   ) as x  inner join FC_Items A ON A.ID=x.ItemID),  " +
                        " dataDestacking3 as (select *,(select top 1 A1.ThnBln from dataDestacking1 A1 where A1.PartNo=A.PartnoAsal and A1.ThnBln<=left(convert(char,@thnbln1,112),6) order by A1.ThnBln desc)ThnBln from dataDestacking2 A) ,  " +
                        " dataDestacking4 as (select PartnoAsal,sum(M3)M3,ThnBln,PlantID from (select A.*,B.PlantID from dataDestacking3 A left join dataDestacking1 B ON A.PartnoAsal=B.PartNo and A.ThnBln=B.ThnBln ) as x group by PartnoAsal,ThnBln,PlantID),  " +
                        " dataDestacking04 as (select *,(select top 1 A1.Line from Def_UKhususProsen A1 where A1.Partno=A.PartnoAsal and A1.Periode=left(convert(char,@thnbln1,112),6))PlantID2 from dataDestacking4 A ),  " +
                        " dataDestacking5 as (select PartnoAsal,M3,case when PlantID2 is null then PlantID else PlantID2 end PlantID from dataDestacking04 xx),  " +
                        " dataDestacking051 as (select PartnoAsal,M3,PlantID from dataDestacking5 xx group by PartnoAsal,M3,PlantID ), " +
                        " dataDestacking05 as (select PartnoAsal,M3,PlantID,(select count(PartnoAsal) from dataDestacking051 A where A.PartnoAsal=dataDestacking051.PartnoAsal)ttl from dataDestacking051 group by PartnoAsal,M3,PlantID),  " +
                        " dataDestacking6 as (select PartnoAsal,sum(m3)m3,PlantID,ttl from dataDestacking05 group by PlantID,ttl,PartnoAsal),  " +
                        " dataDestacking06 as (select PartnoAsal,case when ttl=1 then m3 when ttl>1 then m3/ttl end m3,PlantID from dataDestacking6 group by PlantID,m3,ttl,PartnoAsal), " +
                        " dataDestacking006 as (select cast(m3 as decimal(18,2))m3,PlantID from dataDestacking06 ), " +
                        " dataDestacking7 as (  select sum(M3)M3,[Group] from (  " +
                        " select M3/4 M3,B.[Group] from dataDestacking006 A inner join BM_PlantGroup B ON A.PlantID=B.PlantID where B.PlantID>0  " +
                        " union all  " +
                        " select 0'M3',[Group] from BM_PlantGroup where PlantID>0 ) as x group by [Group] )   " +
                        " select [Group],cast(M3 as decimal(18,3))M3 into tempDefect_UkuranKhusus_detail  from dataDestacking7 " +

                        /** Total Potong Ukuran Khusus **/
                        " ;with dataDestacking as (select distinct ItemID,PlantID,left(convert(char,tglproduksi,112),6)ThnBln from BM_Destacking where RowStatus>-1 group by ItemID,PlantiD,TglProduksi ), " +
                        " dataDestacking1 as (select B.PartNo,PlantID,ThnBln from dataDestacking A inner join FC_Items B ON A.ItemID=B.ID),  " +
                        " dataDestacking2 as (select x.ItemID,x.PartnoAsal,x.Qty,((A.Tebal*A.Lebar*A.Panjang)/1000000000)*x.Qty M3 from (   select PartNo PartnoAsal,ItemID,isnull(SUM(Qty),0)  * -1 Qty from vw_KartuStockBJNew  where qty <0 and (process  like '%simetris%' ) and  (Keterangan like '%-P-%' or Keterangan like '%-3-%' or Keterangan like '%-M-%') and  LokID not In (select ID from FC_Lokasi where lokasi='q99')   and left(convert(char,tanggal,112),8)>=@thnbln1 and  left(convert(char,tanggal,112),8)<=@thnbln2 and ItemID in (select ID  from FC_Items where PartNo like'%-1-%') group by ItemID,Keterangan,PartNo,ItemID   ) as x  inner join FC_Items A ON A.ID=x.ItemID),    " +
                        " dataDestacking3 as (select *,(select top 1 A1.ThnBln from dataDestacking1 A1 where A1.PartNo=A.PartnoAsal and A1.ThnBln<=left(convert(char,@thnbln1,112),6) order by A1.ThnBln desc)ThnBln from dataDestacking2 A) ,    " +
                        " dataDestacking4 as (select PartnoAsal,sum(M3)M3,ThnBln,PlantID from (select A.*,B.PlantID from dataDestacking3 A left join dataDestacking1 B ON A.PartnoAsal=B.PartNo and A.ThnBln=B.ThnBln ) as x group by PartnoAsal,ThnBln,PlantID),    " +
                        " dataDestacking04 as (select *,(select top 1 A1.Line from Def_UKhususProsen A1 where A1.Partno=A.PartnoAsal and A1.Periode=left(convert(char,@thnbln1,112),6))PlantID2 from dataDestacking4 A ),    " +
                        " dataDestacking5 as (select PartnoAsal,M3,case when PlantID2 is null then PlantID else PlantID2 end PlantID from dataDestacking04 xx),  " +
                        " dataDestacking051 as (select PartnoAsal,M3,PlantID from dataDestacking5 xx group by PartnoAsal,M3,PlantID ),  " +
                        " dataDestacking05 as (select PartnoAsal,M3,PlantID,(select count(PartnoAsal) from dataDestacking051 A where A.PartnoAsal=dataDestacking051.PartnoAsal)ttl from dataDestacking051 group by PartnoAsal,M3,PlantID),    " +
                        " dataDestacking6 as (select PartnoAsal,sum(m3)m3,PlantID,ttl from dataDestacking05 group by PlantID,ttl,PartnoAsal), " +
                        " dataDestacking06 as (select PartnoAsal,case when ttl=1 then m3 when ttl>1 then m3/ttl end m3,PlantID from dataDestacking6 group by PlantID,m3,ttl,PartnoAsal),   " +
                        " dataDestacking7 as (  select sum(M3)M3,[Group] from (    " +
                        " select M3/4 M3,B.[Group] from dataDestacking06 A inner join BM_PlantGroup B ON A.PlantID=B.PlantID where B.PlantID>0    " +
                        " union all    " +
                        " select 0'M3',[Group] from BM_PlantGroup where PlantID>0 ) as x group by [Group] )     " +
                        " select [Group],cast(M3 as decimal(18,2))M3  into tempTotalPotong_UkuranKhusus  from dataDestacking7  " +


                        /** OK KM **/
                        " set @Tot_OKKM= " +
                        " isnull((select cast(sum(qtyin *((I.tebal*I.Lebar*I.Panjang)/1000000000)) as decimal(18,2))M3 " +
                        " from T3_Rekap R inner join fc_items I on R.itemid=I.ID  where R.rowstatus>-1 and R.Process  like '%simetris%' " +
                        " and CONVERT(varchar,R.tgltrans,112)>=@thnbln1 and CONVERT(varchar,R.tgltrans,112)<=@thnbln2   and I.lebar=1200 and I.panjang=2400 " +
                        " and R.keterangan like '%-p-%' and (I.partno like '%-3-%' or I.partno like '%-W-%' or I.partno like '%-M-%' )),0)  " +

                        /** Sortir **/
                        " set @Tot_Sortir= " +
                        " isnull((select cast(sum(M3AkhirSS)+sum(M3AkhirSE) as decimal(18,0))M3 " +
                        " from (  SELECT B.tgltrans as Tanggal, I1.PartNo as PartnoAwal, sum(B.QtyIn) as QtyAwal,sum(I1.Volume*B.QtyIn) M3Awal,  " +
                        " I2.PartNo AS PartnoAkhir, case when B.NCSS>0 then sum(B.QtyOut) else 0 end QtyAkhirSS,  case when B.NCSS>0 " +
                        " then sum(I2.Volume*B.QtyOut) else 0 end M3AkhirSS,case when B.NCSE>0 then sum(B.QtyOut) else 0 end QtyAkhirSE,  " +
                        " case when B.NCSE>0 then sum(I2.Volume*B.QtyOut) else 0 end M3AkhirSE,B.NCSS,B.NCSE  " +
                        " FROM T3_Serah AS A   INNER JOIN T3_Simetris AS B ON A.ID = B.SerahID " +
                        " INNER JOIN FC_Items AS I1 ON A.ItemID = I1.ID " +
                        " INNER JOIN   FC_Items AS I2 ON B.ItemID = I2.ID " +
                        " LEFT JOIN T3_GroupM AS D ON B.GroupID = D.ID   " +
                        " where (B.NCSS>0 or B.NCSE>0) and B.rowstatus>-1 and CONVERT(varchar,B.tgltrans,112)>=@thnbln1 " +
                        " and CONVERT(varchar,B.tgltrans,112)<=@thnbln2   group by B.tgltrans,I1.PartNo,I2.PartNo,B.NCSS,B.NCSE ) as xx ),0)  " +

                        /** Retur **/
                        " set @Tot_Retur= " +
                        "" + logikaretur + "" +
                        //" isnull((select cast((TotK1/**-TotK2)+TotK3**/) as decimal(18,2))M3 " +
                        //" from (  select cast((sum(Volume*Tot1)) as decimal(18,2)) TotK1,cast((sum(Volume*Tot2)) as decimal(18,2)) TotK2, " +
                        //" cast((sum(Volume*Tot3)) as decimal(18,2)) TotK3 " +
                        //" from (  select tanggal,PartNo,volume ,sum(isnull(QtyC1,0))QtyC1,sum(isnull(QtyP1,0)) QtyP1,sum(isnull(QtyS1,0)) QtyS1, " +
                        //" sum(isnull(Tot1,0)) Tot1,sum(isnull(TotK1,0)) TotK1, sum(isnull(QtyC2,0)) QtyC2,sum(isnull(QtyP2,0)) QtyP2,sum(isnull(QtyS2,0)) " +
                        //" QtyS2,sum(isnull(Tot2,0)) Tot2, sum(isnull(TotK2,0)) TotK2,sum(isnull(QtyC3,0)) QtyC3,sum(isnull(QtyP3,0)) QtyP3, " +
                        //" sum(isnull(QtyS3,0)) QtyS3,sum(isnull(Tot3,0)) Tot3,sum(isnull(TotK3,0)) TotK3 from ( select tanggal ,PartNo,volume, " +
                        //" case when typeR=1 and ((KW='3' or KW='W')or lokasi='cl') then Qty end QtyC1,case when typeR=1 and (KW='P'and lokasi <> 'cl') " +
                        //" then Qty end QtyP1, case when typeR=1 and (KW='S'and lokasi <> 'cl') then Qty end QtyS1, case when typeR=1 and ((KW='P' or KW='S') " +
                        //" and lokasi <> 'cl') then Qty end Tot1, case when typeR=1 and (KW='P' or KW='S') then QtyK end TotK1, case when typeR=2 " +
                        //" and ((KW='3' or KW='W')or lokasi='cl') then Qty end QtyC2, case when typeR=2 and (KW='P' and lokasi <> 'cl') then Qty end QtyP2, " +
                        //" case when typeR=2 and (KW='S' and lokasi <> 'cl') then Qty end QtyS2, case when typeR=2 and ((KW='P' or KW='S') and lokasi <> 'cl') " +
                        //" then Qty end Tot2, case when typeR=2 and ((KW='P' or KW='S') and lokasi <> 'cl') then QtyK end TotK2, " +
                        //" case when typeR=3 and ((KW='3' or KW='W')or lokasi='cl') then Qty end QtyC3, case when typeR=3 and (KW='P' and lokasi <> 'cl') " +
                        //" then Qty end QtyP3, case when typeR=3 and (KW='S' and lokasi <> 'cl') then Qty end QtyS3, case when typeR=3 and ((KW='P' or KW='S') " +
                        //" and lokasi <> 'cl') then Qty   end Tot3, case when typeR=3 and ((KW='P' or KW='S') and lokasi <> 'cl') then QtyK end TotK3 " +
                        //" from (select R.TglTrans tanggal,I.PartNo,I.volume,SUBSTRING(I.partno,5,1) as KW,sum(R.Qty)Qty, " +
                        //" sum(((I.Panjang*I.Lebar)/(1220*2440) ) * R.Qty) QtyK,isnull(R.TypeR,1)  TypeR,I.ID,L.Lokasi    " +
                        //" from T3_Retur R inner join FC_Items I on R.ItemID =I.ID  inner join FC_lokasi L on R.LokID=L.ID  where R.RowStatus>-1   " +
                        //" group by R.TglTrans,I.PartNo,I.volume,R.TypeR,I.ID,L.Lokasi " +
                        //" union all " +
                        //" select R.TglTrans tanggal,I.PartNo,I.volume,SUBSTRING(I.partno,5,1) as KW,sum(R.Qty)Qty," +
                        //" sum(((I.Panjang*I.Lebar)/(1220*2440) ) * R.Qty) QtyK,3  TypeR,I.ID,L.Lokasi     " +
                        //" from T3_ReturO R inner join FC_Items I on R.ItemID =I.ID  inner join FC_lokasi L on R.LokID=L.ID  where R.RowStatus>-1  " +
                        //" group by R.TglTrans,I.PartNo,I.volume,I.ID,L.Lokasi ) as A ) as B where convert(char,tanggal,112)>=@thnbln1 " +
                        //" and convert(char,tanggal,112)<=@thnbln2 group by tanggal,PartNo,volume ) as x ) as x1),0)  " +

                        /** Data Master Defect ListPlank sampai Strapping **/
                        " ;with Listplank_Master as (  select PartnoAsal,isnull(cast((sum(M3)) as decimal(18,2)),0) M3  " +
                        " from (  select PartnoAsal,isnull(cast((sum(M3)) as decimal(18,2)),0)M3  " +
                        " from (  select PartnoAsal,Qty,cast((((Tebal*Lebar*Panjang)/1000000000)*Qty) as decimal(18,5)) M3  from ( " +

                        " select PartnoAsal,PartNo2,sum(Qty)Qty,Tebal,Lebar,Panjang " +
                        " from (  select x1.PartNo PartnoAsal,x2.PartNo PartNo2,x2.Tebal,x2.Lebar,x2.Panjang,x.Qty " +
                        " from (  select ItemID0,itemid,Qty * -1 Qty from vw_KartuStockListplank where left(convert(char,tanggal,112),8)>=@thnbln1 " +
                        " and  left(convert(char,tanggal,112),8)<=@thnbln2 and process='runingsaw' and qty<0 ) as x   " +
                        " inner join FC_Items x1 ON x.ItemID0=x1.ID  inner join FC_Items x2 ON x.ItemID=x2.ID) as A " +
                        " group by PartnoAsal,PartNo2,Tebal,Lebar,Panjang ) as xx ) as xx1  group by PartnoAsal  " +
                        " union all " +

                        /** 2. Saldo Awal Running Saw **/
                        " select PartnoAsal,isnull(cast((sum((Volume*Qty))) as decimal(18,2)),0) M3  " +
                        " from (  select x2.PartNo PartnoAsal,cast(((x1.Tebal*x1.Lebar*x1.Panjang)/1000000000) as decimal(10,5))Volume,x.Qty  " +
                        " from (  select sum(saldo)Qty ,ItemID,ItemID0 from T1_SaldoListPlank where Process='runingsaw' and thnbln=@BlnThn and Saldo>0 " +
                        " and ItemID<>ItemID0 group by ItemID,ItemID0 ) as x   " +
                        " inner join FC_Items x1 ON x.ItemID=x1.ID  inner join FC_Items x2 ON x.ItemID0=x2.ID) as A group by PartnoAsal " +
                        " union all   " +
                        /** 3. Saldo Akhir RunningSaw **/
                        " select PartnoAsal,isnull(cast((sum(M3)) as decimal(18,2)) * -1,0) M3 " +
                        " from (  select PartnoAsal,Qty,cast((((Tebal*Lebar*Panjang)/1000000000)*Qty) as decimal(18,5)) M3  " +
                        " from (  select PartnoAsal,PartNo2,sum(Qty)Qty,Tebal,Lebar,Panjang  " +
                        " from (  select x1.PartNo PartnoAsal,x2.PartNo PartNo2,x2.Tebal,x2.Lebar,x2.Panjang,x.Qty " +
                        " from (  select sum(Saldo)Qty,ItemID0,ItemID from T1_SaldoListPlank where Process='runingsaw' " +
                        " and thnbln=left(convert(char,@thnbln1,112),6) and Saldo>0 and ItemID<>ItemID0  group by ItemID0,ItemID ) as x  " +
                        " inner join FC_Items x1 ON x.ItemID0=x1.ID  inner join FC_Items x2 ON x.ItemID=x2.ID) as A " +
                        " group by PartnoAsal,PartNo2,Tebal,Lebar,Panjang ) as xx ) as xx1    group by PartnoAsal  " +
                        " union all " +
                        /** 4. Saldo Awal Bevel **/
                        " select PartnoAsal,isnull(cast((sum(M3)) as decimal(18,2)),0) M3 " +
                        " from (  select PartnoAsal,Qty,cast((((Tebal*Lebar*Panjang)/1000000000)*Qty) as decimal(18,5)) M3 " +
                        " from (  select PartnoAsal,PartNo2,sum(Qty)Qty,Tebal,Lebar,Panjang " +
                        " from (  select x1.PartNo PartnoAsal,x2.PartNo PartNo2,x2.Tebal,x2.Lebar,x2.Panjang,x.Qty " +
                        " from (  select sum(Saldo)Qty,ItemID0,ItemID from T1_SaldoListPlank where Process='bevel' and thnbln=@BlnThn and Saldo>0 " +
                        " group by ItemID0,ItemID ) as x   inner join FC_Items x1 ON x.ItemID0=x1.ID  inner join FC_Items x2 ON x.ItemID=x2.ID) as A " +
                        " group by PartnoAsal,PartNo2,Tebal,Lebar,Panjang ) as xx ) as xx1 group by PartnoAsal   " +
                        " union all   " +
                        /** 5. Saldo Akhir Bevel **/
                        " select PartnoAsal,isnull(cast((sum(M3)) as decimal(18,2)) * -1,0) M3 " +
                        " from (  select PartnoAsal,Qty,cast((((Tebal*Lebar*Panjang)/1000000000)*Qty) as decimal(18,5)) M3  " +
                        " from (  select PartnoAsal,PartNo2,sum(Qty)Qty,Tebal,Lebar,Panjang  " +
                        " from (  select x1.PartNo PartnoAsal,x2.PartNo PartNo2,x2.Tebal,x2.Lebar,x2.Panjang,x.Qty " +
                        " from (  select sum(Saldo)Qty,ItemID0,ItemID from T1_SaldoListPlank where Process='bevel' " +
                        " and thnbln=left(convert(char,@thnbln1,112),6) and Saldo>0 and ItemID<>ItemID0  group by ItemID0,ItemID ) as x  " +
                        " inner join FC_Items x1 ON x.ItemID0=x1.ID  inner join FC_Items x2 ON x.ItemID=x2.ID) as A " +
                        " group by PartnoAsal,PartNo2,Tebal,Lebar,Panjang ) as xx ) as xx1   group by PartnoAsal   " +
                        " union all  " +
                        /** 6. Saldo Awal Strapping **/
                        " select PartnoAsal,isnull(cast((sum(M3)) as decimal(18,2)),0) M3 " +
                        " from (select PartnoAsal,Qty,cast((((Tebal*Lebar*Panjang)/1000000000)*Qty) as decimal(18,5)) M3 " +
                        " from (  select PartnoAsal,PartNo2,sum(Qty)Qty,Tebal,Lebar,Panjang  " +
                        " from (  select x1.PartNo PartnoAsal,x2.PartNo PartNo2,x2.Tebal,x2.Lebar,x2.Panjang,x.Qty " +
                        " from (  select sum(Saldo)Qty,ItemID0,ItemID from T1_SaldoListPlank where Process='straping' and thnbln=@BlnThn and Saldo>0 " +
                        " group by ItemID0,ItemID ) as x   inner join FC_Items x1 ON x.ItemID0=x1.ID  inner join FC_Items x2 ON x.ItemID=x2.ID) as A " +
                        " group by PartnoAsal,PartNo2,Tebal,Lebar,Panjang ) as xx ) as xx1 group by PartnoAsal  " +
                        " union all  " +
                        /** 7. Saldo Akhir Strapping **/
                        " select PartnoAsal,isnull(cast((sum(M3)) as decimal(18,2))* -1,0) M3 " +
                        " from (  select PartnoAsal,Qty,cast((((Tebal*Lebar*Panjang)/1000000000)*Qty) as decimal(18,5)) M3  " +
                        " from (  select PartnoAsal,PartNo2,sum(Qty)Qty,Tebal,Lebar,Panjang  " +
                        " from (  select x1.PartNo PartnoAsal,x2.PartNo PartNo2,x2.Tebal,x2.Lebar,x2.Panjang,x.Qty " +
                        " from (  select sum(Saldo)Qty,ItemID0,ItemID from T1_SaldoListPlank where Process='straping' " +
                        " and thnbln=left(convert(char,@thnbln1,112),6) and Saldo>0 and ItemID<>ItemID0  group by ItemID0,ItemID ) as x " +
                        " inner join FC_Items x1 ON x.ItemID0=x1.ID  inner join FC_Items x2 ON x.ItemID=x2.ID) as A " +
                        " group by PartnoAsal,PartNo2,Tebal,Lebar,Panjang ) as xx ) as xxx group by PartnoAsal  " +
                        " ) as DataFinall group by PartnoAsal ) " +
                        " select * into tempDefect_Master_ListPlank from Listplank_Master; " +

                        /** Defect ListPlank **/
                        " ;with   Listplank as (select distinct ItemID,PlantID,left(convert(char,tglproduksi,112),6)ThnBln from BM_Destacking where RowStatus>-1 group by ItemID,PlantiD,TglProduksi ),  Listplank1 as (select B.PartNo,PlantID,ThnBln from Listplank A inner join FC_Items B ON A.ItemID=B.ID),  " +
                        " Listplank2 as (  select PartnoAsal,isnull((sum(M3)) ,0) M3  from ( select PartnoAsal,sum(M3)M3 from ( " +
                        " select PartnoAsal,isnull((sum(M3)) ,0)M3  from (  select PartnoAsal,Qty,(((Tebal*Lebar*Panjang)/1000000000)*Qty) M3  from (  select PartnoAsal,PartNo2,sum(Qty)Qty,Tebal,Lebar,Panjang  from (  select x1.PartNo PartnoAsal,x2.PartNo PartNo2,x2.Tebal,x2.Lebar,x2.Panjang,x.Qty from (  select ItemID0,itemid,Qty * -1 Qty from vw_KartuStockListplank where left(convert(char,tanggal,112),8)>=@thnbln1 and  left(convert(char,tanggal,112),8)<=@thnbln2 and process='runingsaw' and qty<0 ) as x   inner join FC_Items x1 ON x.ItemID0=x1.ID  inner join FC_Items x2 ON x.ItemID=x2.ID) as A group by PartnoAsal,PartNo2,Tebal,Lebar,Panjang ) as xx ) as xx1  group by PartnoAsal   " +
                        " union all " +
                        " select PartnoAsal,isnull((sum(M3)) ,0)M3  from (  select PartnoAsal,Qty,(((Tebal*Lebar*Panjang)/1000000000)*Qty) M3  from (  select PartnoAsal,PartNo2,sum(Qty)Qty,Tebal,Lebar,Panjang  from (  select x1.PartNo PartnoAsal,x2.PartNo PartNo2,x2.Tebal,x2.Lebar,x2.Panjang,x.Qty from (  select ItemID0,itemid,Qty * -1 Qty from vw_KartuStockListplank where left(convert(char,tanggal,112),8)>=@thnbln1 and  left(convert(char,tanggal,112),8)<=@thnbln2 and process Like '%adjoutruningsaw%' and qty<0 ) as x   inner join FC_Items x1 ON x.ItemID0=x1.ID  inner join FC_Items x2 ON x.ItemID=x2.ID) as A group by PartnoAsal,PartNo2,Tebal,Lebar,Panjang ) as xx ) as xx1  group by PartnoAsal  " +
                        " union all " +
                        " select PartnoAsal,isnull((sum(M3)) ,0)M3  from (  select PartnoAsal,Qty,(((Tebal*Lebar*Panjang)/1000000000)*Qty) M3  from (  select PartnoAsal,PartNo2,sum(Qty)Qty,Tebal,Lebar,Panjang  from (  select x1.PartNo PartnoAsal,x2.PartNo PartNo2,x2.Tebal,x2.Lebar,x2.Panjang,x.Qty from (  select ItemID0,itemid,Qty * -1 Qty from vw_KartuStockListplank where left(convert(char,tanggal,112),8)>=@thnbln1 and  left(convert(char,tanggal,112),8)<=@thnbln2 and process Like '%adjinruningsaw%' and qty<0 ) as x   inner join FC_Items x1 ON x.ItemID0=x1.ID  inner join FC_Items x2 ON x.ItemID=x2.ID) as A group by PartnoAsal,PartNo2,Tebal,Lebar,Panjang ) as xx ) as xx1  group by PartnoAsal " +
                        " ) as x group by PartnoAsal " +
                        " union all " +
                        /** 2. Saldo Awal Running Saw **/
                        " select PartnoAsal,isnull((sum((Volume*Qty))) ,0) M3  from (  select x2.PartNo PartnoAsal,((x1.Tebal*x1.Lebar*x1.Panjang)/1000000000) Volume,x.Qty  from (  select sum(saldo)Qty ,ItemID,ItemID0 from T1_SaldoListPlank where Process='runingsaw' and thnbln=@BlnThn and Saldo>0 and ItemID<>ItemID0 group by ItemID,ItemID0 ) as x    inner join FC_Items x1 ON x.ItemID=x1.ID  inner join FC_Items x2 ON x.ItemID0=x2.ID) as A group by PartnoAsal   " +
                        " union all " +
                        /** 3. Saldo Akhir RunningSaw **/
                        " select PartnoAsal,isnull((sum(M3)) * -1,0) M3 from (  select PartnoAsal,Qty,(((Tebal*Lebar*Panjang)/1000000000)*Qty)  M3  from (  select PartnoAsal,PartNo2,sum(Qty)Qty,Tebal,Lebar,Panjang  from (  select x1.PartNo PartnoAsal,x2.PartNo PartNo2,x2.Tebal,x2.Lebar,x2.Panjang,x.Qty from (  select sum(Saldo)Qty,ItemID0,ItemID from T1_SaldoListPlank where Process='runingsaw' and thnbln=left(convert(char,@thnbln1,112),6) and Saldo>0 and ItemID<>ItemID0  group by ItemID0,ItemID ) as x   inner join FC_Items x1 ON x.ItemID0=x1.ID  inner join FC_Items x2 ON x.ItemID=x2.ID) as A group by PartnoAsal,PartNo2,Tebal,Lebar,Panjang ) as xx ) as xx1    group by PartnoAsal   " +
                        " union all " +
                        /** 4. Saldo Awal Bevel **/
                        " select PartnoAsal,isnull((sum(M3)) ,0) M3  from (  select PartnoAsal,Qty,(((Tebal*Lebar*Panjang)/1000000000)*Qty)  M3  from (  select PartnoAsal,PartNo2,sum(Qty)Qty,Tebal,Lebar,Panjang  from (  select x1.PartNo PartnoAsal,x2.PartNo PartNo2,x2.Tebal,x2.Lebar,x2.Panjang,x.Qty from (  select sum(Saldo)Qty,ItemID0,ItemID from T1_SaldoListPlank where Process='bevel' and thnbln=@BlnThn and Saldo>0 group by ItemID0,ItemID ) as x   inner join FC_Items x1 ON x.ItemID0=x1.ID  inner join FC_Items x2 ON x.ItemID=x2.ID) as A group by PartnoAsal,PartNo2,Tebal,Lebar,Panjang ) as xx ) as xx1 group by PartnoAsal   union all    " +
                        /** 5. Saldo Akhir Bevel **/
                        " select PartnoAsal,isnull((sum(M3))  * -1,0) M3 from (  select PartnoAsal,Qty,(((Tebal*Lebar*Panjang)/1000000000)*Qty)  M3  from (  select PartnoAsal,PartNo2,sum(Qty)Qty,Tebal,Lebar,Panjang  from (  select x1.PartNo PartnoAsal,x2.PartNo PartNo2,x2.Tebal,x2.Lebar,x2.Panjang,x.Qty from (  select sum(Saldo)Qty,ItemID0,ItemID from T1_SaldoListPlank where Process='bevel' and thnbln=left(convert(char,@thnbln1,112),6) and Saldo>0 and ItemID<>ItemID0  group by ItemID0,ItemID ) as x   inner join FC_Items x1 ON x.ItemID0=x1.ID  inner join FC_Items x2 ON x.ItemID=x2.ID) as A group by PartnoAsal,PartNo2,Tebal,Lebar,Panjang ) as xx ) as xx1   group by PartnoAsal   union all   " +
                        /** 6. Saldo Awal Strapping **/
                        " select PartnoAsal,isnull((sum(M3)) ,0) M3 from (select PartnoAsal,Qty,(((Tebal*Lebar*Panjang)/1000000000)*Qty)  M3  from (  select PartnoAsal,PartNo2,sum(Qty)Qty,Tebal,Lebar,Panjang  from (  select x1.PartNo PartnoAsal,x2.PartNo PartNo2,x2.Tebal,x2.Lebar,x2.Panjang,x.Qty from (  select sum(Saldo)Qty,ItemID0,ItemID from T1_SaldoListPlank where Process='straping' and thnbln=@BlnThn and Saldo>0 group by ItemID0,ItemID ) as x   inner join FC_Items x1 ON x.ItemID0=x1.ID  inner join FC_Items x2 ON x.ItemID=x2.ID) as A group by PartnoAsal,PartNo2,Tebal,Lebar,Panjang ) as xx ) as xx1 group by PartnoAsal  " +
                        " union all   " +
                        /** 7. Saldo Akhir Strapping **/
                        " select PartnoAsal,isnull((sum(M3)) * -1,0) M3 from (  select PartnoAsal,Qty,(((Tebal*Lebar*Panjang)/1000000000)*Qty)  M3  from (  select PartnoAsal,PartNo2,sum(Qty)Qty,Tebal,Lebar,Panjang  from (  select x1.PartNo PartnoAsal,x2.PartNo PartNo2,x2.Tebal,x2.Lebar,x2.Panjang,x.Qty from (  select sum(Saldo)Qty,ItemID0,ItemID from T1_SaldoListPlank where Process='straping' and thnbln=left(convert(char,@thnbln1,112),6) and Saldo>0 and ItemID<>ItemID0  group by ItemID0,ItemID ) as x   inner join FC_Items x1 ON x.ItemID0=x1.ID  inner join FC_Items x2 ON x.ItemID=x2.ID) as A group by PartnoAsal,PartNo2,Tebal,Lebar,Panjang ) as xx ) as xxx group by PartnoAsal  " +
                        " union all   " +
                        /** 8. Tahap III OK **/
                        " select PartnoAsal,isnull((sum(M3))*-1 ,0) M3 from (  select PartnoAsal,Qty,(((Tebal*Lebar*Panjang)/1000000000)*Qty)  M3  from (  select PartnoAsal,sum(Qty)Qty,Tebal,Lebar,Panjang  from (  select x.PartNo PartnoAsal,x2.Tebal,x2.Lebar,x2.Panjang,x.Qty from (  select sum(Qty)Qty,ItemID,Keterangan Partno from vw_KartuStockBJNew  where sfrom='straping' and left(convert(char,tanggal,112),6)=left(convert(char,@thnbln1,112),6) and ItemID in  (select ID from FC_Items where PartNo like'%-M-%' or PartNo like'%-3-%')  group by ItemID,Keterangan ) as x   inner join FC_Items x2 ON x.ItemID=x2.ID) as A group by PartnoAsal,Tebal,Lebar,Panjang ) as xx ) as xx1 group by PartnoAsal   " +
                        " union all " +
                        /** 9. Tahap III BP **/
                        " select PartnoAsal,isnull((sum(M3)),0) M3  from (  select PartnoAsal,Qty,(((Tebal*Lebar*Panjang)/1000000000)*Qty)   M3  from (  select PartnoAsal,sum(Qty)Qty,Tebal,Lebar,Panjang  from (  select x.PartNo PartnoAsal,x2.Tebal,x2.Lebar,x2.Panjang,x.Qty from (  select sum(Qty)Qty,ItemID,Keterangan Partno from vw_KartuStockBJNew  where sfrom='straping' and left(convert(char,tanggal,112),6)=left(convert(char,@thnbln1,112),6) and  ItemID in (select ID from FC_Items where PartNo like'%-P-%' or PartNo like'%-S-%')  group by ItemID,Keterangan ) as x   inner join FC_Items x2 ON x.ItemID=x2.ID) as A group by PartnoAsal,Tebal,Lebar,Panjang ) as xx ) as xx1 group by PartnoAsal  ) as DataFinall group by PartnoAsal ) ,  " +
                        " Listplank3 as (select *,(select top 1 A1.ThnBln from Listplank1 A1 where A1.PartNo=A.PartnoAsal and A1.ThnBln<=left(convert(char,@thnbln1,112),6) order by A1.ThnBln desc)ThnBln from Listplank2 A) ,  " +
                        " Listplank4 as (select PartnoAsal,sum(M3)M3,ThnBln,PlantID from (select A.*,B.PlantID from Listplank3 A left join Listplank1 B ON A.PartnoAsal=B.PartNo and A.ThnBln=B.ThnBln ) as x group by PartnoAsal,ThnBln,PlantID), " +
                        " Listplank04 as (select *,(select top 1 A1.Line from Def_UKhususProsen A1 where A1.Partno=A.PartnoAsal and A1.Periode=left(convert(char,@thnbln1,112),6))PlantID2 from Listplank4 A ), " +
                        " Listplank5 as (select PartnoAsal,M3,case when PlantID2 is null then PlantID else PlantID2 end PlantID from Listplank04 xx),  Listplank051 as (select PartnoAsal,M3,PlantID from Listplank5 xx group by PartnoAsal,M3,PlantID ), " +
                        " Listplank05 as (select PartnoAsal,M3,PlantID,(select count(PartnoAsal) from Listplank051 A where A.PartnoAsal=Listplank051.PartnoAsal)ttl from Listplank051 group by PartnoAsal,M3,PlantID),  Listplank6 as (select PartnoAsal,sum(m3)m3,PlantID,ttl from Listplank05 group by PlantID,ttl,PartnoAsal), " +
                        " Listplank06 as (select PartnoAsal,case when ttl=1 then m3 when ttl>1 then m3/ttl end m3,PlantID from Listplank6 group by PlantID,m3,ttl,PartnoAsal),  " +
                        " Listplank006 as (select sum(m3)m3,PlantID  from Listplank06 group by PlantID), " +
                        " Listplank0006 as (select cast(m3 as decimal(18,3))M3,PlantID  from Listplank006), " +
                        " Listplank7 as (  select sum(M3)M3,[Group] from (  select cast(M3 as decimal(18,2))/4 M3,B.[Group] from Listplank0006 A inner join BM_PlantGroup B ON A.PlantID=B.PlantID where B.PlantID>0 " +
                        " union all  " +
                        " select 0'M3',[Group] from BM_PlantGroup where PlantID>0 ) as x group by [Group] )   " +
                        " select [Group],M3 into tempDefect_ListPlank_detail from Listplank7;  " +

                        /** ListPlank Before BP dan OK **/
                        " with LP_1 as (select distinct ItemID,PlantID,left(convert(char,tglproduksi,112),6)ThnBln from BM_Destacking where RowStatus>-1 group by ItemID,PlantiD,TglProduksi ),  " +
                        " LP_2 as (select B.PartNo,PlantID,ThnBln from LP_1 A inner join FC_Items B ON A.ItemID=B.ID),  " +
                        " LP_3 as ( select PartnoAsal,isnull(cast((sum(M3)) as decimal(18,4)),0) M3  from (  " +
                        " select * from tempDefect_Master_ListPlank " +
                        " ) as DataFinall group by PartnoAsal) , " +
                        " LP_4 as (select *,(select top 1 A1.ThnBln from LP_2 A1 where A1.PartNo=A.PartnoAsal and A1.ThnBln<=left(convert(char,@thnbln1,112),6) order by A1.ThnBln desc)ThnBln from LP_3 A), " +
                        " LP_5 as (select PartnoAsal,sum(M3)M3,ThnBln,PlantID from (select A.*,B.PlantID from LP_4 A left join LP_2 B ON A.PartnoAsal=B.PartNo and A.ThnBln=B.ThnBln ) as x group by PartnoAsal,ThnBln,PlantID),   " +
                        " LP_6 as (select *,(select top 1 A1.Line from Def_UKhususProsen A1 where A1.Partno=A.PartnoAsal and A1.Periode=left(convert(char,@thnbln1,112),6))PlantID2 from LP_5 A ),  " +
                        " LP_7 as (select PartnoAsal,M3,case when PlantID2 is null then PlantID else PlantID2 end PlantID from LP_6 xx) " +
                        " select cast(sum(M3) as decimal(18,2))M3,PlantID into tempTtl_LP from LP_7 group by PlantID " +

                        /** ListPlank BP **/
                        " ;with LP_1 as (select distinct ItemID,PlantID,left(convert(char,tglproduksi,112),6)ThnBln from BM_Destacking where RowStatus>-1 group by ItemID,PlantiD,TglProduksi ),   " +
                        " LP_2 as (select B.PartNo,PlantID,ThnBln from LP_1 A inner join FC_Items B ON A.ItemID=B.ID), " +
                        " LP_3 as ( select PartnoAsal,isnull(cast((sum(M3)) as decimal(18,4)),0) M3  from ( " +
                        /** Tahap III BP **/
                        " select PartnoAsal,isnull(cast((sum(M3)) as decimal(18,5)),0) M3  from (  select PartnoAsal,Qty,cast((((Tebal*Lebar*Panjang)/1000000000)*Qty) as decimal(18,5))  M3  from (  select PartnoAsal,sum(Qty)Qty,Tebal,Lebar,Panjang  from (  select x.PartNo PartnoAsal,x2.Tebal,x2.Lebar,x2.Panjang,x.Qty from (  select sum(Qty)Qty,ItemID,Keterangan Partno from vw_KartuStockBJNew  where sfrom='straping' and left(convert(char,tanggal,112),6)=left(convert(char,@thnbln1,112),6) and  ItemID in (select ID from FC_Items where PartNo like'%-P-%' or PartNo like'%-S-%')  group by ItemID,Keterangan ) as x   inner join FC_Items x2 ON x.ItemID=x2.ID) as A group by PartnoAsal,Tebal,Lebar,Panjang ) as xx ) as xx1 group by PartnoAsal  " +
                        " ) as DataFinall group by PartnoAsal) , " +
                        " LP_4 as (select *,(select top 1 A1.ThnBln from LP_2 A1 where A1.PartNo=A.PartnoAsal and A1.ThnBln<=left(convert(char,@thnbln1,112),6) order by A1.ThnBln desc)ThnBln from LP_3 A), " +
                        " LP_5 as (select PartnoAsal,sum(M3)M3,ThnBln,PlantID from (select A.*,B.PlantID from LP_4 A left join LP_2 B ON A.PartnoAsal=B.PartNo and A.ThnBln=B.ThnBln ) as x group by PartnoAsal,ThnBln,PlantID),  " +
                        " LP_6 as (select *,(select top 1 A1.Line from Def_UKhususProsen A1 where A1.Rowstatus>-1 and A1.Partno=A.PartnoAsal and A1.Periode=left(convert(char,@thnbln1,112),6))PlantID2 from LP_5 A ),  " +
                        " LP_7 as (select PartnoAsal,M3,case when PlantID2 is null then PlantID else PlantID2 end PlantID from LP_6 xx) " +
                        " select cast(sum(M3) as decimal(18,2))M3,PlantID into tempTtlBP_LP from LP_7 group by PlantID " +

                        ///** ListPlank OK **/
                        //" ;with LP_1 as (select distinct ItemID,PlantID,left(convert(char,tglproduksi,112),6)ThnBln from BM_Destacking where RowStatus>-1 group by ItemID,PlantiD,TglProduksi ), " +
                        //" LP_2 as (select B.PartNo,PlantID,ThnBln from LP_1 A inner join FC_Items B ON A.ItemID=B.ID),  " +
                        //" LP_3 as ( select PartnoAsal,isnull((sum(M3)) ,0) M3  from ( " +
                        //    /** Tahap III OK **/
                        //" select PartnoAsal,isnull((sum(M3)),0) M3 from (  select PartnoAsal,Qty,(((Tebal*Lebar*Panjang)/1000000000)*Qty)  M3  from (  select PartnoAsal,sum(Qty)Qty,Tebal,Lebar,Panjang  from (  select x.PartNo PartnoAsal,x2.Tebal,x2.Lebar,x2.Panjang,x.Qty from (  select sum(Qty)Qty,ItemID,Keterangan Partno from vw_KartuStockBJNew  where sfrom='straping' and left(convert(char,tanggal,112),6)=left(convert(char,@thnbln1,112),6) and ItemID in  (select ID from FC_Items where PartNo like'%-M-%' or PartNo like'%-3-%')  group by ItemID,Keterangan ) as x   inner join FC_Items x2 ON x.ItemID=x2.ID) as A group by PartnoAsal,Tebal,Lebar,Panjang ) as xx ) as xx1 group by PartnoAsal  " +
                        //" ) as DataFinall group by PartnoAsal) , " +
                        //" LP_4 as (select *,(select top 1 A1.ThnBln from LP_2 A1 where A1.PartNo=A.PartnoAsal and A1.ThnBln<=left(convert(char,@thnbln1,112),6) order by A1.ThnBln desc)ThnBln from LP_3 A), " +
                        //" LP_5 as (select PartnoAsal,sum(M3)M3,ThnBln,PlantID from (select A.*,B.PlantID from LP_4 A left join LP_2 B ON A.PartnoAsal=B.PartNo and A.ThnBln=B.ThnBln ) as x group by PartnoAsal,ThnBln,PlantID),  " +
                        //" LP_6 as (select *,(select top 1 A1.Line from Def_UKhususProsen A1 where A1.Partno=A.PartnoAsal and A1.Periode=left(convert(char,@thnbln1,112),6))PlantID2 from LP_5 A ),   " +
                        //" LP_7 as (select PartnoAsal,M3,case when PlantID2 is null then PlantID else PlantID2 end PlantID from LP_6 xx) " +
                        //" select cast(sum(M3) as decimal(18,3)) M3,PlantID into tempTtlOK_LP from LP_7  group by PlantID " +

                        /** ListPlank OK **/
                        " ;with LP_1 as (select distinct ItemID,PlantID,left(convert(char,tglproduksi,112),6)ThnBln from BM_Destacking " +
                        " where RowStatus>-1 group by ItemID,PlantiD,TglProduksi ), " +
                        " LP_2 as (select B.PartNo,PlantID,ThnBln from LP_1 A inner join FC_Items B ON A.ItemID=B.ID), " +
                        " LP_3 as ( select PartnoAsal,isnull((sum(M3)) ,0) M3  from (  select PartnoAsal,isnull((sum(M3)),0) M3 " +
                        " from (  select PartnoAsal,Qty,(((Tebal*Lebar*Panjang)/1000000000)*Qty)  M3  " +
                        " from (  select PartnoAsal,sum(Qty)Qty,Tebal,Lebar,Panjang  from (  select x.PartNo PartnoAsal,x2.Tebal,x2.Lebar,x2.Panjang,x.Qty " +
                        " from (  select sum(Qty)Qty,ItemID,Keterangan Partno from vw_KartuStockBJNew  where sfrom='straping' " +
                        " and left(convert(char,tanggal,112),6)=left(convert(char,@thnbln1,112),6) and ItemID in " +
                        " (select ID from FC_Items where PartNo like'%-M-%' or PartNo like'%-3-%')  group by ItemID,Keterangan ) as x " +
                        " inner join FC_Items x2 ON x.ItemID=x2.ID) as A group by PartnoAsal,Tebal,Lebar,Panjang ) as xx ) as xx1 " +
                        " group by PartnoAsal   ) as DataFinall group by PartnoAsal) ,  " +

                        " LP_40 as (select *,(select top 1 A1.ThnBln from LP_2 A1 " +
                        " where A1.PartNo=A.PartnoAsal and A1.ThnBln<=left(convert(char,@thnbln1,112),6) order by A1.ThnBln desc)ThnBln from LP_3 A), " +

                        " LP_4 as (select PartnoAsal,sum(M3)M3,ThnBln,PlantID from (select A.*,B.PlantID from LP_40 A " +
                        " left join LP_2 B ON A.PartnoAsal=B.PartNo and A.ThnBln=B.ThnBln ) as x group by PartnoAsal,ThnBln,PlantID), " +

                        " LP_04 as (select *,(select top 1 A1.Line from Def_UKhususProsen A1 " +
                        " where A1.Partno=A.PartnoAsal and A1.Periode=left(convert(char,@thnbln1,112),6))PlantID2 from LP_4 A ), " +

                        " LP_5 as (select PartnoAsal,M3,ThnBln,PlantID from (select PartnoAsal,M3,A.ThnBln, " +
                        " case when A.PlantID2 is null then B.PlantID else A.PlantID2 end PlantID from LP_04 A " +
                        " left join LP_2 B ON A.PartnoAsal=B.PartNo and A.ThnBln=B.ThnBln ) as x group by PartnoAsal,ThnBln,PlantID,M3), " +

                        " LP_05 as (select PartnoAsal,M3,PlantID,(select count(PartnoAsal) from LP_5 A where A.PartnoAsal=LP_5.PartnoAsal)ttl " +
                        " from LP_5 group by PartnoAsal,M3,PlantID) , " +
                        " LP_06 as (select PartnoAsal,case when ttl=1 then m3 when ttl>1 then m3/ttl end m3,PlantID from LP_05 " +
                        " group by PlantID,m3,ttl,PartnoAsal)  , " +
                        " LP_006 as (select sum(m3)M3,PlantID  from LP_06 group by PlantID) " +

                        " select sum(M3) M3,PlantID into tempTtlOK_LP from LP_006  group by PlantID  " +

                        /** Total Potong BP ListPlank **/
                        " select sum(M3)M3,PlantID into tempTotalPotong_BP_LP from ( " +
                        " select * from tempTtlBP_LP union all " +
                        " select * from tempTtlOK_LP union all " +
                        " select * from tempTtl_LP ) as x group by PlantID " +

                        /** Total Potong ListPlank **/
                        " select sum(M3)M3,PlantID into tempTotalPotong_LP from ( " +
                        " select * from tempTotalPotong_BP_LP union all " +
                        " select * from tempTtl_LP ) as x group by PlantID " +

                        /** Total Potong ListPlank dan Ukuran Khusus  **/
                        " set @TotPot_LP_UKhusus=isnull(cast(( select sum(M3) from ( " +
                        " select sum(M3)M3 from tempTotalPotong_UkuranKhusus " +
                        " union all " +
                        " select sum(M3)M3 from tempDefect_ListPlank_detail " +
                        " union all " +
                        " select sum(M3)M3 from tempTtlOK_LP " +
                        " ) as x)as decimal(18,2)),0) " +

                        " select [Group] into tempGroup_LPUK from ( " +
                        " select [Group] from tempDefect_UkuranKhusus_detail where M3>0 or M3<0 union all " +
                        " select [Group] from tempDefect_ListPlank_detail where M3>0 or M3<0 ) as x group by [Group] " +

                        " set @TotGroup_LP_UKhusus=(select count([Group]) from tempGroup_LPUK) " +
                        //" select [Group],sum(M3) M3 into tempTotalPot_LP_UkuranKhusus from ( " +
                        //" select [Group],cast(@TotPot_LP_UKhusus as decimal(18,5))/cast(@TotGroup_LP_UKhusus as decimal(18,5))M3 from tempGroup_LPUK A " +
                        //" union all " +
                        //" select [Group],cast('0' as decimal(18,0))M3 from tempData_Group) as x group by [Group] " +

                        /** Baru **/
                        //" select [Group],sum(M3) M3 into tempTotalPot_LP_UkuranKhusus from ( "+
                        //" select [Group],cast(@TotPot_LP_UKhusus as decimal(18,5))/cast(@Tot_GP as decimal(18,5))M3 from tempGroup3 A "+
                        //" union all "+
                        //" select [Group],cast('0' as decimal(18,0))M3 from tempGroup3) as x group by [Group] "+

                        " select [Group],sum(M3) M3 into tempTotalPot_LP_UkuranKhusus from ( " +
                        " select [Group],nullif(cast(@TotPot_LP_UKhusus as decimal(18,5)),0)/nullif(cast(@TotGroup_LP_UKhusus as decimal(18,5)),0)M3 from tempGroup_LPUK A " +
                        " union all " +
                        " select [Group],cast('0' as decimal(18,0))M3 from tempData_Group) as x group by [Group] " +

                        /** Total Potong ListPlank Detail Per Group **/
                        " select case when PlantID=1 then 'Line 1'  when PlantID=2 then 'Line 2' when PlantID=3 then 'Line 3' " +
                        " when PlantID=4 then 'Line 4'  when PlantID=5 then 'Line 5' when PlantID=6 then 'Line 6' end Line, " +
                        " case when PlantID=1 then 'CA,CB,CC,CD' when PlantID=2 then 'CE,CF,CG,CH' when PlantID=3 then 'CI,CJ,CK,CL'  " +
                        " when PlantID=4 then 'CM,CN,CO,CP' when PlantID=5 then 'CQ,CR,CS,CT' when PlantID=6 then 'CU,CV,CW,CX' end [Group],M3 into tempGroup from tempTtlOK_LP   " +

                        " SELECT A.[Line],Split.a.value('.', 'VARCHAR(100)') AS [Group],(M3/4) M3 into tempGroup2   " +
                        " FROM (SELECT [Line],CAST ('<M>' + REPLACE([Group],',', '</M><M>') + '</M>' AS XML) AS String,M3 FROM tempGroup) AS A CROSS APPLY String.nodes ('/M') AS Split(a);  " +

                        /** Accounting Report Mutasi WiP : Pengeluaran B99 **/
                        " set @OutBP_WiP = (  select cast((sum(M3)) as decimal(18,2))BP_M3  from (  select sum(Qty)Qty,sum(M3)M3 from (  select *,cast(((Qty*Volume)) as decimal(18,5))M3 from (  select sum(A.qty *-1) Qty,(B.Tebal*B.Lebar*B.Panjang)/1000000000 Volume from vw_KartustockWIP A   inner join FC_Items B ON A.itemid0=B.ID  where qty<0   and lokasi='B99' and process<>'lari' and process<>'listplank' and left(convert(char,tanggal,112),8)>=@thnbln1 and  left(convert(char,tanggal,112),8)<=@thnbln2   group by tebal,lebar,panjang ) as x ) as x1    " +
                        " union all   " +
                        " select sum(Qty)Qty,sum(M3)M3 from (  select *,cast(((Qty*Volume)) as decimal(18,5))M3 from (  select isnull(SUM(qty)*-1,0)Qty,(I2.Tebal*I2.Lebar*I2.Panjang)/1000000000 Volume from vw_KartustockWIP2 V   inner join FC_Items I on V.itemID=I.ID inner join FC_Items I2 on I2.ID=V.itemid0 and (I.partno  like '%-p-%'  )  where qty<0  and idrec not like '%ou%'    and process='lari'and lokid1 not in (select ID from fc_lokasi where lokasi='I99') and  left(convert(char,tanggal,112),8)>=@thnbln1 and left(convert(char,tanggal,112),8)<=@thnbln2  group by I2.tebal,I2.lebar,I2.panjang) as x ) as x1 ) as xx ) " +

                        " select [Group],cast((M3) as decimal(18,2))M3 into tempDefect_BM_detail0 from (select [Group],cast(m3 as decimal(18,1))M3,DefName from ( " +
                        " select [Group],cast(m3 as decimal(18,2))M3,DefName from ( " +
                        " select [Group],sum(Kubik)M3,DefName  from (  " +
                        " select * from tempDefect_BM " +
                        " ) as x group by [Group],DefName " +
                        " ) as xx " +
                        " ) as xxx ) as xxxx " +

                        /** Total : Defect System BM **/
                        " set @Total_tempDefect_BM_detail = isnull((select M3 from (select cast((sum(M3)) as decimal(18,1))M3 from tempDefect_BM_detail0) as x),1)   " +
                        /** Total : Defect System Finishing **/
                        " set @Total_tempDefect_Fin_detail = (select M3 from (select cast((sum(Kubik)) as decimal(18,1))M3 from tempDefect_Fin) as x)  " +
                        /** Total : Selisih Total Defect **/
                        " set @Selisih_ttl_defect = (select @OutBP_WiP - cast((@Total_tempDefect_BM_detail) as decimal(18,1)) - cast((@Total_tempDefect_Fin_detail) as decimal(18,2)))  " +

                        " select [Group],cast(sum(M3) as decimal(18,1))M3 into tempDefect_BM_detail from (select  * from tempData_Group union all select [Group],m3  from tempDefect_BM_detail0 ) as x group by [Group] order by [Group] " +
                        " select [Group],((M3/@Total_tempDefect_BM_detail)*@Selisih_ttl_defect)  M3 into Selisih_ttl_defect_Detail from tempDefect_BM_detail order by [group]  " +
                        " select [Group],(((M3/@Total_tempDefect_BM_detail)*@Total_tempDefect_Fin_detail)) M3 into tempDefect_Fin_detail from tempDefect_BM_detail  " +

                        /** Defect BM dan Finishing **/
                        " select [Group],sum(M3)M3 into tempDefect_BM_FN_detail from ( " +
                        " select [Group],M3 from tempDefect_BM_detail union all " +
                        " select [Group],M3 from tempDefect_Fin_detail union all " +
                        " select [Group],M3 from Selisih_ttl_defect_Detail ) as x group by [Group] " +

                        /** Defect Produksi **/
                        " select [Group],sum(M3)M3 into tempDefect_Produksi_detail from ( " +
                        " select * from tempDefect_UkuranKhusus_detail union all " +
                        " select * from tempDefect_ListPlank_detail union all " +
                        " select * from tempDefect_BM_FN_detail ) as x group by [Group] " +

                        /** BS Tahap 1 **/
                        " select distinct itemid into tempMasterDataBSauto from vw_KartuStockBJNew where itemid in (select ID from fc_items where partno like '%-s-%') and LokID in (select ID from FC_Lokasi where Lokasi='bsauto')  " +
                        " ;with BSTahap as (select distinct itemid from vw_KartuStockBJNew where itemid in (select ID from fc_items where partno like '%-s-%') and  LokID in (select ID from FC_Lokasi where Lokasi='bsauto')  ),  " +
                        " BSTahap1 as (select * from vw_KartuStockBJNew where left(CONVERT(char, tanggal ,112),6)=left(convert(char,@thnbln1,112),6) and itemID in   (select itemid from tempMasterDataBSauto)),  BSTahap2 as (select * from vw_KartuStockBJNew where left(CONVERT(char, tanggal ,112),6)=left(convert(char,@thnbln1,112),6) and itemID not in   (select itemid from tempMasterDataBSauto) ),  " +
                        " BSTahap3 as (select isnull(sum(Qty),0)Qty,isnull(sum(Qty*Volume),0)M3  from (  select x.qty Qty,((x1.Tebal*x1.Lebar*x1.Panjang)/1000000000)Volume from (  select Qty,ItemID from BSTahap1 where (process='direct' or process like'%Simetris%') and (isnull(sfrom,'-')='-' or isnull(sfrom,'bevel')='-'  or isnull(sfrom,'-')='straping') and lokid in (select ID from FC_Lokasi where Lokasi='BSAUTO') and substring(Keterangan,1,21) like '%-1-%'  and left(convert(char,tanggal,112),6)=left(convert(char,@thnbln1,112),6) and PartNo  like'%-S-%') as x inner join FC_Items x1 ON x.ItemID=x1.ID ) as A  ),   " +
                        " BSTahap4 as (select isnull(sum(Qty),0)Qty,isnull(sum(Qty*Volume),0)M3 from (  select x.qty Qty,((x1.Tebal*x1.Lebar*x1.Panjang)/1000000000)Volume from (  select Qty,ItemID from BSTahap2 where (process='direct' or process like'%Simetris%') and (isnull(sfrom,'-')='-' or isnull(sfrom,'bevel')='-'  or isnull(sfrom,'-')='straping') and lokid not in (select ID from FC_Lokasi where Lokasi='BSAUTO') and substring(Keterangan,1,21) like '%-1-%'  and left(convert(char,tanggal,112),6)=left(convert(char,@thnbln1,112),6) and PartNo  like'%-S-%') as x inner join FC_Items x1 ON x.ItemID=x1.ID ) as A ),  " +
                        " BSTahap5 as (select isnull(sum(M3) ,0) M3 from (select M3 from BSTahap3 union all select M3 from BSTahap4) as x ) " +
                        " select * into tempBS_Tahap1 from BSTahap5  " +

                        /** Total : BS Tahap 1 **/
                        " set @TtlBS_Tahap1 = cast(isnull((select M3 from tempBS_Tahap1),0) as decimal(18,2)) " +

                        /** Total : Defect Finishing + BM **/
                        " set @Total_Defect_BMFin = ( @Total_tempDefect_BM_detail + @Total_tempDefect_Fin_detail + @Selisih_ttl_defect ) " +
                        /** Total Defect Ukuran Khusus **/
                        " set @Total_Defect_UkuranKhusus = (select M3 from (select cast((sum(M3)) as decimal(18,2))M3 from tempDefect_UkuranKhusus_detail) as x) " +
                        /** Total Defect ListPlank **/
                        " set @Total_Defect_ListPlank = (select M3 from (select cast((sum(M3)) as decimal(18,1))M3 from tempDefect_ListPlank_detail) as x) " +
                        /** Total Defect Produksi **/
                        " set @Total_DefectProduksi = cast((@Total_Defect_BMFin + @Total_Defect_UkuranKhusus + @Total_Defect_ListPlank) as decimal(18,0))  " +

                        " select [Group],((M3/@Total_tempDefect_BM_detail)* @TtlBS_Tahap1)  M3 into tempBS_Tahap1_detail from tempDefect_BM_detail order by [group]  " +

                        /** Total Defect **/
                        " select [Group],sum(M3) M3 into tempTotalDefect_detail from ( " +
                        " select * from tempDefect_BM_detail union all " +
                        " select * from tempDefect_Fin_detail union all " +
                        " select * from tempDefect_UkuranKhusus_detail union all " +
                        " select * from tempDefect_ListPlank_detail union all " +
                        " select * from tempBS_Tahap1_detail ) as x group by [Group] " +

                        /** Total Defect Proposionet **/
                        " select  [Group],sum(M3) M3 into tempTotalDefect_Pro_detail from ( " +
                        " select * from tempDefect_ListPlank_detail union all " +
                        " select * from tempDefect_UkuranKhusus_detail union all " +
                        " select * from tempDefect_BM_FN_detail union all " +
                        " select * from tempBS_Tahap1_detail ) as x group by [Group] " +

                        /** Total Potong System QA **/
                        " select  B.[Group],cast((sum(TPotongM3)) as decimal(18,1))M3 into tempTotalPot_QA from BM_Destacking A left join BM_PlantGroup B on A.PlantGroupID=B.ID  inner join (  select C.ID DestID , A.TPotong qtyin,A.TPotong*I.Volume as kubik,A.TPotong*I.Volume TPotongM3 from Def_Defect A   inner join BM_Destacking C on A.DestID=C.ID left join FC_Items I on I.ID=C.ItemID where A.Status>-1 and CONVERT(char,A.tgl,112)>=@thnbln1 and  CONVERT(char,A.tgl,112)<=@thnbln2 ) as C  on A.ID=C.DestID group by B.[Group] ;  " +

                        /** Total Potong System ListPlank Detail per Group**/
                        " select  [Group],sum(M3)M3 into tempTotalPot_SystemLP from ( " +
                        " select * from tempTotalPot_LP_UkuranKhusus union all " +
                        " select * from tempTotalPot_QA ) as x group by [Group] " +

                        ///** Total Potong System All **/
                        //" set @TtlPot_All=cast((select sum(M3)M3 from ( " +
                        //    /** AccReport WIP Out BP, OK, KM **/
                        //" select cast(sum(M3) as decimal(18,1))M3  from (  select sum(Qty)Qty,sum(M3)M3 from (  select *,round((Qty*Volume),2)M3 from (  select sum(A.qty *-1) Qty,(B.Tebal*B.Lebar*B.Panjang)/1000000000 Volume from vw_KartustockWIP A   inner join FC_Items B ON A.itemid0=B.ID  where qty<0   and lokasi in ('H99','B99') and process<>'lari' and process<>'listplank' and left(convert(char,tanggal,112),8)>=@thnbln1  and left(convert(char,tanggal,112),8)<=@thnbln2   group by tebal,lebar,panjang ) as x ) as x1   " +
                        //" union all   " +
                        //" select sum(Qty)Qty,sum(M3)M3 from (  select *,round((Qty*Volume),2)M3 from (  select isnull(SUM(qty)*-1,0)Qty,(I.Tebal*I.Lebar*I.Panjang)/1000000000 Volume from vw_KartustockWIP2 V   inner join FC_Items I on V.itemID=I.ID and (I.partno  like '%-3-%' or I.partno  like '%-M-%' or I.partno  like '%-P-%')     where qty<0  and idrec not like '%ou%'    and process='lari'and lokid1 not in (select ID from fc_lokasi where lokasi='I99') and  left(convert(char,tanggal,112),8)>=@thnbln1 and left(convert(char,tanggal,112),8)<=@thnbln2  group by tebal,lebar,panjang) as x ) as x1 ) as xx  " +
                        //" union all " +
                        //    /** Defect Ukuran Khusus - AccRepot BJ Tahap 1 Out BP, OK, KM **/
                        //" select cast(sum(M3) as decimal(18,1))M from ( " +
                        //" select SUBSTRING(x.partno,1,9)Part,x.PartNo,x.PartnoAsal,x.Qty,((A.Tebal*A.Lebar*A.Panjang)/1000000000)*x.Qty M3 from (   select REPLACE(substring(Keterangan,0,18),'-P-','-1-')Partno,PartNo PartnoAsal,ItemID,isnull(SUM(Qty),0)  * -1 Qty from vw_KartuStockBJNew  where qty <0 and (process  like '%simetris%' ) and  (Keterangan like '%-3-%' or Keterangan like '%-w-%' or  Keterangan like '%-m-%' or Keterangan like '%-P-%') and  LokID not In (select ID from FC_Lokasi where lokasi='q99')   and left(convert(char,tanggal,112),8)>=@thnbln1 and  left(convert(char,tanggal,112),8)<=@thnbln2 and ItemID in (select ID  from FC_Items where PartNo like'%-1-%') group by ItemID,Keterangan,PartNo   ) as x  inner join FC_Items A ON A.ID=x.ItemID ) as x " +
                        //" union all " +
                        //" select cast(sum(M3) as decimal(18,1))M3 from ( " +
                        //    /** Defect LP OK **/
                        //" select isnull(cast((sum(M3)) as decimal(18,1)),0) M3  from (    " +
                        //" select PartnoAsal,isnull(cast((sum(M3)) as decimal(18,5)),0) M3 from (  select PartnoAsal,Qty,cast((((Tebal*Lebar*Panjang)/1000000000)*Qty) as decimal(18,5)) M3  from (  select PartnoAsal,sum(Qty)Qty,Tebal,Lebar,Panjang  from (  select x.PartNo PartnoAsal,x2.Tebal,x2.Lebar,x2.Panjang,x.Qty from (  select sum(Qty)Qty,ItemID,Keterangan Partno from vw_KartuStockBJNew  where sfrom='straping' and left(convert(char,tanggal,112),6)=left(convert(char,@thnbln1,112),6) and ItemID in  (select ID from FC_Items where PartNo like'%-M-%' or PartNo like'%-3-%')  group by ItemID,Keterangan ) as x   inner join FC_Items x2 ON x.ItemID=x2.ID) as A group by PartnoAsal,Tebal,Lebar,Panjang ) as xx ) as xx1 group by PartnoAsal  ) as z  " +
                        //" union all " +
                        //    /** Defect LP BP **/
                        //" select sum(M3)M3 from tempTotalPotong_BP_LP ) as x " +
                        //" union all " +
                        //    /** BS Tahap 1 : AccReport BS Normal dan BS Auto in WiP T1 **/
                        //" select M3 from tempBS_Tahap1 " +
                        //" ) as xx ) as decimal(18,1)) " +

                        /** Total Potong Semua **/
                        /** Defect System OK+BP **/
                        " set @TtlPot_All=isnull((select cast(sum(M3) as decimal(18,2))M3 from ( " +
                        " select sum(M3)M3 from ( " +
                        /** Out B99 Mutasi WiP **/
                        " select cast(@OutBP_WiP as decimal(18,5)) M3 " +
                        " union all " +
                        /** Out OK Mutasi WiP **/
                        " select sum(M3)M3 from ( " +
                        " select sum(Qty)Qty,sum(Qty*Volume) M3 from ( " +
                        " select isnull(SUM(qty)*-1,0)Qty,((B.Tebal*B.Lebar*B.Panjang)/1000000000)Volume from vw_KartustockWIP A " +
                        " inner join FC_Items B ON A.itemid0=B.ID where qty<0 and (lokasi='H99' and process<>'lari' and process<>'listplank') and " +
                        " left(convert(char,tanggal,112),6)=left(convert(char,@thnbln1,112),6) group by B.Tebal,B.Lebar,B.Panjang ) as x " +
                        " union all " +
                        " select sum(Qty)Qty,sum(Qty*Volume) M3 from ( " +
                        " select isnull(SUM(qty)*-1,0)Qty,((I2.Tebal*I2.Lebar*I2.Panjang)/1000000000)Volume from vw_KartustockWIP2 V " +
                        " inner join FC_Items I on V.itemID=I.ID and (I.partno like '%-3-%' or I.PartNo like '%-W-%' or I.PartNo like '%-m-%')  " +
                        " inner join FC_Items I2 ON I2.ID=V.itemid0  " +
                        " where qty<0  and idrec not like '%ou%'   and process='lari' and left(convert(char,tanggal,112),6)=left(convert(char,@thnbln1,112),6) " +
                        " group by I2.Tebal,I2.Lebar,I2.Panjang ) as x " +
                        " ) as xx ) as xx " +
                        " union all " +
                        /** Defect Ukuran Khusus OK + BP	**/
                        " select sum(M3)M3 from ( " +
                        " select SUBSTRING(x.partno,1,9)Part,x.PartNo,x.PartnoAsal,x.Qty,((A.Tebal*A.Lebar*A.Panjang)/1000000000)*x.Qty M3 from (   select REPLACE(substring(Keterangan,0,18),'-P-','-1-')Partno,PartNo PartnoAsal,ItemID,isnull(SUM(Qty),0)  * -1 Qty from vw_KartuStockBJNew  where qty <0 and (process  like '%simetris%' ) and  (Keterangan like '%-3-%' or Keterangan like '%-w-%' or  Keterangan like '%-m-%' or Keterangan like '%-P-%') and  LokID not In (select ID from FC_Lokasi where lokasi='q99')   and left(convert(char,tanggal,112),8)>=@thnbln1 and  left(convert(char,tanggal,112),8)<=@thnbln2 and ItemID in (select ID  from FC_Items where PartNo like'%-1-%') group by ItemID,Keterangan,PartNo   ) as x  inner join FC_Items A ON A.ID=x.ItemID ) as x " +
                        " union all    " +
                        " select @Total_Defect_ListPlank  /** Defect LP BP **/ " +
                        " union all  " +
                        " select M3 from tempTtlOK_LP  /** Defect LP OK **/ " +
                        " union all " +
                        " select @TtlBS_Tahap1  /** BS Tahap 1 **/ " +
                        " ) as AA),0) " +

                        " set @Selisih_TotPot=isnull(cast((select sum(M3) M3 from ( " +
                        " select cast(sum(M3) as decimal(18,2))* -1 M3 from tempTotalPot_SystemLP union all " +
                        " select cast(@TtlPot_All as decimal(18,2))  M3  " +
                        " ) as x)as decimal(18,5)),0) " +

                        //" select [Group],sum(M3) M3 into tempSelisih_TotPot from ( " +
                        //" select [Group],cast(@Selisih_TotPot as decimal(18,5))/cast(@TotGroup_LP_UKhusus as decimal(18,5))M3 from tempGroup_LPUK A " +
                        //" union all " +
                        //" select [Group],cast('0' as decimal(18,0))M3 from tempData_Group) as x group by [Group] " +

                        /** Baru **/
                        " select [Group],sum(M3) M3 into tempSelisih_TotPot from ( " +
                        " select [Group],nullif(cast(@Selisih_TotPot as decimal(18,5)),0)/nullif(cast(@Tot_GP as decimal(18,5)),0)M3 from tempGroup3 A " +
                        " union all " +
                        " select [Group],cast('0' as decimal(18,0))M3 from tempGroup3) as x group by [Group] " +


                        /** Total Potong Proposionet **/
                        " select [Group],sum(M3)M3 into tempTotPot_Proposionet from ( " +
                        " select * from tempSelisih_TotPot union all " +
                        " select * from tempTotalPot_SystemLP ) as x group by [Group] " +

                        " select [Group],((M3/@Total_tempDefect_BM_detail)*@Tot_OKKM)  M3 into temp_OKKM from tempDefect_BM_detail order by [group]  " +
                        " select [Group],((M3/@Total_tempDefect_BM_detail)*@Tot_Retur)  M3 into temp_Retur from tempDefect_BM_detail order by [group]  " +
                        " select [Group],((M3/@Total_tempDefect_BM_detail)*@Tot_Sortir)  M3 into temp_Sortir from tempDefect_BM_detail order by [group] " +

                        " select [Group],sum(M3)M3 into temp_TotalDefect from ( " +
                        " select [Group],M3 from tempTotalDefect_Pro_detail union all " +
                        " select [Group],M3 from temp_Retur union all " +
                        " select [Group],M3 from temp_Sortir union all " +
                        " select [Group],M3*-1 from temp_OKKM ) as x group by [Group] " +

                        " select [Group],M3 * 100 M3 into temp_Persen from ( " +
                        " select [Group],isnull(M3/(select NULLIF(M3,0) from tempTotPot_Proposionet A where A.[Group]=B.[Group]),0) M3  from temp_TotalDefect B ) as x " +

                        /** Kumpulkan semua data **/
                        " select [Group],sum(M3) DefectBM_M3,sum(B)DefectFin_M3,sum(C)Selisih_Ttl_Ptg,sum(D)Defect_BMFIN,sum(E)Defect_UKhusus,sum(F)Defect_ListPlank,sum(G)Defect_Produksi,sum(H)BS_Tahap1,sum(T)Total_Defect0,sum(I)Total_Defect_Pro,sum(J)Total_Pot_SystemQA,sum(K)Total_Pot_LP_UK,sum(L)Total_Pot_SystemLP,sum(M)Selisih_TotPot,sum(N)TotPot_Proposionet,sum(O)OK_KM,sum(P)Retur,sum(Q)Sortir,cast(sum(R) as decimal(18,0))Total_Defect,sum(S)Persen into temp_Total " +
                        " from ( " +
                        " select [Group],M3,'0'B,'0'C,'0'D,'0'E,'0'F,'0'G,'0'H,'0'I,'0'J,'0'K,'0'L,'0'M,'0'N,'0'O,'0'P,'0'Q,'0'R,'0'S,'0'T from tempDefect_BM_detail " +
                        " union all " +
                        " select [Group],'0'A,M3,'0'C,'0'D,'0'E,'0'F,'0'G,'0'H,'0'I,'0'J,'0'K,'0'L,'0'M,'0'N,'0'O,'0'P,'0'Q,'0'R,'0'S,'0'T from tempDefect_Fin_detail " +
                        " union all " +
                        " select [Group],'0'A,'0'B,M3,'0'D,'0'E,'0'F,'0'G,'0'H,'0'I,'0'J,'0'K,'0'L,'0'M,'0'N,'0'O,'0'P,'0'Q,'0'R,'0'S,'0'T from Selisih_ttl_defect_Detail " +
                        " union all " +
                        " select [Group],'0'A,'0'B,'0'C,M3,'0'E,'0'F,'0'G,'0'H,'0'I,'0'J,'0'K,'0'L,'0'M,'0'N,'0'O,'0'P,'0'Q,'0'R,'0'S,'0'T from tempDefect_BM_FN_detail  " +
                        " union all " +
                        " select [Group],'0'A,'0'B,'0'C,'0'D,M3,'0'F,'0'G,'0'H,'0'I,'0'J,'0'K,'0'L,'0'M,'0'N,'0'O,'0'P,'0'Q,'0'R,'0'S,'0'T from tempDefect_UkuranKhusus_detail  " +
                        " union all " +
                        " select [Group],'0'A,'0'B,'0'C,'0'D,'0'E,M3,'0'G,'0'H,'0'I,'0'J,'0'K,'0'L,'0'M,'0'N,'0'O,'0'P,'0'Q,'0'R,'0'S,'0'T from tempDefect_ListPlank_detail " +
                        " union all " +
                        " select [Group],'0'A,'0'B,'0'C,'0'D,'0'E,'0'F,M3,'0'H,'0'I,'0'J,'0'K,'0'L,'0'M,'0'N,'0'O,'0'P,'0'Q,'0'R,'0'S,'0'T from tempDefect_Produksi_detail " +
                        " union all " +
                        " select [Group],'0'A,'0'B,'0'C,'0'D,'0'E,'0'F,'0'G,M3,'0'I,'0'J,'0'K,'0'L,'0'M,'0'N,'0'O,'0'P,'0'Q,'0'R,'0'S,'0'T from tempBS_Tahap1_detail " +
                        " union all " +
                        " select [Group],'0'A,'0'B,'0'C,'0'D,'0'E,'0'F,'0'G,'0'H,M3,'0'J,'0'K,'0'L,'0'M,'0'N,'0'O,'0'P,'0'Q,'0'R,'0'S,'0'T from tempTotalDefect_Pro_detail " +
                        " union all " +
                        " select [Group],'0'A,'0'B,'0'C,'0'D,'0'E,'0'F,'0'G,'0'H,'0'I,M3,'0'K,'0'L,'0'M,'0'N,'0'O,'0'P,'0'Q,'0'R,'0'S,'0'T from tempTotalPot_QA " +
                        " union all " +
                        " select [Group],'0'A,'0'B,'0'C,'0'D,'0'E,'0'F,'0'G,'0'H,'0'I,'0'J,M3,'0'L,'0'M,'0'N,'0'O,'0'P,'0'Q,'0'R,'0'S,'0'T from tempTotalPot_LP_UkuranKhusus " +
                        " union all " +
                        " select [Group],'0'A,'0'B,'0'C,'0'D,'0'E,'0'F,'0'G,'0'H,'0'I,'0'J,'0'K,M3,'0'M,'0'N,'0'O,'0'P,'0'Q,'0'R,'0'S,'0'T from tempTotalPot_SystemLP " +
                        " union all " +
                        " select [Group],'0'A,'0'B,'0'C,'0'D,'0'E,'0'F,'0'G,'0'H,'0'I,'0'J,'0'K,'0'L,M3,'0'N,'0'O,'0'P,'0'Q,'0'R,'0'S,'0'T from tempSelisih_TotPot " +
                        " union all " +
                        " select [Group],'0'A,'0'B,'0'C,'0'D,'0'E,'0'F,'0'G,'0'H,'0'I,'0'J,'0'K,'0'L,'0'M,M3,'0'O,'0'P,'0'Q,'0'R,'0'S,'0'T from tempTotPot_Proposionet " +
                        " union all " +
                        " select [Group],'0'A,'0'B,'0'C,'0'D,'0'E,'0'F,'0'G,'0'H,'0'I,'0'J,'0'K,'0'L,'0'M,'0'N,M3,'0'P,'0'Q,'0'R,'0'S,'0'T from temp_OKKM " +
                        " union all " +
                        " select [Group],'0'A,'0'B,'0'C,'0'D,'0'E,'0'F,'0'G,'0'H,'0'I,'0'J,'0'K,'0'L,'0'M,'0'N,'0'O,M3,'0'Q,'0'R,'0'S,'0'T from temp_Retur " +
                        " union all " +
                        " select [Group],'0'A,'0'B,'0'C,'0'D,'0'E,'0'F,'0'G,'0'H,'0'I,'0'J,'0'K,'0'L,'0'M,'0'N,'0'O,'0'P,M3,'0'R,'0'S,'0'T from temp_Sortir " +
                        " union all " +
                        " select [Group],'0'A,'0'B,'0'C,'0'D,'0'E,'0'F,'0'G,'0'H,'0'I,'0'J,'0'K,'0'L,'0'M,'0'N,'0'O,'0'P,'0'Q,M3,'0'S,'0'T from temp_TotalDefect " +
                        " union all " +
                        " select [Group],'0'A,'0'B,'0'C,'0'D,'0'E,'0'F,'0'G,'0'H,'0'I,'0'J,'0'K,'0'L,'0'M,'0'N,'0'O,'0'P,'0'Q,'0'R,M3,'0'T from temp_Persen " +
                        " union all" +
                        " select [Group],'0'A,'0'B,'0'C,'0'D,'0'E,'0'F,'0'G,'0'H,'0'I,'0'J,'0'K,'0'L,'0'M,'0'N,'0'O,'0'P,'0'Q,'0'R,'0'S,M3 from tempTotalDefect_detail " +
                        " ) as x group by [Group] order by [Group] " +

                        " select * into temp_DataDefectISO from ( " +
                        " select [Group],cast((DefectBM_M3) as decimal(18,1))DefectBM_M3,cast((DefectFin_M3)as decimal(18,1))DefectFin_M3,cast((Selisih_Ttl_Ptg)as decimal(18,1))Selisih_Ttl_Ptg,cast((Defect_BMFIN)as decimal(18,1))Defect_BMFIN,cast((Defect_UKhusus)as decimal(18,1))Defect_UKhusus,cast((Defect_ListPlank)as decimal(18,1))Defect_ListPlank,cast((Defect_Produksi)as decimal(18,1))Defect_Produksi,cast((BS_Tahap1)as decimal(18,1))BS_Tahap1,cast((Total_Defect0)as decimal(18,1))Total_Defect0,cast((Total_Defect_Pro)as decimal(18,1))Total_Defect_Pro,cast((Total_Pot_SystemQA)as decimal(18,1))Total_Pot_SystemQA,cast((Total_Pot_LP_UK)as decimal(18,1))Total_Pot_LP_UK,cast((Total_Pot_SystemLP)as decimal(18,1))Total_Pot_SystemLP,cast((Selisih_TotPot)as decimal(18,1))Selisih_TotPot,cast((TotPot_Proposionet)as decimal(18,1))TotPot_Proposionet,cast((OK_KM)as decimal(18,1))OK_KM,cast((Retur)as decimal(18,1))Retur,cast((Sortir)as decimal(18,1))Sortir,cast((Total_Defect)as decimal(18,1))Total_Defect,isnull(cast(((Total_Defect)/(nullif(TotPot_Proposionet,0)))*100 as decimal(18,1)),0)Persentase from temp_Total " +
                        " union all " +
                        " select 'Total'Total,cast(sum(DefectBM_M3) as decimal(18,1)),cast(sum(DefectFin_M3)as decimal(18,1)),cast(sum(Selisih_Ttl_Ptg)as decimal(18,1)),cast(sum(Defect_BMFIN)as decimal(18,1)),cast(sum(Defect_UKhusus)as decimal(18,1)),cast(sum(Defect_ListPlank)as decimal(18,1)),cast(sum(Defect_Produksi)as decimal(18,1)),cast(sum(BS_Tahap1)as decimal(18,1)),cast(sum(Total_Defect0)as decimal(18,1)),cast(sum(Total_Defect_Pro)as decimal(18,1)),cast(sum(Total_Pot_SystemQA)as decimal(18,1)),cast(sum(Total_Pot_LP_UK)as decimal(18,1)),cast(sum(Total_Pot_SystemLP)as decimal(18,1)),cast(sum(Selisih_TotPot)as decimal(18,1)),cast(sum(TotPot_Proposionet)as decimal(18,1)),cast(sum(OK_KM)as decimal(18,1)),cast(sum(Retur)as decimal(18,1)),cast(sum(Sortir)as decimal(18,1)),cast(sum(Total_Defect)as decimal(18,1)),cast((sum(Total_Defect)/sum(TotPot_Proposionet))*100 as decimal(18,1)) from temp_Total " +
                        " ) as x " +

                        #endregion
                        #region Temp Table2
                        #region Line - 1
 " declare @TotalPotong decimal(18,2) " +
                        " declare @TotalDefKhusus decimal(18,2)   " +
                        " declare @DefKhusus decimal(18,2)   " +
                        " declare @Ttotalkw1kw2 decimal(18,2)  " +
                        " declare @NCSortir decimal(18,2)   " +
                        " declare @Retur decimal(18,2)  " +
                        " set @TotalPotong=isnull((select sum(totkubik ) from tempdefectGPIsoTot),0) " +

                        " declare @TotalPotongL1 decimal(18,2) " +
                        " declare @TotDefKhususL1 decimal(18,2)  " +
                        " declare @DefKhususL1 decimal(18,2)  " +
                        " declare @Ttotalkw1kw2L1 decimal(18,2)  " +
                        " declare @NCSortirL1 decimal(18,2)  " +
                        " declare @ReturL1 decimal(18,2)  " +
                        " declare @DefectFinL1 decimal(18,2) " +

                        //" set @TotalPotongL1=(select isnull(sum(totkubik ),0) from tempdefectGPIsoTot where [group]in (select [group] from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 1'))) " +
                        " set @TotalPotongL1=isnull((select sum(M3) from tempTotPot_Proposionet where [group]in (select [group] from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 1'))),0) " +
                        " set @TotDefKhususL1=(@TotalPotongL1/@TotalPotong)*@TotalDefKhusus " +
                        " set @DefKhususL1=(@TotalPotongL1/@TotalPotong)*@DefKhusus " +
                        " set @Ttotalkw1kw2L1=(@TotalPotongL1/@TotalPotong)*@Ttotalkw1kw2 " +
                        " set @NCSortirL1=(@TotalPotongL1/@TotalPotong)*@NCSortir " +
                        " set @ReturL1=(@TotalPotongL1/@TotalPotong)*@Retur " +
                        //" set @DefectFinL1=isnull((@TotalPotongL1/@TotalPotong)*@DefectFin,0) " +

                        " if @TotalPotongL1>0 " +
                        " begin " +
                        " select [Group],cast((b) as decimal(18,2))b,cast((c) as decimal(18,2))c,cast((d) as decimal(18,2))d,cast((e) as decimal(18,2))e,cast((f) as decimal(18,2))f,cast((g) as decimal(18,2))g,cast((i) as decimal(18,2))i,j into tempdefectL1 from ( " +
                        " select * from ( " +
                        " select [Group], " +
                        " case when @TotalPotongL1>0 then isnull((select cast((TotPot_Proposionet) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)  else 0 end b, " +
                        " case when @TotalPotongL1>0 then ((isnull((select cast((Defect_Produksi) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end c, " +
                        " case when @TotalPotongL1>0 then ((isnull((select cast((OK_KM) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0))) else 0 end  d,  " +
                        " case when @TotalPotongL1>0 then ((isnull((select cast((Sortir) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  e, " +
                        " case when @TotalPotongL1>0 then ((isnull((select cast((Retur) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  f, " +
                        " case when @TotalPotongL1>0 then ((isnull((select cast((BS_Tahap1) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end g,  " +
                        " case when @TotalPotongL1>0 then ((isnull((select cast((Total_Defect) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end i, " +
                        " case when @TotalPotongL1>0 then ((isnull((select cast((Persentase) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end j " +

                        " from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 1') )A " +

                        " union all  " +

                        " select 'Total' [Group],sum(b)b,sum(c)c,sum(d)d,sum(e)e,sum(f)f,sum(g)g,sum(i) i,(sum(nullif(i,0))/sum(b))*100 j" +
                        "  from( " +
                        " select [Group], " +
                        " case when @TotalPotongL1>0 then isnull((select cast((TotPot_Proposionet) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)  else 0 end b,  " +
                        " case when @TotalPotongL1>0 then ((isnull((select cast((Defect_Produksi) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end c,  " +
                        " case when @TotalPotongL1>0 then ((isnull((select cast((OK_KM) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0))) else 0 end  d, " +
                        " case when @TotalPotongL1>0 then ((isnull((select cast((Sortir) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  e,  " +
                        " case when @TotalPotongL1>0 then ((isnull((select cast((Retur) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  f,  " +
                        " case when @TotalPotongL1>0 then ((isnull((select cast((BS_Tahap1) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end g,  " +
                        " case when @TotalPotongL1>0 then ((isnull((select cast((Total_Defect) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end i, " +
                        " case when @TotalPotongL1>0 then ((isnull((select cast((Persentase) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end j " +
                        " from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 1'))A )B " +
                        " end " +
                        " else " +
                        " begin " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 i, 0 j into tempdefectL1 " +
                        " end " +
                        #endregion
 " " +
                        #region Line - 2
 " declare @TotalPotongL2 decimal(18,2) " +
                        " declare @TotDefKhususL2 decimal(18,2) " +
                        " declare @DefKhususL2 decimal(18,2) " +
                        " declare @Ttotalkw1kw2L2 decimal(18,2) " +
                        " declare @NCSortirL2 decimal(18,2) " +
                        " declare @ReturL2 decimal(18,2) " +
                        " declare @DefectFinL2 decimal(18,2) " +

                        //" set @TotalPotongL2=(select isnull(sum(totkubik ),0) from tempdefectGPIsoTot where [group]in (select [group] from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 2'))) " +
                        " set @TotalPotongL2=isnull((select sum(M3) from tempTotPot_Proposionet where [group]in (select [group] from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 2'))),0) " +
                        " set @TotDefKhususL2=(@TotalPotongL2/@TotalPotong)*@TotalDefKhusus " +
                        " set @DefKhususL2=(@TotalPotongL2/@TotalPotong)*@DefKhusus " +
                        " set @Ttotalkw1kw2L2=(@TotalPotongL2/@TotalPotong)*@Ttotalkw1kw2 " +
                        " set @NCSortirL2=(@TotalPotongL2/@TotalPotong)*@NCSortir " +
                        " set @ReturL2=(@TotalPotongL2/@TotalPotong)*@Retur " +
                        //" set @DefectFinL2=isnull((@TotalPotongL2/@TotalPotong)*@DefectFin,0) " +

                        " if @TotalPotongL2>0 " +
                        " begin " +
                        " select [Group],cast((b) as decimal(18,1))b,cast((c) as decimal(18,1))c,cast((d) as decimal(18,1))d,cast((e) as decimal(18,1))e,cast((f) as decimal(18,1))f,cast((g) as decimal(18,1))g,cast((i) as decimal(18,1))i,j into tempdefectL2 from ( " +
                        " select * from ( " +
                        " select [Group], " +
                        " case when @TotalPotongL2>0 then isnull((select cast((TotPot_Proposionet) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)  else 0 end b,  " +
                        " case when @TotalPotongL2>0 then ((isnull((select cast((Defect_Produksi) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end c,  " +
                        " case when @TotalPotongL2>0 then ((isnull((select cast((OK_KM) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0))) else 0 end  d, " +
                        " case when @TotalPotongL2>0 then ((isnull((select cast((Sortir) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  e,  " +
                        " case when @TotalPotongL2>0 then ((isnull((select cast((Retur) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  f,  " +
                        " case when @TotalPotongL2>0 then ((isnull((select cast((BS_Tahap1) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end g , " +
                        " case when @TotalPotongL2>0 then ((isnull((select cast((Total_Defect) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end i, " +
                        " case when @TotalPotongL2>0 then ((isnull((select cast((Persentase) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end j " +
                        " from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 2') )A " +

                        " union all  " +

                        " select 'Total' [Group],sum(b)b,sum(c)c,sum(d)d,sum(e)e,sum(f)f,sum(g)g,sum(i) i,(sum(nullif(i,0))/sum(b))*100 j " +
                        " from( " +
                        //" " + logika3 + " " +
                        " select [Group], " +
                        " case when @TotalPotongL2>0 then isnull((select cast((TotPot_Proposionet) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)  else 0 end b,  " +
                        " case when @TotalPotongL2>0 then ((isnull((select cast((Defect_Produksi) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end c,  " +
                        " case when @TotalPotongL2>0 then ((isnull((select cast((OK_KM) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0))) else 0 end  d, " +
                        " case when @TotalPotongL2>0 then ((isnull((select cast((Sortir) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  e,  " +
                        " case when @TotalPotongL2>0 then ((isnull((select cast((Retur) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  f,  " +
                        " case when @TotalPotongL2>0 then ((isnull((select cast((BS_Tahap1) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end g,  " +
                        " case when @TotalPotongL2>0 then ((isnull((select cast((Total_Defect) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end i, " +
                        " case when @TotalPotongL2>0 then ((isnull((select cast((Persentase) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end j " +
                        " from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 2'))A )B " +
                        " end " +
                        " else " +
                        " begin " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 i, 0 j into tempdefectL2 " +
                        " end " +
                        #endregion
 " " +
                        #region Lin3 - 3
 " declare @TotalPotongL3 decimal(18,2) " +
                        " declare @TotDefKhususL3 decimal(18,2) " +
                        " declare @DefKhususL3 decimal(18,2) " +
                        " declare @Ttotalkw1kw2L3 decimal(18,2) " +
                        " declare @NCSortirL3 decimal(18,2) " +
                        " declare @ReturL3 decimal(18,2) " +
                        " declare @DefectFinL3 decimal(18,2) " +

                        //" set @TotalPotongL3=(select isnull(sum(totkubik ),0) from tempdefectGPIsoTot where [group]in (select [group] from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 3'))) " +
                        " set @TotalPotongL3=isnull((select sum(M3) from tempTotPot_Proposionet where [group]in (select [group] from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 3'))),0) " +
                        " set @TotDefKhususL3=(@TotalPotongL3/@TotalPotong)*@TotalDefKhusus " +
                        " set @DefKhususL3=(@TotalPotongL3/@TotalPotong)*@DefKhusus " +
                        " set @Ttotalkw1kw2L3=(@TotalPotongL3/@TotalPotong)*@Ttotalkw1kw2 " +
                        " set @NCSortirL3=(@TotalPotongL3/@TotalPotong)*@NCSortir " +
                        " set @ReturL3=(@TotalPotongL3/@TotalPotong)*@Retur " +

                        " if @TotalPotongL3>0 " +
                        " begin " +
                        " select [Group],cast((b) as decimal(18,1))b,cast((c) as decimal(18,1))c,cast((d) as decimal(18,1))d,cast((e) as decimal(18,1))e,cast((f) as decimal(18,1))f,cast((g) as decimal(18,1))g,cast((i) as decimal(18,1))i,j into tempdefectL3 from ( " +
                        " select * from ( select [Group], " +
                        " case when @TotalPotongL3>0 then isnull((select cast((TotPot_Proposionet) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)  else 0 end b,  " +
                        " case when @TotalPotongL3>0 then ((isnull((select cast((Defect_Produksi) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end c,  " +
                        " case when @TotalPotongL3>0 then ((isnull((select cast((OK_KM) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0))) else 0 end  d, " +
                        " case when @TotalPotongL3>0 then ((isnull((select cast((Sortir) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  e,  " +
                        " case when @TotalPotongL3>0 then ((isnull((select cast((Retur) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  f,  " +
                        " case when @TotalPotongL3>0 then ((isnull((select cast((BS_Tahap1) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end g,  " +
                        " case when @TotalPotongL3>0 then ((isnull((select cast((Total_Defect) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end i, " +
                        " case when @TotalPotongL3>0 then ((isnull((select cast((Persentase) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end j " +
                        "  from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 3') )A " +

                        " union all  " +

                        " select 'Total' [Group],sum(b)b,sum(c)c,sum(d)d,sum(e)e,sum(f)f,sum(g)g,sum(i) i,(sum(nullif(i,0))/sum(b))*100 j " +
                        " from( " +
                        " select [Group], " +
                        " case when @TotalPotongL3>0 then isnull((select cast((TotPot_Proposionet) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)  else 0 end b,  " +
                        " case when @TotalPotongL3>0 then ((isnull((select cast((Defect_Produksi) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end c,  " +
                        " case when @TotalPotongL3>0 then ((isnull((select cast((OK_KM) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0))) else 0 end  d, " +
                        " case when @TotalPotongL3>0 then ((isnull((select cast((Sortir) as decimal(18,2))M33 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  e,  " +
                        " case when @TotalPotongL3>0 then ((isnull((select cast((Retur) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  f,  " +
                        " case when @TotalPotongL3>0 then ((isnull((select cast((BS_Tahap1) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end g,  " +
                        " case when @TotalPotongL3>0 then ((isnull((select cast((Total_Defect) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end i, " +
                        " case when @TotalPotongL3>0 then ((isnull((select cast((Persentase) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end j " +
                        " from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 3'))A )B " +
                        " end " +
                        " else " +
                        " begin " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 i, 0 j into tempdefectL3 " +
                        " end " +
                        #endregion
 " " +
                        #region Line - 4
 " declare @TotalPotongL4 decimal(18,2) " +
                        " declare @TotDefKhususL4 decimal(18,2) " +
                        " declare @DefKhususL4 decimal(18,2) " +
                        " declare @Ttotalkw1kw2L4 decimal(18,2) " +
                        " declare @NCSortirL4 decimal(18,2) " +
                        " declare @ReturL4 decimal(18,2) " +
                        " declare @DefectFinL4 decimal(18,2) " +

                        //" set @TotalPotongL4=(select isnull(sum(totkubik ),0) from tempdefectGPIsoTot where [group]in (select [group] from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 4'))) " +
                        " set @TotalPotongL4=isnull((select sum(M3) from tempTotPot_Proposionet where [group]in (select [group] from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 4'))),0) " +
                        " set @TotDefKhususL4=(@TotalPotongL4/@TotalPotong)*@TotalDefKhusus " +
                        " set @DefKhususL4=(@TotalPotongL4/@TotalPotong)*@DefKhusus " +
                        " set @Ttotalkw1kw2L4=(@TotalPotongL4/@TotalPotong)*@Ttotalkw1kw2 " +
                        " set @NCSortirL4=(@TotalPotongL4/@TotalPotong)*@NCSortir " +
                        " set @ReturL4=(@TotalPotongL4/@TotalPotong)*@Retur " +
                        //" set @DefectFinL4=isnull((@TotalPotongL4/@TotalPotong)*@DefectFin,0) " +

                        " if @TotalPotongL4>0 " +
                        " begin " +
                        " select [Group],cast((b) as decimal(18,1))b,cast((c) as decimal(18,1))c,cast((d) as decimal(18,1))d,cast((e) as decimal(18,1))e,cast((f) as decimal(18,1))f,cast((g) as decimal(18,1))g,cast((i) as decimal(18,1))i,j into tempdefectL4 from ( " +
                        " select * from ( " +
                        " select [Group], " +
                        " case when @TotalPotongL4>0 then isnull((select cast((TotPot_Proposionet) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)  else 0 end b,  " +
                        " case when @TotalPotongL4>0 then ((isnull((select cast((Defect_Produksi) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end c,  " +
                        " case when @TotalPotongL4>0 then ((isnull((select cast((OK_KM) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0))) else 0 end  d, " +
                        " case when @TotalPotongL4>0 then ((isnull((select cast((Sortir) as decimal(18,2))M33 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  e,  " +
                        " case when @TotalPotongL4>0 then ((isnull((select cast((Retur) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  f,  " +
                        " case when @TotalPotongL4>0 then ((isnull((select cast((BS_Tahap1) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end g,  " +
                        " case when @TotalPotongL4>0 then ((isnull((select cast((Total_Defect) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end i, " +
                        " case when @TotalPotongL4>0 then ((isnull((select cast((Persentase) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end j " +
                        " from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 4') )A " +

                        " union all  " +

                        " select 'Total' [Group],sum(b)b,sum(c)c,sum(d)d,sum(e)e,sum(f)f,sum(g)g,sum(i)i,(sum(nullif(i,0))/sum(b))*100 j" +
                        " from( " +
                        " select [Group], " +
                        " ((isnull((select cast((TotPot_Proposionet) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0))) b, " +
                        " ((isnull((select cast((Defect_Produksi) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0))) c, " +
                        " ((isnull((select cast((OK_KM) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0))) d, " +
                        " ((isnull((select cast((Sortir) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0))) e, " +
                        " ((isnull((select cast((Retur) as decimal(18,2))M33 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0))) f, " +
                        " ((isnull((select cast((BS_Tahap1) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0))) g, " +
                        " ((isnull((select cast((Total_Defect) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0))) i, " +
                        " ((isnull((select cast((Persentase) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0))) j " +
                        " from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 4'))A )B " +
                        " end " +
                        " else " +
                        " begin " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 i, 0 j into tempdefectL4 " +
                        " end " +
                        #endregion
 " " +
                        #region Line - 5
 " declare @TotalPotongL5 decimal(18,2) " +
                        " declare @TotDefKhususL5 decimal(18,2) " +
                        " declare @DefKhususL5 decimal(18,2) " +
                        " declare @Ttotalkw1kw2L5 decimal(18,2) " +
                        " declare @NCSortirL5 decimal(18,2) " +
                        " declare @ReturL5 decimal(18,2) " +
                        " declare @DefectFinL5 decimal(18,2) " +

                        //" set @TotalPotongL5=(select isnull(sum(totkubik ),0) from tempdefectGPIsoTot where [group]in (select [group] from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 5'))) " +
                        " set @TotalPotongL5=isnull((select sum(M3) from tempTotPot_Proposionet where [group]in (select [group] from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 5'))),0) " +
                        " set @TotDefKhususL5=(@TotalPotongL5/@TotalPotong)*@TotalDefKhusus " +
                        " set @DefKhususL5=(@TotalPotongL5/@TotalPotong)*@DefKhusus " +
                        " set @Ttotalkw1kw2L5=(@TotalPotongL5/@TotalPotong)*@Ttotalkw1kw2 " +
                        " set @NCSortirL5=(@TotalPotongL5/@TotalPotong)*@NCSortir " +
                        " set @ReturL5=(@TotalPotongL5/@TotalPotong)*@Retur " +
                        //" set @DefectFinL5=isnull((@TotalPotongL5/@TotalPotong)*@DefectFin,0) " +

                        " if @TotalPotongL5>0 " +
                        " begin " +
                        " select [Group],cast((b) as decimal(18,1))b,cast((c) as decimal(18,1))c,cast((d) as decimal(18,1))d,cast((e) as decimal(18,1))e,cast((f) as decimal(18,1))f,cast((g) as decimal(18,1))g,cast((i) as decimal(18,1))i,j into tempdefectL5 from ( " +
                        " select * from ( " +
                        " select [Group], " +
                        " case when @TotalPotongL5>0 then isnull((select cast((TotPot_Proposionet) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)  else 0 end b,  " +
                        " case when @TotalPotongL5>0 then ((isnull((select cast((Defect_Produksi) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end c,  " +
                        " case when @TotalPotongL5>0 then ((isnull((select cast((OK_KM) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0))) else 0 end  d, " +
                        " case when @TotalPotongL5>0 then ((isnull((select cast((Sortir) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  e,  " +
                        " case when @TotalPotongL5>0 then ((isnull((select cast((Retur) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  f,  " +
                        " case when @TotalPotongL5>0 then ((isnull((select cast((BS_Tahap1) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end g,  " +
                        " case when @TotalPotongL5>0 then ((isnull((select cast((Total_Defect) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end i, " +
                        " case when @TotalPotongL5>0 then ((isnull((select cast((Persentase) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end j " +
                        " from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 5') )A " +

                        "union all  " +

                        " select 'Total' [Group],sum(b)b,sum(c)c,sum(d)d,sum(e)e,sum(f)f,sum(g)g,sum(i)i,(sum(nullif(i,0))/sum(b))*100 j " +
                        " from( " +
                        " select [Group], " +
                        " ((isnull((select cast((TotPot_Proposionet) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0))) b, " +
                        " ((isnull((select cast((Defect_Produksi) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0))) c, " +
                        " ((isnull((select cast((OK_KM) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0))) d, " +
                        " ((isnull((select cast((Sortir) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0))) e, " +
                        " ((isnull((select cast((Retur) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0))) f, " +
                        " ((isnull((select cast((BS_Tahap1) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0))) g, " +
                        " ((isnull((select cast((Total_Defect) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0))) i, " +
                        " ((isnull((select cast((Persentase) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0))) j " +
                        " from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 5'))A )B " +
                        " end " +
                        " else " +
                        " begin " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 i, 0 j into tempdefectL5 " +
                        " end " +
                        #endregion
 " " +
                        #region Line - 6
 " declare @TotalPotongL6 decimal(18,2) " +
                        " declare @TotDefKhususL6 decimal(18,2) " +
                        " declare @DefKhususL6 decimal(18,2) " +
                        " declare @Ttotalkw1kw2L6 decimal(18,2) " +
                        " declare @NCSortirL6 decimal(18,2) " +
                        " declare @ReturL6 decimal(18,2) " +
                        " declare @DefectFinL6 decimal(18,2) " +

                        //" set @TotalPotongL6=(select isnull(sum(totkubik ),0) from tempdefectGPIsoTot where [group]in (select [group] from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 6'))) " +
                        " set @TotalPotongL6=isnull((select sum(M3) from tempTotPot_Proposionet where [group]in (select [group] from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 6'))),0) " +
                        " set @TotDefKhususL6=(@TotalPotongL6/@TotalPotong)*@TotalDefKhusus " +
                        " set @DefKhususL6=(@TotalPotongL6/@TotalPotong)*@DefKhusus " +
                        " set @Ttotalkw1kw2L6=(@TotalPotongL6/@TotalPotong)*@Ttotalkw1kw2 " +
                        " set @NCSortirL6=(@TotalPotongL6/@TotalPotong)*@NCSortir " +
                        " set @ReturL6=(@TotalPotongL6/@TotalPotong)*@Retur " +
                        //" set @DefectFinL6=isnull((@TotalPotongL6/@TotalPotong)*@DefectFin,0) " +

                        " if @TotalPotongL6>0 " +
                        " begin " +
                        " select [Group],cast((b) as decimal(18,1))b,cast((c) as decimal(18,1))c,cast((d) as decimal(18,1))d,cast((e) as decimal(18,1))e,cast((f) as decimal(18,1))f,cast((g) as decimal(18,1))g,cast((i) as decimal(18,1))i,cast((j) as decimal(18,1))j into tempdefectL6 from ( " +
                        " select * from ( " +
                        " select [Group], " +
                        " case when @TotalPotongL6>0 then isnull((select cast((TotPot_Proposionet) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)  else 0 end b,  " +
                        " case when @TotalPotongL6>0 then ((isnull((select cast((Defect_Produksi) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end c,  " +
                        " case when @TotalPotongL6>0 then ((isnull((select cast((OK_KM) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0))) else 0 end  d, " +
                        " case when @TotalPotongL6>0 then ((isnull((select cast((Sortir) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  e,  " +
                        " case when @TotalPotongL6>0 then ((isnull((select cast((Retur) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  f,  " +
                        " case when @TotalPotongL6>0 then ((isnull((select cast((BS_Tahap1) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end g,  " +
                        " case when @TotalPotongL6>0 then ((isnull((select cast((Total_Defect) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end i, " +
                        " case when @TotalPotongL6>0 then ((isnull((select cast((Persentase) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end j " +
                        " from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 6') )A " +

                        "union all  " +

                        " select 'Total' [Group],sum(b)b,sum(c)c,sum(d)d,sum(e)e,sum(f)f,sum(g)g,sum(i)i,(sum(nullif(i,0))/sum(b))*100 j " +
                        " from( " +
                        " select [Group], " +
                        " ((isnull((select cast((TotPot_Proposionet) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0))) b, " +
                        " ((isnull((select cast((Defect_Produksi) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0))) c, " +
                        " ((isnull((select cast((OK_KM) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0))) d, " +
                        " ((isnull((select cast((Sortir) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0))) e, " +
                        " ((isnull((select cast((Retur) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0))) f, " +
                        " ((isnull((select cast((BS_Tahap1) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0))) g, " +
                        " ((isnull((select cast((Total_Defect) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0))) i, " +
                        " ((isnull((select cast((Persentase) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0))) j " +
                        " from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 6'))A )B " +
                        " end " +
                        " else " +
                        " begin " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 i, 0 j into tempdefectL6 " +
                        " end " +
                        #endregion

                        //" select [group],cast((b) as decimal(18,2))b,cast((c) as decimal(18,2))c,cast((d) as decimal(18,2))d,cast((e) as decimal(18,2))e,cast((f) as decimal(18,2))f,case when [group]<>'total' then cast((g) as decimal(18,2)) when [group]='total' then cast((g) as decimal(18,2)) end g,i,j from tempdefectL1 " +

                        " select [group],b,c,d,e,f,g,i,case when [group]='total' then cast((i/b)*100 as decimal(18,1)) else j end j from ( " +
            " select [group],cast((b) as decimal(18,0))b,cast((c) as decimal(18,2))c,cast((d) as decimal(18,2))d,cast((e) as decimal(18,2))e,cast((f) as decimal(18,2))f, " +
            " case when [group]<>'total' then cast((g) as decimal(18,2)) when [group]='total' then cast((g) as decimal(18,2)) end g, " +
            " cast(i as decimal(18,0))i,cast(j as decimal(18,2))j from tempdefectL1 " +
            " ) as b " +

                        " select GP,i NilaiDefect,b NilaiSerah,'" + DateTime.Parse(txtdrtanggal.Text).ToString("yyyyMM") + "'Periode  into tempDataSarmut_Defect from " +
                        " ( " +
                        " select case when [Group]='Total' then 'Total_L1' else [Group] end GP,b,i from tempdefectL1 union all " +
                        " select case when [Group]='Total' then 'Total_L2' else [Group] end GP,b,i from tempdefectL2 union all  " +
                        " select case when [Group]='Total' then 'Total_L3' else [Group] end GP,b,i from tempdefectL3 union all  " +
                        " select case when [Group]='Total' then 'Total_L4' else [Group] end GP,b,i from tempdefectL4 union all " +
                        " select case when [Group]='Total' then 'Total_L5' else [Group] end GP,b,i from tempdefectL5 union all " +
                        " select case when [Group]='Total' then 'Total_L6' else [Group] end GP,b,i from tempdefectL6   " +
                        " )A  where GP<>'' ";
                        #endregion
                    }
                    #endregion
                }
            }
            #endregion
            /** Plant Karawang **/
            #region Karawang
            else if (/**Convert.ToInt32(strtgl1.Substring(0, 6)) > 202106 &&**/ users.UnitKerjaID == 7)
            {
                string Aquery = string.Empty; string Aquery2 = string.Empty;
                string OKKM = string.Empty;

                if (Convert.ToInt32(strtgl1.Substring(0, 6)) > 202207)
                {
                    OKKM =
                    " set @Tot_OKKM=isnull((select cast(sum(M3) as decimal(18,0))m3 from ( " +
                    " (select sum(qtyin *((I.tebal*I.Lebar*I.Panjang)/1000000000))M3  from T3_Rekap R inner join fc_items I on R.itemid=I.ID " +
                    " where R.rowstatus>-1 and R.Process  like '%simetris%'  and CONVERT(varchar,R.tgltrans,112)>=@thnbln1 and " +
                    " CONVERT(varchar,R.tgltrans,112)<=@thnbln2   and I.lebar=1200 and I.panjang=2400  and R.keterangan like '%-p-%' " +
                    " and (I.partno like '%-3-%' or I.partno like '%-W-%' or I.partno like '%-M-%' )) " +
                    " union all " +
                    " select sum(((Tebal*Lebar*Panjang)/1000000000)*qty ) M3 from vw_KartuStockBJNew where process='direct' " +
                    " and ( isnull(sfrom,'-') like 'bevel%' or isnull(sfrom,'-') like 'strapingr%') and left(convert(char,tanggal,112),8)>=@thnbln1 " +
                    " and left(convert(char,tanggal,112),8)<=@thnbln2 and (partno like '%-3-%' or partno like '%-w-%' or partno like '%-m-%') " +
                    " and lebar=1200 and Panjang=2400) as x ),0) ";
                }
                else
                {
                    OKKM =
                    " set @Tot_OKKM=isnull((select cast(sum(qtyin *((I.tebal*I.Lebar*I.Panjang)/1000000000)) as decimal(18,2))M3 from T3_Rekap R inner join fc_items I on R.itemid=I.ID  where R.rowstatus>-1 and R.Process  like '%simetris%' and CONVERT(varchar,R.tgltrans,112)>=@thnbln1 and CONVERT(varchar,R.tgltrans,112)<=@thnbln2   and I.lebar=1200 and I.panjang=2400 and R.keterangan like '%-p-%' and (I.partno like '%-3-%' or I.partno like '%-W-%' or I.partno like '%-M-%' )),0) ";
                }

                //if (Convert.ToInt32(strtgl1.Substring(0, 6)) > 232112)            
                //{
                //    Aquery = " select [Group],cast(@Selisih_TotPot as decimal(18,5))/cast((select count([Group]) from temp_ttlgrp_aktif) as decimal(18,2))M3 from temp_ttlgrp_aktif A ";                
                //}
                //else { Aquery = " select [Group],cast(@Selisih_TotPot as decimal(18,5))/cast((select count([Group]) from tempData_Group) as decimal(18,2))M3 from temp_GroupNow1 A "; }

                if (Convert.ToInt32(strtgl1.Substring(0, 6)) > 202203)
                {
                    Aquery =
                    " select [Group],sum(M3)M3 into tempSelisih_TotPot  from (  select [Group],M3 from (  " +
                    " select [Group],cast(@Selisih_TotPot as decimal(18,5))/cast((select count([Group]) from temp_ttlgrp_aktif) as decimal(18,2))M3 " +
                    " from temp_ttlgrp_aktif A  union all  select [Group],cast('0' as decimal(18,0))M3 from temp_ttlgrp_aktif) as x group by [Group],M3 ) " +
                    " as xx group by [Group] ";
                }
                else
                {
                    //Aquery = " select [Group],cast(@Selisih_TotPot as decimal(18,5))/cast((select count([Group]) from tempData_Group) as decimal(18,2))M3 from temp_GroupNow1 A "; 
                    Aquery =
                    " select [Group],sum(M3)M3 into tempSelisih_TotPot from ( " +
                    " select [Group],M3 from ( " +
                    " select [Group],cast(@Selisih_TotPot as decimal(18,5))/cast((select count([Group]) from tempData_Group) as decimal(18,2))M3 " +
                    " from temp_GroupNow1 A " +
                    " union all " +
                    " select [Group],cast('0' as decimal(18,0))M3 from tempData_Group) as x group by [Group],M3 ) as xx group by [Group] ";
                }


                strSQL =

                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempData_Group]') AND type in (N'U')) DROP TABLE [dbo].[tempData_Group] " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDefect_BM]') AND type in (N'U')) DROP TABLE [dbo].[tempDefect_BM] " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDefect_Fin]') AND type in (N'U')) DROP TABLE [dbo].[tempDefect_Fin] " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDefect_Fin0]') AND type in (N'U')) DROP TABLE [dbo].[tempDefect_Fin0] " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDefect_BM_detail0]') AND type in (N'U')) DROP TABLE [dbo].[tempDefect_BM_detail0] " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDefect_BM_detail]') AND type in (N'U')) DROP TABLE [dbo].[tempDefect_BM_detail] " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDefect_Fin_detail]') AND type in (N'U')) DROP TABLE [dbo].[tempDefect_Fin_detail] " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDefect_Fin_detail0]') AND type in (N'U')) DROP TABLE [dbo].[tempDefect_Fin_detail0] " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Selisih_ttl_defect_Detail]') AND type in (N'U')) DROP TABLE [dbo].[Selisih_ttl_defect_Detail] " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDefect_BM_FN_detail]') AND type in (N'U')) DROP TABLE [dbo].[tempDefect_BM_FN_detail] " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDefect_UkuranKhusus_detail]') AND type in (N'U')) DROP TABLE [dbo].[tempDefect_UkuranKhusus_detail] " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDefect_ListPlank_detail]') AND type in (N'U')) DROP TABLE [dbo].[tempDefect_ListPlank_detail] " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDefect_ListPlank_detail2]') AND type in (N'U')) DROP TABLE [dbo].[tempDefect_ListPlank_detail2] " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDefect_Produksi_detail]') AND type in (N'U')) DROP TABLE [dbo].[tempDefect_Produksi_detail] " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempMasterDataBSauto]') AND type in (N'U')) DROP TABLE [dbo].[tempMasterDataBSauto]  " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempBS_Tahap1]') AND type in (N'U')) DROP TABLE [dbo].[tempBS_Tahap1]  " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempBS_Tahap1_detail]') AND type in (N'U')) DROP TABLE [dbo].[tempBS_Tahap1_detail]  " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTotalDefect_detail]') AND type in (N'U')) DROP TABLE [dbo].[tempTotalDefect_detail]  " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTotalDefect_Pro_detail]') AND type in (N'U')) DROP TABLE [dbo].[tempTotalDefect_Pro_detail]  " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTotalPot_QA]') AND type in (N'U')) DROP TABLE [dbo].[tempTotalPot_QA]  " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDefect_Master_ListPlank]') AND type in (N'U')) DROP TABLE [dbo].[tempDefect_Master_ListPlank]  " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTtlBP_LP]') AND type in (N'U')) DROP TABLE [dbo].[tempTtlBP_LP]  " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTtlOK_LP]') AND type in (N'U')) DROP TABLE [dbo].[tempTtlOK_LP]  " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTtl_LP]') AND type in (N'U')) DROP TABLE [dbo].[tempTtl_LP]  " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTotalPotong_BP_LP]') AND type in (N'U')) DROP TABLE [dbo].[tempTotalPotong_BP_LP]  " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTotalPotong_LP]') AND type in (N'U')) DROP TABLE [dbo].[tempTotalPotong_LP]  " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTotalPotong_UkuranKhusus]') AND type in (N'U')) DROP TABLE [dbo].[tempTotalPotong_UkuranKhusus]  " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempGroup]') AND type in (N'U')) DROP TABLE [dbo].[tempGroup]  " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempGroup2]') AND type in (N'U')) DROP TABLE [dbo].[tempGroup2]  " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTotalPot_LP_UkuranKhusus]') AND type in (N'U')) DROP TABLE [dbo].[tempTotalPot_LP_UkuranKhusus]  " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTotalPot_SystemLP]') AND type in (N'U')) DROP TABLE [dbo].[tempTotalPot_SystemLP]  " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempSelisih_TotPot]') AND type in (N'U')) DROP TABLE [dbo].[tempSelisih_TotPot]  " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTotPot_Proposionet]') AND type in (N'U')) DROP TABLE [dbo].[tempTotPot_Proposionet]  " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempGroup_LPUK]') AND type in (N'U')) DROP TABLE [dbo].[tempGroup_LPUK]  " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[temp_OKKM]') AND type in (N'U')) DROP TABLE [dbo].[temp_OKKM]  " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[temp_Retur]') AND type in (N'U')) DROP TABLE [dbo].[temp_Retur]  " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[temp_Sortir]') AND type in (N'U')) DROP TABLE [dbo].[temp_Sortir]  " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[temp_TotalDefect]') AND type in (N'U')) DROP TABLE [dbo].[temp_TotalDefect]  " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[temp_Persen]') AND type in (N'U')) DROP TABLE [dbo].[temp_Persen]  " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[temp_Total]') AND type in (N'U')) DROP TABLE [dbo].[temp_Total]  " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[temp_DataDefectISO]') AND type in (N'U')) DROP TABLE [dbo].[temp_DataDefectISO]  " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectGPIsoTot]') AND type in (N'U')) DROP TABLE [dbo].[tempdefectGPIsoTot]  " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[temp_GroupNow]') AND type in (N'U')) DROP TABLE [dbo].[temp_GroupNow] " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[temp_GroupNow1]') AND type in (N'U')) DROP TABLE [dbo].[temp_GroupNow1] " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[temp_GroupNow2]') AND type in (N'U')) DROP TABLE [dbo].[temp_GroupNow2] " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectL1]') AND type in (N'U')) DROP TABLE [dbo].tempdefectL1  " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectL2]') AND type in (N'U')) DROP TABLE [dbo].tempdefectL2  " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectL3]') AND type in (N'U')) DROP TABLE [dbo].tempdefectL3  " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectL4]') AND type in (N'U')) DROP TABLE [dbo].tempdefectL4  " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectL5]') AND type in (N'U')) DROP TABLE [dbo].tempdefectL5  " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectL6]') AND type in (N'U')) DROP TABLE [dbo].tempdefectL6 " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDataSarmut_Defect]') AND type in (N'U')) DROP TABLE [dbo].tempDataSarmut_Defect " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[temp_ttlgrp_aktif]') AND type in (N'U')) DROP TABLE [dbo].temp_ttlgrp_aktif " +

                "  " +

                " declare @Total_tempDefect_BM_detail decimal(18,5)  " +
                " declare @Total_tempDefect_Fin_detail decimal(10,5) " +
                " declare @Selisih_ttl_defect decimal(10,5) " +
                " declare @dtlSelisih_ttl_defect decimal(10,5) " +
                " declare @Selisih_ttl_defect2 decimal(10,5) " +
                " declare @Total_Defect_ListPlank decimal(10,5) " +
                " declare @Total_Defect_UkuranKhusus decimal(10,5) " +
                " declare @OutBP_WiP decimal(10,5) " +
                " declare @Total_tempDefect_BM decimal(10,5) " +
                " declare @Total_Defect_BMFin decimal(10,5)  " +
                " declare @Total_DefectProduksi decimal(10,5)  " +
                " declare @TtlBS_Tahap1 varchar(10)   " +
                " declare @TtlPot_All varchar(10)   " +
                " declare @Selisih_TotPot decimal(10,5)  " +
                " declare @TotPot_LP_UKhusus varchar(10)  " +
                " declare @TotGroup_LP_UKhusus varchar(10)  " +
                " declare @Tot_Sortir varchar(10)  " +
                " declare @Tot_OKKM varchar(10)  " +
                " declare @Tot_Retur varchar(10)  " +

                "  " +

                " declare @thnbln1 varchar(8) declare @thnbln2 varchar(8) declare @BlnThn varchar(6)   " +
                //" set @thnbln1='20210701'   " +
                //" set @thnbln2='20210731'   " +
                //" set @BlnThn='202106'   " +

                " set @thnbln1='" + strtgl1 + "' " +
                " set @thnbln2='" + strtgl2 + "' " +
                " set @BlnThn='" + Periode + "' " +

                /** Group Produksi yg ada OutPutnya nya **/
                "; with dataGrp as (select distinct PlantID  from BM_Destacking where left(convert(char,tglproduksi,112),6)=substring(@thnbln1,1,6) " +
                " and Qty>0 and RowStatus>-1), " +
                " dataGrp1 as (select case when PlantID =1 then 'Line 1' when PlantID=2 then 'Line 2' when PlantID=3 then 'Line 3' " +
                " when PlantID=4 then 'Line 4' when PlantID=5 then 'Line 5' when PlantID=6 then 'Line 6' end Line,case when PlantID =1 then 'KA,KB,KC,KD' " +
                " when PlantID =2 then 'KE,KF,KG,KH' when PlantID =3 then 'KI,KJ,KK,KL' when PlantID =4 then 'KM,KN,KO,KP' when PlantID =5 then 'KQ,KR,KS,KT' " +
                " when PlantID=6 then 'KU,KV,KW,KX' else '' end GP from dataGrp), " +
                " dataGrp2 as (SELECT A.[Line],Split.a.value('.', 'VARCHAR(100)') AS [Group]   " +
                " FROM (SELECT [Line],CAST ('<M>' + REPLACE([Gp],',', '</M><M>') + '</M>' AS XML) AS String FROM dataGrp1) AS A " +
                " CROSS APPLY String.nodes ('/M') AS Split(a)) " +
                " select *,'0'M3 into temp_ttlgrp_aktif from dataGrp2 order by line,[Group]; " +

                "  " +

                " /** Group Produksi **/ " +
                " select [Group],'0' M3 into tempData_Group from BM_PlantGroup   " +

                "  " +

                " /** Group Produksi yg Berjalan **/ " +
                //" select case when PlantID=1 then 'Line 1'  when PlantID=2 then 'Line 2' when PlantID=3 then 'Line 3' " +
                //" when PlantID=4 then 'Line 4'  when PlantID=5 then 'Line 5' when PlantID=6 then 'Line 6' end Line, " +
                //" case when PlantID=1 then 'KA,KB,KC,KD' when PlantID=2 then 'KE,KF,KG,KH' when PlantID=3 then 'KI,KJ,KK,KL'  " +
                //" when PlantID=4 then 'KM,KN,KO,KP' when PlantID=5 then 'KQ,KR,KS,KT' when PlantID=6 then 'KCU,KV,KCW,KX' end [Group] into temp_GroupNow from  " +
                //" BM_Destacking where RowStatus>-1 and left(convert(char,tglproduksi,112),6)=left(convert(char,@thnbln1,112),6) and Qty>0 " +

                " select * into temp_GroupNow from ( " +
                " select 'Line 1'Line,'KA,KB,KC,KD' [Group] union all " +
                " select 'Line 2'Line,'KE,KF,KG,KH' [Group] union all " +
                " select 'Line 3'Line,'KI,KJ,KK,KL' [Group] union all " +
                " select 'Line 4'Line,'KM,KN,KO,KP' [Group] union all " +
                " select 'Line 5'Line,'KQ,KR,KS,KT' [Group] union all " +
                " select 'Line 6'Line,'KU,KV,KW,KX' [Group] ) as x " +

                "  " +

                " SELECT A.[Line],Split.a.value('.', 'VARCHAR(100)') AS [Group]   into temp_GroupNow1 " +
                " FROM (SELECT [Line],CAST ('<M>' + REPLACE([Group],',', '</M><M>') + '</M>' AS XML) AS String FROM temp_GroupNow) AS A CROSS APPLY String.nodes ('/M') AS Split(a);  " +
                "  " +
                " select Line,[Group] into temp_GroupNow2 from temp_GroupNow1 group by Line,[Group] order by Line,[Group] " +
                "  " +
                " /** Defect BM **/ " +
                " select *  into tempDefect_BM from (  select case when D.DeptID=0 then  case when GJ.GroupJemurName In ('M','N','O','P','Q','R','S','T','U','V','W','X') then   " +
                " case when D.DefName='retak' then 2 when D.DefName='gompal' then 3 else D.DeptID end else  " +
                " case when (B.Qty/E.Qty) *100 >5 then 2 else 3 end   end  else D.DeptID end deptID1,A.CreatedTime as tglInput,A.Tgl as TglPeriksa,   " +
                " E.TglProduksi as TglProd,  D.DefCode,BP.PlantName as Line, PG.[Group],BF.FormulaCode as Jenis,D.DefName,D.DeptID,B.ID,B.DefectID,   " +
                " B.MasterID,B.Qty,A.ID  DestID,isnull(A.TPotong,0)  QtyIn,   " +
                " I.Volume*B.Qty Kubik,isnull(A.TPotong,0) as TotPotong, '' sfrom   " +
                " from Def_DefectDetail B   " +
                " inner join Def_Defect A on A.Id=B.DefectID     " +
                " left join Def_MasterDefect D on B.MasterID=D.ID   " +
                " left join BM_Destacking E on E.ID=A.DestID    " +
                " left join BM_PlantGroup PG on A.GroupProdID=PG.ID  " +
                " left join BM_Formula BF on BF.ID=E.FormulaID     " +
                " left join BM_Plant BP on BP.ID=E.PlantID   " +
                " left join FC_Items I on I.ID=E.ItemID   " +
                " inner join Def_GroupJemur GJ on GJ.ID=A.GroupJemurID    " +
                " where B.RowStatus>-1  and D.RowStatus >-1) as Def      " +
                " where DeptID1=2 and CONVERT(varchar,TglPeriksa,112)>=@thnbln1 and CONVERT(varchar,TglPeriksa,112)<=@thnbln2   " +
                "  " +
                " select *,isnull((select sum(qty) from tempDefect_BM where [group]=A.[Group] ),0) totdefect, isnull((select sum(kubik) from tempDefect_BM where [group]=A.[Group] ),0) totdefectK into tempdefectGPIsoTot from ( select  B.[Group],SUM(C.qtyin) as totpotong,SUM(kubik) as totkubik    from BM_Destacking A left join BM_PlantGroup B on A.PlantGroupID=B.ID  inner join (  select C.destid,C.qtyin,C.QtyIn*I1.Volume as kubik from T1_Serah C Inner join fc_items I  on C.itemid=I.ID Inner join fc_items I1 on C.itemid0=I1.ID  where C.Status>-1 and CONVERT(char,C.tglserah,112)>=@thnbln1 and   CONVERT(char,C.tglserah,112)<=@thnbln2 and (I.PartNo like '%-w-%' or I.PartNo like '%-3-%' )  union all   select C.DestID , B.Qty qtyin,B.Qty*I.Volume as kubik from Def_Defect A inner join Def_DefectDetail B on A.ID=B.DefectID  inner join T1_Serah C on A.SerahID=C.ID  left join FC_Items I on I.ID=C.ItemID0  where CONVERT(char,A.tgl,112)>=@thnbln1 and  CONVERT(char,A.tgl,112)<=@thnbln2 and B.RowStatus>-1 ) as C   on A.ID=C.DestID group by B.[Group])A  " +
                "  " +
                "  " +
                " /** Defect Finishing **/ " +
                "  select * into tempDefect_Fin  from (  " +
                "  select case when D.DeptID=0 then  case when GJ.GroupJemurName In ('M','N','O','P','Q','R','S','T','U','V','W','X') then   case when D.DefName='retak' then 2 when D.DefName='gompal' then 3 else D.DeptID end else case when (B.Qty/E.Qty) *100 >5 then 2  else 3 end   end  else D.DeptID end deptID1,A.CreatedTime as tglInput,A.Tgl as TglPeriksa,E.TglProduksi as TglProd,  D.DefCode,BP.PlantName as Line, PG.[Group],BF.FormulaCode as Jenis,D.DefName,D.DeptID,B.ID,B.DefectID,B.MasterID,B.Qty,A.ID  DestID,isnull(A.TPotong,0)  QtyIn,B.Qty*I.Volume as Kubik,isnull(A.TPotong,0) as TotPotong,'' sfrom    " +
                "  from Def_DefectDetail B  " +
                "  inner join Def_Defect A on A.Id=B.DefectID   " +
                "  left join Def_MasterDefect D on B.MasterID=D.ID " +
                "  left join BM_Destacking E on E.ID=A.DestID    " +
                "  left join BM_PlantGroup PG on A.GroupProdID=PG.ID  " +
                "  left join BM_Formula BF on BF.ID=E.FormulaID     " +
                "  left join BM_Plant BP on BP.ID=E.PlantID  " +
                "  left join FC_Items I on I.ID=E.ItemID   " +
                "  inner join Def_GroupJemur GJ on GJ.ID=A.GroupJemurID  " +
                "  where B.RowStatus>-1  and D.RowStatus >-1) as Def   " +
                "  where DeptID1=3 and CONVERT(varchar,TglPeriksa,112)>=@thnbln1 and CONVERT(varchar,TglPeriksa,112)<=@thnbln2   " +
                "  " +
                "  /** Defect Ukuran Khusus **/ " +
                " ;with dataDestacking as (select distinct ItemID,PlantID,left(convert(char,tglproduksi,112),6)ThnBln from BM_Destacking where RowStatus>-1 group by ItemID,PlantiD,TglProduksi ),  " +
                " dataDestacking1 as (select B.PartNo,PlantID,ThnBln from dataDestacking A inner join FC_Items B ON A.ItemID=B.ID),    " +
                " dataDestacking2 as (select x.ItemID,x.PartnoAsal,x.Qty,((A.Tebal*A.Lebar*A.Panjang)/1000000000)*x.Qty M3 from (   select PartNo PartnoAsal,ItemID,isnull(SUM(Qty),0)  * -1 Qty from vw_KartuStockBJNew  where qty <0 and (process  like '%simetris%' ) and  (Keterangan like '%-P-%') and  LokID not In (select ID from FC_Lokasi where lokasi='q99')   and left(convert(char,tanggal,112),8)>=@thnbln1 and  left(convert(char,tanggal,112),8)<=@thnbln2 and ItemID in (select ID  from FC_Items where PartNo like'%-1-%') group by ItemID,Keterangan,PartNo,ItemID   ) as x  inner join FC_Items A ON A.ID=x.ItemID),   " +
                " dataDestacking3 as (select *,(select top 1 A1.ThnBln from dataDestacking1 A1 where A1.PartNo=A.PartnoAsal and A1.ThnBln<=left(convert(char,@thnbln1,112),6) order by A1.ThnBln desc)ThnBln from dataDestacking2 A) ,   " +
                " dataDestacking4 as (select PartnoAsal,sum(M3)M3,ThnBln,PlantID from (select A.*,B.PlantID from dataDestacking3 A left join dataDestacking1 B ON A.PartnoAsal=B.PartNo and A.ThnBln=B.ThnBln ) as x group by PartnoAsal,ThnBln,PlantID),   " +
                " dataDestacking04 as (select *,(select top 1 A1.Line from Def_UKhususProsen A1 where A1.Partno=A.PartnoAsal and A1.Periode=left(convert(char,@thnbln1,112),6))PlantID2 from dataDestacking4 A ),   " +
                " dataDestacking5 as (select PartnoAsal,M3,case when PlantID2 is null then PlantID else PlantID2 end PlantID from dataDestacking04 xx),   " +
                " dataDestacking051 as (select PartnoAsal,M3,PlantID from dataDestacking5 xx group by PartnoAsal,M3,PlantID ),   " +
                " dataDestacking05 as (select PartnoAsal,M3,PlantID,(select count(PartnoAsal) from dataDestacking051 A where A.PartnoAsal=dataDestacking051.PartnoAsal)ttl from dataDestacking051 group by PartnoAsal,M3,PlantID),   " +
                " dataDestacking6 as (select PartnoAsal,sum(m3)m3,PlantID,ttl from dataDestacking05 group by PlantID,ttl,PartnoAsal),   " +
                " dataDestacking06 as (select PartnoAsal,case when ttl=1 then m3 when ttl>1 then m3/ttl end m3,PlantID from dataDestacking6 group by PlantID,m3,ttl,PartnoAsal),   " +
                " dataDestacking006 as (select cast(m3 as decimal(18,5))m3,PlantID from dataDestacking06 ), " +
                " dataDestacking7 as (  select sum(M3)M3,[Group] from (   " +
                " select M3/4 M3,B.[Group] from dataDestacking006 A inner join BM_PlantGroup B ON A.PlantID=B.PlantID where B.PlantID>0   " +
                " union all   " +
                " select 0'M3',[Group] from BM_PlantGroup where PlantID>0 ) as x group by [Group] )    " +
                " select [Group],M3 into tempDefect_UkuranKhusus_detail  from dataDestacking7   " +
                "  " +
                "  /** Total Potong Ukuran Khusus **/ " +
                " ;with dataDestacking as (select distinct ItemID,PlantID,left(convert(char,tglproduksi,112),6)ThnBln from BM_Destacking where RowStatus>-1 group by ItemID,PlantiD,TglProduksi ),  " +
                " dataDestacking1 as (select B.PartNo,PlantID,ThnBln from dataDestacking A inner join FC_Items B ON A.ItemID=B.ID),    " +
                " dataDestacking2 as (select x.ItemID,x.PartnoAsal,x.Qty,((A.Tebal*A.Lebar*A.Panjang)/1000000000)*x.Qty M3 from (   select PartNo PartnoAsal,ItemID,isnull(SUM(Qty),0)  * -1 Qty from vw_KartuStockBJNew  where qty <0 and (process  like '%simetris%' ) and  (Keterangan like '%-P-%' or Keterangan like '%-3-%' or Keterangan like '%-M-%') and  LokID not In (select ID from FC_Lokasi where lokasi='q99')   and left(convert(char,tanggal,112),8)>=@thnbln1 and  left(convert(char,tanggal,112),8)<=@thnbln2 and ItemID in (select ID  from FC_Items where PartNo like'%-1-%') group by ItemID,Keterangan,PartNo,ItemID   ) as x  inner join FC_Items A ON A.ID=x.ItemID),   " +
                " dataDestacking3 as (select *,(select top 1 A1.ThnBln from dataDestacking1 A1 where A1.PartNo=A.PartnoAsal and A1.ThnBln<=left(convert(char,@thnbln1,112),6) order by A1.ThnBln desc)ThnBln from dataDestacking2 A) ,   " +
                " dataDestacking4 as (select PartnoAsal,sum(M3)M3,ThnBln,PlantID from (select A.*,B.PlantID from dataDestacking3 A left join dataDestacking1 B ON A.PartnoAsal=B.PartNo and A.ThnBln=B.ThnBln ) as x group by PartnoAsal,ThnBln,PlantID),   " +
                " dataDestacking04 as (select *,(select top 1 A1.Line from Def_UKhususProsen A1 where A1.Partno=A.PartnoAsal and A1.Periode=left(convert(char,@thnbln1,112),6))PlantID2 from dataDestacking4 A ),   " +
                " dataDestacking5 as (select PartnoAsal,M3,case when PlantID2 is null then PlantID else PlantID2 end PlantID from dataDestacking04 xx),   " +
                " dataDestacking051 as (select PartnoAsal,M3,PlantID from dataDestacking5 xx group by PartnoAsal,M3,PlantID ),   " +
                " dataDestacking05 as (select PartnoAsal,M3,PlantID,(select count(PartnoAsal) from dataDestacking051 A where A.PartnoAsal=dataDestacking051.PartnoAsal)ttl from dataDestacking051 group by PartnoAsal,M3,PlantID),   " +
                " dataDestacking6 as (select PartnoAsal,sum(m3)m3,PlantID,ttl from dataDestacking05 group by PlantID,ttl,PartnoAsal),   " +
                " dataDestacking06 as (select PartnoAsal,case when ttl=1 then m3 when ttl>1 then m3/ttl end m3,PlantID from dataDestacking6 group by PlantID,m3,ttl,PartnoAsal),   " +
                " dataDestacking7 as (  select sum(M3)M3,[Group] from (   " +
                " select M3/4 M3,B.[Group] from dataDestacking06 A inner join BM_PlantGroup B ON A.PlantID=B.PlantID where B.PlantID>0   " +
                " union all   " +
                " select 0'M3',[Group] from BM_PlantGroup where PlantID>0 ) as x group by [Group] )    " +
                "  " +
                " select [Group],M3 into tempTotalPotong_UkuranKhusus  from dataDestacking7  " +
                "  " +
              
                " /** OK KM **/ " +
                " " + OKKM + " " +
                //" set @Tot_OKKM=isnull((select cast(sum(qtyin *((I.tebal*I.Lebar*I.Panjang)/1000000000)) as decimal(18,2))M3 from T3_Rekap R inner join fc_items I on R.itemid=I.ID  where R.rowstatus>-1 and R.Process  like '%simetris%' and CONVERT(varchar,R.tgltrans,112)>=@thnbln1 and CONVERT(varchar,R.tgltrans,112)<=@thnbln2   and I.lebar=1200 and I.panjang=2400 and R.keterangan like '%-p-%' and (I.partno like '%-3-%' or I.partno like '%-W-%' or I.partno like '%-M-%' )),0) " +

                "  " +
                "  /** Retur **/ " +
                " set @Tot_Retur=isnull((select cast(Qty1-Qty2+Qty3+Qty4 as decimal(18,2))M3 from ( " +
                " select sum(Tot1*volume)Qty1,sum(Tot2*volume)Qty2,sum(Tot3*volume)Qty3,sum(Tot4*volume)Qty4 from ( " +
                " select tanggal,PartNo,volume ,sum(isnull(QtyC1,0))QtyC1,sum(isnull(QtyP1,0)) QtyP1,sum(isnull(QtyS1,0)) QtyS1,sum(isnull(Tot1,0)) Tot1,sum(isnull(TotK1,0)) TotK1, sum(isnull(QtyC2,0)) QtyC2,sum(isnull(QtyP2,0)) QtyP2,sum(isnull(QtyS2,0)) QtyS2,sum(isnull(Tot2,0)) Tot2, sum(isnull(TotK2,0)) TotK2,sum(isnull(QtyC3,0)) QtyC3,sum(isnull(QtyP3,0)) QtyP3,sum(isnull(QtyS3,0)) QtyS3,sum(isnull(Tot3,0)) Tot3,sum(isnull(TotK3,0)) TotK3, sum(isnull(QtyC4,0)) QtyC4,sum(isnull(QtyP4,0)) QtyP4,sum(isnull(QtyS4,0)) QtyS4,sum(isnull(Tot4,0)) Tot4,sum(isnull(TotK4,0)) TotK4 from ( select tanggal ,PartNo,volume,case when typeR=1 and ((KW='3' or KW='W')or lokasi='cl') then Qty end QtyC1,case when typeR=1 and (KW='P'and lokasi <> 'cl') then Qty end QtyP1, case when typeR=1 and (KW='S'and lokasi <> 'cl') then Qty end QtyS1, case when typeR=1 and ((KW='P' or KW='S') and lokasi <> 'cl') then Qty end Tot1, case when typeR=1 and (KW='P' or KW='S') then QtyK end TotK1, case when typeR=2 and ((KW='3' or KW='W')or lokasi='cl') then Qty end QtyC2, case when typeR=2 and (KW='P' and lokasi <> 'cl') then Qty end QtyP2, case when typeR=2 and (KW='S' and lokasi <> 'cl') then Qty end QtyS2, case when typeR=2 and ((KW='P' or KW='S') and lokasi <> 'cl') then Qty end Tot2, case when typeR=2 and ((KW='P' or KW='S') and lokasi <> 'cl') then QtyK end TotK2, case when typeR=3 and ((KW='3' or KW='W')or lokasi='cl') then Qty end QtyC3, case when typeR=3 and (KW='P' and lokasi <> 'cl') then Qty end QtyP3, case when typeR=3 and (KW='S' and lokasi <> 'cl') then Qty end QtyS3, case when typeR=3 and ((KW='P' or KW='S') and lokasi <> 'cl') then Qty   end Tot3, case when typeR=3 and ((KW='P' or KW='S') and lokasi <> 'cl') then QtyK end TotK3, case when typeR=4 and ((KW='3' or KW='W')or lokasi='cl') then Qty end QtyC4,  case when typeR=4 and (KW='P' and lokasi <> 'cl') then Qty end QtyP4,  case when typeR=4 and (KW='S' and lokasi <> 'cl') then Qty end QtyS4,  case when typeR=4 and ((KW='P' or KW='S') and lokasi <> 'cl') then Qty   end Tot4,  case when typeR=4 and ((KW='P' or KW='S') and lokasi <> 'cl') then QtyK end TotK4  from (     select R.TglTrans tanggal,I.PartNo,I.volume,SUBSTRING(I.partno,5,1) as KW,sum(R.Qty)Qty,     sum(((I.Panjang*I.Lebar)/(1220*2440) ) * R.Qty) QtyK,isnull(R.TypeR,1)  TypeR,I.ID,L.Lokasi     from T3_Retur R inner join FC_Items I on R.ItemID =I.ID  inner join FC_lokasi L on R.LokID=L.ID  where R.RowStatus>-1     group by R.TglTrans,I.PartNo,I.volume,R.TypeR,I.ID,L.Lokasi union all select R.TglTrans tanggal,I.PartNo,I.volume,SUBSTRING(I.partno,5,1) as KW,sum(R.Qty)Qty,    sum(((I.Panjang*I.Lebar)/(1220*2440) ) * R.Qty) QtyK,3  TypeR,I.ID,L.Lokasi     from T3_ReturO R inner join FC_Items I on R.ItemID =I.ID  inner join FC_lokasi L on R.LokID=L.ID  where R.RowStatus>-1     group by R.TglTrans,I.PartNo,I.volume,I.ID,L.Lokasi ) as A ) as B where convert(char,tanggal,112)>=@thnbln1 and convert(char,tanggal,112)<=@thnbln2 group by tanggal,PartNo,volume ) " +
                " as x ) as xx),0) " +
                "  " +
                "  /** Sortir **/ " +
                " set @Tot_Sortir=isnull((select cast((STD+EFO) as decimal(18,2)) M3 from ( " +
                " select sum(M3AkhirSS)STD,sum(M3AkhirSE)EFO from ( " +
                " select ROW_NUMBER() over (order by PartnoAkhir asc ) as No,* from ( select PartnoAkhir,sum(QtyAkhirSS)QtyAkhirSS,sum(M3AkhirSS)M3AkhirSS, sum(QtyAkhirSE)QtyAkhirSE,sum(M3AkhirSE)M3AkhirSE from ( SELECT B.tgltrans as Tanggal, I1.PartNo as PartnoAwal, sum(B.QtyIn) as QtyAwal,sum(I1.Volume*B.QtyIn) M3Awal,  I2.PartNo AS PartnoAkhir, case when B.NCSS>0 then sum(B.QtyOut) else 0 end QtyAkhirSS, case when B.NCSS>0 then sum(I2.Volume*B.QtyOut) else 0 end M3AkhirSS,case when B.NCSE>0 then sum(B.QtyOut) else 0 end QtyAkhirSE, case when B.NCSE>0 then sum(I2.Volume*B.QtyOut) else 0 end M3AkhirSE,B.NCSS,B.NCSE  FROM T3_Serah AS A  INNER JOIN T3_Simetris AS B ON A.ID = B.SerahID INNER JOIN FC_Items AS I1 ON A.ItemID = I1.ID INNER JOIN  FC_Items AS I2 ON B.ItemID = I2.ID LEFT JOIN T3_GroupM AS D ON B.GroupID = D.ID  where (B.NCSS>0 or B.NCSE>0) and B.rowstatus>-1 and left(convert(varchar,B.tgltrans,112),6)=left(convert(varchar,@thnbln1,112),6)  group by B.tgltrans,I1.PartNo,I2.PartNo,B.NCSS,B.NCSE) S  group by PartnoAkhir ) as x ) as xx ) as xxx),0) " +
                "  " +

                " /** Data Master Defect ListPlank sampai Strapping **/    " +
                "  ;with Listplank_Master as (  select PartnoAsal,isnull((sum(M3)) ,0) M3  from (  select PartnoAsal,isnull((sum(M3)) ,0)M3  from (  select PartnoAsal,Qty,(((Tebal*Lebar*Panjang)/1000000000)*Qty)  M3  from (  " +
                "  select PartnoAsal,PartNo2,sum(Qty)Qty,Tebal,Lebar,Panjang  from (  select x1.PartNo PartnoAsal,x2.PartNo PartNo2,x2.Tebal,x2.Lebar,x2.Panjang,x.Qty from (  select ItemID0,itemid,Qty * -1 Qty from vw_KartuStockListplank where left(convert(char,tanggal,112),8)>=@thnbln1 and  left(convert(char,tanggal,112),8)<=@thnbln2 and process='runingsaw' and qty<0 and rowstatus=0) as x   inner join FC_Items x1 ON x.ItemID0=x1.ID  inner join FC_Items x2 ON x.ItemID=x2.ID) as A group by PartnoAsal,PartNo2,Tebal,Lebar,Panjang ) as xx ) as xx1  group by PartnoAsal   " +
                "  union all  " +
                "  /** 2. Saldo Awal Running Saw **/    " +
                "  select PartnoAsal,isnull((sum((Volume*Qty))) ,0) M3  from (  select x2.PartNo PartnoAsal,((x1.Tebal*x1.Lebar*x1.Panjang)/1000000000) Volume,x.Qty  from (  select sum(saldo)Qty ,ItemID,ItemID0 from T1_SaldoListPlank where Process='runingsaw' and thnbln=@BlnThn and Saldo>0 and ItemID<>ItemID0 group by ItemID,ItemID0 ) as x    inner join FC_Items x1 ON x.ItemID=x1.ID  inner join FC_Items x2 ON x.ItemID0=x2.ID) as A group by PartnoAsal   " +
                "  union all    " +
                "  /** 3. Saldo Akhir RunningSaw **/   " +
                "  select PartnoAsal,isnull((sum(M3))  * -1,0) M3 from (  select PartnoAsal,Qty,(((Tebal*Lebar*Panjang)/1000000000)*Qty)  M3  from (  select PartnoAsal,PartNo2,sum(Qty)Qty,Tebal,Lebar,Panjang  from (  select x1.PartNo PartnoAsal,x2.PartNo PartNo2,x2.Tebal,x2.Lebar,x2.Panjang,x.Qty from (  select sum(Saldo)Qty,ItemID0,ItemID from T1_SaldoListPlank where Process='runingsaw' and thnbln=left(convert(char,@thnbln1,112),6) and Saldo>0 and ItemID<>ItemID0  group by ItemID0,ItemID ) as x   inner join FC_Items x1 ON x.ItemID0=x1.ID  inner join FC_Items x2 ON x.ItemID=x2.ID) as A group by PartnoAsal,PartNo2,Tebal,Lebar,Panjang ) as xx ) as xx1    group by PartnoAsal   " +
                "  union all    " +
                "  /** 4. Saldo Awal Bevel **/    " +
                "  select PartnoAsal,isnull((sum(M3)),0) M3  from (  select PartnoAsal,Qty,(((Tebal*Lebar*Panjang)/1000000000)*Qty)  M3  from (  select PartnoAsal,PartNo2,sum(Qty)Qty,Tebal,Lebar,Panjang  from (  select x1.PartNo PartnoAsal,x2.PartNo PartNo2,x2.Tebal,x2.Lebar,x2.Panjang,x.Qty from (  select sum(Saldo)Qty,ItemID0,ItemID from T1_SaldoListPlank where Process='bevel' and thnbln=@BlnThn and Saldo>0 group by ItemID0,ItemID ) as x   inner join FC_Items x1 ON x.ItemID0=x1.ID  inner join FC_Items x2 ON x.ItemID=x2.ID) as A group by PartnoAsal,PartNo2,Tebal,Lebar,Panjang ) as xx ) as xx1 group by PartnoAsal   union all    " +
                "  /** 5. Saldo Akhir Bevel **/    " +
                "  select PartnoAsal,isnull((sum(M3))  * -1,0) M3 from (  select PartnoAsal,Qty,(((Tebal*Lebar*Panjang)/1000000000)*Qty)  M3  from (  select PartnoAsal,PartNo2,sum(Qty)Qty,Tebal,Lebar,Panjang  from (  select x1.PartNo PartnoAsal,x2.PartNo PartNo2,x2.Tebal,x2.Lebar,x2.Panjang,x.Qty from (  select sum(Saldo)Qty,ItemID0,ItemID from T1_SaldoListPlank where Process='bevel' and thnbln=left(convert(char,@thnbln1,112),6) and Saldo>0 and ItemID<>ItemID0  group by ItemID0,ItemID ) as x   inner join FC_Items x1 ON x.ItemID0=x1.ID  inner join FC_Items x2 ON x.ItemID=x2.ID) as A group by PartnoAsal,PartNo2,Tebal,Lebar,Panjang ) as xx ) as xx1   group by PartnoAsal   union all   " +
                "  /** 6. Saldo Awal Strapping **/     " +
                "  select PartnoAsal,isnull((sum(M3)),0) M3 from (select PartnoAsal,Qty,(((Tebal*Lebar*Panjang)/1000000000)*Qty)  M3  from (  select PartnoAsal,PartNo2,sum(Qty)Qty,Tebal,Lebar,Panjang  from (  select x1.PartNo PartnoAsal,x2.PartNo PartNo2,x2.Tebal,x2.Lebar,x2.Panjang,x.Qty from (  select sum(Saldo)Qty,ItemID0,ItemID from T1_SaldoListPlank where Process='straping' and thnbln=@BlnThn and Saldo>0 group by ItemID0,ItemID ) as x   inner join FC_Items x1 ON x.ItemID0=x1.ID  inner join FC_Items x2 ON x.ItemID=x2.ID) as A group by PartnoAsal,PartNo2,Tebal,Lebar,Panjang ) as xx ) as xx1 group by PartnoAsal   " +
                "  union all    " +
                "  /** 7. Saldo Akhir Strapping **/   " +
                "  select PartnoAsal,isnull(sum(M3)* -1,0) M3 from (  select PartnoAsal,Qty,(((Tebal*Lebar*Panjang)/1000000000)*Qty) M3  from (  select PartnoAsal,PartNo2,sum(Qty)Qty,Tebal,Lebar,Panjang  from (  select x1.PartNo PartnoAsal,x2.PartNo PartNo2,x2.Tebal,x2.Lebar,x2.Panjang,x.Qty from (  select sum(Saldo)Qty,ItemID0,ItemID from T1_SaldoListPlank where Process='straping' and thnbln=left(convert(char,@thnbln1,112),6) and Saldo>0 and ItemID<>ItemID0  group by ItemID0,ItemID ) as x   inner join FC_Items x1 ON x.ItemID0=x1.ID  inner join FC_Items x2 ON x.ItemID=x2.ID) as A group by PartnoAsal,PartNo2,Tebal,Lebar,Panjang ) as xx ) as xxx group by PartnoAsal   " +
                " ) as DataFinall group by PartnoAsal )  " +
                "  select * into tempDefect_Master_ListPlank from Listplank_Master;  " +
                "   " +

                "  /** ListPlank Before BP dan OK **/ " +
                " with LP_1 as (select distinct ItemID,PlantID,left(convert(char,tglproduksi,112),6)ThnBln from BM_Destacking where RowStatus>-1 group by ItemID,PlantiD,TglProduksi ),   " +
                " LP_2 as (select B.PartNo,PlantID,ThnBln from LP_1 A inner join FC_Items B ON A.ItemID=B.ID),  " +
                " LP_3 as ( select PartnoAsal,isnull(sum(M3),0) M3  from (  " +
                "  select * from tempDefect_Master_ListPlank " +
                " ) as DataFinall group by PartnoAsal) , " +
                "  LP_4 as (select *,(select top 1 A1.ThnBln from LP_2 A1 where A1.PartNo=A.PartnoAsal and A1.ThnBln<=left(convert(char,@thnbln1,112),6) order by A1.ThnBln desc)ThnBln from LP_3 A), " +
                "  LP_5 as (select PartnoAsal,sum(M3)M3,ThnBln,PlantID from (select A.*,B.PlantID from LP_4 A left join LP_2 B ON A.PartnoAsal=B.PartNo and A.ThnBln=B.ThnBln ) as x group by PartnoAsal,ThnBln,PlantID),   " +
                //"  LP_6 as (select *,(select top 1 A1.Line from Def_UKhususProsen A1 where A1.Partno=A.PartnoAsal and A1.Periode=left(convert(char,@thnbln1,112),6))PlantID2 from LP_5 A ),   " +
                //"  LP_7 as (select PartnoAsal,M3,case when PlantID2 is null then PlantID else PlantID2 end PlantID from LP_6 xx), " +
                //"   LP_07 as (select M3,PlantID from LP_7 group by M3,PlantID) " +
                //" select cast(sum(M3) as decimal(18,2))M3,PlantID into tempTtl_LP from LP_07 group by PlantID " +
                " LP_51 as (select PartnoAsal,M3,PlantID from LP_5 xx group by PartnoAsal,M3,PlantID ),  " +
                " LP_05 as (select PartnoAsal,M3,PlantID,(select count(PartnoAsal) from LP_51 A where A.PartnoAsal=LP_51.PartnoAsal)ttl from LP_51 group by PartnoAsal,M3,PlantID),  " +
                " LP_6 as (select *,(select top 1 A1.Line from Def_UKhususProsen A1 where A1.Partno=A.PartnoAsal and A1.Periode=left(convert(char,@thnbln1,112),6))PlantID2 from LP_05 A ),   " +
                " LP_06 as (select PartnoAsal,case when ttl=1 then m3 when ttl>1 then m3/ttl end m3,PlantID,PlantID2 from LP_6 group by PlantID,m3,ttl,PartnoAsal,PlantID2),   " +
                " LP_7 as (select PartnoAsal,M3,case when PlantID2 is null then PlantID else PlantID2 end PlantID from LP_06 xx), " +
                " LP_07 as (select PartnoAsal,M3,PlantID from LP_7 group by PartnoAsal,M3,PlantID) " +
                " select cast(sum(M3) as decimal(18,2))M3,PlantID into tempTtl_LP from LP_07 group by PlantID " +

                "  " +
                " /** ListPlank BP **/ " +
                " ;with LP_1 as (select distinct ItemID,PlantID,left(convert(char,tglproduksi,112),6)ThnBln from BM_Destacking where RowStatus>-1 group by ItemID,PlantiD,TglProduksi ),   " +
                " LP_2 as (select B.PartNo,PlantID,ThnBln from LP_1 A inner join FC_Items B ON A.ItemID=B.ID),  " +
                " LP_3 as ( select PartnoAsal,isnull((sum(M3)),0) M3  from (   " +
                " /** Tahap III BP **/    " +
                "  select PartnoAsal,isnull((sum(M3)),0) M3  from (  select PartnoAsal,Qty,(((Tebal*Lebar*Panjang)/1000000000)*Qty) M3  from (  select PartnoAsal,sum(Qty)Qty,Tebal,Lebar,Panjang  from (  select x.PartNo PartnoAsal,x2.Tebal,x2.Lebar,x2.Panjang,x.Qty from (  select sum(Qty)Qty,ItemID,Keterangan Partno from vw_KartuStockBJNew  where sfrom='straping' and left(convert(char,tanggal,112),6)=left(convert(char,@thnbln1,112),6) and  ItemID in (select ID from FC_Items where PartNo like'%-P-%' or PartNo like'%-S-%')  group by ItemID,Keterangan ) as x   inner join FC_Items x2 ON x.ItemID=x2.ID) as A group by PartnoAsal,Tebal,Lebar,Panjang ) as xx ) as xx1 group by PartnoAsal   " +
                " ) as DataFinall group by PartnoAsal) , " +
                "  LP_4 as (select *,(select top 1 A1.ThnBln from LP_2 A1 where A1.PartNo=A.PartnoAsal and A1.ThnBln<=left(convert(char,@thnbln1,112),6) order by A1.ThnBln desc)ThnBln from LP_3 A), " +
                "  LP_5 as (select PartnoAsal,sum(M3)M3,ThnBln,PlantID from (select A.*,B.PlantID from LP_4 A left join LP_2 B ON A.PartnoAsal=B.PartNo and A.ThnBln=B.ThnBln ) as x group by PartnoAsal,ThnBln,PlantID),   " +
                //"  LP_6 as (select *,(select top 1 A1.Line from Def_UKhususProsen A1 where A1.Rowstatus>-1 and A1.Partno=A.PartnoAsal and A1.Periode=left(convert(char,@thnbln1,112),6))PlantID2 from LP_5 A ),   " +
                //"  LP_7 as (select PartnoAsal,M3,case when PlantID2 is null then PlantID else PlantID2 end PlantID from LP_6 xx), " +
                //"   LP_07 as (select PartnoAsal,M3,PlantID from LP_7 group by PartnoAsal,M3,PlantID) " +
                //" select cast(sum(M3) as decimal(18,2))M3,PlantID into tempTtlBP_LP from LP_07 group by PlantID " +
                " LP_51 as (select PartnoAsal,M3,PlantID from LP_5 xx group by PartnoAsal,M3,PlantID ),   " +
                " LP_05 as (select PartnoAsal,M3,PlantID,(select count(PartnoAsal) from LP_51 A where A.PartnoAsal=LP_51.PartnoAsal)ttl from LP_51 group by PartnoAsal,M3,PlantID),  " +
                " LP_6 as (select *,(select top 1 A1.Line from Def_UKhususProsen A1 where A1.Partno=A.PartnoAsal and A1.Periode=left(convert(char,@thnbln1,112),6))PlantID2 from LP_05 A ),   " +
                " LP_06 as (select PartnoAsal,case when ttl=1 then m3 when ttl>1 then m3/ttl end m3,PlantID,PlantID2 from LP_6 group by PlantID,m3,ttl,PartnoAsal,PlantID2),   " +
                " LP_7 as (select PartnoAsal,M3,case when PlantID2 is null then PlantID else PlantID2 end PlantID from LP_06 xx), " +
                " LP_07 as (select PartnoAsal,M3,PlantID  from LP_7 group by PartnoAsal,M3,PlantID) " +
                " select cast(sum(M3) as decimal(18,2))M3,PlantID into tempTtlBP_LP from LP_07 group by PlantID " +
                "  " +

                " /** ListPlank OK **/ " +
                " ;with LP_1 as (select distinct ItemID,PlantID,left(convert(char,tglproduksi,112),6)ThnBln from BM_Destacking where RowStatus>-1 group by ItemID,PlantiD,TglProduksi ),   " +
                " LP_2 as (select B.PartNo,PlantID,ThnBln from LP_1 A inner join FC_Items B ON A.ItemID=B.ID),  " +
                " LP_3 as ( select PartnoAsal,isnull((sum(M3)) ,0) M3  from ( " +
                "  /** Tahap III OK **/      " +
                "  select PartnoAsal,isnull((sum(M3)),0) M3 from (  select PartnoAsal,Qty,(((Tebal*Lebar*Panjang)/1000000000)*Qty)  M3  from (  select PartnoAsal,sum(Qty)Qty,Tebal,Lebar,Panjang  from (  select x.PartNo PartnoAsal,x2.Tebal,x2.Lebar,x2.Panjang,x.Qty from (  select sum(Qty)Qty,ItemID,Keterangan Partno from vw_KartuStockBJNew  where sfrom='straping' and left(convert(char,tanggal,112),6)=left(convert(char,@thnbln1,112),6) and ItemID in  (select ID from FC_Items where PartNo like'%-M-%' or PartNo like'%-3-%')  group by ItemID,Keterangan ) as x   inner join FC_Items x2 ON x.ItemID=x2.ID) as A group by PartnoAsal,Tebal,Lebar,Panjang ) as xx ) as xx1 group by PartnoAsal     " +
                " ) as DataFinall group by PartnoAsal) , " +
                "  LP_4 as (select *,(select top 1 A1.ThnBln from LP_2 A1 where A1.PartNo=A.PartnoAsal and A1.ThnBln<=left(convert(char,@thnbln1,112),6) order by A1.ThnBln desc)ThnBln from LP_3 A), " +
                "  LP_5 as (select PartnoAsal,sum(M3)M3,ThnBln,PlantID from (select A.*,B.PlantID from LP_4 A left join LP_2 B ON A.PartnoAsal=B.PartNo and A.ThnBln=B.ThnBln ) as x group by PartnoAsal,ThnBln,PlantID),   " +
                //"  LP_6 as (select *,(select top 1 A1.Line from Def_UKhususProsen A1 where A1.Partno=A.PartnoAsal and A1.Periode=left(convert(char,@thnbln1,112),6))PlantID2 from LP_5 A ),   " +
                //"  LP_7 as (select PartnoAsal,M3,case when PlantID2 is null then PlantID else PlantID2 end PlantID from LP_6 xx), " +
                //"    LP_07 as (select PartnoAsal,M3,PlantID from LP_7 group by PartnoAsal,M3,PlantID) " +
                //" select sum(M3) M3,PlantID into tempTtlOK_LP from LP_07  group by PlantID " +
                " LP_51 as (select PartnoAsal,M3,PlantID from LP_5 xx group by PartnoAsal,M3,PlantID ),   " +
                " LP_05 as (select PartnoAsal,M3,PlantID,(select count(PartnoAsal) from LP_51 A where A.PartnoAsal=LP_51.PartnoAsal)ttl from LP_51 group by PartnoAsal,M3,PlantID),   " +
                " LP_6 as (select *,(select top 1 A1.Line from Def_UKhususProsen A1 where A1.Partno=A.PartnoAsal and A1.Periode=left(convert(char,@thnbln1,112),6))PlantID2 from LP_05 A ),   " +
                " LP_06 as (select PartnoAsal,case when ttl=1 then m3 when ttl>1 then m3/ttl end m3,PlantID,PlantID2 from LP_6 group by PlantID,m3,ttl,PartnoAsal,PlantID2),   " +
                " LP_7 as (select PartnoAsal,M3,case when PlantID2 is null then PlantID else PlantID2 end PlantID from LP_06 xx), " +
                " LP_07 as (select PartnoAsal,M3,PlantID from LP_7 group by PartnoAsal,M3,PlantID) " +
                " select sum(M3) M3,PlantID into tempTtlOK_LP from LP_07  group by PlantID " +
                "  " +

                " /** Defect ListPlank New **/ " +
                " ;with A as ( " +
                " select sum(M3)M3,PlantID from ( " +
                " select M3,PlantID from tempTtl_LP union all " +
                " select M3*-1 M3,PlantID from tempTtlOK_LP union all " +
                " select M3,PlantID from tempTtlBP_LP ) as x group by PlantID ), " +
                " B as ( " +
                " select case when PlantID=1 then 'Line 1'  when PlantID=2 then 'Line 2' when PlantID=3 then 'Line 3' " +
                " when PlantID=4 then 'Line 4'  when PlantID=5 then 'Line 5' when PlantID=6 then 'Line 6' end Line, " +
                " case when PlantID=1 then 'KA,KB,KC,KD' when PlantID=2 then 'KE,KF,KG,KH' when PlantID=3 then 'KI,KJ,KK,KL'  " +
                " when PlantID=4 then 'KM,KN,KO,KP' when PlantID=5 then 'KQ,KR,KS,KT' when PlantID=6 then 'KU,KV,KW,KX' end [Group],M3  from A  ), " +
                " C as ( " +
                " SELECT A.[Line],Split.a.value('.', 'VARCHAR(100)') AS [Group],(M3/4) M3    " +
                " FROM (SELECT [Line],CAST ('<M>' + REPLACE([Group],',', '</M><M>') + '</M>' AS XML) AS String,M3 FROM B) AS A CROSS APPLY String.nodes ('/M') AS Split(a)) " +
                "  " +
                " select [Group],sum(M3)M3 into tempDefect_ListPlank_detail from ( " +
                " select Line,[Group],M3  from C " +
                " union all " +
                " select Line,[Group],'0'M3 from temp_GroupNow2 ) as x group by [Group] " +
                "  " +
                " /** Defect ListPlank New2 **/ " +
                " ;with A as ( " +
                " select sum(M3)M3,PlantID from ( " +
                " select M3,PlantID from tempTtl_LP ) as x group by PlantID ), " +
                " B as ( " +
                " select case when PlantID=1 then 'Line 1'  when PlantID=2 then 'Line 2' when PlantID=3 then 'Line 3' " +
                " when PlantID=4 then 'Line 4'  when PlantID=5 then 'Line 5' when PlantID=6 then 'Line 6' end Line, " +
                " case when PlantID=1 then 'KA,KB,KC,KD' when PlantID=2 then 'KE,KF,KG,KH' when PlantID=3 then 'KI,KJ,KK,KL'  " +
                " when PlantID=4 then 'KM,KN,KO,KP' when PlantID=5 then 'KQ,KR,KS,KT' when PlantID=6 then 'KU,KV,KW,KX' end [Group],M3  from A  ), " +
                " C as ( " +
                " SELECT A.[Line],Split.a.value('.', 'VARCHAR(100)') AS [Group],(M3/4) M3    " +
                " FROM (SELECT [Line],CAST ('<M>' + REPLACE([Group],',', '</M><M>') + '</M>' AS XML) AS String,M3 FROM B) AS A CROSS APPLY String.nodes ('/M') AS Split(a)) " +
                "  " +
                " select [Group],sum(M3)M3 into tempDefect_ListPlank_detail2 from ( " +
                " select Line,[Group],M3  from C " +
                " union all " +
                " select Line,[Group],'0'M3 from temp_GroupNow2 ) as x group by [Group] " +
                "  " +
                " /** Total Potong BP ListPlank **/ " +
                " select sum(M3)M3,PlantID into tempTotalPotong_BP_LP from ( " +
                " select * from tempTtlBP_LP union all " +
                " select * from tempTtlOK_LP union all " +
                " select * from tempTtl_LP ) as x group by PlantID " +
                "  " +
                " /** Total Potong ListPlank **/ " +
                " select sum(M3)M3,PlantID into tempTotalPotong_LP from ( " +
                " select * from tempTotalPotong_BP_LP union all " +
                " select * from tempTtl_LP ) as x group by PlantID " +
                "  " +
                " /** Total Potong ListPlank dan Ukuran Khusus : tidak di pakai for krwg **/ " +
                " set @TotPot_LP_UKhusus=isnull(( select sum(M3) from ( " +
                "  select cast(sum(M3) as decimal(18,2))M3 from tempTotalPotong_UkuranKhusus " +
                "  union all " +
                "  select cast(sum(M3) as decimal(18,1))M3 from tempDefect_ListPlank_detail " +
                "  ) as x),0) " +
                "  " +
                "  select [Group] into tempGroup_LPUK from ( " +
                "  select [Group] from tempDefect_UkuranKhusus_detail where M3>0 or M3<0 union all " +
                "   select [Group] from tempDefect_ListPlank_detail where M3>0 or M3<0 ) as x group by [Group] " +
                "    " +
                " set @TotGroup_LP_UKhusus=(select count([Group]) from tempGroup_LPUK) " +
                "  " +
                " /** utk krwg **/ " +
                "  select [Group],sum(M3)M3 into tempTotalPot_LP_UkuranKhusus from ( " +
                "  select * from tempTotalPotong_UkuranKhusus union all " +
                "  select * from tempDefect_ListPlank_detail2 ) as x group by [Group] " +
                "  " +
                " /** Total Potong ListPlank Detail Per Group **/ " +
                " select case when PlantID=1 then 'Line 1'  when PlantID=2 then 'Line 2' when PlantID=3 then 'Line 3' " +
                " when PlantID=4 then 'Line 4'  when PlantID=5 then 'Line 5' when PlantID=6 then 'Line 6' end Line, " +
                " case when PlantID=1 then 'KA,KB,KC,KD' when PlantID=2 then 'KE,KF,KG,KH' when PlantID=3 then 'KI,KJ,KK,KL'  " +
                " when PlantID=4 then 'KM,KN,KO,KP' when PlantID=5 then 'KQ,KR,KS,KT' when PlantID=6 then 'KU,KV,KW,KX' end [Group],M3 into tempGroup from tempTtlOK_LP   " +
                "  " +
                " SELECT A.[Line],Split.a.value('.', 'VARCHAR(100)') AS [Group],(M3/4) M3 into tempGroup2   " +
                " FROM (SELECT [Line],CAST ('<M>' + REPLACE([Group],',', '</M><M>') + '</M>' AS XML) AS String,M3 FROM tempGroup) AS A CROSS APPLY String.nodes ('/M') AS Split(a);  " +
                "  " +
                "   /** Accounting Report Mutasi WiP : Pengeluaran B99 **/   " +
                "  set @OutBP_WiP = (  select cast((sum(M3)) as decimal(18,2))BP_M3  from (  select sum(Qty)Qty,sum(M3)M3 from (  select *,cast(((Qty*Volume)) as decimal(18,5))M3 from (  select sum(A.qty *-1) Qty,(B.Tebal*B.Lebar*B.Panjang)/1000000000 Volume from vw_KartustockWIP A   inner join FC_Items B ON A.itemid0=B.ID  where qty<0   and lokasi='B99' and process<>'lari' and process<>'listplank' and left(convert(char,tanggal,112),8)>=@thnbln1 and  left(convert(char,tanggal,112),8)<=@thnbln2   group by tebal,lebar,panjang ) as x ) as x1    " +
                "  union all   " +
                "  select sum(Qty)Qty,sum(M3)M3 from (  select *,cast(((Qty*Volume)) as decimal(18,5))M3 from (  select isnull(SUM(qty)*-1,0)Qty,(I2.Tebal*I2.Lebar*I2.Panjang)/1000000000 Volume from vw_KartustockWIP2 V   inner join FC_Items I on V.itemID=I.ID inner join FC_Items I2 on I2.ID=V.itemid0 and (I.partno  like '%-p-%'  )  where qty<0  and idrec not like '%ou%'    and process='lari'and lokid1 not in (select ID from fc_lokasi where lokasi='I99') and  left(convert(char,tanggal,112),8)>=@thnbln1 and left(convert(char,tanggal,112),8)<=@thnbln2  group by I2.tebal,I2.lebar,I2.panjang) as x ) as x1 ) as xx )  " +
                "  " +

                //" select [Group],cast((M3) as decimal(18,2))M3 into tempDefect_BM_detail0 from (select [Group],cast(m3 as decimal(18,2))M3,DefName from ( " +
                //" select [Group],cast(m3 as decimal(18,2))M3,DefName from ( " +
                //" select [Group],sum(Kubik)M3,DefName  from (  " +
                //" select * from tempDefect_BM " +
                //" ) as x group by [Group],DefName " +
                //" ) as xx " +
                //" ) as xxx ) as xxxx " +
                //"  " +

                " select [Group],M3 into tempDefect_BM_detail0 from (select cast(sum(kubik) as decimal(10,1))M3,[Group] from tempDefect_BM group by [Group] ) as x group by [Group],M3  " +

                " /** Total : Defect System BM **/ " +
                " set @Total_tempDefect_BM_detail = isnull((select M3 from (select cast((sum(M3)) as decimal(18,1))M3 from tempDefect_BM_detail0) as x),1)   " +

                " /** Total : Defect System Finishing **/ " +
                " set @Total_tempDefect_Fin_detail = (select M3 from (select cast((sum(Kubik)) as decimal(18,1))M3 from tempDefect_Fin) as x)  " +

                " /** Total : Selisih Total Defect **/ " +
                " set @Selisih_ttl_defect = (select cast(@OutBP_WiP as decimal(18,1)) - cast((@Total_tempDefect_BM_detail) as decimal(18,1)) - cast((@Total_tempDefect_Fin_detail) as decimal(18,1)))  " +

                "  " +
                " select [Group],cast(sum(M3) as decimal(18,1))M3 into tempDefect_BM_detail from (select  * from tempData_Group union all select [Group],m3  from tempDefect_BM_detail0 ) as x group by [Group] order by [Group] " +
                "  " +
                " select [Group],((M3/@Total_tempDefect_BM_detail)*@Selisih_ttl_defect)  M3 into Selisih_ttl_defect_Detail from tempDefect_BM_detail order by [group]  " +
                " select [Group],(((M3/@Total_tempDefect_BM_detail)*@Total_tempDefect_Fin_detail)) M3 into tempDefect_Fin_detail from tempDefect_BM_detail  " +
                "  " +
                " /** Defect BM dan Finishing **/ " +
                " select [Group],sum(M3)M3 into tempDefect_BM_FN_detail from ( " +
                " select [Group],M3 from tempDefect_BM_detail union all " +
                " select [Group],M3 from tempDefect_Fin_detail union all " +
                " select [Group],M3 from Selisih_ttl_defect_Detail ) as x group by [Group] " +
                "  " +
                "  /** Defect Produksi **/ " +
                "  select [Group],sum(M3)M3 into tempDefect_Produksi_detail from ( " +
                "  select * from tempDefect_UkuranKhusus_detail union all " +
                "  select * from tempDefect_ListPlank_detail union all " +
                "  select * from tempDefect_BM_FN_detail ) as x group by [Group] " +
                "  " +
                "  /** BS Tahap 1 **/ " +
                "  select distinct itemid into tempMasterDataBSauto from vw_KartuStockBJNew where itemid in (select ID from fc_items where partno like '%-s-%') and LokID in (select ID from FC_Lokasi where Lokasi='bsauto')  " +
                "  ;with BSTahap as (select distinct itemid from vw_KartuStockBJNew where itemid in (select ID from fc_items where partno like '%-s-%') and  LokID in (select ID from FC_Lokasi where Lokasi='bsauto')  ),  " +
                "  BSTahap1 as (select * from vw_KartuStockBJNew where left(CONVERT(char, tanggal ,112),6)=left(convert(char,@thnbln1,112),6) and itemID in   (select itemid from tempMasterDataBSauto)),  BSTahap2 as (select * from vw_KartuStockBJNew where left(CONVERT(char, tanggal ,112),6)=left(convert(char,@thnbln1,112),6) and itemID not in   (select itemid from tempMasterDataBSauto) ),  " +
                "  BSTahap3 as (select isnull(sum(Qty),0)Qty,isnull(sum(Qty*Volume),0)M3  from (  select x.qty Qty,((x1.Tebal*x1.Lebar*x1.Panjang)/1000000000)Volume from (  select Qty,ItemID from BSTahap1 where (process='direct' or process like'%Simetris%') and (isnull(sfrom,'-')='-' or isnull(sfrom,'bevel')='-'  or isnull(sfrom,'-')='straping') and lokid in (select ID from FC_Lokasi where Lokasi='BSAUTO') and substring(Keterangan,1,21) like '%-1-%'  and left(convert(char,tanggal,112),6)=left(convert(char,@thnbln1,112),6) and PartNo  like'%-S-%') as x inner join FC_Items x1 ON x.ItemID=x1.ID ) as A  ),   " +
                "  BSTahap4 as (select isnull(sum(Qty),0)Qty,isnull(sum(Qty*Volume),0)M3 from (  select x.qty Qty,((x1.Tebal*x1.Lebar*x1.Panjang)/1000000000)Volume from (  select Qty,ItemID from BSTahap2 where (process='direct' or process like'%Simetris%') and (isnull(sfrom,'-')='-' or isnull(sfrom,'bevel')='-'  or isnull(sfrom,'-')='straping') and lokid not in (select ID from FC_Lokasi where Lokasi='BSAUTO') and substring(Keterangan,1,21) like '%-1-%'  and left(convert(char,tanggal,112),6)=left(convert(char,@thnbln1,112),6) and PartNo  like'%-S-%') as x inner join FC_Items x1 ON x.ItemID=x1.ID ) as A ),  " +
                "  BSTahap5 as (select isnull(sum(M3) ,0) M3 from (select M3 from BSTahap3 union all select M3 from BSTahap4) as x ) " +
                "  select * into tempBS_Tahap1 from BSTahap5  " +
                "  " +
                " /** Total : BS Tahap 1 **/ " +
                " set @TtlBS_Tahap1 = cast(isnull((select M3 from tempBS_Tahap1),0) as decimal(18,2)) " +
                "  " +
                " /** Total : Defect Finishing + BM **/ " +
                " set @Total_Defect_BMFin = ( @Total_tempDefect_BM_detail + @Total_tempDefect_Fin_detail + @Selisih_ttl_defect ) " +
                " /** Total Defect Ukuran Khusus **/ " +
                " set @Total_Defect_UkuranKhusus = (select M3 from (select cast((sum(M3)) as decimal(18,2))M3 from tempDefect_UkuranKhusus_detail) as x) " +
                " /** Total Defect ListPlank **/ " +
                " set @Total_Defect_ListPlank = (select M3 from (select cast((sum(M3)) as decimal(18,1))M3 from tempDefect_ListPlank_detail) as x) " +
                " /** Total Defect Produksi **/ " +
                " set @Total_DefectProduksi = cast((@Total_Defect_BMFin + @Total_Defect_UkuranKhusus + @Total_Defect_ListPlank) as decimal(18,0))   " +
                "  " +
                " select [Group],((M3/@Total_tempDefect_BM_detail)* @TtlBS_Tahap1)  M3 into tempBS_Tahap1_detail from tempDefect_BM_detail order by [group]  " +
                "  " +
                "  /** Total Defect Proposionet **/ " +
                " select  [Group],sum(M3) M3 into tempTotalDefect_Pro_detail from ( " +
                " select * from tempDefect_ListPlank_detail union all " +
                " select * from tempDefect_UkuranKhusus_detail union all " +
                " select * from tempDefect_BM_FN_detail union all " +
                " select * from tempBS_Tahap1_detail ) as x group by [Group] " +
                "  " +
                " /** Total Defect **/ " +
                " select [Group],sum(M3) M3 into tempTotalDefect_detail from ( " +
                " select * from tempDefect_BM_detail union all " +
                " select * from tempDefect_Fin_detail union all " +
                " select * from tempDefect_UkuranKhusus_detail union all " +
                " select * from tempDefect_ListPlank_detail union all " +
                " select * from tempBS_Tahap1_detail ) as x group by [Group] " +
                "  " +
                " /** Total Potong System QA **/ " +
                "  select  B.[Group],cast((sum(TPotongM3)) as decimal(18,1))M3 into tempTotalPot_QA from BM_Destacking A left join BM_PlantGroup B on A.PlantGroupID=B.ID  inner join (  select C.ID DestID , A.TPotong qtyin,A.TPotong*I.Volume as kubik,A.TPotong*I.Volume TPotongM3 from Def_Defect A   inner join BM_Destacking C on A.DestID=C.ID left join FC_Items I on I.ID=C.ItemID where A.Status>-1 and CONVERT(char,A.tgl,112)>=@thnbln1 and  CONVERT(char,A.tgl,112)<=@thnbln2 ) as C  on A.ID=C.DestID group by B.[Group] ;  " +
                "    " +
                " /** Total Potong System ListPlank Detail per Group**/ " +
                " select  [Group],sum(M3)M3 into tempTotalPot_SystemLP from ( " +
                " select * from tempTotalPot_LP_UkuranKhusus union all " +
                " select * from tempTotalPot_QA ) as x group by [Group] " +
                "  " +
                " /** Total Potong System All **/ " +
                " set @TtlPot_All=cast((select sum(M3)M3 from ( " +
                "  /** AccReport WIP Out BP, OK, KM **/ " +
                "  select cast(sum(M3) as decimal(18,1))M3  from (  select sum(Qty)Qty,sum(M3)M3 from (  select *,round((Qty*Volume),2)M3 from (  select sum(A.qty *-1) Qty,(B.Tebal*B.Lebar*B.Panjang)/1000000000 Volume from vw_KartustockWIP A   inner join FC_Items B ON A.itemid0=B.ID  where qty<0   and lokasi in ('H99','B99') and process<>'lari' and process<>'listplank' and left(convert(char,tanggal,112),8)>=@thnbln1  and left(convert(char,tanggal,112),8)<=@thnbln2   group by tebal,lebar,panjang ) as x ) as x1   " +
                "  union all   " +
                "  select sum(Qty)Qty,sum(M3)M3 from (  select *,round((Qty*Volume),2)M3 from (  select isnull(SUM(qty)*-1,0)Qty,(II.Tebal*II.Lebar*II.Panjang)/1000000000 Volume from vw_KartustockWIP2 V  " +
                " inner join FC_Items I on V.itemID=I.ID and (I.partno  like '%-3-%' or I.partno  like '%-M-%' or I.partno  like '%-P-%')  " +
                " inner join FC_Items II on V.itemid0=II.ID " +
                "  where qty<0  and idrec not like '%ou%'    and process='lari'and lokid1 not in (select ID from fc_lokasi where lokasi='I99') and  left(convert(char,tanggal,112),8)>=@thnbln1 and left(convert(char,tanggal,112),8)<=@thnbln2  group by II.tebal,II.lebar,II.panjang,itemid0) as x ) as x1 ) as xx  " +
                "  union all " +
                "  /** Defect Ukuran Khusus - AccRepot BJ Tahap 1 Out BP, OK, KM **/ " +
                "  select cast(sum(M3) as decimal(18,1))M from ( " +
                "   select SUBSTRING(x.partno,1,9)Part,x.PartNo,x.PartnoAsal,x.Qty,((A.Tebal*A.Lebar*A.Panjang)/1000000000)*x.Qty M3 from (   select REPLACE(substring(Keterangan,0,18),'-P-','-1-')Partno,PartNo PartnoAsal,ItemID,isnull(SUM(Qty),0)  * -1 Qty from vw_KartuStockBJNew  where qty <0 and (process  like '%simetris%' ) and  (Keterangan like '%-3-%' or Keterangan like '%-w-%' or  Keterangan like '%-m-%' or Keterangan like '%-P-%') and  LokID not In (select ID from FC_Lokasi where lokasi='q99')   and left(convert(char,tanggal,112),8)>=@thnbln1 and  left(convert(char,tanggal,112),8)<=@thnbln2 and ItemID in (select ID  from FC_Items where PartNo like'%-1-%') group by ItemID,Keterangan,PartNo   ) as x  inner join FC_Items A ON A.ID=x.ItemID ) as x " +
                "    union all " +
                "   select cast(sum(M3) as decimal(18,1))M3 from ( " +
                "   /** Defect LP OK **/ " +
                "   select isnull(cast((sum(M3)) as decimal(18,1)),0) M3  from (    " +
                "  select PartnoAsal,isnull(cast((sum(M3)) as decimal(18,5)),0) M3 from (  select PartnoAsal,Qty,cast((((Tebal*Lebar*Panjang)/1000000000)*Qty) as decimal(18,5)) M3  from (  select PartnoAsal,sum(Qty)Qty,Tebal,Lebar,Panjang  from (  select x.PartNo PartnoAsal,x2.Tebal,x2.Lebar,x2.Panjang,x.Qty from (  select sum(Qty)Qty,ItemID,Keterangan Partno from vw_KartuStockBJNew  where sfrom='straping' and left(convert(char,tanggal,112),6)=left(convert(char,@thnbln1,112),6) and ItemID in  (select ID from FC_Items where PartNo like'%-M-%' or PartNo like'%-3-%')  group by ItemID,Keterangan ) as x   inner join FC_Items x2 ON x.ItemID=x2.ID) as A group by PartnoAsal,Tebal,Lebar,Panjang ) as xx ) as xx1 group by PartnoAsal  ) as z  " +
                "  union all " +
                "  /** Defect LP BP **/ " +
                "  select sum(M3)M3 from tempTotalPotong_BP_LP ) as x " +
                "   union all " +
                "  /** BS Tahap 1 : AccReport BS Normal dan BS Auto in WiP T1 **/ " +
                "  select M3 from tempBS_Tahap1 " +
                "  ) as xx ) as decimal(18,1)) " +
                "  " +
                "  /** Total Potong Semua **/ " +
                "  /** Defect System OK+BP **/ " +
                "  set @TtlPot_All=isnull((select cast(sum(M3) as decimal(18,2))M3 from ( " +
                "  select sum(M3)M3 from ( " +
                "  select @OutBP_WiP M3 " +
                "    union all " +
                "     /** Defect System OK **/ " +
                " select sum(M3)M3 from ( " +
                " select sum(Qty)Qty,sum(Qty*Volume) M3 from ( " +
                " select isnull(SUM(qty)*-1,0)Qty,((B.Tebal*B.Lebar*B.Panjang)/1000000000)Volume from vw_KartustockWIP A inner join FC_Items B ON A.itemid=B.ID where qty<0 and (lokasi='H99' and process<>'lari' and process<>'listplank') and left(convert(char,tanggal,112),6)=left(convert(char,@thnbln1,112),6) group by B.Tebal,B.Lebar,B.Panjang ) as x " +
                " union all " +
                " select sum(Qty)Qty,sum(Qty*Volume) M3 from ( " +
                " select isnull(SUM(qty)*-1,0)Qty,((I2.Tebal*I2.Lebar*I2.Panjang)/1000000000)Volume from vw_KartustockWIP2 V inner join FC_Items I on V.itemID=I.ID inner join FC_Items I2 ON I2.ID=V.itemid0 and (I.partno like '%-3-%' or I.PartNo like '%-W-%' or I.PartNo like '%-m-%') where qty<0  and idrec not like '%ou%'   and process='lari' and left(convert(char,tanggal,112),6)=left(convert(char,@thnbln1,112),6) group by I2.Tebal,I2.Lebar,I2.Panjang ) as x " +
                " ) as xx ) as xx " +
                " union all " +
                "    /** Defect Ukuran Khusus OK + BP **/ " +
                "  select sum(M3)M3 from ( " +
                "   select SUBSTRING(x.partno,1,9)Part,x.PartNo,x.PartnoAsal,x.Qty,((A.Tebal*A.Lebar*A.Panjang)/1000000000)*x.Qty M3 from (   select REPLACE(substring(Keterangan,0,18),'-P-','-1-')Partno,PartNo PartnoAsal,ItemID,isnull(SUM(Qty),0)  * -1 Qty from vw_KartuStockBJNew  where qty <0 and (process  like '%simetris%' ) and  (Keterangan like '%-3-%' or Keterangan like '%-w-%' or  Keterangan like '%-m-%' or Keterangan like '%-P-%') and  LokID not In (select ID from FC_Lokasi where lokasi='q99')   and left(convert(char,tanggal,112),8)>=@thnbln1 and  left(convert(char,tanggal,112),8)<=@thnbln2 and ItemID in (select ID  from FC_Items where PartNo like'%-1-%') group by ItemID,Keterangan,PartNo   ) as x  inner join FC_Items A ON A.ID=x.ItemID ) as x " +
                "   union all    " +
                "   select sum(M3)M3 from tempDefect_ListPlank_detail  /** Defect LP BP **/ " +
                "   union all  " +
                " select sum(M3)M3 from tempTtlOK_LP  /** Defect LP OK **/ " +
                " union all " +
                " select @TtlBS_Tahap1  /** BS Tahap 1 **/ " +
                " ) as AA),0) " +
                "  " +
                " set @Selisih_TotPot=isnull(( " +
                " select sum(M3)M3 from ( " +
                " select cast(@TtlPot_All as decimal(18,5)) M3 union all " +
                " select sum(M3)*-1 M3 from tempTotalPot_SystemLP  " +
                " ) as x " +
                " ),0) " +
                "  " +

                //" select [Group],sum(M3)M3 into tempSelisih_TotPot  from ( " +
                //" select [Group],M3 from ( " +
                //" select [Group],cast(@Selisih_TotPot as decimal(18,5))/cast((select count([Group]) from tempData_Group) as decimal(18,2))M3 from temp_GroupNow1 A " +
                ////" select [Group],cast(@Selisih_TotPot as decimal(18,5))/cast((select count([Group]) from temp_ttlgrp_aktif) as decimal(18,2))M3 from temp_ttlgrp_aktif A " +
                ////" " + Aquery + "" +
                //" union all " +
                //" select [Group],cast('0' as decimal(18,0))M3 from tempData_Group) as x group by [Group],M3 ) as xx group by [Group] " +

                " " + Aquery + "" +

                "  " +
                "  /** Total Potong Proposionet **/ " +
                " select [Group],sum(M3)M3 into tempTotPot_Proposionet from ( " +
                " select * from tempSelisih_TotPot union all " +
                " select * from tempTotalPot_SystemLP ) as x group by [Group] " +
                "  " +
                " select [Group],((M3/@Total_tempDefect_BM_detail)*@Tot_OKKM)  M3 into temp_OKKM from tempDefect_BM_detail order by [group]  " +
                " select [Group],((M3/@Total_tempDefect_BM_detail)*@Tot_Retur)  M3 into temp_Retur from tempDefect_BM_detail order by [group]  " +
                " select [Group],((M3/@Total_tempDefect_BM_detail)*@Tot_Sortir)  M3 into temp_Sortir from tempDefect_BM_detail order by [group]  " +
                "  " +
                " select [Group],sum(M3)M3 into temp_TotalDefect from ( " +
                " select [Group],M3 from tempTotalDefect_Pro_detail union all " +
                " select [Group],M3 from temp_Retur union all " +
                " select [Group],M3 from temp_Sortir union all " +
                " select [Group],M3*-1 from temp_OKKM ) as x group by [Group] " +
                "  " +
                " select [Group],M3 * 100 M3 into temp_Persen from ( " +
                " select [Group],isnull(M3/(select NULLIF(M3,0) from tempTotPot_Proposionet A where A.[Group]=B.[Group]),0) M3  from temp_TotalDefect B ) as x " +
                "  " +
                "    " +
                " /** Kumpulkan semua data **/ " +
                " select [Group],sum(M3) DefectBM_M3,sum(B)DefectFin_M3,sum(C)Selisih_Ttl_Ptg,sum(D)Defect_BMFIN,sum(E)Defect_UKhusus,sum(F)Defect_ListPlank,sum(G)Defect_Produksi,sum(H)BS_Tahap1,sum(T)Total_Defect0,sum(I)Total_Defect_Pro,sum(J)Total_Pot_SystemQA,sum(K)Total_Pot_LP_UK,sum(L)Total_Pot_SystemLP,sum(M)Selisih_TotPot,sum(N)TotPot_Proposionet,sum(O)OK_KM,sum(P)Retur,sum(Q)Sortir,sum(R)Total_Defect,sum(S)Persen into temp_Total " +
                " from ( " +
                " select [Group],M3,'0'B,'0'C,'0'D,'0'E,'0'F,'0'G,'0'H,'0'I,'0'J,'0'K,'0'L,'0'M,'0'N,'0'O,'0'P,'0'Q,'0'R,'0'S,'0'T from tempDefect_BM_detail " +
                " union all " +
                " select [Group],'0'A,M3,'0'C,'0'D,'0'E,'0'F,'0'G,'0'H,'0'I,'0'J,'0'K,'0'L,'0'M,'0'N,'0'O,'0'P,'0'Q,'0'R,'0'S,'0'T from tempDefect_Fin_detail " +
                " union all " +
                " select [Group],'0'A,'0'B,M3,'0'D,'0'E,'0'F,'0'G,'0'H,'0'I,'0'J,'0'K,'0'L,'0'M,'0'N,'0'O,'0'P,'0'Q,'0'R,'0'S,'0'T from Selisih_ttl_defect_Detail " +
                " union all " +
                " select [Group],'0'A,'0'B,'0'C,M3,'0'E,'0'F,'0'G,'0'H,'0'I,'0'J,'0'K,'0'L,'0'M,'0'N,'0'O,'0'P,'0'Q,'0'R,'0'S,'0'T from tempDefect_BM_FN_detail  " +
                " union all " +
                " select [Group],'0'A,'0'B,'0'C,'0'D,M3,'0'F,'0'G,'0'H,'0'I,'0'J,'0'K,'0'L,'0'M,'0'N,'0'O,'0'P,'0'Q,'0'R,'0'S,'0'T from tempDefect_UkuranKhusus_detail  " +
                " union all " +
                " select [Group],'0'A,'0'B,'0'C,'0'D,'0'E,M3,'0'G,'0'H,'0'I,'0'J,'0'K,'0'L,'0'M,'0'N,'0'O,'0'P,'0'Q,'0'R,'0'S,'0'T from tempDefect_ListPlank_detail " +
                " union all " +
                " select [Group],'0'A,'0'B,'0'C,'0'D,'0'E,'0'F,M3,'0'H,'0'I,'0'J,'0'K,'0'L,'0'M,'0'N,'0'O,'0'P,'0'Q,'0'R,'0'S,'0'T from tempDefect_Produksi_detail " +
                " union all " +
                " select [Group],'0'A,'0'B,'0'C,'0'D,'0'E,'0'F,'0'G,M3,'0'I,'0'J,'0'K,'0'L,'0'M,'0'N,'0'O,'0'P,'0'Q,'0'R,'0'S,'0'T from tempBS_Tahap1_detail " +
                " union all " +
                " select [Group],'0'A,'0'B,'0'C,'0'D,'0'E,'0'F,'0'G,'0'H,M3,'0'J,'0'K,'0'L,'0'M,'0'N,'0'O,'0'P,'0'Q,'0'R,'0'S,'0'T from tempTotalDefect_Pro_detail " +
                " union all " +
                " select [Group],'0'A,'0'B,'0'C,'0'D,'0'E,'0'F,'0'G,'0'H,'0'I,M3,'0'K,'0'L,'0'M,'0'N,'0'O,'0'P,'0'Q,'0'R,'0'S,'0'T from tempTotalPot_QA " +
                " union all " +
                " select [Group],'0'A,'0'B,'0'C,'0'D,'0'E,'0'F,'0'G,'0'H,'0'I,'0'J,M3,'0'L,'0'M,'0'N,'0'O,'0'P,'0'Q,'0'R,'0'S,'0'T from tempTotalPot_LP_UkuranKhusus " +
                " union all " +
                " select [Group],'0'A,'0'B,'0'C,'0'D,'0'E,'0'F,'0'G,'0'H,'0'I,'0'J,'0'K,M3,'0'M,'0'N,'0'O,'0'P,'0'Q,'0'R,'0'S,'0'T from tempTotalPot_SystemLP " +
                " union all " +
                " select [Group],'0'A,'0'B,'0'C,'0'D,'0'E,'0'F,'0'G,'0'H,'0'I,'0'J,'0'K,'0'L,M3,'0'N,'0'O,'0'P,'0'Q,'0'R,'0'S,'0'T from tempSelisih_TotPot " +
                " union all " +
                " select [Group],'0'A,'0'B,'0'C,'0'D,'0'E,'0'F,'0'G,'0'H,'0'I,'0'J,'0'K,'0'L,'0'M,M3,'0'O,'0'P,'0'Q,'0'R,'0'S,'0'T from tempTotPot_Proposionet " +
                " union all " +
                " select [Group],'0'A,'0'B,'0'C,'0'D,'0'E,'0'F,'0'G,'0'H,'0'I,'0'J,'0'K,'0'L,'0'M,'0'N,M3,'0'P,'0'Q,'0'R,'0'S,'0'T from temp_OKKM " +
                " union all " +
                " select [Group],'0'A,'0'B,'0'C,'0'D,'0'E,'0'F,'0'G,'0'H,'0'I,'0'J,'0'K,'0'L,'0'M,'0'N,'0'O,M3,'0'Q,'0'R,'0'S,'0'T from temp_Retur " +
                " union all " +
                " select [Group],'0'A,'0'B,'0'C,'0'D,'0'E,'0'F,'0'G,'0'H,'0'I,'0'J,'0'K,'0'L,'0'M,'0'N,'0'O,'0'P,M3,'0'R,'0'S,'0'T from temp_Sortir " +
                " union all " +
                " select [Group],'0'A,'0'B,'0'C,'0'D,'0'E,'0'F,'0'G,'0'H,'0'I,'0'J,'0'K,'0'L,'0'M,'0'N,'0'O,'0'P,'0'Q,M3,'0'S,'0'T from temp_TotalDefect " +
                " union all " +
                " select [Group],'0'A,'0'B,'0'C,'0'D,'0'E,'0'F,'0'G,'0'H,'0'I,'0'J,'0'K,'0'L,'0'M,'0'N,'0'O,'0'P,'0'Q,'0'R,M3,'0'T from temp_Persen " +
                " union all " +
                " select [Group],'0'A,'0'B,'0'C,'0'D,'0'E,'0'F,'0'G,'0'H,'0'I,'0'J,'0'K,'0'L,'0'M,'0'N,'0'O,'0'P,'0'Q,'0'R,'0'S,M3 from tempTotalDefect_detail " +
                " ) as x group by [Group] order by [Group] " +
                "  " +
                " select * into temp_DataDefectISO from  ( " +
                " select [Group],cast((DefectBM_M3) as decimal(18,1))DefectBM_M3,cast((DefectFin_M3)as decimal(18,1))DefectFin_M3,cast((Selisih_Ttl_Ptg)as decimal(18,1))Selisih_Ttl_Ptg,cast((Defect_BMFIN)as decimal(18,1))Defect_BMFIN,cast((Defect_UKhusus)as decimal(18,1))Defect_UKhusus,cast((Defect_ListPlank)as decimal(18,1))Defect_ListPlank,cast((Defect_Produksi)as decimal(18,1))Defect_Produksi,cast((BS_Tahap1)as decimal(18,1))BS_Tahap1,cast((Total_Defect0)as decimal(18,1))Total_Defect0,cast((Total_Defect_Pro)as decimal(18,1))Total_Defect_Pro,cast((Total_Pot_SystemQA)as decimal(18,1))Total_Pot_SystemQA,cast((Total_Pot_LP_UK)as decimal(18,1))Total_Pot_LP_UK,cast((Total_Pot_SystemLP)as decimal(18,1))Total_Pot_SystemLP,cast((Selisih_TotPot)as decimal(18,1))Selisih_TotPot,cast((TotPot_Proposionet)as decimal(18,1))TotPot_Proposionet,cast((OK_KM)as decimal(18,1))OK_KM,cast((Retur)as decimal(18,1))Retur,cast((Sortir)as decimal(18,1))Sortir,cast((Total_Defect)as decimal(18,1))Total_Defect,isnull(cast(((Total_Defect)/(nullif(TotPot_Proposionet,0)))*100 as decimal(18,1)),0)Persentase from temp_Total " +
                " union all " +
                " select 'Total'Total,cast(sum(DefectBM_M3) as decimal(18,1)),cast(sum(DefectFin_M3)as decimal(18,1)),cast(sum(Selisih_Ttl_Ptg)as decimal(18,1)),cast(sum(Defect_BMFIN)as decimal(18,1)),cast(sum(Defect_UKhusus)as decimal(18,1)),cast(sum(Defect_ListPlank)as decimal(18,1)),cast(sum(Defect_Produksi)as decimal(18,1)),cast(sum(BS_Tahap1)as decimal(18,1)),cast(sum(Total_Defect0)as decimal(18,1)),cast(sum(Total_Defect_Pro)as decimal(18,1)),cast(sum(Total_Pot_SystemQA)as decimal(18,1)),cast(sum(Total_Pot_LP_UK)as decimal(18,1)),cast(sum(Total_Pot_SystemLP)as decimal(18,1)),cast(sum(Selisih_TotPot)as decimal(18,1)),cast(sum(TotPot_Proposionet)as decimal(18,1)),cast(sum(OK_KM)as decimal(18,1)),cast(sum(Retur)as decimal(18,1)),cast(sum(Sortir)as decimal(18,1)),cast(sum(Total_Defect)as decimal(18,1)),cast((sum(Total_Defect)/sum(TotPot_Proposionet))*100 as decimal(18,1)) from temp_Total  " +
                " ) as x " +



                #region Line - 1
                " declare @TotalPotong decimal(18,2) " +
                " declare @TotalDefKhusus decimal(18,2)   " +
                " declare @DefKhusus decimal(18,2)   " +
                " declare @Ttotalkw1kw2 decimal(18,2)  " +
                " declare @NCSortir decimal(18,2)   " +
                " declare @Retur decimal(18,2)  " +
                " set @TotalPotong=isnull((select sum(totkubik ) from tempdefectGPIsoTot),0) " +

                " declare @TotalPotongL1 decimal(18,2) " +
                " declare @TotDefKhususL1 decimal(18,2)  " +
                " declare @DefKhususL1 decimal(18,2)  " +
                " declare @Ttotalkw1kw2L1 decimal(18,2)  " +
                " declare @NCSortirL1 decimal(18,2)  " +
                " declare @ReturL1 decimal(18,2)  " +
                " declare @DefectFinL1 decimal(18,2) " +

                //" set @TotalPotongL1=(select isnull(sum(totkubik ),0) from tempdefectGPIsoTot where [group]in (select [group] from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 1'))) " +
                " set @TotalPotongL1=isnull((select sum(M3) from tempTotPot_Proposionet where [group]in (select [group] from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 1'))),0) " +
                " set @TotDefKhususL1=(@TotalPotongL1/nullif(@TotalPotong,0))*@TotalDefKhusus " +
                " set @DefKhususL1=(@TotalPotongL1/nullif(@TotalPotong,0))*@DefKhusus " +
                " set @Ttotalkw1kw2L1=(@TotalPotongL1/nullif(@TotalPotong,0))*@Ttotalkw1kw2 " +
                " set @NCSortirL1=(@TotalPotongL1/nullif(@TotalPotong,0))*@NCSortir " +
                " set @ReturL1=(@TotalPotongL1/nullif(@TotalPotong,0))*@Retur " +
                //" set @DefectFinL1=isnull((@TotalPotongL1/@TotalPotong)*@DefectFin,0) " +

                " if @TotalPotongL1>0 " +
                " begin " +
                " select [Group],cast((b) as decimal(18,2))b,cast((c) as decimal(18,2))c,cast((d) as decimal(18,2))d,cast((e) as decimal(18,2))e,cast((f) as decimal(18,2))f,cast((g) as decimal(18,2))g,cast((i) as decimal(18,2))i,j into tempdefectL1 from ( " +
                " select * from ( " +
                " select [Group], " +
                " case when @TotalPotongL1>0 then isnull((select cast((TotPot_Proposionet) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)  else 0 end b, " +
                " case when @TotalPotongL1>0 then ((isnull((select cast((Defect_Produksi) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end c, " +
                " case when @TotalPotongL1>0 then ((isnull((select cast((OK_KM) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0))) else 0 end  d,  " +
                " case when @TotalPotongL1>0 then ((isnull((select cast((Sortir) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  e, " +
                " case when @TotalPotongL1>0 then ((isnull((select cast((Retur) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  f, " +
                " case when @TotalPotongL1>0 then ((isnull((select cast((BS_Tahap1) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end g,  " +
                " case when @TotalPotongL1>0 then ((isnull((select cast((Total_Defect) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end i, " +
                " case when @TotalPotongL1>0 then ((isnull((select cast((Persentase) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end j " +
                " from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 1') )A " +

                " union all  " +

                " select 'Total' [Group],sum(b)b,sum(c)c,sum(d)d,sum(e)e,sum(f)f,sum(g)g,sum(i) i,isnull((sum(nullif(i,0))/sum(nullif(b,0)))*100,0) j" +
                " from( " +
                " select [Group], " +
                " case when @TotalPotongL1>0 then isnull((select cast((TotPot_Proposionet) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)  else 0 end b,  " +
                " case when @TotalPotongL1>0 then ((isnull((select cast((Defect_Produksi) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end c,  " +
                " case when @TotalPotongL1>0 then ((isnull((select cast((OK_KM) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0))) else 0 end  d, " +
                " case when @TotalPotongL1>0 then ((isnull((select cast((Sortir) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  e,  " +
                " case when @TotalPotongL1>0 then ((isnull((select cast((Retur) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  f,  " +
                " case when @TotalPotongL1>0 then ((isnull((select cast((BS_Tahap1) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end g,  " +
                " case when @TotalPotongL1>0 then ((isnull((select cast((Total_Defect) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end i, " +
                " case when @TotalPotongL1>0 then ((isnull((select cast((Persentase) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end j " +
                " from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 1'))A )B " +
                " end " +
                " else " +
                " begin " +
                " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 i, 0 j into tempdefectL1 " +
                " end " +
                #endregion
 " " +
                #region Line - 2
 " declare @TotalPotongL2 decimal(18,2) " +
                " declare @TotDefKhususL2 decimal(18,2) " +
                " declare @DefKhususL2 decimal(18,2) " +
                " declare @Ttotalkw1kw2L2 decimal(18,2) " +
                " declare @NCSortirL2 decimal(18,2) " +
                " declare @ReturL2 decimal(18,2) " +
                " declare @DefectFinL2 decimal(18,2) " +

                //" set @TotalPotongL2=(select isnull(sum(totkubik ),0) from tempdefectGPIsoTot where [group]in (select [group] from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 2'))) " +
                " set @TotalPotongL2=isnull((select sum(M3) from tempTotPot_Proposionet where [group]in (select [group] from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 2'))),0) " +
                " set @TotDefKhususL2=(@TotalPotongL2/nullif(@TotalPotong,0))*@TotalDefKhusus " +
                " set @DefKhususL2=(@TotalPotongL2/nullif(@TotalPotong,0))*@DefKhusus " +
                " set @Ttotalkw1kw2L2=(@TotalPotongL2/nullif(@TotalPotong,0))*@Ttotalkw1kw2 " +
                " set @NCSortirL2=(@TotalPotongL2/nullif(@TotalPotong,0))*@NCSortir " +
                " set @ReturL2=(@TotalPotongL2/nullif(@TotalPotong,0))*@Retur " +
                //" set @DefectFinL2=isnull((@TotalPotongL2/@TotalPotong)*@DefectFin,0) " +

                " if @TotalPotongL2>0 " +
                " begin " +
                " select [Group],cast((b) as decimal(18,1))b,cast((c) as decimal(18,1))c,cast((d) as decimal(18,1))d,cast((e) as decimal(18,1))e,cast((f) as decimal(18,1))f,cast((g) as decimal(18,1))g,cast((i) as decimal(18,1))i,j into tempdefectL2 from ( " +
                " select * from ( " +
                " select [Group], " +
                " case when @TotalPotongL2>0 then isnull((select cast((TotPot_Proposionet) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)  else 0 end b,  " +
                " case when @TotalPotongL2>0 then ((isnull((select cast((Defect_Produksi) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end c,  " +
                " case when @TotalPotongL2>0 then ((isnull((select cast((OK_KM) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0))) else 0 end  d, " +
                " case when @TotalPotongL2>0 then ((isnull((select cast((Sortir) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  e,  " +
                " case when @TotalPotongL2>0 then ((isnull((select cast((Retur) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  f,  " +
                " case when @TotalPotongL2>0 then ((isnull((select cast((BS_Tahap1) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end g , " +
                " case when @TotalPotongL2>0 then ((isnull((select cast((Total_Defect) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end i, " +
                 " case when @TotalPotongL2>0 then ((isnull((select cast((Persentase) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end j " +
                " from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 2') )A " +

                " union all  " +

                " select 'Total' [Group],sum(b)b,sum(c)c,sum(d)d,sum(e)e,sum(f)f,sum(g)g,sum(i) i,(sum(nullif(i,0))/sum(nullif(b,0)))*100 j " +
                " from( select [Group], " +
                " case when @TotalPotongL2>0 then isnull((select cast((TotPot_Proposionet) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)  else 0 end b,  " +
                " case when @TotalPotongL2>0 then ((isnull((select cast((Defect_Produksi) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end c,  " +
                " case when @TotalPotongL2>0 then ((isnull((select cast((OK_KM) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0))) else 0 end  d, " +
                " case when @TotalPotongL2>0 then ((isnull((select cast((Sortir) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  e,  " +
                " case when @TotalPotongL2>0 then ((isnull((select cast((Retur) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  f,  " +
                " case when @TotalPotongL2>0 then ((isnull((select cast((BS_Tahap1) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end g,  " +
                " case when @TotalPotongL2>0 then ((isnull((select cast((Total_Defect) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end i, " +
                " case when @TotalPotongL1>0 then ((isnull((select cast((Persentase) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end j " +
                " from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 2'))A )B " +
                " end " +
                " else " +
                " begin " +
                " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 i, 0 j into tempdefectL2 " +
                " end " +
                #endregion
 " " +
                #region Lin3 - 3
                " declare @TotalPotongL3 decimal(18,2) " +
                " declare @TotDefKhususL3 decimal(18,2) " +
                " declare @DefKhususL3 decimal(18,2) " +
                " declare @Ttotalkw1kw2L3 decimal(18,2) " +
                " declare @NCSortirL3 decimal(18,2) " +
                " declare @ReturL3 decimal(18,2) " +
                " declare @DefectFinL3 decimal(18,2) " +

                //" set @TotalPotongL3=(select isnull(sum(totkubik ),0) from tempdefectGPIsoTot where [group]in (select [group] from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 3'))) " +
                " set @TotalPotongL3=isnull((select sum(M3) from tempTotPot_Proposionet where [group]in (select [group] from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 3'))),0) " +
                " set @TotDefKhususL3=(@TotalPotongL3/nullif(@TotalPotong,0))*@TotalDefKhusus " +
                " set @DefKhususL3=(@TotalPotongL3/nullif(@TotalPotong,0))*@DefKhusus " +
                " set @Ttotalkw1kw2L3=(@TotalPotongL3/nullif(@TotalPotong,0))*@Ttotalkw1kw2 " +
                " set @NCSortirL3=(@TotalPotongL3/nullif(@TotalPotong,0))*@NCSortir " +
                " set @ReturL3=(@TotalPotongL3/nullif(@TotalPotong,0))*@Retur " +

                " if @TotalPotongL3>0 " +
                " begin " +
                " select [Group],cast((b) as decimal(18,1))b,cast((c) as decimal(18,1))c,cast((d) as decimal(18,1))d,cast((e) as decimal(18,1))e,cast((f) as decimal(18,1))f,cast((g) as decimal(18,1))g,cast((i) as decimal(18,1))i,j into tempdefectL3 from ( " +
                " select * from ( select [Group], " +
                " case when @TotalPotongL3>0 then isnull((select cast((TotPot_Proposionet) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)  else 0 end b,  " +
                " case when @TotalPotongL3>0 then ((isnull((select cast((Defect_Produksi) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end c,  " +
                " case when @TotalPotongL3>0 then ((isnull((select cast((OK_KM) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0))) else 0 end  d, " +
                " case when @TotalPotongL3>0 then ((isnull((select cast((Sortir) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  e,  " +
                " case when @TotalPotongL3>0 then ((isnull((select cast((Retur) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  f,  " +
                " case when @TotalPotongL3>0 then ((isnull((select cast((BS_Tahap1) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end g,  " +
                " case when @TotalPotongL3>0 then ((isnull((select cast((Total_Defect) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end i, " +
                " case when @TotalPotongL3>0 then ((isnull((select cast((Persentase) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end j " +
                " from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 3') )A " +

                " union all  " +

                " select 'Total' [Group],sum(b)b,sum(c)c,sum(d)d,sum(e)e,sum(f)f,sum(g)g,sum(i) i,isnull((sum(nullif(i,0))/sum(nullif(b,0)))*100,0) j " +
                " from( " +
                " select [Group], " +
                " case when @TotalPotongL3>0 then isnull((select cast((TotPot_Proposionet) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)  else 0 end b,  " +
                " case when @TotalPotongL3>0 then ((isnull((select cast((Defect_Produksi) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end c,  " +
                " case when @TotalPotongL3>0 then ((isnull((select cast((OK_KM) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0))) else 0 end  d, " +
                " case when @TotalPotongL3>0 then ((isnull((select cast((Sortir) as decimal(18,2))M33 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  e,  " +
                " case when @TotalPotongL3>0 then ((isnull((select cast((Retur) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  f,  " +
                " case when @TotalPotongL3>0 then ((isnull((select cast((BS_Tahap1) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end g,  " +
                " case when @TotalPotongL3>0 then ((isnull((select cast((Total_Defect) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end i, " +
                " case when @TotalPotongL3>0 then ((isnull((select cast((Persentase) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end j " +
                " from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 3'))A )B " +
                " end " +
                " else " +
                " begin " +
                " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 i, 0 j into tempdefectL3 " +
                " end " +
                #endregion
 " " +
                #region Line - 4
 " declare @TotalPotongL4 decimal(18,2) " +
                " declare @TotDefKhususL4 decimal(18,2) " +
                " declare @DefKhususL4 decimal(18,2) " +
                " declare @Ttotalkw1kw2L4 decimal(18,2) " +
                " declare @NCSortirL4 decimal(18,2) " +
                " declare @ReturL4 decimal(18,2) " +
                " declare @DefectFinL4 decimal(18,2) " +

                //" set @TotalPotongL4=(select isnull(sum(totkubik ),0) from tempdefectGPIsoTot where [group]in (select [group] from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 4'))) " +
                " set @TotalPotongL4=isnull((select sum(M3) from tempTotPot_Proposionet where [group]in (select [group] from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 4'))),0) " +
                " set @TotDefKhususL4=(@TotalPotongL4/nullif(@TotalPotong,0))*@TotalDefKhusus " +
                " set @DefKhususL4=(@TotalPotongL4/nullif(@TotalPotong,0))*@DefKhusus " +
                " set @Ttotalkw1kw2L4=(@TotalPotongL4/nullif(@TotalPotong,0))*@Ttotalkw1kw2 " +
                " set @NCSortirL4=(@TotalPotongL4/nullif(@TotalPotong,0))*@NCSortir " +
                " set @ReturL4=(@TotalPotongL4/nullif(@TotalPotong,0))*@Retur " +
                //" set @DefectFinL4=isnull((@TotalPotongL4/@TotalPotong)*@DefectFin,0) " +

                " if @TotalPotongL4>0 " +
                " begin " +
                " select [Group],cast((b) as decimal(18,1))b,cast((c) as decimal(18,1))c,cast((d) as decimal(18,1))d,cast((e) as decimal(18,1))e,cast((f) as decimal(18,1))f,cast((g) as decimal(18,1))g,cast((i) as decimal(18,1))i,j into tempdefectL4 from ( " +
                " select * from ( " +
                " select [Group], " +
                " case when @TotalPotongL4>0 then isnull((select cast((TotPot_Proposionet) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)  else 0 end b,  " +
                " case when @TotalPotongL4>0 then ((isnull((select cast((Defect_Produksi) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end c,  " +
                " case when @TotalPotongL4>0 then ((isnull((select cast((OK_KM) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0))) else 0 end  d, " +
                " case when @TotalPotongL4>0 then ((isnull((select cast((Sortir) as decimal(18,2))M33 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  e,  " +
                " case when @TotalPotongL4>0 then ((isnull((select cast((Retur) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  f,  " +
                " case when @TotalPotongL4>0 then ((isnull((select cast((BS_Tahap1) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end g,  " +
                " case when @TotalPotongL4>0 then ((isnull((select cast((Total_Defect) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end i, " +
                " case when @TotalPotongL4>0 then ((isnull((select cast((Persentase) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end j " +
                " from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 4') )A " +

                " union all  " +

                " select 'Total' [Group],sum(b)b,sum(c)c,sum(d)d,sum(e)e,sum(f)f,sum(g)g,sum(i) i,(sum(nullif(i,0))/sum(nullif(b,0)))*100 j" +
                " from( select [Group], " +
                " ((isnull((select cast((TotPot_Proposionet) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0))) b, " +
                " ((isnull((select cast((Defect_Produksi) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0))) c, " +
                " ((isnull((select cast((OK_KM) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0))) d, " +
                " ((isnull((select cast((Sortir) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0))) e, " +
                " ((isnull((select cast((Retur) as decimal(18,2))M33 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0))) f, " +
                " ((isnull((select cast((BS_Tahap1) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0))) g, " +
                " ((isnull((select cast((Total_Defect) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0))) i, " +
                " ((isnull((select cast((Persentase) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0))) j " +
                " from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 4'))A )B " +
                " end " +
                " else " +
                " begin " +
                " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 i, 0 j into tempdefectL4 " +
                " end " +
                #endregion
 " " +
                #region Line - 5
                " declare @TotalPotongL5 decimal(18,2) " +
                " declare @TotDefKhususL5 decimal(18,2) " +
                " declare @DefKhususL5 decimal(18,2) " +
                " declare @Ttotalkw1kw2L5 decimal(18,2) " +
                " declare @NCSortirL5 decimal(18,2) " +
                " declare @ReturL5 decimal(18,2) " +
                " declare @DefectFinL5 decimal(18,2) " +

                //" set @TotalPotongL5=(select isnull(sum(totkubik ),0) from tempdefectGPIsoTot where [group]in (select [group] from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 5'))) " +
                " set @TotalPotongL5=isnull((select sum(M3) from tempTotPot_Proposionet where [group]in (select [group] from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 5'))),0) " +
                " set @TotDefKhususL5=(@TotalPotongL5/nullif(@TotalPotong,0))*@TotalDefKhusus " +
                " set @DefKhususL5=(@TotalPotongL5/nullif(@TotalPotong,0))*@DefKhusus " +
                " set @Ttotalkw1kw2L5=(@TotalPotongL5/nullif(@TotalPotong,0))*@Ttotalkw1kw2 " +
                " set @NCSortirL5=(@TotalPotongL5/nullif(@TotalPotong,0))*@NCSortir " +
                " set @ReturL5=(@TotalPotongL5/nullif(@TotalPotong,0))*@Retur " +
                //" set @DefectFinL5=isnull((@TotalPotongL5/@TotalPotong)*@DefectFin,0) " +

                " if @TotalPotongL5>0 " +
                " begin " +
                " select [Group],cast((b) as decimal(18,1))b,cast((c) as decimal(18,1))c,cast((d) as decimal(18,1))d,cast((e) as decimal(18,1))e,cast((f) as decimal(18,1))f,cast((g) as decimal(18,1))g,cast((i) as decimal(18,1))i,j into tempdefectL5 from ( " +
                " select * from ( " +
                " select [Group], " +
                " case when @TotalPotongL5>0 then isnull((select cast((TotPot_Proposionet) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)  else 0 end b,  " +
                " case when @TotalPotongL5>0 then ((isnull((select cast((Defect_Produksi) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end c,  " +
                " case when @TotalPotongL5>0 then ((isnull((select cast((OK_KM) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0))) else 0 end  d, " +
                " case when @TotalPotongL5>0 then ((isnull((select cast((Sortir) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  e,  " +
                " case when @TotalPotongL5>0 then ((isnull((select cast((Retur) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  f,  " +
                " case when @TotalPotongL5>0 then ((isnull((select cast((BS_Tahap1) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end g,  " +
                " case when @TotalPotongL5>0 then ((isnull((select cast((Total_Defect) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end i, " +
                " case when @TotalPotongL5>0 then ((isnull((select cast((Persentase) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end j " +
                " from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 5') )A " +

                "union all  " +

                " select 'Total' [Group],sum(b)b,sum(c)c,sum(d)d,sum(e)e,sum(f)f,sum(g)g,sum(i) i,(sum(nullif(i,0))/sum(nullif(b,0)))*100 j " +
                " from( select [Group], " +
                " ((isnull((select cast((TotPot_Proposionet) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0))) b, " +
                " ((isnull((select cast((Defect_Produksi) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0))) c, " +
                " ((isnull((select cast((OK_KM) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0))) d, " +
                " ((isnull((select cast((Sortir) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0))) e, " +
                " ((isnull((select cast((Retur) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0))) f, " +
                " ((isnull((select cast((BS_Tahap1) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0))) g, " +
                " ((isnull((select cast((Total_Defect) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0))) i, " +
                " ((isnull((select cast((Persentase) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0))) j " +
                " from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 5'))A )B " +
                " end " +
                " else " +
                " begin " +
                " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 i, 0 j into tempdefectL5 " +
                " end " +
                #endregion
 " " +
                #region Line - 6
                " declare @TotalPotongL6 decimal(18,2) " +
                " declare @TotDefKhususL6 decimal(18,2) " +
                " declare @DefKhususL6 decimal(18,2) " +
                " declare @Ttotalkw1kw2L6 decimal(18,2) " +
                " declare @NCSortirL6 decimal(18,2) " +
                " declare @ReturL6 decimal(18,2) " +
                " declare @DefectFinL6 decimal(18,2) " +

                //" set @TotalPotongL6=(select isnull(sum(totkubik ),0) from tempdefectGPIsoTot where [group]in (select [group] from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 6'))) " +
                " set @TotalPotongL6=isnull((select sum(M3) from tempTotPot_Proposionet where [group]in (select [group] from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 6'))),0) " +
                " set @TotDefKhususL6=(@TotalPotongL6/nullif(@TotalPotong,0))*@TotalDefKhusus " +
                " set @DefKhususL6=(@TotalPotongL6/nullif(@TotalPotong,0))*@DefKhusus " +
                " set @Ttotalkw1kw2L6=(@TotalPotongL6/nullif(@TotalPotong,0))*@Ttotalkw1kw2 " +
                " set @NCSortirL6=(@TotalPotongL6/nullif(@TotalPotong,0))*@NCSortir " +
                " set @ReturL6=(@TotalPotongL6/nullif(@TotalPotong,0))*@Retur " +
                //" set @DefectFinL6=isnull((@TotalPotongL6/@TotalPotong)*@DefectFin,0) " +

                " if @TotalPotongL6>0 " +
                " begin " +
                " select [Group],cast((b) as decimal(18,1))b,cast((c) as decimal(18,1))c,cast((d) as decimal(18,1))d,cast((e) as decimal(18,1))e,cast((f) as decimal(18,1))f,cast((g) as decimal(18,1))g,cast((i) as decimal(18,1))i,j into tempdefectL6 from ( " +
                " select * from ( " +
                " select [Group], " +
                " case when @TotalPotongL6>0 then isnull((select cast((TotPot_Proposionet) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)  else 0 end b,  " +
                " case when @TotalPotongL6>0 then ((isnull((select cast((Defect_Produksi) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end c,  " +
                " case when @TotalPotongL6>0 then ((isnull((select cast((OK_KM) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0))) else 0 end  d, " +
                " case when @TotalPotongL6>0 then ((isnull((select cast((Sortir) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  e,  " +
                " case when @TotalPotongL6>0 then ((isnull((select cast((Retur) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end  f,  " +
                " case when @TotalPotongL6>0 then ((isnull((select cast((BS_Tahap1) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end g,  " +
                " case when @TotalPotongL6>0 then ((isnull((select cast((Total_Defect) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end i, " +
                " case when @TotalPotongL6>0 then ((isnull((select cast((Persentase) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0)))  else 0 end j " +
                " from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 6') )A " +

                "union all  " +

                " select 'Total' [Group],sum(b)b,sum(c)c,sum(d)d,sum(e)e,sum(f)f,sum(g)g,sum(i) i,(sum(nullif(i,0))/sum(nullif(b,0)))*100 j " +
                " from( select [Group], " +
                " ((isnull((select cast((TotPot_Proposionet) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0))) b, " +
                " ((isnull((select cast((Defect_Produksi) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0))) c, " +
                " ((isnull((select cast((OK_KM) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0))) d, " +
                " ((isnull((select cast((Sortir) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0))) e, " +
                " ((isnull((select cast((Retur) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0))) f, " +
                " ((isnull((select cast((BS_Tahap1) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0))) g, " +
                " ((isnull((select cast((Total_Defect) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0))) i, " +
                " ((isnull((select cast((Persentase) as decimal(18,2))M3 from temp_DataDefectISO where [group]=BM_PlantGroup.[Group] ),0))) j " +
                " from BM_PlantGroup where PlantID in (select id from BM_Plant where PlantName='line 6'))A )B " +
                 //" end " +
                 //" else " +
                 //" begin " +
                 //" select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 i, 0 j into tempdefectL6 " +
                 //" end " +
                 " end " +
                        " else " +
                        " begin " +
                        " select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 i, 0 j into tempdefectL6 " +
                        " end " +
                #endregion

            //" select [group],cast((b) as decimal(18,2))b,cast((c) as decimal(18,2))c,cast((d) as decimal(18,2))d,cast((e) as decimal(18,2))e,cast((f) as decimal(18,2))f,case when [group]<>'total' then cast((g) as decimal(18,2)) when [group]='total' then cast((g) as decimal(18,2)) end g,i,j from tempdefectL1 " +

            " select [group],b,c,d,e,f,g,i,case when [group]='total' then cast((i/b)*100 as decimal(18,1)) else j end j from ( " +
            " select [group],cast((b) as decimal(18,0))b,cast((c) as decimal(18,2))c,cast((d) as decimal(18,2))d,cast((e) as decimal(18,2))e,cast((f) as decimal(18,2))f, " +
            " case when [group]<>'total' then cast((g) as decimal(18,2)) when [group]='total' then cast((g) as decimal(18,2)) end g, " +
            " cast(i as decimal(18,0))i,cast(j as decimal(18,2))j from tempdefectL1 " +
            " ) as b " +

    " select GP,i NilaiDefect,b NilaiSerah,'" + DateTime.Parse(txtdrtanggal.Text).ToString("yyyyMM") + "'Periode  into tempDataSarmut_Defect from " +
    " ( " +
    " select case when [Group]='Total' then 'Total_L1' else [Group] end GP,b,i from tempdefectL1 union all " +
    " select case when [Group]='Total' then 'Total_L2' else [Group] end GP,b,i from tempdefectL2 union all  " +
    " select case when [Group]='Total' then 'Total_L3' else [Group] end GP,b,i from tempdefectL3 union all  " +
    " select case when [Group]='Total' then 'Total_L4' else [Group] end GP,b,i from tempdefectL4 union all " +
    " select case when [Group]='Total' then 'Total_L5' else [Group] end GP,b,i from tempdefectL5 union all " +
    " select case when [Group]='Total' then 'Total_L6' else [Group] end GP,b,i from tempdefectL6   " +
    " )A  where GP<>'' ";

                //" else " +
                //" begin " +
                //" select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 i, 0 j into tempdefectL1 " +
                //" select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 i, 0 j into tempdefectL2 " +
                //" select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 i, 0 j into tempdefectL3 " +
                //" select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 i, 0 j into tempdefectL4 " +
                //" select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 i, 0 j into tempdefectL5 " +
                //" select '' [group],0 b,0 c,0 d,0 e,0 f,0 g,0 i, 0 j into tempdefectL6 " +
                //" end " +
                //" select [group],cast((b) as decimal(18,2))b,cast((c) as decimal(18,2))c,cast((d) as decimal(18,2))d,cast((e) as decimal(18,2))e,cast((f) as decimal(18,2))f,case when [group]<>'total' then cast((g) as decimal(18,2)) when [group]='total' then cast((g) as decimal(18,2)) end g,i,j from tempdefectL1 ";


            }
            #endregion

            SqlConnection sqlCon = new SqlConnection(Global.ConnectionString());
            sqlCon.Open();
            SqlDataAdapter da = new SqlDataAdapter(strSQL, sqlCon);
            da.SelectCommand.CommandTimeout = 0;
            #region loadDynamicGrid1
            #region Code for preparing the DataTable
            DataTable dt = new DataTable();
            da.Fill(dt);
            DataColumn dcol = new DataColumn(ID, typeof(System.Int32));
            dcol.AutoIncrement = true;
            #endregion
            GrdDynamic.Columns.Clear();
            foreach (DataColumn col in dt.Columns)
            {
                BoundField bfield = new BoundField();
                bfield.DataField = col.ColumnName;
                bfield.HeaderText = col.ColumnName;
                //bfield.DataFormatString = "{0:N0}";
                if (Convert.ToInt32(strtgl1.Substring(0, 6)) > 201910)
                {
                    if (bfield.HeaderText.Trim() == "Group")
                        bfield.ItemStyle.HorizontalAlign = HorizontalAlign.Center;
                    else
                    {
                        bfield.ItemStyle.HorizontalAlign = HorizontalAlign.Right;
                        if (RBKubik.Checked == true)
                            bfield.DataFormatString = "{0:N0}";
                        else
                            bfield.DataFormatString = "{0:N0}";

                    }
                    if (bfield.HeaderText.Trim() == "b")
                    {
                        bfield.HeaderText = "TOTAL SERAH PRODUK TAHAP 1 ke TAHAP 3";
                        bfield.DataFormatString = "{0:N0}";
                    }

                    if (bfield.HeaderText.Trim() == "c")
                    {
                        bfield.HeaderText = "DEFECT PRODUKSI";
                        bfield.DataFormatString = "{0:N0}";
                    }

                    if (bfield.HeaderText.Trim() == "d")
                    {
                        bfield.HeaderText = "OK KM 1200 X 2400";
                        bfield.DataFormatString = "{0:N0}";
                    }

                    if (bfield.HeaderText.Trim() == "e")
                    {
                        bfield.HeaderText = "NC SORTIR";
                        bfield.DataFormatString = "{0:N0}";
                    }

                    if (bfield.HeaderText.Trim() == "f")
                    {
                        bfield.HeaderText = "RETUR";
                        bfield.DataFormatString = "{0:N0}";
                    }

                    if (bfield.HeaderText.Trim() == "g")
                    {
                        bfield.HeaderText = "BS TAHAP I";
                        bfield.DataFormatString = "{0:N0}";
                    }

                    if (bfield.HeaderText.Trim() == "i")
                    {
                        bfield.HeaderText = "TOTAL DEFECT";
                        bfield.DataFormatString = "{0:N0}";
                    }

                    if (bfield.HeaderText.Trim() == "j")
                    {
                        bfield.HeaderText = "%";
                        bfield.DataFormatString = "{0:N1}";
                    }


                    GrdDynamic.Columns.Add(bfield);
                }
                else
                {
                    if (bfield.HeaderText.Trim() == "Group")
                        bfield.ItemStyle.HorizontalAlign = HorizontalAlign.Center;
                    else
                    {
                        bfield.ItemStyle.HorizontalAlign = HorizontalAlign.Right;
                        if (RBKubik.Checked == true)
                            bfield.DataFormatString = "{0:N1}";
                        else
                            bfield.DataFormatString = "{0:N0}";

                    }
                    if (bfield.HeaderText.Trim() == "b")
                    {
                        bfield.HeaderText = "TOTAL SERAH PRODUK TAHAP 1 ke TAHAP 3";
                    }
                    if (bfield.HeaderText.Trim() == "c")
                        bfield.HeaderText = "DEFECT BOARDMILL";
                    if (bfield.HeaderText.Trim() == "d")
                        bfield.HeaderText = "OK KM 1200 X 2400";
                    if (bfield.HeaderText.Trim() == "e")
                        bfield.HeaderText = "NC SORTIR";
                    if (bfield.HeaderText.Trim() == "f")
                        bfield.HeaderText = "RETUR";
                    if (bfield.HeaderText.Trim() == "g")
                        bfield.HeaderText = "DEFECT FINISHING";
                    if (bfield.HeaderText.Trim() == "h")
                        bfield.HeaderText = "DEFECT UKURAN KHUSUS";
                    if (bfield.HeaderText.Trim() == "i")
                    {
                        bfield.HeaderText = "TOTAL DEFECT";

                    }
                    if (bfield.HeaderText.Trim() == "j")
                    {
                        bfield.HeaderText = "%";
                        bfield.DataFormatString = "{0:N1}";
                    }

                    GrdDynamic.Columns.Add(bfield);
                }
            }
            #endregion
            GrdDynamic.DataSource = dt;
            GrdDynamic.DataBind();
            ZetroView zl = new ZetroView();
            zl.QueryType = Operation.CUSTOM;
            //zl.CustomQuery = "drop table tempdest";
            SqlDataReader sdr = zl.Retrieve();

            #region Insert Data Temp to SARMUT

            string strError = ""; int Approval = -1; int ada = 0;
            ZetroView zInsert = new ZetroView();
            zInsert.QueryType = Operation.CUSTOM;
            zInsert.CustomQuery =
            " delete Temp_DefectSarMut where Periode='" + DateTime.Parse(txtdrtanggal.Text).ToString("yyyyMM") + "' " +
            " insert Temp_DefectSarMut " +
            " select GP,NilaiSerah,NilaiDefect,Periode " +
            " from tempDataSarmut_Defect ";
            SqlDataReader sdUpdate = zInsert.Retrieve();

            ArrayList arrDefect = new ArrayList();
            SarmutPESFacade sarPesDefect = new SarmutPESFacade();
            arrDefect = sarPesDefect.RetrieveUserDefect();
            foreach (SarmutPes uc in arrDefect)
            {
                ZetroView zv0 = new ZetroView();
                zv0.QueryType = Operation.CUSTOM;
                zv0.CustomQuery =
                " select sum(ada)ada from ( " +
                " select ID ada from PES_Nilai where UserID_ISO='" + uc.UserID + "' and Periode='" + DateTime.Parse(txtdrtanggal.Text).ToString("yyyyMM") + "' " +
                " and ItemSarMut='" + uc.ItemSarMut + "' and RowStatus>-1 " +
                " union all " +
                " select 0 ) as x ";
                SqlDataReader dr0 = zv0.Retrieve();
                if (dr0.HasRows)
                {
                    while (dr0.Read())
                    {
                        ada = Convert.ToInt32(dr0["ada"]);
                    }
                }

                ZetroView zv = new ZetroView();
                zv.QueryType = Operation.CUSTOM;
                zv.CustomQuery =
                " select sum(Approval)Approval from ( " +
                " select Approval from ISO_KPIDetail where KPIID in (select ID from ISO_KPI where left(convert(char,tglmulai,112),6)='" + DateTime.Parse(txtdrtanggal.Text).ToString("yyyyMM") + "' " +
                " and DeptID in (2,25,27) and ISO_UserID='" + uc.UserID + "' and RowStatus>-1 and CategoryID in (select ID from ISO_UserCategory  " +
                " where Sarmut='" + uc.ItemSarMut + "')) and RowStatus>-1 " +
                "  union all " +
                " select 0 ) as x ";
                SqlDataReader dr = zv.Retrieve();
                if (dr.HasRows)
                {
                    while (dr.Read())
                    {
                        Approval = Convert.ToInt32(dr["Approval"]);
                    }
                }

                if (Approval == 0 && ada == 0)
                {
                    ZetroView zInsert2 = new ZetroView();
                    zInsert2.QueryType = Operation.CUSTOM;
                    zInsert2.CustomQuery =
                        "exec sp_InsertNilaiPES '" + uc.UserID + "', '" + DateTime.Parse(txtdrtanggal.Text).ToString("yyyyMM") + "','" + uc.ItemSarMut + "','0' ";
                    SqlDataReader sdrInsert2 = zInsert2.Retrieve();
                }
                else if (Approval == 0 && ada > 0)
                {
                    ZetroView zInsert2 = new ZetroView();
                    zInsert2.QueryType = Operation.CUSTOM;
                    zInsert2.CustomQuery =
                        "exec sp_InsertNilaiPES '" + uc.UserID + "', '" + DateTime.Parse(txtdrtanggal.Text).ToString("yyyyMM") + "','" + uc.ItemSarMut + "','" + ada + "' ";
                    SqlDataReader sdrInsert2 = zInsert2.Retrieve();
                }
            }
            #endregion

        }
        private void loadDynamicGrid2(string tgl1)
        {
            ddlBulan_SelectedIndexChanged(null, null);
            Users users = (Users)Session["Users"];
            string strStocker = string.Empty;
            if (txtdrtanggal.Text == string.Empty || txtsdtanggal.Text == string.Empty)
            {
                return;
            }
            DateTime intgl1 = DateTime.Parse(txtdrtanggal.Text);
            DateTime intgl2 = DateTime.Parse(txtsdtanggal.Text);
            string tglproses = string.Empty; string strtgl1 = intgl1.ToString("yyyyMMdd");

            string thnbln = ddTahun.SelectedValue + ddlBulan.SelectedValue.ToString().PadLeft(2, '0');
            //string strSQL = " select [group],round(b,1)b,round(c,1)c,round(d,1)d,round(e,1)e,round(f,1)f,case when [group]<>'total' then round(g,1) when [group]='total' then round(g,1) end g,i,j  from tempdefectL2 order by [group] ";
            //string strSQL = "  select [Group],round(c,0)c,round(d,0)d,round(e,0)e,round(f,0)f,round(g,0)g,round(i,0)i,round(j,0)j from tempdefectL2 order by [group] ";
            string strSQL =
           " select [group],b,c,d,e,f,g,i,case when [group]='total' then cast((i/b)*100 as decimal(18,1)) else j end j from ( " +
           " select [group],cast((b) as decimal(18,0))b,cast((c) as decimal(18,2))c,cast((d) as decimal(18,2))d,cast((e) as decimal(18,2))e,cast((f) as decimal(18,2))f, " +
           " case when [group]<>'total' then cast((g) as decimal(18,2)) when [group]='total' then cast((g) as decimal(18,2)) end g, " +
           " cast(i as decimal(18,0))i,cast(j as decimal(18,2))j from tempdefectL2 " +
           " ) as b ";
            SqlConnection sqlCon = new SqlConnection(Global.ConnectionString());
            sqlCon.Open();
            SqlDataAdapter da = new SqlDataAdapter(strSQL, sqlCon);
            da.SelectCommand.CommandTimeout = 0;
            #region Code for preparing the DataTable
            DataTable dt = new DataTable();
            da.Fill(dt);
            DataColumn dcol = new DataColumn(ID, typeof(System.Int32));
            dcol.AutoIncrement = true;
            #endregion
            GrdDynamic2.Columns.Clear();
            foreach (DataColumn col in dt.Columns)
            {
                BoundField bfield = new BoundField();
                bfield.DataField = col.ColumnName;
                bfield.HeaderText = col.ColumnName;
                //bfield.DataFormatString = "{0:N0}";
                if (Convert.ToInt32(strtgl1.Substring(0, 6)) > 201910)
                {
                    if (bfield.HeaderText.Trim() == "Group")
                        bfield.ItemStyle.HorizontalAlign = HorizontalAlign.Center;
                    else
                    {
                        bfield.ItemStyle.HorizontalAlign = HorizontalAlign.Right;
                        if (RBKubik.Checked == true)
                            bfield.DataFormatString = "{0:N0}";
                        else
                            bfield.DataFormatString = "{0:N0}";

                    }

                    if (bfield.HeaderText.Trim() == "b")
                    {
                        bfield.HeaderText = "TOTAL SERAH PRODUK TAHAP 1 ke TAHAP 3";
                        bfield.DataFormatString = "{0:N0}";
                    }

                    if (bfield.HeaderText.Trim() == "c")
                    {
                        bfield.HeaderText = "DEFECT PRODUKSI";
                        bfield.DataFormatString = "{0:N0}";
                    }

                    if (bfield.HeaderText.Trim() == "d")
                    {
                        bfield.HeaderText = "OK KM 1200 X 2400";
                        bfield.DataFormatString = "{0:N0}";
                    }

                    if (bfield.HeaderText.Trim() == "e")
                    {
                        bfield.HeaderText = "NC SORTIR";
                        bfield.DataFormatString = "{0:N0}";
                    }

                    if (bfield.HeaderText.Trim() == "f")
                    {
                        bfield.HeaderText = "RETUR";
                        bfield.DataFormatString = "{0:N0}";
                    }

                    if (bfield.HeaderText.Trim() == "g")
                    {
                        bfield.HeaderText = "BS TAHAP I";
                        bfield.DataFormatString = "{0:N0}";
                    }

                    if (bfield.HeaderText.Trim() == "i")
                    {
                        bfield.HeaderText = "TOTAL DEFECT";
                        bfield.DataFormatString = "{0:N0}";
                    }

                    if (bfield.HeaderText.Trim() == "j")
                    {
                        bfield.HeaderText = "%";
                        bfield.DataFormatString = "{0:N1}";
                    }

                    GrdDynamic2.Columns.Add(bfield);
                }
                else
                {
                    if (bfield.HeaderText.Trim() == "Group")
                        bfield.ItemStyle.HorizontalAlign = HorizontalAlign.Center;
                    else
                    {
                        bfield.ItemStyle.HorizontalAlign = HorizontalAlign.Right;
                        if (RBKubik.Checked == true)
                            bfield.DataFormatString = "{0:N1}";
                        else
                            bfield.DataFormatString = "{0:N0}";

                    }
                    if (bfield.HeaderText.Trim() == "b")
                    {
                        bfield.HeaderText = "TOTAL SERAH PRODUK TAHAP 1 ke TAHAP 3";
                    }
                    if (bfield.HeaderText.Trim() == "c")
                        bfield.HeaderText = "DEFECT BOARDMILL";
                    if (bfield.HeaderText.Trim() == "d")
                        bfield.HeaderText = "OK KM 1200 X 2400";
                    if (bfield.HeaderText.Trim() == "e")
                        bfield.HeaderText = "NC SORTIR";
                    if (bfield.HeaderText.Trim() == "f")
                        bfield.HeaderText = "RETUR";
                    //if (bfield.HeaderText.Trim() == "g")
                    //    bfield.HeaderText = "DEFECT FINISHING";
                    if (bfield.HeaderText.Trim() == "h")
                        bfield.HeaderText = "DEFECT UKURAN KHUSUS";
                    if (bfield.HeaderText.Trim() == "i")
                    {
                        bfield.HeaderText = "TOTAL DEFECT";

                    }
                    if (bfield.HeaderText.Trim() == "j")
                    {
                        bfield.HeaderText = "%";
                        bfield.DataFormatString = "{0:N1}";
                    }

                    GrdDynamic2.Columns.Add(bfield);
                }
            }
            GrdDynamic2.DataSource = dt;
            GrdDynamic2.DataBind();


            ZetroView zl = new ZetroView();
            zl.QueryType = Operation.CUSTOM;
            //zl.CustomQuery = "drop table tempdest";
            SqlDataReader sdr = zl.Retrieve();
        }
        private void loadDynamicGrid3(string tgl1)
        {
            ddlBulan_SelectedIndexChanged(null, null);
            Users users = (Users)Session["Users"];
            string strStocker = string.Empty;
            if (txtdrtanggal.Text == string.Empty || txtsdtanggal.Text == string.Empty)
            {
                return;
            }
            DateTime intgl1 = DateTime.Parse(txtdrtanggal.Text);
            DateTime intgl2 = DateTime.Parse(txtsdtanggal.Text);
            string tglproses = string.Empty; string strtgl1 = intgl1.ToString("yyyyMMdd");

            string thnbln = ddTahun.SelectedValue + ddlBulan.SelectedValue.ToString().PadLeft(2, '0');
            //string strSQL = " select [group],round(b,1)b,round(c,1)c,round(d,1)d,round(e,1)e,round(f,1)f,case when [group]<>'total' then round(g,1) when [group]='total' then round(g,1) end g,i,j  from tempdefectL3 order by [group]";
            string strSQL =
           " select [group],b,c,d,e,f,g,i,case when [group]='total' then cast((i/b)*100 as decimal(18,1)) else j end j from ( " +
           " select [group],cast((b) as decimal(18,0))b,cast((c) as decimal(18,2))c,cast((d) as decimal(18,2))d,cast((e) as decimal(18,2))e,cast((f) as decimal(18,2))f, " +
           " case when [group]<>'total' then cast((g) as decimal(18,2)) when [group]='total' then cast((g) as decimal(18,2)) end g, " +
           " cast(i as decimal(18,0))i,cast(j as decimal(18,2))j from tempdefectL3 " +
           " ) as b ";
            SqlConnection sqlCon = new SqlConnection(Global.ConnectionString());
            sqlCon.Open();
            SqlDataAdapter da = new SqlDataAdapter(strSQL, sqlCon);
            da.SelectCommand.CommandTimeout = 0;
            #region Code for preparing the DataTable
            DataTable dt = new DataTable();
            da.Fill(dt);
            DataColumn dcol = new DataColumn(ID, typeof(System.Int32));
            dcol.AutoIncrement = true;
            #endregion
            GrdDynamic3.Columns.Clear();
            foreach (DataColumn col in dt.Columns)
            {
                BoundField bfield = new BoundField();
                bfield.DataField = col.ColumnName;
                bfield.HeaderText = col.ColumnName;
                //bfield.DataFormatString = "{0:N0}";
                if (Convert.ToInt32(strtgl1.Substring(0, 6)) > 201910)
                {
                    if (bfield.HeaderText.Trim() == "Group")
                        bfield.ItemStyle.HorizontalAlign = HorizontalAlign.Center;
                    else
                    {
                        bfield.ItemStyle.HorizontalAlign = HorizontalAlign.Right;
                        if (RBKubik.Checked == true)
                            bfield.DataFormatString = "{0:N1}";
                        else
                            bfield.DataFormatString = "{0:N0}";
                    }

                    if (bfield.HeaderText.Trim() == "b")
                    {
                        bfield.HeaderText = "TOTAL SERAH PRODUK TAHAP 1 ke TAHAP 3";
                        bfield.DataFormatString = "{0:N0}";
                    }

                    if (bfield.HeaderText.Trim() == "c")
                    {
                        bfield.HeaderText = "DEFECT PRODUKSI";
                        bfield.DataFormatString = "{0:N0}";
                    }

                    if (bfield.HeaderText.Trim() == "d")
                    {
                        bfield.HeaderText = "OK KM 1200 X 2400";
                        bfield.DataFormatString = "{0:N0}";
                    }

                    if (bfield.HeaderText.Trim() == "e")
                    {
                        bfield.HeaderText = "NC SORTIR";
                        bfield.DataFormatString = "{0:N0}";
                    }

                    if (bfield.HeaderText.Trim() == "f")
                    {
                        bfield.HeaderText = "RETUR";
                        bfield.DataFormatString = "{0:N0}";
                    }

                    if (bfield.HeaderText.Trim() == "g")
                    {
                        bfield.HeaderText = "BS TAHAP I";
                        bfield.DataFormatString = "{0:N0}";
                    }

                    if (bfield.HeaderText.Trim() == "i")
                    {
                        bfield.HeaderText = "TOTAL DEFECT";
                        bfield.DataFormatString = "{0:N0}";
                    }

                    if (bfield.HeaderText.Trim() == "j")
                    {
                        bfield.HeaderText = "%";
                        bfield.DataFormatString = "{0:N1}";
                    }


                    GrdDynamic3.Columns.Add(bfield);
                }
                else
                {
                    if (bfield.HeaderText.Trim() == "Group")
                        bfield.ItemStyle.HorizontalAlign = HorizontalAlign.Center;
                    else
                    {
                        bfield.ItemStyle.HorizontalAlign = HorizontalAlign.Right;
                        if (RBKubik.Checked == true)
                            bfield.DataFormatString = "{0:N1}";
                        else
                            bfield.DataFormatString = "{0:N0}";

                    }
                    if (bfield.HeaderText.Trim() == "b")
                    {
                        bfield.HeaderText = "TOTAL SERAH PRODUK TAHAP 1 ke TAHAP 3";
                        bfield.DataFormatString = "{0:N1}";
                    }
                    if (bfield.HeaderText.Trim() == "c")
                        bfield.HeaderText = "DEFECT BOARDMILL";
                    if (bfield.HeaderText.Trim() == "d")
                        bfield.HeaderText = "OK KM 1200 X 2400";
                    if (bfield.HeaderText.Trim() == "e")
                        bfield.HeaderText = "NC SORTIR";
                    if (bfield.HeaderText.Trim() == "f")
                        bfield.HeaderText = "RETUR";
                    if (bfield.HeaderText.Trim() == "g")
                        bfield.HeaderText = "DEFECT FINISHING";
                    if (bfield.HeaderText.Trim() == "h")
                        bfield.HeaderText = "DEFECT UKURAN KHUSUS";
                    if (bfield.HeaderText.Trim() == "i")
                    {
                        bfield.HeaderText = "TOTAL DEFECT";

                    }
                    if (bfield.HeaderText.Trim() == "j")
                    {
                        bfield.HeaderText = "%";
                        bfield.DataFormatString = "{0:N1}";
                    }

                    GrdDynamic3.Columns.Add(bfield);
                }
            }
            GrdDynamic3.DataSource = dt;
            GrdDynamic3.DataBind();


            ZetroView zl = new ZetroView();
            zl.QueryType = Operation.CUSTOM;
            //zl.CustomQuery = "drop table tempdest";
            SqlDataReader sdr = zl.Retrieve();
        }
        private void loadDynamicGrid4(string tgl1)
        {
            ddlBulan_SelectedIndexChanged(null, null);
            Users users = (Users)Session["Users"];
            string strStocker = string.Empty;
            if (txtdrtanggal.Text == string.Empty || txtsdtanggal.Text == string.Empty)
            {
                return;
            }
            DateTime intgl1 = DateTime.Parse(txtdrtanggal.Text);
            DateTime intgl2 = DateTime.Parse(txtsdtanggal.Text);
            string tglproses = string.Empty; string strtgl1 = intgl1.ToString("yyyyMMdd");

            string thnbln = ddTahun.SelectedValue + ddlBulan.SelectedValue.ToString().PadLeft(2, '0');
            //string strSQL = " select [group],round(b,1)b,round(c,1)c,round(d,1)d,round(e,1)e,round(f,1)f,case when [group]<>'total' then round(g,1) when [group]='total' then round(g,1) end g,i,j  from tempdefectL4 order by [group]";
            string strSQL =
           " select [group],b,c,d,e,f,g,i,case when [group]='total' then cast((i/b)*100 as decimal(18,1)) else j end j from ( " +
           " select [group],cast((b) as decimal(18,0))b,cast((c) as decimal(18,2))c,cast((d) as decimal(18,2))d,cast((e) as decimal(18,2))e,cast((f) as decimal(18,2))f, " +
           " case when [group]<>'total' then cast((g) as decimal(18,2)) when [group]='total' then cast((g) as decimal(18,2)) end g, " +
           " cast(i as decimal(18,0))i,cast(j as decimal(18,2))j from tempdefectL4 " +
           " ) as b ";
            SqlConnection sqlCon = new SqlConnection(Global.ConnectionString());
            sqlCon.Open();
            SqlDataAdapter da = new SqlDataAdapter(strSQL, sqlCon);
            da.SelectCommand.CommandTimeout = 0;
            #region Code for preparing the DataTable
            DataTable dt = new DataTable();
            da.Fill(dt);
            DataColumn dcol = new DataColumn(ID, typeof(System.Int32));
            dcol.AutoIncrement = true;
            #endregion
            GrdDynamic4.Columns.Clear();
            foreach (DataColumn col in dt.Columns)
            {
                BoundField bfield = new BoundField();
                bfield.DataField = col.ColumnName;
                bfield.HeaderText = col.ColumnName;
                //bfield.DataFormatString = "{0:N0}";
                if (Convert.ToInt32(strtgl1.Substring(0, 6)) > 201910)
                {
                    if (bfield.HeaderText.Trim() == "Group")
                        bfield.ItemStyle.HorizontalAlign = HorizontalAlign.Center;
                    else
                    {
                        bfield.ItemStyle.HorizontalAlign = HorizontalAlign.Right;
                        if (RBKubik.Checked == true)
                            bfield.DataFormatString = "{0:N1}";
                        else
                            bfield.DataFormatString = "{0:N0}";

                    }
                    if (bfield.HeaderText.Trim() == "b")
                    {
                        bfield.HeaderText = "TOTAL SERAH PRODUK TAHAP 1 ke TAHAP 3";
                        bfield.DataFormatString = "{0:N0}";
                    }

                    if (bfield.HeaderText.Trim() == "c")
                    {
                        bfield.HeaderText = "DEFECT PRODUKSI";
                        bfield.DataFormatString = "{0:N0}";
                    }

                    if (bfield.HeaderText.Trim() == "d")
                    {
                        bfield.HeaderText = "OK KM 1200 X 2400";
                        bfield.DataFormatString = "{0:N0}";
                    }

                    if (bfield.HeaderText.Trim() == "e")
                    {
                        bfield.HeaderText = "NC SORTIR";
                        bfield.DataFormatString = "{0:N0}";
                    }

                    if (bfield.HeaderText.Trim() == "f")
                    {
                        bfield.HeaderText = "RETUR";
                        bfield.DataFormatString = "{0:N0}";
                    }

                    if (bfield.HeaderText.Trim() == "g")
                    {
                        bfield.HeaderText = "BS TAHAP I";
                        bfield.DataFormatString = "{0:N0}";
                    }

                    if (bfield.HeaderText.Trim() == "i")
                    {
                        bfield.HeaderText = "TOTAL DEFECT";
                        bfield.DataFormatString = "{0:N0}";
                    }

                    if (bfield.HeaderText.Trim() == "j")
                    {
                        bfield.HeaderText = "%";
                        bfield.DataFormatString = "{0:N1}";
                    }


                    GrdDynamic4.Columns.Add(bfield);
                }
                else
                {
                    if (bfield.HeaderText.Trim() == "Group")
                        bfield.ItemStyle.HorizontalAlign = HorizontalAlign.Center;
                    else
                    {
                        bfield.ItemStyle.HorizontalAlign = HorizontalAlign.Right;
                        if (RBKubik.Checked == true)
                            bfield.DataFormatString = "{0:N1}";
                        else
                            bfield.DataFormatString = "{0:N0}";

                    }
                    if (bfield.HeaderText.Trim() == "b")
                    {
                        bfield.HeaderText = "TOTAL SERAH PRODUK TAHAP 1 ke TAHAP 3";
                    }

                    if (bfield.HeaderText.Trim() == "c")
                    {
                        bfield.HeaderText = "DEFECT BOARDMILL";
                        bfield.DataFormatString = "{0:N2}";
                    }

                    if (bfield.HeaderText.Trim() == "d")
                    {
                        bfield.HeaderText = "OK KM 1200 X 2400";
                    }

                    if (bfield.HeaderText.Trim() == "e")
                    {
                        bfield.HeaderText = "NC SORTIR";
                    }

                    if (bfield.HeaderText.Trim() == "f")
                    {
                        bfield.HeaderText = "RETUR";
                    }

                    if (bfield.HeaderText.Trim() == "g")
                    {
                        bfield.HeaderText = "DEFECT FINISHING";
                    }
                    if (bfield.HeaderText.Trim() == "h")
                    {
                        bfield.HeaderText = "DEFECT UKURAN KHUSUS";
                    }

                    if (bfield.HeaderText.Trim() == "i")
                    {
                        bfield.HeaderText = "TOTAL DEFECT";

                    }
                    if (bfield.HeaderText.Trim() == "j")
                    {
                        bfield.HeaderText = "%";
                        bfield.DataFormatString = "{0:N1}";
                    }

                    GrdDynamic4.Columns.Add(bfield);
                }
            }
            GrdDynamic4.DataSource = dt;
            GrdDynamic4.DataBind();


            ZetroView zl = new ZetroView();
            zl.QueryType = Operation.CUSTOM;
            //zl.CustomQuery = "drop table tempdest";
            SqlDataReader sdr = zl.Retrieve();
        }
        private void loadDynamicGrid5(string tgl1)
        {
            ddlBulan_SelectedIndexChanged(null, null);
            Users users = (Users)Session["Users"];
            string strStocker = string.Empty;
            if (txtdrtanggal.Text == string.Empty || txtsdtanggal.Text == string.Empty)
            {
                return;
            }
            DateTime intgl1 = DateTime.Parse(txtdrtanggal.Text);
            DateTime intgl2 = DateTime.Parse(txtsdtanggal.Text);
            string tglproses = string.Empty; string strtgl1 = intgl1.ToString("yyyyMMdd");

            string thnbln = ddTahun.SelectedValue + ddlBulan.SelectedValue.ToString().PadLeft(2, '0');
            //string strSQL = " select [group],round(b,1)b,round(c,1)c,round(d,1)d,round(e,1)e,round(f,1)f,case when [group]<>'total' then round(g,1) when [group]='total' then round(g,1) end g,i,j from tempdefectL5 order by [group] ";
            string strSQL =
           " select [group],b,c,d,e,f,g,i,case when [group]='total' then cast((i/b)*100 as decimal(18,1)) else j end j from ( " +
           " select [group],cast((b) as decimal(18,0))b,cast((c) as decimal(18,2))c,cast((d) as decimal(18,2))d,cast((e) as decimal(18,2))e,cast((f) as decimal(18,2))f, " +
           " case when [group]<>'total' then cast((g) as decimal(18,2)) when [group]='total' then cast((g) as decimal(18,2)) end g, " +
           " cast(i as decimal(18,0))i,cast(j as decimal(18,2))j from tempdefectL5 " +
           " ) as b ";
            SqlConnection sqlCon = new SqlConnection(Global.ConnectionString());
            sqlCon.Open();
            SqlDataAdapter da = new SqlDataAdapter(strSQL, sqlCon);
            da.SelectCommand.CommandTimeout = 0;
            #region Code for preparing the DataTable
            DataTable dt = new DataTable();
            da.Fill(dt);
            DataColumn dcol = new DataColumn(ID, typeof(System.Int32));
            dcol.AutoIncrement = true;
            #endregion
            GrdDynamic5.Columns.Clear();
            foreach (DataColumn col in dt.Columns)
            {
                BoundField bfield = new BoundField();
                bfield.DataField = col.ColumnName;
                bfield.HeaderText = col.ColumnName;
                //bfield.DataFormatString = "{0:N0}";
                if (Convert.ToInt32(strtgl1.Substring(0, 6)) > 201910)
                {
                    if (bfield.HeaderText.Trim() == "Group")
                        bfield.ItemStyle.HorizontalAlign = HorizontalAlign.Center;
                    else
                    {
                        bfield.ItemStyle.HorizontalAlign = HorizontalAlign.Right;
                        if (RBKubik.Checked == true)
                            bfield.DataFormatString = "{0:N1}";
                        else
                            bfield.DataFormatString = "{0:N0}";

                    }
                    if (bfield.HeaderText.Trim() == "b")
                    {
                        bfield.HeaderText = "TOTAL SERAH PRODUK TAHAP 1 ke TAHAP 3";
                        bfield.DataFormatString = "{0:N0}";
                    }

                    if (bfield.HeaderText.Trim() == "c")
                    {
                        bfield.HeaderText = "DEFECT PRODUKSI";
                        bfield.DataFormatString = "{0:N0}";
                    }

                    if (bfield.HeaderText.Trim() == "d")
                    {
                        bfield.HeaderText = "OK KM 1200 X 2400";
                        bfield.DataFormatString = "{0:N0}";
                    }

                    if (bfield.HeaderText.Trim() == "e")
                    {
                        bfield.HeaderText = "NC SORTIR";
                        bfield.DataFormatString = "{0:N0}";
                    }

                    if (bfield.HeaderText.Trim() == "f")
                    {
                        bfield.HeaderText = "RETUR";
                        bfield.DataFormatString = "{0:N0}";
                    }

                    if (bfield.HeaderText.Trim() == "g")
                    {
                        bfield.HeaderText = "BS TAHAP I";
                        bfield.DataFormatString = "{0:N0}";
                    }

                    if (bfield.HeaderText.Trim() == "i")
                    {
                        bfield.HeaderText = "TOTAL DEFECT";
                        bfield.DataFormatString = "{0:N0}";
                    }

                    if (bfield.HeaderText.Trim() == "j")
                    {
                        bfield.HeaderText = "%";
                        bfield.DataFormatString = "{0:N1}";
                    }


                    GrdDynamic5.Columns.Add(bfield);
                }
                else
                {
                    if (bfield.HeaderText.Trim() == "Group")
                        bfield.ItemStyle.HorizontalAlign = HorizontalAlign.Center;
                    else
                    {
                        bfield.ItemStyle.HorizontalAlign = HorizontalAlign.Right;
                        if (RBKubik.Checked == true)
                            bfield.DataFormatString = "{0:N1}";
                        else
                            bfield.DataFormatString = "{0:N0}";

                    }
                    if (bfield.HeaderText.Trim() == "b")
                    {
                        bfield.HeaderText = "TOTAL SERAH PRODUK TAHAP 1 ke TAHAP 3";
                        bfield.DataFormatString = "{0:N1}";
                    }
                    if (bfield.HeaderText.Trim() == "c")
                        bfield.HeaderText = "DEFECT BOARDMILL";
                    if (bfield.HeaderText.Trim() == "d")
                        bfield.HeaderText = "OK KM 1200 X 2400";
                    if (bfield.HeaderText.Trim() == "e")
                        bfield.HeaderText = "NC SORTIR";
                    if (bfield.HeaderText.Trim() == "f")
                        bfield.HeaderText = "RETUR";
                    if (bfield.HeaderText.Trim() == "g")
                        bfield.HeaderText = "DEFECT FINISHING";
                    if (bfield.HeaderText.Trim() == "h")
                        bfield.HeaderText = "DEFECT UKURAN KHUSUS";
                    if (bfield.HeaderText.Trim() == "i")
                    {
                        bfield.HeaderText = "TOTAL DEFECT";

                    }
                    if (bfield.HeaderText.Trim() == "j")
                    {
                        bfield.HeaderText = "%";
                        bfield.DataFormatString = "{0:N1}";
                    }

                    GrdDynamic5.Columns.Add(bfield);
                }
            }
            GrdDynamic5.DataSource = dt;
            GrdDynamic5.DataBind();


            ZetroView zl = new ZetroView();
            zl.QueryType = Operation.CUSTOM;
            //zl.CustomQuery = "drop table tempdest";
            SqlDataReader sdr = zl.Retrieve();
        }
        private void loadDynamicGrid6(string tgl1)
        {
            ddlBulan_SelectedIndexChanged(null, null);
            Users users = (Users)Session["Users"];
            string strStocker = string.Empty;
            if (txtdrtanggal.Text == string.Empty || txtsdtanggal.Text == string.Empty)
            {
                return;
            }
            DateTime intgl1 = DateTime.Parse(txtdrtanggal.Text);
            DateTime intgl2 = DateTime.Parse(txtsdtanggal.Text);
            string tglproses = string.Empty; string strtgl1 = intgl1.ToString("yyyyMMdd");

            string thnbln = ddTahun.SelectedValue + ddlBulan.SelectedValue.ToString().PadLeft(2, '0');
            //string strSQL = " select [group],round(b,1)b,round(c,1)c,round(d,0)d,round(e,1)e,round(f,1)f,case when [group]<>'total' then round(g,1) when [group]='total' then round(g,1) end g,i,j  from tempdefectL6 order by [group] ";
            string strSQL =
            " select [group],b,c,d,e,f,g,i,case when [group]='total' then cast((i/b)*100 as decimal(18,1)) else j end j from ( " +
            " select [group],cast((b) as decimal(18,0))b,cast((c) as decimal(18,2))c,cast((d) as decimal(18,2))d,cast((e) as decimal(18,2))e,cast((f) as decimal(18,2))f, " +
            " case when [group]<>'total' then cast((g) as decimal(18,2)) when [group]='total' then cast((g) as decimal(18,2)) end g, " +
            " cast(i as decimal(18,0))i,cast(j as decimal(18,2))j from tempdefectL6 " +
            " ) as b ";
            SqlConnection sqlCon = new SqlConnection(Global.ConnectionString());
            sqlCon.Open();
            SqlDataAdapter da = new SqlDataAdapter(strSQL, sqlCon);
            da.SelectCommand.CommandTimeout = 0;
            #region Code for preparing the DataTable
            DataTable dt = new DataTable();
            da.Fill(dt);
            DataColumn dcol = new DataColumn(ID, typeof(System.Int32));
            dcol.AutoIncrement = true;
            #endregion
            GrdDynamic6.Columns.Clear();
            foreach (DataColumn col in dt.Columns)
            {
                BoundField bfield = new BoundField();
                bfield.DataField = col.ColumnName;
                bfield.HeaderText = col.ColumnName;
                //bfield.DataFormatString = "{0:N0}";
                if (Convert.ToInt32(strtgl1.Substring(0, 6)) > 201910)
                {
                    if (bfield.HeaderText.Trim() == "Group")
                        bfield.ItemStyle.HorizontalAlign = HorizontalAlign.Center;
                    else
                    {
                        bfield.ItemStyle.HorizontalAlign = HorizontalAlign.Right;
                        if (RBKubik.Checked == true)
                            bfield.DataFormatString = "{0:N1}";
                        else
                            bfield.DataFormatString = "{0:N0}";

                    }

                    if (bfield.HeaderText.Trim() == "b")
                    {
                        bfield.HeaderText = "TOTAL SERAH PRODUK TAHAP 1 ke TAHAP 3";
                        bfield.DataFormatString = "{0:N0}";
                    }

                    if (bfield.HeaderText.Trim() == "c")
                    {
                        bfield.HeaderText = "DEFECT PRODUKSI";
                        bfield.DataFormatString = "{0:N0}";
                    }

                    if (bfield.HeaderText.Trim() == "d")
                    {
                        bfield.HeaderText = "OK KM 1200 X 2400";
                        bfield.DataFormatString = "{0:N0}";
                    }

                    if (bfield.HeaderText.Trim() == "e")
                    {
                        bfield.HeaderText = "NC SORTIR";
                        bfield.DataFormatString = "{0:N0}";
                    }

                    if (bfield.HeaderText.Trim() == "f")
                    {
                        bfield.HeaderText = "RETUR";
                        bfield.DataFormatString = "{0:N0}";
                    }

                    if (bfield.HeaderText.Trim() == "g")
                    {
                        bfield.HeaderText = "BS TAHAP I";
                        bfield.DataFormatString = "{0:N0}";
                    }

                    if (bfield.HeaderText.Trim() == "i")
                    {
                        bfield.HeaderText = "TOTAL DEFECT";
                        bfield.DataFormatString = "{0:N0}";
                    }

                    if (bfield.HeaderText.Trim() == "j")
                    {
                        bfield.HeaderText = "%";
                        bfield.DataFormatString = "{0:N1}";
                    }


                    GrdDynamic6.Columns.Add(bfield);
                }
                else
                {
                    if (bfield.HeaderText.Trim() == "Group")
                        bfield.ItemStyle.HorizontalAlign = HorizontalAlign.Center;
                    else
                    {
                        bfield.ItemStyle.HorizontalAlign = HorizontalAlign.Right;
                        if (RBKubik.Checked == true)
                            bfield.DataFormatString = "{0:N1}";
                        else
                            bfield.DataFormatString = "{0:N0}";

                    }
                    if (bfield.HeaderText.Trim() == "b")
                    {
                        bfield.HeaderText = "TOTAL SERAH PRODUK TAHAP 1 ke TAHAP 3";
                    }
                    if (bfield.HeaderText.Trim() == "c")
                        bfield.HeaderText = "DEFECT BOARDMILL";
                    if (bfield.HeaderText.Trim() == "d")
                        bfield.HeaderText = "OK KM 1200 X 2400";
                    if (bfield.HeaderText.Trim() == "e")
                        bfield.HeaderText = "NC SORTIR";
                    if (bfield.HeaderText.Trim() == "f")
                        bfield.HeaderText = "RETUR";
                    if (bfield.HeaderText.Trim() == "g")
                        bfield.HeaderText = "DEFECT FINISHING";
                    if (bfield.HeaderText.Trim() == "h")
                        bfield.HeaderText = "DEFECT UKURAN KHUSUS";
                    if (bfield.HeaderText.Trim() == "i")
                    {
                        bfield.HeaderText = "TOTAL DEFECT";

                    }
                    if (bfield.HeaderText.Trim() == "j")
                    {
                        bfield.HeaderText = "%";
                        bfield.DataFormatString = "{0:N1}";
                    }

                    GrdDynamic6.Columns.Add(bfield);
                }
            }
            GrdDynamic6.DataSource = dt;
            GrdDynamic6.DataBind();


            ZetroView zl = new ZetroView();
            zl.QueryType = Operation.CUSTOM;
            //zl.CustomQuery = "drop table tempdest";
            SqlDataReader sdr = zl.Retrieve();
        }
        private void loadDynamicGrid7(string tgl1)
        {
            ddlBulan_SelectedIndexChanged(null, null);
            Users users = (Users)Session["Users"];
            string strStocker = string.Empty; string Query1 = string.Empty;
            if (txtdrtanggal.Text == string.Empty || txtsdtanggal.Text == string.Empty)
            {
                return;
            }
            DateTime intgl1 = DateTime.Parse(txtdrtanggal.Text);
            DateTime intgl2 = DateTime.Parse(txtsdtanggal.Text);
            string tglproses = string.Empty; string strtgl1 = intgl1.ToString("yyyyMMdd");

            string A = string.Empty;

            if (RBKubik.Checked == true || RBLembar.Checked == true)
            {
                if (Convert.ToInt32(strtgl1.Substring(0, 6)) > 201910 && Convert.ToInt32(strtgl1.Substring(0, 6)) < 202002)
                {
                    A = " round(cast(((sum(c)-sum(d)+sum(e)+sum(f))/sum(b))*100 as decimal(10,2)),1) j ";
                }
                else if (Convert.ToInt32(strtgl1.Substring(0, 6)) > 202001)
                {
                    A = " case when (sum(b))*100 = 0  then 0 when (sum(b))*100 > 0 then round(cast(((sum(i)/(sum(b))))*100 as decimal(10,2)),1) end j ";
                }
                else
                {
                    A = " (sum(c)-sum(d)+sum(e)+sum(f)+sum(g)+sum(g))/sum(b)*100 j ";
                }
            }
            else if (RBKubik.Checked == false)
            {
                A = " (select ((cast(sum(Qty) as decimal(10,2))+sum(h)+(select sum(qty) Qty from vw_KartuStockBJNew where " +
                 "YEAR(tanggal)=" + ddTahun.SelectedValue + " and MONTH(tanggal)=" + ddlBulan.SelectedValue.ToString() + " and ItemID IN (SELECT ID from FC_Items where partno like'%-P-%') and Process like'%simetris%' " +
                 "and Keterangan like'%-1-%' and CutID in (select ID from T3_Simetris where QtyIn=QtyOut and RowStatus>-1)))/sum(b))*100 Qty " +
                 "from tempdefectListP3 A1 )  j  ";
            }

            #region Citeureup dan Jombang
            if (Convert.ToInt32(strtgl1.Substring(0, 6)) > 202105 && users.UnitKerjaID == 13)
            {
                Query1 =

                " update SPD_TransPrs set actual= cast((select " +
                " case when sum(b)=0 then 0 when sum(b)>0 then (sum(c)-sum(d)+sum(e)+sum(f))/sum(b)*100  end d  from ( select * from tempdefectL1 union all select * from tempdefectL2   " +
                " union all select * from tempdefectL3  union all select * from tempdefectL4  union all select * from tempdefectL5  " +
                " union all select * from tempdefectL6  )A where [group]='total' " +
                " ) as decimal(18,1)) where approval=0 and Tahun =" + ddTahun.SelectedValue + " and Bulan=" + ddlBulan.SelectedValue.ToString() +
                " and SarmutPID in (select ID from SPD_Perusahaan where SarMutPerusahaan ='Defect Board Mill') " +

                //" select [Group],TotPot_Proposionet b,Total_Defect0 c,OK_KM d,Sortir e,Retur f,BS_Tahap1 g,Total_Defect i,Persentase j from temp_DataDefectISO where [Group]='Total' " +
                " select [Group],cast(TotPot_Proposionet as decimal(18,0))b,cast(Defect_Produksi as decimal(18,0))c,cast(OK_KM as decimal(18,0))d,cast(Sortir as decimal(18,0))e,cast(Retur as decimal(18,0))f,cast(BS_Tahap1 as decimal(18,0))g,cast(Total_Defect as decimal(18,0))i,Persentase j from temp_DataDefectISO where [Group]='Total' " +


                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempData_Group]') AND type in (N'U')) DROP TABLE [dbo].[tempData_Group] " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDefect_BM]') AND type in (N'U')) DROP TABLE [dbo].[tempDefect_BM] " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDefect_Fin]') AND type in (N'U')) DROP TABLE [dbo].[tempDefect_Fin] " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDefect_Fin0]') AND type in (N'U')) DROP TABLE [dbo].[tempDefect_Fin0] " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDefect_BM_detail0]') AND type in (N'U')) DROP TABLE [dbo].[tempDefect_BM_detail0] " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDefect_BM_detail]') AND type in (N'U')) DROP TABLE [dbo].[tempDefect_BM_detail] " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDefect_Fin_detail]') AND type in (N'U')) DROP TABLE [dbo].[tempDefect_Fin_detail] " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDefect_Fin_detail0]') AND type in (N'U')) DROP TABLE [dbo].[tempDefect_Fin_detail0] " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Selisih_ttl_defect_Detail]') AND type in (N'U')) DROP TABLE [dbo].[Selisih_ttl_defect_Detail] " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDefect_BM_FN_detail]') AND type in (N'U')) DROP TABLE [dbo].[tempDefect_BM_FN_detail] " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDefect_UkuranKhusus_detail]') AND type in (N'U')) DROP TABLE [dbo].[tempDefect_UkuranKhusus_detail] " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDefect_ListPlank_detail]') AND type in (N'U')) DROP TABLE [dbo].[tempDefect_ListPlank_detail] " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDefect_ListPlank_detail2]') AND type in (N'U')) DROP TABLE [dbo].[tempDefect_ListPlank_detail2] " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDefect_Produksi_detail]') AND type in (N'U')) DROP TABLE [dbo].[tempDefect_Produksi_detail] " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempMasterDataBSauto]') AND type in (N'U')) DROP TABLE [dbo].[tempMasterDataBSauto]  " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempBS_Tahap1]') AND type in (N'U')) DROP TABLE [dbo].[tempBS_Tahap1]  " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempBS_Tahap1_detail]') AND type in (N'U')) DROP TABLE [dbo].[tempBS_Tahap1_detail]  " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTotalDefect_detail]') AND type in (N'U')) DROP TABLE [dbo].[tempTotalDefect_detail]  " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTotalDefect_Pro_detail]') AND type in (N'U')) DROP TABLE [dbo].[tempTotalDefect_Pro_detail]  " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTotalPot_QA]') AND type in (N'U')) DROP TABLE [dbo].[tempTotalPot_QA]  " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDefect_Master_ListPlank]') AND type in (N'U')) DROP TABLE [dbo].[tempDefect_Master_ListPlank]  " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTtlBP_LP]') AND type in (N'U')) DROP TABLE [dbo].[tempTtlBP_LP]  " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTtlOK_LP]') AND type in (N'U')) DROP TABLE [dbo].[tempTtlOK_LP]  " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTtl_LP]') AND type in (N'U')) DROP TABLE [dbo].[tempTtl_LP]  " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTotalPotong_BP_LP]') AND type in (N'U')) DROP TABLE [dbo].[tempTotalPotong_BP_LP]  " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTotalPotong_LP]') AND type in (N'U')) DROP TABLE [dbo].[tempTotalPotong_LP]  " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTotalPotong_UkuranKhusus]') AND type in (N'U')) DROP TABLE [dbo].[tempTotalPotong_UkuranKhusus]  " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempGroup]') AND type in (N'U')) DROP TABLE [dbo].[tempGroup]  " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempGroup2]') AND type in (N'U')) DROP TABLE [dbo].[tempGroup2]  " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempGroup3]') AND type in (N'U')) DROP TABLE [dbo].[tempGroup3]  " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTotalPot_LP_UkuranKhusus]') AND type in (N'U')) DROP TABLE [dbo].[tempTotalPot_LP_UkuranKhusus]  " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTotalPot_SystemLP]') AND type in (N'U')) DROP TABLE [dbo].[tempTotalPot_SystemLP]  " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempSelisih_TotPot]') AND type in (N'U')) DROP TABLE [dbo].[tempSelisih_TotPot]  " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTotPot_Proposionet]') AND type in (N'U')) DROP TABLE [dbo].[tempTotPot_Proposionet]  " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempGroup_LPUK]') AND type in (N'U')) DROP TABLE [dbo].[tempGroup_LPUK]  " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[temp_OKKM]') AND type in (N'U')) DROP TABLE [dbo].[temp_OKKM]  " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[temp_Retur]') AND type in (N'U')) DROP TABLE [dbo].[temp_Retur]  " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[temp_Sortir]') AND type in (N'U')) DROP TABLE [dbo].[temp_Sortir]  " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[temp_TotalDefect]') AND type in (N'U')) DROP TABLE [dbo].[temp_TotalDefect]  " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[temp_Persen]') AND type in (N'U')) DROP TABLE [dbo].[temp_Persen]  " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[temp_Total]') AND type in (N'U')) DROP TABLE [dbo].[temp_Total]  " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[temp_DataDefectISO]') AND type in (N'U')) DROP TABLE [dbo].[temp_DataDefectISO]  " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectGPIsoTot]') AND type in (N'U')) DROP TABLE [dbo].[tempdefectGPIsoTot]  " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[temp_GroupNow]') AND type in (N'U')) DROP TABLE [dbo].[temp_GroupNow] " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[temp_GroupNow1]') AND type in (N'U')) DROP TABLE [dbo].[temp_GroupNow1] " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[temp_GroupNow2]') AND type in (N'U')) DROP TABLE [dbo].[temp_GroupNow2] " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectL1]') AND type in (N'U')) DROP TABLE [dbo].tempdefectL1  " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectL2]') AND type in (N'U')) DROP TABLE [dbo].tempdefectL2  " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectL3]') AND type in (N'U')) DROP TABLE [dbo].tempdefectL3  " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectL4]') AND type in (N'U')) DROP TABLE [dbo].tempdefectL4  " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectL5]') AND type in (N'U')) DROP TABLE [dbo].tempdefectL5  " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectL6]') AND type in (N'U')) DROP TABLE [dbo].tempdefectL6 " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDataSarmut_Defect]') AND type in (N'U')) DROP TABLE [dbo].tempDataSarmut_Defect ";

            }
            #endregion
            else if (Convert.ToInt32(strtgl1.Substring(0, 6)) > 202105 && users.UnitKerjaID == 1)
            {
                Query1 =

                    " update SPD_TransPrs set actual= cast((select " +
                    " case when sum(b)=0 then 0 when sum(b)>0 then (sum(c)-sum(d)+sum(e)+sum(f))/sum(b)*100  end d  from ( select * from tempdefectL1 union all select * from tempdefectL2   " +
                    " union all select * from tempdefectL3  union all select * from tempdefectL4  union all select * from tempdefectL5  " +
                    " union all select * from tempdefectL6  )A where [group]='total' " +
                    " ) as decimal(18,1)) where approval=0 and Tahun =" + ddTahun.SelectedValue + " and Bulan=" + ddlBulan.SelectedValue.ToString() +
                    " and SarmutPID in (select ID from SPD_Perusahaan where SarMutPerusahaan ='Defect Board Mill') " +

                    //" select [Group],TotPot_Proposionet b,Total_Defect0 c,OK_KM d,Sortir e,Retur f,BS_Tahap1 g,Total_Defect i,Persentase j from temp_DataDefectISO where [Group]='Total' " +
                    " select [Group],cast(TotPot_Proposionet as decimal(18,0))b,cast(Defect_Produksi as decimal(18,0))c,cast(OK_KM as decimal(18,0))d,cast(Sortir as decimal(18,0))e,cast(Retur as decimal(18,0))f,cast(BS_Tahap1 as decimal(18,0))g,cast(Total_Defect as decimal(18,0))i,Persentase j from temp_DataDefectISO where [Group]='Total' " +


                    " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempData_Group]') AND type in (N'U')) DROP TABLE [dbo].[tempData_Group] " +
                    " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDefect_BM]') AND type in (N'U')) DROP TABLE [dbo].[tempDefect_BM] " +
                    " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDefect_Fin]') AND type in (N'U')) DROP TABLE [dbo].[tempDefect_Fin] " +
                    " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDefect_Fin0]') AND type in (N'U')) DROP TABLE [dbo].[tempDefect_Fin0] " +
                    " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDefect_BM_detail0]') AND type in (N'U')) DROP TABLE [dbo].[tempDefect_BM_detail0] " +
                    " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDefect_BM_detail]') AND type in (N'U')) DROP TABLE [dbo].[tempDefect_BM_detail] " +
                    " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDefect_Fin_detail]') AND type in (N'U')) DROP TABLE [dbo].[tempDefect_Fin_detail] " +
                    " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDefect_Fin_detail0]') AND type in (N'U')) DROP TABLE [dbo].[tempDefect_Fin_detail0] " +
                    " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Selisih_ttl_defect_Detail]') AND type in (N'U')) DROP TABLE [dbo].[Selisih_ttl_defect_Detail] " +
                    " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDefect_BM_FN_detail]') AND type in (N'U')) DROP TABLE [dbo].[tempDefect_BM_FN_detail] " +
                    " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDefect_UkuranKhusus_detail]') AND type in (N'U')) DROP TABLE [dbo].[tempDefect_UkuranKhusus_detail] " +
                    " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDefect_ListPlank_detail]') AND type in (N'U')) DROP TABLE [dbo].[tempDefect_ListPlank_detail] " +
                    " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDefect_ListPlank_detail2]') AND type in (N'U')) DROP TABLE [dbo].[tempDefect_ListPlank_detail2] " +
                    " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDefect_Produksi_detail]') AND type in (N'U')) DROP TABLE [dbo].[tempDefect_Produksi_detail] " +
                    " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempMasterDataBSauto]') AND type in (N'U')) DROP TABLE [dbo].[tempMasterDataBSauto]  " +
                    " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempBS_Tahap1]') AND type in (N'U')) DROP TABLE [dbo].[tempBS_Tahap1]  " +
                    " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempBS_Tahap1_detail]') AND type in (N'U')) DROP TABLE [dbo].[tempBS_Tahap1_detail]  " +
                    " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTotalDefect_detail]') AND type in (N'U')) DROP TABLE [dbo].[tempTotalDefect_detail]  " +
                    " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTotalDefect_Pro_detail]') AND type in (N'U')) DROP TABLE [dbo].[tempTotalDefect_Pro_detail]  " +
                    " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTotalPot_QA]') AND type in (N'U')) DROP TABLE [dbo].[tempTotalPot_QA]  " +
                    " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDefect_Master_ListPlank]') AND type in (N'U')) DROP TABLE [dbo].[tempDefect_Master_ListPlank]  " +
                    " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTtlBP_LP]') AND type in (N'U')) DROP TABLE [dbo].[tempTtlBP_LP]  " +
                    " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTtlOK_LP]') AND type in (N'U')) DROP TABLE [dbo].[tempTtlOK_LP]  " +
                    " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTtl_LP]') AND type in (N'U')) DROP TABLE [dbo].[tempTtl_LP]  " +
                    " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTotalPotong_BP_LP]') AND type in (N'U')) DROP TABLE [dbo].[tempTotalPotong_BP_LP]  " +
                    " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTotalPotong_LP]') AND type in (N'U')) DROP TABLE [dbo].[tempTotalPotong_LP]  " +
                    " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTotalPotong_UkuranKhusus]') AND type in (N'U')) DROP TABLE [dbo].[tempTotalPotong_UkuranKhusus]  " +
                    " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempGroup]') AND type in (N'U')) DROP TABLE [dbo].[tempGroup]  " +
                    " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempGroup2]') AND type in (N'U')) DROP TABLE [dbo].[tempGroup2]  " +
                    " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempGroup3]') AND type in (N'U')) DROP TABLE [dbo].[tempGroup3]  " +
                    " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTotalPot_LP_UkuranKhusus]') AND type in (N'U')) DROP TABLE [dbo].[tempTotalPot_LP_UkuranKhusus]  " +
                    " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTotalPot_SystemLP]') AND type in (N'U')) DROP TABLE [dbo].[tempTotalPot_SystemLP]  " +
                    " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempSelisih_TotPot]') AND type in (N'U')) DROP TABLE [dbo].[tempSelisih_TotPot]  " +
                    " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTotPot_Proposionet]') AND type in (N'U')) DROP TABLE [dbo].[tempTotPot_Proposionet]  " +
                    " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempGroup_LPUK]') AND type in (N'U')) DROP TABLE [dbo].[tempGroup_LPUK]  " +
                    " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[temp_OKKM]') AND type in (N'U')) DROP TABLE [dbo].[temp_OKKM]  " +
                    " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[temp_Retur]') AND type in (N'U')) DROP TABLE [dbo].[temp_Retur]  " +
                    " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[temp_Sortir]') AND type in (N'U')) DROP TABLE [dbo].[temp_Sortir]  " +
                    " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[temp_TotalDefect]') AND type in (N'U')) DROP TABLE [dbo].[temp_TotalDefect]  " +
                    " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[temp_Persen]') AND type in (N'U')) DROP TABLE [dbo].[temp_Persen]  " +
                    " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[temp_Total]') AND type in (N'U')) DROP TABLE [dbo].[temp_Total]  " +
                    " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[temp_DataDefectISO]') AND type in (N'U')) DROP TABLE [dbo].[temp_DataDefectISO]  " +
                    " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectGPIsoTot]') AND type in (N'U')) DROP TABLE [dbo].[tempdefectGPIsoTot]  " +
                    " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[temp_GroupNow]') AND type in (N'U')) DROP TABLE [dbo].[temp_GroupNow] " +
                    " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[temp_GroupNow1]') AND type in (N'U')) DROP TABLE [dbo].[temp_GroupNow1] " +
                    " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[temp_GroupNow2]') AND type in (N'U')) DROP TABLE [dbo].[temp_GroupNow2] " +
                    " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectL1]') AND type in (N'U')) DROP TABLE [dbo].tempdefectL1  " +
                    " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectL2]') AND type in (N'U')) DROP TABLE [dbo].tempdefectL2  " +
                    " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectL3]') AND type in (N'U')) DROP TABLE [dbo].tempdefectL3  " +
                    " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectL4]') AND type in (N'U')) DROP TABLE [dbo].tempdefectL4  " +
                    " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectL5]') AND type in (N'U')) DROP TABLE [dbo].tempdefectL5  " +
                    " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectL6]') AND type in (N'U')) DROP TABLE [dbo].tempdefectL6 " +
                    " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDataSarmut_Defect]') AND type in (N'U')) DROP TABLE [dbo].tempDataSarmut_Defect "+
                    " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Master_Plant1]') AND type in (N'U')) DROP TABLE [dbo].Master_Plant1 " +
                    " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Master_Plant2]') AND type in (N'U')) DROP TABLE[dbo].Master_Plant2 " +
                    " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Master_Plant3]') AND type in (N'U')) DROP TABLE[dbo].Master_Plant3 " +
                    " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[temp_UkuranKhusus_Trans]') AND type in (N'U')) DROP TABLE[dbo].temp_UkuranKhusus_Trans " +
                    " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Master_Plant22]') AND type in (N'U')) DROP TABLE[dbo].Master_Plant22 " +
                    " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Master_Plant33]') AND type in (N'U')) DROP TABLE[dbo].Master_Plant33 " +
                    " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[temp_ToPotUK_Trans]') AND type in (N'U')) DROP TABLE[dbo].temp_ToPotUK_Trans " +
                    " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[temp_ListPlank_Trans]') AND type in (N'U')) DROP TABLE[dbo].temp_ListPlank_Trans " +
                    " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Master_Plant23]') AND type in (N'U')) DROP TABLE[dbo].Master_Plant23 " +
                    " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Master_Plant34]') AND type in (N'U')) DROP TABLE[dbo].Master_Plant34 " +
                    " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[temp_M_LP]') AND type in (N'U')) DROP TABLE[dbo].temp_M_LP " +
                    " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[temp_TtlBP_Trans]') AND type in (N'U')) DROP TABLE[dbo].temp_TtlBP_Trans " +
                    " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[temp_TtlOK_Trans]') AND type in (N'U')) DROP TABLE[dbo].temp_TtlOK_Trans ";

            }
            #region Karawang
            else
            {
                Query1 =

                " update SPD_TransPrs set actual= cast((select " +
                " case when sum(b)=0 then 0 when sum(b)>0 then (sum(c)-sum(d)+sum(e)+sum(f))/sum(b)*100  end d  from ( select * from tempdefectL1 union all select * from tempdefectL2   " +
                " union all select * from tempdefectL3  union all select * from tempdefectL4  union all select * from tempdefectL5  " +
                " union all select * from tempdefectL6  )A where [group]='total' " +
                " ) as decimal(18,1)) where approval=0 and Tahun =" + ddTahun.SelectedValue + " and Bulan=" + ddlBulan.SelectedValue.ToString() +
                " and SarmutPID in (select ID from SPD_Perusahaan where SarMutPerusahaan ='Defect Board Mill') " +

                //"  select [Group],cast(TotPot_Proposionet as decimal(18,0))b,cast(Defect_Produksi as decimal(18,0))c,cast(OK_KM as decimal(18,0))d,cast(Sortir as decimal(18,0))e,cast(Retur as decimal(18,0))f,cast(BS_Tahap1 as decimal(18,0))g,cast(Total_Defect as decimal(18,0))i,Persentase j from temp_DataDefectISO where [Group]='Total' " +

                " select [Group],b,c,d,e,f,g,i,cast((i/b)*100 as decimal(18,1)) j from ( " +
                " select [Group],cast(TotPot_Proposionet as decimal(18,0))b,cast(Defect_Produksi as decimal(18,0))c,cast(OK_KM as decimal(18,0))d, " +
                " cast(Sortir as decimal(18,0))e,cast(Retur as decimal(18,0))f,cast(BS_Tahap1 as decimal(18,0))g,cast(Total_Defect as decimal(18,0))i, " +
                " Persentase j from temp_DataDefectISO where [Group]='Total'  " +
                " ) as b " +

                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempData_Group]') AND type in (N'U')) DROP TABLE [dbo].[tempData_Group] " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDefect_BM]') AND type in (N'U')) DROP TABLE [dbo].[tempDefect_BM] " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDefect_Fin]') AND type in (N'U')) DROP TABLE [dbo].[tempDefect_Fin] " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDefect_Fin0]') AND type in (N'U')) DROP TABLE [dbo].[tempDefect_Fin0] " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDefect_BM_detail0]') AND type in (N'U')) DROP TABLE [dbo].[tempDefect_BM_detail0] " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDefect_BM_detail]') AND type in (N'U')) DROP TABLE [dbo].[tempDefect_BM_detail] " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDefect_Fin_detail]') AND type in (N'U')) DROP TABLE [dbo].[tempDefect_Fin_detail] " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDefect_Fin_detail0]') AND type in (N'U')) DROP TABLE [dbo].[tempDefect_Fin_detail0] " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[Selisih_ttl_defect_Detail]') AND type in (N'U')) DROP TABLE [dbo].[Selisih_ttl_defect_Detail] " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDefect_BM_FN_detail]') AND type in (N'U')) DROP TABLE [dbo].[tempDefect_BM_FN_detail] " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDefect_UkuranKhusus_detail]') AND type in (N'U')) DROP TABLE [dbo].[tempDefect_UkuranKhusus_detail] " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDefect_ListPlank_detail]') AND type in (N'U')) DROP TABLE [dbo].[tempDefect_ListPlank_detail] " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDefect_ListPlank_detail2]') AND type in (N'U')) DROP TABLE [dbo].[tempDefect_ListPlank_detail2] " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDefect_Produksi_detail]') AND type in (N'U')) DROP TABLE [dbo].[tempDefect_Produksi_detail] " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempMasterDataBSauto]') AND type in (N'U')) DROP TABLE [dbo].[tempMasterDataBSauto]  " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempBS_Tahap1]') AND type in (N'U')) DROP TABLE [dbo].[tempBS_Tahap1]  " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempBS_Tahap1_detail]') AND type in (N'U')) DROP TABLE [dbo].[tempBS_Tahap1_detail]  " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTotalDefect_detail]') AND type in (N'U')) DROP TABLE [dbo].[tempTotalDefect_detail]  " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTotalDefect_Pro_detail]') AND type in (N'U')) DROP TABLE [dbo].[tempTotalDefect_Pro_detail]  " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTotalPot_QA]') AND type in (N'U')) DROP TABLE [dbo].[tempTotalPot_QA]  " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDefect_Master_ListPlank]') AND type in (N'U')) DROP TABLE [dbo].[tempDefect_Master_ListPlank]  " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTtlBP_LP]') AND type in (N'U')) DROP TABLE [dbo].[tempTtlBP_LP]  " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTtlOK_LP]') AND type in (N'U')) DROP TABLE [dbo].[tempTtlOK_LP]  " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTtl_LP]') AND type in (N'U')) DROP TABLE [dbo].[tempTtl_LP]  " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTotalPotong_BP_LP]') AND type in (N'U')) DROP TABLE [dbo].[tempTotalPotong_BP_LP]  " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTotalPotong_LP]') AND type in (N'U')) DROP TABLE [dbo].[tempTotalPotong_LP]  " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTotalPotong_UkuranKhusus]') AND type in (N'U')) DROP TABLE [dbo].[tempTotalPotong_UkuranKhusus]  " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempGroup]') AND type in (N'U')) DROP TABLE [dbo].[tempGroup]  " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempGroup2]') AND type in (N'U')) DROP TABLE [dbo].[tempGroup2]  " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTotalPot_LP_UkuranKhusus]') AND type in (N'U')) DROP TABLE [dbo].[tempTotalPot_LP_UkuranKhusus]  " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTotalPot_SystemLP]') AND type in (N'U')) DROP TABLE [dbo].[tempTotalPot_SystemLP]  " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempSelisih_TotPot]') AND type in (N'U')) DROP TABLE [dbo].[tempSelisih_TotPot]  " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempTotPot_Proposionet]') AND type in (N'U')) DROP TABLE [dbo].[tempTotPot_Proposionet]  " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempGroup_LPUK]') AND type in (N'U')) DROP TABLE [dbo].[tempGroup_LPUK]  " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[temp_OKKM]') AND type in (N'U')) DROP TABLE [dbo].[temp_OKKM]  " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[temp_Retur]') AND type in (N'U')) DROP TABLE [dbo].[temp_Retur]  " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[temp_Sortir]') AND type in (N'U')) DROP TABLE [dbo].[temp_Sortir]  " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[temp_TotalDefect]') AND type in (N'U')) DROP TABLE [dbo].[temp_TotalDefect]  " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[temp_Persen]') AND type in (N'U')) DROP TABLE [dbo].[temp_Persen]  " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[temp_Total]') AND type in (N'U')) DROP TABLE [dbo].[temp_Total]  " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[temp_DataDefectISO]') AND type in (N'U')) DROP TABLE [dbo].[temp_DataDefectISO]  " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectGPIsoTot]') AND type in (N'U')) DROP TABLE [dbo].[tempdefectGPIsoTot]  " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[temp_GroupNow]') AND type in (N'U')) DROP TABLE [dbo].[temp_GroupNow] " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[temp_GroupNow1]') AND type in (N'U')) DROP TABLE [dbo].[temp_GroupNow1] " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[temp_GroupNow2]') AND type in (N'U')) DROP TABLE [dbo].[temp_GroupNow2] " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectL1]') AND type in (N'U')) DROP TABLE [dbo].tempdefectL1  " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectL2]') AND type in (N'U')) DROP TABLE [dbo].tempdefectL2  " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectL3]') AND type in (N'U')) DROP TABLE [dbo].tempdefectL3  " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectL4]') AND type in (N'U')) DROP TABLE [dbo].tempdefectL4  " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectL5]') AND type in (N'U')) DROP TABLE [dbo].tempdefectL5  " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempdefectL6]') AND type in (N'U')) DROP TABLE [dbo].tempdefectL6 " +
                " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[tempDataSarmut_Defect]') AND type in (N'U')) DROP TABLE [dbo].tempDataSarmut_Defect " +
                 " IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[temp_ttlgrp_aktif]') AND type in (N'U')) DROP TABLE [dbo].temp_ttlgrp_aktif ";
            }
            #endregion

            string thnbln = ddTahun.SelectedValue + ddlBulan.SelectedValue.ToString().PadLeft(2, '0');
            string strSQL = "" + Query1 + "";

            SqlConnection sqlCon = new SqlConnection(Global.ConnectionString());
            sqlCon.Open();
            SqlDataAdapter da = new SqlDataAdapter(strSQL, sqlCon);
            da.SelectCommand.CommandTimeout = 0;

            #region Code for preparing the DataTable
            DataTable dt = new DataTable();
            da.Fill(dt);
            DataColumn dcol = new DataColumn(ID, typeof(System.Int32));
            dcol.AutoIncrement = true;
            #endregion
            GrdDynamic7.Columns.Clear();
            foreach (DataColumn col in dt.Columns)
            {
                BoundField bfield = new BoundField();
                bfield.DataField = col.ColumnName;
                bfield.HeaderText = col.ColumnName;

                if (bfield.HeaderText.Trim() == "Group")
                {
                    bfield.ItemStyle.HorizontalAlign = HorizontalAlign.Center;
                    bfield.HeaderText = "";
                }
                else
                {
                    bfield.ItemStyle.HorizontalAlign = HorizontalAlign.Right;
                    if (RBKubik.Checked == true)
                        bfield.DataFormatString = "{0:N0}";
                    else
                        bfield.DataFormatString = "{0:N0}";
                }

                if (bfield.HeaderText.Trim() == "b")
                {
                    bfield.HeaderText = "TOTAL SERAH PRODUK TAHAP 1 ke TAHAP 3";
                    bfield.DataFormatString = "{0:N1}";
                }

                if (bfield.HeaderText.Trim() == "c")
                {
                    bfield.HeaderText = "DEFECT PRODUKSI";
                    bfield.DataFormatString = "{0:N1}";
                }

                if (bfield.HeaderText.Trim() == "d")
                {
                    bfield.HeaderText = "OK KM 1200 X 2400";
                    bfield.DataFormatString = "{0:N1}";
                }

                if (bfield.HeaderText.Trim() == "e")
                {
                    bfield.HeaderText = "NC SORTIR";
                    bfield.DataFormatString = "{0:N1}";
                }

                if (bfield.HeaderText.Trim() == "f")
                {
                    bfield.HeaderText = "RETUR";
                    bfield.DataFormatString = "{0:N1}";
                }

                if (bfield.HeaderText.Trim() == "g")
                {
                    bfield.HeaderText = "BS TAHAP I";
                    bfield.DataFormatString = "{0:N1}";
                }

                if (bfield.HeaderText.Trim() == "i")
                {
                    bfield.HeaderText = "TOTAL DEFECT";
                    bfield.DataFormatString = "{0:N1}";
                }

                if (bfield.HeaderText.Trim() == "j")
                {
                    bfield.HeaderText = "%";
                    bfield.DataFormatString = "{0:N1}";
                }

                GrdDynamic7.Columns.Add(bfield);
            }
            GrdDynamic7.DataSource = dt;
            GrdDynamic7.DataBind();


            ZetroView zl = new ZetroView();
            zl.QueryType = Operation.CUSTOM;
            //zl.CustomQuery = "drop table tempdest";
            SqlDataReader sdr = zl.Retrieve();
        }
        private void loadDynamicGrid8(string tgl1)
        {
            ddlBulan_SelectedIndexChanged(null, null);
            Users users = (Users)Session["Users"];
            string strStocker = string.Empty;
            if (txtdrtanggal.Text == string.Empty || txtsdtanggal.Text == string.Empty)
            {
                return;
            }
            DateTime intgl1 = DateTime.Parse(txtdrtanggal.Text);
            DateTime intgl2 = DateTime.Parse(txtsdtanggal.Text);
            string tglproses = string.Empty; string strtgl1 = intgl1.ToString("yyyyMMdd");

            string thnbln = ddTahun.SelectedValue + ddlBulan.SelectedValue.ToString().PadLeft(2, '0');
            string strSQL =

                "select 'DEFECT BOARDMILL , RETUR,OK KM 1200 X 2400' [Group],sum(b)b,sum(c)c,sum(d)d,NULL e,sum(f)f,sum(h)h,sum(c)-sum(d)+sum(e)+sum(f) i, " +
                 "(sum(c)-sum(d)+sum(e)+sum(f))/sum(b)*100 j from ( select * from tempdefectL1 union all select * from tempdefectL2   " +
                 "union all select * from tempdefectL3  union all select * from tempdefectL4  union all select * from tempdefectL5  " +
                 "union all select * from tempdefectL6  )A where [group]='total' " +

                 "union all " +

                 " select 'DEFECT SORTIR ULANG' [Group],sum(b)b,NULL c,NULL d,sum(e) e,NULL f,NULL h,NULL  i, " +
                 "(sum(e)/sum(b))*100 j from ( select * from tempdefectL1 union all select * from tempdefectL2   " +
                 "union all select * from tempdefectL3  union all select * from tempdefectL4  union all select * from tempdefectL5  " +
                 "union all select * from tempdefectL6  )A where [group]='total' ";







            SqlConnection sqlCon = new SqlConnection(Global.ConnectionString());
            sqlCon.Open();
            SqlDataAdapter da = new SqlDataAdapter(strSQL, sqlCon);
            da.SelectCommand.CommandTimeout = 0;
            #region Code for preparing the DataTable
            DataTable dt = new DataTable();
            da.Fill(dt);
            DataColumn dcol = new DataColumn(ID, typeof(System.Int32));
            dcol.AutoIncrement = true;
            #endregion
            GrdDynamic8.Columns.Clear();
            foreach (DataColumn col in dt.Columns)
            {
                BoundField bfield = new BoundField();
                bfield.DataField = col.ColumnName;
                bfield.HeaderText = col.ColumnName;
                //bfield.DataFormatString = "{0:N0}";
                if (bfield.HeaderText.Trim() == "Group")
                {
                    bfield.ItemStyle.HorizontalAlign = HorizontalAlign.Center;
                    bfield.HeaderText = "URAIAN";
                }
                else
                {
                    bfield.ItemStyle.HorizontalAlign = HorizontalAlign.Right;
                    if (RBKubik.Checked == true)
                        bfield.DataFormatString = "{0:N1}";
                    else
                        bfield.DataFormatString = "{0:N0}";

                }
                if (bfield.HeaderText.Trim() == "b")
                    bfield.HeaderText = "TOTAL CUTTER"; bfield.DataFormatString = "{0:N1}";
                if (bfield.HeaderText.Trim() == "c")
                    bfield.HeaderText = "DEFECT BOARDMILL"; bfield.DataFormatString = "{0:N1}";
                if (bfield.HeaderText.Trim() == "d")
                    bfield.HeaderText = "OK KM 1200 X 2400"; bfield.DataFormatString = "{0:N1}";
                if (bfield.HeaderText.Trim() == "e")
                    bfield.HeaderText = "SORTIR";
                if (bfield.HeaderText.Trim() == "f")
                    bfield.HeaderText = "RETUR";
                //if (bfield.HeaderText.Trim() == "g")
                //    bfield.HeaderText = "DEFECT FINISHING";
                if (bfield.HeaderText.Trim() == "h")
                    bfield.HeaderText = "DEFECT UKURAN KHUSUS";
                if (bfield.HeaderText.Trim() == "i")
                    bfield.HeaderText = "TOTAL DEFECT";
                if (bfield.HeaderText.Trim() == "j")
                {
                    bfield.HeaderText = "%";
                    bfield.DataFormatString = "{0:N1}";
                }

                GrdDynamic8.Columns.Add(bfield);
            }
            GrdDynamic8.DataSource = dt;
            GrdDynamic8.DataBind();


            ZetroView zl = new ZetroView();
            zl.QueryType = Operation.CUSTOM;
            //zl.CustomQuery = "drop table tempdest";
            SqlDataReader sdr = zl.Retrieve();
        }
        protected decimal retrievetodest(string strquery)
        {
            decimal result = 0;
            ZetroView zl = new ZetroView();
            zl.QueryType = Operation.CUSTOM;
            zl.CustomQuery = strquery;
            SqlDataReader sdr = zl.Retrieve();
            if (sdr.HasRows)
            {
                while (sdr.Read())
                {
                    result = decimal.Parse(sdr["result"].ToString());
                }
            }
            return result;
        }
        protected void LinkButton3_Click(object sender, EventArgs e)
        {
            if (GrdDynamic.Rows.Count == 0)
                return;
            Response.ClearContent();
            Response.Buffer = true;
            Response.AddHeader("content-disposition", string.Format("attachment; filename={0}", "rekap Defect ISO.xls"));
            Response.ContentType = "application/ms-excel";
            StringWriter sw = new StringWriter();
            HtmlTextWriter htw = new HtmlTextWriter(sw);
            GrdDynamic.AllowPaging = false;
            //GrdDynamic.HeaderRow.Style.Add("background-color", "#FFFFFF");
            //for (int i = 0; i < GrdDynamic.HeaderRow.Cells.Count; i++)
            //{
            //    GrdDynamic.HeaderRow.Cells[i].Style.Add("background-color", "#df5015");
            //}
            Panel1.RenderControl(htw);
            Response.Write(sw.ToString());
            Response.End();
        }
        protected void txtsdtanggal_TextChanged(object sender, EventArgs e)
        {
            if (DateTime.Parse(txtsdtanggal.Text) < DateTime.Parse(txtdrtanggal.Text))
                txtdrtanggal.Text = "01-" + DateTime.Parse(txtsdtanggal.Text).ToString("MMM-yyyy");
            LblTgl1.Text = DateTime.Parse(txtdrtanggal.Text).ToString("dd MMMM yyyy") + " sd " + DateTime.Parse(txtsdtanggal.Text).ToString("dd MMMM yyyy");
            Button1_Click(null, null);
        }
        protected void txtdrtanggal_TextChanged(object sender, EventArgs e)
        {
            if (DateTime.Parse(txtsdtanggal.Text) < DateTime.Parse(txtdrtanggal.Text))
                txtsdtanggal.Text = txtdrtanggal.Text;
            LblTgl1.Text = DateTime.Parse(txtdrtanggal.Text).ToString("dd MMMM yyyy") + " sd " + DateTime.Parse(txtsdtanggal.Text).ToString("dd MMMM yyyy");
            Button1_Click(null, null);
            //txtsdtanggal.Text = Convert.ToDateTime(DateTime.Parse("1-" + (DateTime.Parse(txtdrtanggal.Text).AddMonths(1)).ToString("MMM-yyyy"))).AddDays(-1).ToString("dd")
            //    + "-" + DateTime.Parse(txtdrtanggal.Text).ToString("MMM") + "-" + DateTime.Now.ToString("yyyy");
        }
        protected void grvMergeHeader_RowCreated(object sender, GridViewRowEventArgs e)
        {
            if (e.Row.RowType == DataControlRowType.Header)
            {
                GridView HeaderGrid = (GridView)sender;
                GridViewRow HeaderGridRow = new GridViewRow(0, 0, DataControlRowType.Header, DataControlRowState.Insert);
                TableCell HeaderCell = new TableCell();
                HeaderCell = new TableCell();
                HeaderCell.Text = "REKAP DEFECT LINE 1";
                HeaderCell.ColumnSpan = 10;
                HeaderCell.HorizontalAlign = HorizontalAlign.Left;
                HeaderCell.HorizontalAlign = HorizontalAlign.Left;
                HeaderCell.Font.Bold = true;
                HeaderGridRow.Cells.Add(HeaderCell);
                GrdDynamic.Controls[0].Controls.AddAt(0, HeaderGridRow);
            }
        }
        protected void grvMergeHeader_RowCreated2(object sender, GridViewRowEventArgs e)
        {
            if (e.Row.RowType == DataControlRowType.Header)
            {
                GridView HeaderGrid2 = (GridView)sender;
                GridViewRow HeaderGridRow2 = new GridViewRow(0, 0, DataControlRowType.Header, DataControlRowState.Insert);
                TableCell HeaderCell2 = new TableCell();
                HeaderCell2 = new TableCell();
                HeaderCell2.Text = "REKAP DEFECT LINE 2";
                HeaderCell2.ColumnSpan = 10;
                HeaderCell2.HorizontalAlign = HorizontalAlign.Left;
                HeaderCell2.HorizontalAlign = HorizontalAlign.Left;
                HeaderCell2.Font.Bold = true;
                HeaderGridRow2.Cells.Add(HeaderCell2);
                GrdDynamic2.Controls[0].Controls.AddAt(0, HeaderGridRow2);
            }
        }
        protected void grvMergeHeader_RowCreated3(object sender, GridViewRowEventArgs e)
        {
            if (e.Row.RowType == DataControlRowType.Header)
            {
                GridView HeaderGrid3 = (GridView)sender;
                GridViewRow HeaderGridRow3 = new GridViewRow(0, 0, DataControlRowType.Header, DataControlRowState.Insert);
                TableCell HeaderCell3 = new TableCell();
                HeaderCell3 = new TableCell();
                HeaderCell3.Text = "REKAP DEFECT LINE 3";
                HeaderCell3.ColumnSpan = 10;
                HeaderCell3.HorizontalAlign = HorizontalAlign.Left;
                HeaderCell3.HorizontalAlign = HorizontalAlign.Left;
                HeaderCell3.Font.Bold = true;
                HeaderGridRow3.Cells.Add(HeaderCell3);
                GrdDynamic3.Controls[0].Controls.AddAt(0, HeaderGridRow3);
            }
        }
        protected void grvMergeHeader_RowCreated4(object sender, GridViewRowEventArgs e)
        {
            if (e.Row.RowType == DataControlRowType.Header)
            {
                GridView HeaderGrid4 = (GridView)sender;
                GridViewRow HeaderGridRow4 = new GridViewRow(0, 0, DataControlRowType.Header, DataControlRowState.Insert);
                TableCell HeaderCell4 = new TableCell();
                HeaderCell4 = new TableCell();
                HeaderCell4.Text = "REKAP DEFECT LINE 4";
                HeaderCell4.ColumnSpan = 10;
                HeaderCell4.HorizontalAlign = HorizontalAlign.Left;
                HeaderCell4.HorizontalAlign = HorizontalAlign.Left;
                HeaderCell4.Font.Bold = true;
                HeaderGridRow4.Cells.Add(HeaderCell4);
                GrdDynamic4.Controls[0].Controls.AddAt(0, HeaderGridRow4);
            }
        }
        protected void grvMergeHeader_RowCreated5(object sender, GridViewRowEventArgs e)
        {
            if (e.Row.RowType == DataControlRowType.Header)
            {
                GridView HeaderGrid5 = (GridView)sender;
                GridViewRow HeaderGridRow5 = new GridViewRow(0, 0, DataControlRowType.Header, DataControlRowState.Insert);
                TableCell HeaderCell5 = new TableCell();
                HeaderCell5 = new TableCell();
                HeaderCell5.Text = "REKAP DEFECT LINE 5";
                HeaderCell5.ColumnSpan = 10;
                HeaderCell5.HorizontalAlign = HorizontalAlign.Left;
                HeaderCell5.HorizontalAlign = HorizontalAlign.Left;
                HeaderCell5.Font.Bold = true;
                HeaderGridRow5.Cells.Add(HeaderCell5);
                GrdDynamic5.Controls[0].Controls.AddAt(0, HeaderGridRow5);
            }
        }
        protected void grvMergeHeader_RowCreated6(object sender, GridViewRowEventArgs e)
        {
            if (e.Row.RowType == DataControlRowType.Header)
            {
                GridView HeaderGrid6 = (GridView)sender;
                GridViewRow HeaderGridRow6 = new GridViewRow(0, 0, DataControlRowType.Header, DataControlRowState.Insert);
                TableCell HeaderCell6 = new TableCell();
                HeaderCell6 = new TableCell();
                HeaderCell6.Text = "REKAP DEFECT LINE 6";
                HeaderCell6.ColumnSpan = 10;
                HeaderCell6.HorizontalAlign = HorizontalAlign.Left;
                HeaderCell6.HorizontalAlign = HorizontalAlign.Left;
                HeaderCell6.Font.Bold = true;
                HeaderGridRow6.Cells.Add(HeaderCell6);
                GrdDynamic6.Controls[0].Controls.AddAt(0, HeaderGridRow6);
            }
        }
        protected void grvMergeHeader_RowCreated7(object sender, GridViewRowEventArgs e)
        {
            if (e.Row.RowType == DataControlRowType.Header)
            {
                GridView HeaderGrid7 = (GridView)sender;
                GridViewRow HeaderGridRow7 = new GridViewRow(0, 0, DataControlRowType.Header, DataControlRowState.Insert);
                TableCell HeaderCell7 = new TableCell();
                HeaderCell7 = new TableCell();
                HeaderCell7.Text = "DEFECT TOTAL";
                HeaderCell7.ColumnSpan = 10;
                HeaderCell7.HorizontalAlign = HorizontalAlign.Left;
                HeaderCell7.HorizontalAlign = HorizontalAlign.Left;
                HeaderCell7.Font.Bold = true;
                HeaderGridRow7.Cells.Add(HeaderCell7);
                GrdDynamic7.Controls[0].Controls.AddAt(0, HeaderGridRow7);
            }
        }
        protected void grvMergeHeader_RowCreated8(object sender, GridViewRowEventArgs e)
        {
            if (e.Row.RowType == DataControlRowType.Header)
            {
                GridView HeaderGrid8 = (GridView)sender;
                GridViewRow HeaderGridRow8 = new GridViewRow(0, 0, DataControlRowType.Header, DataControlRowState.Insert);
                TableCell HeaderCell8 = new TableCell();
                HeaderCell8 = new TableCell();
                HeaderCell8.Text = " ";
                HeaderCell8.ColumnSpan = 10;
                HeaderCell8.HorizontalAlign = HorizontalAlign.Left;
                HeaderCell8.HorizontalAlign = HorizontalAlign.Left;
                HeaderCell8.Font.Bold = true;
                HeaderGridRow8.Cells.Add(HeaderCell8);
                GrdDynamic8.Controls[0].Controls.AddAt(0, HeaderGridRow8);
            }
        }

        protected void GridView1_DataBinding(object sender, EventArgs e)
        {

        }
        public enum DateInterval
        {
            Day,
            DayOfYear,
            Hour,
            Minute,
            Month,
            Quarter,
            Second,
            Weekday,
            WeekOfYear,
            Year
        }

        public static long DateDiff(DateInterval interval, DateTime dt1, DateTime dt2)
        {
            return DateDiff(interval, dt1, dt2, System.Globalization.DateTimeFormatInfo.CurrentInfo.FirstDayOfWeek);
        }

        private static int GetQuarter(int nMonth)
        {
            if (nMonth <= 3)
                return 1;
            if (nMonth <= 6)
                return 2;
            if (nMonth <= 9)
                return 3;
            return 4;
        }

        public static long DateDiff(DateInterval interval, DateTime dt1, DateTime dt2, DayOfWeek eFirstDayOfWeek)
        {
            if (interval == DateInterval.Year)
                return dt2.Year - dt1.Year;

            if (interval == DateInterval.Month)
                return (dt2.Month - dt1.Month) + (12 * (dt2.Year - dt1.Year));

            TimeSpan ts = dt2 - dt1;

            if (interval == DateInterval.Day || interval == DateInterval.DayOfYear)
                return Round(ts.TotalDays);

            if (interval == DateInterval.Hour)
                return Round(ts.TotalHours);

            if (interval == DateInterval.Minute)
                return Round(ts.TotalMinutes);

            if (interval == DateInterval.Second)
                return Round(ts.TotalSeconds);

            if (interval == DateInterval.Weekday)
            {
                return Round(ts.TotalDays / 7.0);
            }

            if (interval == DateInterval.WeekOfYear)
            {
                while (dt2.DayOfWeek != eFirstDayOfWeek)
                    dt2 = dt2.AddDays(-1);
                while (dt1.DayOfWeek != eFirstDayOfWeek)
                    dt1 = dt1.AddDays(-1);
                ts = dt2 - dt1;
                return Round(ts.TotalDays / 7.0);
            }

            if (interval == DateInterval.Quarter)
            {
                double d1Quarter = GetQuarter(dt1.Month);
                double d2Quarter = GetQuarter(dt2.Month);
                double d1 = d2Quarter - d1Quarter;
                double d2 = (4 * (dt2.Year - dt1.Year));
                return Round(d1 + d2);
            }

            return 0;

        }

        private static long Round(double dVal)
        {
            if (dVal >= 0)
                return (long)Math.Floor(dVal);
            return (long)Math.Ceiling(dVal);
        }
        private void LoadBulan()
        {
            ddlBulan.Items.Clear();
            DateTime date1 = DateTime.Parse("01-jan-2000");
            ddlBulan.Items.Add(new ListItem(date1.ToString("MMMM"), date1.ToString("MM")));
            for (int i = 1; i < 12; i++)
            {
                DateTime date2 = date1.AddMonths(i);
                ddlBulan.Items.Add(new ListItem(date2.ToString("MMMM"), date2.ToString("MM")));
            }
        }

        protected void ddlBulan_SelectedIndexChanged(object sender, EventArgs e)
        {

            DateTime tgl = DateTime.Parse("01-" + ddlBulan.SelectedItem.Text + "-" + ddTahun.SelectedValue);
            txtdrtanggal.Text = "01-" + tgl.ToString("MMM-yyyy");
            DateTime endOfMonth = new DateTime(tgl.Year, tgl.Month, DateTime.DaysInMonth(tgl.Year, tgl.Month));
            txtsdtanggal.Text = endOfMonth.ToString("dd-MMM-yyyy");
            LblTgl1.Text = DateTime.Parse(txtdrtanggal.Text).ToString("MMMM yyyy");
            //Button1_Click(null, null);
        }
        protected void GrdDynamic_RowDataBound(object sender, GridViewRowEventArgs e)
        {
            if (e.Row.RowType == DataControlRowType.DataRow)
            {
                //int rowindex = Convert.ToInt32(e.Row.RowIndex.ToString());
                //int i = 0;
                //if (IsNumeric(e.Row.Cells[0].Text.Trim()) == false )
                //{

                //    for (i = 1; i <= 10; i++)
                //    {
                //        if (e.Row.Cells[i].Text != "&nbsp;")
                //            e.Row.Cells[i].Text = decimal.Parse(e.Row.Cells[i].Text).ToString("N2");
                //    }
                //}
                //else
                //{
                //    for (i = 1; i <= 10; i++)
                //    {
                //        if (e.Row.Cells[i].Text != "&nbsp;")
                //            e.Row.Cells[i].Text = decimal.Parse(e.Row.Cells[i].Text).ToString("N0");
                //    }
                //    if (e.Row.Cells[34].Text != "&nbsp;")
                //        e.Row.Cells[34].Text = decimal.Parse(e.Row.Cells[34].Text).ToString("N2");
                //}
            }
        }
        protected void ddTahun_SelectedIndexChanged(object sender, EventArgs e)
        {
            ddlBulan_SelectedIndexChanged(null, null);
            LblTgl1.Text = DateTime.Parse(txtdrtanggal.Text).ToString("MMMM yyyy");
            LblTgl1.Text = DateTime.Parse(txtdrtanggal.Text).ToString("MMMM yyyy");
            //Button1_Click(null, null);
        }
        protected void RBLembar_CheckedChanged(object sender, EventArgs e)
        {
            if (RBLembar.Checked == true)
                LblTgl2.Text = "Satuan Lembar";
            else
                LblTgl2.Text = "Satuan Meter Kubik";
            Button1_Click(null, null);
        }
        static bool IsNumeric(object Expression)
        {
            bool isNum;
            double retNum;
            isNum = Double.TryParse(Convert.ToString(Expression), System.Globalization.NumberStyles.Any, System.Globalization.NumberFormatInfo.InvariantInfo, out retNum);
            return isNum;
        }
        protected void RBBulanan_CheckedChanged(object sender, EventArgs e)
        {
            ddlBulan_SelectedIndexChanged(null, null);
            PanelBln.Visible = true;
            PanelHari.Visible = false;
            //Button1_Click(null, null);
        }
        protected void RBHarian_CheckedChanged(object sender, EventArgs e)
        {
            LblTgl1.Text = DateTime.Parse(txtdrtanggal.Text).ToString("dd MMMM yyyy") + " sd " + DateTime.Parse(txtsdtanggal.Text).ToString("dd MMMM yyyy");
            PanelBln.Visible = false;
            PanelHari.Visible = true;
        }


    }
}